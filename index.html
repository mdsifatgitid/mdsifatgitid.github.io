<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Primary Meta Tags -->
    <title>Bangla Toolbox - All-in-One Utility App | বাংলা টুলবক্স</title>
    <meta name="title" content="Bangla Toolbox - All-in-One Utility App | বাংলা টুলবক্স">
    <meta name="description" content="Bangla Toolbox: A comprehensive utility app featuring Bijoy-Unicode Converter, Scientific Calculator, Prayer Times, OCR, PDF Tools, and more. বাংলা টুলবক্স: বিজয় কনভার্টার, ক্যালকুলেটর, নামাজের সময়সূচি সহ সব প্রয়োজনীয় টুলস এক সাথে।">
    <meta name="keywords" content="Bangla Toolbox, Bijoy to Unicode, Unicode to Bijoy, Bangla Converter, Age Calculator, Prayer Times Bangladesh, OCR Bangla, Text to Speech Bangla, বাংলা টুলবক্স, বিজয় কনভার্টার, বয়স ক্যালকুলেটর, নামাজের সময়সূচি, অনলাইন টুলস">
    <meta name="author" content="Md Shahiduzzaman Sifat">
    <meta name="robots" content="index, follow">
    <meta name="language" content="Bengali">

    <!-- Open Graph / Facebook / WhatsApp -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://banglatoolbox.github.io/">
    <meta property="og:title" content="Bangla Toolbox - বাংলা টুলবক্স">
    <meta property="og:description" content="দৈনন্দিন জীবনের প্রয়োজনীয় সব ডিজিটাল টুলস এখন এক জায়গায়। ব্যবহার করুন বাংলা টুলবক্স।">
    <meta property="og:image" content="https://mdsifatgitid.github.io/converticon.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://banglatoolbox.github.io/">
    <meta property="twitter:title" content="Bangla Toolbox - বাংলা টুলবক্স">
    <meta property="twitter:description" content="দৈনন্দিন জীবনের প্রয়োজনীয় সব ডিজিটাল টুলস এখন এক জায়গায়। ব্যবহার করুন বাংলা টুলবক্স।">
    <meta property="twitter:image" content="https://mdsifatgitid.github.io/converticon.png">

    <!-- PWA Manifest & Meta -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="https://mdsifatgitid.github.io/converticon.png">
    <link rel="icon" type="image/png" href="https://mdsifatgitid.github.io/converticon.png">
    <link rel="canonical" href="https://banglatoolbox.github.io/" />

    <!-- Google Structured Data (JSON-LD) for Rich Results -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Bangla Toolbox",
      "alternateName": "বাংলা টুলবক্স",
      "url": "https://banglatoolbox.github.io/",
      "applicationCategory": "UtilityApplication",
      "operatingSystem": "Web",
      "description": "A comprehensive utility web application for Bengali users featuring converters, calculators, and daily tools.",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "BDT"
      },
      "author": {
        "@type": "Person",
        "name": "Md Shahiduzzaman Sifat"
      }
    }
    </script>

    <!-- Tailwind CSS CDN -->
<script src="https://cdn.jsdelivr.net/gh/mdsifatgitid/mdsifatgitid.github.io@main/tailwind.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/easyqrcodejs@4.4.13/dist/easy.qrcode.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
		<!-- Chart.js CDN (গ্রাফের জন্য নতুন যুক্ত করা হয়েছে) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<!-- Cropper.js CDN (নতুন যুক্ত করা হয়েছে) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
		<!-- jsPDF CDN (পিডিএফ টুলের জন্য নতুন যুক্ত করা হয়েছে) -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
		<!-- Diff Match Patch CDN (ডিফ চেকারের জন্য) -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
	<!-- Crypto-JS CDN (এনক্রিপশন টুলের জন্য নতুন যুক্ত করা হয়েছে) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <!-- ফাইল প্রসেসিং লাইব্রেরি (কনভার্টারের জন্য নতুন যুক্ত) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

	
    <style>
        /* Custom font and basic styles */
        /* SUTONNYMJ ফন্টটি লোড করার জন্য @font-face ব্যবহার করা হয়েছে। */
        /* মোবাইল ডিভাইসে দ্রুত এবং নির্ভরযোগ্য লোডিং নিশ্চিত করতে jsDelivr CDN ব্যবহার করা হয়েছে। */
        @font-face {
            font-family: 'SUTONNYMJ';
            src: url('https://cdn.jsdelivr.net/gh/mdsifatgitid/mdsifatgitid.github.io/SUTONNYMJ.TTF') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
/* নতুন ফন্ট সেকশন শুরু */
/* 'Bornomala' ফন্টটি লোড করার জন্য @font-face যুক্ত করা হয়েছে। */
/* পরিবর্তন: GitHub-এর সরাসরি লিংকের পরিবর্তে jsDelivr CDN ব্যবহার করা হয়েছে। */
/* এটি সব ডিভাইসে, বিশেষ করে মোবাইলে, ফন্টটি সঠিকভাবে লোড হতে সাহায্য করবে। */
@font-face {
    font-family: 'Bornomala';
    src: url('https://cdn.jsdelivr.net/gh/mdsifatgitid/mdsifatgitid.github.io/Bornomala-Regular.ttf') format('truetype');
    font-weight: normal;
    font-style: normal;
}
/* নতুন ফন্ট সেকশন শেষ */
/* Preloader Styles (পরিবর্তিত) */
#preloader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #000000;
    z-index: 9999;
    display: flex;
    flex-direction: column; /* ছবি এবং লেখাকে উল্লম্বভাবে সাজানোর জন্য এই লাইনটি যোগ করা হয়েছে */
    justify-content: center;
    align-items: center;
    transition: opacity 1.5s ease, visibility 1.5s ease;
}

/* নতুন: প্রি-লোডার ছবির জন্য স্টাইল */
#preloader-image {
    width: 120px;
    height: 120px;
    border-radius: 50%; /* গোলাকার ছবির জন্য */
    object-fit: cover;
	/*Default:ΝŨťŚŨ ňŬŚΝǑ ĺř ųŊŴŖŚŔŨř  ĺř őŨŗ ųŗŨŦ śũŞŏūίŨŗŨő ũŝŕŨō*/
    margin-bottom: 20px; /* লেখা থেকে ছবির দূরত্ব */
    border: 3px solid #fff; /* একটি সাদা বর্ডার দেওয়া হয়েছে */
    opacity: 0;
    /* লেখার মতো ছবির জন্যও একই অ্যানিমেশন যোগ করা হয়েছে */
    animation: animate-name 3.5s ease-out forwards;
}

#preloader.preloader-hidden {
    opacity: 0;
    visibility: hidden;
}

#preloader-name {
    color: white;
    font-size: 2.5rem;
    font-weight: bold;
    opacity: 0;
    animation: animate-name 3.5s ease-out forwards;
    text-align: center;
}

@keyframes animate-name {
    0% {
        opacity: 0;
        transform: scale(0.8);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}
        
        @keyframes fadeInContent {
            from { opacity: 0; }
            to { opacity: 1; }
        }


        /* Animated Background Styles */
        .area {
            background: #e0f2f7;
            background: -webkit-linear-gradient(to left, #e0f2f7, #d2eaf1);
            width: 100%;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
        }
        /* ডার্ক মোডে অ্যানিমেটেড ব্যাকগ্রাউন্ড পরিবর্তন */
        .dark .area {
             background: #1a202c; /* গাঢ় নীল-ধূসর */
             background: -webkit-linear-gradient(to left, #2d3748, #1a202c);
        }


        .circles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .circles li {
            position: absolute;
            display: block;
            list-style: none;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.4);
            animation: animate-bg 25s linear infinite;
            bottom: -150px;
        }
        /* ডার্ক মোডে বৃত্তের রঙ পরিবর্তন */
        .dark .circles li {
            background: rgba(255, 255, 255, 0.1);
        }


        .circles li:nth-child(1) { left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
        .circles li:nth-child(2) { left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
        .circles li:nth-child(3) { left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
        .circles li:nth-child(4) { left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; }
        .circles li:nth-child(5) { left: 65%; width: 20px; height: 20px; animation-delay: 0s; }
        .circles li:nth-child(6) { left: 75%; width: 110px; height: 110px; animation-delay: 3s; }
        .circles li:nth-child(7) { left: 35%; width: 150px; height: 150px; animation-delay: 7s; }
        .circles li:nth-child(8) { left: 50%; width: 25px; height: 25px; animation-delay: 15s; animation-duration: 45s; }
        .circles li:nth-child(9) { left: 20%; width: 15px; height: 15px; animation-delay: 2s; animation-duration: 35s; }
        .circles li:nth-child(10) { left: 85%; width: 150px; height: 150px; animation-delay: 0s; animation-duration: 11s; }

        @keyframes animate-bg {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
                border-radius: 0;
            }
            100% {
                transform: translateY(-1000px) rotate(720deg);
                opacity: 0;
                border-radius: 50%;
            }
        }

		/* body ট্যাগের font-family পরিবর্তন করে Bornomala ফন্টটিকে প্রধান ফন্ট হিসেবে সেট করা হয়েছে। */
			body {
			font-family: 'Bornomala', 'Inter', 'Hind Siliguri', sans-serif;
			display: flex;
			justify-content: center; /* অনুভূমিকভাবে মাঝখানে রাখার জন্য */
			align-items: flex-start;     /* উল্লম্বভাবে ওপরে অ্যালাইন করার জন্য (স্ক্রোলের জন্য গুরুত্বপূর্ণ) */
			min-height: 100vh;
			background-color: transparent; /* অ্যানিমেটেড ব্যাকগ্রাউন্ডের জন্য স্বচ্ছ করা হয়েছে */
			padding: 5px 5px; /* ওপরে এবং নিচে প্যাডিং বাড়ানো হয়েছে */
			}

        .main-container {
            background-color: rgba(255, 255, 255, 0.85); /* Slightly transparent white */
            backdrop-filter: blur(10px); /* Frosted glass effect */
            -webkit-backdrop-filter: blur(10px);
            padding: 10px; /* বর্ধিত প্যাডিং */
            border-radius: 20px; /* গোলাকার কোণ */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15); /* গভীর ছায়া */
            max-width: 1000px; /* সমস্ত কন্টেন্টের জন্য বর্ধিত সর্বোচ্চ প্রস্থ */
            width: 100%; /* প্রতিক্রিয়াশীল প্রস্থ */
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            visibility: hidden; /* Initially hidden */
        }
        .dark .main-container {
            background-color: rgba(26, 32, 44, 0.85); /* গাঢ় ব্যাকগ্রাউন্ড */
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }

        /* নতুন: থিম টগল বাটন */
        .theme-toggle-container {
            display: flex;
            align-items: center;
        }
        .theme-toggle-button {
            background-color: #e0e7ff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            padding: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .dark .theme-toggle-button {
            background-color: #4a5568;
        }
        .theme-toggle-button:hover {
            transform: scale(1.1);
        }
        .theme-toggle-button svg {
            width: 24px;
            height: 24px;
            color: #3f51b5;
        }
        .dark .theme-toggle-button svg {
            color: #f7fafc;
        }
        #moon-icon { display: none; }
        .dark #sun-icon { display: none; }
        .dark #moon-icon { display: block; }


        .tab-buttons {
            display: flex;
            justify-content: center;
            align-items: center; /* উল্লম্বভাবে কেন্দ্র করার জন্য যোগ করা হয়েছে */
            margin-bottom: 5px; /* বর্ধিত মার্জিন */
            gap: 8px; /* বর্ধিত ফাঁক */
            flex-wrap: wrap; /* ছোট স্ক্রিনে ট্যাবগুলি মোড়ানো */
        }

        
/* ========================================= */
/* START: ট্যাব থিম ভেরিয়েবল ও ডায়নামিক স্টাইল */
/* ========================================= */
        
        /* ১. কালার ভেরিয়েবল ডিক্লারেশন */
        :root {
            /* ডিফল্ট: নতুন থিম (Modern/Soft Blue) */
            --bg-main: rgba(255, 255, 255, 0.85);
            --bg-main-dark: rgba(26, 32, 44, 0.85);
            --tab-bg: #e0e7ff;
            --tab-text: #3f51b5;
            --tab-active-bg: #3f51b5;
            --tab-active-gradient: none; /* ক্লাসিকে গ্রেডিয়েন্ট ছিল না */
            --converter-bg: #ffffff;
            --tab-border: none;
            --tab-radius: 10px;
            --shadow-soft: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        /* পুরাতন থিম (Classic) যখন সিলেক্ট করা হবে */
        [data-theme="classic"] {
			--bg-main: rgba(240, 249, 255, 0.92);
            --bg-main-dark: rgba(30, 41, 59, 0.9);
            --tab-bg: #f1f5f9;
            --tab-text: #475569;
            --tab-active-bg: #4f46e5;
            --tab-active-gradient: linear-gradient(135deg, #4f46e5 0%, #0ea5e9 100%);
            --converter-bg: #ffffff;
            --tab-border: 1px solid #e2e8f0;
            --tab-radius: 12px;
            --shadow-soft: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
/* প্রকৃতি থিম (Nature) */
        [data-theme="nature"] {
            --bg-main: rgba(240, 253, 244, 0.95); /* হালকা মিন্ট গ্রিন */
            --bg-main-dark: rgba(20, 83, 45, 0.92); /* গাঢ় ফরেস্ট গ্রিন */
            --tab-bg: #dcfce7; /* বাটন ব্যাকগ্রাউন্ড */
            --tab-text: #14532d; /* বাটন টেক্সট */
            --tab-active-bg: #16a34a;
            --tab-active-gradient: linear-gradient(135deg, #22c55e 0%, #15803d 100%); /* সবুজ গ্রেডিয়েন্ট */
            --converter-bg: #ffffff;
            --tab-border: 1px solid #86efac;
            --tab-radius: 14px;
            --shadow-soft: 0 20px 40px rgba(22, 163, 74, 0.15);
        }
/* রয়াল পার্পল থিম (Royal Purple) */
        [data-theme="purple"] {
            --bg-main: rgba(250, 245, 255, 0.95); /* হালকা ল্যাভেন্ডার */
            --bg-main-dark: rgba(59, 7, 100, 0.92); /* গাঢ় পার্পল */
            --tab-bg: #f3e8ff; /* বাটন ব্যাকগ্রাউন্ড */
            --tab-text: #6b21a8; /* বাটন টেক্সট */
            --tab-active-bg: #9333ea;
            --tab-active-gradient: linear-gradient(135deg, #a855f7 0%, #7e22ce 100%); /* পার্পল গ্রেডিয়েন্ট */
            --converter-bg: #ffffff;
            --tab-border: 1px solid #d8b4fe;
            --tab-radius: 14px;
            --shadow-soft: 0 20px 40px rgba(147, 51, 234, 0.15);
        }
/* উষ্ণ সূর্যাস্ত থিম (Sunset Orange) */
        [data-theme="sunset"] {
            --bg-main: rgba(255, 247, 237, 0.95); /* হালকা কমলা */
            --bg-main-dark: rgba(67, 20, 7, 0.92); /* গাঢ় বাদামী */
            --tab-bg: #ffedd5; /* বাটন ব্যাকগ্রাউন্ড */
            --tab-text: #c2410c; /* বাটন টেক্সট */
            --tab-active-bg: #f97316;
            --tab-active-gradient: linear-gradient(135deg, #f97316 0%, #ea580c 100%); /* অরেঞ্জ গ্রেডিয়েন্ট */
            --converter-bg: #ffffff;
            --tab-border: 1px solid #fdba74;
            --tab-radius: 14px;
            --shadow-soft: 0 20px 40px rgba(249, 115, 22, 0.15);
        }
        /* ২. মেইন কন্টেইনার (ভেরিয়েবল ব্যবহার করে আপডেট করা) */
        .main-container {
            background-color: var(--bg-main); 
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 15px;
            border-radius: 24px;
            box-shadow: var(--shadow-soft);
            max-width: 1000px;
            width: 100%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.4);
            visibility: hidden;
            transition: background-color 0.5s ease;
        }
        .dark .main-container {
            background-color: var(--bg-main-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        /* --- নতুন: ফুলস্ক্রিন মোড ক্লাস --- */
        .main-container.full-width {
            max-width: 98% !important; /* দুই পাশের ফাঁকা স্থান কমিয়ে পুরো স্ক্রিন জুড়ে থাকবে */
        }
/* ফুলস্ক্রিন মোডে ভেতরের কন্টেন্টগুলোর প্রশস্ততা বাড়ানো */
        .main-container.full-width .font-converter-content,
        .main-container.full-width .text-assistant-content,
        .main-container.full-width .translator-content,
        .main-container.full-width .notepad-container,
        .main-container.full-width .image-to-text-content,
        .main-container.full-width .word-counter-content,
        .main-container.full-width .spell-checker-content,
        .main-container.full-width .text-beautifier-content,
        .main-container.full-width .word-meaning-content,
        .main-container.full-width .tts-content,
        .main-container.full-width .stt-content,
        .main-container.full-width .typing-test-content,
        .main-container.full-width .measurement-content,
        .main-container.full-width .qr-code-content,
        .main-container.full-width .prayer-time-content,
        .main-container.full-width .clock-container,
        .main-container.full-width .player-container,
        .main-container.full-width .emergency-numbers-content,
        .main-container.full-width .zakat-calculator-content,
        .main-container.full-width .days-observances-container,
        .main-container.full-width .history-page-container,
        .main-container.full-width .settings-page-container,
        .main-container.full-width .news-content,
        .main-container.full-width .health-lifestyle-content,
        .main-container.full-width .quiz-setup-container, 
        .main-container.full-width .quiz-container, 
        .main-container.full-width .quiz-result-container,
        .main-container.full-width .donate-section,
        .main-container.full-width .important-links-container,
        .main-container.full-width .color-picker-container,
        .main-container.full-width .age-calculator-content,
        .main-container.full-width .date-time-content,
        .main-container.full-width .weather-content,
        .main-container.full-width .scientific-calculator-content,
        .main-container.full-width .image-resizer-controls,
        .main-container.full-width #invoice-container {
            max-width: 100% !important;
        }
        
        /* ফুলস্ক্রিন মোডে সাধারণ ক্যালকুলেটর খুব বেশি বড় হলে দেখতে খারাপ লাগবে, তাই একটু লিমিট রাখা হলো */
        .main-container.full-width .calculator-grid {
             max-width: 500px; 
             width: 100%;
        }		

/* ৩. ট্যাব বাটন (ভেরিয়েবল ব্যবহার করে আপডেট করা) */
        .tab-button {
            padding: 10px 16px;
            background-color: var(--tab-bg); 
            border: var(--tab-border);
            border-radius: var(--tab-radius);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--tab-text); 
            transition: all 0.3s ease;
        }
        .dark .tab-button {
            background-color: #334155;
            color: #cbd5e1;
            border-color: #475569;
        }

        .tab-button.active {
            background-image: var(--tab-active-gradient); 
            background-color: var(--tab-active-bg);      
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(63, 81, 181, 0.3);
            transform: translateY(-2px);
        }
        .dark .tab-button.active {
            background-image: linear-gradient(135deg, #6366f1 0%, #38bdf8 100%);
        }
        
        .tab-button:hover:not(.active) {
            background-color: #e0f2fe;
            transform: translateY(-1px);
        }

        /* ডার্ক মোডে ট্যাবের ওপর হোভার করলে টেক্সট সাদা করার জন্য */
        .dark .tab-button:hover:not(.active) {
            background-color: #475569;
            color: white;
        }

        /* ৪. ফন্ট কনভার্টার সেকশন (ভেরিয়েবল ব্যবহার করে আপডেট করা) */
        .font-converter-content {
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 1000px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: var(--converter-bg); 
            border: 1px solid #f1f5f9;
            transition: background-color 0.5s ease, border-color 0.5s ease;
        }
        .dark .font-converter-content {
            background-color: #1e293b;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border-color: #334155;
        }
		
/* ========================================= */
/* END: ট্যাব থিম ভেরিয়েবল ও ডায়নামিক স্টাইল */
/* ========================================= */


/* মৌলিক ক্যালকুলেটর স্টাইল */
        .basic-calculator-wrapper {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: stretch; /* পরিবর্তন: flex-start থেকে stretch করা হয়েছে যাতে উচ্চতা সমান থাকে */
            gap: 20px;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 কলাম, সমান প্রস্থ */
            grid-template-rows: minmax(100px, auto) repeat(5, 1fr); /* ডিসপ্লে এবং 5 সারি বোতাম */
            gap: 10px; /* বোতামগুলির মধ্যে ফাঁক */
            padding: 20px; /* বর্ধিত প্যাডিং */
            border-radius: 20px; /* গোলাকার কোণ */
            background-color: #263238; /* গাঢ় ধূসর/নীল ক্যালকুলেটর ব্যাকগ্রাউন্ড */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3); /* ছায়া */
            width: 100%; /* রেস্পন্সিভ হওয়ার জন্য */
            max-width: 400px !important; /* প্রস্থ ফিক্স করা হয়েছে */
            min-height: 440px; /* নতুন: দৈর্ঘ্য বা উচ্চতা বাড়ানো হয়েছে */
        }
        .output {
            grid-column: 1 / -1; /* ডিসপ্লে পূর্ণ প্রস্থ জুড়ে বিস্তৃত */
            background-color: #1c262b; /* ডিসপ্লে ব্যাকগ্রাউন্ড */
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: space-around;
            padding: 12px; /* বর্ধিত প্যাডিং */
            border-radius: 12px; /* ডিসপ্লের জন্য গোলাকার কোণ */
            margin-bottom: 8px; /* বর্ধিত মার্জিন */
            height: 100px; /* বর্ধিত নির্দিষ্ট উচ্চতা */
            word-wrap: break-word; /* দীর্ঘ সংখ্যা ভাঙুন */
            word-break: break-all; /* দীর্ঘ সংখ্যা ভাঙুন */
            box-sizing: border-box; /* উচ্চতায় প্যাডিং এবং বর্ডার অন্তর্ভুক্ত করুন */
        }
        .output .previous-operand {
            color: rgba(255, 255, 255, 0.6); /* পূর্ববর্তী অপারেশনের রঙ */
            font-size: 1.5rem; /* বর্ধিত ফন্ট সাইজ */
            word-wrap: break-word; /* দীর্ঘ সংখ্যা ভাঙুন */
            word-break: break-all; /* দীর্ঘ সংখ্যা ভাঙুন */
            align-self: flex-end; /* ডানদিকে সারিবদ্ধ করুন */
            max-width: 100%; /* নিশ্চিত করুন যে এটি তার কন্টেইনারের বাইরে না যায় */
        }
        .output .current-operand {
            color: white; /* বর্তমান অপারেশনের রঙ */
            font-size: 2.5rem; /* ফন্ট সাইজ সামান্য সামঞ্জস্য করা হয়েছে */
            word-wrap: break-word; /* দীর্ঘ সংখ্যা ভাঙুন */
            word-break: break-all; /* দীর্ঘ সংখ্যা ভাঙুন */
            align-self: flex-end; /* ডানদিকে সারিবদ্ধ করুন */
            max-width: 100%; /* নিশ্চিত করুন যে এটি তার কন্টেইনারের বাইরে না যায় */
        }
        .calculator-button {
            cursor: pointer;
            font-size: 1.6rem; /* বর্ধিত ফন্ট সাইজ */
            border: none;
            outline: none;
            background-color: #455a64; /* বোতামের ব্যাকগ্রাউন্ড (নীল-ধূসর) */
            color: white; /* বোতামের টেক্সট রঙ */
            border-radius: 10px; /* বোতামগুলির জন্য গোলাকার কোণ */
            transition: background-color 0.2s ease-in-out, transform 0.1s ease; /* হোভার প্রভাব */
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .calculator-button:hover {
            background-color: #546e7a; /* হোভারে ব্যাকগ্রাউন্ড */
            transform: translateY(-1px);
        }
        .operator {
            background-color: #007bff; /* নীল অপারেটর বোতামের রঙ */
        }
        .operator:hover {
            background-color: #0056b3; /* নীল অপারেটর হোভার রঙ */
        }
        .equals {
            background-color: #007bff; /* ইকুয়ালস বোতামের রঙ (নীল) */
        }
        .equals:hover {
            background-color: #0056b3; /* ইকুয়ালস বোতাম হোভার রঙ (গাঢ় নীল) */
        }
        .clear {
            grid-column: span 2; /* ক্লিয়ার বোতাম দুটি কলাম জুড়ে বিস্তৃত */
            background-color: #ef5350; /* লাল ক্লিয়ার বোতামের রঙ */
            color: white; /* ক্লিয়ার বোতামের টেক্সট রঙ */
        }
        .clear:hover {
            background-color: #d32f2f; /* লাল ক্লিয়ার বোতাম হোভার রঙ */
        }
        .zero {
            grid-column: span 2; /* জিরো বোতাম দুটি কলাম জুড়ে বিস্তৃত */
        }
        
/* নতুন: হিস্টোরি প্যানেল স্টাইল */
        .history-panel {
            background-color: #263238;
            color: white;
            padding: 20px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px !important;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            /* নতুন: ফ্লেক্সবক্স ব্যবহার করে পুরো উচ্চতা নেওয়া হয়েছে */
            display: flex;
            flex-direction: column;
            height: 440px; /* ক্যালকুলেটরের সমান হাইট ফিক্স করা হয়েছে যাতে স্ক্রোলবার আসে */
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 1px solid #455a64;
            padding-bottom: 10px;
        }
        .history-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
        }
        #clearHistoryBtn {
            background-color: #ef5350;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s ease;
        }
        #clearHistoryBtn:hover {
            background-color: #d32f2f;
        }
        #history-list {
            flex-grow: 1; 
            overflow-y: auto; /* স্ক্রোল এনাবল করা হয়েছে */
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: right;
            /* ফায়ারফক্সের জন্য স্ক্রোলবার স্টাইল */
            scrollbar-width: thin;
            scrollbar-color: #546e7a #263238;
            padding-right: 5px; 
        }
        
        /* কাস্টম স্ক্রোলবার ডিজাইন (Chrome, Edge, Safari) */
        #history-list::-webkit-scrollbar {
            width: 8px;
        }

        #history-list::-webkit-scrollbar-track {
            background: #263238;
            border-radius: 4px;
        }

        #history-list::-webkit-scrollbar-thumb {
            background-color: #546e7a;
            border-radius: 4px;
            border: 2px solid #263238;
        }

        #history-list::-webkit-scrollbar-thumb:hover {
            background-color: #78909c;
        }

        #history-list li {
            padding: 8px 5px;
            border-bottom: 1px solid #37474f;
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
        }
        #history-list li:last-child {
            border-bottom: none;
        }

        /* ব্যাখ্যা বোতামের জন্য নতুন স্টাইল */
        .explain-button {
            background-color: #28a745; /* সবুজ */
            color: white;
            padding: 10px 20px;
            font-size: 1rem;
            border-radius: 10px;
            margin-top: 15px;
            margin-bottom: 5px;
            display: block; /* ব্লক লেভেল উপাদান হিসাবে সেট করুন */
            margin-left: auto; /* কেন্দ্র করার জন্য */
            margin-right: auto; /* কেন্দ্র করার জন্য */
            width: fit-content; /* কন্টেন্টের আকারের সাথে প্রস্থ সামঞ্জস্য করুন */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .explain-button:hover {
            background-color: #218838;
        }

        /* বয়স ক্যালকুলেটর স্টাইল */
        .age-calculator-content {
            padding: 20px; /* বর্ধিত প্যাডিং */
            border-radius: 16px;
            margin: 0 auto;
            max-width: 400px; /* বয়স ক্যালকুলেটরের জন্য বর্ধিত প্রস্থ */
            background-color: #f8f9fa; /* হালকা ধূসর ব্যাকগ্রাউন্ড */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        .dark .age-calculator-content {
            background-color: #2d3748;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }
        .age-calculator-content .input-group {
            margin-bottom: 20px; /* বর্ধিত মার্জিন */
            text-align: left;
        }
        .age-calculator-content .input-group label {
            display: block;
            margin-bottom: 8px; /* বর্ধিত মার্জিন */
            font-size: 1.05rem; /* বর্ধিত ফন্ট সাইজ */
            color: #333;
            font-weight: 600;
        }
        .dark .age-calculator-content .input-group label {
            color: #e2e8f0;
        }

        .age-calculator-content .input-group input[type="date"],
        .age-calculator-content .input-group input[type="number"] {
            width: 100%;
            padding: 12px; /* বর্ধিত প্যাডিং */
            border: 1px solid #cce7ff; /* হালকা নীল বর্ডার */
            border-radius: 10px;
            font-size: 1rem; /* বর্ধিত ফন্ট সাইজ */
            box-sizing: border-box; /* প্রস্থে প্যাডিং এবং বর্ডার অন্তর্ভুক্ত করুন */
            cursor: pointer;
            background-color: #eaf6ff; /* হালকা নীল ইনপুট ব্যাকগ্রাউন্ড */
            color: #333;
        }
        .dark .age-calculator-content .input-group input[type="date"],
        .dark .age-calculator-content .input-group input[type="number"] {
            background-color: #4a5568;
            border-color: #718096;
            color: #f7fafc;
        }
        .age-calculator-content .input-group input[type="date"] {
             appearance: none; /* ডিফল্ট তারিখ ইনপুট স্টাইলিং সরান */
            -webkit-appearance: none;
        }
        .age-calculator-content .calculate-button {
            background-color: #007bff; /* নীল বোতাম */
            color: white;
            padding: 14px 25px; /* বর্ধিত প্যাডিং */
            border: none;
            border-radius: 10px;
            font-size: 1.15rem; /* বর্ধিত ফন্ট সাইজ */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 100%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .age-calculator-content .calculate-button:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }
        .age-calculator-content .result-area {
            margin-top: 25px; /* বর্ধিত মার্জিন */
            padding: 20px; /* বর্ধিত প্যাডিং */
            background-color: #e6f7ff; /* ফলাফলের জন্য হালকা নীল ব্যাকগ্রাউন্ড */
            border-radius: 16px;
            border: 1px solid #b3e0ff;
            min-height: 80px; /* বর্ধিত উচ্চতা */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .dark .age-calculator-content .result-area {
            background-color: #1a202c;
            border-color: #4a5568;
        }

        .age-calculator-content .result-area p {
            font-size: 1.3rem; /* বর্ধিত ফন্ট সাইজ */
            color: #0056b3;
            font-weight: 700;
            margin: 5px 0; /* সামঞ্জস্যপূর্ণ মার্জিন */
        }
        .dark .age-calculator-content .result-area p {
            color: #90cdf4;
        }

        .age-calculator-content .result-area .error-message {
            color: #d9534f; /* ত্রুটি বার্তার জন্য লাল */
            font-size: 1rem; /* বর্ধিত ফন্ট সাইজ */
            font-weight: 500;
        }
        
        /* বছর ক্যালকুলেটরের ফলাফলের জন্য স্টাইল */
        #yearCalcResult {
            align-items: stretch;
            text-align: center;
            padding: 10px;
        }
        #yearCalcResult .result-item {
            padding: 15px;
            background-color: #ffffff;
            border-radius: 12px;
            border: 1px solid #cce7ff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .dark #yearCalcResult .result-item {
            background-color: #4a5568;
            border-color: #718096;
        }
        #yearCalcResult h3 {
            font-size: 1.1rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }
        .dark #yearCalcResult h3 {
            color: #e2e8f0;
        }
        #yearCalcResult p {
            font-size: 1.2rem;
            font-weight: 600;
        }
        #yearCalcResult .past-date {
            color: #c62828; /* লাল */
        }
        .dark #yearCalcResult .past-date {
            color: #feb2b2;
        }
        #yearCalcResult .future-date {
            color: #28a745; /* সবুজ */
        }
        .dark #yearCalcResult .future-date {
            color: #9ae6b4;
        }

        /* তারিখ ও সময় ক্যালকুলেটর স্টাইল */
        .date-time-content {
            padding: 20px; /* বর্ধিত প্যাডিং */
            border-radius: 16px;
            margin: 0 auto;
            max-width: 450px; /* বর্ধিত প্রস্থ */
            background-color: #f8f9fa; /* হালকা ধূসর ব্যাকগ্রাউন্ড */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        .dark .date-time-content {
            background-color: #2d3748;
        }
        .date-time-content .button-group {
            display: flex;
            justify-content: space-around;
            gap: 10px; /* বর্ধিত ফাঁক */
            margin-bottom: 20px; /* বর্ধিত মার্জিন */
            flex-wrap: wrap;
        }
        .date-time-content .show-date-button {
            background-color: #007bff; /* নীল বোতাম */
            color: white;
            padding: 14px 25px; /* বর্ধিত প্যাডিং */
            border: none;
            border-radius: 10px;
            font-size: 1.15rem; /* বর্ধিত ফন্ট সাইজ */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            flex: 1; /* বোতামগুলি সমান প্রস্থ নেবে */
            min-width: 160px; /* ছোট স্ক্রিনে মোড়ানোর জন্য */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .date-time-content .show-date-button:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }
        .date-time-content .result-area {
            margin-top: 25px; /* বর্ধিত মার্জিন */
            padding: 20px; /* বর্ধিত প্যাডিং */
            background-color: #e6f7ff; /* ফলাফলের জন্য হালকা নীল ব্যাকগ্রাউন্ড */
            border-radius: 16px;
            border: 1px solid #b3e0ff;
            min-height: 80px; /* বর্ধিত উচ্চতা */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start; /* টেক্সট বামদিকে সারিবদ্ধ করুন */
            text-align: left; /* টেক্সট বামদিকে সারিবদ্ধ করুন */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .dark .date-time-content .result-area {
            background-color: #1a202c;
            border-color: #4a5568;
        }

        .date-time-content .result-area p {
            font-size: 1.05rem; /* বর্ধিত ফন্ট সাইজ */
            color: #333;
            font-weight: 500;
            margin: 5px 0; /* সামঞ্জস্যপূর্ণ মার্জিন */
        }
        .dark .date-time-content .result-area p {
            color: #e2e8f0;
        }
        .date-time-content .result-area strong {
            font-weight: 700;
            color: #0056b3;
        }
        .dark .date-time-content .result-area strong {
            color: #90cdf4;
        }
        .date-time-content .result-section-title {
            font-size: 1.3rem; /* বর্ধিত ফন্ট সাইজ */
            font-weight: 700;
            color: #0056b3;
            margin-top: 15px; /* বর্ধিত মার্জিন */
            margin-bottom: 10px; /* বর্ধিত মার্জিন */
            width: 100%;
            text-align: center;
        }
        .dark .date-time-content .result-section-title {
            color: #90cdf4;
        }
        .date-time-content .result-section-title:first-child {
            margin-top: 0;
        }
        .date-time-content .input-group input[type="date"] {
            padding: 12px; /* বর্ধিত প্যাডিং */
            border: 1px solid #cce7ff; /* হালকা নীল বর্ডার */
            border-radius: 10px;
            font-size: 1rem; /* বর্ধিত ফন্ট সাইজ */
            background-color: #eaf6ff; /* হালকা নীল ইনপুট ব্যাকগ্রাউন্ড */
            color: #333;
        }
        .dark .date-time-content .input-group input[type="date"] {
            background-color: #4a5568;
            border-color: #718096;
            color: #f7fafc;
        }
        .dark .text-gray-700 {
            color: #cbd5e0;
        }

/* বৈজ্ঞানিক ক্যালকুলেটর স্টাইল */
        .scientific-calculator-content {
            padding: 20px; /* বর্ধিত প্যাডিং */
            border-radius: 20px; /* গোলাকার কোণ */
            background-color: #263238; /* গাঢ় ধূসর/নীল ক্যালকুলেটর ব্যাকগ্রাউন্ড */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3); /* ছায়া */
            margin: 0 auto;
            max-width: 500px; /* বর্ধিত প্রস্থ */
        }
        .scientific-calculator-content .input-area {
            margin-bottom: 15px; /* বর্ধিত মার্জিন */
        }
        .scientific-calculator-content .expression-input {
            width: 100%;
            padding: 12px; /* প্যাডিং কমানো হয়েছে */
            font-size: 1.5rem; /* ফন্ট সাইজ বাড়ানো হয়েছে */
            border: 1px solid #ccc;
            border-radius: 12px;
            box-sizing: border-box;
            margin-bottom: 10px; /* বর্ধিত মার্জিন */
            text-align: right;
            background-color: #1c262b;
            color: white;
            height: 70px; /* উচ্চতা বাড়ানো হয়েছে */
            word-wrap: break-word; /* দীর্ঘ সংখ্যা ভাঙুন */
            word-break: break-all; /* দীর্ঘ সংখ্যা ভাঙুন */
        }
        .scientific-calculator-content .scientific-buttons-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 5 কলাম থেকে 4 কলামে পরিবর্তন */
            gap: 10px; /* বর্ধিত ফাঁক */
            margin-bottom: 15px; /* বর্ধিত মার্জিন */
        }
        .scientific-calculator-content .scientific-button {
            padding: 14px; /* বর্ধিত প্যাডিং */
            font-size: 1.1rem; /* বর্ধিত ফন্ট সাইজ */
            border: none;
            outline: none;
            background-color: #455a64; /* বোতামের ব্যাকগ্রাউন্ড (নীল-ধূসর) */
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .scientific-calculator-content .scientific-button:hover {
            background-color: #546e7a;
            transform: translateY(-1px);
        }
        .scientific-calculator-content .scientific-button.operator-btn {
            background-color: #007bff; /* নীল অপারেটর */
        }
        .scientific-calculator-content .scientific-button.operator-btn:hover {
            background-color: #0056b3;
        }
        .scientific-calculator-content .scientific-button.clear-btn {
            background-color: #ef5350; /* লাল ক্লিয়ার */
            color: white;
        }
        .scientific-calculator-content .scientific-button.clear-btn:hover {
            background-color: #d32f2f;
        }
        .scientific-calculator-content .scientific-button.equals-btn {
            background-color: #28a745; /* ইকুয়ালস বোতামের রঙ (সবুজ) */
        }
        .scientific-calculator-content .scientific-button.equals-btn:hover {
            background-color: #218838;
        }
        /* scientific-result ক্লাসটি মুছে ফেলা হয়েছে বা হাইড করা যেতে পারে কারণ রেজাল্ট এখন ইনপুটে দেখাবে */
        .scientific-result {
            display: none; 
        }

        /* ফন্ট কনভার্টার বিভাগের স্টাইল */
        .font-converter-content {
            padding: 15px; /* বডির সাথে মিলিয়ে প্যাডিং বাড়ানো হয়েছে */
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15); /* গভীর ছায়া */
            width: 100%;
            max-width: 1000px; /* দুটি কলামের জন্য সর্বোচ্চ প্রস্থ সামঞ্জস্য করা হয়েছে */
            display: flex;
            flex-direction: column;
            gap: 12px;				/* গ্যাপ কমানো হয়েছে */
            background-color: #ffffff; /* কনভার্টার বিভাগের জন্য সাদা ব্যাকগ্রাউন্ড */
        }
        .dark .font-converter-content {
            background-color: #2d3748;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }
        .font-converter-sections-wrapper {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        @media (min-width: 768px) {
            .font-converter-sections-wrapper {
                flex-direction: row;
            }
        }
        .font-converter-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .font-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .font-section-header h2 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        .dark .font-section-header h2 {
            color: #e2e8f0;
        }
.font-converter-content textarea {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            box-sizing: border-box;
            transition: all 1.0s ease-in-out;
            color: #333; /* টেক্সটএরিয়া টেক্সট পঠনযোগ্য নিশ্চিত করুন */
            text-align: justify; /* লেখা জাস্টিফাই করবে */
            text-align-last: left; /* প্যারার শেষ লাইন বা এন্টার দেওয়া লাইন বামে রাখবে */
        }
        .dark .font-converter-content textarea {
            background-color: #1a202c;
            border-color: #4a5568;
            color: #f7fafc;
        }
/* ডানদিকের টেক্সটএরিয়ার জন্য লোড করা SutonnyMJ ফন্ট ব্যবহার করার স্টাইল */
        #textAreaRight {
            font-family: 'SUTONNYMJ', sans-serif;
            font-size: 1.3rem;
        }
        
        /* ফিক্স: প্লেসহোল্ডারের জন্য Bornomala ফন্ট ফোর্স করা হয়েছে */
        #textAreaRight::-webkit-input-placeholder {
            font-family: 'Bornomala', sans-serif !important;
            opacity: 0.7;
        }
        #textAreaRight::-moz-placeholder {
            font-family: 'Bornomala', sans-serif !important;
            opacity: 0.7;
        }
        #textAreaRight:-ms-input-placeholder {
            font-family: 'Bornomala', sans-serif !important;
            opacity: 0.7;
        }
        #textAreaRight::placeholder {
            font-family: 'Bornomala', sans-serif !important;
            opacity: 0.7;
        }
        .font-converter-content textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .font-button-group {
            display: flex;
            justify-content: center;
            gap: 4px; /* গ্যাপ কমানো হয়েছে */
            flex-wrap: wrap;
        }
        .font-converter-content button {
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        .font-converter-content button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            z-index: -1;
            transform: skewX(-20deg);
        }
        .font-converter-content button:hover:before {
            left: 100%;
        }
        .font-converter-content button:hover {
            transform: translateY(-3px);
        }
        .font-converter-content button:active {
            transform: translateY(0);
        }

        .font-conversion-button {
            background-image: linear-gradient(to right, #34d399 0%, #10b981 100%); /* সবুজ গ্রেডিয়েন্ট */
            padding: 10px 15px; /* প্যাডিং কমানো হয়েছে */
            font-size: 1.05rem; /* সামান্য বড় ফন্ট */
            border-radius: 8px; /* আরও গোলাকার */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* উন্নত ছায়া */
        }
        .font-conversion-button:hover {
            background-image: linear-gradient(to right, #10b981 0%, #059669 100%); /* হোভারে গাঢ় সবুজ গ্রেডিয়েন্ট */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        .font-conversion-button:active {
            background-image: linear-gradient(to right, #059669 0%, #047857 100%); /* সক্রিয় অবস্থায় আরও গাঢ় সবুজ */
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
        }

        .font-copy-button {
            background-image: linear-gradient(to right, #34d399 0%, #10b981 100%); /* সবুজ গ্রেডিয়েন্ট */
            padding: 8px 15px; /* কপি বোতামের জন্য ছোট */
            font-size: 0.9rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .font-copy-button:hover {
            background-image: linear-gradient(to right, #10b981 0%, #059669 100%); /* হোভারে গাঢ় সবুজ গ্রেডিয়েন্ট */
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        .font-copy-button:active {
            background-image: linear-gradient(to right, #059669 0%, #047857 100%); /* সক্রিয় অবস্থায় আরও গাঢ় সবুজ */
            transform: translateY(0);
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
        }

        .font-undo-redo-button {
            background-image: linear-gradient(to right, #60a5fa 0%, #3b82f6 100%); /* নীল গ্রেডিয়েন্ট */
            padding: 10px 15px; /* প্যাডিং কমানো হয়েছে */
            font-size: 0.95rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .font-undo-redo-button:hover {
            background-image: linear-gradient(to right, #3b82f6 0%, #2563eb 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        .font-undo-redo-button:active {
            background-image: linear-gradient(to right, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(0);
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
        }
        .font-undo-redo-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: none;
        }

        .font-clear-button {
            background-image: linear-gradient(to right, #ef5350 0%, #d32f2f 100%); /* লাল গ্রেডিয়েন্ট */
            padding: 10px 15px; /* প্যাডিং কমানো হয়েছে */
            font-size: 0.95rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .font-clear-button:hover {
            background-image: linear-gradient(to right, #d32f2f 0%, #c62828 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        .font-clear-button:active {
            background-image: linear-gradient(to right, #c62828 0%, #b71c1c 100%);
            transform: translateY(0);
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
        }

        .font-clear-all-button {
            background-image: linear-gradient(to right, #ef5350 0%, #d32f2f 100%); /* লাল গ্রেডিয়েন্ট */
            padding: 15px 30px;
            font-size: 1.05rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 100%; /* পূর্ণ প্রস্থ জুড়ে বিস্তৃত করুন */
            margin-top: 00px; /* কিছু টপ মার্জিন যোগ করুন */
        }
        .font-clear-all-button:hover {
            background-image: linear-gradient(to right, #d32f2f 0%, #c62828 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        .font-clear-all-button:active {
            background-image: linear-gradient(to right, #c62828 0%, #b71c1c 100%);
            transform: translateY(0);
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
        }


        .external-converter-link {
            display: block;
            margin-top: 100px; /* বর্ধিত মার্জিন */
            padding: 12px 18px; /* বর্ধিত প্যাডিং */
            background-color: #007bff;
            color: white;
            border-radius: 10px;
            text-decoration: none;
            font-size: 1.05rem; /* বর্ধিত ফন্ট সাইজ */
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center; /* লিঙ্কের মধ্যে টেক্সট কেন্দ্র করুন */
        }
        .external-converter-link:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }
        .dark .text-green-700 {
            color: #68d391;
        }
        .dark .text-purple-700 {
            color: #b794f4;
        }
        .dark .text-blue-700 {
            color: #63b3ed;
        }
        .dark .list-disc, .dark .list-circle {
            color: #a0aec0;
        }

        /* নতুন: পরিমাপ (ইউনিট কনভার্টার) স্টাইল */
        .measurement-content {
            padding: 20px;
            border-radius: 16px;
            margin: 0 auto;
            max-width: 800px; /* প্রস্থ বাড়ানো হয়েছে */
            background-color: #f8f9fa;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        .dark .measurement-content {
            background-color: #2d3748;
        }
        .converter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }
        .converter-section {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .dark .converter-section {
            background-color: #1a202c;
            border-color: #4a5568;
        }
        .converter-section h3 {
            font-size: 1.3rem;
            font-weight: 700;
            color: #3f51b5;
            margin-bottom: 15px;
            text-align: center;
        }
        .dark .converter-section h3 {
            color: #90cdf4;
        }
        .converter-section .input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .converter-section .input-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            text-align: left;
        }
        .converter-section label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #4a5568;
            margin-bottom: 5px;
        }
        .dark .converter-section label {
            color: #a0aec0;
        }
        .converter-section input[type="number"],
        .converter-section select {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1rem;
            background-color: #f7fafc;
        }
        .dark .converter-section input[type="number"],
        .dark .converter-section select {
            background-color: #4a5568;
            border-color: #718096;
            color: #f7fafc;
        }
        .swap-icon {
            font-size: 1.5rem;
            color: #3f51b5;
            cursor: pointer;
            transition: transform 0.3s ease;
            margin-top: 20px; /* ইনপুটের সাথে সারিবদ্ধ করতে */
        }
        .dark .swap-icon {
            color: #90cdf4;
        }
        .swap-icon:hover {
            transform: rotate(180deg);
        }

/* BMI Calculator Styles - শুরু */
.bmi-calculator {
    max-width: 450px;
    margin: 2rem auto;
    padding: 2rem;
    background-color: #f9fafb;
    border-radius: 12px;
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
    border: 1px solid #e5e7eb;
}

.bmi-title {
    text-align: center;
    color: #111827;
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.bmi-subtitle {
    text-align: center;
    color: #6b7280;
    margin-bottom: 2rem;
}

.bmi-input-group {
    margin-bottom: 1.25rem;
}

.bmi-input-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: #374151;
    font-weight: 500;
}

.bmi-input-group input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    box-sizing: border-box;
    font-size: 1rem;
    transition: border-color 0.2s, box-shadow 0.2s;
}

.bmi-input-group input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
}

.bmi-height-inputs {
    display: flex;
    gap: 1rem;
}

#bmi-calculate-btn {
    width: 100%;
    padding: 0.8rem 1rem;
    background-color: #2563eb;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

#bmi-calculate-btn:hover {
    background-color: #1d4ed8;
}

.bmi-result-section {
    margin-top: 1.5rem;
    padding: 1.25rem;
    border-radius: 8px;
    text-align: center;
    font-size: 1.1rem;
    line-height: 1.6;
    display: none; /* Initially hidden */
}

/* Result category styles */
.bmi-underweight { background-color: #e0f2fe; color: #0c4a6e; border: 1px solid #bae6fd; }
.bmi-normal { background-color: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
.bmi-overweight { background-color: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
.bmi-obese { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
/* BMI Calculator Styles - শেষ */

/* BMI ক্যালকুলেটরের জন্য ডার্ক মোড স্টাইল - শুরু */
.dark .bmi-calculator {
    background-color: #2d3748; /* bg-gray-800 */
    border-color: #4a5568; /* border-gray-600 */
}

.dark .bmi-title {
    color: #e2e8f0; /* text-gray-200 */
}

.dark .bmi-subtitle {
    color: #a0aec0; /* text-gray-400 */
}

.dark .bmi-input-group label {
    color: #cbd5e0; /* text-gray-300 */
}

.dark .bmi-input-group input {
    background-color: #4a5568; /* bg-gray-600 */
    border-color: #718096; /* border-gray-500 */
    color: #f7fafc; /* text-gray-100 */
}

.dark .bmi-input-group input:focus {
    border-color: #63b3ed; /* border-blue-400 */
    box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.3);
}

/* ডার্ক মোডে ফলাফলের জন্য স্টাইল */
.dark .bmi-underweight { background-color: #1e3a8a; color: #bfdbfe; border: 1px solid #3b82f6; } /* bg-blue-900, text-blue-200, border-blue-500 */
.dark .bmi-normal { background-color: #064e3b; color: #a7f3d0; border: 1px solid #34d399; } /* bg-green-900, text-green-300, border-green-500 */
.dark .bmi-overweight { background-color: #78350f; color: #fde68a; border: 1px solid #f59e0b; } /* bg-amber-900, text-amber-300, border-amber-500 */
.dark .bmi-obese { background-color: #7f1d1d; color: #fecaca; border: 1px solid #ef4444; } /* bg-red-900, text-red-300, border-red-500 */
/* BMI ক্যালকুলেটরের জন্য ডার্ক মোড স্টাইল - শেষ */

        /* টেক্সট অ্যাসিস্ট্যান্ট (চ্যাট) বিভাগের নতুন স্টাইল */
        .text-assistant-content {
            padding: 20px;
            border-radius: 16px;
            margin: 0 auto;
            max-width: 600px; /* চ্যাটের জন্য প্রস্থ বাড়ানো হয়েছে */
            background-color: #f8f9fa;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        .dark .text-assistant-content {
            background-color: #2d3748;
        }
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .chat-header h3 {
            font-size: 1.4rem;
            font-weight: 700;
            color: #333;
        }
        .dark .chat-header h3 {
            color: #e2e8f0;
        }
        .clear-chat-button {
            background-color: #ef5350;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .clear-chat-button:hover {
            background-color: #d32f2f;
        }
        .chat-window {
            height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 15px;
            background-color: #e6f7ff;
            border-radius: 16px;
            border: 1px solid #b3e0ff;
            margin-bottom: 15px;
        }
        .dark .chat-window {
            background-color: #1a202c;
            border-color: #4a5568;
        }
        .message {
            padding: 10px 15px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.6;
        }
        .user-message {
            background-color: #3f51b5;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }
        .gemini-message {
            background-color: #ffffff;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .dark .gemini-message {
            background-color: #4a5568;
            color: #f7fafc;
        }
        .gemini-error-message {
            background-color: #ffebee;
            color: #c62828;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }
        .input-container {
            display: flex;
            gap: 10px;
            align-items: stretch; /* বোতাম এবং টেক্সটএরিয়া একই উচ্চতায় রাখুন */
        }
        .text-assistant-content textarea {
            flex-grow: 1;
            height: auto;
            min-height: 50px;
            padding: 12px;
            margin-bottom: 0;
            border: 1px solid #cce7ff;
            border-radius: 10px;
            font-size: 1rem;
            resize: vertical;
        }
        .dark .text-assistant-content textarea {
            background-color: #4a5568;
            border-color: #718096;
            color: #f7fafc;
        }
        .text-assistant-content .ask-button {
            width: auto;
            margin-bottom: 0;
            flex-shrink: 0;
            background-color: #8A2BE2;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            cursor: pointer;
        }
        .text-assistant-content .loading-indicator {
            display: none;
            text-align: center;
            padding: 10px;
            font-size: 1rem;
            color: #555;
        }
        .dark .text-assistant-content .loading-indicator {
            color: #a0aec0;
        }

        /* নতুন: ফাইল আপলোড প্রিভিউ স্টাইল */
        #filePreviewContainer {
            background-color: #e6f7ff;
            border-color: #b3e0ff;
        }
        .dark #filePreviewContainer {
            background-color: #1a202c;
            border-color: #4a5568;
        }
        #filePreviewContainer img, #filePreviewContainer video {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
            object-fit: cover;
        }
        #removeFileBtn {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #ef5350;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: #333;
        }
        .dark .file-info {
            color: #e2e8f0;
        }
        .user-message img {
            max-width: 150px;
            border-radius: 8px;
            margin-top: 8px;
        }
/* Message copy button styles START */
    .message {
        position: relative; /* This is needed for the absolute positioning of the button */
        /* আপনার .message ক্লাসের অন্যান্য স্টাইলগুলো এখানে থাকবে... */
        /* যেমন: padding, border-radius, max-width, ইত্যাদি। */
    }

    .copy-message-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        background-color: #e2e8f0; /* light gray */
        color: #475569; /* dark gray text */
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s ease-in-out, background-color 0.2s;
        z-index: 5;
    }

    .dark .copy-message-btn {
        background-color: #4a5568; /* dark mode gray */
        color: #e2e8f0; /* light text */
    }

    .message:hover .copy-message-btn {
        opacity: 1; /* Show on hover */
    }

    .copy-message-btn:hover {
        background-color: #cbd5e0; /* light gray hover */
    }

    .dark .copy-message-btn:hover {
        background-color: #718096; /* dark mode gray hover */
    }
    /* Message copy button styles END */
	
        /* নতুন: বাংলা বানান সংশোধন স্টাইল */
        .spell-checker-content {
            padding: 20px;
            border-radius: 16px;
            margin: 0 auto;
            max-width: 600px;
            background-color: #f8f9fa;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        .dark .spell-checker-content {
            background-color: #2d3748;
        }
        .spell-checker-content textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #cce7ff;
            border-radius: 10px;
            font-size: 1.1rem;
            resize: vertical;
            box-sizing: border-box;
            background-color: #eaf6ff;
            color: #333;
        }
        .dark .spell-checker-content textarea {
            background-color: #4a5568;
            border-color: #718096;
            color: #f7fafc;
        }
        .spell-checker-content .result-area #spellCheckResult {
            min-height: 150px;
            background-color: #ffffff;
            border-radius: 8px;
            border: 1px solid #ddd;
            padding: 12px;
            white-space: pre-wrap; /* ফরম্যাটিং বজায় রাখতে */
        }
        .dark .spell-checker-content .result-area #spellCheckResult {
            background-color: #1a202c;
            border-color: #4a5568;
            color: #e2e8f0;
        }

        /* বানান পরীক্ষা করুন বোতামের জন্য নতুন সুন্দর স্টাইল */
        .spell-check-button {
            background-image: linear-gradient(to right, #8A2BE2 0%, #4A00E0 100%); /* বেগুনি গ্রেডিয়েন্ট */
            color: white;
            padding: 14px 25px;
            border: none;
            border-radius: 12px; /* আরও গোলাকার */
            font-size: 1.15rem;
            font-weight: 700; /* বোল্ড */
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            width: 100%;
            box-shadow: 0 5px 15px rgba(74, 0, 224, 0.3); /* রঙের সাথে মানানসই ছায়া */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px; /* আইকন এবং টেক্সটের মধ্যে ফাঁক */
        }

        .spell-check-button:hover {
            background-image: linear-gradient(to right, #9932CC 0%, #5D00EE 100%); /* হোভারে ভিন্ন গ্রেডিয়েন্ট */
            transform: translateY(-2px); /* উপরে ওঠার প্রভাব */
            box-shadow: 0 8px 20px rgba(74, 0, 224, 0.4); /* গভীর ছায়া */
        }

        .spell-check-button:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px rgba(74, 0, 224, 0.3);
        }

        /* নতুন: লেখা সাজানো স্টাইল */
        .text-beautifier-content {
            padding: 20px;
            border-radius: 16px;
            margin: 0 auto;
            max-width: 600px;
            background-color: #f8f9fa;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        .dark .text-beautifier-content {
            background-color: #2d3748;
        }
        .text-beautifier-content textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #cce7ff;
            border-radius: 10px;
            font-size: 1.1rem;
            resize: vertical;
            box-sizing: border-box;
            background-color: #eaf6ff;
            color: #333;
        }
        .dark .text-beautifier-content textarea {
            background-color: #4a5568;
            border-color: #718096;
            color: #f7fafc;
        }
        .text-beautifier-content .result-area #beautifyResult {
            min-height: 150px;
            background-color: #ffffff;
            border-radius: 8px;
            border: 1px solid #ddd;
            padding: 12px;
            white-space: pre-wrap; /* ফরম্যাটিং বজায় রাখতে */
        }
        .dark .text-beautifier-content .result-area #beautifyResult {
            background-color: #1a202c;
            border-color: #4a5568;
            color: #e2e8f0;
        }

        /* লেখা সাজানো বোতামের জন্য নতুন সুন্দর স্টাইল */
        .beautify-button {
            background-image: linear-gradient(to right, #20c997 0%, #087f5b 100%); /* টিল/সায়ান গ্রেডিয়েন্ট */
            color: white;
            padding: 14px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1.15rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            width: 100%;
            box-shadow: 0 5px 15px rgba(32, 201, 151, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .beautify-button:hover {
            background-image: linear-gradient(to right, #12b886 0%, #099268 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(32, 201, 151, 0.4);
        }

        .beautify-button:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px rgba(32, 201, 151, 0.3);
        }

        /* নতুন: শব্দের অর্থ বিভাগের স্টাইল */
        .word-meaning-content {
            padding: 20px;
            border-radius: 16px;
            margin: 0 auto;
            max-width: 600px;
            background-color: #f8f9fa;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        .dark .word-meaning-content {
            background-color: #2d3748;
        }
        .word-meaning-content input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #cce7ff;
            border-radius: 10px;
            font-size: 1.1rem;
            box-sizing: border-box;
            background-color: #eaf6ff;
            color: #333;
        }
        .dark .word-meaning-content input[type="text"] {
            background-color: #4a5568;
            border-color: #718096;
            color: #f7fafc;
        }
        .word-meaning-content .result-area #wordMeaningResult {
            min-height: 150px;
            background-color: #ffffff;
            border-radius: 8px;
            border: 1px solid #ddd;
            padding: 12px;
            white-space: pre-wrap; /* ফরম্যাটিং বজায় রাখতে */
            text-align: left;
        }
        .dark .word-meaning-content .result-area #wordMeaningResult {
            background-color: #1a202c;
            border-color: #4a5568;
            color: #e2e8f0;
        }

        .find-meaning-button {
            background-image: linear-gradient(to right, #fd7e14 0%, #f76707 100%); /* কমলা গ্রেডিয়েন্ট */
            color: white;
            padding: 14px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1.15rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            width: 100%;
            box-shadow: 0 5px 15px rgba(253, 126, 20, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .find-meaning-button:hover {
            background-image: linear-gradient(to right, #f76707 0%, #e8590c 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(253, 126, 20, 0.4);
        }

        .find-meaning-button:active {
            transform: translateY(0);
            box-shadow: 0 5px 15px rgba(253, 126, 20, 0.3);
        }
        
        /* নতুন: টেক্সট টু স্পিচ (TTS) স্টাইল */
        .tts-content {
            padding: 20px;
            border-radius: 16px;
            margin: 0 auto;
            max-width: 600px;
            background-color: #f8f9fa;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        .dark .tts-content {
            background-color: #2d3748;
        }
        .tts-content textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #cce7ff;
            border-radius: 10px;
            font-size: 1.1rem;
            resize: vertical;
            box-sizing: border-box;
            background-color: #eaf6ff;
            color: #333;
            margin-bottom: 20px;
        }
        .dark .tts-content textarea {
            background-color: #4a5568;
            border-color: #718096;
            color: #f7fafc;
        }
        .tts-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            text-align: left;
        }
        .control-group label {
            font-weight: 600;
            color: #333;
            min-width: 120px;
        }
        .dark .control-group label {
            color: #e2e8f0;
        }
        .control-group select, .control-group input[type="range"] {
            flex-grow: 1;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #cce7ff;
            background-color: #eaf6ff;
        }
        .dark .control-group select, .dark .control-group input[type="range"] {
            background-color: #4a5568;
            border-color: #718096;
            color: #f7fafc;
        }
        .control-group input[type="range"] {
            cursor: pointer;
        }
        .control-group span {
            font-weight: 500;
            min-width: 25px;
            text-align: center;
        }
        .dark .control-group span {
            color: #e2e8f0;
        }
        .tts-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .tts-button {
            color: white;
            padding: 12px 22px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .tts-button.speak {
            background-color: #28a745; /* Green */
        }
        .tts-button.speak:hover {
            background-color: #218838;
        }
        .tts-button.pause {
            background-color: #ffc107; /* Yellow */
        }
        .tts-button.pause:hover {
            background-color: #e0a800;
        }
        .tts-button.resume {
            background-color: #17a2b8; /* Cyan */
        }
        .tts-button.resume:hover {
            background-color: #138496;
        }
        .tts-button.stop {
            background-color: #dc3545; /* Red */
        }
        .tts-button.stop:hover {
            background-color: #c82333;
        }
		/* New download button style */
        .tts-button.download {
            background-color: #007bff; /* Blue */
        }
        .tts-button.download:hover:not(:disabled) {
            background-color: #0056b3;
        }
        .tts-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        /* New clear button style for TTS/STT */
        .tts-button.clear-input,
        .stt-button.clear-input {
            background-image: linear-gradient(to right, #ef5350 0%, #d32f2f 100%); /* Red gradient */
            color: white;
            padding: 12px 22px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .tts-button.clear-input:hover,
        .stt-button.clear-input:hover {
            background-image: linear-gradient(to right, #d32f2f 0%, #c62828 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        .tts-button.clear-input:active,
        .stt-button.clear-input:active {
            background-image: linear-gradient(to right, #c62828 0%, #b71c1c 100%);
            transform: translateY(0);
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
        }


        /* নতুন: স্পিচ টু টেক্সট (STT) স্টাইল */
        .stt-content {
            padding: 20px;
            border-radius: 16px;
            margin: 0 auto;
            max-width: 600px;
            background-color: #f8f9fa;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        .dark .stt-content {
            background-color: #2d3748;
        }
        .stt-content textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #cce7ff;
            border-radius: 10px;
            font-size: 1.1rem;
            resize: vertical;
            box-sizing: border-box;
            background-color: #eaf6ff;
            color: #333;
            margin-bottom: 20px;
        }
        .dark .stt-content textarea {
            background-color: #4a5568;
            border-color: #718096;
            color: #f7fafc;
        }
        .stt-status {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            padding: 10px;
            background-color: #e6f7ff;
            border-radius: 8px;
            border: 1px solid #b3e0ff;
        }
        .dark .stt-status {
            background-color: #1a202c;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        .stt-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .stt-button {
            color: white;
            padding: 12px 22px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .stt-button.start {
            background-color: #28a745; /* Green */
        }
        .stt-button.start:hover {
            background-color: #218838;
        }
        .stt-button.stop {
            background-color: #dc3545; /* Red */
        }
        .stt-button.stop:hover {
            background-color: #c82333;
        }
        .stt-button.copy {
            background-color: #007bff; /* Blue */
        }
        .stt-button.copy:hover {
            background-color: #0056b3;
        }
        .stt-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        /* নতুন: টাইপিং টেস্ট স্টাইল */
        .typing-test-content {
            padding: 20px;
            border-radius: 16px;
            margin: 0 auto;
            max-width: 800px;
            background-color: #f8f9fa;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        .dark .typing-test-content {
            background-color: #2d3748;
        }
        .typing-settings {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .typing-settings label {
            font-weight: 600;
            color: #333;
        }
        .dark .typing-settings label {
            color: #e2e8f0;
        }
        .typing-settings select, .typing-settings textarea {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #cce7ff;
            background-color: #eaf6ff;
            cursor: pointer;
        }
        .dark .typing-settings select, .dark .typing-settings textarea {
            background-color: #4a5568;
            border-color: #718096;
            color: #f7fafc;
        }
        #custom-text-input {
            width: 100%;
            margin-top: 10px;
            resize: vertical;
        }
        .typing-text-display {
            font-size: 1.2rem;
            line-height: 2.5rem;
            letter-spacing: 1px;
            padding: 20px;
            border-radius: 12px;
            background-color: #e6f7ff;
            border: 1px solid #b3e0ff;
            margin-bottom: 20px;
            text-align: justify;
            user-select: none;
            height: 180px;
            overflow-y: auto;
        }
        .dark .typing-text-display {
            background-color: #1a202c;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        .typing-text-display span.correct {
            color: #28a745;
        }
        .typing-text-display span.incorrect {
            color: #dc3545;
            text-decoration: underline;
        }
        .typing-text-display span.current {
            background-color: #b3e0ff;
            border-radius: 4px;
        }
        .dark .typing-text-display span.current {
             background-color: #4a5568;
        }
        .typing-input {
            width: 100%;
            padding: 15px;
            font-size: 1rem;
            border: 2px solid #007bff;
            border-radius: 10px;
            box-sizing: border-box;
        }
        .typing-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3);
        }
        .typing-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .dark .typing-stats {
            background-color: #1a202c;
        }
        .stat-item {
            text-align: center;
        }
        .stat-item h4 {
            font-size: 1rem;
            color: #555;
            margin-bottom: 5px;
        }
        .dark .stat-item h4 {
            color: #a0aec0;
        }
        .stat-item p {
            font-size: 1rem;
            font-weight: 700;
            color: #3f51b5;
        }
        .dark .stat-item p {
            color: #90cdf4;
        }
        .typing-controls {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .typing-btn {
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .typing-btn.restart {
             background-image: linear-gradient(to right, #60a5fa 0%, #3b82f6 100%);
        }
        .typing-btn.clear {
            background-image: linear-gradient(to right, #ef5350 0%, #d32f2f 100%);
        }
		/* নতুন: টাইপিং টেস্টের পজ/রিজিউম বাটনের জন্য স্টাইল */
        .typing-btn.pause {
            background-image: linear-gradient(to right, #ffc107 0%, #f7b733 100%); /* হলুদ গ্রেডিয়েন্ট */
        }

        .typing-btn.pause:hover {
            background-image: linear-gradient(to right, #f7b733 0%, #e0a800 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        .typing-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
/* নতুন: টাইপিং টেস্ট ফলাফল রিপোর্টের জন্য স্টাইল */
        #typingTestResultReport {
            background-color: #f0f9ff; /* light blue background */
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e0f2fe;
        }
        .dark #typingTestResultReport {
            background-color: #1f2937; /* dark blue-gray */
            border-color: #374151;
        }
        #typingHistoryTableBody tr:nth-child(even) {
            background-color: #f8fafc;
        }
        .dark #typingHistoryTableBody tr:nth-child(even) {
            background-color: #374151;
        }
        /* ডার্ক মোডে টেবিলের হেডার এবং বডির লেখার রঙ সাদা করার জন্য */
        .dark #typingTestResultReport th, 
        .dark #typingHistoryTableBody td {
            color: #e2e8f0;
        }
        /* নতুন: ট্রান্সলেটর স্টাইল */
        .translator-content {
            padding: 20px;
            border-radius: 16px;
            margin: 0 auto;
            max-width: 800px; /* সাইড-বাই-সাইড টেক্সটএরিয়ার জন্য প্রস্থ বাড়ানো হয়েছে */
            background-color: #f8f9fa;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        .dark .translator-content {
            background-color: #2d3748;
        }
        .translator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .translator-section textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #cce7ff;
            border-radius: 10px;
            font-size: 1.1rem;
            resize: vertical;
            box-sizing: border-box;
            background-color: #eaf6ff;
            color: #333;
            min-height: 200px;
        }
        .dark .translator-section textarea {
            background-color: #4a5568;
            border-color: #718096;
            color: #f7fafc;
        }
        .translator-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .language-selector-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .dark .language-selector-wrapper label {
            color: #e2e8f0;
        }
        .translator-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .translate-button {
            background-image: linear-gradient(to right, #2980B9 0%, #6DD5FA 100%);
            color: white;
            padding: 14px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1.15rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            width: auto;
            box-shadow: 0 5px 15px rgba(41, 128, 185, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .translate-button:hover {
            background-image: linear-gradient(to right, #6DD5FA 0%, #2980B9 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(41, 128, 185, 0.4);
        }

        /* কন্টেন্ট প্রাথমিকভাবে লুকানো */
        .calculator-content {
            display: none;
        }
        .calculator-content.active {
            display: block;
        }

/* নতুন: গুগল ম্যাপ স্টাইল */
.map-container {
    padding: 10px;
    border-radius: 16px;
    margin: 0 auto;
    max-width: 98%; /* প্রস্থ প্রায় সম্পূর্ণ স্ক্রিন জুড়ে দেওয়া হলো */
    background-color: #f8f9fa;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}
.dark .map-container {
    background-color: #2d3748;
}
.map-container iframe {
    border-radius: 12px;
    width: 100%;
    height: 65vh; /* উচ্চতা ভিউপোর্টের উচ্চতার ৬৫% করা হলো */
}
@media (max-width: 600px) {
    .map-container iframe {
        height: 55vh; /* মোবাইল ডিভাইসের জন্য উচ্চতা */
    }
}

/* গুগল ম্যাপের নতুন ফিচারগুলোর জন্য স্টাইল */
    .map-features {
        max-width: 98%;
        margin: 1rem auto 0;
        border: 1px solid #e2e8f0;
    }

    .dark .map-features {
        border-color: #4a5568;
    }

    .feature-section:not(:last-child) {
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 1rem;
    }

    .dark .feature-section:not(:last-child) {
        border-color: #4a5568;
    }

    .feature-section input[type="text"] {
        transition: all 0.3s ease;
    }

    .feature-section button {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    /* নতুন: নামাজের সময়সূচি স্টাইল */
    .prayer-time-content {
        padding: 20px;
        border-radius: 16px;
        margin: 0 auto;
        max-width: 800px;
        background-color: #f8f9fa;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    .dark .prayer-time-content {
        background-color: #2d3748;
    }
    .prayer-times-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        text-align: center;
    }
    .prayer-time-card {
        background-color: #e6f7ff;
        border: 1px solid #b3e0ff;
        border-radius: 12px;
        padding: 20px 15px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .dark .prayer-time-card {
        background-color: #1a202c;
        border-color: #4a5568;
    }
    .prayer-time-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    .prayer-time-card h4 {
        font-size: 1.1rem;
        font-weight: 700;
        color: #0056b3;
        margin-bottom: 10px;
    }
    .dark .prayer-time-card h4 {
        color: #90cdf4;
    }
    .prayer-time-card p {
        font-size: 1.5rem;
        font-weight: 700;
        color: #333;
    }
    .dark .prayer-time-card p {
        color: #e2e8f0;
    }
	
/* টগল সুইচের জন্য CSS (ছোট আকারের জন্য আপডেট করা হয়েছে) */
.switch {
    position: relative;
    display: inline-block;
    width: 40px;  /* কমানো হয়েছে */
    height: 20px; /* কমানো হয়েছে */
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    -webkit-transition: .4s;
    transition: .4s;
}

.slider:before {
    position: absolute;
    content: "";
    height: 14px; /* কমানো হয়েছে */
    width: 14px;  /* কমানো হয়েছে */
    left: 3px;    /* সামঞ্জস্য করা হয়েছে */
    bottom: 3px;  /* সামঞ্জস্য করা হয়েছে */
    background-color: white;
    -webkit-transition: .4s;
    transition: .4s;
}

input:checked + .slider {
    background-color: #2196F3;
}

input:focus + .slider {
    box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
    -webkit-transform: translateX(20px); /* সামঞ্জস্য করা হয়েছে */
    -ms-transform: translateX(20px);    /* সামঞ্জস্য করা হয়েছে */
    transform: translateX(20px);       /* সামঞ্জস্য করা হয়েছে */
}

/* Rounded sliders */
.slider.round {
    border-radius: 20px; /* সামঞ্জস্য করা হয়েছে */
}

.slider.round:before {
    border-radius: 50%;
}

        /* API কী মডেল স্টাইল */
        .api-key-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* গাঢ় ব্যাকগ্রাউন্ড */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(8px); /* ব্যাকগ্রাউন্ড ব্লার */
        }

        .api-key-modal-content {
            background-color: #ffffff;
            padding: 30px; /* বর্ধিত প্যাডিং */
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3); /* গভীর ছায়া */
            max-width: 450px;
            width: 90%;
            text-align: center;
            transform: translateY(-30px); /* সামান্য উপর থেকে আসবে */
            animation: fadeInScale 0.4s ease-out forwards;
        }
        .dark .api-key-modal-content {
            background-color: #2d3748;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .api-key-modal-content h3 {
            font-size: 1.8rem; /* বর্ধিত ফন্ট সাইজ */
            font-weight: 700;
            color: #333;
            margin-bottom: 25px; /* বর্ধিত মার্জিন */
        }
        .dark .api-key-modal-content h3 {
            color: #e2e8f0;
        }

        .api-key-modal-content input[type="text"] {
            width: 100%;
            padding: 15px; /* বর্ধিত প্যাডিং */
            margin-bottom: 20px; /* বর্ধিত মার্জিন */
            border: 1px solid #cce7ff; /* হালকা নীল বর্ডার */
            border-radius: 10px;
            font-size: 1.05rem;
            box-sizing: border-box;
            background-color: #eaf6ff; /* হালকা নীল ইনপুট ব্যাকগ্রাউন্ড */
            color: #333;
        }
        .dark .api-key-modal-content input[type="text"] {
            background-color: #4a5568;
            border-color: #718096;
            color: #f7fafc;
        }

        .api-key-modal-content .modal-buttons {
            display: flex;
            justify-content: space-around;
            gap: 15px; /* বর্ধিত ফাঁক */
        }

        .api-key-modal-content .modal-button {
            padding: 12px 25px; /* বর্ধিত প্যাডিং */
            border: none;
            border-radius: 10px;
            font-size: 1.05rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            flex: 1;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .api-key-modal-content .modal-button.save {
            background-color: #28a745; /* সবুজ */
            color: white;
        }
        .api-key-modal-content .modal-button.save:hover {
            background-color: #218838;
            transform: translateY(-1px);
        }

        .api-key-modal-content .modal-button.cancel {
            background-color: #ef5350; /* লাল */
            color: white;
        }
        .api-key-modal-content .modal-button.cancel:hover {
            background-color: #d32f2f;
            transform: translateY(-1px);
        }

        .api-key-modal-content .message-area {
            margin-top: 20px; /* বর্ধিত মার্জিন */
            font-size: 1rem;
            font-weight: 500;
            min-height: 25px; /* বার্তা প্রদর্শনের জন্য ন্যূনতম উচ্চতা */
        }
        .api-key-modal-content .message-area.success {
            color: #28a745; /* সবুজ */
        }
        .dark .api-key-modal-content .message-area.success {
            color: #68d391;
        }
        .api-key-modal-content .message-area.error {
            color: #d9534f; /* লাল */
        }
        .dark .api-key-modal-content .message-area.error {
            color: #fc8181;
        }
        .dark .response-area {
            background-color: #1a202c !important;
            border-color: #4a5568 !important;
            color: #e2e8f0;
        }

        /* নতুন: বর্তমান তারিখ ও সময় ব্যানার */
        #currentDateTimeBanner {
            display: flex; /* Flexbox ব্যবহার করুন */
            justify-content: center; /* অনুভূমিকভাবে মাঝখানে আনুন */
            align-items: center; /* উল্লম্বভাবে মাঝখানে আনুন */
            flex-wrap: wrap; /* ছোট স্ক্রিনে টেক্সট মোড়ানোর জন্য */
            text-align: center;
            font-size: 0.95rem; /* ফন্ট সাইজ সামঞ্জস্য করুন */
            font-weight: 600;
            margin-bottom: 10px; /* এখানে মার্জিন কমানো হয়েছে */
            margin-top: 0px; /* এখানে মার্জিন কমানো হয়েছে */
            padding: 05px 05px; /* প্যাডিং যোগ করুন */
            background-color: #e0e7ff; /* হালকা নীল ব্যাকগ্রাউন্ড */
            border-radius: 15px; /* গোলাকার কোণ */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* হালকা শ্যাডো */
            color: #3f51b5; /* টেক্সটের রঙ */
            line-height: 1.5; /* লাইন উচ্চতা */
            transition: opacity 0.5s ease-in-out; /* অ্যানিমেশনের জন্য এই লাইনটি যোগ করা হয়েছে */
        }
        .dark #currentDateTimeBanner {
            background-color: #2d3748; /* ডার্ক মোডে গাঢ় ব্যাকগ্রাউন্ড */
            color: #cbd5e0; /* ডার্ক মোডে হালকা টেক্সট */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        #currentDateTimeBanner span {
            margin: 0 4px; /* প্রতিটি অংশের মধ্যে সামান্য ফাঁক */
        }

        /* ছোট স্ক্রিনের জন্য প্রতিক্রিয়াশীল সামঞ্জস্য */
        @media (max-width: 768px) {
            .translator-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 600px) {
            .main-container {
                padding: 15px;
                border-radius: 15px;
            }
            #preloader-name {
                font-size: 1.8rem;
            }
            #currentDateTimeBanner {
                font-size: 0.8rem; /* ছোট স্ক্রিনে ফন্ট সাইজ আরও কমানো */
                padding: 8px 10px;
                margin-bottom: 0px; /* এখানে মার্জিন কমানো হয়েছে */
                margin-top: 0px; /* এখানে মার্জিন কমানো হয়েছে */
            }
            #currentDateTimeBanner span {
                margin: 0 2px;
            }
            .tab-buttons {
                margin-bottom: 15px;
                gap: 6px;
            }
            .tab-button {
                padding: 8px 10px;
                font-size: 0.8rem;
                border-radius: 8px;
            }
            .calculator-grid {
                grid-template-columns: repeat(4, 1fr);
                grid-template-rows: minmax(80px, auto) repeat(5, 1fr);
                gap: 8px;
                padding: 15px;
                max-width: 320px;
            }
            .calculator-button {
                font-size: 1.4rem;
                border-radius: 8px;
            }
            .output {
                height: 80px;
                padding: 10px;
                border-radius: 10px;
            }
            .output .current-operand {
                font-size: 2.4rem; /* ছোট স্ক্রিনের জন্য ফন্ট সাইজ কমানো হয়েছে */
            }
            .output .previous-operand {
                font-size: 1.3rem;
            }
            .explain-button {
                padding: 8px 15px;
                font-size: 0.9rem;
                border-radius: 8px;
            }
            .age-calculator-content,
            .date-time-content,
            .scientific-calculator-content,
            .news-content,
            .font-converter-content,
            .measurement-content, /* Measurement content responsiveness */
            .text-assistant-content,
            .spell-checker-content,
            .text-beautifier-content,
            .word-meaning-content,
            .tts-content,
            .stt-content,
            .typing-test-content,
            .translator-content { /* Translator content responsiveness */
                padding: 15px;
                border-radius: 12px;
            }
            .age-calculator-content .input-group label,
            .date-time-content .input-group label {
                font-size: 0.95rem;
            }
            .age-calculator-content .input-group input[type="date"],
            .date-time-content .input-group input[type="date"] {
                padding: 10px;
                font-size: 0.9rem;
                border-radius: 8px;
            }
            .age-calculator-content .calculate-button,
            .date-time-content .show-date-button {
                padding: 12px 20px;
                font-size: 1.05rem;
                border-radius: 8px;
            }
            .age-calculator-content .result-area p,
            .date-time-content .result-area p {
                font-size: 1rem;
            }
            .scientific-calculator-content .expression-input {
                font-size: 1.1rem; /* ছোট স্ক্রিনের জন্য ফন্ট সাইজ কমানো হয়েছে */
                padding: 10px; /* ছোট স্ক্রিনের জন্য প্যাডিং কমানো হয়েছে */
                height: 45px; /* ছোট স্ক্রিনের জন্য উচ্চতা কমানো হয়েছে */
                border-radius: 10px;
            }
            .scientific-button { /* বৈজ্ঞানিক বোতামের জন্য সামঞ্জস্যপূর্ণ */
                font-size: 0.9rem;
                padding: 10px;
                border-radius: 8px;
            }
            .scientific-result { /* বৈজ্ঞানিক ফলাফলের জন্য সামঞ্জস্যপূর্ণ */
                font-size: 1.4rem;
                padding: 15px;
                min-height: 55px;
                border-radius: 12px;
            }
            .news-content .news-display-area h3 {
                font-size: 1.3rem;
            }
            .news-content .news-display-area a {
                font-size: 0.95rem;
            }
            .font-converter-content textarea {
                height: 100px;
                font-size: 0.95rem;
                border-radius: 8px;
            }
            .font-converter-content .font-conversion-button { /* কনভার্টার বোতাম থেকে পরিবর্তিত */
                padding: 10px 15px;
                font-size: 0.95rem;
                min-width: 140px;
                border-radius: 8px;
            }
            .font-converter-content .font-copy-button { /* কনভার্টার বোতাম থেকে পরিবর্তিত */
                padding: 8px 12px;
                font-size: 0.85rem;
                border-radius: 8px;
            }
            .font-undo-redo-button {
                padding: 8px 12px;
                font-size: 0.85rem;
                border-radius: 8px;
            }
            .font-clear-button {
                padding: 8px 12px;
                font-size: 0.85rem;
                border-radius: 8px;
            }
            .font-clear-all-button {
                padding: 12px 20px;
                font-size: 0.95rem;
                border-radius: 8px;
            }
            .text-assistant-content textarea {
                height: 120px;
                font-size: 0.95rem;
                border-radius: 8px;
            }
            .text-assistant-content .ask-button {
                padding: 12px 20px;
                font-size: 1.05rem;
                border-radius: 8px;
            }
            .api-key-modal-content {
                padding: 20px;
                border-radius: 15px;
            }
            .api-key-modal-content h3 {
                font-size: 1.5rem;
            }
            .api-key-modal-content input[type="text"] {
                padding: 12px;
                font-size: 0.95rem;
                border-radius: 8px;
            }
            .api-key-modal-content .modal-button {
                padding: 10px 15px;
                font-size: 0.95rem;
                border-radius: 8px;
            }
        }
		/* নতুন: ছবি থেকে লেখা (OCR) স্টাইল */
.image-to-text-content {
    padding: 20px;
    border-radius: 16px;
    margin: 0 auto;
    max-width: 600px;
    background-color: #f8f9fa;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}
.dark .image-to-text-content {
    background-color: #2d3748;
}
.image-upload-area {
    border: 2px dashed #007bff;
    border-radius: 12px;
    padding: 30px;
    text-align: center;
    cursor: pointer;
    background-color: #eaf6ff;
    transition: background-color 0.3s ease;
}
.dark .image-upload-area {
    border-color: #63b3ed;
    background-color: #1a202c;
}
.image-upload-area:hover {
    background-color: #d4eaff;
}
.dark .image-upload-area:hover {
    background-color: #2c3748;
}
.image-upload-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
    color: #007bff;
    font-weight: 600;
    cursor: pointer;
}
.dark .image-upload-label {
    color: #63b3ed;
}
.image-preview {
    margin-top: 20px;
    text-align: center;
    position: relative;
}
.image-preview img {
    max-width: 100%;
    max-height: 300px;
    border-radius: 12px;
    border: 2px solid #b3e0ff;
}
.dark .image-preview img {
    border-color: #4a5568;
}
.image-preview .remove-image-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background-color: rgba(239, 83, 80, 0.8);
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    font-size: 1.5rem;
    line-height: 1;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
.extract-text-button {
    background-image: linear-gradient(to right, #6d28d9 0%, #4c1d95 100%); /* Deep Purple Gradient */
    color: white;
    padding: 14px 25px;
    border: none;
    border-radius: 12px;
    font-size: 1.15rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease-in-out;
    width: 100%;
    box-shadow: 0 5px 15px rgba(109, 40, 217, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}
.extract-text-button:hover {
    background-image: linear-gradient(to right, #5b21b6 0%, #4c1d95 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(109, 40, 217, 0.4);
}
.image-to-text-content .result-area textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #cce7ff;
    border-radius: 10px;
    font-size: 1.1rem;
    resize: vertical;
    box-sizing: border-box;
    background-color: #eaf6ff;
    color: #333;
	text-align: justify;
}
.dark .image-to-text-content .result-area textarea {
    background-color: #1a202c;
    border-color: #4a5568;
    color: #f7fafc;
}
/* Drag & Drop এর জন্য নতুন স্টাইল */
.image-upload-area.drag-over {
    background-color: #cce7ff; /* ড্র্যাগ করার সময় ব্যাকগ্রাউন্ড রঙ পরিবর্তন হবে */
    border-style: solid;
    border-color: #0056b3;
}
.dark .image-upload-area.drag-over {
    background-color: #2c3748;
    border-color: #90cdf4;
}
/* নতুন: ওয়ার্ড কাউন্টার স্টাইল */
.word-counter-content {
    padding: 20px;
    border-radius: 16px;
    margin: 0 auto;
    max-width: 800px;
    background-color: #f8f9fa;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}
.dark .word-counter-content {
    background-color: #2d3748;
}

/* নতুন: আবহাওয়া বিভাগের স্টাইল */
        .weather-content {
            padding: 20px;
            border-radius: 16px;
            margin: 0 auto;
            max-width: 500px;
            background-color: #f8f9fa;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }
        .dark .weather-content {
            background-color: #2d3748;
        }
        .weather-search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .city-input {
            flex-grow: 1;
            padding: 12px;
            border: 1px solid #cce7ff;
            border-radius: 10px;
            font-size: 1rem;
            background-color: #eaf6ff;
            color: #333;
        }
        .dark .city-input {
            background-color: #4a5568;
            border-color: #718096;
            color: #f7fafc;
        }
        .search-weather-button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .search-weather-button:hover {
            background-color: #0056b3;
        }
        .weather-result-area {
            background-color: #e6f7ff;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            border: 1px solid #b3e0ff;
            min-height: auto; /* উচ্চতা পরিবর্তন করা হয়েছে */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* কন্টেন্ট ওপর থেকে শুরু হবে */
        }
        .dark .weather-result-area {
            background-color: #1a202c;
            border-color: #4a5568;
            color: #e2e8f0; /* সাধারণ টেক্সটের জন্য সাদা রঙ যোগ করা হয়েছে */
        }
        .weather-result-area h4 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0056b3;
        }
        .dark .weather-result-area h4 {
            color: #90cdf4;
        }
        .weather-result-area .weather-icon {
            width: 100px;
            height: 100px;
            margin: 10px auto;
        }
        .weather-result-area .temp {
            font-size: 2.5rem;
            font-weight: 700;
        }
        .weather-result-area .description {
            font-size: 1.2rem;
            text-transform: capitalize;
            margin-bottom: 15px;
        }
        
        /* ডার্ক মোডে তাপমাত্রা এবং বিবরণ সাদা করার জন্য */
        .dark .weather-result-area .temp,
        .dark .weather-result-area .description {
            color: #f7fafc;
        }

        /* নতুন যুক্ত করা এবং আপডেট করা স্টাইল */
        .weather-feels-like {
            font-size: 1rem;
            margin-top: -10px;
            margin-bottom: 15px;
            color: #555;
        }
        .dark .weather-feels-like {
            color: #a0aec0;
        }
        .weather-extra-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            width: 100%;
            margin-top: 20px;
            text-align: left;
        }
        .detail-item {
            background-color: rgba(255, 255, 255, 0.5);
            padding: 10px;
            border-radius: 10px;
        }
        .dark .detail-item {
            background-color: rgba(0, 0, 0, 0.2);
        }
        .detail-item strong {
            display: block;
            font-size: 0.9rem;
            color: #3f51b5;
            margin-bottom: 5px;
        }
        .dark .detail-item strong {
            color: #90cdf4;
        }
        /* ডিটেইল আইটেমের ভ্যালুগুলো ডার্ক মোডে সাদা করার জন্য */
        .dark .detail-item span {
            color: #e2e8f0;
        }

 /* প্রিসেট ড্রপডাউন বাটনের জন্য নতুন CSS */
    #presetButtonLeft.open svg, #presetButtonRight.open svg {
        transform: rotate(180deg);
    }
/* আরও মেনু এবং সেটিংস মেনুর জন্য CSS*/
        .tab-menu-container {
            display: flex;
            justify-content: center;
            align-items: center; /* উল্লম্বভাবে কেন্দ্র করার জন্য */
            margin: 5px; /* মার্জিন */
            gap: 5px; /* ট্যাবগুলোর মাঝে ফাঁক */
            flex-wrap: wrap; /* ছোট স্ক্রিনে ট্যাবগুলি মোড়ানো */
        }

        /* নতুন: ড্রপডাউন কন্টেইনারের ব্যাকগ্রাউন্ডে বর্ডার যুক্ত করা হয়েছে */
        #moreMenuDropdown, #settingsMenuDropdown {
            border: 1px solid #b3e0ff; /* লাইট মোডে চিকন নীল বর্ডার */
        }
        
        /* ডার্ক মোডের জন্য বর্ডার কালার */
        .dark #moreMenuDropdown, .dark #settingsMenuDropdown {
            border: 1px solid #4a5568; /* ডার্ক মোডে ধূসর বর্ডার */
        }


/* নতুন: নোটপ্যাড / টু-ডু লিস্ট স্টাইল (আপডেট করা) */
.notepad-container {
    padding: 20px;
    border-radius: 16px;
    margin: 0 auto;
    max-width: 600px;
    background-color: #f8f9fa;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}
.dark .notepad-container {
    background-color: #2d3748;
}
.notepad-input-area {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}
.task-input {
    flex-grow: 1;
    padding: 12px;
    border: 1px solid #cce7ff;
    border-radius: 10px;
    font-size: 1rem;
    background-color: #eaf6ff;
    color: #333;
    /* নতুন সংযোজন */
    min-height: 80px; /* ইনপুট বক্স বড় করা হয়েছে */
    resize: vertical; /* ব্যবহারকারীকে রিসাইজ করার সুবিধা দেওয়া হয়েছে */
    line-height: 1.5; /* লাইনগুলোর মধ্যে ফাঁকা বাড়াতে */
}

.dark .task-input {
    background-color: #4a5568;
    border-color: #718096;
    color: #f7fafc;
}
.add-task-btn {
    background-color: #28a745;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
}
.add-task-btn:hover {
    background-color: #218838;
}
.task-list {
    list-style: none;
    padding: 0;
    /* max-height এবং overflow-y বৈশিষ্ট্যগুলো মুছে ফেলা হয়েছে যাতে লিস্ট বড় হলে পুরো পেজ স্ক্রোল হয়। */
}

/* টাস্ক আইটেম এবং এর বিভিন্ন অবস্থার স্টাইল */
.task-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    background-color: #ffffff;
    border-radius: 8px;
    margin-bottom: 10px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    word-break: break-word;
    position: relative;
    overflow: hidden;
}

.dark .task-item {
    background-color: #1a202c;
    border-color: #4a5568;
}
.task-item.pinned {
    background-color: #fef3c7; /* হালকা হলুদ */
    border-left: 4px solid #f59e0b; /* হলুদ বর্ডার */
}
.dark .task-item.pinned {
    background-color: #3f331a;
    border-left-color: #fcd34d;
}
.task-item.completed .task-text {
    text-decoration: line-through;
    color: #6c757d;
}
.dark .task-item.completed .task-text {
    color: #a0aec0;
}
.task-item.dragging {
    opacity: 0.5;
    background-color: #cce7ff;
}
.dark .task-item.dragging {
    background-color: #2c3748;
}

/* টাস্ক টেক্সট এবং নাম্বারিং স্টাইল */
.task-item .task-text {
    flex-grow: 1;
    text-align: justify; /* লেখাটি সব সময় জাস্টিফাই করা হয়েছে */
    cursor: pointer;
    white-space: pre-wrap; /* এন্টার কী/লাইন ব্রেক সমর্থন করার জন্য */
    display: block; /* লেখাটি সব সময় জাস্টিফাই দেখানোর জন্য এটি যোগ করা হয়েছে */
}

.dark .task-item .task-text {
    color: #f4f4f4;
}
.task-item .task-text:focus {
    display: block;
    outline: none;
    border: 2px solid #3b82f6;
    background-color: #ffffff;
    padding: 4px;
    margin: -6px;
    border-radius: 6px;
}
.dark .task-item .task-text:focus {
    background-color: #2c3748;
    border-color: #60a5fa; /* ডার্ক মোডের জন্য উন্নত ভিজিবিলিটি */
}
.task-number {
    font-weight: bold;
    color: #3f51b5;
    background-color: #e0e7ff;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
    flex-shrink: 0;
}
.dark .task-number {
    color: #90cdf4;
    background-color: #4a5568;
}

/* টাস্ক আইটেমের অ্যাকশন বাটন স্টাইল */
.task-item .actions {
    display: flex;
    gap: 8px;
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%) translateX(125%);
    transition: transform 0.2s ease-in-out;
    background: rgba(241, 245, 249, 0.9);
    padding: 5px;
    border-radius: 20px;
    z-index: 2;
}
.dark .task-item .actions {
    background: rgba(45, 55, 72, 0.9);
}
.task-item:hover .actions {
    transform: translateY(-50%) translateX(0);
}
.task-item .action-btn {
    border: none;
    background: #e2e8f0;
    color: #475569;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s, color 0.2s, transform 0.2s;
    flex-shrink: 0;
}
.dark .task-item .action-btn {
    background-color: #4a5568;
    color: #e2e8f0;
}
.task-item .action-btn:hover {
    transform: scale(1.1);
}
.task-item .action-btn.copy:hover {
    background-color: #3b82f6;
    color: white;
}
.task-item .action-btn.delete:hover {
    background-color: #ef4444;
    color: white;
}
.task-item .action-btn.pin:hover {
    background-color: #f59e0b;
    color: white;
}
.task-item .action-btn.pin.active {
    background-color: #f59e0b;
    color: white;
}

/* আগের ডিলিট বাটন স্টাইল অপ্রয়োজনীয়, তাই লুকানো হলো */
.delete-task-btn {
    display: none;
}

/* নতুন: নোটপ্যাড টেক্সট ফরম্যাটিং অ্যাকশন বার */
.notepad-action-toolbar {
    position: absolute;
    z-index: 10;
    background-color: #374151; /* bg-gray-700 */
    color: white;
    border-radius: 8px;
    padding: 4px;
    display: none; /* প্রাথমিকভাবে লুকানো থাকবে */
    gap: 4px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    transition: opacity 0.1s ease-in-out, transform 0.1s ease-in-out;
}

.toolbar-btn {
    background: transparent;
    border: none;
    color: white;
    cursor: pointer;
    padding: 6px 8px;
    border-radius: 4px;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
}

.toolbar-btn:hover {
    background-color: #4b5563; /* bg-gray-600 */
}

/* ইনপুট বক্সকে div হিসাবে স্টাইল করা */
.task-input[contenteditable="true"] {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-color: #eaf6ff;
    border: 1px solid #cce7ff;
    border-radius: 10px;
    color: #333;
    flex-grow: 1;
    font-size: 1rem;
    line-height: 1.5;
    min-height: 80px;
    padding: 12px;
    resize: vertical;
    overflow-y: auto; /* textarea-এর মতো স্ক্রোল যুক্ত করা */
    text-align: justify;
}
.dark .task-input[contenteditable="true"] {
    background-color: #4a5568;
    border-color: #718096;
    color: #f7fafc;
}

/* প্লেসহোল্ডার সিমুলেশন */
.task-input[contenteditable="true"]:empty::before {
    content: attr(data-placeholder);
    color: #6b7280; /* text-gray-500 */
    pointer-events: none;
}
.dark .task-input[contenteditable="true"]:empty::before {
    color: #9ca3af; /* text-gray-400 */
}

/* task-text এর জন্য overflow-wrap property যোগ করা হয়েছে */
.task-item .task-text {
    flex-grow: 1;
    text-align: justify;
    cursor: pointer;
    white-space: pre-wrap;
    display: block;
    overflow-wrap: break-word; /* লম্বা শব্দ ভাঙার জন্য */
    word-break: break-word;    /* অতিরিক্ত সুরক্ষার জন্য */
}

/* নতুন: ঘড়ি ট্যাবের জন্য স্টাইল */
.clock-container {
    padding: 20px;
    border-radius: 16px;
    margin: 0 auto;
    max-width: 900px;
    background-color: #f8f9fa;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    display: grid;
    grid-template-columns: 1fr;
    gap: 25px;
}
.dark .clock-container {
    background-color: #2d3748;
}

@media (min-width: 768px) {
    .clock-container {
        grid-template-columns: repeat(2, 1fr);
        grid-template-areas:
            "stopwatch alarm"
            "world-clock world-clock"
            "countdown countdown"; /* কাউন্টডাউন সবার নিচে */
    }
    .stopwatch { grid-area: stopwatch; }
    .alarm { grid-area: alarm; }
    .countdown { grid-area: countdown; }
    .world-clock { grid-area: world-clock; }
}

.clock-section {
    background-color: #ffffff;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}
.dark .clock-section {
    background-color: #1a202c;
    border-color: #4a5568;
}

.section-title {
    font-size: 1.4rem;
    font-weight: 700;
    color: #3f51b5;
    margin-bottom: 20px;
    text-align: center;
}
.dark .section-title {
    color: #90cdf4;
}

/* স্টপওয়াচ স্টাইল */
.stopwatch-display {
    font-family: 'Courier New', Courier, monospace;
    font-size: 2.5rem;
    font-weight: bold;
    text-align: center;
    color: #111827;
    background-color: #e6f7ff;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
    letter-spacing: 2px;
}
.dark .stopwatch-display {
    background-color: #1e3a8a;
    color: #e0f2fe;
}
.stopwatch-controls, .alarm-controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
}
.control-btn {
    padding: 10px 20px;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    color: white;
    transition: all 0.2s ease;
}
.control-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
.control-btn.start-btn { background-color: #28a745; }
.control-btn.stop-btn { background-color: #dc3545; }
.control-btn.reset-btn { background-color: #6c757d; }
.control-btn.lap-btn { background-color: #007bff; }
.laps-container {
    margin-top: 20px;
    max-height: 150px;
    overflow-y: auto;
    background-color: #f1f5f9;
    border-radius: 8px;
    padding: 10px;
}
.dark .laps-container {
    background-color: #4a5568;
}
.laps-container h4 {
    text-align: center;
    font-weight: 600;
    margin-bottom: 5px;
    color: #475569;
}
.dark .laps-container h4 {
    color: #cbd5e0;
}
#lapsList {
    list-style: none;
    padding: 0;
    margin: 0;
}
#lapsList li {
    padding: 8px;
    border-bottom: 1px solid #e2e8f0;
    font-family: 'Courier New', Courier, monospace;
    display: flex;
    justify-content: space-between;
}
.dark #lapsList li {
    border-color: #718096;
    color: #e2e8f0; /* লেখা সাদা করার জন্য যোগ করা হয়েছে */
}

/* অ্যালার্ম স্টাইল */
.alarm-time-input {
    width: 100%;
    padding: 5px;
    font-size: 1.5rem;
    border: 1px solid #cbd5e0;
    border-radius: 8px;
    text-align: center;
    margin-bottom: 10px;
}
.dark .alarm-time-input {
    background-color: #4a5568;
    border-color: #718096;
    color: #f7fafc;
}
.control-btn.set-alarm-btn { background-color: #8A2BE2; }
.control-btn.clear-alarm-btn { background-color: #ffc107; color: #111827; }

.alarm-status {
    text-align: center;
    margin-top: 10px;
    font-weight: 600;
    font-size: 1.1rem;
    padding: 5px;
    border-radius: 8px;
}
/* নতুন: ডার্ক মোডে অ্যালার্ম স্ট্যাটাসের জন্য রঙ যোগ করা হয়েছে */
.dark .alarm-status {
    color: #cbd5e0;
}
.alarm-status.active {
    background-color: #dcfce7;
    color: #166534;
    animation: pulse 2s infinite;
}
.dark .alarm-status.active {
    background-color: #064e3b;
    color: #a7f3d0;
}
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.03); }
    100% { transform: scale(1); }
}
/* অ্যালার্ম স্ট্যাটাসের জন্য অতিরিক্ত স্টাইল */
.alarm-status .countdown {
    display: block;
    font-size: 1rem;
    font-weight: 500;
    color: #4a5568;
    margin-top: 5px;
}

.dark .alarm-status .countdown {
    color: #a0aec0;
}
/* কাস্টম অডিও সিলেকশন */
.custom-file-upload-small {
    padding: 5px 5px;
    cursor: pointer;
    background-color: #4a5568;
    color: white;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 500;
    transition: background-color 0.3s ease;
}
.dark .custom-file-upload-small {
    background-color: #718096;
}
.custom-file-upload-small:hover {
    background-color: #2d3748;
}
.dark .custom-file-upload-small:hover {
    background-color: #4a5568;
}
#removeCustomAlarmSound {
    background-color: #ef5350;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    line-height: 1;
}

/* বিশ্ব ঘড়ি স্টাইল (এখানে পুরনো কোডটি বদলে দিন) */
        .world-clock-grid {
            display: grid;
            /* ছোট স্ক্রিনের জন্য: স্বয়ংক্রিয় ফিট কলাম */
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        /* বড় স্ক্রিনের জন্য ৩-কলামের লেআউট নিশ্চিত করতে */
        @media (min-width: 900px) {
            .world-clock-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        .world-clock-card {
            background-color: #e0f2f7;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #b3e0ff;
        }
        .dark .world-clock-card {
            background-color: #1a202c;
            border-color: #4a5568;
        }
        .world-clock-card .city {
            font-size: 1.2rem;
            font-weight: bold;
            color: #0056b3;
        }
        .dark .world-clock-card .city {
            color: #90cdf4;
        }
        /* নতুন: দেশের নামের জন্য স্টাইল */
        .world-clock-card .country {
            font-size: 0.85rem;
            color: #4a5568;
            margin-bottom: 4px;
        }
        .dark .world-clock-card .country {
            color: #a0aec0;
        }
        .world-clock-card .time {
            font-size: 1.8rem;
            font-weight: 500;
            margin: 5px 0;
        }
        .dark .world-clock-card .time {
            color: #e2e8f0;
        }
        .world-clock-card .date {
            font-size: 0.9rem;
            color: #555;
        }
        .dark .world-clock-card .date {
            color: #a0aec0;
        }
        /* নির্বাচিত কার্ডকে আলাদাভাবে স্টাইল করতে */
        #selected-timezone-card {
            background-color: #dbeafe; /* হালকা নীল */
            border-color: #93c5fd;
            border-width: 2px;
        }
        .dark #selected-timezone-card {
            background-color: #1e3a8a; /* গাঢ় নীল */
            border-color: #3b82f6;
        }

/* নতুন: প্লেয়ার ট্যাবের জন্য স্টাইল */
.player-container {
    padding: 20px;
    border-radius: 16px;
    margin: 0 auto;
    max-width: 800px;
    background-color: #f8f9fa;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    gap: 25px;
}

.dark .player-container {
    background-color: #2d3748;
}

.player-section {
    background-color: #ffffff;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}

.dark .player-section {
    background-color: #1a202c;
    border-color: #4a5568;
}

.player-section-title {
    font-size: 1.3rem;
    font-weight: 700;
    color: #3f51b5;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e2e8f0;
}

.dark .player-section-title {
    color: #90cdf4;
    border-bottom-color: #4a5568;
}

.player-content-area {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.image-preview-box {
    width: 100%;
    max-height: 400px;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #f1f5f9;
    border-radius: 8px;
    overflow: hidden;
}

.dark .image-preview-box {
    background-color: #2d3748;
}

#imagePreview {
    width: 100%;
    height: 100%;
    max-height: 400px;
    object-fit: contain;
}

.player-input-area {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
}

.player-input-area input[type="file"] {
    display: none;
}

.custom-file-upload {
    display: inline-block;
    padding: 10px 18px;
    cursor: pointer;
    background-color: #3f51b5;
    color: white;
    border-radius: 8px;
    font-weight: 600;
    transition: background-color 0.3s ease;
}

.dark .custom-file-upload {
    background-color: #4c51bf;
}

.custom-file-upload:hover {
    background-color: #303f9f;
}

.dark .custom-file-upload:hover {
    background-color: #434190;
}

.file-name-display {
    font-size: 0.9rem;
    color: #4a5568;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.dark .file-name-display {
    color: #a0aec0;
}

.player-section.drag-over {
  border-color: #3b82f6;
  border-style: dashed;
  background-color: #eff6ff;
 }
 .dark .player-section.drag-over {
   border-color: #60a5fa;
   background-color: #2c3748;
}

/* ==================================================================== */
/* START: QR Code Generator Styles */
/* ==================================================================== */

.qr-code-content {
    padding: 20px;
    border-radius: 16px;
    margin: 0 auto;
    max-width: 800px; /* Increased max-width */
    background-color: #f8f9fa;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    display: grid;
    grid-template-columns: 1fr;
    gap: 25px;
}
.dark .qr-code-content {
    background-color: #2d3748;
}

@media (min-width: 768px) {
    .qr-code-content {
        grid-template-columns: 1fr 1fr; /* Two columns on larger screens */
    }
}

.qr-input-section, .qr-output-section {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.qr-code-content textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #cce7ff;
    border-radius: 10px;
    font-size: 1.1rem;
    resize: vertical;
    box-sizing: border-box;
    background-color: #eaf6ff;
    color: #333;
    min-height: 150px;
    transition: all 0.2s ease-in-out;
}
.dark .qr-code-content textarea {
    background-color: #4a5568;
    border-color: #718096;
    color: #f7fafc;
}
.qr-code-content textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
}

#qrcode-container {
    margin: 0 auto; /* Horizontally center the container */
    width: 280px;
    height: 280px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #e6f7ff;
    border: 1px solid #b3e0ff;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05) inset;
}
.dark #qrcode-container {
    background-color: #1a202c;
    border-color: #4a5568;
}

#qrcode canvas {
    border-radius: 8px;
}

#qrcode-placeholder {
    width: 100%;
    height: 100%;
}

.qr-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 10px;
}

.qr-button {
    color: white;
    padding: 14px 25px;
    border: none;
    border-radius: 12px;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease-in-out;
    width: 100%;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.qr-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}
.qr-button:active:not(:disabled) {
    transform: translateY(0);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.qr-button.generate {
    background-image: linear-gradient(to right, #3b82f6 0%, #2563eb 100%);
    box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
}
.qr-button.download {
    background-image: linear-gradient(to right, #10b981 0%, #059669 100%);
    box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
}
.qr-button.clear {
    background-image: linear-gradient(to right, #ef4444 0%, #dc2626 100%);
    box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
}

.qr-button.upload {
    background-image: linear-gradient(to right, #8b5cf6 0%, #6d28d9 100%);
    box-shadow: 0 5px 15px rgba(139, 92, 246, 0.3);
}

.qr-button:disabled {
    background-image: none;
    background-color: #9ca3af;
    cursor: not-allowed;
    opacity: 0.7;
}

/* ==================================================================== */
/* END: QR Code Generator Styles */
/* ==================================================================== */

/* ==================================================================== */
/* START: Emergency Numbers Styles */
/* ==================================================================== */


.emergency-numbers-content {
    padding: 20px;
    border-radius: 16px;
    margin: 0 auto;
    max-width: 900px;
    background-color: #f8f9fa;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}
.dark .emergency-numbers-content {
    background-color: #2d3748;
}

.emergency-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    margin-bottom: 25px;
}

@media (min-width: 640px) {
    .emergency-controls {
        flex-direction: row;
        justify-content: center;
    }
}

.emergency-numbers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px;
}

.emergency-card {
    background-color: #ffffff;
    border: 1px solid #e2e8f0;
    border-left: 5px solid #3b82f6; /* Blue accent */
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}
.dark .emergency-card {
    background-color: #1a202c;
    border-color: #4a5568;
    border-left-color: #60a5fa; /* Light blue accent for dark mode */
}

.emergency-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
}

.emergency-card .card-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: #1e3a8a;
    margin-bottom: 8px;
}
.dark .emergency-card .card-title {
    color: #93c5fd;
}

.emergency-card .card-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 15px;
    font-family: 'Courier New', Courier, monospace;
}
.dark .emergency-card .card-number {
    color: #e5e7eb;
}

.emergency-card .call-button {
    background-color: #28a745;
    color: white;
    padding: 8px 12px;
    border: none;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    align-self: flex-start; /* Button aligns to the start */
}

.emergency-card .call-button:hover {
    background-color: #218838;
}

.emergency-card {
    position: relative; /* Action বাটন পজিশন করার জন্য */
    overflow: hidden; /* বাইরে চলে যাওয়া Action বাটন লুকানোর জন্য */
}

/* নম্বর এডিট করার সময় আউটলাইন এবং ব্যাকগ্রাউন্ড পরিবর্তন হবে */
.emergency-card .card-number[contenteditable="true"] {
    outline: 2px solid #3b82f6; /* নীল আউটলাইন */
    background-color: #ffffff;
    padding: 2px 4px;
    margin: -3px -5px; /* ইনপুটের মতো দেখানোর জন্য */
    border-radius: 4px;
}
.dark .emergency-card .card-number[contenteditable="true"] {
    background-color: #2c3748;
    border-color: #60a5fa;
}

/* Action বাটনের কন্টেইনার */
.emergency-card .actions {
    display: flex;
    gap: 8px;
    position: absolute;
    right: 10px;
    top: 15px; /* ওপর থেকে পজিশন */
    transform: translateX(125%); /* প্রাথমিকভাবে ডানদিকে লুকানো থাকবে */
    transition: transform 0.2s ease-in-out;
    background: rgba(241, 245, 249, 0.9);
    padding: 5px;
    border-radius: 20px;
    z-index: 2;
}
.dark .emergency-card .actions {
    background: rgba(45, 55, 72, 0.9);
}
/* কার্ডের ওপর হোভার করলে Action বাটন দেখা যাবে */
.emergency-card:hover .actions {
    transform: translateX(0);
}

/* প্রতিটি Action বাটনের স্টাইল */
.emergency-card .action-btn {
    border: none;
    background: #e2e8f0;
    color: #475569;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s, color 0.2s, transform 0.2s;
    flex-shrink: 0;
}
.dark .emergency-card .action-btn {
    background-color: #4a5568;
    color: #e2e8f0;
}
.emergency-card .action-btn:hover {
    transform: scale(1.1);
}
.emergency-card .action-btn.copy:hover {
    background-color: #3b82f6; /* নীল */
    color: white;
}
.emergency-card .action-btn.edit:hover {
    background-color: #f59e0b; /* কমলা */
    color: white;
}

/* ==================================================================== */
/* END: Emergency Numbers Styles */
/* ==================================================================== */

/* শুরু: যাকাত ক্যালকুলেটর স্টাইল */
.zakat-calculator-content {
    padding: 20px;
    border-radius: 16px;
    margin: 0 auto;
    max-width: 900px;
    background-color: #f8f9fa;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}
.dark .zakat-calculator-content {
    background-color: #2d3748;
}
.zakat-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 25px;
    margin-bottom: 25px;
}
@media (min-width: 768px) {
    .zakat-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    .nisab-section {
        grid-column: 1 / -1; /* Make Nisab section span full width on larger screens */
    }
}
.zakat-section {
    background-color: #ffffff;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}
.dark .zakat-section {
    background-color: #1a202c;
    border-color: #4a5568;
}
.zakat-section-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: #3f51b5;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e2e8f0;
}
.dark .zakat-section-title {
    color: #90cdf4;
    border-bottom-color: #4a5568;
}
.zakat-input-group {
    margin-bottom: 15px;
    text-align: left;
}
.zakat-input-group label {
    display: block;
    margin-bottom: 8px;
    color: #374151;
    font-weight: 500;
}
.dark .zakat-input-group label {
    color: #cbd5e0;
}
.zakat-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    box-sizing: border-box;
    font-size: 1rem;
    transition: border-color 0.2s, box-shadow 0.2s;
}
.dark .zakat-input {
    background-color: #4a5568;
    border-color: #718096;
    color: #f7fafc;
}
.zakat-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
}
.nisab-result {
    margin-top: 15px;
    padding: 10px;
    background-color: #e6f7ff;
    border: 1px solid #b3e0ff;
    border-radius: 8px;
    text-align: center;
    font-size: 1.1rem;
}
.dark .nisab-result {
    background-color: #1a202c;
    border-color: #4a5568;
    color: #e2e8f0;
}
.zakat-calculate-btn {
    width: 100%;
    padding: 0.8rem 1rem;
    background-color: #10b981;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    margin-top: 10px;
}
.zakat-calculate-btn:hover {
    background-color: #059669;
    transform: translateY(-2px);
}
.zakat-result-area {
    margin-top: 25px;
    padding: 20px;
    border-radius: 12px;
    background-color: #dcfce7;
    border: 1px solid #bbf7d0;
    text-align: left;
    line-height: 1.8;
    display: none; /* Initially hidden */
}
.dark .zakat-result-area {
    background-color: #064e3b;
    border-color: #34d399;
    color: #d1fae5;
}
.zakat-result-area h4 {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 10px;
}
.zakat-result-area p {
    font-size: 1rem;
    margin-bottom: 5px;
}
.zakat-result-area .final-zakat {
    font-size: 1.5rem;
    font-weight: bold;
    color: #047857;
    margin-top: 10px;
}
.dark .zakat-result-area .final-zakat {
    color: #6ee7b7;
}
.zakat-result-area.not-payable {
    background-color: #fef3c7;
    border-color: #fde68a;
}
.dark .zakat-result-area.not-payable {
    background-color: #78350f;
    border-color: #f59e0b;
    color: #fef3c7;
}

/* শেষ: যাকাত ক্যালকুলেটর স্টাইল */


#news-ticker-container {
    position: relative; 
    overflow: hidden; 
    transition: height 0.5s ease-in-out; 
}

#news-ticker-container:hover #news-ticker-text.typing-animation {
    animation-play-state: paused; 
}

#news-ticker-content {
    width: 100%;
    text-align: center;
    overflow: hidden; 
    position: relative; 
    
    transition: height 0.5s ease-in-out; 
}

#news-ticker-text {
    position: absolute;
    left: 0;
    right: 0;
    width: 100%;
    text-align: center;
    color: inherit;
    text-decoration: none;
    cursor: pointer;
    transition: top 0.5s ease-in-out, opacity 0.5s ease-in-out;
    top: 100%;
    opacity: 0;
    
    white-space: normal; 
    overflow: visible; 
    line-height: 1.5; 
    font-weight: 600; 
}


#news-ticker-text:hover {
    text-decoration: underline;
}

#news-ticker-text.typing-animation {
    position: static;
    display: inline-block; 
    vertical-align: middle; 
    transform: none;
    width: 0;
    overflow: hidden;
    white-space: nowrap;
    animation-name: typing;
    animation-timing-function: steps(60, end); 
    animation-fill-mode: forwards;
    transition: none;
    opacity: 1;
    top: auto;
    line-height: normal; 
    text-overflow: clip;
}

@keyframes typing {
    from { width: 0 }
    to { width: 100% } 
}


.news-source {
    font-style: italic;
    color: #4f46e5; 
}
.dark .news-source {
    color: #a5b4fc;
}

.news-nav-icon {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background-color: rgba(0, 0, 0, 0.1);
    color: #312e81;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0; 
    transition: opacity 0.3s ease, background-color 0.3s ease;
    z-index: 10;
}
.dark .news-nav-icon {
    background-color: rgba(255, 255, 255, 0.2);
    color: #e0e7ff;
}

#news-ticker-container:hover .news-nav-icon {
    opacity: 1; 
}

.news-nav-icon:hover {
    background-color: rgba(0, 0, 0, 0.2);
}
.dark .news-nav-icon:hover {
    background-color: rgba(255, 255, 255, 0.4);
}

#prev-news { left: 5px; }
#next-news { right: 5px; }
/* Animated News Ticker Styles End */



/* ======================================================== */
/* START: Important Links Tab Styles (গুরুত্বপূর্ণ লিংকসমূহ) */
/* ======================================================== */

.important-links-container {
    max-width: 680px;
    margin: 0 auto;
    background-color: #f8fafc; /* Tailwind's gray-50 */
    border-radius: 16px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    border: 1px solid #e2e8f0; /* Tailwind's gray-200 */
}

.dark .important-links-container {
    background-color: #1f2937; /* Tailwind's gray-800 */
    border-color: #4b5563; /* Tailwind's gray-600 */
}

.profile-pic {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    margin: 0 auto;
    object-fit: cover;
    border: 4px solid #ffffff; /* Tailwind's white */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.dark .profile-pic {
    border-color: #374151; /* Tailwind's gray-700 */
}

.link-btn {
    display: flex;
    align-items: center;
    gap: 16px;
    width: 100%;
    padding: 14px 20px;
    text-align: center;
    border-radius: 12px;
    background-color: #ffffff; /* Tailwind's white */
    color: #1f2937; /* Tailwind's gray-800 */
    font-weight: 600;
    font-size: 1rem;
    text-decoration: none;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: 1px solid #e5e7eb; /* Tailwind's gray-200 */
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.dark .link-btn {
    background-color: #374151; /* Tailwind's gray-700 */
    color: #f9fafb; /* Tailwind's gray-50 */
    border-color: #4b5563; /* Tailwind's gray-600 */
}

.link-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
}

.dark .link-btn:hover {
    background-color: #4b5563; /* Tailwind's gray-600 */
}

.link-btn svg {
    flex-shrink: 0;
}

.link-btn span {
    flex-grow: 1;
    text-align: center;
}

.social-icon {
    color: #4b5563; /* Tailwind's gray-600 */
    transition: color 0.2s ease, transform 0.2s ease;
}

.dark .social-icon {
    color: #9ca3af; /* Tailwind's gray-400 */
}

.social-icon:hover {
    color: #111827; /* Tailwind's gray-900 */
    transform: scale(1.1);
}

.dark .social-icon:hover {
    color: #ffffff; /* Tailwind's white */
}

/* ======================================================== */
/* END: Important Links Tab Styles                         */
/* ======================================================== */

/* ======================================================== */
/* START: হেডিং অ্যানিমেশনের জন্য পরিবর্তিত স্টাইল (Updated Heading Animation Styles) */
/* ======================================================== */

#main-heading {
    position: relative; /* গ্লিচ ইফেক্টের জন্য আবশ্যক */
    z-index: 1; /* অন্যান্য উপাদানের উপরে রাখতে */
    transition: color 0.3s; /* ডার্ক মোডের জন্য ট্রানজিশন */
}

/* যখন অ্যানিমেশন ক্লাসটি যোগ করা হবে */
#main-heading.glitch-effect {
    /* গ্লিচ ইফেক্টের সময়কাল নিয়ন্ত্রণের জন্য একটি অ্যানিমেশন যোগ করা হয়েছে */
    /* ফ্যাড-ইন/আউট এবং গ্রেডিয়েন্ট অ্যানিমেশন সরানো হয়েছে */
    animation: glitch-duration 2s linear;
}

#main-heading.glitch-effect::before,
#main-heading.glitch-effect::after {
    content: 'বাংলা টুলবক্স'; /* আপনার হেডিং টেক্সট Default: ΝŨťŚŨ ňŬŚΝǑ ĺř ųŊŴŖŚŔŨř  ĺř őŨŗ ųŗŨŦ śũŞŏūίŨŗŨő ũŝŕŨō */
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: transparent;
    overflow: hidden;
    clip: rect(0, 900px, 0, 0);
    /* মূল লেখার রঙ এখন স্বাভাবিক থাকবে কারণ গ্রেডিয়েন্ট সরানো হয়েছে */
    color: inherit;
}

#main-heading.glitch-effect::before {
    left: 2px;
    text-shadow: -1px 0 red;
    /* গ্লিচ অ্যানিমেশন অপরিবর্তিত আছে */
    animation: glitch-anim-1 2s linear alternate-reverse;
}

#main-heading.glitch-effect::after {
    left: -2px;
    text-shadow: -1px 0 blue;
    /* গ্লিচ অ্যানিমেশন অপরিবর্তিত আছে */
    animation: glitch-anim-2 2s linear alternate-reverse;
}

/* নতুন: গ্লিচ ইফেক্টের সময়কাল নিয়ন্ত্রণের জন্য অ্যানিমেশন */
/* এটি JavaScript-এর 'animationend' ইভেন্টটিকে সঠিকভাবে কাজ করতে সাহায্য করে */
@keyframes glitch-duration {
    0%, 100% {
        opacity: 1;
    }
}

/* গ্লিচ অ্যানিমেশন ১ (অপরিবর্তিত) */
@keyframes glitch-anim-1 {
    0% { clip: rect(42px, 9999px, 44px, 0); }
    5% { clip: rect(12px, 9999px, 60px, 0); }
    10% { clip: rect(40px, 9999px, 40px, 0); }
    15% { clip: rect(80px, 9999px, 5px, 0); }
    20% { clip: rect(25px, 9999px, 70px, 0); }
    25% { clip: rect(55px, 9999px, 33px, 0); }
    30% { clip: rect(15px, 9999px, 82px, 0); }
    35% { clip: rect(90px, 9999px, 2px, 0); }
    40% { clip: rect(33px, 9999px, 50px, 0); }
    45% { clip: rect(70px, 9999px, 18px, 0); }
    50% { clip: rect(48px, 9999px, 52px, 0); }
}

/* গ্লিচ অ্যানিমেশন ২ (অপরিবর্তিত) */
@keyframes glitch-anim-2 {
    0% { clip: rect(10px, 9999px, 90px, 0); }
    10% { clip: rect(80px, 9999px, 10px, 0); }
    20% { clip: rect(22px, 9999px, 66px, 0); }
    30% { clip: rect(5px, 9999px, 85px, 0); }
    40% { clip: rect(60px, 9999px, 30px, 0); }
    50% { clip: rect(18px, 9999px, 77px, 0); }
    60% { clip: rect(40px, 9999px, 55px, 0); }
    70% { clip: rect(75px, 9999px, 5px, 0); }
    80% { clip: rect(30px, 9999px, 60px, 0); }
    90% { clip: rect(55px, 9999px, 40px, 0); }
    100% { clip: rect(15px, 9999px, 80px, 0); }
}
/* ======================================================== */
/* END: হেডিং অ্যানিমেশনের জন্য পরিবর্তিত স্টাইল (Updated Heading Animation Styles) */
/* ======================================================== */


/* ======================================================== */
/* START: Health & Lifestyle Tab Styles (স্বাস্থ্য ও জীবনধারা) */
/* ======================================================== */

.health-lifestyle-content {
    padding: 20px;
    border-radius: 16px;
    margin: 0 auto;
    max-width: 800px;
    background-color: #f8f9fa;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}

.dark .health-lifestyle-content {
    background-color: #2d3748;
}

.health-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 25px;
}

@media (min-width: 768px) {
    .health-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

.health-section {
    background-color: #ffffff;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}

.dark .health-section {
    background-color: #1a202c;
    border-color: #4a5568;
}

.health-section-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: #3f51b5;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.dark .health-section-title {
    color: #90cdf4;
    border-bottom-color: #4a5568;
}

.health-input-group {
    margin-bottom: 15px;
    text-align: left;
}

.health-input-group label {
    display: block;
    margin-bottom: 8px;
    color: #374151;
    font-weight: 500;
}

.dark .health-input-group label {
    color: #cbd5e0;
}

.health-input, .health-select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    box-sizing: border-box;
    font-size: 1rem;
    transition: border-color 0.2s, box-shadow 0.2s;
}

.dark .health-input, .dark .health-select {
    background-color: #4a5568;
    border-color: #718096;
    color: #f7fafc;
}

.health-input:focus, .health-select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
}

.health-calculate-btn {
    width: 100%;
    padding: 0.8rem 1rem;
    background-color: #10b981;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    margin-top: 10px;
}

.health-calculate-btn:hover {
    background-color: #059669;
    transform: translateY(-2px);
}

.health-result-area {
    margin-top: 20px;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    line-height: 1.7;
    background-color: #e6f7ff;
    border: 1px solid #b3e0ff;
    min-height: 60px;
}

.dark .health-result-area {
    background-color: #1a202c;
    border-color: #4a5568;
    color: #e2e8f0;
}

.health-result-area h4 {
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 8px;
    color: #0056b3;
}

.dark .health-result-area h4 {
    color: #90cdf4;
}

.health-result-area p {
    font-size: 1.2rem;
    font-weight: 600;
}
/* ======================================================== */
/* END: Health & Lifestyle Tab Styles                      */
/* ======================================================== */

/* ======================================================== */
/* START: দিবসসমূহ কার্ডের জন্য CSS */
/* ======================================================== */
.days-observances-container {
    padding: 20px;
    border-radius: 16px;
    margin: 0 auto;
    max-width: 900px;
    background-color: #f8f9fa;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}
.dark .days-observances-container {
    background-color: #2d3748;
}

/* নতুন: আগত দিবস সেকশনের জন্য স্টাইল */
.upcoming-observances-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
    margin-bottom: 25px;
}
@media (min-width: 640px) {
    .upcoming-observances-container {
        grid-template-columns: 1fr 1fr;
    }
}
.upcoming-day-card {
    padding: 15px;
    border-radius: 12px;
    text-align: center;
    color: white;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
}
.upcoming-day-card.national {
    background: linear-gradient(135deg, #059669, #10b981);
}
.upcoming-day-card.international {
    background: linear-gradient(135deg, #4f46e5, #6366f1);
}
.upcoming-day-card .card-supertitle {
    font-size: 0.9rem;
    font-weight: 500;
    opacity: 0.8;
    margin-bottom: 4px;
}
.upcoming-day-card .card-day-name {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 8px;
}
.upcoming-day-card .card-day-date {
    font-size: 1.1rem;
    font-weight: 500;
    background-color: rgba(0,0,0,0.15);
    padding: 5px 10px;
    border-radius: 20px;
    display: inline-block;
}

.year-selector-wrapper {
    text-align: center;
    margin-bottom: 25px;
}
.year-selector-wrapper .year-input {
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #cce7ff;
    background-color: #eaf6ff;
    font-size: 1.1rem;
    font-weight: 600;
    width: 120px;
    text-align: center;
}

.observances-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
}

@media (min-width: 768px) {
    .observances-grid {
        grid-template-columns: 1fr 1fr;
    }
}

.observance-section {
    background-color: #ffffff;
    padding: 15px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
}
.dark .observance-section {
    background-color: #1a202c;
    border-color: #4a5568;
}

.observance-section .section-title {
    font-size: 1.3rem;
    font-weight: 700;
    color: #3f51b5;
    margin-bottom: 15px;
    text-align: center;
    padding-bottom: 10px;
    border-bottom: 1px solid #e2e8f0;
}
.dark .observance-section .section-title {
    color: #90cdf4;
    border-bottom-color: #4a5568;
}

.days-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 50vh;
    overflow-y: auto;
    padding-right: 10px;
}

.day-item {
    background-color: #e6f7ff;
    border-left: 4px solid #3b82f6;
    padding: 12px;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.dark .day-item {
    background-color: #1a202c;
    border-left-color: #60a5fa;
}

.day-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.day-item .day-name {
    font-weight: 600;
    font-size: 1.1rem;
    color: #1e3a8a;
}
.dark .day-item .day-name {
    color: #bfdbfe;
}

.day-item .day-date {
    font-size: 0.95rem;
    color: #475569;
    font-weight: 500;
}
.dark .day-item .day-date {
    color: #cbd5e0;
}
.today-day-card {
    padding: 15px;
    border-radius: 12px;
    text-align: center;
    color: white;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    min-height: 120px; /* একটি ন্যূনতম উচ্চতা যোগ করা হয়েছে */
    display: flex; /* কন্টেন্ট উল্লম্বভাবে মাঝখানে রাখার জন্য */
    flex-direction: column;
    justify-content: center;
}
.today-day-card.national {
    /* টিল রঙ */
    background: linear-gradient(135deg, #0f766e, #14b8a6); 
}
.today-day-card.international {
    /* কমলা রঙ */
    background: linear-gradient(135deg, #c2410c, #f97316);
}
.today-day-card .card-supertitle {
    font-size: 0.9rem;
    font-weight: 500;
    opacity: 0.8;
    margin-bottom: 4px;
}
.today-day-card .card-day-name {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 8px;
}
.today-day-card .card-day-date {
    font-size: 1.1rem;
    font-weight: 500;
    background-color: rgba(0,0,0,0.15);
    padding: 5px 10px;
    border-radius: 20px;
    display: inline-block;
}
/* ======================================================== */
/* END: দিবসসমূহ CSS */
/* ======================================================== */

    /* ======================================================== */
    /* START: Holiday List Tab Styles (ছুটির তালিকা) */
    /* ======================================================== */
    #holidayTable tbody tr.weekend-holiday {
        background-color: #fee2e2; /* light red */
        color: #991b1b; /* dark red text */
    }
    .dark #holidayTable tbody tr.weekend-holiday {
        background-color: #450a0a; /* dark red bg */
        color: #fecaca; /* light red text */
    }
    #holidayTable tbody tr.gov-holiday {
        background-color: #dcfce7; /* light green */
        color: #166534; /* dark green text */
    }
    .dark #holidayTable tbody tr.gov-holiday {
        background-color: #064e3b; /* dark green bg */
        color: #a7f3d0; /* light green text */
    }
    /* নতুন: চাঁদ দেখার উপর নির্ভরশীল ছুটির জন্য স্টাইল */
    #holidayTable tbody tr.moon-sighting-holiday {
        background-color: #fef9c3; /* light yellow */
        color: #854d0e; /* dark yellow text */
    }
    .dark #holidayTable tbody tr.moon-sighting-holiday {
        background-color: #423b08; /* dark yellow bg */
        color: #fde047; /* light yellow text */
    }
    #holidayTable tbody tr:hover {
        background-color: #e0e7ff; /* light blue on hover */
    }
    .dark #holidayTable tbody tr:hover {
        background-color: #374151; /* gray on hover */
    }
    #holidayTable th, #holidayTable td {
        border-bottom: 1px solid #e5e7eb;
    }
    .dark #holidayTable th, .dark #holidayTable td {
        border-bottom: 1px solid #4b5563;
    }
    /* ======================================================== */
    /* END: Holiday List Tab Styles */
    /* ======================================================== */

/* ======================================================== */
/* START: Quiz Tab Styles (Gemini Integrated) */
/* ======================================================== */

.quiz-setup-container, .quiz-container, .quiz-result-container {
    padding: 20px;
    border-radius: 16px;
    margin: 0 auto;
    max-width: 700px;
    background-color: #f8f9fa;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    text-align: center;
}
.dark .quiz-setup-container, .dark .quiz-container, .dark .quiz-result-container {
    background-color: #2d3748;
}

.quiz-options {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin: 30px 0;
}
@media (min-width: 640px) {
    .quiz-options {
        flex-direction: row;
        justify-content: center; /* Updated for better alignment */
        flex-wrap: wrap; /* Added for responsiveness */
        gap: 15px; /* Added for spacing */
    }
}
.quiz-option-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}
.quiz-option-group label {
    font-size: 1rem;
    font-weight: 600;
    color: #374151;
}
.dark .quiz-option-group label {
    color: #cbd5e0;
}
.quiz-select {
    padding: 10px 15px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    background-color: #ffffff;
    font-size: 1rem;
    min-width: 200px;
}
.dark .quiz-select {
    background-color: #4a5568;
    border-color: #718096;
    color: #f7fafc;
}

.quiz-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    font-size: 1rem;
    font-weight: 600;
    color: #4a5568;
}
.dark .quiz-header {
    color: #a0aec0;
}

.question-container {
    background-color: #e6f7ff;
    border: 1px solid #b3e0ff;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    min-height: 100px;
    display: flex;
    flex-direction: column; /* To stack question and type */
    align-items: center;
    justify-content: center;
    text-align: center;
}
.dark .question-container {
    background-color: #1a202c;
    border-color: #4a5568;
}
#question-text {
    font-size: 1.25rem;
    font-weight: 700;
    color: #0056b3;
    margin-bottom: 8px; /* Space between question and type */
}
.dark #question-text {
    color: #90cdf4;
}
#question-type {
    font-size: 0.9rem;
    font-weight: 500;
    color: #0284c7;
    background-color: #e0f2fe;
    padding: 2px 8px;
    border-radius: 12px;
}
.dark #question-type {
    color: #bae6fd;
    background-color: #075985;
}


.options-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
}
@media (min-width: 640px) {
    .options-container {
        grid-template-columns: 1fr 1fr;
    }
}

.option-btn {
    width: 100%;
    padding: 14px;
    text-align: left;
    background-color: #ffffff;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}
.dark .option-btn {
    background-color: #4a5568;
    border-color: #718096;
    color: #f7fafc;
}
.option-btn:hover:not(:disabled) {
    border-color: #3b82f6;
    background-color: #eff6ff;
}
.dark .option-btn:hover:not(:disabled) {
    border-color: #60a5fa;
    background-color: #2c3748;
}
.option-btn:disabled {
    cursor: not-allowed;
    opacity: 0.7;
}

.option-btn.correct {
    background-color: #dcfce7;
    border-color: #34d399;
    color: #065f46;
    font-weight: 700;
}
.dark .option-btn.correct {
    background-color: #064e3b;
    border-color: #34d399;
    color: #a7f3d0;
}
.option-btn.incorrect {
    background-color: #fee2e2;
    border-color: #f87171;
    color: #991b1b;
}
.dark .option-btn.incorrect {
    background-color: #7f1d1d;
    border-color: #ef4444;
    color: #fecaca;
}

.quiz-feedback {
    margin-top: 15px;
    font-size: 1rem;
    font-weight: 600;
    min-height: 24px;
    text-align: center;
}
.quiz-feedback.correct { color: #15803d; }
.dark .quiz-feedback.correct { color: #6ee7b7; }
.quiz-feedback.incorrect { color: #b91c1c; }
.dark .quiz-feedback.incorrect { color: #fca5a5; }

.quiz-footer {
    margin-top: 20px;
    text-align: center;
}

.quiz-button {
    color: white;
    padding: 12px 25px;
    border: none;
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}
.quiz-button.start {
    background-color: #8A2BE2; /* Purple */
    width: 60%;
    margin-top: 20px;
}
.quiz-button.start:hover {
    background-color: #6a1aae;
}
.quiz-button.next {
    background-color: #3b82f6; /* Blue */
}
.quiz-button.next:hover {
    background-color: #2563eb;
}
.quiz-button.restart {
    background-color: #10b981; /* Green */
}
.quiz-button.restart:hover {
    background-color: #059669;
}
.quiz-button:disabled {
    background-color: #9ca3af;
    cursor: not-allowed;
}

.final-score {
    font-size: 1.8rem;
    font-weight: 700;
    color: #3b82f6;
    margin: 20px 0;
}
.dark .final-score {
    color: #60a5fa;
}

.final-feedback {
    font-size: 1.2rem;
    font-weight: 500;
    margin-bottom: 30px;
}

.hidden {
    display: none !important;
}
/* ======================================================== */
/* END: Quiz Tab Styles */
/* ======================================================== */

/* ======================================================== */
/* START: Donate Tab Styles (ডোনেট ট্যাব) */
/* ======================================================== */

.donate-section {
    padding: 20px;
    border-radius: 16px;
    margin: 0 auto;
    max-width: 600px;
    background-color: #f8f9fa;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    text-align: center;
}
.dark .donate-section {
    background-color: #2d3748;
}
.donate-text {
    font-size: 1.1rem;
    color: #374151;
    margin-bottom: 20px;
    line-height: 1.8;
    text-align: justify;
}
.dark .donate-text {
    color: #cbd5e0;
}
.donate-subtitle {
    font-size: 1.2rem;
    font-weight: 700;
    color: #3f51b5;
    margin-top: 25px;
    margin-bottom: 10px;
}
.dark .donate-subtitle {
    color: #90cdf4;
}
.donate-number {
    font-size: 1.3rem;
    font-weight: 600;
    background-color: #e6f7ff;
    padding: 12px 20px; /* আইকনের জন্য জায়গা করতে ডানে প্যাডিং বাড়ানো হয়েছে */
    border-radius: 10px;
    border: 1px solid #b3e0ff;
    display: inline-block;
}
.dark .donate-number {
    background-color: #1a202c;
    border-color: #4a5568;
}
.qr-code-section {
    margin-top: 20px;
}
.qr-code-image {
    max-width: 200px;
    height: auto;
    margin: 10px auto;
    border: 5px solid white;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.donate-email {
    margin-top: 25px;
    font-size: 1rem;
    color: #4a5568;
}
.dark .donate-email {
    color: #a0aec0;
}

/* নতুন: ডোনেট নম্বর কপির জন্য স্টাইল - পরিবর্তিত */
#donate-number-container .actions {
    position: absolute;
    top: 50%;
    left: 100%; /* কন্টেইনারের ডান পাশে পজিশন করা হয়েছে */
    transform: translateY(-50%); /* শুধুমাত্র উল্লম্বভাবে মাঝখানে আনা হয়েছে */
    margin-left: 8px; /* নম্বর বক্স থেকে একটু فاصله দেওয়ার জন্য */
    opacity: 0; /* প্রাথমিকভাবে লুকানো থাকবে */
    transition: opacity 0.3s ease; /* মসৃণভাবে দেখানোর জন্য ট্রানজিশন */
    pointer-events: none; /* লুকানো অবস্থায় ক্লিক করা যাবে না */
    background: rgba(241, 245, 249, 0.9);
    padding: 5px;
    border-radius: 20px;
    z-index: 2;
    display: flex;
}
.dark #donate-number-container .actions {
    background: rgba(45, 55, 72, 0.9);
}
#donate-number-container:hover .actions {
    opacity: 1; /* হোভার করলে দৃশ্যমান হবে */
    pointer-events: auto; /* দৃশ্যমান অবস্থায় ক্লিক করা যাবে */
}

#donate-number-container .action-btn {
    border: none;
    background: #e2e8f0;
    color: #475569;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s, color 0.2s, transform 0.2s;
}
.dark #donate-number-container .action-btn {
    background-color: #4a5568;
    color: #e2e8f0;
}
#donate-number-container .action-btn:hover {
    transform: scale(1.1);
}
#donate-number-container .action-btn.copy:hover {
    background-color: #3b82f6; /* নীল */
    color: white;
}
/* ======================================================== */
/* END: Donate Tab Styles */
/* ======================================================== */

/* ======================================================== */
/* START: Invoice Tab Styles (ইনভয়েজ ট্যাব) */
/* ======================================================== */

#invoiceContent {
    background-color: #f3f4f6; /* gray-100 */
}
.dark #invoiceContent {
    background-color: #111827; /* gray-900 */
}

#invoice-container [contenteditable="true"]:focus {
    background-color: #eff6ff; /* blue-50 */
}
.dark #invoice-container [contenteditable="true"]:focus {
    background-color: #1e3a8a; /* blue-900 */
}

#invoice-items-table input {
    border: 1px solid #d1d5db; /* gray-300 */
    border-radius: 6px;
    transition: all 0.2s ease-in-out;
    padding: 0.5rem;
}
.dark #invoice-items-table input {
    background-color: #374151; /* gray-700 */
    border-color: #4b5563; /* gray-600 */
}
#invoice-items-table input:focus {
    outline: none;
    border-color: #3b82f6; /* blue-500 */
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
}

.summary-input {
    width: 120px;
    text-align: right;
    padding: 0.25rem 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
}
.dark .summary-input {
     background-color: #374151; /* gray-700 */
    border-color: #4b5563; /* gray-600 */
}


/* Print Styles */
@media print {
    #invoice-comments {
        background-color: transparent !important;
        border: 1px solid #eee !important; /* প্রিন্টের জন্য একটি হালকা বর্ডার */
        padding: 8px !important;
        min-height: 40px !important;
    }
    body * {
        visibility: hidden;
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
    }
    .main-container {
        box-shadow: none !important;
        padding: 0 !important;
        margin: 0 !important;
    }
    #invoice-container, #invoice-container * {
        visibility: visible;
    }
    #invoice-container {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        max-width: 100%;
        border: none;
        box-shadow: none;
        padding: 0;
        margin: 0;
        border-radius: 0;
        color: #000 !important;
    }
    .no-print {
        display: none !important;
    }
    input[type="text"], 
    input[type="number"], 
    textarea {
        border: none !important;
        background-color: transparent !important;
        box-shadow: none !important;
        padding: 1px !important;
    }
    [contenteditable="true"] {
        outline: none !important;
    }
    #invoice-items-table tbody tr {
        page-break-inside: avoid;
    }
    #invoice-items-table {
        width: 100%;
    }
}
/* ======================================================== */
/* END: Invoice Tab Styles */
/* ======================================================== */

/* ======================================================== */
/* START: Color Picker Tab Styles (রঙ বাছাইকারী) */
/* ======================================================== */
/* নির্দেশনা: এই সম্পূর্ণ CSS কোডটি আপনার HTML ফাইলের <style> ট্যাগের ভেতরে যেকোনো জায়গায় যুক্ত করুন। */

.color-picker-container {
    padding: 20px;
    border-radius: 16px;
    margin: 0 auto;
    max-width: 500px;
    background-color: #f8f9fa;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}
.dark .color-picker-container {
    background-color: #2d3748;
}
.color-picker-main {
    display: flex;
    align-items: center;
    justify-content: space-around;
    gap: 20px;
    margin-bottom: 25px;
}
.color-picker-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
}
.color-picker-label {
    font-weight: 600;
    color: #374151;
}
.dark .color-picker-label {
    color: #cbd5e0;
}
#colorPickerInput {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    width: 80px;
    height: 80px;
    background-color: transparent;
    border: none;
    cursor: pointer;
}
#colorPickerInput::-webkit-color-swatch {
    border-radius: 50%;
    border: 4px solid #fff;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
}
#colorPickerInput::-moz-color-swatch {
    border-radius: 50%;
    border: 4px solid #fff;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
}
.color-preview {
    width: 120px;
    height: 120px;
    border-radius: 16px;
    border: 2px solid #e5e7eb;
    transition: background-color 0.3s ease;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}
.dark .color-preview {
    border-color: #4b5563;
}
.color-values {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.color-value-group {
    text-align: left;
}
.color-value-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #4b5569;
}
.dark .color-value-group label {
    color: #9ca3af;
}
.input-with-button {
    display: flex;
    gap: 8px;
}
.input-with-button input {
    flex-grow: 1;
    padding: 10px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-family: 'Courier New', Courier, monospace;
    font-size: 1rem;
    background-color: #f9fafb;
}
.dark .input-with-button input {
    background-color: #374151;
    border-color: #4b5563;
    color: #f3f4f6;
}
.copy-color-btn {
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    background-color: #3b82f6;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s ease;
}
.copy-color-btn:hover {
    background-color: #2563eb;
}
/* ======================================================== */
/* END: Color Picker Tab Styles */
/* ======================================================== */


/* ======================================================== */
/* START: Sidebar */
/* ======================================================== */
/* Sidebar Styles */
#sidebar {
    transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 50; /* Ensure sidebar is on top */
}
.dark #sidebar {
    background-color: #1f2937 !important; /* Tailwind CSS-এর bg-gray-800 এর রঙ */
}
#sidebarOverlay { 
    position: fixed;
    top: 0;
    left: 0;
    width: 100%; /* পুরো প্রস্থ কভার করে */
    height: 100%; /* পুরো উচ্চতা কভার করে */
    background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent black */
    display: none; /* Initially hidden */
    z-index: 40; /* Should be below sidebar but above main content */
    cursor: pointer;
}
body.sidebar-open #sidebar {
    left: 0;
}
body.sidebar-open #sidebarOverlay {
    display: block; /* Visible when sidebar is open */
}
/* Custom scrollbar for sidebar */
#sidebar-tool-list::-webkit-scrollbar {
    width: 6px;
}
#sidebar-tool-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}
.dark #sidebar-tool-list::-webkit-scrollbar-track {
    background: #4b5563;
}
#sidebar-tool-list::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
}
#sidebar-tool-list::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* Dashboard Styles */
.dashboard-card {
    background-color: #ffffff;
    color: #3f51b5;
    padding: 1rem;
    border-radius: 0.75rem;
    font-weight: 600;
    text-align: center;
    cursor: grab; /* Indicates it's draggable */
    transition: all 0.2s ease-in-out;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    position: relative;
    border: 1px solid #e0e7ff;
    user-select: none; /* Prevent text selection while dragging */
}
.dark .dashboard-card {
    background-color: #2d3748;
    color: #cbd5e0;
    border-color: #4a5568;
}
.dashboard-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
}
.dashboard-card .remove-from-dashboard {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 24px;
    height: 24px;
    background-color: #ef4444;
    color: white;
    border-radius: 50%;
    border: 2px solid white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    line-height: 1;
    cursor: pointer;
    opacity: 0;
    transform: scale(0.5);
    transition: opacity 0.2s, transform 0.2s;
}
.dark .dashboard-card .remove-from-dashboard {
    border-color: #2d3748;
}
.dashboard-card:hover .remove-from-dashboard {
    opacity: 1;
    transform: scale(1);
}
#dashboard-grid.drag-over {
    background-color: #e0e7ff;
    border-color: #3f51b5;
}
.dark #dashboard-grid.drag-over {
    background-color: #4a5563;
    border-color: #a5b4fc;
}

/* Draggable item style */
.dragging {
    opacity: 0.5;
    cursor: grabbing;
    border: 2px dashed #3f51b5 !important;
}
/* ======================================================== */
/* End: Sidebar */
/* ======================================================== */
/* ======================================================== */
/* START: Image Resizer Styles (ছবি রিসাইজার) - পরিবর্তিত */
/* ======================================================== */
#imageResizerContent {
    grid-template-columns: 1fr;
    gap: 25px;
    padding: 15px;
}

.calculator-content.active#imageResizerContent {
    display: grid;
}
/* @media (min-width: 1024px) {
    .image-resizer-container {
        grid-template-columns: 350px 1fr; /* সাইডবার এবং প্রিভিউ এর জন্য কলাম */
    /* }
} */

.image-resizer-controls {
    background-color: #ffffff;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}
.dark .image-resizer-controls {
    background-color: #1f2937;
    border-color: #4a5568;
}

.image-upload-area {
    border: 2px dashed #9ca3af;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    background-color: #f9fafb;
    transition: background-color 0.3s ease, border-color 0.3s;
    margin-bottom: 20px;
}
.dark .image-upload-area {
    background-color: #374151;
    border-color: #6b7280;
}
.image-upload-area.drag-over, .image-upload-area:hover {
    background-color: #eff6ff;
    border-color: #3b82f6;
}
.dark .image-upload-area.drag-over, .dark .image-upload-area:hover {
    background-color: #2c3748;
    border-color: #60a5fa;
}
.image-upload-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: #6b7280;
    font-weight: 500;
    cursor: pointer;
}
.dark .image-upload-label {
    color: #d1d5db;
}

.control-section {
    margin-top: 20px;
}
.control-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 10px;
    padding-bottom: 5px;
    border-bottom: 1px solid #e5e7eb;
}
.dark .control-title {
    color: #d1d5db;
    border-bottom-color: #4b5563;
}
.input-group {
    text-align: left;
}
.input-group label {
    display: block;
    margin-bottom: 6px;
    font-size: 0.9rem;
    color: #4b5569;
}
.dark .input-group label {
    color: #9ca3af;
}
.resizer-input {
    width: 100%;
    padding: 0.6rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 1rem;
    background-color: #f9fafb;
}
.dark .resizer-input {
    background-color: #4a5568;
    border-color: #718096;
    color: #f7fafc;
}

/* নতুন: ক্রপ টগল বাটনের জন্য স্টাইল */
.crop-toggle-btn {
    width: 100%;
    padding: 0.7rem 1rem;
    background-color: #8A2BE2; /* বেগুনি রঙ */
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}
.crop-toggle-btn.active {
    background-color: #dc3545; /* লাল রঙ যখন সক্রিয় */
}
.crop-toggle-btn:hover:not(:disabled) {
    background-color: #6a1aae; /* হোভারে গাঢ় বেগুনি */
}
.crop-toggle-btn.active:hover:not(:disabled) {
    background-color: #c82333; /* হোভারে গাঢ় লাল */
}
.crop-toggle-btn:disabled {
    background-color: #9ca3af;
    cursor: not-allowed;
}


.download-btn {
    width: 100%;
    padding: 0.8rem 1rem;
    margin-top: 25px;
    background-color: #10b981; /* সবুজ রঙ */
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}
.download-btn:hover:not(:disabled) {
    background-color: #059669; /* হোভারে গাঢ় সবুজ */
    transform: translateY(-2px); /* হালকা উপরে উঠবে */
}
.download-btn:disabled {
    background-color: #9ca3af; /* নিষ্ক্রিয় অবস্থায় রঙ */
    cursor: not-allowed;
    opacity: 0.7;
}

.image-resizer-preview {
    display: grid;
    grid-template-columns: 1fr; /* ডিফল্ট ১ কলাম */
    gap: 20px;
}
@media (min-width: 768px) {
    .image-resizer-preview {
        grid-template-columns: 1fr 1fr; /* মাঝারি স্ক্রিনে ২ কলাম */
    }
}
.preview-box {
    background-color: #ffffff;
    padding: 15px;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
    text-align: center;
}
.dark .preview-box {
    background-color: #1f2937;
    border-color: #4a5568;
}
.preview-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 10px;
    color: #374151;
}
.dark .preview-title {
    color: #d1d5db;
}

.image-container {
    width: 100%;
    height: auto; /* পরিবর্তিত: উচ্চতা auto করা হয়েছে */
    min-height: 200px;
    background-color: #f1f5f9;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    margin-bottom: 10px;
    position: relative;
}
.dark .image-container {
    background-color: #374151;
}
.image-container img {
    display: block; /* Cropper.js এর জন্য আবশ্যক */
    max-width: 100%; /* Cropper.js এর জন্য আবশ্যক */
    max-height: 100%;
    object-fit: contain;
    transition: opacity 0.2s ease-in-out;
}

#removeOriginalBtn {
    position: absolute;
    top: 8px;
    right: 8px;
    z-index: 10;
    width: 32px;
    height: 32px;
    background-color: rgba(239, 68, 68, 0.8);
    color: white;
    border-radius: 50%;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: bold;
    line-height: 1;
    cursor: pointer;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease-in-out;
}
#originalPreviewContainer.has-image:hover #removeOriginalBtn {
    opacity: 1;
    pointer-events: auto;
}
#removeOriginalBtn:hover {
    background-color: rgba(220, 38, 38, 1);
}

.file-info-box {
    background-color: #f8fafc;
    border-radius: 8px;
    padding: 8px;
    font-size: 0.85rem;
    color: #475569;
}
.dark .file-info-box {
    background-color: #4a5568;
    color: #d1d5db;
}
/* ======================================================== */
/* END: Image Resizer Styles */
/* ======================================================== */

/* শুরু সকল ফিচার ট্যাব */
/* এটি news-content এর স্টাইল পুনরায় ব্যবহার করে */

.news-content {
    /* আপনার বিদ্যমান স্টাইল */
     padding: 20px;
     border-radius: 16px;
     margin: 0 auto;
     max-width: 800px; /* Example max-width */
     background-color: #f8f9fa; /* Example light bg */
     box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}
.dark .news-content {
    background-color: #2d3748; /* Example dark bg */
}
.news-display-area {
    /* আপনার বিদ্যমান স্টাইল */
    background-color: #e6f7ff; /* Example light result area bg */
    border-radius: 16px;
    padding: 20px;
    text-align: center;
    border: 1px solid #b3e0ff;
}
.dark .news-display-area {
     background-color: #1a202c; /* Example dark result area bg */
     border-color: #4a5568;
}
#featuresDisplayArea h3 {
    /* আপনার বিদ্যমান h3 স্টাইল */
    font-size: 1.5rem; /* Example */
    font-weight: bold;
    margin-bottom: 1rem;
    color: #333; /* Example */
}
.dark #featuresDisplayArea h3 {
     color: #e2e8f0; /* Example */
}


/* Specific styles used within the list */
.list-disc {
    list-style-type: disc;
}
.list-circle {
    list-style-type: circle;
}
.pl-5 {
    padding-left: 1.25rem; /* 20px */
}
.pl-4 {
    padding-left: 1rem; /* 16px */
}
.text-left {
    text-align: left;
}
.mb-2 {
    margin-bottom: 0.5rem; /* 8px */
}
.mt-1 {
    margin-top: 0.25rem; /* 4px */
}
/* Color styles (replace with your actual Tailwind colors if different) */
.text-indigo-700 { color: #4338ca; }
.dark .text-indigo-400 { color: #a5b4fc; }
.text-green-700 { color: #047857; }
.dark .text-green-400 { color: #6ee7b7; }
.text-purple-700 { color: #7e22ce; }
.dark .text-purple-400 { color: #c084fc; }
.text-sky-700 { color: #0369a1; }
.dark .text-sky-400 { color: #7dd3fc; }
.text-lime-700 { color: #4d7c0f; }
.dark .text-lime-400 { color: #a3e635; }
.text-cyan-700 { color: #0e7490; }
.dark .text-cyan-400 { color: #67e8f9; }
.text-pink-700 { color: #be185d; }
.dark .text-pink-400 { color: #f9a8d4; }
.text-amber-700 { color: #b45309; }
.dark .text-amber-400 { color: #fcd34d; }
.text-rose-700 { color: #be123c; }
.dark .text-rose-400 { color: #fb7185; }
.text-violet-700 { color: #6d28d9; }
.dark .text-violet-400 { color: #a78bfa; }
.text-emerald-700 { color: #047857; }
.dark .text-emerald-400 { color: #6ee7b7; }
.text-orange-700 { color: #c2410c; }
.dark .text-orange-400 { color: #fb923c; }
.text-teal-700 { color: #0f766e; }
.dark .text-teal-400 { color: #5eead4; }
.text-blue-700 { color: #1d4ed8; }
.dark .text-blue-400 { color: #60a5fa; }
.text-fuchsia-700 { color: #a21caf; }
.dark .text-fuchsia-400 { color: #e879f9; }
.text-red-700 { color: #b91c1c; }
.dark .text-red-400 { color: #f87171; }
.text-yellow-700 { color: #a16207; }
.dark .text-yellow-400 { color: #facc15; }
.text-gray-700 { color: #374151; }
.dark .text-gray-400 { color: #9ca3af; }

/* Styles for interactive feature names in the list */
#featuresDisplayArea ul li > strong {
    cursor: pointer;
    text-decoration: underline;
    /* Optional: Add hover effect */
    transition: color 0.2s ease;
}
#featuresDisplayArea ul li > strong:hover {
    color: #1d4ed8; /* Example hover color (blue-700) */
}
.dark #featuresDisplayArea ul li > strong:hover {
    color: #60a5fa; /* Example dark hover color (blue-400) */
}
/* Link specific style */
.text-blue-600 { color: #2563eb; }
.hover\:underline:hover { text-decoration: underline; }

/* শেষ: সকল ফিচার ট্যাব */

/* ======================================================== */
/* START: আরও সেটিংস ট্যাব (More Settings) Styles */
/* ======================================================== */
.settings-page-container {
    padding: 20px;
    border-radius: 16px;
    margin: 0 auto;
    max-width: 700px;
    background-color: #f8f9fa;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    text-align: left;
}
.dark .settings-page-container {
    background-color: #2d3748;
}
.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background-color: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}
.dark .setting-item {
    background-color: #1a202c;
    border-color: #4a5568;
}
.setting-text {
    flex-grow: 1;
    margin-right: 16px;
}
/* ======================================================== */
/* END: আরও সেটিংস ট্যাব Styles */
/* ======================================================== */

/* ======================================================== */
/* START: ইতিহাস ট্যাব (History Tab) Styles */
/* ======================================================== */
.history-page-container {
    position: relative; /* রিফ্রেশ বাটন পজিশন করার জন্য এটি যোগ করুন */
    padding: 20px;
    border-radius: 16px;
    margin: 0 auto;
    max-width: 800px;
    background-color: #f8f9fa;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}
.dark .history-page-container {
    background-color: #2d3748;
}

/* নতুন: ইতিহাস হেডার কার্ডের স্টাইল */
.history-header-card {
    padding: 15px;
    border-radius: 12px;
    text-align: center;
    color: white;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    margin-bottom: 1.5rem; /* 24px */
}
.history-header-card.today {
    background: linear-gradient(135deg, #059669, #10b981); /* Green Gradient */
}
.history-header-card.tomorrow {
    background: linear-gradient(135deg, #4f46e5, #6366f1); /* Blue/Purple Gradient */
}
.history-header-card .card-supertitle {
    font-size: 1rem; /* 16px */
    font-weight: 500;
    opacity: 0.8;
    margin-bottom: 4px;
}
.history-header-card .card-day-name {
    font-size: 1.5rem; /* 24px */
    font-weight: 700;
    margin-bottom: 0;
}
/* শেষ: ইতিহাস হেডার কার্ডের স্টাইল */

#history-display-area, #history-display-area-tomorrow {
    text-align: left;
    color: #374151;
    line-height: 1.8;
}
.dark #history-display-area, .dark #history-display-area-tomorrow {
    color: #cbd5e0;
}
/* জেমিনি থেকে আসা কন্টেন্টের জন্য স্টাইল */
.history-section h4 {
    font-size: 1.25rem; /* 20px */
    font-weight: 700;
    color: #3f51b5;
    margin-top: 1.5rem; /* 24px */
    margin-bottom: 0.75rem; /* 12px */
    padding-bottom: 0.5rem; /* 8px */
    border-bottom: 2px solid #e0e7ff;
}
.dark .history-section h4 {
    color: #90cdf4;
    border-bottom-color: #4a5568;
}
.history-section ul {
    list-style-type: disc;
    padding-left: 1.75rem; /* 28px */
}
.history-section li {
    margin-bottom: 0.5rem; /* 8px */
}
.history-section p {
    font-size: 1.1rem;
    font-weight: 500;
    color: #1f2937;
    background-color: #e6f7ff;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #b3e0ff;
}
.dark .history-section p {
    color: #e5e7eb;
    background-color: #1a202c;
    border-color: #4a5568;
}
/* ======================================================== */
/* END: ইতিহাস ট্যাব Styles */
/* ======================================================== */

/* শুরু নতুন: ওয়েব সার্চ বা ব্রাউজার স্টাইল */
.web-browser-content {
    padding: 10px;
    border-radius: 16px;
    margin: 0 auto;
    max-width: 98%;
    background-color: #f8f9fa;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    height: 80vh; /* পুরো হাইট নেওয়ার জন্য */
    display: flex;
    flex-direction: column;
}
.dark .web-browser-content {
    background-color: #2d3748;
}

.browser-toolbar {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    background-color: #e0e7ff;
    padding: 8px;
    border-radius: 12px;
    align-items: center;
}
.dark .browser-toolbar {
    background-color: #4a5568;
}

.address-bar {
    flex-grow: 1;
    padding: 10px 15px;
    border-radius: 20px;
    border: 1px solid #cce7ff;
    font-size: 1rem;
    outline: none;
    transition: all 0.3s ease;
}
.dark .address-bar {
    background-color: #2d3748;
    border-color: #718096;
    color: white;
}
.address-bar:focus {
    border-color: #3f51b5;
    box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.2);
}

.browser-btn {
    background-color: #3f51b5;
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    transition: background-color 0.2s;
    flex-shrink: 0;
}
.browser-btn:hover {
    background-color: #303f9f;
}
.browser-btn.new-tab {
    background-color: #28a745;
}
.browser-btn.new-tab:hover {
    background-color: #218838;
}

.browser-frame {
    flex-grow: 1;
    width: 100%;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    background-color: white;
}
/* শেষ নতুন: ওয়েব সার্চ বা ব্রাউজার স্টাইল */

/* --- PDF Tools Drag & Drop Sort Styles --- */
.pdf-preview-item {
    cursor: grab;
    transition: transform 0.2s, box-shadow 0.2s;
}
.pdf-preview-item.dragging {
    opacity: 0.5;
    transform: scale(0.95);
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    cursor: grabbing;
}
.pdf-preview-item:hover::after {
    content: attr(data-serial);
    position: absolute;
    bottom: 5px;
    left: 5px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
    pointer-events: none;
}

/* --- Meme Generator Canvas Styles --- */
#memeCanvas {
    cursor: crosshair;
    touch-action: none; /* মোবাইলে স্ক্রল বন্ধ করার জন্য */
}
.meme-controls-overlay {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 5px;
}

/* ========================================= */
/* START: ড্রপডাউন মেনু এনিমেশন স্টাইল (আপডেট করা হয়েছে) */
/* ========================================= */

/* ড্রপডাউন কন্টেইনার যখন ওপেন হবে (hidden ক্লাস সরে যাবে) */
#moreMenuDropdown:not(.hidden), 
#settingsMenuDropdown:not(.hidden) {
    /* ফেড-ইন এবং বর্ডার ব্লিংক এনিমেশন একসাথে */
    animation: dropdownFadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards, borderBlink 2s infinite ease-in-out;
    transform-origin: top right; /* ডানদিকের উপর থেকে ওপেন হবে */
    border: 1px solid #b3e0ff; /* ফলব্যাক বর্ডার */
}

/* ডার্ক মোডে ড্রপডাউন ওপেন হলে */
.dark #moreMenuDropdown:not(.hidden), 
.dark #settingsMenuDropdown:not(.hidden) {
    animation: dropdownFadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards, borderBlinkDark 2s infinite ease-in-out;
    border: 1px solid #4a5568; /* ফলব্যাক বর্ডার */
}

/* কন্টেইনারের ওপেনিং এনিমেশন */
@keyframes dropdownFadeIn {
    from {
        opacity: 0;
        transform: scale(0.9) translateY(-10px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

/* লাইট মোড বর্ডার ব্লিংক এনিমেশন */
@keyframes borderBlink {
    0%, 100% {
        border-color: #b3e0ff;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    50% {
        border-color: #3f51b5; /* নীল রঙে জ্বলবে */
        box-shadow: 0 0 10px rgba(63, 81, 181, 0.4); /* গ্লো ইফেক্ট */
    }
}

/* ডার্ক মোড বর্ডার ব্লিংক এনিমেশন */
@keyframes borderBlinkDark {
    0%, 100% {
        border-color: #4a5568;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
    }
    50% {
        border-color: #90cdf4; /* হালকা নীল রঙে জ্বলবে */
        box-shadow: 0 0 10px rgba(144, 205, 244, 0.4); /* গ্লো ইফেক্ট */
    }
}

/* ড্রপডাউনের ভেতরের বাটনগুলোর জন্য এনিমেশন */
#moreMenuDropdown:not(.hidden) .tab-button,
#settingsMenuDropdown:not(.hidden) .tab-button {
    opacity: 0; /* শুরুতে অদৃশ্য থাকবে */
    animation: tabSlideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

/* বাটন স্লাইড এবং ফেড এনিমেশন */
@keyframes tabSlideIn {
    0% {
        opacity: 0;
        transform: translateY(15px) scale(0.95);
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* প্রতিটি বাটনে আলাদা ডিলে (Delay) দেওয়া, যাতে একটার পর একটা ঢেউয়ের মতো আসে */
#moreMenuDropdown:not(.hidden) .tab-button:nth-child(1) { animation-delay: 0.05s; }
#moreMenuDropdown:not(.hidden) .tab-button:nth-child(2) { animation-delay: 0.08s; }
#moreMenuDropdown:not(.hidden) .tab-button:nth-child(3) { animation-delay: 0.11s; }
#moreMenuDropdown:not(.hidden) .tab-button:nth-child(4) { animation-delay: 0.14s; }
#moreMenuDropdown:not(.hidden) .tab-button:nth-child(5) { animation-delay: 0.17s; }
#moreMenuDropdown:not(.hidden) .tab-button:nth-child(6) { animation-delay: 0.20s; }
#moreMenuDropdown:not(.hidden) .tab-button:nth-child(7) { animation-delay: 0.23s; }
#moreMenuDropdown:not(.hidden) .tab-button:nth-child(8) { animation-delay: 0.26s; }
#moreMenuDropdown:not(.hidden) .tab-button:nth-child(9) { animation-delay: 0.29s; }
#moreMenuDropdown:not(.hidden) .tab-button:nth-child(10) { animation-delay: 0.32s; }
#moreMenuDropdown:not(.hidden) .tab-button:nth-child(11) { animation-delay: 0.35s; }
#moreMenuDropdown:not(.hidden) .tab-button:nth-child(12) { animation-delay: 0.38s; }
#moreMenuDropdown:not(.hidden) .tab-button:nth-child(13) { animation-delay: 0.41s; }
#moreMenuDropdown:not(.hidden) .tab-button:nth-child(14) { animation-delay: 0.44s; }
#moreMenuDropdown:not(.hidden) .tab-button:nth-child(15) { animation-delay: 0.47s; }
/* ১৫ এর অধিক বাটন থাকলে সেগুলোর জন্য ফিক্সড ডিলে */
#moreMenuDropdown:not(.hidden) .tab-button:nth-child(n+16) { animation-delay: 0.50s; }

/* ========================================= */
/* END: ড্রপডাউন মেনু এনিমেশন স্টাইল */
/* ========================================= */

/* --- ডিজিটাল তাসবিহ মডার্ন স্টাইল --- */
.tasbeeh-container-modern {
    font-family: 'Bornomala', sans-serif;
    padding: 25px;
    border-radius: 24px;
    margin: 0 auto;
    max-width: 900px;
    background: linear-gradient(145deg, #ffffff, #f0f9ff);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    position: relative;
    overflow: hidden;
}
.dark .tasbeeh-container-modern {
    background: linear-gradient(145deg, #1a202c, #2d3748);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

/* কাউন্টার সার্কেল ডিজাইন */
.tasbeeh-counter-ring {
    width: 280px;
    height: 280px;
    border-radius: 50%;
    background: #ffffff;
    border: 8px solid #e0f2fe;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.05), 0 10px 20px rgba(59, 130, 246, 0.2);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin: 0 auto 30px auto;
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    cursor: pointer;
    position: relative;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
}
.dark .tasbeeh-counter-ring {
    background: #2d3748;
    border-color: #4a5568;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.3), 0 10px 20px rgba(0, 0, 0, 0.4);
}
.tasbeeh-counter-ring:active {
    transform: scale(0.95);
    border-color: #3b82f6;
}

/* কাউন্টার টেক্সট */
.tasbeeh-count-text {
    font-size: 5.5rem;
    font-weight: 700;
    color: #3b82f6;
    line-height: 1;
}
.dark .tasbeeh-count-text {
    color: #60a5fa;
}
.tasbeeh-label {
    font-size: 1.1rem;
    color: #64748b;
    margin-top: 5px;
}
.dark .tasbeeh-label {
    color: #94a3b8;
}

/* ইউজার লিস্ট স্টাইল */
.user-list-container {
    max-height: 300px;
    overflow-y: auto;
    padding-right: 5px;
    scrollbar-width: thin;
}
.user-card {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 12px 16px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s ease;
    cursor: pointer;
}
.dark .user-card {
    background: #2d3748;
    border-color: #4a5568;
}
.user-card:hover {
    transform: translateX(5px);
    border-color: #3b82f6;
}
.user-card.active-user {
    background: #eff6ff;
    border-left: 4px solid #3b82f6;
    border-color: #bfdbfe;
}
.dark .user-card.active-user {
    background: #374151;
    border-color: #4a5568;
    border-left-color: #60a5fa;
}
.user-info h4 {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1e293b;
}
.dark .user-info h4 {
    color: #f1f5f9;
}
.user-info p {
    font-size: 0.9rem;
    color: #64748b;
}
.dark .user-info p {
    color: #cbd5e0;
}
.user-actions button {
    padding: 6px;
    border-radius: 6px;
    transition: background 0.2s;
}
.user-actions button:hover {
    background: #e2e8f0;
}
.dark .user-actions button:hover {
    background: #4a5568;
}

/* ক্লিক এনিমেশন */
@keyframes clickPulse {
    0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
    70% { box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); }
    100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
}
.pulse-animation {
    animation: clickPulse 0.3s ease-out;
}

/* ========================================= */
/* START: অডিও ভিজুয়ালাইজার আইকন স্টাইল (নতুন) */
/* ========================================= */
.playing-icon {
    display: inline-flex;
    align-items: flex-end;
    justify-content: center;
    width: 16px;
    height: 16px;
    margin-left: auto; /* আইকনটিকে ডানদিকে সরাবে */
    gap: 2px;
    padding-bottom: 3px;
}

.playing-icon .bar {
    width: 3px;
    background-color: currentColor; /* টেক্সটের রঙের সাথে মিলবে */
    border-radius: 2px;
    animation: visualizer-bounce 0.5s infinite ease-in-out alternate;
}

.playing-icon .bar:nth-child(1) { height: 6px; animation-delay: 0s; }
.playing-icon .bar:nth-child(2) { height: 12px; animation-delay: 0.2s; }
.playing-icon .bar:nth-child(3) { height: 8px; animation-delay: 0.4s; }

@keyframes visualizer-bounce {
    0% { height: 4px; }
    100% { height: 14px; }
}
/* ========================================= */
/* END: অডিও ভিজুয়ালাইজার আইকন স্টাইল */
/* ========================================= */

/* ======================================================== */
/* START: Diff Checker Styles (Modern Side-by-Side) */
/* ======================================================== */
.diff-checker-content {
    padding: 20px;
    border-radius: 16px;
    margin: 0 auto;
    max-width: 98%; /* আরো প্রশস্ত ভিউ */
    background-color: #f8f9fa;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.dark .diff-checker-content {
    background-color: #2d3748;
}

.diff-editor-container {
    display: flex;
    gap: 15px;
    height: 300px; /* ইনপুট সেকশনের হাইট কমানো হয়েছে যাতে রেজাল্ট বড় দেখা যায় */
}

.diff-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    background-color: #ffffff;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    overflow: hidden;
}
.dark .diff-pane {
    background-color: #1e1e1e;
    border-color: #4a5568;
}

.diff-pane-header {
    padding: 10px 15px;
    background-color: #e2e8f0;
    font-weight: 700;
    color: #4a5568;
    border-bottom: 1px solid #d1d5db;
    font-size: 0.95rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.dark .diff-pane-header {
    background-color: #2d2d2d;
    color: #e2e8f0;
    border-bottom-color: #4a5568;
}

.diff-textarea {
    flex: 1;
    width: 100%;
    resize: none;
    padding: 15px;
    border: none;
    outline: none;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.6;
    background-color: transparent;
    color: #333;
    /* নতুন যুক্ত করা হয়েছে: টেক্সট জাস্টিফাই এবং শেষ লাইন বামে */
    text-align: justify;
    text-align-last: left;
}
.dark .diff-textarea {
    color: #d4d4d4;
}

/* রেজাল্ট সেকশন স্টাইল */
.diff-result-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    height: 500px; /* রেজাল্ট দেখার জন্য বড় জায়গা */
}

.diff-result-box {
    background-color: #ffffff;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}
.dark .diff-result-box {
    background-color: #1e1e1e;
    border-color: #4a5568;
}

.diff-result-content {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
    color: #333;
    /* নতুন যুক্ত করা হয়েছে: টেক্সট জাস্টিফাই এবং শেষ লাইন বামে */
    text-align: justify;
    text-align-last: left;
}
.dark .diff-result-content {
    color: #d4d4d4;
}

/* হাইলাইটিং কালার */
.diff-removed {
    background-color: #ffeef0;
    color: #b91c1c;
    text-decoration: line-through;
    border-radius: 2px;
    padding: 0 2px;
}
.dark .diff-removed {
    background-color: #450a0a;
    color: #fecaca;
}

.diff-added {
    background-color: #e6ffed;
    color: #166534;
    font-weight: bold;
    border-radius: 2px;
    padding: 0 2px;
}
.dark .diff-added {
    background-color: #064e3b;
    color: #a7f3d0;
}

.diff-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 10px;
}

@media (max-width: 768px) {
    .diff-editor-container, .diff-result-grid {
        grid-template-columns: 1fr;
        flex-direction: column;
        height: auto;
    }
    .diff-textarea, .diff-result-content {
        min-height: 200px;
    }
}
/* ======================================================== */
/* END: Diff Checker Styles */
/* ======================================================== */

/* ======================================================== */
/* START: Text Encryption Tab Styles */
/* ======================================================== */
.encryption-content {
    padding: 20px;
    border-radius: 16px;
    margin: 0 auto;
    max-width: 700px;
    background-color: #f8f9fa;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}
.dark .encryption-content {
    background-color: #2d3748;
}

.encryption-input-group {
    margin-bottom: 20px;
    text-align: left;
}

.encryption-input-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #374151;
}
.dark .encryption-input-group label {
    color: #cbd5e0;
}

.encryption-textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #cce7ff;
    border-radius: 10px;
    font-size: 1rem;
    background-color: #ffffff;
    color: #333;
    min-height: 120px;
    resize: vertical;
}
.dark .encryption-textarea {
    background-color: #4a5568;
    border-color: #718096;
    color: #f7fafc;
}

.encryption-password-input {
    width: 100%;
    padding: 10px;
    border: 1px solid #cce7ff;
    border-radius: 8px;
    font-size: 1rem;
    background-color: #ffffff;
    color: #333;
}
.dark .encryption-password-input {
    background-color: #4a5568;
    border-color: #718096;
    color: #f7fafc;
}

.encryption-btn-group {
    display: flex;
    gap: 15px;
    margin-top: 10px;
    flex-wrap: wrap;
}

.encrypt-btn {
    flex: 1;
    background-color: #ef4444; /* Red */
    color: white;
    padding: 12px;
    border-radius: 8px;
    font-weight: bold;
    transition: background 0.3s;
}
.encrypt-btn:hover { background-color: #dc2626; }

.decrypt-btn {
    flex: 1;
    background-color: #10b981; /* Green */
    color: white;
    padding: 12px;
    border-radius: 8px;
    font-weight: bold;
    transition: background 0.3s;
}
.decrypt-btn:hover { background-color: #059669; }

.encryption-result-area {
    margin-top: 25px;
    position: relative;
}
/* ======================================================== */
/* END: Text Encryption Tab Styles */
/* ======================================================== */

/* ========================================= */
/* START: Voice Command & PWA Styles (নতুন) */
/* ========================================= */
.voice-command-btn {
    background-color: #e0e7ff;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    padding: 8px;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.3s ease;
    /* margin-right: 8px; মুছে ফেলা হয়েছে যাতে আইকনগুলো কাছাকাছি থাকে */
    position: relative;
    /* ফোকাস স্টাইল যোগ করা হয়েছে */
    outline: none;
}
/* ফোকাস হলে রিং ইফেক্ট */
.voice-command-btn:focus, .theme-toggle-button:focus {
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5); /* Indigo color ring */
}

.dark .voice-command-btn {
    background-color: #4a5568;
    color: #f7fafc;
}
.dark .voice-command-btn:focus, .dark .theme-toggle-button:focus {
    box-shadow: 0 0 0 3px rgba(165, 180, 252, 0.5); /* Lighter ring for dark mode */
}

.voice-command-btn:hover {
    transform: scale(1.1);
    background-color: #c7d2fe;
}
.dark .voice-command-btn:hover {
    background-color: #718096;
}
.voice-command-btn.listening {
    background-color: #ef4444; /* শোনার সময় লাল হবে */
    color: white;
    animation: pulse-ring 1.5s infinite;
}
.voice-command-btn.listening svg {
    animation: bounce 1s infinite;
}
@keyframes pulse-ring {
    0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
    100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
}
@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-3px); }
}
/* PWA Install Button (ডিফল্টভাবে লুকানো থাকবে) */
#pwaInstallBtn {
    display: none;
    /* আগের কালার কোড মুছে ফেলা হয়েছে, এখন এটি ভয়েস বাটনের স্টাইল পাবে */
}

/* টুলটিপ ডিজাইন */
    .has-tooltip {
        position: relative;
    }
    .has-tooltip::after {
        content: attr(data-tooltip);
        position: absolute;
        background-color: #1f2937; /* Gray-800 */
        color: white;
        padding: 4px 12px;
        font-size: 0.75rem;
        border-radius: 9999px;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        /* হাইড হওয়ার সময় (হোভার সরলে) কোনো ডিলে থাকবে না, সাথে সাথে মিলিয়ে যাবে */
        transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        z-index: 100;
        pointer-events: none;

        /* ডিফল্ট পজিশন (আইকনের উপরে) */
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
    }
    .has-tooltip:hover::after {
        opacity: 1;
        visibility: visible;
        /* ডিফল্ট এনিমেশন (নিচ থেকে উপরে) */
        transform: translateX(-50%) translateY(-5px);
        /* শো হওয়ার সময় (হোভার করলে) ২ সেকেন্ড ডিলে হবে */
        transition-delay: 1s;
    }

    /* শুধুমাত্র সাইডবার টগল বাটনের জন্য টুলটিপ ডানে হবে */
    #sidebarToggle.has-tooltip::after {
        bottom: auto; /* ডিফল্ট পজিশন রিসেট */
        top: 50%;
        left: 125%; /* আইকনের ডানপাশে */
        transform: translateY(-50%); /* লম্বভাবে মাঝখানে */
    }
    
    #sidebarToggle.has-tooltip:hover::after {
        /* সাইডবারের জন্য এনিমেশন (বাম থেকে ডানে) */
        transform: translateY(-50%) translateX(5px);
        /* এখানেও ২ সেকেন্ড ডিলে যোগ করা হলো */
        transition-delay: 1s;
    }


/* ========================================= */
/* END: Voice Command & PWA Styles */
/* ========================================= */

/* কীবোর্ড ড্রপডাউন এনিমেশন */
#keyboardLayoutDropdown {
    transition: opacity 0.2s ease-out, transform 0.2s ease-out;
}
#keyboardLayoutDropdown.hidden {
    opacity: 0;
    transform: scale(0.95);
    pointer-events: none;
}
#keyboardLayoutDropdown:not(.hidden) {
    opacity: 1;
    transform: scale(1);
    pointer-events: auto;
}

/* অ্যাক্টিভ লেআউটের জন্য স্টাইল */
.layout-option.active {
    background-color: #e0e7ff; /* light indigo */
    color: #4338ca; /* dark indigo */
    font-weight: 600;
}
.dark .layout-option.active {
    background-color: #374151;
    color: #818cf8;
}
.layout-option.active .check-icon {
    display: block;
}
/* কীবোর্ড ড্রপডাউন এনিমেশন */

/* --- Live Cricket Ticker Styles (New) --- */
#cricket-ticker-container {
    transition: all 0.5s ease;
    animation: fadeIn 0.5s ease-out;
}
.ball-run {
    width: 20px;
    height: 20px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-size: 11px;
    font-weight: bold;
    color: #1e3a8a; /* Dark Blue */
    background-color: #f3f4f6; /* Gray-100 */
    margin-left: 3px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}
.ball-run.four { background-color: #22c55e; color: white; border: 1px solid #166534; } /* Green */
.ball-run.six { background-color: #8b5cf6; color: white; border: 1px solid #5b21b6; } /* Purple */
.ball-run.wicket { background-color: #ef4444; color: white; border: 1px solid #b91c1c; } /* Red */
.ball-run.dot { color: #6b7280; } /* Gray Text */

/* --- end Live Cricket Card Styles --- */


<!-- এখান থেকে ওপরে নতুন ট্যাবের সি এস এস কোড লিখতে হবে বা বসাতে হয় বা বসাতে হবে -->
    </style>
</head>
<body>

<div id="preloader">
    <!-- ছবি চাইলে নিচের লাইন আনকমেন্ট -->
    <!-- <img id="preloader-image" src="https://cdn.jsdelivr.net/gh/mdsifatgitid/mdsifatgitid.github.io/Md%20Shahiduzzaman%20Sifat.png" alt="Profile Picture"> -->
    <h1 id="preloader-name">...</h1>
</div>

    <!-- Animated Background -->
    <div class="area">
        <ul class="circles">
            <li></li>
            <li></li>
            <li></li>
            <li></li>
            <li></li>
            <li></li>
            <li></li>
            <li></li>
            <li></li>
            <li></li>
        </ul>
    </div>
	
<!--css style started from here ওপরে অন্যান্য স্টাইলগুলো আছে।-->

    <div class="main-container">
        <!-- বর্তমান তারিখ ও সময় ব্যানার -->
        <!-- মার্জিন কমানো হয়েছে: mb-4 থেকে mb-0 এবং mt-0 যোগ করা হয়েছে -->
        <div id="currentDateTimeBanner" class="text-center text-lg font-semibold mb-0 mt-0 p-2 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-lg shadow-md">
            <!-- JavaScript দ্বারা তারিখ ও সময় এখানে আপডেট হবে -->
        </div>

<!-- NEW: Live Cricket Ticker Section -->
        <div id="cricket-ticker-container" class="hidden relative group w-full max-w-4xl mx-auto mt-2 mb-1 bg-indigo-100 dark:bg-gray-700 text-indigo-900 dark:text-gray-100 p-2 rounded-lg shadow-inner border border-indigo-200 dark:border-gray-600 flex flex-wrap items-center justify-between gap-2 text-sm z-10 transition-all duration-300" style="font-family: 'Bornomala', sans-serif;">
            
            <!-- Close Button (Hidden by default, shown on hover) -->
            <!-- পরিবর্তন: hover:scale-75 সরিয়ে scale-75 দেওয়া হয়েছে -->
            <button id="closeTickerBtn" class="absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center shadow-lg opacity-0 group-hover:opacity-100 scale-75 transition-all duration-200 z-50 cursor-pointer" title="টিকার মুছুন">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <!-- Teams & Scores -->
            <div class="flex items-center gap-3 flex-grow justify-center sm:justify-start min-w-0">
                <div class="flex items-center gap-1.5">
                    <img id="ctTeam1Flag" src="" class="w-5 h-5 rounded-full bg-white p-0.5 object-cover hidden">
                    <span id="ctTeam1Name" class="font-bold uppercase text-indigo-800 dark:text-blue-300 tracking-wider"></span>
                    <span id="ctTeam1Score" class="font-bold text-black dark:text-white text-base shadow-sm"></span>
                </div>
                
                <span class="text-blue-600 dark:text-blue-400 font-black text-xs px-1 italic">VS</span>
                
                <div class="flex items-center gap-1.5">
                    <img id="ctTeam2Flag" src="" class="w-5 h-5 rounded-full bg-white p-0.5 object-cover hidden">
                    <span id="ctTeam2Name" class="font-bold uppercase text-indigo-800 dark:text-blue-300 tracking-wider"></span>
                    <span id="ctTeam2Score" class="font-bold text-black dark:text-white text-base shadow-sm"></span>
                </div>
            </div>

            <!-- Match Status / Result / Countdown -->
            <div id="ctMatchStatus" class="font-semibold text-indigo-700 dark:text-indigo-300 text-xs sm:text-sm text-center flex-shrink-0 animate-pulse px-2"></div>

            <!-- Recent Balls (Last Over) -->
            <div id="ctLastOver" class="flex items-center bg-white/50 dark:bg-black/20 rounded-full px-3 py-1 hidden sm:flex gap-1 border border-indigo-100 dark:border-gray-600">
                <span class="text-[10px] text-gray-600 dark:text-gray-300 mr-1 uppercase font-bold">Recent:</span>
                <!-- Balls will be injected here via JS -->
            </div>
        </div>

		
<!-- Animated News Ticker Start (Updated) -->
<div id="news-ticker-container" class="relative w-full max-w-2xl mx-auto mt-3 mb-1 overflow-hidden bg-indigo-100 dark:bg-gray-700 p-1 rounded-lg shadow-inner transition-[height] duration-500 ease-in-out">
    <!-- Ticker Content Area -->
    <div id="news-ticker-content" class="w-full text-center overflow-hidden relative">
        <a id="news-ticker-text" href="#" target="_blank" class="text-indigo-800 dark:!text-white font-semibold block px-10"></a>
    </div>

    <!-- News Summary Overlay (Hidden by default) -->
    <div id="news-summary-view" class="hidden absolute top-0 left-0 w-full h-full bg-white dark:bg-gray-800 z-20 overflow-y-auto rounded-lg custom-scrollbar">
         <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-4 border-b pb-2 dark:border-gray-600 sticky top-0 bg-white dark:bg-gray-800 z-10 flex items-center gap-2 p-4 shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="text-indigo-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" /></svg>
            সংবাদ সারসংক্ষেপ (AI)
         </h3>
         
         <div id="news-summary-start-view" class="absolute inset-0 flex flex-col items-center justify-center bg-white dark:bg-gray-800 z-30 pt-10">
            <button id="btn-load-summary" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-full shadow-lg transition-transform transform hover:scale-105 flex items-center gap-2 animate-bounce">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                নিউজ সামারি দেখুন
            </button>
            <p class="mt-4 text-xs text-gray-500 dark:text-gray-400">এআই এর মাধ্যমে সংবাদের সারসংক্ষেপ</p>
         </div>

         <div id="news-summary-loading" class="hidden flex flex-col items-center justify-center py-10">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 dark:border-indigo-400 mb-2"></div>
            <p class="text-sm text-gray-500 dark:text-gray-400 animate-pulse">সংবাদ বিশ্লেষণ করা হচ্ছে...</p>
         </div>

         <div id="news-summary-list" class="space-y-4 pb-2 p-4 hidden"></div>
    </div>

    <!-- NEW: Headlines List Overlay (Hidden by default) -->
    <div id="news-headlines-view" class="hidden absolute top-0 left-0 w-full h-full bg-white dark:bg-gray-800 z-20 overflow-y-auto rounded-lg p-0 custom-scrollbar">
         <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-0 border-b pb-2 dark:border-gray-600 sticky top-0 bg-white dark:bg-gray-800 z-10 flex items-center justify-between gap-2 p-4 shadow-sm">
            <div class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="text-green-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16" /></svg>
                সকল সংবাদ শিরোনাম
            </div>
            <!-- Manual Refresh Button removed from header injection, now in controls -->
         </h3>
         <div id="news-headlines-list" class="space-y-2 pb-2 p-4"></div>
    </div>

    <!-- Navigation Buttons -->
    <button id="prev-news" class="news-nav-icon absolute left-1 top-1/2 transform -translate-y-1/2 z-30" title="পূর্ববর্তী সংবাদ">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/></svg>
    </button>

    <!-- Right Controls Group -->
    <div id="ticker-right-controls" class="absolute right-1 top-1/2 transform -translate-y-1/2 flex gap-1 z-30 transition-all duration-300">
        
        <!-- View All Headlines Button (Hidden by default, shown in Summary View) -->
        <button id="view-headlines-btn" class="hidden news-nav-icon static transform-none bg-green-100 dark:bg-gray-600 text-green-600 dark:text-green-300 hover:bg-green-200 dark:hover:bg-gray-500" title="সকল শিরোনাম দেখুন">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5z"/>
                <path d="M1.5 3.5A1.5 1.5 0 0 1 3 2h1a1.5 1.5 0 0 1 1.5 1.5v1A1.5 1.5 0 0 1 4 6H3a1.5 1.5 0 0 1-1.5-1.5v-1zm1 .5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zm-1 5A1.5 1.5 0 0 1 3 7.5h1A1.5 1.5 0 0 1 5.5 9v1A1.5 1.5 0 0 1 4 11.5H3A1.5 1.5 0 0 1 1.5 10v-1zm1 .5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1zm-1 5A1.5 1.5 0 0 1 1.5-1.5h1a1.5 1.5 0 0 1 1.5 1.5v1a1.5 1.5 0 0 1-1.5 1.5H3a1.5 1.5 0 0 1-1.5-1.5v-1zm1 .5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-1z"/>
            </svg>
        </button>

        <!-- Refresh Button (Summary) -->
        <button id="refresh-summary-btn" class="hidden news-nav-icon static transform-none bg-blue-100 dark:bg-gray-600 text-blue-600 dark:text-blue-300 hover:bg-blue-200 dark:hover:bg-gray-500" title="সামারি রিফ্রেশ করুন">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
            </svg>
        </button>
        
        <!-- NEW: Refresh Button (Headlines) - Placed with other icons -->
        <button id="refresh-headlines-btn" class="hidden news-nav-icon static transform-none bg-green-100 dark:bg-gray-600 text-green-600 dark:text-green-300 hover:bg-green-200 dark:hover:bg-gray-500" title="শিরোনাম রিফ্রেশ করুন">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
            </svg>
        </button>

        <button id="next-news" class="news-nav-icon static transform-none" title="পরবর্তী সংবাদ">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg>
        </button>
        
        <!-- Summary Toggle Button (Acts as Close button when expanded) -->
        <button id="summary-news-btn" class="news-nav-icon static transform-none bg-indigo-200 dark:bg-gray-600 text-indigo-800 dark:text-white hover:bg-indigo-300 dark:hover:bg-gray-500" title="সংবাদ সারসংক্ষেপ দেখুন">
            <svg id="icon-summary" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                 <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                 <path d="M4.5 10a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5zm0 2a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
            </svg>
            <svg id="icon-close" class="hidden" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
            </svg>
        </button>
    </div>
</div>
<!-- Animated News Ticker End -->


<!-- টাইটেল এবং ভয়েস কমান্ড বাটন এরিয়া শুরু -->
        <div class="flex justify-center items-center gap-3 mb-2 mt-2">
            <h2 id="main-heading" class="text-2xl font-bold text-gray-800 dark:text-white mb-0">বাংলা টুলবক্স</h2>
            
            <div class="flex items-center gap-1"> <!-- বাটন দুটিকে একটি গ্রুপে রাখা হয়েছে এবং গ্যাপ কমানো হয়েছে -->
                <!-- Voice Command Button -->
                <button id="voiceCommandBtn" type="button" class="voice-command-btn w-9 h-9 bg-indigo-100 dark:bg-gray-700 hover:bg-indigo-200 dark:hover:bg-gray-600 text-indigo-600 dark:text-indigo-300 rounded-full flex justify-center items-center transition-all duration-300 shadow-sm has-tooltip" data-tooltip=" ভয়েজ কমান্ড ও টিটিএস (শর্টকাট: Alt+V)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                </button>

                <!-- PWA Install Button -->
                <!-- ক্লাস voice-command-btn যুক্ত করা হয়েছে -->
                <button id="pwaInstallBtn" type="button" class="voice-command-btn w-9 h-9 bg-indigo-100 dark:bg-gray-700 hover:bg-indigo-200 dark:hover:bg-gray-600 text-indigo-600 dark:text-indigo-300 rounded-full flex justify-center items-center transition-all duration-300 shadow-sm" title="অ্যাপটি ইন্সটল করুন" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                </button>
<!-- Keyboard Layout Toggle (Voice Icon এর ডানে বসান) -->
<div class="relative inline-block text-left ml-1" id="keyboard-layout-container">
    <button id="keyboardLayoutBtn" type="button" class="voice-command-btn w-9 h-9 bg-indigo-100 dark:bg-gray-700 hover:bg-indigo-200 dark:hover:bg-gray-600 text-indigo-600 dark:text-indigo-300 rounded-full flex justify-center items-center transition-all duration-300 shadow-sm has-tooltip" data-tooltip="কীবোর্ড লেআউট (Ctrl+Space/Ctrl+K)">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
        <!-- Indicator Dot -->
        <span id="currentLayoutIndicator" class="absolute top-0 right-0 block h-2.5 w-2.5 rounded-full bg-gray-400 ring-2 ring-white transform translate-x-1/4 -translate-y-1/4 hidden"></span>
    </button>

    <!-- Dropdown Menu -->
    <div id="keyboardLayoutDropdown" class="hidden absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white dark:bg-gray-700 ring-1 ring-black ring-opacity-5 focus:outline-none z-50 origin-top-right transform transition-all duration-200 border border-gray-200 dark:border-gray-600">
        <div class="py-1" role="menu">
            <div class="px-4 py-2 text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider border-b dark:border-gray-600">
                লেআউট নির্বাচন করুন
            </div>
            <button class="layout-option w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center justify-between group active" data-layout="english">
                <span>English (Default)</span>
                <svg class="w-4 h-4 text-indigo-600 check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </button>
            <button class="layout-option w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center justify-between group" data-layout="bijoy_unicode">
                <span>বিজয় ইউনিকোড</span>
                <svg class="w-4 h-4 text-indigo-600 hidden check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </button>
            <button class="layout-option w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center justify-between group" data-layout="bijoy_ansi">
                <span>বিজয় আনসি (ANSI)</span>
                <svg class="w-4 h-4 text-indigo-600 hidden check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </button>
        </div>
    </div>
</div>
            </div>
        </div>
        <!-- টাইটেল এবং ভয়েস কমান্ড বাটন এরিয়া শেষ -->

<div class="tab-buttons">
            <!-- থিম টগল বাটন কন্টেইনার শুরু -->
            <div class="theme-toggle-container">
                <!-- এখান থেকে PWA Install Button সরানো হয়েছে -->
                
                <!-- Theme Toggle Button -->
                <button id="theme-toggle" type="button" class="theme-toggle-button has-tooltip" data-tooltip=" লাইট/ডার্ক মোড (শর্টকাট: Alt+L)">
                    <svg id="sun-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                    <svg id="moon-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                </button>
            </div> 
            <!-- থিম টগল বাটন কন্টেইনার শেষ -->
            
            <button id="basicCalcTab" class="tab-button active rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+C">সাধারণ ক্যালকুলেটর</button>
    <button id="scientificCalcTab" class="tab-button rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+S">সাইন্টিফিক ক্যালকুলেটর</button>
	<button id="dateCalcTab" class="tab-button rounded-xl">তারিখ ও সময়</button>
    <button id="ageCalcTab" class="tab-button rounded-xl">বয়স ক্যালকুলেটর</button>
	<button id="webSearchTab" class="tab-button rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+G">ওয়েব সার্চ</button>
	<button id="textAssistantTab" class="tab-button rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+A">টেক্সট অ্যাসিস্ট্যান্ট</button>
  <button id="converterTab" class="tab-button rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+B">কনভার্টার</button>
	<button id="prayerTimeTab" class="tab-button rounded-xl">নামাজের সময়সূচি</button>
    <button id="translatorTab" class="tab-button rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+T">ট্রান্সলেটর</button>
	<button id="wordCounterTab" class="tab-button rounded-xl">ওয়ার্ড কাউন্টার</button>
	<button id="wordMeaningTab" class="tab-button rounded-xl">শব্দের অর্থ</button>
    <button id="spellCheckTab" class="tab-button rounded-xl">বানান সংশোধন</button>
    <button id="textBeautifierTab" class="tab-button rounded-xl">লেখা সাজানো</button>
	<button id="imageToTextTab" class="tab-button rounded-xl">ছবি থেকে লেখা</button>
	<button id="typingTestTab" class="tab-button rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+Y">টাইপিং টেস্ট</button>
	<button id="sttTab" class="tab-button rounded-xl">কথা থেকে লেখা</button>
    <button id="ttsTab" class="tab-button rounded-xl">লেখা থেকে কথা</button>
	<button id="mapTab" class="tab-button rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+M">গুগল ম্যাপ</button>
    <button id="weatherTab" class="tab-button rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+W">আবহাওয়া</button>
	<button id="measurementTab" class="tab-button rounded-xl">পরিমাপ</button>
	<button id="notepadTab" class="tab-button rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+N">নোটপ্যাড</button>
	<button id="dashboardTab" class="tab-button rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+D">ড্যাশবোর্ড</button>

    
    <!-- নতুন: আরও মেনু (ড্রপডাউন) -->
    <div class="tab-buttons">
        <button id="moreMenuBtn" class="tab-button rounded-xl flex items-center gap-1 has-tooltip" data-tooltip="আরও ট্যাব দেখুন (শর্টকাট: Alt+.)">
            আরও
            <svg class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </button>
        <!-- নতুন কোড (উপরের অংশটি সরিয়ে এটি বসান) -->
		<div id="moreMenuDropdown" class="absolute right-0 mt-1 w-auto bg-white dark:bg-gray-800 rounded-lg shadow-xl z-20 hidden ring-1 ring-black ring-opacity-5">
			<div class="tab-menu-container">
				<!-- ভবিষ্যতে নতুন ট্যাব এখানে যোগ করা যাবে -->
				<button id="clockTab" class="tab-button rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+O">ঘড়ি</button>
				<button id="playerTab" class="tab-button rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+P">প্লেয়ার</button>
				<button id="quizTab" class="tab-button rounded-xl">কুইজ</button>
				<button id="historyTab" class="tab-button rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+H">ইতিহাস</button>
				<button id="daysObservancesTab" class="tab-button rounded-xl">দিবসসমূহ</button>
				<button id="holidayListTab" class="tab-button rounded-xl">ছুটির তালিকা</button>
				<button id="zakatCalcTab" class="tab-button rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+Z">যাকাতের হিসাব</button>
				<button id="qrCodeTab" class="tab-button rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+Q">কিউআর কোড</button>
				<button id="barcodeGenTab" class="tab-button rounded-xl">বারকোড</button>
				<button id="colorPickerTab" class="tab-button rounded-xl">রঙ বাছাইকারী</button>
				<button id="invoiceTab" class="tab-button rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+i">ইনভয়েজ</button>
				<button id="imageResizerTab" class="tab-button rounded-xl R">ছবি রিসাইজার</button>
				<button id="healthLifestyleTab" class="tab-button rounded-xl">স্বাস্থ্য ও জীবনধারা</button>
				<button id="emiCalcTab" class="tab-button rounded-xl">ইএমআই ক্যালকুলেটর</button>
				<button id="currencyTab" class="tab-button rounded-xl">মুদ্রা রূপান্তরকারী</button>
				<button id="unitPriceTab" class="tab-button rounded-xl">দামের তুলনা</button>
				<button id="ipInfoTab" class="tab-button rounded-xl">আইপি ও ডিভাইস ইনফো</button>
				<button id="speedTestTab" class="tab-button rounded-xl">ইন্টারনেট স্পিড</button>
				<button id="recipeTab" class="tab-button rounded-xl">রেসিপি জেনারেটর</button>
				<button id="pdfToolsTab" class="tab-button rounded-xl">পিডিএফ টুলস</button>
				<button id="jsonFormatterTab" class="tab-button rounded-xl">জেসন ফর্মাটার</button>
				<button id="memeGenTab" class="tab-button rounded-xl">মিম জেনারেটর</button>
				<button id="randomPickerTab" class="tab-button rounded-xl">র‍্যান্ডম পিকার</button>
				<button id="screenRecorderTab" class="tab-button rounded-xl">স্ক্রিন রেকর্ডার</button>
				<button id="emergencyNumbersTab" class="tab-button rounded-xl">জরুরি নম্বর</button>
				<button id="tasbeehTab" class="tab-button rounded-xl">ডিজিটাল তাসবিহ</button>
				<button id="diffCheckerTab" class="tab-button rounded-xl">ডিফ চেকার (Diff)</button>
				<button id="textEncryptionTab" class="tab-button rounded-xl">টেক্সট এনক্রিপশন</button>

				<button id="expenseTrackerTab" class="tab-button rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+E">আয়-ব্যয় হিসাব</button>
				<button id="allFeaturesTab" class="tab-button rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+F">সকল ফিচার</button>
				<button id="importantLinksTab" class="tab-button rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+K">গুরুত্বপূর্ণ লিংকসমূহ</button>
				<button id="donateTab" class="tab-button rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+J">ডোনেট</button>
			</div>
		</div>
    </div>

    <!-- নতুন: সেটিংস মেনু (ড্রপডাউন) -->
    <div class="tab-buttons">
        <button id="settingsMenuBtn" class="tab-button rounded-xl flex items-center gap-1 has-tooltip" data-tooltip="শর্টকাট: Alt+U">
            সেটিংস
            <svg class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
        </button>
        <div id="settingsMenuDropdown" class="absolute right-0 mt-1 w-auto bg-white dark:bg-gray-800 rounded-lg shadow-xl z-20 hidden ring-1 ring-black ring-opacity-5">
            <div class="tab-menu-container">
                <button id="setApiKeyBtn" class="tab-button rounded-xl">API কী সেট করুন</button>
				<button id="moreSettingsTab" class="tab-button rounded-xl has-tooltip" data-tooltip="শর্টকাট: Alt+U">আরও সেটিংস</button>
            </div>
        </div>
    </div>
</div>

<!-- মৌলিক ক্যালকুলেটর বিভাগ -->
        <div id="basicCalculatorContent" class="calculator-content active">
            <div class="basic-calculator-wrapper">
                <div class="calculator-grid">
                    <div class="output">
                        <div data-previous-operand class="previous-operand"></div>
                        <div data-current-operand class="current-operand"></div>
                    </div>
                    <button data-all-clear class="clear calculator-button rounded-xl" style="grid-column: span 2;">AC</button>
                    <button data-delete class="calculator-button rounded-xl">DEL</button>
                    <button data-operator class="operator calculator-button rounded-xl">÷</button> <!-- ভাগ -->
                    <button data-number class="calculator-button rounded-xl">7</button>
                    <button data-number class="calculator-button rounded-xl">8</button>
                    <button data-number class="calculator-button rounded-xl">9</button>
                    <button data-operator class="operator calculator-button rounded-xl">×</button> <!-- গুণ -->
                    <button data-number class="calculator-button rounded-xl">4</button>
                    <button data-number class="calculator-button rounded-xl">5</button>
                    <button data-number class="calculator-button rounded-xl">6</button>
                    <button data-operator class="operator calculator-button rounded-xl">-</button> <!-- বিয়োগ -->
                    <button data-number class="calculator-button rounded-xl">1</button>
                    <button data-number class="calculator-button rounded-xl">2</button>
                    <button data-number class="calculator-button rounded-xl">3</button>
                    <button data-operator class="operator calculator-button rounded-xl">+</button> <!-- যোগ -->
                    
                    <!-- পরিবর্তন: ০ এবং ডট বাটন সোয়াপ করা হয়েছে -->
                    <button data-number class="calculator-button rounded-xl">.</button>
                    <button data-number class="calculator-button rounded-xl">0</button>
                    <button data-operator class="operator calculator-button rounded-xl">%</button>
                    <!-- পরিবর্তন শেষ -->

                    <button data-equals class="equals calculator-button rounded-xl">=</button> <!-- সমান -->
                </div>
                <!-- নতুন: হিস্টোরি প্যানেল -->
                <div class="history-panel">
                    <div class="history-header">
                        <h3>হিস্টোরি</h3>
                        <button id="clearHistoryBtn">মুছুন</button>
                    </div>
                    <ul id="history-list">
                        <!-- হিস্টোরি আইটেম এখানে যুক্ত হবে -->
                    </ul>
                </div>
            </div>
            <!-- LLM-চালিত ব্যাখ্যা বৈশিষ্ট্য -->
            <button id="explainBasicBtn" class="explain-button rounded-xl">ব্যাখ্যা করুন ✨</button>
            <div id="basicExplanationLoading" class="loading-indicator">জেমিনি ব্যাখ্যা করছে</div>
            <div id="basicExplanation" class="response-area rounded-lg mt-4" style="background-color: #e6f7ff; border: 1px solid #b3e0ff;"></div>
        </div>

        <!-- বয়স ক্যালকুলেটর বিভাগ -->
        <div id="ageCalculatorContent" class="calculator-content">
            <div class="age-calculator-content">
                <!-- Existing Age Calculator -->
                <h3 class="text-xl font-bold text-gray-700 mb-4">বয়স গণনা করুন</h3>
                <div class="input-group">
                    <label for="birthDate">জন্ম তারিখ:</label>
                    <input type="date" id="birthDate" class="rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="input-group">
                    <label for="currentDate">বর্তমান তারিখ:</label>
                    <input type="date" id="currentDate" class="rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <button id="calculateAgeBtn" class="calculate-button rounded-xl">বয়স গণনা করুন</button>
                <div id="ageResultArea" class="result-area">
                    <p id="ageResult" class="text-xl"></p>
                    <p id="ageErrorMessage" class="error-message"></p>
                </div>
                
                <!-- Divider -->
                <hr class="my-8 border-gray-300">

<!-- New Year Calculator Feature (Updated) -->
                <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200 mt-8 border-t pt-6 dark:border-gray-600">তারিখ ও সময় যোগ/বিয়োগ</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4">যেকোনো তারিখ ও সময়ের সাথে বছর, মাস, দিন, ঘণ্টা বা মিনিট যোগ বা বিয়োগ করে নতুন সময় বের করুন।</p>
                
                <div class="input-group mb-4">
                    <label for="yearCalcDateInput" class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">তারিখ ও সময় নির্বাচন করুন (খালি রাখলে বর্তমান সময়)</label>
                    <input type="datetime-local" id="yearCalcDateInput" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                </div>

                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-semibold mb-1 text-gray-700 dark:text-gray-300">বছর</label>
                        <input type="number" id="calcYears" placeholder="0" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1 text-gray-700 dark:text-gray-300">মাস</label>
                        <input type="number" id="calcMonths" placeholder="0" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1 text-gray-700 dark:text-gray-300">দিন</label>
                        <input type="number" id="calcDays" placeholder="0" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1 text-gray-700 dark:text-gray-300">ঘণ্টা</label>
                        <input type="number" id="calcHours" placeholder="0" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold mb-1 text-gray-700 dark:text-gray-300">মিনিট</label>
                        <input type="number" id="calcMinutes" placeholder="0" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    </div>
                </div>

                <button id="calculateYearsBtn" class="calculate-button rounded-xl w-full mb-4">হিসাব করুন</button>
                <div id="yearCalcResult" class="result-area">
                    <!-- Results will be injected here -->
                </div>
            </div>
        </div>


        <!-- তারিখ ও সময় ক্যালকুলেটর বিভাগ -->
        <div id="dateCalculatorContent" class="calculator-content">
            <div class="date-time-content">
                <div class="button-group">
                    <button id="showTodayDatesBtn" class="show-date-button rounded-xl">আজকের তারিখ ও সময়</button>
                    <button id="showTomorrowDatesBtn" class="show-date-button rounded-xl">আগামীকালের তারিখ ও সময়</button>
                </div>
                <div id="dateDisplayResult" class="result-area">
                    <!-- আজকের তারিখের জন্য -->
                    <div id="todayResultSection">
                        <p class="result-section-title">আজকের তারিখ</p>
                        <p id="todayGregorianDateDisplay"></p>
                        <p id="todayBengaliDateDisplay"></p>
                        <p id="todayHijriDateDisplay"></p>
                        <p id="todayDayDisplay"></p> <!-- আজকের দিনের জন্য নতুন সারি -->
                        <p id="todayTimeDisplay"></p>
                    </div>

                    <!-- আগামীকালের তারিখের জন্য -->
                    <div id="tomorrowResultSection" style="display: none;">
                        <p class="result-section-title">আগামীকালের তারিখ</p>
                        <p id="tomorrowGregorianDateDisplay"></p>
                        <p id="tomorrowBengaliDateDisplay"></p>
                        <p id="tomorrowHijriDateDisplay"></p>
                        <p id="tomorrowDayDisplay"></p> <!-- আগামীকালের দিনের জন্য নতুন সারি -->
                        <p id="tomorrowTimeDisplay"></p>
                    </div>
                </div>

<!-- ইংরেজি থেকে বাংলা ও হিজরি তারিখ রূপান্তর বৈশিষ্ট্য -->
				<h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200 p-5">ইংরেজি থেকে বাংলা ও হিজরি তারিখ</h3>
                <div class="input-group mt-0">
                    <label for="englishDateInput" class="text-gray-700 font-semibold text-left block mb-2">ইংরেজি তারিখ লিখুন:</label>
                    <input type="date" id="englishDateInput" class="rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full p-1 border border-gray-300">
                </div>
                <button id="convertEnglishToBengaliBtn" class="show-date-button rounded-xl mt-4">তারিখ রূপান্তর করুন</button>
                <div id="bengaliConvertedDateDisplay" class="result-area mt-4">
                    <p class="result-section-title">রূপান্তরিত তারিখ</p>
                    <p id="convertedBengaliDate"></p>
                    <p id="convertedHijriDate"></p> <!-- হিজরি তারিখের জন্য নতুন লাইন -->
                    <p id="convertedDayDisplay"></p>
                </div>
<!-- বাংলা থেকে ইংরেজি তারিখ রূপান্তর বৈশিষ্ট্য (নতুন) -->
<h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200 p-5">বাংলা থেকে ইংরেজি তারিখ বের করুন</h3>
    <div class="input-group mt-4">
        <label for="bengaliDayInput" class="text-gray-700 font-semibold text-left block mb-2">বাংলা তারিখ (দিন) লিখুন:</label>
        <input type="number" id="bengaliDayInput" placeholder="যেমন: ১" class="rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full p-1 border border-gray-300">
    </div>
    <div class="input-group mt-4">
        <label for="bengaliMonthInput" class="text-gray-700 font-semibold text-left block mb-2">বাংলা মাস নির্বাচন করুন:</label>
        <select id="bengaliMonthInput" class="rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full p-2 border border-gray-300 bg-white dark:bg-gray-700">
            <option value="0">বৈশাখ</option>
            <option value="1">জ্যৈষ্ঠ</option>
            <option value="2">আষাঢ়</option>
            <option value="3">শ্রাবণ</option>
            <option value="4">ভাদ্র</option>
            <option value="5">আশ্বিন</option>
            <option value="6">কার্তিক</option>
            <option value="7">অগ্রহায়ণ</option>
            <option value="8">পৌষ</option>
            <option value="9">মাঘ</option>
            <option value="10">ফাল্গুন</option>
            <option value="11">চৈত্র</option>
        </select>
    </div>
    <div class="input-group mt-6">
        <label for="bengaliYearInput" class="text-gray-700 font-semibold text-left block mb-2">বাংলা সন লিখুন:</label>
        <input type="number" id="bengaliYearInput" placeholder="যেমন: ১৪৩১" class="rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full p-2 border border-gray-300">
    </div>
    <button id="convertBengaliToEnglishBtn" class="show-date-button rounded-xl mt-4">ইংরেজি তারিখে রূপান্তর করুন</button>
    <div id="englishConvertedDateDisplay" class="result-area mt-4">
        <p class="result-section-title">রূপান্তরিত ইংরেজি তারিখ</p>
        <p id="convertedEnglishDate"></p>
        <p id="convertedEnglishDayDisplay"></p>
    </div>

<!-- হিজরি থেকে ইংরেজি তারিখ রূপান্তর বৈশিষ্ট্য (নতুন যুক্ত করা হয়েছে) -->
<h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200 p-5">হিজরি থেকে ইংরেজি তারিখ বের করুন</h3>
    <div class="input-group mt-4">
        <label for="hijriDayInput" class="text-gray-700 font-semibold text-left block mb-2">হিজরি তারিখ (দিন) লিখুন:</label>
        <input type="number" id="hijriDayInput" placeholder="যেমন: ১০" class="rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full p-1 border border-gray-300">
    </div>
    <div class="input-group mt-4">
        <label for="hijriMonthInput" class="text-gray-700 font-semibold text-left block mb-2">হিজরি মাস নির্বাচন করুন:</label>
        <select id="hijriMonthInput" class="rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full p-2 border border-gray-300 bg-white dark:bg-gray-700">
            <option value="1">মুহাররম</option>
            <option value="2">সফর</option>
            <option value="3">রবিউল আউয়াল</option>
            <option value="4">রবিউস সানি</option>
            <option value="5">জমাদিউল আউয়াল</option>
            <option value="6">জমাদিউস সানি</option>
            <option value="7">রজব</option>
            <option value="8">শাবান</option>
            <option value="9">রমজান</option>
            <option value="10">শাওয়াল</option>
            <option value="11">জিলকদ</option>
            <option value="12">জিলহজ</option>
        </select>
    </div>
    <div class="input-group mt-6">
        <label for="hijriYearInput" class="text-gray-700 font-semibold text-left block mb-2">হিজরি সন লিখুন:</label>
        <input type="number" id="hijriYearInput" placeholder="যেমন: ১৪৪৫" class="rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full p-2 border border-gray-300">
    </div>
    <button id="convertHijriToEnglishBtn" class="show-date-button rounded-xl mt-4">ইংরেজি তারিখে রূপান্তর করুন</button>
    <div id="englishFromHijriDateDisplay" class="result-area mt-4">
        <p class="result-section-title">রূপান্তরিত ইংরেজি তারিখ</p>
        <p id="convertedEnglishFromHijriDate"></p>
        <p id="convertedEnglishFromHijriDayDisplay"></p>
    </div>
	
	                <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">সময়ের ব্যবধান ক্যালকুলেটর</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">দুটি সময়ের মধ্যবর্তী ব্যবধান বের করুন। তারিখ না দিলে শুধু সময়ের ব্যবধান দেখাবে।</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="input-group">
                        <label class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">শুরুর সময়</label>
                        <div class="flex flex-col gap-2">
                            <input type="date" id="diffStartDate" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <input type="time" id="diffStartTime" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">শেষ সময়</label>
                        <div class="flex flex-col gap-2">
                            <input type="date" id="diffEndDate" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <input type="time" id="diffEndTime" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                    </div>
                </div>
                
                <button id="calcTimeDiffBtn" class="w-full mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow transition-colors">
                    ব্যবধান হিসাব করুন
                </button>
                
                <div id="timeDiffResult" class="result-area mt-6 hidden bg-indigo-50 dark:bg-gray-800 p-4 rounded-lg border border-indigo-200 dark:border-gray-600 text-left">
                    <h4 class="font-bold text-indigo-700 dark:text-indigo-300 mb-3 text-lg border-b border-indigo-200 dark:border-gray-600 pb-2">ফলাফল:</h4>
                    <div id="diffOutputContent" class="text-gray-800 dark:text-gray-200 space-y-2"></div>
                </div>
				
                <!-- নতুন বোতাম এবং লিংক -->
                <a href="https://ajkertarikh.com" target="_blank" class="show-date-button rounded-xl mt-4 block mx-auto text-center">প্রয়োজনে এখানে তারিখ দেখুন</a>
				<a href="https://www.bangladatetoday.com/" target="_blank" class="show-date-button rounded-xl mt-4 block mx-auto text-center">অথবা এখানে তারিখ দেখুন</a>
            </div>
        </div>

<!-- বৈজ্ঞানিক ক্যালকুলেটর বিভাগ -->
        <div id="scientificCalculatorContent" class="calculator-content">
            <div class="scientific-calculator-content">
                <!-- ডিসপ্লে সেকশন (আপডেট করা হয়েছে) -->
                <div class="input-area" style="background-color: #1c262b; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #455a64; display: flex; flex-direction: column; justify-content: flex-end; height: 110px;">
                    <!-- উপরের ছোট এক্সপ্রেশন ডিসপ্লে -->
                    <div id="scientificHistoryDisplay" style="text-align: right; color: rgba(255, 255, 255, 0.6); font-size: 1.3rem; min-height: 25px; font-family: monospace; overflow: hidden; white-space: nowrap;"></div>
                    <!-- নিচের বড় ইনপুট/ফলাফল ডিসপ্লে -->
                    <input type="text" id="scientificExpressionInput" class="expression-input" placeholder="0" style="width: 100%; border: none !important; background: transparent !important; color: white !important; font-size: 2.8rem !important; text-align: right !important; padding: 0 !important; margin: 0 !important; height: auto !important; box-shadow: none !important;">
                </div>

                <div class="scientific-buttons-grid">
                    <!-- সারি ১: ফাংশনস -->
                    <button class="scientific-button rounded-lg" data-sci-input="sin">sin</button>
                    <button class="scientific-button rounded-lg" data-sci-input="cos">cos</button>
                    <button class="scientific-button rounded-lg" data-sci-input="tan">tan</button>
                    <button class="scientific-button rounded-lg" data-sci-input="log">log</button>

                    <!-- সারি ২: ফাংশনস -->
                    <button class="scientific-button rounded-lg" data-sci-input="ln">ln</button>
                    <button class="scientific-button rounded-lg" data-sci-input="(">(</button>
                    <button class="scientific-button rounded-lg" data-sci-input=")">)</button>
                    <button class="scientific-button rounded-lg" data-sci-input="^">^</button>

                    <!-- সারি ৩: ফাংশনস ও ক্লিয়ার -->
                    <button class="scientific-button rounded-lg" data-sci-input="sqrt">√</button>
                    <button class="scientific-button rounded-lg" data-sci-input="π">π</button>
                    <button class="scientific-button clear-btn rounded-lg" data-sci-input="C">C</button>
                    <button class="scientific-button rounded-lg" style="background-color: #ef5350;" data-sci-input="DEL">DEL</button>

                    <!-- সারি ৪: ৭-৮-৯ এবং ভাগ -->
                    <button class="scientific-button rounded-lg" data-sci-input="7">7</button>
                    <button class="scientific-button rounded-lg" data-sci-input="8">8</button>
                    <button class="scientific-button rounded-lg" data-sci-input="9">9</button>
                    <button class="scientific-button operator-btn rounded-lg" data-sci-input="÷">÷</button>

                    <!-- সারি ৫: ৪-৫-৬ এবং গুণ -->
                    <button class="scientific-button rounded-lg" data-sci-input="4">4</button>
                    <button class="scientific-button rounded-lg" data-sci-input="5">5</button>
                    <button class="scientific-button rounded-lg" data-sci-input="6">6</button>
                    <button class="scientific-button operator-btn rounded-lg" data-sci-input="×">×</button>

                    <!-- সারি ৬: ১-২-৩ এবং বিয়োগ -->
                    <button class="scientific-button rounded-lg" data-sci-input="1">1</button>
                    <button class="scientific-button rounded-lg" data-sci-input="2">2</button>
                    <button class="scientific-button rounded-lg" data-sci-input="3">3</button>
                    <button class="scientific-button operator-btn rounded-lg" data-sci-input="-">-</button>

                    <!-- সারি ৭: ডট, ০, পার্সেন্ট, যোগ (সোয়াপ করা হয়েছে) -->
                    <button class="scientific-button rounded-lg" data-sci-input=".">.</button>
                    <button class="scientific-button rounded-lg" data-sci-input="0">0</button>
                    <button class="scientific-button rounded-lg" data-sci-input="%">%</button>
                    <button class="scientific-button operator-btn rounded-lg" data-sci-input="+">+</button>

                    <!-- সারি ৮: সমান (পুরো জায়গা জুড়ে) -->
                    <button class="scientific-button equals-btn rounded-lg" data-sci-equals style="grid-column: span 4;">=</button>
                </div>
            </div>
            
            <div id="scientificErrorMessage" class="error-message"></div>
            <!-- LLM-চালিত ব্যাখ্যা বৈশিষ্ট্য -->
            <button id="explainScientificBtn" class="explain-button rounded-xl">ব্যাখ্যা করুন ✨</button>
            <div id="scientificExplanationLoading" class="loading-indicator">জেমিনি ব্যাখ্যা করছে</div>
            <div id="scientificExplanation" class="response-area rounded-lg mt-4" style="background-color: #e6f7ff; border: 1px solid #b3e0ff;"></div>
        </div>

<!-- পরিমাপ (ইউনিট কনভার্টার) বিভাগ শুরু -->
<div id="measurementContent" class="calculator-content">
    <div class="measurement-content">
        <div class="converter-grid">
            <!-- দৈর্ঘ্য রূপান্তরকারী -->
            <div class="converter-section">
                <h3>দৈর্ঘ্য রূপান্তরকারী</h3>
                <div class="input-row">
                    <div class="input-wrapper">
                        <label for="lengthFromValue">পরিমাণ (থেকে)</label>
                        <input type="number" id="lengthFromValue" class="unit-input" data-converter="length" value="1">
                    </div>
                    <div class="input-wrapper">
                        <label for="lengthFromUnit">একক</label>
                        <select id="lengthFromUnit" class="unit-select" data-converter="length">
                            <option value="meter">মিটার</option>
                            <option value="kilometer">কিলোমিটার</option>
                            <option value="centimeter">সেন্টিমিটার</option>
                            <option value="millimeter">মিলিমিটার</option>
                            <option value="mile">মাইল</option>
                            <option value="yard">গজ</option>
                            <option value="foot" selected>ফুট</option>
                            <option value="inch">ইঞ্চি</option>
                        </select>
                    </div>
                </div>
                <div class="input-row">
                     <div class="input-wrapper">
                        <label for="lengthToValue">ফলাফল (তে)</label>
                        <input type="number" id="lengthToValue" class="unit-input" data-converter="length_rev">
                    </div>
                    <div class="input-wrapper">
                        <label for="lengthToUnit">একক</label>
                        <select id="lengthToUnit" class="unit-select" data-converter="length">
                            <option value="meter">মিটার</option>
                            <option value="kilometer">কিলোমিটার</option>
                            <option value="centimeter">সেন্টিমিটার</option>
                            <option value="millimeter">মিলিমিটার</option>
                            <option value="mile">মাইল</option>
                            <option value="yard">গজ</option>
                            <option value="foot">ফুট</option>
                            <option value="inch" selected>ইঞ্চি</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ওজন রূপান্তরকারী -->
            <div class="converter-section">
                <h3>ওজন রূপান্তরকারী</h3>
                 <div class="input-row">
                    <div class="input-wrapper">
                        <label for="weightFromValue">পরিমাণ (থেকে)</label>
                        <input type="number" id="weightFromValue" class="unit-input" data-converter="weight" value="1">
                    </div>
                    <div class="input-wrapper">
                        <label for="weightFromUnit">একক</label>
                        <select id="weightFromUnit" class="unit-select" data-converter="weight">
                            <option value="gram">গ্রাম</option>
                            <option value="kilogram" selected>কিলোগ্রাম</option>
                            <option value="milligram">মিলিগ্রাম</option>
                            <option value="tonne">টন</option>
                            <option value="pound">পাউন্ড</option>
                            <option value="ounce">আউন্স</option>
                        </select>
                    </div>
                </div>
                <div class="input-row">
                     <div class="input-wrapper">
                        <label for="weightToValue">ফলাফল (তে)</label>
                        <input type="number" id="weightToValue" class="unit-input" data-converter="weight_rev">
                    </div>
                    <div class="input-wrapper">
                        <label for="weightToUnit">একক</label>
                        <select id="weightToUnit" class="unit-select" data-converter="weight">
                            <option value="gram" selected>গ্রাম</option>
                            <option value="kilogram">কিলোগ্রাম</option>
                            <option value="milligram">মিলিগ্রাম</option>
                            <option value="tonne">টন</option>
                            <option value="pound">পাউন্ড</option>
                            <option value="ounce">আউন্স</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ক্ষেত্রফল রূপান্তরকারী -->
            <div class="converter-section">
                <h3>ক্ষেত্রফল রূপান্তরকারী</h3>
                 <div class="input-row">
                    <div class="input-wrapper">
                        <label for="areaFromValue">পরিমাণ (থেকে)</label>
                        <input type="number" id="areaFromValue" class="unit-input" data-converter="area" value="1">
                    </div>
                    <div class="input-wrapper">
                        <label for="areaFromUnit">একক</label>
                        <select id="areaFromUnit" class="unit-select" data-converter="area">
                            <option value="sq_meter">বর্গ মিটার</option>
                            <option value="sq_kilometer">বর্গ কিলোমিটার</option>
                            <option value="sq_foot" selected>বর্গ ফুট</option>
                            <option value="sq_inch">বর্গ ইঞ্চি</option>
                            <option value="hectare">হেক্টর</option>
                            <option value="acre">একর</option>
                            <option value="bigha">বিঘা</option>
                            <option value="katha">কাঠা</option>
                            <option value="shotok">শতক</option>
                        </select>
                    </div>
                </div>
                <div class="input-row">
                     <div class="input-wrapper">
                        <label for="areaToValue">ফলাফল (তে)</label>
                        <input type="number" id="areaToValue" class="unit-input" data-converter="area_rev">
                    </div>
                    <div class="input-wrapper">
                        <label for="areaToUnit">একক</label>
                        <select id="areaToUnit" class="unit-select" data-converter="area">
                            <option value="sq_meter">বর্গ মিটার</option>
                            <option value="sq_kilometer">বর্গ কিলোমিটার</option>
                            <option value="sq_foot">বর্গ ফুট</option>
                            <option value="sq_inch">বর্গ ইঞ্চি</option>
                            <option value="hectare">হেক্টর</option>
                            <option value="acre">একর</option>
                            <option value="bigha">বিঘা</option>
                            <option value="katha" selected>কাঠা</option>
                            <option value="shotok">শতক</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- তাপমাত্রা রূপান্তরকারী -->
            <div class="converter-section">
                <h3>তাপমাত্রা রূপান্তরকারী</h3>
                 <div class="input-row">
                    <div class="input-wrapper">
                        <label for="temperatureFromValue">পরিমাণ (থেকে)</label>
                        <input type="number" id="temperatureFromValue" class="unit-input" data-converter="temperature" value="1">
                    </div>
                    <div class="input-wrapper">
                        <label for="temperatureFromUnit">একক</label>
                        <select id="temperatureFromUnit" class="unit-select" data-converter="temperature">
                            <option value="celsius" selected>সেলসিয়াস</option>
                            <option value="fahrenheit">ফারেনহাইট</option>
                            <option value="kelvin">কেলভিন</option>
                        </select>
                    </div>
                </div>
                <div class="input-row">
                     <div class="input-wrapper">
                        <label for="temperatureToValue">ফলাফল (তে)</label>
                        <input type="number" id="temperatureToValue" class="unit-input" data-converter="temperature_rev">
                    </div>
                    <div class="input-wrapper">
                        <label for="temperatureToUnit">একক</label>
                        <select id="temperatureToUnit" class="unit-select" data-converter="temperature">
                            <option value="celsius">সেলসিয়াস</option>
                            <option value="fahrenheit" selected>ফারেনহাইট</option>
                            <option value="kelvin">কেলভিন</option>
                        </select>
                    </div>
                </div>
            </div>
			
	    <!-- নতুন: সময় রূপান্তরকারী সেকশন শুরু -->

<div class="converter-section">
		<h3>সময় রুপান্তর</h3>
			<div class="input-row">
				<div class="input-wrapper">
				<label for="time24Hour">২৪-ঘণ্টা ফরম্যাট (0-23)</label>
				<input type="number" id="time24Hour" class="unit-input" placeholder="e.g., 14" min="0" max="23">
				</div>
			</div>
	<div class="input-row">
				<div class="input-wrapper" style="flex-grow: 2;">
				<label for="time12Hour">১২-ঘণ্টা ফরম্যাট (1-12)</label>
			<input type="number" id="time12Hour" class="unit-input" placeholder="e.g., 2" min="1" max="12">
		</div>
	<div class="input-wrapper" style="flex-grow: 1;">
				<label for="timeAmPm">AM/PM</label>
				<select id="timeAmPm" class="unit-select">
				<option value="AM">AM</option>
				<option value="PM">PM</option>
					</select>
					</div>
				</div>
			</div>
	<!-- নতুন: সময় রূপান্তরকারী সেকশন শেষ -->
    </div>
   </div>
</div>
<!-- পরিমাপ (ইউনিট কনভার্টার) বিভাগ শেষ -->

        <!-- নতুন: টাইপিং টেস্ট বিভাগ (আপডেট করা হয়েছে) -->
        <div id="typingTestContent" class="calculator-content">
            <div class="typing-test-content">
                <h3 class="text-xl font-bold text-gray-700 mb-4">টাইপিং টেস্ট</h3>
                <div class="typing-settings">
                    <div>
                        <label for="textSelection">অনুচ্ছেদ নির্বাচন:</label>
                        <select id="textSelection">
                            <option value="bn_1">বাংলা অনুচ্ছেদ ১</option>
                            <option value="bn_2">বাংলা অনুচ্ছেদ ২</option>
                            <option value="bn_3">বাংলা অনুচ্ছেদ ৩</option>
                            <option value="en_1">English Paragraph 1</option>
                            <option value="en_2">English Paragraph 2</option>
                            <option value="en_3">English Paragraph 3</option>
                            <option value="custom">কাস্টম টেক্সট</option>
                        </select>
                    </div>
                    <div>
                        <label for="timeSelection">সময় নির্বাচন:</label>
                        <select id="timeSelection">
                            <option value="0">আনলিমিটেড</option>
                            <option value="60">১ মিনিট</option>
                            <option value="120">২ মিনিট</option>
                            <option value="180">৩ মিনিট</option>
                            <option value="300">৫ মিনিট</option>
                        </select>
                    </div>
                </div>
                <textarea id="custom-text-input" class="hidden" placeholder="এখানে আপনার কাস্টম টেক্সট লিখুন..."></textarea>
                <div id="typingTextDisplay" class="typing-text-display">
                    পুনরায় শুরু করুন বাটনে ক্লিক করে নিচের বক্সে টাইপ করুন...
                </div>
                <textarea id="typingInput" class="typing-input" placeholder="এখানে টাইপ করুন..." disabled></textarea>
                <div id="typingStats" class="typing-stats">
                    <div class="stat-item">
                        <h4>অতিবাহিত সময়</h4>
                        <p id="elapsedTimeDisplay">০০:০০</p>
                    </div>
                    <div class="stat-item">
                        <h4>অবশিষ্ট সময়</h4>
                        <p id="remainingTimeDisplay">০০:০০</p>
                    </div>
                    <div class="stat-item">
                        <h4>WPM</h4>
                        <p id="wpmDisplay">0</p>
                    </div>
                    <div class="stat-item">
                        <h4>মোট শব্দ</h4>
                        <p id="totalWordsDisplay">0</p>
                    </div>
                    <div class="stat-item">
                        <h4>সঠিক</h4>
                        <p id="correctWordsDisplay">0</p>
                    </div>
                    <div class="stat-item">
                        <h4>ভুল</h4>
                        <p id="incorrectWordsDisplay">0</p>
                    </div>
                    <div class="stat-item">
                        <h4>নির্ভুলতা</h4>
                        <p id="accuracyDisplay">100%</p>
                    </div>
                </div>
                <div class="typing-controls">
                    <button id="restartTypingBtn" class="typing-btn restart">পুনরায় শুরু করুন</button>
                    <!-- পরিবর্তন: নতুন পজ/রিজিউম বাটন যোগ করা হয়েছে -->
                    <button id="pauseResumeTypingBtn" class="typing-btn pause">থামান</button>
                    <button id="clearTypingBtn" class="typing-btn clear">মুছুন</button>
                </div>
				
               <!-- নতুন: পরীক্ষার ফলাফল রিপোর্ট বিভাগ -->
                <div id="typingTestResultReport" class="mt-6 hidden">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200 border-t pt-4">বিস্তারিত ফলাফল</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- চার্ট ১: পারফরম্যান্স ইতিহাস -->
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                            <h4 class="font-semibold mb-2 text-center dark:text-gray-200">শেষ ১০টি পরীক্ষার পারফরম্যান্স</h4>
                            <canvas id="performanceHistoryChart"></canvas>
                        </div>
                        <!-- চার্ট ২: ধীরগতির অক্ষর -->
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                            <h4 class="font-semibold mb-2 text-center dark:text-gray-200">যে অক্ষরগুলোতে বেশি সময় লেগেছে</h4>
                            <canvas id="slowestCharsChart"></canvas>
                        </div>
                    </div>

                    <!-- ফলাফলের ইতিহাস -->
                    <div class="mt-6">
                        <h4 class="text-lg font-bold text-gray-700 mb-3 dark:text-gray-200">ফলাফলের ইতিহাস</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
                                <thead class="bg-gray-100 dark:bg-gray-700">
                                    <tr>
										<th class="p-3 text-center">ক্রমিক</th>
                                        <th class="p-3 text-left">তারিখ</th>
                                        <th class="p-3 text-center">WPM</th>
                                        <th class="p-3 text-center">নির্ভুলতা</th>
                                        <th class="p-3 text-center">ভুল শব্দ</th>
                                    </tr>
                                </thead>
                                <tbody id="typingHistoryTableBody">
                                    <!-- History rows will be injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- ফন্ট কনভার্টার বিভাগ (আনডু/রিডু সহ আপডেট করা হয়েছে) -->
<!-- ফন্ট কনভার্টার বিভাগ (প্রিসেট বাটনসহ আপডেট করা হয়েছে) -->
<div id="converterContent" class="calculator-content">

<!--
    <h1 style="color:green">যেকোনো ভাঙ্গা বিজয় লেখা বিজয় টেক্সট বক্সে রেখে ফিক্স করুন বাটনে ক্লিক করলে অথবা ইউনিকোড করে আবার বিজয় করলেও ঠিক হবে।</h1>
-->
	
    <div class="font-converter-content">

	<!-- নতুন: লাইভ কনভার্ট টগল সুইচ -->
<div id="converter-options" class="flex justify-center items-center gap-3">
    <span class="font-semibold text-gray-700 dark:text-gray-300">ম্যানুয়াল কনভার্ট</span>
    <label class="switch">
        <input type="checkbox" id="live-convert-toggle">
        <span class="slider round"></span>
    </label>
    <span class="font-semibold text-gray-700 dark:text-gray-300">লাইভ কনভার্ট</span>
</div>
        <div class="font-converter-sections-wrapper">
            <!-- বাম টেক্সটএরিয়া -->
            <div class="font-converter-section">
                <div class="font-section-header">
                    <h2>ইউনিকোড</h2>
                    <div class="flex items-center gap-2">
                        <!-- Preset Dropdown Left -->
                        <div class="relative inline-block text-left">
                            <div>
                                <button type="button" id="presetButtonLeft" class="font-copy-button rounded-lg inline-flex justify-center w-full px-4 py-2 text-sm font-medium" style="background-image: linear-gradient(to right, #fbbf24 0%, #f59e0b 100%);">
                                    প্রিসেট
                                    <svg class="-mr-1 ml-2 h-5 w-5 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                            <div id="dropdownMenuLeft" class="origin-top-left absolute left-0 mt-2 w-56 rounded-md shadow-lg bg-white dark:bg-gray-700 ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10">
                                <div class="py-1">
                                    <a href="#" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" data-preset="default">ডিফল্ট</a>
                                    <a href="#" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" data-preset="single-space">একটি স্পেস</a>
                                    <a href="#" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" data-preset="double-space">দুটি স্পেস</a>
                                    <a href="#" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" data-preset="four-space">চারটি স্পেস</a>
                                    <a href="#" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" data-preset="single-enter">একটি এন্টার</a>
                                    <a href="#" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" data-preset="double-enter">দুটি এন্টার</a>
									<a href="#" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" data-preset="double-enter-v2">দুটি এন্টার V2</a>
									<a href="#" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" data-preset="double-enter-v3">দুটি এন্টার V3</a>
                                    <a href="#" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" data-preset="custom">কাস্টম</a>
                                    <a href="#" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" data-preset="custom-serial">ক্রমিকসহ কাস্টম</a>
                                </div>
                            </div>
                        </div>
                        <button id="pasteButtonLeft" class="font-copy-button rounded-lg" style="background-image: linear-gradient(to right, #60a5fa 0%, #3b82f6 100%);">পেস্ট</button>
                        <button class="font-copy-button rounded-lg" onclick="copyToClipboard('textAreaLeft')">কপি করুন</button>
                    </div>
                </div>
                <textarea id="textAreaLeft" placeholder="এখানে ইউনিকোড টেক্সট লিখুন"></textarea>
                <div class="font-button-group">
                    <button class="font-conversion-button rounded-lg" onclick="convertLeftToRight()">ইউনিকোড থেকে বিজয়</button>
					<button id="undoButtonLeft" class="font-undo-redo-button rounded-lg">আনডু</button>
					<button id="redoButtonLeft" class="font-undo-redo-button rounded-lg">রিডু</button>
                    <button class="font-clear-button rounded-lg" onclick="clearTextarea('textAreaLeft')">মুছুন</button>
                </div>
            </div>
            <!-- ডান টেক্সটএরিয়া -->
            <div class="font-converter-section">
                <div class="font-section-header">
                    <h2>বিজয়</h2>
                    <div class="flex items-center gap-2">
                         <!-- Preset Dropdown Right -->
                        <div class="relative inline-block text-left">
                            <div>
                                <button type="button" id="presetButtonRight" class="font-copy-button rounded-lg inline-flex justify-center w-full px-4 py-2 text-sm font-medium" style="background-image: linear-gradient(to right, #fbbf24 0%, #f59e0b 100%);">
                                    প্রিসেট
                                    <svg class="-mr-1 ml-2 h-5 w-5 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                            <div id="dropdownMenuRight" class="origin-top-left absolute left-0 mt-2 w-56 rounded-md shadow-lg bg-white dark:bg-gray-700 ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10">
                                <div class="py-1">
                                     <a href="#" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" data-preset="default">ডিফল্ট</a>
                                    <a href="#" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" data-preset="single-space">একটি স্পেস</a>
                                    <a href="#" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" data-preset="double-space">দুটি স্পেস</a>
                                    <a href="#" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" data-preset="four-space">চারটি স্পেস</a>
                                    <a href="#" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" data-preset="single-enter">একটি এন্টার</a>
                                    <a href="#" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" data-preset="double-enter">দুটি এন্টার</a>
									<a href="#" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" data-preset="double-enter-v2">দুটি এন্টার V2</a>
									<a href="#" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" data-preset="double-enter-v3">দুটি এন্টার V3</a>
                                    <a href="#" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" data-preset="custom">কাস্টম</a>
                                    <a href="#" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600" data-preset="custom-serial">ক্রমিকসহ কাস্টম</a>
                                </div>
                            </div>
                        </div>
                        <button id="pasteButtonRight" class="font-copy-button rounded-lg" style="background-image: linear-gradient(to right, #60a5fa 0%, #3b82f6 100%);">পেস্ট</button>
                        <button id="fixAnsiButton" class="font-copy-button rounded-lg" style="background-image: linear-gradient(to right, #60a5fa 0%, #3b82f6 100%);">ফিক্স করুন</button>
                        <button class="font-copy-button rounded-lg" onclick="copyToClipboard('textAreaRight')">কপি করুন</button>
                    </div>
                </div>
                <textarea id="textAreaRight" placeholder="এখানে বিজয় টেক্সট লিখুন"></textarea>
                <div class="font-button-group">
                    <button class="font-conversion-button rounded-lg" onclick="convertRightToLeft()">বিজয় থেকে ইউনিকোড</button>
                    <button id="undoButtonRight" class="font-undo-redo-button rounded-lg">আনডু</button>
					<button id="redoButtonRight" class="font-undo-redo-button rounded-lg">রিডু</button>
                    <button class="font-clear-button rounded-lg" onclick="clearTextarea('textAreaRight')">মুছুন</button>
                </div>
            </div>
        </div>
        <!-- নতুন "সব মুছুন" বোতাম -->
        <button class="font-clear-all-button rounded-lg" onclick="clearAllTextareas()">সব মুছুন</button>
       
<!-- নতুন: ফাইল ইমপোর্ট/এক্সপোর্ট সেকশন -->
        <div class="file-converter-section p-4 bg-blue-50 dark:bg-gray-700 rounded-lg border border-blue-100 dark:border-gray-600 mb-2">
            <h4 class="text-lg font-bold text-gray-700 dark:text-gray-200 mb-3 text-center">ফাইল কনভার্টার (Beta)</h4>
            <div class="flex flex-col items-center gap-4">
                
                <!-- ফাইল আপলোড এরিয়া -->
                <div class="w-full relative">
                    <input type="file" id="converterFileInput" accept=".docx, .doc, .xlsx, .xls, .txt" class="hidden" />
                    <label for="converterFileInput" id="converterDropZone" class="flex flex-col items-center justify-center w-full h-32 border-2 border-blue-300 border-dashed rounded-lg cursor-pointer bg-white dark:bg-gray-800 hover:bg-blue-50 dark:hover:bg-gray-700 transition-colors transition-all duration-200">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <svg class="w-8 h-8 mb-4 text-blue-500 dark:text-blue-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>
                            </svg>
                            <p class="mb-2 text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">ফাইল আপলোড করতে ক্লিক করুন</span> অথবা ড্র্যাগ করে আনুন</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">সাপোর্টেড: .doc, .docx, .xls, .xlsx, .txt</p>
                            <p id="fileNameDisplay" class="mt-2 text-sm font-bold text-blue-600 dark:text-blue-400"></p>
                        </div>
                    </label>
                </div>

                <!-- ফাইল অ্যাকশন বাটন (ফাইল সিলেক্ট করলে ভিজিবল হবে - এবং এখন উপরে থাকবে) -->
                <div id="fileImportButtons" class="flex flex-wrap justify-center gap-3 hidden w-full mt-2">
                    <button id="importToUnicodeBtn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-sm">
                        ইউনিকোড টেক্সটবক্সে নিন
                    </button>
                    <button id="importToBijoyBtn" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow-sm">
                        বিজয় টেক্সটবক্সে নিন
                    </button>
                    <button id="clearFileBtn" class="px-6 py-2 bg-red-100 hover:bg-red-200 text-red-600 font-bold rounded-lg transition-colors border border-red-200">
                        বাতিল
                    </button>
                </div>

                <!-- মেইন এক্সপোর্ট বাটন (সবসময় ভিজিবল - এখন নিচে থাকবে) -->
                <div id="mainExportButtons" class="flex flex-wrap justify-center gap-3 w-full mt-2">
                    <button id="exportUnicodeBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow transition-transform transform hover:scale-105 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        ইউনিকোড এক্সপোর্ট
                    </button>
                    <button id="exportBijoyBtn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow transition-transform transform hover:scale-105 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        বিজয় এক্সপোর্ট
                    </button>
                    
                    <!-- কাস্টম এক্সপোর্ট ড্রপডাউন -->
                    <div class="relative inline-block text-left flex-1 min-w-[140px]">
                        <button id="customExportDropdownBtn" type="button" class="w-full h-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow flex items-center justify-center gap-2 transition-colors">
                            <span id="exportBtnText">ফরম্যাট: অটো</span>
                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="customExportMenu" class="hidden absolute right-0 bottom-full mb-2 w-full rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 z-20 overflow-hidden">
                            <div class="py-1">
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-value="default">অটো (ইনপুট অনুযায়ী)</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-value="docx">MS Word (.docx)</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-value="doc">MS Word 97-2003 (.doc)</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-value="xlsx">MS Excel (.xlsx)</a>
                                <a href="#" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" data-value="txt">Text File (.txt)</a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="fileProcessingLoader" class="hidden text-blue-600 font-semibold animate-pulse mt-2">
                    প্রসেসিং হচ্ছে... অনুগ্রহ করে অপেক্ষা করুন।
                </div>
            </div>
        </div>
        
        <a href="https://bio.link/mdsifatbiolink" target="_blank" class="external-converter-link rounded-xl">প্রয়োজনে এখানে যোগাযোগ করুন অথবা মতামত জানান</a>
    </div>
</div>

<!-- কাস্টম প্রিসেট ইনপুটের জন্য মোডাল -->
<div id="customPresetModal" class="api-key-modal-overlay hidden">
    <div class="api-key-modal-content">
        <h3 id="customModalTitle">কাস্টম প্রিসেট</h3>
        <p id="customModalDesc" class="mb-4 text-gray-600 dark:text-gray-300"></p>
        <input type="text" id="customPresetInput" placeholder="এখানে আপনার কাস্টম টেক্সট লিখুন..." class="rounded-lg">
        <div class="modal-buttons mt-4">
            <button id="saveCustomPresetBtn" class="modal-button save rounded-lg">সেভ করুন</button>
            <button id="cancelCustomPresetBtn" class="modal-button cancel rounded-lg">বাতিল করুন</button>
        </div>
    </div>
</div>

        <!-- নতুন: ট্রান্সলেটর বিভাগ -->
        <div id="translatorContent" class="calculator-content">
            <div class="translator-content">
                <h3 class="text-xl font-bold text-gray-700 mb-4">যেকোনো ভাষায় অনুবাদ করুন</h3>
                <div class="translator-grid">
                    <!-- Input Text Area -->
                    <div class="translator-section">
                        <textarea id="translatorInput" rows="8" placeholder="এখানে আপনার লেখাটি পেস্ট করুন..."></textarea>
                    </div>
                    <!-- Output Text Area -->
                    <div class="translator-section">
                        <textarea id="translatorOutput" rows="8" placeholder="অনুবাদিত লেখা এখানে দেখা যাবে..." readonly></textarea>
                    </div>
                </div>
                <div class="translator-controls mt-4">
                     <div class="language-selector-wrapper">
                        <label for="targetLanguage" class="font-semibold text-gray-700 dark:text-gray-200">কোন ভাষায় অনুবাদ করবেন:</label>
                        <select id="targetLanguage" class="rounded-lg p-2 border bg-gray-100 dark:bg-gray-600 dark:text-white">
                            <!-- Languages will be populated by JS -->
                        </select>
                    </div>
                    <button id="translateBtn" class="translate-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z"></path></svg>
                        <span>অনুবাদ করুন</span>
                    </button>
                </div>
                 <div class="translator-actions mt-4">
                     <button id="copyTranslatedTextBtn" class="font-copy-button rounded-lg">ফলাফল কপি করুন</button>
                     <button id="clearTranslatorTextBtn" class="font-clear-button rounded-lg">সব মুছুন</button>
                </div>
                <div id="translatorLoading" class="loading-indicator mt-4" style="display: none;">অনুবাদ করা হচ্ছে...</div>
            </div>
        </div>

        <!-- নতুন: বাংলা বানান সংশোধন বিভাগ -->
        <div id="spellCheckerContent" class="calculator-content">
            <div class="spell-checker-content">
                <h3 class="text-xl font-bold text-gray-700 mb-4">বাংলা বানান সংশোধন করুন</h3>
                <textarea id="spellCheckInput" rows="8" placeholder="এখানে আপনার বাংলা লেখাটি পেস্ট করুন..."></textarea>
                <div class="flex gap-4 mt-4">
                    <button id="checkSpellingBtn" class="spell-check-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z"/></svg>
                        <span>বানান পরীক্ষা করুন</span>
                    </button>
                    <!-- নতুন 'মুছুন' বাটন -->
                    <button id="clearSpellCheckBtn" class="font-clear-button rounded-lg" style="width: auto; padding: 14px 25px;">মুছুন</button>
                </div>
                <div id="spellCheckLoading" class="loading-indicator mt-4" style="display: none;">পরীক্ষা করা হচ্ছে...</div>
                <div class="result-area mt-4">
                    <p class="result-section-title">সংশোধিত লেখা</p>
                    <div id="spellCheckResult" class="text-left p-2"></div>
                </div>
            </div>
        </div>

        <!-- নতুন: লেখা সাজানো বিভাগ -->
        <div id="textBeautifierContent" class="calculator-content">
            <div class="text-beautifier-content">
                <h3 class="text-xl font-bold text-gray-700 mb-4">আপনার লেখাকে সহজ ও সুন্দর করুন</h3>
                <textarea id="beautifyInput" rows="8" placeholder="এখানে আপনার এলোমেলো বা জটিল লেখাটি পেস্ট করুন..."></textarea>
                <button id="beautifyTextBtn" class="beautify-button mt-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z"></path></svg>
                    <span>সাজিয়ে লেখো</span>
                </button>
                <div id="beautifyLoading" class="loading-indicator mt-4" style="display: none;">আপনার লেখা গোছানো হচ্ছে...</div>
                <div class="result-area mt-4">
                    <div class="flex justify-between items-center mb-2">
                        <p class="result-section-title" style="text-align: left; margin: 0;">সাজানো লেখা</p>
                        <button id="copyBeautifiedTextBtn" class="font-copy-button rounded-lg">কপি করুন</button>
                    </div>
                    <div id="beautifyResult" class="text-left p-2"></div>
                </div>
                <button id="clearBeautifyTextBtn" class="font-clear-button rounded-lg mt-4 w-full">সব মুছে ফেলুন</button>
            </div>
        </div>

        <!-- নতুন: শব্দের অর্থ বিভাগ -->
        <div id="wordMeaningContent" class="calculator-content">
            <div class="word-meaning-content">
                <h3 class="text-xl font-bold text-gray-700 mb-4">শব্দের অর্থ ও ব্যাখ্যা খুঁজুন</h3>
                <input type="text" id="wordMeaningInput" placeholder="এখানে বাংলা বা ইংরেজি শব্দ লিখুন..." class="mb-4">
                <div class="flex gap-4">
                    <button id="findMeaningBtn" class="find-meaning-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <span>অর্থ খুঁজুন</span>
                    </button>
                     <!-- নতুন 'মুছুন' বাটন -->
                    <button id="clearWordMeaningBtn" class="font-clear-button rounded-lg" style="width: auto; padding: 14px 25px;">মুছুন</button>
                </div>
                <div id="wordMeaningLoading" class="loading-indicator mt-4" style="display: none;">অর্থ খোঁজা হচ্ছে...</div>
                <div class="result-area mt-4">
                    <p class="result-section-title">ফলাফল</p>
                    <div id="wordMeaningResult" class="text-left p-2"></div>
                </div>
            </div>
        </div>
        
        <!-- নতুন: টেক্সট টু স্পিচ বিভাগ -->
        <div id="textToSpeechContent" class="calculator-content">
            <div class="tts-content">
                <h3 class="text-xl font-bold text-gray-700 mb-4">বাংলা টেক্সট টু স্পিচ</h3>
                <textarea id="ttsInput" rows="8" placeholder="এখানে আপনার বাংলা লেখাটি পেস্ট করুন..."></textarea>
                <div class="tts-controls">
                    <div class="control-group">
                        <label for="voiceSelect">ভয়েস নির্বাচন করুন:</label>
                        <select id="voiceSelect" class="rounded-lg"></select>
                    </div>
                    <div class="control-group">
                        <label for="rate">গতি:</label>
                        <input type="range" min="0.5" max="2" value="1" step="0.1" id="rate">
                        <span id="rate-value">1</span>
                    </div>
                    <div class="control-group">
                        <label for="pitch">পিচ:</label>
                        <input type="range" min="0" max="2" value="1" step="0.1" id="pitch">
                        <span id="pitch-value">1</span>
                    </div>
                </div>
                <div class="tts-buttons">
                    <button id="speakBtn" class="tts-button speak rounded-lg">লোড করুন</button>
                    <button id="resumeBtn" class="tts-button resume rounded-lg">শুনুন</button>
					<button id="pauseBtn" class="tts-button pause rounded-lg">থামান</button>
                    <button id="stopBtn" class="tts-button stop rounded-lg">শেষ করুন</button>
                    <button id="clearTtsBtn" class="tts-button clear-input rounded-lg">মুছুন</button> <!-- Added Clear button -->
					<button id="downloadTtsBtn" class="tts-button download rounded-lg" disabled>ডাউনলোড করুন</button>
                </div>
            </div>
        </div>

        <!-- নতুন: স্পিচ টু টেক্সট বিভাগ -->
<div id="speechToTextContent" class="calculator-content">
    <div class="stt-content">
        <h3 class="text-xl font-bold text-gray-700 mb-4">বাংলা স্পিচ টু টেক্সট (Gemini API)</h3>
        <div id="sttStatus" class="stt-status mb-4">অবস্থা: নিষ্ক্রিয়</div>
        <textarea id="sttOutput" rows="8" class="rounded-lg" placeholder="রেকর্ড করুন বা অডিও আপলোড করে কথাকে লেখায় রূপান্তর করুন..."></textarea>
        <!-- অডিও আপলোডের জন্য লুকানো ফাইল ইনপুট -->
        <input type="file" id="audioFileInput" class="hidden" accept="audio/*">
        <div class="stt-buttons mt-4">
            <button id="startSttBtn" data-state="record" class="stt-button start rounded-lg">রেকর্ড করুন</button>
            <button id="uploadAudioBtn" class="stt-button copy rounded-lg">আপলোড করুন</button>
            <button id="copySttBtn" class="stt-button copy rounded-lg">কপি করুন</button>
            <button id="clearSttBtn" class="stt-button clear-input rounded-lg">মুছুন</button>
        </div>
        <p class="mt-4 text-sm text-gray-500 dark:text-gray-400">দ্রষ্টব্য: রেকর্ডিং শেষ হলে 'পাঠান' বাটনে ক্লিক করে লেখাটি পেতে কিছুক্ষণ অপেক্ষা করুন।</p>
    </div>
</div>


<!-- টেক্সট অ্যাসিস্ট্যান্ট (চ্যাট) বিভাগ -->
<div id="textAssistantContent" class="calculator-content">
    <div class="text-assistant-content">
        <div class="chat-header">
            <h3>জেমিনির সাথে চ্যাট করুন</h3>
            <!-- এখান থেকে ড্রপডাউনটি সরানো হয়েছে -->
            <button id="clearChatBtn" class="clear-chat-button">চ্যাট মুছুন</button>
        </div>
        <div id="chatWindow" class="chat-window">
            <!-- চ্যাট বার্তা এখানে যুক্ত করা হবে -->
        </div>
        <div id="assistantLoading" class="loading-indicator">জেমিনি চিন্তা করছে...</div>
        <!-- ফাইল প্রিভিউ কন্টেইনার -->
        <div id="filePreviewContainer" class="hidden mb-2 p-2 border rounded-lg relative">
            <!-- প্রিভিউ এখানে JS দ্বারা যুক্ত করা হবে -->
        </div>
        <div class="input-container">
            <!-- ফাইল আপলোড বাটন -->
            <label for="fileUploadInput" class="flex items-center justify-center p-2.5 rounded-lg bg-gray-200 hover:bg-gray-300 cursor-pointer dark:bg-gray-600 dark:hover:bg-gray-500 transition-colors" title="ফাইল আপলোড করুন">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600 dark:text-gray-300"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
            </label>
            <input type="file" id="fileUploadInput" class="hidden" accept="image/png, image/jpeg, image/webp, text/*, audio/*, video/*">
            <textarea id="assistantInput" placeholder="এখানে আপনার প্রশ্ন লিখুন..."></textarea>
            <button id="askGeminiBtn" class="ask-button">পাঠান</button>
        </div>
    </div>
</div>
<!-- টেক্সট অ্যাসিস্ট্যান্ট (চ্যাট) বিভাগ শেষ -->

<!-- সকল ফিচার বিভাগ -->
<div id="allFeaturesContent" class="calculator-content">
    <div class="news-content !p-2 sm:!p-5"> <!-- মোবাইলে প্যাডিং কমানো হয়েছে -->
        <div id="featuresDisplayArea" class="news-display-area rounded-lg !p-3 sm:!p-5 mb-6">
            <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">এই অ্যাপের সকল ফিচার</h3>
            
            <!-- লম্বা তালিকার জন্য স্ক্রল এবং টেক্সট র‍্যাপিং ফিক্স -->
            <div class="overflow-y-auto max-h-[60vh] pr-1"> <!-- উচ্চতা সামান্য কমানো হলো যাতে নিচের সেকশন দেখা যায় -->
                <ul class="list-disc list-outside ml-4 sm:ml-6 text-left space-y-2 text-sm sm:text-base break-words">
                    <li class="mb-2">
                        <strong class="text-indigo-700 dark:text-indigo-400 hover:text-indigo-600 cursor-pointer transition-colors">সাধারণ ও সাইন্টিফিক ক্যালকুলেটর:</strong> মৌলিক এবং জটিল গাণিতিক গণনার সুবিধা। প্রতিটি গণনার জন্য জেমিনি দ্বারা সহজ ব্যাখ্যা পাওয়ার সুযোগ রয়েছে।
                    </li>
                    <li class="mb-2">
                        <strong class="text-indigo-700 dark:text-indigo-400 hover:text-indigo-600 cursor-pointer transition-colors">বয়স ও তারিখ ক্যালকুলেটর:</strong> সঠিক বয়স গণনা, নির্দিষ্ট বছর আগে বা পরের তারিখ অনুসন্ধান এবং গ্রেগরিয়ান, বাংলা ও হিজরি তারিখ দেখার সুবিধা।
                    </li>
                    <li class="mb-2">
                        <strong class="text-green-700 dark:text-green-400 hover:text-green-600 cursor-pointer transition-colors">পরিমাপ (ইউনিট কনভার্টার):</strong> দৈর্ঘ্য, ওজন, ক্ষেত্রফল, তাপমাত্রা এবং বিএমআই (BMI) সহজেই গণনা ও রূপান্তর করুন।
                    </li>
                     <li class="mb-2">
                        <strong class="text-green-700 dark:text-green-400 hover:text-green-600 cursor-pointer transition-colors">স্বাস্থ্য ও জীবনধারা:</strong> প্রেগন্যান্সি ডিউ ডেট, দৈনিক পানি পানের পরিমাণ এবং BMI হিসাব করুন।
                    </li>
                    <li class="mb-2">
                        <strong class="text-purple-700 dark:text-purple-400 hover:text-purple-600 cursor-pointer transition-colors">টাইপিং টেস্ট:</strong> বাংলা ও ইংরেজি অনুচ্ছেদ টাইপ করে আপনার টাইপিং স্পিড (WPM) এবং নির্ভুলতা পরীক্ষা করুন। সময়সীমা নির্ধারণ ও কাস্টম টেক্সট ব্যবহারের সুবিধাও রয়েছে।
                    </li>
                    <li class="mb-2">
                        <strong class="text-sky-700 dark:text-sky-400 hover:text-sky-600 cursor-pointer transition-colors">ফন্ট কনভার্টার:</strong> বিজয় কনভার্টার (Bijoy Converter)। ইউনিকোড ও বিজয় ফন্টের মধ্যে লেখা রূপান্তর করুন। এতে ভাঙা বিজয় লেখা ফিক্স করার বিশেষ সুবিধা এবং লাইভ কনভার্সন, আনডু/রিডু অপশন রয়েছে।
                    </li>
                     <li class="mb-2">
                        <strong class="text-lime-700 dark:text-lime-400 hover:text-lime-600 cursor-pointer transition-colors">ওয়ার্ড কাউন্টার:</strong> আপনার লেখার শব্দ, অক্ষর, বাক্য এবং অনুচ্ছেদ রিয়েল-টাইমে গণনা করুন।
                    </li>
                    <li class="mb-2">
                        <strong class="text-cyan-700 dark:text-cyan-400 hover:text-cyan-600 cursor-pointer transition-colors">ট্রান্সলেটর (জেমিনি):</strong> যেকোনো ভাষাকে সহজেই অন্য ভাষায় অনুবাদ করুন।
                    </li>
                    <li class="mb-2">
                        <strong class="text-pink-700 dark:text-pink-400 hover:text-pink-600 cursor-pointer transition-colors">লেখা সম্পর্কিত টুলস (জেমিনি):</strong>
                        <ul class="list-[circle] list-outside ml-4 mt-1 text-gray-700 dark:text-gray-400 space-y-1">
                            <li><strong>বানান সংশোধন:</strong> বাংলা লেখার বানান ও ব্যাকরণগত ভুল সংশোধন করুন।</li>
                            <li><strong>লেখা সাজানো:</strong> এলোমেলো বা জটিল লেখাকে সহজ ও সুন্দর ভাষায় গুছিয়ে নিন।</li>
                            <li><strong>শব্দের অর্থ:</strong> যেকোনো বাংলা বা ইংরেজি শব্দের বিস্তারিত অর্থ, প্রতিশব্দ ও ব্যাখ্যা খুঁজুন।</li>
                        </ul>
                    </li>
                    <li class="mb-2">
                        <strong class="text-amber-700 dark:text-amber-400 hover:text-amber-600 cursor-pointer transition-colors">স্পিচ টুলস:</strong>
                        <ul class="list-[circle] list-outside ml-4 mt-1 text-gray-700 dark:text-gray-400 space-y-1">
                            <li><strong>টেক্সট টু স্পিচ:</strong> আপনার লেখা টেক্সটকে বাংলা কণ্ঠে শুনুন এবং অডিও ফাইল ডাউনলোড করুন।</li>
                            <li><strong>স্পিচ টু টেক্সট (জেমিনি):</strong> আপনার কথাকে রিয়েল-টাইমে বাংলা বা ইংরেজি টেক্সটে রূপান্তর করুন। অডিও ফাইলও আপলোড করা যাবে।</li>
                            <li><strong>ভয়েস কমান্ড:</strong> মুখের কথায় অ্যাপ কন্ট্রোল করুন (যেমন: 'ক্যালকুলেটর', 'আবহাওয়া' বলুন)। এছাড়াও ইনপুট বক্সে ভয়েস টাইপিং সুবিধা।</li>
                        </ul>
                    </li>
                    <li class="mb-2">
                        <strong class="text-rose-700 dark:text-rose-400 hover:text-rose-600 cursor-pointer transition-colors">ছবি থেকে লেখা (OCR - জেমিনি):</strong> যেকোনো ছবি থেকে বাংলা ও ইংরেজি লেখা বের করুন।
                    </li>
                     <li class="mb-2">
                        <strong class="text-rose-700 dark:text-rose-400 hover:text-rose-600 cursor-pointer transition-colors">ছবি রিসাইজার:</strong> ছবি রিসাইজ করুন, কোয়ালিটি কমান/বাড়ান, ফরম্যাট পরিবর্তন করুন এবং ক্রপ করুন।
                    </li>
                     <li class="mb-2">
                        <strong class="text-violet-700 dark:text-violet-400 hover:text-violet-600 cursor-pointer transition-colors">টেক্সট অ্যাসিস্ট্যান্ট (জেমিনি):</strong> যেকোনো প্রশ্ন করুন, লেখা সারসংক্ষেপ করুন, এবং ছবিসহ বিভিন্ন ফাইল আপলোড করে চ্যাট করুন।
                    </li>
                    <li class="mb-2">
                        <strong class="text-blue-700 dark:text-blue-400 hover:text-blue-600 cursor-pointer transition-colors">ওয়েব সার্চ:</strong> অ্যাপের ভেতর থেকেই ব্রাউজিং করুন এবং প্রয়োজনীয় তথ্য খুঁজুন। সাথে রয়েছে জনপ্রিয় সাইটগুলোর কুইক লিংক। চাইলে আরও লিংক এখানে সংরক্ষণ করে রাখা যাবে।
                    </li>
                     <li class="mb-2">
                        <strong class="text-emerald-700 dark:text-emerald-400 hover:text-emerald-600 cursor-pointer transition-colors">গুগল ম্যাপ:</strong> ম্যাপে যেকোনো স্থান খুঁজুন, নিজের অবস্থান দেখুন এবং এক স্থান থেকে অন্য স্থানে যাওয়ার দিকনির্দেশনা (Directions) পান।
                    </li>
                    <li class="mb-2">
                        <strong class="text-orange-700 dark:text-orange-400 hover:text-orange-600 cursor-pointer transition-colors">আবহাওয়া:</strong> আপনার শহর বা যেকোনো স্থানের বর্তমান ও আগামী ৭ দিনের আবহাওয়ার পূর্বাভাস দেখুন।
                    </li>
                    <li class="mb-2">
                        <strong class="text-teal-700 dark:text-teal-400 hover:text-teal-600 cursor-pointer transition-colors">নামাজের সময়সূচি:</strong> আপনার জেলা অনুযায়ী নামাজের স্বয়ংক্রিয় সময়সূচি দেখুন এবং প্রয়োজনে ম্যানুয়ালি সময় সেট করার সুবিধাও রয়েছে।
                    </li>
                   
                    <li class="mb-2">
                        <strong class="text-teal-700 dark:text-teal-400 hover:text-teal-600 cursor-pointer transition-colors">দিবসসমূহ:</strong> বছরের গুরুত্বপূর্ণ জাতীয় ও আন্তর্জাতিক দিবসগুলো দেখুন।
                    </li>
                     <li class="mb-2">
                        <strong class="text-teal-700 dark:text-teal-400 hover:text-teal-600 cursor-pointer transition-colors">ছুটির তালিকা:</strong> বছরের সরকারি ছুটির তালিকা দেখুন (সাপ্তাহিক ও চাঁদ দেখার উপর নির্ভরশীল ছুটিসহ)।
                    </li>
                     <li class="mb-2">
                        <strong class="text-blue-700 dark:text-blue-400 hover:text-blue-600 cursor-pointer transition-colors">যাকাত ক্যালকুলেটর:</strong> সোনা, রুপা এবং অন্যান্য সম্পদের উপর ভিত্তি করে আপনার যাকাতের পরিমাণ সহজেই হিসাব করুন।
                    </li>
                    <li class="mb-2">
                        <strong class="text-cyan-700 dark:text-cyan-400 hover:text-cyan-600 cursor-pointer transition-colors">ডিজিটাল তাসবিহ:</strong> আধুনিক ডিজাইনের ডিজিটাল কাউন্টার, যেখানে একাধিক প্রোফাইল তৈরি করে আলাদাভাবে জিকির গণনা সেভ করে রাখা যায়। সাথে রয়েছে ভাইব্রেশন, আনডু, রিডু এবং ম্যানুয়ালি সংখ্যা সেট করার সুবিধা।
                    </li>
    
                    <li class="mb-2">
                        <strong class="text-fuchsia-700 dark:text-fuchsia-400 hover:text-fuchsia-600 cursor-pointer transition-colors">কিউআর কোড:</strong> যেকোনো টেক্সট বা লিঙ্ক থেকে QR কোড তৈরি করুন, ডাউনলোড করুন এবং ছবি থেকে QR কোড স্ক্যান করুন।
                    </li>
                     <li class="mb-2">
                        <strong class="text-purple-700 dark:text-purple-400 hover:text-purple-600 cursor-pointer transition-colors">রঙ বাছাইকারী:</strong> রঙ বাছাই করুন এবং HEX, RGB, HSL কোড দেখুন ও কপি করুন।
                    </li>
                     <li class="mb-2">
                        <strong class="text-red-700 dark:text-red-400 hover:text-red-600 cursor-pointer transition-colors">জরুরি নম্বর:</strong> জাতীয় এবং জেলাভিত্তিক সকল জরুরি সেবার নম্বর খুঁজুন, এডিট করুন এবং আপনার ডিভাইসে সেভ করে রাখুন।
                    </li>
                     <li class="mb-2">
                        <strong class="text-pink-700 dark:text-pink-400 hover:text-pink-600 cursor-pointer transition-colors">ইনভয়েজ:</strong> সহজে পেশাদার ইনভয়েজ তৈরি করুন, আইটেম যোগ করুন, ডিসকাউন্ট দিন এবং প্রিন্ট করুন। ইনভয়েজ সেভ করে রাখার সুবিধাও রয়েছে।
                    </li>
                    <li class="mb-2">
                        <strong class="text-cyan-700 dark:text-cyan-400 hover:text-cyan-600 cursor-pointer transition-colors">ঘড়ি:</strong> স্টপওয়াচ, অ্যালার্ম (কাস্টম সাউন্ডসহ) এবং বিশ্বের বিভিন্ন শহরের সময় দেখার সুবিধা।
                    </li>
                    <li class="mb-2">
                        <strong class="text-yellow-700 dark:text-yellow-400 hover:text-yellow-600 cursor-pointer transition-colors">প্লেয়ার:</strong> আপনার ডিভাইস থেকে সরাসরি অডিও, ভিডিও এবং ছবি প্লে করুন।
                    </li>
                    <li class="mb-2">
                         <strong class="text-gray-700 dark:text-gray-400 hover:text-gray-600 cursor-pointer transition-colors">নোটপ্যাড / টু-ডু লিস্ট:</strong> আপনার কাজ বা নোট যোগ করুন এবং ব্রাউজারেই সেভ করে রাখুন। এতে টেক্সট ফরম্যাটিং, ছবি যোগ করা, এবং কাজ ড্র্যাগ-ড্রপ করার সুবিধা রয়েছে।
                    </li>
                     <li class="mb-2">
                        <strong class="text-indigo-700 dark:text-indigo-400 hover:text-indigo-600 cursor-pointer transition-colors">কুইজ (জেমিনি):</strong> বিভিন্ন বিভাগ ও অসুবিধার স্তরে সাধারণ জ্ঞান কুইজ খেলুন।
                    </li>
                    <!-- নতুন যুক্ত করা ফিচারসমূহ -->
                    <li class="mb-2">
                        <strong class="text-blue-600 dark:text-blue-400 hover:text-blue-500 cursor-pointer transition-colors">মুদ্রা রূপান্তরকারী:</strong> রিয়েল-টাইম এক্সচেঞ্জ রেট সহ বিশ্বের বিভিন্ন দেশের মুদ্রা রূপান্তর করুন।
                    </li>
                    <li class="mb-2">
                        <strong class="text-teal-600 dark:text-teal-400 hover:text-teal-500 cursor-pointer transition-colors">দামের তুলনা:</strong> দুটি পণ্যের দাম ও পরিমাণ দিয়ে সহজেই বের করুন কোনটি কেনা লাভজনক।
                    </li>
                    <li class="mb-2">
                        <strong class="text-slate-700 dark:text-slate-400 hover:text-slate-600 cursor-pointer transition-colors">ডিফ চেকার (Diff):</strong> দুটি টেক্সট বা কোডের মধ্যে পার্থক্য তুলনা করুন এবং পরিবর্তনগুলো হাইলাইট আকারে দেখুন।
                    </li>
                     <li class="mb-2">
                        <strong class="text-teal-600 dark:text-teal-400 hover:text-teal-500 cursor-pointer transition-colors">আয়-ব্যয় হিসাব:</strong> আপনার দৈনন্দিন আয়ের ও ব্যয়ের হিসাব রাখুন, এডিট করুন এবং চার্ট দেখুন।
                    </li>
                    <li class="mb-2">
                        <strong class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-500 cursor-pointer transition-colors">ইএমআই ক্যালকুলেটর:</strong> ঋণের পরিমাণ, সুদের হার এবং মেয়াদ দিয়ে মাসিক কিস্তি এবং মোট সুদ হিসাব করুন।
                    </li>
                    <li class="mb-2">
                        <strong class="text-purple-600 dark:text-purple-400 hover:text-purple-500 cursor-pointer transition-colors">আইপি ও ডিভাইস ইনফো:</strong> আপনার বর্তমান আইপি এড্রেস, লোকেশন, আইএসপি এবং ডিভাইসের বিস্তারিত তথ্য দেখুন।
                    </li>
                    <li class="mb-2">
                        <strong class="text-orange-600 dark:text-orange-400 hover:text-orange-500 cursor-pointer transition-colors">রেসিপি জেনারেটর (জেমিনি):</strong> ঘরে থাকা উপকরণগুলোর নাম লিখুন এবং এআই এর মাধ্যমে মজাদার রান্নার রেসিপি পান।
                    </li>
                    <li class="mb-2">
                        <strong class="text-red-600 dark:text-red-400 hover:text-red-500 cursor-pointer transition-colors">পিডিএফ টুলস:</strong> একাধিক ছবি আপলোড করে ড্র্যাগ-ড্রপ করে সাজিয়ে পিডিএফ তৈরি ও ডাউনলোড করুন।
                    </li>
                    <li class="mb-2">
                        <strong class="text-red-500 dark:text-red-400 hover:text-red-600 cursor-pointer transition-colors">স্ক্রিন রেকর্ডার:</strong> অডিও সহ বা ছাড়া আপনার স্ক্রিন রেকর্ড করুন এবং ভিডিও ডাউনলোড করুন।
                    </li>
                    <li class="mb-2">
                        <strong class="text-yellow-600 dark:text-yellow-400 hover:text-yellow-500 cursor-pointer transition-colors">জেসন ফর্মাটার:</strong> অগোছালো JSON কোড সুন্দরভাবে সাজান (Beautify), মিনিফাই করুন এবং ভুল থাকলে তা যাচাই করুন।
                    </li>
                    <li class="mb-2">
                        <strong class="text-pink-600 dark:text-pink-400 hover:text-pink-500 cursor-pointer transition-colors">মিম জেনারেটর:</strong> ছবি আপলোড করে টেক্সট বসিয়ে সহজেই মজার মিম তৈরি করুন।
                    </li>
                    <li class="mb-2">
                        <strong class="text-green-600 dark:text-green-400 hover:text-green-500 cursor-pointer transition-colors">ইন্টারনেট স্পিড:</strong> আপনার ইন্টারনেটের ডাউনলোড, আপলোড স্পিড এবং পিং টেস্ট করুন।
                    </li>
                    <li class="mb-2">
                        <strong class="text-slate-700 dark:text-slate-400 hover:text-slate-600 cursor-pointer transition-colors">বারকোড জেনারেটর:</strong> টেক্সট বা নম্বর দিয়ে সহজেই বিভিন্ন ফরম্যাটের বারকোড তৈরি করুন, কালার কাস্টমাইজ করুন এবং ডাউনলোড করুন।
                    </li>
                    <li class="mb-2">
                        <strong class="text-fuchsia-700 dark:text-fuchsia-400 hover:text-fuchsia-600 cursor-pointer transition-colors">র‍্যান্ডম পিকার / লটারি:</strong> লটারি, গিভঅ্যাওয়ে বা র‍াফেল ড্র-এর জন্য নামের তালিকা থেকে অটোমেটিক ও নিরপেক্ষভাবে বিজয়ী নির্বাচন করুন।
                    </li>
                    <li class="mb-2">
                        <strong class="text-gray-700 dark:text-gray-400 hover:text-gray-600 cursor-pointer transition-colors">টেক্সট এনক্রিপশন:</strong> আপনার গোপন তথ্য বা মেসেজ পাসওয়ার্ড দিয়ে লক (এনক্রিপ্ট) এবং আনলক (ডিক্রিপ্ট) করুন।
                    </li>
                    <li class="mb-2">
                        <strong class="text-blue-600 dark:text-blue-400 hover:text-blue-500 cursor-pointer transition-colors">অন্যান্য সুবিধাসমূহ:</strong>
                        <ul class="list-[circle] list-outside ml-4 mt-1 text-gray-700 dark:text-gray-400 space-y-1">
                            <li><strong>সাইডবার মেনু:</strong> বাম পাশের মেনু থেকে যেকোনো ফিচার সহজে খুঁজে বের করুন এবং সার্চ করুন।</li>
                            <li><strong>অ্যাপ ইন্সটল (PWA):</strong> এই টুলবক্সটি অ্যাপ হিসেবে ইন্সটল করে অফলাইনে ব্যবহারের সুবিধা।</li>
                            <li><strong>সেটিংস:</strong> জেমিনি মডেল, এপিআই কী, গুগল সার্চ, তারিখ আপডেট এবং এনিমেশন কাস্টমাইজ করুন।</li>
                            <li><strong>এপিআই কী:</strong> জেমিনি এআই ফিচারগুলো (চ্যাট, অনুবাদ, ওসিআর ইত্যাদি) ব্যবহার করতে আপনার নিজস্ব এপিআই কী সেট করুন।</li>
                            <li><strong>ডার্ক ও লাইট মোড:</strong> চোখের আরামের জন্য অ্যাপের থিম পরিবর্তন করুন।</li>
                        </ul>
                    </li>
                    <li class="mb-2">
                        <strong class="text-lime-700 dark:text-lime-400 hover:text-lime-600 cursor-pointer transition-colors">ডোনেট:</strong> বাংলা টুলবক্সের উন্নয়নে সহায়তা করুন।
                    </li>
                    <li class="mb-2"><strong class="text-violet-700 dark:text-violet-400 hover:text-violet-600 cursor-pointer transition-colors">ডেভেলোপার প্রোফাইল: </strong>প্রয়োজনীয় বিভিন্ন লিংক পেতে এবং ডেভেলোপার এর প্রোফাইল 👉 <a href="https://bio.link/mdsifatbiolink" target="_blank" class="text-blue-600 hover:underline">bio.link/mdsifatbiolink</a></li>
                </ul>
            </div>
        </div>

        <!-- কীবোর্ড শর্টকাট সেকশন (নতুন যোগ করা) -->
        <div id="shortcutsSection"> <!-- Removed 'calculator-content' class -->
            <div class="days-observances-container">
                <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-6 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="text-indigo-600 dark:text-indigo-400">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                    </svg>
                    কীবোর্ড শর্টকাট তালিকা
                </h3>
                
                <p class="text-center text-gray-600 dark:text-gray-400 mb-8">দ্রুত কাজ করার জন্য নিচের শর্টকাটগুলো ব্যবহার করুন। (Mac ব্যবহারকারীরা Alt এর পরিবর্তে Option কী ব্যবহার করতে পারেন)</p>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 text-left">
                    
                    <!-- নেভিগেশন ও গ্লোবাল -->
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md border-l-4 border-blue-500 hover:shadow-lg transition-shadow">
                        <h4 class="text-lg font-bold text-blue-600 dark:text-blue-400 mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path></svg>
                            নেভিগেশন ও কন্ট্রোল
                        </h4>
                        <ul class="space-y-3 text-sm text-gray-700 dark:text-gray-300">
                            <li class="flex justify-between items-center"><span>পরবর্তী ট্যাব</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Ctrl + Right ➡</kbd></li>
                            <li class="flex justify-between items-center"><span>পূর্ববর্তী ট্যাব</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Ctrl + Left ⬅</kbd></li>
                            <li class="flex justify-between items-center"><span>ইনপুট ফোকাস</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Ctrl + Down ⬇</kbd></li>
                            <li class="flex justify-between items-center"><span>ফোকাস সরান</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Ctrl + Up ⬆</kbd></li>
                            <li class="flex justify-between items-center"><span>সাইডবার মেনু</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + X</kbd></li>
                            <li class="flex justify-between items-center"><span>থিম পরিবর্তন (Dark/Light)</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + L</kbd></li>
                            <li class="flex justify-between items-center"><span>ভয়েস কমান্ড</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + V</kbd></li>
                        </ul>
                    </div>

                    <!-- এডিটিং টুলস -->
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md border-l-4 border-green-500 hover:shadow-lg transition-shadow">
                        <h4 class="text-lg font-bold text-green-600 dark:text-green-400 mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                            এডিটিং ও লেখালেখি
                        </h4>
                        <ul class="space-y-3 text-sm text-gray-700 dark:text-gray-300">
                            <li class="flex justify-between items-center"><span>নোটপ্যাড</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + N</kbd></li>
                            <li class="flex justify-between items-center"><span>ফন্ট কনভার্টার</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + B</kbd></li>
                            <li class="flex justify-between items-center"><span>টেক্সট অ্যাসিস্ট্যান্ট (AI)</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + A</kbd></li>
                            <li class="flex justify-between items-center"><span>ট্রান্সলেটর</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + T</kbd></li>
                            <li class="flex justify-between items-center"><span>টাইপিং টেস্ট</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + Y</kbd></li>
                            <li class="flex justify-between items-center"><span>বোল্ড (নোটপ্যাড)</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Ctrl + B</kbd></li>
                            <li class="flex justify-between items-center"><span>ইটালিক (নোটপ্যাড)</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Ctrl + I</kbd></li>
                        </ul>
                    </div>

                    <!-- ইউটিলিটি টুলস -->
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md border-l-4 border-purple-500 hover:shadow-lg transition-shadow">
                        <h4 class="text-lg font-bold text-purple-600 dark:text-purple-400 mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                            ইউটিলিটি ও গণনা
                        </h4>
                        <ul class="space-y-3 text-sm text-gray-700 dark:text-gray-300">
                            <li class="flex justify-between items-center"><span>সাধারণ ক্যালকুলেটর</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + C</kbd></li>
                            <li class="flex justify-between items-center"><span>সাইন্টিফিক ক্যালকুলেটর</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + S</kbd></li>
                            <li class="flex justify-between items-center"><span>আয়-ব্যয় হিসাব</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + E</kbd></li>
                            <li class="flex justify-between items-center"><span>ইনভয়েজ</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + I</kbd></li>
                            <li class="flex justify-between items-center"><span>যাকাত ক্যালকুলেটর</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + Z</kbd></li>
                            <li class="flex justify-between items-center"><span>ঘড়ি ও অ্যালার্ম</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + O</kbd></li>
                            <li class="flex justify-between items-center"><span>কিউআর কোড</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + Q</kbd></li>
                        </ul>
                    </div>

                    <!-- মিডিয়া ও অন্যান্য -->
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md border-l-4 border-orange-500 hover:shadow-lg transition-shadow">
                        <h4 class="text-lg font-bold text-orange-600 dark:text-orange-400 mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            মিডিয়া ও অন্যান্য
                        </h4>
                        <ul class="space-y-3 text-sm text-gray-700 dark:text-gray-300">
                            <li class="flex justify-between items-center"><span>মিডিয়া প্লেয়ার</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + P</kbd></li>
                            <li class="flex justify-between items-center"><span>ছবি রিসাইজার</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + R</kbd></li>
                            <li class="flex justify-between items-center"><span>ওয়েব সার্চ</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + G</kbd></li>
                            <li class="flex justify-between items-center"><span>আবহাওয়া</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + W</kbd></li>
                            <li class="flex justify-between items-center"><span>গুগল ম্যাপ</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + M</kbd></li>
                            <li class="flex justify-between items-center"><span>ইতিহাস</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + H</kbd></li>
                        </ul>
                    </div>

                    <!-- সেটিংস ও মেনু -->
                    <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md border-l-4 border-gray-500 hover:shadow-lg transition-shadow md:col-span-2 lg:col-span-1">
                        <h4 class="text-lg font-bold text-gray-600 dark:text-gray-300 mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            সেটিংস ও মেনু
                        </h4>
                        <ul class="space-y-3 text-sm text-gray-700 dark:text-gray-300">
                            <li class="flex justify-between items-center"><span>ড্যাশবোর্ড</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + D</kbd></li>
                            <li class="flex justify-between items-center"><span>সেটিংস মেনু</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + U</kbd></li>
                            <li class="flex justify-between items-center"><span>সকল ফিচার (আরও)</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + F</kbd></li>
                            <li class="flex justify-between items-center"><span>গুরুত্বপূর্ণ লিংক</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + K</kbd></li>
                            <li class="flex justify-between items-center"><span>ডোনেট</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + J</kbd></li>
                            <li class="flex justify-between items-center"><span>মোর মেনু (ড্রপডাউন)</span> <kbd class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded border border-gray-300 dark:border-gray-600 font-mono text-xs">Alt + .</kbd></li>
                        </ul>
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>
<!-- শেষ: সকল ফিচার ট্যাব -->


		
<!-- নতুন: গুগল ম্যাপ বিভাগ -->
<div id="mapContent" class="calculator-content">
    <div class="map-container">
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">গুগল ম্যাপ - বাংলাদেশ</h3>
        <iframe
            src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3746118.913102029!2d88.10075841566833!3d23.49058226042993!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x30adaaed80e18ba7%3A0xf2d28e0c4e1fc6b!2sBangladesh!5e0!3m2!1sen!2sbd!4v1675346780000!5m2!1sen!2sbd"
            width="100%"
            height="450"
            style="border:0;"
            allowfullscreen=""
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade">
			
        </iframe>
		<!-- এই কোডটি mapContent div-এর ভেতরের iframe ট্যাগের পরে যোগ করুন -->
		<div class="map-features mt-4 p-4 bg-white dark:bg-gray-700 rounded-lg shadow-inner">
    <!-- স্থান খুঁজুন -->
    <div class="feature-section mb-4">
        <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">স্থান খুঁজুন (Search Location)</h4>
        <div class="flex flex-col sm:flex-row gap-2">
            <input type="text" id="searchInput" placeholder="যেমন: ঢাকা বিশ্ববিদ্যালয়" class="flex-grow p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white focus:ring-2 focus:ring-blue-500">
            <button id="searchBtn" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition-colors">খুঁজুন</button>
        </div>
    </div>

    <!-- আমার অবস্থান -->
    <div class="feature-section mb-4">
        <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">আমার অবস্থান (My Location)</h4>
        <button id="myLocationBtn" class="w-full px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition-colors">আমার বর্তমান অবস্থান দেখুন</button>
    </div>

					<!-- দিকনির্দেশনা -->
			<div class="feature-section">
				<h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">দিকনির্দেশনা (Directions)</h4>
				<div class="flex flex-col sm:flex-row gap-2">
				<input type="text" id="directionsFrom" placeholder="শুরুর স্থান (From)" class="flex-grow p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white focus:ring-2 focus:ring-purple-500">
				<input type="text" id="directionsTo" placeholder="গন্তব্য স্থান (To)" class="flex-grow p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white focus:ring-2 focus:ring-purple-500">
				</div>
				<button id="directionsBtn" class="w-full mt-2 px-4 py-2 bg-purple-500 text-white font-semibold rounded-lg hover:bg-purple-600 transition-colors">দিকনির্দেশনা দেখুন</button>
			</div>
		</div>
	</div>
</div>

<!-- নতুন: ওয়েব সার্চ বিভাগ -->
<div id="webSearchContent" class="calculator-content">
    <div class="web-browser-content">
        <!-- ব্রাউজার টুলবার -->
        <div class="browser-toolbar">
            <!-- হোম বাটন -->
            <button id="browserHomeBtn" class="browser-btn" title="হোম">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            </button>
            
            <!-- অ্যাড্রেস বার -->
            <input type="text" id="browserAddress" class="address-bar" placeholder="সার্চ করুন বা ইউআরএল লিখুন">
            
            <!-- গো বাটন -->
            <button id="browserGoBtn" class="browser-btn" title="এখানেই খুঁজুন">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </button>

            <!-- ব্রাউজারে খুলুন বাটন -->
            <button id="browserOpenExternalBtn" class="browser-btn" style="background-color: #ef4444;" title="বাইরে খুলুন (নতুন ট্যাবে)">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"></path></svg>
            </button>
        </div>

        <!-- কুইক লিংকস -->
        <div id="shortcutsContainer" class="flex flex-wrap justify-center gap-2 mb-2">
		
			<!-- WhatsApp -->
            <button onclick="window.open('https://web.whatsapp.com', '_blank')" class="px-3 py-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-full text-sm font-semibold hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors text-green-500 flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg> WhatsApp
            </button>
			
		    <!-- Gmail -->
            <button onclick="window.open('https://mail.google.com', '_blank')" class="px-3 py-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-full text-sm font-semibold hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors text-red-500 flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414.05 3.555ZM0 4.697v7.104l5.803-3.558L0 4.697ZM6.761 8.83l-6.57 4.027A2 2 0 0 0 2 14h12a2 2 0 0 0 1.808-1.144l-6.57-4.027L8 9.586l-1.239-.757Zm3.436-.586L16 11.801V4.697l-5.803 3.546Z"/></svg> Gmail
            </button>
			
            <!-- Google -->
            <button onclick="window.open('https://google.com', '_blank')" class="px-3 py-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-full text-sm font-semibold hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors flex items-center gap-1">
                <span class="text-blue-500">G</span><span class="text-red-500">o</span><span class="text-yellow-500">o</span><span class="text-blue-500">g</span><span class="text-green-500">l</span><span class="text-red-500">e</span>
            </button>
            
            <!-- YouTube -->
            <button onclick="window.open('https://youtube.com', '_blank')" class="px-3 py-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-full text-sm font-semibold hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors flex items-center gap-1 text-red-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8.051 1.999h.089c.822.003 4.987.033 6.11.335a2.01 2.01 0 0 1 1.415 1.42c.101.38.172.883.22 1.402l.01.104.022.26.008.104c.065.914.073 1.77.074 1.957v.075c-.001.194-.01 1.108-.082 2.06l-.008.105-.009.104c-.05.572-.124 1.14-.235 1.558a2.007 2.007 0 0 1-1.415 1.42c-1.16.312-5.569.334-6.18.335h-.142c-.309 0-1.587-.006-2.927-.052l-.17-.006-.087-.004-.171-.007-.171-.007c-1.11-.049-2.167-.128-2.654-.26a2.007 2.007 0 0 1-1.415-1.419c-.111-.417-.185-.986-.235-1.558L.09 9.82l-.008.104A31.4 31.4 0 0 1 0 7.68v-.123c.002-.215.01-.958.064-1.778l.007-.103.003-.052.008-.104.022-.26.01-.104c.048-.519.119-1.023.22-1.402a2.007 2.007 0 0 1 1.415-1.42c.487-.13 1.544-.21 2.654-.26l.17-.007.172-.006.086-.003.171-.007A99.788 99.788 0 0 1 7.858 2h.193zM6.4 5.209v4.818l4.157-2.408L6.4 5.209z"/></svg> YouTube
            </button>
		
            <!-- Facebook -->
            <button onclick="window.open('https://facebook.com', '_blank')" class="px-3 py-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-full text-sm font-semibold hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors text-blue-600">Facebook</button>


            <!-- ChatGPT -->
            <button onclick="window.open('https://chatgpt.com', '_blank')" class="px-3 py-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-full text-sm font-semibold hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors text-emerald-600">ChatGPT</button>
            
            <!-- Gemini -->
            <button onclick="window.open('https://gemini.google.com', '_blank')" class="px-3 py-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-full text-sm font-semibold hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors text-blue-600 flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0a1 1 0 0 1 1 1v5.5a1 1 0 0 0 .5.5H15a1 1 0 0 1 1 1v.5a1 1 0 0 1-1 1h-5.5a1 1 0 0 0-.5.5V15a1 1 0 0 1-1 1h-.5a1 1 0 0 1-1-1v-5.5a1 1 0 0 0-.5-.5H1a1 1 0 0 1-1-1v-.5a1 1 0 0 1 1-1h5.5a1 1 0 0 0 .5-.5V1a1 1 0 0 1 1-1h.5z"/></svg> Gemini
            </button>
            
            <!-- Add Shortcut Button -->
            <button id="addShortcutBtn" class="px-3 py-1 bg-gray-200 dark:bg-gray-600 border border-gray-300 dark:border-gray-500 rounded-full text-sm font-bold hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors text-gray-700 dark:text-gray-200 flex items-center gap-1" title="নতুন শর্টকাট যুক্ত করুন">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2z"/></svg>
            </button>
        </div>
        
        <!-- আইফ্রেম -->
        <!-- পরিবর্তন: sandbox থেকে allow-popups সরানো হয়েছে যাতে নতুন ট্যাব ওপেন করা ব্লক হয়, এবং গুগল ব্যবহার করা হচ্ছে যা আইফ্রেমে কাজ করে -->
        <iframe id="browserFrame" class="browser-frame" src="" sandbox="allow-scripts allow-same-origin allow-forms allow-presentation"></iframe>
        <p class="text-xs text-gray-500 mt-1 text-center">নোট: আইফ্রেমের ভেতরে লিংক ওপেন রাখতে এখানে গুগল সার্চ ব্যবহার করা হয়েছে। অনেক ওয়েবসাইট (যেমন: ফেসবুক, ইউটিউব) আইফ্রেমে লোড হতে দেয় না, সেগুলো লাল বাটনে ক্লিক করে খুলুন।</p>
    </div>
</div>

<!-- নতুন: নামাজের সময়সূচি বিভাগ -->
<div id="prayerTimeContent" class="calculator-content">
    <div class="prayer-time-content">
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">নামাজের সময়সূচি</h3>
        <p id="prayerTimeDate" class="text-md font-semibold text-gray-600 dark:text-gray-300 mb-4"></p>
        
        <div class="district-selector-wrapper mb-6">
            <label for="district-select" class="block text-left mb-2 font-semibold text-gray-700 dark:text-gray-200">আপনার জেলা নির্বাচন করুন:</label>
            <select id="district-select" class="w-full p-3 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white focus:ring-2 focus:ring-blue-500 transition-all"></select>
        </div>


<!-- prayerTimeContent div এর মধ্যে, district-selector-wrapper এর নিচে যোগ করুন -->
<div class="manual-time-control-wrapper mb-6 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-inner">
    <div class="flex items-center justify-between mb-4">
        <label for="manualTimeToggle" class="font-semibold text-gray-700 dark:text-gray-200">ম্যানুয়াল সময় সেট করুন:</label>
        <label class="switch">
            <input type="checkbox" id="manualTimeToggle">
            <span class="slider round"></span>
        </label>
    </div>
    <div id="manualTimeInputs" class="hidden grid grid-cols-2 sm:grid-cols-3 gap-4">
        <div>
            <label for="manualSehri" class="block text-sm font-medium text-gray-600 dark:text-gray-300">সাহরি:</label>
            <input type="time" id="manualSehri" value="04:00" class="w-full p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white">
        </div>
        <div>
            <label for="manualFajr" class="block text-sm font-medium text-gray-600 dark:text-gray-300">ফজর:</label>
            <input type="time" id="manualFajr" value="04:10" class="w-full p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white">
        </div>
        <div>
            <label for="manualDhuhr" class="block text-sm font-medium text-gray-600 dark:text-gray-300">যোহর:</label>
            <input type="time" id="manualDhuhr" value="12:00" class="w-full p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white">
        </div>
        <div>
            <label for="manualAsr" class="block text-sm font-medium text-gray-600 dark:text-gray-300">আসর:</label>
            <input type="time" id="manualAsr" value="16:30" class="w-full p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white">
        </div>
        <div>
            <label for="manualIftar" class="block text-sm font-medium text-gray-600 dark:text-gray-300">ইফতার ও মাগরিব:</label>
            <input type="time" id="manualIftar" value="18:45" class="w-full p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white">
        </div>
        <div>
            <label for="manualIsha" class="block text-sm font-medium text-gray-600 dark:text-gray-300">ইশা:</label>
            <input type="time" id="manualIsha" value="20:00" class="w-full p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white">
        </div>
    </div>
</div>


        <div id="prayer-times-display" class="prayer-times-grid">
            <div class="prayer-time-card">
                <h4>সাহরি</h4>
                <p id="sehri-time">--:--</p>
            </div>
            <div class="prayer-time-card">
                <h4>ফজর</h4>
                <p id="fajr-time">--:--</p>
            </div>
            <div class="prayer-time-card">
                <h4>যোহর</h4>
                <p id="dhuhr-time">--:--</p>
            </div>
            <div class="prayer-time-card">
                <h4>আসর</h4>
                <p id="asr-time">--:--</p>
            </div>
            <div class="prayer-time-card">
                <h4>ইফতার ও মাগরিব</h4>
                <p id="iftar-time">--:--</p>
            </div>
            <div class="prayer-time-card">
                <h4>ইশা</h4>
                <p id="isha-time">--:--</p>
            </div>
        </div>
        <!-- আপডেট করা দ্রষ্টব্য -->
        <p class="mt-4 text-sm text-gray-500 dark:text-gray-400">দ্রষ্টব্য: সময়সূচি aladhan.com API থেকে আনা হয়েছে (হিসাব পদ্ধতি: University of Islamic Sciences, Karachi)। এটি ইসলামিক ফাউন্ডেশনের সময়ের সাথে কিছুটা ভিন্ন হতে পারে।</p>
    </div>
</div>

<!-- নতুন: ছবি থেকে লেখা (OCR) বিভাগ -->
<div id="imageToTextContent" class="calculator-content">
    <div class="image-to-text-content">
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">ছবি থেকে লেখা বের করুন (OCR)</h3>
        <div class="image-upload-area">
            <label for="ocrImageInput" class="image-upload-label">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-12 h-12 mb-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                <span>একটি ছবি নির্বাচন করুন</span>
            </label>
            <input type="file" id="ocrImageInput" accept="image/png, image/jpeg, image/webp" class="hidden">
        </div>
        <div id="ocrImagePreview" class="image-preview hidden"></div>
        <div class="flex gap-4 mt-4">
            <button id="extractTextBtn" class="extract-text-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L14.5 9.5L22 12L14.5 14.5L12 22L9.5 14.5L2 12L9.5 9.5L12 2Z"/></svg>
                <span>লেখা বের করুন</span>
            </button>
        </div>
        <div id="ocrLoading" class="loading-indicator mt-4" style="display: none;">ছবি থেকে লেখা বের করা হচ্ছে...</div>
        <div class="result-area mt-4">
            <div class="flex justify-between items-center mb-2">
                <p class="result-section-title" style="text-align: left; margin: 0;">বের করা লেখা</p>
                <button id="copyOcrTextBtn" class="font-copy-button rounded-lg">কপি করুন</button>
            </div>
            <textarea id="ocrResultText" rows="10" placeholder="এখানে লেখা দেখা যাবে..."></textarea>
        </div>
        <button id="clearOcrBtn" class="font-clear-button rounded-lg mt-4 w-full">সব মুছে ফেলুন</button>
    </div>
</div>
<!-- নতুন: ওয়ার্ড কাউন্টার বিভাগ -->
<div id="wordCounterContent" class="calculator-content">
    <div class="word-counter-content">
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">ওয়ার্ড ও ক্যারেক্টার কাউন্টার</h3>
        <p class="text-gray-600 dark:text-gray-400 mb-4">নিচের টেক্সটবক্সে আপনার লেখা পেস্ট করুন অথবা টাইপ করুন। ফলাফল রিয়েল-টাইমে আপডেট হবে।</p>
        <textarea id="wordCounterInput" rows="10" class="w-full p-3 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white focus:ring-2 focus:ring-blue-500 transition-all" placeholder="এখানে আপনার লেখা পেস্ট করুন অথবা টাইপ করুন..."></textarea>
        <div id="wordCounterStats" class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
            <div class="p-4 bg-blue-100 dark:bg-blue-900 rounded-lg shadow">
                <h4 class="text-lg font-semibold text-blue-800 dark:text-blue-200">শব্দ</h4>
                <p id="wordCount" class="text-2xl font-bold text-blue-600 dark:text-blue-300">0</p>
            </div>
            <div class="p-4 bg-green-100 dark:bg-green-900 rounded-lg shadow">
                <h4 class="text-lg font-semibold text-green-800 dark:text-green-200">অক্ষর</h4>
                <p id="charCount" class="text-2xl font-bold text-green-600 dark:text-green-300">0</p>
            </div>
            <div class="p-4 bg-purple-100 dark:bg-purple-900 rounded-lg shadow">
                <h4 class="text-lg font-semibold text-purple-800 dark:text-purple-200">বাক্য</h4>
                <p id="sentenceCount" class="text-2xl font-bold text-purple-600 dark:text-purple-300">0</p>
            </div>
            <div class="p-4 bg-yellow-100 dark:bg-yellow-900 rounded-lg shadow">
                <h4 class="text-lg font-semibold text-yellow-800 dark:text-yellow-200">অনুচ্ছেদ</h4>
                <p id="paragraphCount" class="text-2xl font-bold text-yellow-600 dark:text-yellow-300">0</p>
            </div>
        </div>
    </div>
</div>

<!-- নতুন: আবহাওয়া বিভাগ -->
<div id="weatherContent" class="calculator-content">
    <div class="weather-content">
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">আবহাওয়ার পূর্বাভাস</h3>
        <div class="weather-search-box">
            <input type="text" id="cityInput" placeholder="আপনার শহরের নাম লিখুন..." class="city-input">
            <button id="searchWeatherBtn" class="search-weather-button">খুঁজুন</button>
        </div>
        <div id="weatherResult" class="weather-result-area">
            <!-- আবহাওয়ার তথ্য এখানে দেখানো হবে -->
            <p>একটি শহরের নাম লিখে 'খুঁজুন' বাটনে ক্লিক করুন।</p>
        </div>
        <div id="weatherLoading" class="loading-indicator mt-4" style="display: none;">আবহাওয়ার তথ্য আনা হচ্ছে...</div>
    </div>
<!-- আবহাওয়া সেকশন শুরু -->
<section id="weather-section" class="bg-gray-800 p-8 rounded-xl shadow-lg mt-8 hidden">
    <div class="text-center mb-6">
        <h2 class="text-3xl font-bold text-white mb-2">আবহাওয়ার পূর্বাভাস</h2>
        <div class="flex flex-col sm:flex-row items-center justify-center gap-2 mb-4">
            <input type="text" id="location-search-input" placeholder="শহর বা জেলার নাম লিখুন..." class="p-2 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-80">
            <button id="search-weather-button" class="bg-blue-600 text-white p-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors w-full sm:w-auto">
                অনুসন্ধান করুন
            </button>
        </div>
        <p class="text-gray-400 text-lg" id="location-name"></p>
    </div>
    <div id="forecast-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-8 gap-4">
        <!-- এখানে প্রতিটি দিনের আবহাওয়ার কার্ডগুলো JavaScript দ্বারা যুক্ত হবে -->
    </div>
</section>
<!-- আবহাওয়া সেকশন শেষ -->
</div>

<!-- নতুন: নোটপ্যাড / টু-ডু লিস্ট বিভাগ (ফরম্যাটিং বার সহ) -->
<div id="notepadContent" class="calculator-content">
    <div class="notepad-container relative"> <!-- Toolbar-এর পজিশনের জন্য relative ক্লাস যুক্ত করা হয়েছে -->
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">নোটপ্যাড / টু-ডু লিস্ট</h3>
		<div class="notepad-controls flex flex-wrap justify-between items-center gap-4 mb-4 p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
            <!-- Find Feature -->
            <div class="find-feature flex items-center gap-2">
                <input type="text" id="notepadFindInput" placeholder="নোটে খুঁজুন..." class="p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white text-sm">
                <button id="notepadFindBtn" class="px-3 py-2 bg-blue-500 text-white text-sm font-semibold rounded-lg hover:bg-blue-600">খুঁজুন</button>
            </div>
            <!-- Export Feature -->
            <div class="export-feature flex items-center gap-2">
                <button id="exportTxtBtn" class="px-3 py-2 bg-green-500 text-white text-sm font-semibold rounded-lg hover:bg-green-600">.txt এক্সপোর্ট</button>
                <button id="exportHtmlBtn" class="px-3 py-2 bg-purple-500 text-white text-sm font-semibold rounded-lg hover:bg-purple-600">.html এক্সপোর্ট</button>
            </div>
        </div>
        <p class="text-gray-600 dark:text-gray-400 mb-4">আপনার কাজ বা নোট যোগ করুন। ব্রাউজার বন্ধ করলেও আপনার ডেটা সেভ থাকবে। ছবিও পেস্ট করে যুক্ত করা যাবে।</p>
        
        <!-- ফরম্যাটিং অ্যাকশন বার -->
        <div id="notepadActionToolbar" class="notepad-action-toolbar flex items-center">
            <button class="toolbar-btn" data-command="bold" title="বোল্ড (Ctrl+B)"><b>B</b></button>
            <button class="toolbar-btn" data-command="italic" title="ইটালিক (Ctrl+I)"><i>I</i></button>
            <button class="toolbar-btn" data-command="underline" title="আন্ডারলাইন (Ctrl+U)"><u>U</u></button>
            <button class="toolbar-btn" data-command="strikeThrough" title="স্ট্রাইকথ্রু"><s>S</s></button>
            
            <!-- ফন্ট সাইজ বাটন -->
            <button class="toolbar-btn" data-command="increaseFontSize" title="ফন্ট বড় করুন">A+</button>
            <button class="toolbar-btn" data-command="decreaseFontSize" title="ফন্ট ছোট করুন">A-</button>

            <!-- নতুন: টেক্সট কালার পিকার -->
            <div class="toolbar-btn relative flex items-center justify-center cursor-pointer" title="লেখার রঙ">
                <span style="font-weight:bold; font-family:serif; position: relative; top: -2px;">A</span>
                <span style="position:absolute; bottom:4px; left:4px; right:4px; height:3px; background:red; border-radius:1px;"></span>
                <input type="color" data-command="foreColor" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" style="padding:0; border:none;">
            </div>

            <!-- নতুন: হাইলাইট কালার পিকার -->
            <div class="toolbar-btn relative flex items-center justify-center cursor-pointer" title="হাইলাইট কালার">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M16.56 3.44L19.14 6.02C19.4526 6.33266 19.6282 6.75674 19.6282 7.19902C19.6282 7.64131 19.4526 8.06539 19.14 8.37805L18.56 8.96L14.08 4.48L14.66 3.9C14.9708 3.5859 15.3946 3.40918 15.837 3.40918C16.1139 3.40794 16.3887 3.46131 16.646 3.56631L16.56 3.44ZM12.66 5.9L17.14 10.38L7.94 19.5H3.5V15.06L12.66 5.9ZM2 21.5H21V23.5H2V21.5Z"></path></svg>
                <input type="color" data-command="hiliteColor" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" style="padding:0; border:none;">
            </div>

            <button class="toolbar-btn" data-command="justifyLeft" title="বামে অ্যালাইন">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3V4zm0 14h12v2H3v-2zm0-7h18v2H3v-2z"></path></svg>
            </button>
            <button class="toolbar-btn" data-command="justifyCenter" title="মাঝে অ্যালাইন">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3V4zm3 14h12v2H6v-2zm-3-7h18v2H3v-2z"></path></svg>
            </button>
            <button class="toolbar-btn" data-command="justifyRight" title="ডানে অ্যালাইন">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3V4zm9 14h9v2h-9v-2zm-9-7h18v2H3v-2z"></path></svg>
            </button>
            <button class="toolbar-btn" data-command="justifyFull" title="জাস্টিফাই">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4h18v2H3V4zm0 14h18v2H3v-2zm0-7h18v2H3v-2z"></path></svg>
            </button>
<button class="toolbar-btn" data-command="removeFormat" title="ফরম্যাটিং মুছুন">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
        <path d="M9.134 11.634 6.866 4.366l1.23-.41L10.366 11.225zm-4.32-2.52-1.627-1.88L6.072 6.82l.627 1.884-1.885.63zm5.66-2.532.63-1.882 1.884.627-.629 1.883zM4.746 4.366l-1.23.41L1.28 11.225l1.23.41L4.746 4.366zM13.68 11.225l-2.234-6.699 1.23-.41 2.234 6.7zM2.58 12.04l.34-1.018H6.6l.339 1.018H2.58zM10.02 6.82l.63-1.882L12.532 5.57l-.63 1.883z"/>
    </svg>
</button>
        </div>

        <div class="notepad-input-area">
            <!-- Textarea-কে contenteditable div দিয়ে প্রতিস্থাপন করা হয়েছে -->
            <div id="taskInput" class="task-input" contenteditable="true" data-placeholder="এখানে নতুন কাজ বা নোট লিখুন..."></div>
            <button id="addTaskBtn" class="add-task-btn">যোগ করুন</button>
        </div>
        <ul id="taskList" class="task-list">
            <!-- কাজগুলো এখানে জাভাস্ক্রিপ্ট দ্বারা যুক্ত হবে -->
        </ul>
    </div>
</div>

<!-- নতুন: ঘড়ি ট্যাব (স্টপওয়াচ, অ্যালার্ম, বিশ্ব ঘড়ি, কাউন্টডাউন) -->
<div id="clockContent" class="calculator-content">
    <div class="clock-container">
        <!-- স্টপওয়াচ সেকশন -->
        <div class="clock-section stopwatch">
            <h3 class="section-title">স্টপওয়াচ</h3>
            <div class="stopwatch-display">00:00:00.000</div>
            <div class="stopwatch-controls">
                <button id="startStopwatch" class="control-btn start-btn">শুরু</button>
                <button id="stopStopwatch" class="control-btn stop-btn">থামুন</button>
                <button id="resetStopwatch" class="control-btn reset-btn">রিসেট</button>
                <button id="lapStopwatch" class="control-btn lap-btn">ল্যাপ</button>
            </div>
            <div class="laps-container">
                <h4>ল্যাপ টাইম</h4>
                <ul id="lapsList"></ul>
            </div>
        </div>

        <!-- অ্যালার্ম সেকশন -->
        <div class="clock-section alarm">
            <h3 class="section-title">অ্যালার্ম</h3>
            <div class="alarm-input-group">
                <input type="time" id="alarmTimeInput" class="alarm-time-input">
            </div>
            <!-- অ্যালার্ম সাউন্ড সিলেকশন -->
            <div class="alarm-sound-selector mb-4">
                <label for="alarmSoundSelect" class="block text-left mb-2 font-semibold text-gray-700 dark:text-gray-200">ডিফল্ট অ্যালার্ম সাউন্ড:</label>
                <select id="alarmSoundSelect" class="w-full p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                    <option value="beep">বিপ</option>
                    <option value="chime">চাইম</option>
                    <option value="radar">রাডার</option>
                </select>
                
                <!-- কাস্টম অডিও আপলোড -->
                <div class="mt-4">
                    <label class="block text-left text-sm font-medium text-gray-600 dark:text-gray-300">অথবা নিজের অডিও ফাইল দিন (mp3, wav, ogg):</label>
                    <div class="flex items-center gap-2 mt-2">
                        <input type="file" id="customAlarmSoundInput" class="hidden" accept="audio/*">
                        <label for="customAlarmSoundInput" class="custom-file-upload-small">ফাইল বাছাই করুন</label>
                        <span id="customAlarmFileName" class="text-sm text-gray-500 dark:text-gray-400 truncate" style="max-width: 120px;">কোনো ফাইল নেই</span>
                        <button id="removeCustomAlarmSound" class="hidden" title="কাস্টম সাউন্ড সরান">&times;</button>
                    </div>
                </div>
            </div>
            <div class="alarm-controls">
                <button id="setAlarmBtn" class="control-btn set-alarm-btn">অ্যালার্ম সেট করুন</button>
                <button id="stopAlarmBtn" class="control-btn stop-btn hidden">অ্যালার্ম থামান</button>
                <button id="clearAlarmBtn" class="control-btn clear-alarm-btn">অ্যালার্ম মুছুন</button>
            </div>
            <div id="alarmStatus" class="alarm-status">কোনো অ্যালার্ম সেট করা নেই।</div>
        </div>

        <!-- বিশ্ব ঘড়ি সেকশন -->
        <div class="clock-section world-clock">
            <h3 class="section-title">বিশ্ব ঘড়ি</h3>
            <div class="mb-4">
                <label for="timezone-select" class="block mb-2 font-semibold text-gray-700 dark:text-gray-200">অন্যান্য দেশের সময় দেখুন:</label>
                <select id="timezone-select" class="w-full p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white focus:ring-2 focus:ring-blue-500"></select>
            </div>
            <div class="world-clock-grid">
                <!-- ঘড়িগুলো এখানে যুক্ত হবে -->
            </div>
        </div>

<!-- কাউন্টডাউন টাইমার সেকশন (আপডেটেড) -->
        <div class="clock-section countdown">
            <h3 class="section-title">কাউন্টডাউন টাইমার</h3>
            
            <!-- টাইটেল ইনপুট -->
            <div class="mb-4">
                 <input type="text" id="cdTitle" placeholder="টাইমারের নাম দিন (যেমন: কুইজ, ইফতার)" class="w-full p-2 border rounded-lg text-center font-semibold dark:bg-gray-700 dark:text-white dark:border-gray-600 focus:ring-2 focus:ring-blue-500">
            </div>
            
            <!-- মোড সিলেকশন -->
            <div class="flex justify-center gap-6 mb-4 p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <label class="inline-flex items-center cursor-pointer">
                    <input type="radio" name="cdMode" value="duration" checked class="form-radio text-indigo-600 h-4 w-4">
                    <span class="ml-2 text-gray-700 dark:text-gray-300 font-medium text-sm">সময়কাল (Duration)</span>
                </label>
                <label class="inline-flex items-center cursor-pointer">
                    <input type="radio" name="cdMode" value="datetime" class="form-radio text-indigo-600 h-4 w-4">
                    <span class="ml-2 text-gray-700 dark:text-gray-300 font-medium text-sm">নির্দিষ্ট তারিখ ও সময়</span>
                </label>
            </div>

            <!-- ইনপুট গ্রিড (Duration) -->
            <div id="cdDurationInputs" class="grid grid-cols-4 gap-2 mb-4 transition-all">
                <div class="flex flex-col">
                    <input type="number" id="cdDays" placeholder="0" min="0" class="w-full p-3 text-center text-xl font-bold border rounded-lg dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    <span class="text-xs text-center mt-1 dark:text-gray-300 font-semibold">দিন</span>
                </div>
                <div class="flex flex-col">
                    <input type="number" id="cdHours" placeholder="0" min="0" class="w-full p-3 text-center text-xl font-bold border rounded-lg dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    <span class="text-xs text-center mt-1 dark:text-gray-300 font-semibold">ঘণ্টা</span>
                </div>
                <div class="flex flex-col">
                    <input type="number" id="cdMinutes" placeholder="0" min="0" max="59" class="w-full p-3 text-center text-xl font-bold border rounded-lg dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    <span class="text-xs text-center mt-1 dark:text-gray-300 font-semibold">মিনিট</span>
                </div>
                <div class="flex flex-col">
                    <input type="number" id="cdSeconds" placeholder="0" min="0" max="59" class="w-full p-3 text-center text-xl font-bold border rounded-lg dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    <span class="text-xs text-center mt-1 dark:text-gray-300 font-semibold">সেকেন্ড</span>
                </div>
            </div>
            
            <!-- ইনপুট গ্রিড (DateTime) - নতুন -->
            <div id="cdDateTimeInputs" class="hidden mb-4">
                <input type="datetime-local" id="cdTargetDateTime" class="w-full p-3 text-center text-lg font-bold border rounded-lg dark:bg-gray-700 dark:text-white dark:border-gray-600 focus:ring-2 focus:ring-indigo-500">
                <p class="text-xs text-center mt-1 text-gray-500 dark:text-gray-400">কাঙ্ক্ষিত তারিখ ও সময় নির্বাচন করুন</p>
            </div>

            <!-- ডিসপ্লে -->
            <div id="countdownDisplay" class="stopwatch-display" style="font-family: 'Bornomala', sans-serif;">00 : 00 : 00 : 00</div>
            
            <div class="stopwatch-controls">
                <button id="startCountdown" class="control-btn start-btn">শুরু</button>
                <button id="pauseCountdown" class="control-btn stop-btn hidden">থামান</button>
                <button id="resetCountdown" class="control-btn reset-btn">রিসেট</button>
            </div>
        </div>
    </div>
</div>


<!-- নতুন: প্লেয়ার ট্যাব -->
<div id="playerContent" class="calculator-content">
    <div class="player-container">
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">মিডিয়া প্লেয়ার</h3>

        <!-- অডিও সেকশন -->
        <div class="player-section">
            <h4 class="player-section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                <span>অডিও প্লেয়ার</span>
            </h4>
            <div class="player-content-area">
                <audio id="audioPlayer" controls class="w-full"></audio>
                <div class="player-input-area flex flex-wrap items-center gap-2">
                    <label for="audioInput" class="custom-file-upload">অডিও ফাইল বাছাই করুন</label>
                    <input type="file" id="audioInput" accept="audio/*">
                    <p id="audioFileName" class="file-name-display truncate max-w-[150px] sm:max-w-[250px]"></p>
                    
                    <!-- অডিও মুছুন বাটন -->
                    <button id="clearAudioBtn" class="hidden text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors" title="অডিও মুছুন">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                        </svg>
                    </button>

                    <!-- অডিওর জন্য লুপ টগল সুইচ -->
                    <div class="flex items-center gap-2 ml-auto">
                        <span class="font-semibold text-gray-700 dark:text-gray-300 text-sm">লুপ</span>
                        <label class="switch">
                            <input type="checkbox" id="audioLoopToggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- ছবি সেকশন -->
        <div class="player-section">
            <h4 class="player-section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                <span>ছবি প্রদর্শক</span>
            </h4>
            <div class="player-content-area">
                <div class="image-preview-box">
                    <img id="imagePreview" src="https://placehold.co/600x400/e2e8f0/4a5568?text=ছবি+লোড+করুন" alt="Image Preview">
                </div>
                <div class="player-input-area flex flex-wrap items-center gap-2">
                    <label for="imageInput" class="custom-file-upload">ছবি বাছাই করুন</label>
                    <input type="file" id="imageInput" accept="image/*">
                    
                    <!-- ছবি মুছুন বাটন -->
                    <button id="clearImageBtn" class="hidden text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors" title="ছবি মুছুন">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- ভিডিও সেকশন -->
        <div class="player-section">
            <h4 class="player-section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
                <span>ভিডিও প্লেয়ার</span>
            </h4>
            <div class="player-content-area">
                <video id="videoPlayer" controls class="w-full rounded-lg bg-black"></video>
                <div class="player-input-area flex flex-wrap items-center gap-2">
                    <label for="videoInput" class="custom-file-upload">ভিডিও ফাইল বাছাই করুন</label>
                    <input type="file" id="videoInput" accept="video/*">
                    
                    <!-- ভিডিও মুছুন বাটন -->
                    <button id="clearVideoBtn" class="hidden text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors" title="ভিডিও মুছুন">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                        </svg>
                    </button>

                    <!-- মুভ টু অডিও বাটন -->
                    <button id="moveToAudioBtn" class="hidden px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-semibold transition-colors flex items-center gap-1" title="ভিডিওটি অডিও প্লেয়ারে বাজান">
                       <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                       অডিওতে নিন
                    </button>

                     <!-- ভিডিওর জন্য লুপ টগল সুইচ -->
                    <div class="flex items-center gap-2 ml-auto">
                        <span class="font-semibold text-gray-700 dark:text-gray-300 text-sm">লুপ</span>
                        <label class="switch">
                            <input type="checkbox" id="videoLoopToggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- নতুন: যাকাত ক্যালকুলেটর বিভাগ -->
<div id="zakatCalculatorContent" class="calculator-content">
    <div class="zakat-calculator-content">
        <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-4">যাকাত ক্যালকুলেটর</h3>
        <p class="text-gray-600 dark:text-gray-400 mb-6">আপনার যাকাতযোগ্য সম্পদের হিসাব করতে নিচের ঘরগুলো পূরণ করুন। রুপার হিসাব অনুযায়ী নিসাব গণনা করা নিরাপদ।</p>

        <div class="zakat-grid">
            <!-- নিসাব গণনা অংশ -->
            <div class="zakat-section nisab-section">
                <h4 class="zakat-section-title">নিসাব গণনা</h4>
                <div class="zakat-input-group">
                    <label for="silverPrice">১ ভরি রুপার বর্তমান বাজারমূল্য (টাকা)<b style="color:red">*</b></label>
                    <input type="number" id="silverPrice" placeholder="যেমন: 2100" class="zakat-input">
                </div>
                 <div class="zakat-input-group">
                    <label for="goldPrice">১ ভরি সোনার বর্তমান বাজারমূল্য (টাকা)<b style="color:red">*</b></label>
                    <input type="number" id="goldPrice" placeholder="যেমন: 110000" class="zakat-input">
                </div>
                <div class="nisab-result">
                    <p>রুপা অনুযায়ী নিসাব: <span id="nisabAmount" class="font-bold">৳ 0.00</span></p>
                    <small>(সাড়ে ৫২ ভরি রুপার মূল্যের সমপরিমাণ)</small>
                </div>
            </div>

            <!-- সম্পদ অংশ -->
            <div class="zakat-section">
                <h4 class="zakat-section-title">যাকাতযোগ্য সম্পদ</h4>
                <div class="zakat-input-group">
                    <label for="goldAmount">সোনা (ভরি)</label>
                    <input type="number" id="goldAmount" placeholder="0" class="zakat-input">
                </div>
                <div class="zakat-input-group">
                    <label for="silverAmount">রুপা (ভরি)</label>
                    <input type="number" id="silverAmount" placeholder="0" class="zakat-input">
                </div>
                <div class="zakat-input-group">
                    <label for="cashAmount">নগদ অর্থ (ব্যাংক, হাতে থাকা)</label>
                    <input type="number" id="cashAmount" placeholder="0" class="zakat-input">
                </div>
                <div class="zakat-input-group">
                    <label for="businessAssets">ব্যবসায়িক সম্পদ (বর্তমান বাজারমূল্য)</label>
                    <input type="number" id="businessAssets" placeholder="0" class="zakat-input">
                </div>
                <div class="zakat-input-group">
                    <label for="otherAssets">অন্যান্য সম্পদ (শেয়ার, বন্ড, প্রদত্ত ঋণ)</label>
                    <input type="number" id="otherAssets" placeholder="0" class="zakat-input">
                </div>
            </div>

            <!-- দেনা অংশ -->
            <div class="zakat-section">
                <h4 class="zakat-section-title">মোট দেনা / ঋণ</h4>
                <div class="zakat-input-group">
                    <label for="debtAmount">বাদযোগ্য ঋণ (যা এক বছরের মধ্যে পরিশোধযোগ্য)</label>
                    <input type="number" id="debtAmount" placeholder="0" class="zakat-input">
                </div>
            </div>
        </div>

        <button id="calculateZakatBtn" class="zakat-calculate-btn">যাকাতের হিসাব করুন</button>

        <div id="zakatResultArea" class="zakat-result-area">
            <!-- ফলাফল এখানে দেখানো হবে -->
        </div>
    </div>
</div>

<!-- নতুন: কিউআর কোড জেনারেটর বিভাগ (আপলোড ফিচার এবং লাইভ জেনারেশনসহ) -->
<div id="qrCodeContent" class="calculator-content">
    <div class="qr-code-content">
        <!-- ইনপুট এবং অপশন -->
        <div class="qr-input-section">
            <h3 class="text-xl font-bold text-gray-700 mb-2 dark:text-gray-200">কিউআর কোড জেনারেটর ও রিডার</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-2">যেকোনো টেক্সট বা লিঙ্ক থেকে QR কোড তৈরি করুন অথবা ছবি আপলোড করে QR কোড থেকে তথ্য পড়ুন। টেক্সটবক্সে লিখলেই লাইভ QR কোড তৈরি হবে।</p>
            <textarea id="qrInput" rows="6" placeholder="এখানে আপনার টেক্সট বা URL লিখুন..."></textarea>
        </div>

        <!-- ফলাফল এবং বাটন -->
        <div class="qr-output-section">
            <!-- কিউআর কোড এখানে দেখানো হবে -->
            <div id="qrcode-container">
                <div id="qrcode" class="p-2 bg-white rounded-lg shadow-inner"></div>
                <div id="qrcode-placeholder" class="flex items-center justify-center">
                    <svg class="w-16 h-16 text-gray-300 dark:text-gray-500" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 5h3v3H5zm0 8h3v3H5zm8-8h3v3h-3zm0 8h3v3h-3zM9 2v2M9 20v2m8-11h2m-2-4h2m-6 0V2m-6 0V2m-2 4h2m-2 2H3m2 6H3m2 2H3m6 0v2m-4 0v2m11-2h2m-2 2h2m-2-6h2m-2-2h2"/></svg>
                </div>
            </div>
            
            <div class="qr-actions">
                <button id="downloadQrBtn" class="qr-button download" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
                    <span>ডাউনলোড (PNG)</span>
                </button>
                 <label for="qrFileInput" class="qr-button upload" style="cursor: pointer;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg>
                    <span>আপলোড</span>
                </label>
                <input type="file" id="qrFileInput" class="hidden" accept="image/*">
                <button id="clearQrBtn" class="qr-button clear">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5M8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5m3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0"/></svg>
                    <span>মুছুন</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- নতুন: জরুরি নম্বর বিভাগ -->
<div id="emergencyNumbersContent" class="calculator-content">
    <div class="emergency-numbers-content">
        <h3 class="text-xl font-bold text-gray-700 mb-2 dark:text-gray-200">জরুরি সেবার নম্বর</h3>
        <p class="text-gray-600 dark:text-gray-400 mb-4">জাতীয় জরুরি সেবা অথবা আপনার জেলা নির্বাচন করে প্রয়োজনীয় নম্বরগুলো দেখুন। নাম্বারগুলো যাচাই করা প্রয়োজন অথবা কাঙ্খিত সঠিক নাম্বারটি এডিট করে রাখতে পারবেন। ব্রাউজার বন্ধ করলেও নাম্বারটি সেভ থাকবে।</p>

		<div class="emergency-controls">
			<label for="location-select" class="font-semibold text-gray-700 dark:text-gray-300">অবস্থান নির্বাচন করুন:</label>
			<select id="location-select" class="w-full sm:w-auto p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white focus:ring-2 focus:ring-blue-500 transition-all"></select>
    
			<!-- নতুন বাটন -->
			<button id="addEmergencyCardBtn" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition-colors">নতুন কার্ড যুক্ত করুন</button>
		</div>

        <div id="emergency-numbers-display" class="emergency-numbers-grid">
            <!-- জরুরি নম্বরগুলো এখানে জাভাস্ক্রিপ্ট দ্বারা যুক্ত হবে -->
        </div>
    </div>
</div>

<!-- নতুন: গুরুত্বপূর্ণ লিংকসমূহ বিভাগ -->
<div id="importantLinksContent" class="calculator-content">
    <div class="important-links-container p-4 sm:p-6">
        <!-- Profile Section -->
        <div class="text-center mb-6">
            <img class="profile-pic" src="https://cdn.jsdelivr.net/gh/mdsifatgitid/mdsifatgitid.github.io/Md%20Shahiduzzaman%20Sifat.png" alt="Profile Picture">
            <h2 class="text-2xl font-bold mt-4 text-gray-800 dark:text-gray-100">Md Shahiduzzaman Sifat</h2>
            <p class="text-gray-600 dark:text-gray-400 mt-1">Developer of 'Bangla Toolbox', Tech Enthusiast</p>
        </div>

        <!-- Links Section -->
        <div class="flex flex-col gap-4">
            <!-- Example Link 1: Website -->
            <a href="https://bio.link/mdsifatbiolink" target="_blank" class="link-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                <span>বায়ো প্রোফাইল (সকল লিংক এখানে)</span>
            </a>
            <!-- Example Link 2: GitHub -->
            <a href="https://muslimbangla.com/" target="_blank" class="link-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                <span>মুসলিম বাংলা</span>
            </a>
            <a href="https://toffeeshare.com/" target="_blank" class="link-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                <span>ফাইল ট্রান্সফার</span>
            </a>
            <a href="https://www.remove.bg/" target="_blank" class="link-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                <span>ব্যাকগ্রাউন্ড রিমুভ</span>
            </a>
            <a href="https://www.camscanner.com/" target="_blank" class="link-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                <span>ক্যামস্ক্যানার</span>
            </a>
            <a href="https://www.sejda.com/" target="_blank" class="link-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                <span>পিডিএফ এডিটর</span>
            </a>
            <a href="https://crex.com/live-matches" target="_blank" class="link-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                <span>ক্রিকেট লাইভ স্কোর</span>
            </a>
            <a href="https://livestreamcricket.cc/" target="_blank" class="link-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                <span>ক্রিকেট লাইভ ম্যাচ ১</span>
            </a>
            <a href="https://durbintvlive.com/match/" target="_blank" class="link-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                <span>ক্রিকেট লাইভ ম্যাচ ২</span>
            </a>
            <!-- Example Link 3: Facebook -->
            <a href="https://www.facebook.com/mdsifatfbid" target="_blank" class="link-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>
                <span>ফেসবুক</span>
            </a>
             <!-- Example Link 4: Email -->
            <a href="mailto:banglatoolbox@gmail.com" class="link-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                <span>ইমেইল</span>
            </a>
        </div>

        <!-- Social Icons Section -->
        <div class="flex justify-center gap-6 mt-8">
            <a href="https://facebook.com/mdsifatfbid" target="_blank" class="social-icon" title="LinkedIn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>
            </a>
             <a href="https://www.youtube.com/@mdsifatytid" target="_blank" class="social-icon" title="YouTube">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22.54 6.42a2.78 2.78 0 0 0-1.94-2C18.88 4 12 4 12 4s-6.88 0-8.6.46a2.78 2.78 0 0 0-1.94 2A29 29 0 0 0 1 11.75a29 29 0 0 0 .46 5.33A2.78 2.78 0 0 0 3.4 19c1.72.46 8.6.46 8.6.46s6.88 0 8.6-.46a2.78 2.78 0 0 0 1.94-2 29 29 0 0 0 .46-5.25 29 29 0 0 0-.46-5.33z"></path><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"></polygon></svg>
            </a>
            <a href="https://x.com/mdsifatttid" target="_blank" class="social-icon" title="Twitter / X">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg>
            </a>
        </div>
 <!-- ভিজিটর কাউন্টার সেকশন শুরু -->
<!-- এই সম্পূর্ণ div টি আপনার পুরনো visitor-counter-section div এর পরিবর্তে বসান -->
<div id="visitor-counter-section" class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-600 grid grid-cols-2 md:grid-cols-4 gap-4">
    <!-- আপনার আজকের ভিজিট কার্ড (বিদ্যমান) -->
    <div class="bg-indigo-100 dark:bg-indigo-900/50 p-4 rounded-xl text-center">
        <h4 class="text-sm font-semibold text-indigo-600 dark:text-indigo-300">আজ আপনার ভিজিট</h4>
        <p id="today-visits" class="text-3xl font-bold text-indigo-800 dark:text-indigo-200 mt-2">০</p>
    </div>
    <!-- আপনার মোট ভিজিট কার্ড (বিদ্যমান) -->
    <div class="bg-green-100 dark:bg-green-900/50 p-4 rounded-xl text-center">
        <h4 class="text-sm font-semibold text-green-600 dark:text-green-300">আপনার মোট ভিজিট</h4>
        <p id="total-visits" class="text-3xl font-bold text-green-800 dark:text-green-200 mt-2">০</p>
    </div>
    <!-- আজকের ভিজিট (সকল) কার্ড (নতুন) -->
    <div class="bg-yellow-100 dark:bg-yellow-900/50 p-4 rounded-xl text-center">
        <h4 class="text-sm font-semibold text-yellow-600 dark:text-yellow-300">আজকের ভিজিটর</h4>
        <p id="all-today-visits" class="text-3xl font-bold text-yellow-800 dark:text-yellow-200 mt-2">০</p>
    </div>
    <!-- সর্বমোট ভিজিট (সকল) কার্ড (নতুন) -->
    <div class="bg-red-100 dark:bg-red-900/50 p-4 rounded-xl text-center">
        <h4 class="text-sm font-semibold text-red-600 dark:text-red-300">মোট ভিজিটর (সকল)</h4>
        <p id="all-total-visits" class="text-3xl font-bold text-red-800 dark:text-red-200 mt-2">০</p>
    </div>
</div>
<!-- ভিজিটর কাউন্টার সেকশন শেষ -->
    </div>
</div>

<!-- নতুন: স্বাস্থ্য ও জীবনধারা ট্যাব -->
<div id="healthLifestyleContent" class="calculator-content">
    <div class="health-lifestyle-content">
        <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-6 text-center">স্বাস্থ্য ও জীবনধারা</h3>
        <div class="health-grid">
            <!-- প্রেগন্যান্সি ডিউ ডেট ক্যালকুলেটর -->
            <div class="health-section">
                <h4 class="health-section-title">
                    <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
                    <span>প্রেগন্যান্সি ডিউ ডেট ক্যালকুলেটর</span>
                </h4>
                <div class="health-input-group">
                    <label for="lmpDate">আপনার শেষ মাসিকের প্রথম দিন:</label>
                    <input type="date" id="lmpDate" class="health-input">
                </div>
                <button id="calculateDueDateBtn" class="health-calculate-btn">হিসাব করুন</button>
                <div id="dueDateResultArea" class="health-result-area">
                    <p>অনুগ্রহ করে তারিখ নির্বাচন করুন।</p>
                </div>
            </div>

            <!-- পানি পানের পরিমাণ ক্যালকুলেটর -->
            <div class="health-section">
                <h4 class="health-section-title">
                    <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 6v6l4 2"/></svg>
                    <span>দৈনিক পানি পানের পরিমাণ</span>
                </h4>
                <div class="health-input-group">
                    <label for="userAge">বয়স (বছর):</label>
                    <input type="number" id="userAge" placeholder="যেমন: 25" class="health-input">
                </div>
                <div class="health-input-group">
                    <label for="userWeight">ওজন (কেজি):</label>
                    <input type="number" id="userWeight" placeholder="যেমন: 65" class="health-input">
                </div>
                <div class="health-input-group">
                    <label for="activityLevel">কাজের ধরন:</label>
                    <select id="activityLevel" class="health-select">
                        <option value="0">বসে কাজ (Sedentary)</option>
                        <option value="30">হালকা সক্রিয় (Lightly Active)</option>
                        <option value="60">মাঝারি সক্রিয় (Moderately Active)</option>
                        <option value="90">খুব সক্রিয় (Very Active)</option>
                    </select>
                </div>
                <button id="calculateWaterIntakeBtn" class="health-calculate-btn">হিসাব করুন</button>
                <div id="waterIntakeResultArea" class="health-result-area">
                    <p>অনুগ্রহ করে তথ্য দিন।</p>
                </div>
            </div>
			<!-- BMI ক্যালকুলেটরের শুরু -->
<div id="bmi-calculator-container" class="bmi-calculator">
    <h3 class="bmi-title">বিএমআই (BMI) ক্যালকুলেটর</h3>
    <p class="bmi-subtitle">আপনার ওজন ও উচ্চতা নিচের ঘরে লিখুন।</p>
    
    <!-- ওজন ইনপুট -->
    <div class="bmi-input-group">
        <label for="bmi-weight">ওজন (কেজি)</label>
        <input type="number" id="bmi-weight" placeholder="যেমন: 70">
    </div>
    
    <!-- উচ্চতা ইনপুট -->
    <div class="bmi-input-group">
        <label>উচ্চতা (ফিট ও ইঞ্চি)</label>
        <div class="bmi-height-inputs">
            <input type="number" id="bmi-height-feet" placeholder="ফিট">
            <input type="number" id="bmi-height-inches" placeholder="ইঞ্চি">
        </div>
    </div>
    
    <!-- হিসাব করার বাটন -->
    <button id="bmi-calculate-btn">হিসাব করুন</button>
    
    <!-- ফলাফল দেখানোর স্থান -->
    <div id="bmi-result" class="bmi-result-section"></div>
</div>
<!-- BMI ক্যালকুলেটরের শেষ -->
        </div>
    </div>
</div>

<!-- নতুন: দিবসসমূহ ট্যাব -->
<div id="daysObservancesContent" class="calculator-content">
    <div class="days-observances-container">
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">দিবসসমূহ</h3>

        <!-- ***** নতুন: আজকের দিবস সেকশন ***** -->
        <div id="todayObservances" class="upcoming-observances-container mb-6">
            <div id="todayNationalDay" class="today-day-card national">
                <!-- JavaScript দ্বারা পূর্ণ হবে -->
            </div>
            <div id="todayInternationalDay" class="today-day-card international">
                <!-- JavaScript দ্বারা পূর্ণ হবে -->
            </div>
        </div>
		
        <!-- নতুন: আগত দিবস সেকশন -->
        <div id="upcomingObservances" class="upcoming-observances-container mb-6">
            <div id="upcomingNationalDay" class="upcoming-day-card national">
                <!-- JavaScript দ্বারা পূর্ণ হবে -->
            </div>
            <div id="upcomingInternationalDay" class="upcoming-day-card international">
                <!-- JavaScript দ্বারা পূর্ণ হবে -->
            </div>
        </div>
        <!-- ***** নতুন সেকশন শেষ ***** -->
        <div class="year-selector-wrapper mb-6">
            <label for="observanceYearSelect" class="font-semibold text-gray-700 dark:text-gray-300 mr-2">বছর নির্বাচন করুন:</label>
            <input type="number" id="observanceYearSelect" class="year-input dark:bg-gray-600 dark:border-gray-500 dark:text-white focus:ring-2 focus:ring-blue-500 transition-all">
        </div>
        <div class="observances-grid">
            <div class="observance-section">
                <h4 class="section-title">বাংলাদেশী দিবসসমূহ</h4>
                <div id="bangladeshiDaysList" class="days-list">
                    <!-- JavaScript দ্বারা পূর্ণ হবে -->
                </div>
            </div>
            <div class="observance-section">
                <h4 class="section-title">আন্তর্জাতিক দিবসসমূহ</h4>
                <div id="internationalDaysList" class="days-list">
                    <!-- JavaScript দ্বারা পূর্ণ হবে -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- নতুন: ছুটির তালিকা ট্যাব -->
<div id="holidayListContent" class="calculator-content">
    <div class="days-observances-container"> <!-- Reusing existing style for consistency -->
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">সরকারি ছুটির তালিকা</h3>
        
        <!-- পরিবর্তন: আগত ছুটির কার্ডটি মাঝে আনা হয়েছে -->
        <div id="upcomingHolidayContainer" class="flex justify-center mb-6">
            <div id="upcomingHolidayCard" class="upcoming-day-card w-full max-w-sm" style="background: linear-gradient(135deg, #3b82f6, #60a5fa);">
                <!-- JavaScript দ্বারা পূর্ণ হবে -->
            </div>
        </div>

        <p class="text-gray-600 dark:text-gray-400 mb-4">
            সাপ্তাহিক ছুটি (লাল), সরকারি ছুটি (সবুজ), এবং চাঁদ দেখার উপর নির্ভরশীল ছুটিগুলো (হলুদ) দেখানো হয়েছে। ডেটা Gemini API অথবা Nager.Date API থেকে লোড করা হয়েছে। তথ্য যাচাই প্রয়োজন হতে পারে।
        </p>
        <!-- পরিবর্তন: রিফ্রেশ বাটন যোগ করা হয়েছে -->
        <div class="year-selector-wrapper mb-6 flex justify-center items-center gap-4">
            <label for="holidayYearSelect" class="font-semibold text-gray-700 dark:text-gray-300 mr-2">বছর নির্বাচন করুন:</label>
            <input type="number" id="holidayYearSelect" class="year-input dark:bg-gray-600 dark:border-gray-500 dark:text-white focus:ring-2 focus:ring-blue-500 transition-all">
            <button id="refreshHolidayListBtn" class="p-2 bg-indigo-500 text-white rounded-full hover:bg-indigo-600 transition-colors" title="তালিকা রিফ্রেশ করুন">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
                </svg>
            </button>
        </div>
        <div class="overflow-x-auto max-h-[60vh] relative min-h-[300px]">
            <table id="holidayTable" class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-800 dark:text-gray-400 sticky top-0">
                    <tr>
                        <th scope="col" class="px-6 py-3">তারিখ</th>
                        <th scope="col" class="px-6 py-3">বার</th>
                        <th scope="col" class="px-6 py-3">উপলক্ষ</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Holiday rows will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- নতুন: কুইজ ট্যাব (জেমিনি API ইন্টিগ্রেটেড) -->
<div id="quizContent" class="calculator-content">
    <!-- কুইজ সেটআপ স্ক্রিন -->
    <div id="quiz-setup-container" class="quiz-setup-container">
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">সাধারণ জ্ঞান কুইজ</h3>
        <p class="text-gray-600 dark:text-gray-400 mb-6">আপনার পছন্দের বিভাগ এবং অসুবিধার স্তর নির্বাচন করে কুইজ শুরু করুন। প্রশ্নগুলো জেমিনি দ্বারা তৈরি করা হবে।</p>
        
    <div class="quiz-options">
		<div class="quiz-option-group">
			<label for="quiz-category">বিভাগ নির্বাচন করুন:</label>
			<select id="quiz-category" class="quiz-select">
				<option value="সাধারণ জ্ঞান">সাধারণ জ্ঞান</option>
				<option value="বিসিএস প্রস্তুতি">বিসিএস প্রস্তুতি</option>
				<option value="চাকরির পরীক্ষা">চাকরির পরীক্ষা</option>
				<option value="বিশ্ববিদ্যালয় ভর্তি">বিশ্ববিদ্যালয় ভর্তি</option>
				<option value="স্কুল ও কলেজ">স্কুল ও কলেজ</option>
				<option value="বিজ্ঞান ও প্রযুক্তি">বিজ্ঞান ও প্রযুক্তি</option>
				<option value="custom">কাস্টম</option>
			</select>
			<input type="text" id="quiz-custom-category" class="quiz-select hidden mt-2" placeholder="আপনার কাস্টম ক্যাটাগরি লিখুন...">
		</div>
            <div class="quiz-option-group">
                <label for="quiz-difficulty">অসুবিধার স্তর:</label>
                <select id="quiz-difficulty" class="quiz-select">
                    <option value="সহজ">সহজ</option>
                    <option value="মধ্যম">মধ্যম</option>
                    <option value="জটিল">জটিল</option>
                </select>
            </div>
            <!-- নতুন: প্রশ্নের সংখ্যা নির্বাচনের জন্য ড্রপডাউন -->
            <div class="quiz-option-group">
                <label for="quiz-question-count">প্রশ্নের সংখ্যা:</label>
                <select id="quiz-question-count" class="quiz-select">
                    <option value="10">১০</option>
                    <option value="20">২০</option>
                    <option value="30">৩০</option>
                    <option value="50">৫০</option>
                    <option value="100">১০০</option>
                </select>
            </div>
        </div>
        
        <button id="start-quiz-btn" class="quiz-button start">কুইজ শুরু করুন</button>
        <div id="quiz-loading" class="loading-indicator mt-4" style="display: none;">কুইজ লোড হচ্ছে, অনুগ্রহ করে অপেক্ষা করুন...</div>
    </div>

    <!-- মূল কুইজ স্ক্রিন -->
    <div id="quiz-main-container" class="quiz-container hidden">
        <div id="quiz-header" class="quiz-header">
            <div id="question-number">প্রশ্ন: ১/১০</div>
            <div id="quiz-score">স্কোর: ০</div>
        </div>
        <div class="question-container">
            <p id="question-text">প্রশ্ন এখানে লোড হবে...</p>
        </div>
        <div id="options-container" class="options-container">
            <!-- অপশনগুলো এখানে যুক্ত হবে -->
        </div>
        <div id="quiz-feedback" class="quiz-feedback"></div>
        <div class="quiz-footer">
            <button id="next-question-btn" class="quiz-button next">পরবর্তী প্রশ্ন</button>
        </div>
    </div>

    <!-- ফলাফল স্ক্রিন -->
    <div id="quiz-result-container" class="quiz-result-container hidden">
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">কুইজ সম্পন্ন!</h3>
        <p id="final-score" class="final-score"></p>
        <p id="final-feedback" class="final-feedback"></p>
        <button id="restart-quiz-btn" class="quiz-button restart">নতুন কুইজ শুরু করুন</button>
    </div>
</div>

<!-- ডোনেট ট্যাব কন্টেন্ট শুরু -->
<div id="donateContent" class="calculator-content">
    <div class="donate-section">
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">ডোনেট করুন</h3>
        <p class="donate-text">
            বাংলা ভাষাভাষীদের জন্য বাংলা টুলবক্স সবসময় ফ্রিতেই ব্যবহার করার সুযোগ থাকবে ইনশাআল্লাহ। তবে বাংলা টুলবক্স প্রকল্পটির উন্নয়ন চলমান রাখতে ও উৎসাহ প্রদানের উপলক্ষে বাংলা টুলবক্স প্রজেক্টটিতে সামর্থ্য ও ইচ্ছা অনুযায়ী ডোনেট করতে পারেন।
        </p>
        <h4 class="donate-subtitle">ডোনেট করুন নিম্নোক্ত মাধ্যমে:</h4>
        
        <!-- নতুন: নম্বর কপি করার জন্য কন্টেইনার যোগ করা হয়েছে -->
        <div class="relative inline-block" id="donate-number-container">
            <p class="donate-number dark:!text-white" id="donate-number-text">
                <strong>বিকাশ, নগদ, রকেট, উপায়:</strong> 01778472964
            </p>
            <!-- নোটপ্যাডের মতো অ্যাকশন বার -->
            <div id="donate-actions" class="actions">
                <button class="action-btn copy" id="copyDonateNumberBtn" title="নম্বর কপি করুন">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z"/></svg>
                </button>
            </div>
        </div>

        <div class="qr-code-section">
             <h4 class="donate-subtitle">কিউআর কোড (সেন্ড মানি): বিকাশ</h4>
             <!-- পরিবর্তন: QR কোডের লিংক CDN ব্যবহার করে আপডেট করা হয়েছে -->
             <img src="https://cdn.jsdelivr.net/gh/mdsifatgitid/mdsifatgitid.github.io/Bkash%20QR%20Code.jpeg" alt="বিকাশ QR কোড" class="qr-code-image">
        </div>
        <p class="donate-email">
            <strong>প্রয়োজনে মেইল করুন:</strong> </br>mdsifatgid@gmail.com</br>banglatoolbox@gmail.com</br>mdshahiduzzamansifat@gmail.com
        </p>
        <div class="flex flex-col gap-1">
            <!-- Example Link 1: Website -->
            <a href="https://bio.link/mdsifatbiolink" target="_blank" class="link-btn">
                <span>যেকোনো মতামত বা পরামর্শ জানান (অন্যান্য সকল যোগাযোগ মাধ্যম)</span>
            </a>
            <a href="https://banglatoolbox.github.io" target="_blank" class="link-btn">
                <span>বাংলা টুলবক্স (লিংক ১)</span>
            </a>
            <a href="https://mdsifatgitid.github.io" target="_blank" class="link-btn">
                <span>বাংলা টুলবক্স (লিংক ২)</span>
            </a>
        </div>
    </div>
</div>
<!-- ডোনেট ট্যাব কন্টেন্ট শেষ -->

<!-- ======================================================== -->
<!-- START: Invoice Tab Content (ইনভয়েজ ট্যাব) -->
<!-- ======================================================== -->
<div id="invoiceContent" class="calculator-content">
    <div id="invoice-container" class="mx-auto my-8 p-8 bg-white dark:bg-gray-900 rounded-lg shadow-lg max-w-4xl text-gray-800 dark:text-gray-200">

        <!-- Header Section -->
        <header class="flex justify-between items-start mb-8 border-b pb-4 border-gray-200 dark:border-gray-700">
            <div class="flex items-center gap-4">
                <div class="relative">
                    <img id="invoice-logo" src="https://placehold.co/150x80/e2e8f0/4a5568?text=লোগো+দিন" alt="Company Logo" class="object-contain h-20 w-auto">
                    <input type="file" id="logo-upload" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer no-print" accept="image/*" title="লোগো পরিবর্তন করুন">
                </div>
                <div>
                    <h2 contenteditable="true" id="company-name" class="text-2xl font-bold text-gray-900 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 rounded-md px-2">আপনার প্রতিষ্ঠানের নাম</h2>
                    <p contenteditable="true" id="company-address" class="text-sm text-gray-600 dark:text-gray-400 outline-none focus:ring-2 focus:ring-blue-500 rounded-md px-2 mt-1">ঠিকানা, শহর, পোস্টকোড</p>
                    <p contenteditable="true" id="company-phone" class="text-sm text-gray-600 dark:text-gray-400 outline-none focus:ring-2 focus:ring-blue-500 rounded-md px-2">ফোন: +৮৮০ ১২৩৪ ৫৬৭৮৯০</p>
                </div>
            </div>
            <div class="text-right">
<h1 contenteditable="true" id="invoice-title" class="text-3xl font-bold text-gray-700 dark:text-gray-300 outline-none focus:ring-2 focus:ring-blue-500 rounded-md px-2">ইনভয়েজ</h1>
                <div class="mt-2">
                    <span class="font-semibold">ইনভয়েজ নং:</span>
                    <span contenteditable="true" id="invoice-number" class="outline-none focus:ring-2 focus:ring-blue-500 rounded-md px-1">০০১</span>
                </div>
                <div>
                    <span class="font-semibold">তারিখ:</span>
                    <span contenteditable="true" id="invoice-date" class="outline-none focus:ring-2 focus:ring-blue-500 rounded-md px-1"></span>
                </div>
            </div>
        </header>

        <!-- Bill To Section -->
        <section class="mb-8">
            <h3 class="text-lg font-semibold border-b border-gray-200 dark:border-gray-700 pb-1 mb-2">প্রাপক:</h3>
            <div contenteditable="true" id="customer-name" class="font-bold outline-none focus:ring-2 focus:ring-blue-500 rounded-md px-2">ক্রেতার নাম</div>
            <div contenteditable="true" id="customer-address" class="text-sm text-gray-600 dark:text-gray-400 outline-none focus:ring-2 focus:ring-blue-500 rounded-md px-2">ক্রেতার ঠিকানা</div>
        </section>

        <!-- Items Table -->
        <section>
            <table class="w-full text-left" id="invoice-items-table">
                <thead class="bg-gray-100 dark:bg-gray-800">
                    <tr>
                        <th class="p-3 font-semibold">পণ্যের বিবরণ</th>
                        <th class="p-3 font-semibold text-center w-24">পরিমাণ</th>
                        <th class="p-3 font-semibold text-right w-32">দর</th>
                        <th class="p-3 font-semibold text-right w-32">ছাড় (টাকা)</th>
                        <th class="p-3 font-semibold text-right w-40">নীট মূল্য</th>
                        <th class="p-3 text-center no-print">মুছুন</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Item rows will be injected here -->
                </tbody>
            </table>
            <button id="add-item-btn" class="mt-4 px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition-colors no-print">
                + নতুন আইটেম
            </button>
        </section>

        <!-- Summary Section -->
        <section class="mt-8 flex justify-end">
            <div class="w-full max-w-sm space-y-2">
                <div class="flex justify-between">
                    <span class="font-semibold">সাবটোটাল:</span>
                    <span id="subtotal">০.০০</span>
                </div>
                 <div class="flex justify-between">
                    <span class="font-semibold text-red-600">আইটেম ডিসকাউন্ট:-</span>
                    <span id="item-discounts-total" class="text-red-600">- ০.০০</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-red-600">অতিরিক্ত ডিসকাউন্ট:-</span>
                    <input type="number" id="extra-discount" placeholder="0.00" class="w-28 text-right p-1 border rounded-md bg-red-50 dark:bg-red-900/50 text-red-700 dark:text-red-300">
                </div>
                <div class="flex justify-between items-center">
                    <span class="font-semibold">পূর্বের বকেয়া:+</span>
                    <input type="number" id="prev-due" placeholder="0.00" class="w-28 text-right p-1 border rounded-md bg-gray-50 dark:bg-gray-700">
                </div>
                <div class="flex justify-between border-t-2 pt-2 border-gray-300 dark:border-gray-600">
                    <span class="font-bold text-lg">সর্বমোট:</span>
                    <span id="grand-total" class="font-bold text-lg">০.০০</span>
                </div>
                 <div class="flex justify-between items-center">
                    <span class="font-semibold text-green-600">জমা:-</span>
                    <input type="number" id="paid-amount" placeholder="0.00" class="w-28 text-right p-1 border rounded-md bg-green-50 dark:bg-green-900/50 text-green-700 dark:text-green-300">
                </div>
                <div class="flex justify-between bg-red-100 dark:bg-red-900/50 p-2 rounded-md">
                    <span class="font-bold text-red-700 dark:text-red-300 text-lg">বর্তমান বকেয়া:</span>
                    <span id="final-due" class="font-bold text-red-700 dark:text-red-300 text-lg">০.০০</span>
                </div>
            </div>
        </section>
        <!-- Notes/Comments Section -->
        <section class="mt-8 border-t pt-4 border-gray-200 dark:border-gray-700">
            <div contenteditable="true" id="invoice-comments" class="text-sm text-gray-600 dark:text-gray-400 outline-none focus:ring-2 focus:ring-blue-500 rounded-md p-2 min-h-[60px] bg-gray-50 dark:bg-gray-800 w-full">মন্তব্য:</div>
        </section>
        <!-- Footer / Actions -->
        <footer class="mt-12 text-center no-print">
            <button id="print-invoice-btn" class="px-6 py-3 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition-colors">
                ইনভয়েজ প্রিন্ট করুন
            </button>
        </footer>

         <!-- NEW: Saved Invoices Section -->
        <div class="mt-8 pt-8 border-t border-gray-300 dark:border-gray-700 no-print">
            <div class="flex justify-center gap-4">
                 <button id="save-to-list-btn" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors">
                    ইনভয়েজ লিস্টে সেভ করুন
                 </button>
                 <button id="clear-current-invoice-btn" class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition-colors">
                    নতুন ইনভয়েজ
                 </button>
            </div>
            <h3 class="text-xl font-bold text-gray-700 dark:text-gray-200 mt-8 mb-4 text-center">সেভ করা ইনভয়েজের তালিকা</h3>
            <div id="saved-invoices-container" class="max-h-96 overflow-y-auto p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                <table id="saved-invoices-table" class="w-full text-left hidden">
					<thead class="bg-gray-200 dark:bg-gray-700 sticky top-0">
						<tr>
							<th class="p-2">তারিখ</th>
							<th class="p-2">ক্রেতা</th>
							<th class="p-2 text-right">জমা</th>
							<th class="p-2 text-right">বর্তমান বকেয়া</th>
							<th class="p-2 text-center">অ্যাকশন</th>
						</tr>
					</thead>
                    <tbody>
                        <!-- Saved invoice rows go here -->
                    </tbody>
                </table>
                 <p id="no-invoices-message" class="text-center text-gray-500">এখনো কোনো ইনভয়েজ সেভ করা হয়নি।</p>
            </div>
        </div>

    </div>
</div>
<!-- ======================================================== -->
<!-- END: Invoice Tab Content -->
<!-- ======================================================== -->
<!-- ======================================================== -->
<!-- START: Currency Converter Tab Content -->
<!-- ======================================================== -->
<div id="currencyContent" class="calculator-content">
    <div class="converter-section" style="max-width: 500px; margin: 0 auto;">
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">মুদ্রা রূপান্তরকারী (লাইভ)</h3>
        <div class="input-row mb-4">
            <div class="input-wrapper w-full">
                <label class="block mb-1 font-semibold dark:text-gray-300">পরিমাণ</label>
                <input type="number" id="currAmount" value="1" class="unit-input w-full p-2 border rounded dark:bg-gray-700 dark:text-white">
            </div>
        </div>
        <div class="flex gap-2 items-center mb-4">
            <div class="w-1/2">
                <label class="block mb-1 font-semibold dark:text-gray-300">থেকে</label>
                <select id="currFrom" class="unit-select w-full p-2 border rounded dark:bg-gray-700 dark:text-white"></select>
            </div>
            <button id="currSwapBtn" class="mt-6 p-2 rounded-full bg-gray-200 hover:bg-gray-300 dark:bg-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 16V4M7 4L3 8M7 4L11 8M17 8V20M17 20L21 16M17 20L13 16"/></svg>
            </button>
            <div class="w-1/2">
                <label class="block mb-1 font-semibold dark:text-gray-300">তে</label>
                <select id="currTo" class="unit-select w-full p-2 border rounded dark:bg-gray-700 dark:text-white"></select>
            </div>
        </div>
        <button id="convertCurrencyBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mb-4">রূপান্তর করুন</button>
        <div id="currResult" class="p-4 bg-blue-50 dark:bg-gray-800 rounded-lg text-center hidden">
            <p class="text-gray-500 dark:text-gray-400 text-sm mb-1">বিনিময় হার: <span id="currRate">...</span></p>
            <h2 id="currFinalAmount" class="text-2xl font-bold text-blue-700 dark:text-blue-300"></h2>
        </div>
        <p class="text-xs text-center text-gray-400 mt-2">API দ্বারা লাইভ রেট আপডেট করা হয়। ইন্টারনেট সংযোগ প্রয়োজন।</p>
    </div>
</div>
<!-- END: Currency Converter Tab Content -->

<!-- ======================================================== -->
<!-- START: EMI Calculator Tab Content -->
<!-- ======================================================== -->
<div id="emiCalcContent" class="calculator-content">
    <!-- পরিবর্তন: ইনলাইন স্টাইল থেকে ব্যাকগ্রাউন্ড কালার সরিয়ে ক্লাস যোগ করা হয়েছে -->
    <div class="calculator-grid bg-white dark:bg-gray-800" style="max-width: 500px; margin: 0 auto; display: block;">
        <h3 class="text-xl font-bold text-gray-700 mb-6 dark:text-gray-200 text-center">ইএমআই (EMI) ক্যালকুলেটর</h3>
        
        <div class="mb-4">
            <label class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">ঋণের পরিমাণ (টাকা)</label>
            <input type="number" id="emiPrincipal" placeholder="যেমন: 100000" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
        </div>
        
        <div class="mb-4">
            <label class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">সুদের হার (বার্ষিক %)</label>
            <input type="number" id="emiRate" placeholder="যেমন: 9" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
        </div>
        
        <div class="mb-6">
            <label class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">সময়কাল</label>
            <div class="flex gap-2">
                <input type="number" id="emiTenure" placeholder="সময়" class="w-2/3 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                <select id="emiTenureType" class="w-1/3 p-3 border rounded-lg bg-gray-100 dark:bg-gray-600 dark:text-white">
                    <option value="years">বছর</option>
                    <option value="months">মাস</option>
                </select>
            </div>
        </div>

        <button id="calculateEmiBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">হিসাব করুন</button>

        <div id="emiResult" class="mt-6 p-4 bg-indigo-50 dark:bg-gray-700 rounded-lg hidden">
            <div class="text-center mb-4">
                <p class="text-sm text-gray-600 dark:text-gray-300">মাসিক কিস্তি (EMI)</p>
                <h2 id="emiMonthly" class="text-3xl font-bold text-indigo-700 dark:text-indigo-300">৳ ০</h2>
            </div>
            <div class="grid grid-cols-2 gap-4 text-sm border-t border-gray-300 dark:border-gray-600 pt-4">
                <div>
                    <p class="text-gray-500 dark:text-gray-400">মোট সুদ</p>
                    <p id="emiTotalInterest" class="font-bold text-gray-800 dark:text-white">৳ ০</p>
                </div>
                <div class="text-right">
                    <p class="text-gray-500 dark:text-gray-400">মোট পরিশোধ</p>
                    <p id="emiTotalPayment" class="font-bold text-gray-800 dark:text-white">৳ ০</p>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- END: EMI Calculator Tab Content -->

<!-- START: IP & Device Info Tab Content -->
<!-- ======================================================== -->
<div id="ipInfoContent" class="calculator-content">
    <div class="settings-page-container">
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">আমার আইপি এবং ডিভাইস ইনফো</h3>
        
        <div id="ipLoading" class="text-center py-8">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-2 text-gray-500">তথ্য লোড হচ্ছে...</p>
        </div>

        <!-- ইরর মেসেজ দেখানোর জন্য নতুন div -->
        <div id="ipErrorDisplay" class="hidden p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400" role="alert"></div>

        <div id="ipInfoResult" class="hidden">
            <!-- IP Info Card -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4 border-l-4 border-blue-500">
                <h4 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-2">নেটওয়ার্ক তথ্য</h4>
                <div class="space-y-2">
                    <div class="flex justify-between border-b dark:border-gray-700 pb-1">
                        <span class="text-gray-500">IP Address:</span>
                        <span id="infoIp" class="font-mono font-bold text-blue-600 dark:text-blue-400">...</span>
                    </div>
                    <div class="flex justify-between border-b dark:border-gray-700 pb-1">
                        <span class="text-gray-500">ISP:</span>
                        <span id="infoIsp" class="font-medium dark:text-gray-200">...</span>
                    </div>
                    <div class="flex justify-between border-b dark:border-gray-700 pb-1">
                        <span class="text-gray-500">Location:</span>
                        <span id="infoLoc" class="font-medium dark:text-gray-200">...</span>
                    </div>
                </div>
            </div>

            <!-- Device Info Card -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 border-l-4 border-green-500">
                <h4 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-2">ডিভাইস তথ্য</h4>
                <div class="space-y-2">
                    <div class="flex justify-between border-b dark:border-gray-700 pb-1">
                        <span class="text-gray-500">OS:</span>
                        <span id="infoOs" class="font-medium dark:text-gray-200">...</span>
                    </div>
                    <div class="flex justify-between border-b dark:border-gray-700 pb-1">
                        <span class="text-gray-500">Browser:</span>
                        <span id="infoBrowser" class="font-medium dark:text-gray-200">...</span>
                    </div>
                    <div class="flex justify-between border-b dark:border-gray-700 pb-1">
                        <span class="text-gray-500">Screen Res:</span>
                        <span id="infoRes" class="font-mono dark:text-gray-200">...</span>
                    </div>
                    <div class="flex justify-between pb-1">
                        <span class="text-gray-500">User Agent:</span>
                    </div>
                    <p id="infoUa" class="text-xs text-gray-400 break-all bg-gray-100 dark:bg-gray-900 p-2 rounded">...</p>
                </div>
            </div>
        </div>
        <button id="refreshIpBtn" class="mt-4 w-full py-2 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:text-white rounded-lg transition">তথ্য রিফ্রেশ করুন</button>
    </div>
</div>
<!-- END: IP & Device Info Tab Content -->

<!-- START: Recipe Generator Tab Content -->
<!-- ======================================================== -->
<div id="recipeContent" class="calculator-content">
    <div class="text-assistant-content">
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">🍽️ এআই রেসিপি জেনারেটর</h3>
        <p class="text-sm text-gray-500 mb-4 dark:text-gray-400">আপনার ঘরে থাকা উপকরণগুলোর নাম লিখুন, জেমিনি আপনাকে একটি মজাদার রেসিপি তৈরি করে দেবে।</p>
        
        <textarea id="recipeInput" rows="3" class="w-full p-3 border rounded-lg mb-4 dark:bg-gray-700 dark:text-white" placeholder="উদাহরণ: আলু, ডিম, পেঁয়াজ, টমেটো..."></textarea>
        
        <button id="generateRecipeBtn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg flex justify-center items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>
            রেসিপি তৈরি করুন
        </button>

        <div id="recipeLoading" class="hidden mt-6 text-center">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600 mb-2"></div>
            <p class="text-orange-600 font-semibold animate-pulse">শেফ রেসিপি ভাবছেন... 🍳</p>
        </div>
        
        <div id="recipeResult" class="result-area mt-4 hidden bg-white dark:bg-gray-800 p-4 rounded-lg border border-orange-200 dark:border-gray-600 text-left">
            <!-- Recipe content here -->
        </div>
    </div>
</div>
<!-- END: Recipe Generator Tab Content -->

<!-- START: PDF Tools Tab Content -->
<!-- ======================================================== -->
<div id="pdfToolsContent" class="calculator-content">
    <div class="image-to-text-content"> <!-- Reuse existing styling -->
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">ছবি থেকে পিডিএফ (Image to PDF)</h3>
        
        <div id="pdfDropZone" class="image-upload-area mb-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors cursor-pointer relative">
            <label for="pdfImageInput" class="image-upload-label cursor-pointer w-full h-full block">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-500 mx-auto mb-2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                <span>ছবি নির্বাচন করুন বা ড্র্যাগ করে আনুন</span>
            </label>
            <input type="file" id="pdfImageInput" accept="image/*" multiple class="hidden">
        </div>

        <div id="pdfPreviewArea" class="grid grid-cols-3 sm:grid-cols-4 gap-3 mb-4">
            <!-- Previews with remove buttons will go here -->
        </div>

        <button id="generatePdfBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            পিডিএফ তৈরি ও ডাউনলোড করুন
        </button>
    </div>
</div>
<!-- END: PDF Tools Tab Content -->

<!-- নতুন: রঙ বাছাইকারী ট্যাব -->
<div id="colorPickerContent" class="calculator-content">
    <div class="color-picker-container">
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">রঙ বাছাইকারী (Color Picker)</h3>
        <p class="text-gray-600 dark:text-gray-400 mb-6">ওয়েব ডেভেলপার এবং ডিজাইনারদের জন্য একটি সহায়ক টুল। রঙ বাছাই করুন এবং HEX, RGB ও HSL কোডের মধ্যে রূপান্তর করুন।</p>
        <div class="color-picker-main">
            <div class="color-picker-controls">
                <label for="colorPickerInput" class="color-picker-label">রঙ বাছাই করুন</label>
                <input type="color" id="colorPickerInput" value="#3b82f6">
            </div>
            <div id="colorPreview" class="color-preview"></div>
        </div>
        <div class="color-values">
            <!-- HEX -->
            <div class="color-value-group">
                <label for="hexValue">HEX</label>
                <div class="input-with-button">
                    <input type="text" id="hexValue" readonly>
                    <button class="copy-color-btn" data-target="hexValue">কপি</button>
                </div>
            </div>
            <!-- RGB -->
            <div class="color-value-group">
                <label for="rgbValue">RGB</label>
                <div class="input-with-button">
                    <input type="text" id="rgbValue" readonly>
                    <button class="copy-color-btn" data-target="rgbValue">কপি</button>
                </div>
            </div>
            <!-- HSL -->
            <div class="color-value-group">
                <label for="hslValue">HSL</label>
                <div class="input-with-button">
                    <input type="text" id="hslValue" readonly>
                    <button class="copy-color-btn" data-target="hslValue">কপি</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ======================================================== -->
<!-- START: Screen Recorder Content -->
<!-- ======================================================== -->
<div id="screenRecorderContent" class="calculator-content">
    <div class="text-assistant-content">
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">🎥 স্ক্রিন রেকর্ডার</h3>
        <p class="text-sm text-gray-500 mb-4 dark:text-gray-400">আপনার স্ক্রিন রেকর্ড করুন এবং ভিডিও ডাউনলোড করুন। (অডিও সহ বা ছাড়া)</p>
        
        <div class="flex flex-col items-center gap-4">
            <div class="flex gap-4">
                <button id="startRecordBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></svg>
                    রেকর্ডিং শুরু
                </button>
                <button id="stopRecordBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg flex items-center gap-2" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="6" width="12" height="12"></rect></svg>
                    থামান
                </button>
            </div>
            
            <video id="recordingPreview" class="w-full max-w-2xl bg-black rounded-lg hidden" controls></video>
            <a id="downloadVideoBtn" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">ভিডিও ডাউনলোড করুন</a>
        </div>
    </div>
</div>
<!-- END: Screen Recorder Content -->

<!-- ======================================================== -->
<!-- START: JSON Formatter Content -->
<!-- ======================================================== -->
<div id="jsonFormatterContent" class="calculator-content">
    <div class="translator-content"> <!-- Reusing styling -->
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">E JSON ফর্মাটার ও ভ্যালিডেটর</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">ইনপুট (অগোছালো JSON):</label>
                <textarea id="jsonInput" rows="12" class="w-full p-3 border rounded-lg font-mono text-sm dark:bg-gray-700 dark:text-white" placeholder='{"name":"Bangla Toolbox","type":"Utility"}'></textarea>
            </div>
            <div>
                <label class="block mb-2 font-semibold text-gray-700 dark:text-gray-300">আউটপুট (সাজানো JSON):</label>
                <textarea id="jsonOutput" rows="12" class="w-full p-3 border rounded-lg font-mono text-sm bg-gray-50 dark:bg-gray-800 dark:text-green-400" readonly></textarea>
            </div>
        </div>

        <div class="flex flex-wrap gap-3 mt-4 justify-center">
            <button id="formatJsonBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">ফরম্যাট (সুন্দর)</button>
            <button id="minifyJsonBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">মিনিফাই (এক লাইনে)</button>
            <button id="copyJsonBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">কপি করুন</button>
            <button id="clearJsonBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">মুছুন</button>
        </div>
    </div>
</div>
<!-- END: JSON Formatter Content -->

<!-- ======================================================== -->
<!-- START: Meme Generator Content -->
<!-- ======================================================== -->
<div id="memeGenContent" class="calculator-content">
    <div class="image-resizer-controls">
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">😂 মিম জেনারেটর</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="flex flex-col gap-4">
                <!-- ইমেজ আপলোড এরিয়া -->
                <div class="image-upload-area p-4 border-2 border-dashed border-gray-300 rounded-lg text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                    <label for="memeImageInput" class="cursor-pointer block">
                        <span class="text-gray-500 dark:text-gray-400">ছবি আপলোড করুন (Template)</span>
                    </label>
                    <input type="file" id="memeImageInput" accept="image/*" class="hidden">
                </div>
                
                <!-- টেক্সট ইনপুট এবং কন্ট্রোলস -->
                <div class="flex flex-col gap-3">
                    <textarea id="memeTextInput" rows="3" placeholder="এখানে টেক্সট লিখুন..." class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white resize-y" style="min-height:60px;"></textarea>
                    
                    <div class="flex gap-2 flex-wrap items-end">
                        <div class="flex-1 min-w-[80px]">
                            <label class="block text-xs mb-1 dark:text-gray-300">ফন্ট সাইজ</label>
                            <input type="number" id="memeFontSize" value="40" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white">
                        </div>
                        <!-- ফিল কালার সেকশন আপডেট -->
                        <div class="flex-1 min-w-[100px]">
                            <label class="block text-xs mb-1 dark:text-gray-300">ফিল কালার</label>
                            <div class="flex items-center gap-2">
                                <input type="color" id="memeTextColor" value="#ffffff" class="w-10 h-10 p-0 border rounded cursor-pointer">
                                <label class="flex items-center gap-1 text-xs cursor-pointer select-none text-gray-700 dark:text-gray-300">
                                    <input type="checkbox" id="memeNoFill" class="w-4 h-4 text-blue-600 rounded">
                                    ফিল নেই
                                </label>
                            </div>
                        </div>
                        <div class="flex-1 min-w-[100px]">
                            <label class="block text-xs mb-1 dark:text-gray-300">বর্ডার কালার</label>
                            <div class="flex items-center gap-2">
                                <input type="color" id="memeBorderColor" value="#000000" class="w-10 h-10 p-0 border rounded cursor-pointer">
                                <label class="flex items-center gap-1 text-xs cursor-pointer select-none text-gray-700 dark:text-gray-300">
                                    <input type="checkbox" id="memeNoBorder" class="w-4 h-4 text-blue-600 rounded">
                                    বর্ডার নেই
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- অ্যালাইনমেন্ট বাটন -->
                    <div class="flex gap-2 justify-center bg-gray-100 dark:bg-gray-700 p-2 rounded">
                        <button id="alignLeftBtn" class="p-2 hover:bg-gray-300 dark:hover:bg-gray-600 rounded" title="বামে">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="17" y1="10" x2="3" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="17" y1="18" x2="3" y2="18"></line></svg>
                        </button>
                        <button id="alignCenterBtn" class="p-2 bg-gray-300 dark:bg-gray-500 rounded" title="মাঝে">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="10" x2="6" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="18" y1="18" x2="6" y2="18"></line></svg>
                        </button>
                        <button id="alignRightBtn" class="p-2 hover:bg-gray-300 dark:hover:bg-gray-600 rounded" title="ডানে">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="21" y1="10" x2="7" y2="10"></line><line x1="21" y1="6" x2="3" y2="6"></line><line x1="21" y1="14" x2="3" y2="14"></line><line x1="21" y1="18" x2="7" y2="18"></line></svg>
                        </button>
                    </div>

                    <!-- শেপ ইনসার্ট বাটন -->
                    <div class="flex gap-2 justify-center bg-gray-100 dark:bg-gray-700 p-2 rounded">
                        <button id="addRectBtn" class="p-2 hover:bg-gray-300 dark:hover:bg-gray-600 rounded" title="চতুর্ভূজ">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
                        </button>
                        <button id="addCircleBtn" class="p-2 hover:bg-gray-300 dark:hover:bg-gray-600 rounded" title="বৃত্ত">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle></svg>
                        </button>
                        <button id="addTriangleBtn" class="p-2 hover:bg-gray-300 dark:hover:bg-gray-600 rounded" title="ত্রিভুজ">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path></svg>
                        </button>
                        <button id="addStarBtn" class="p-2 hover:bg-gray-300 dark:hover:bg-gray-600 rounded" title="স্টার">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                        </button>
                    </div>

                    <div class="flex gap-2">
                        <button id="addMemeTextBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg font-bold flex-1 transition-colors">টেক্সট যোগ করুন</button>
                        <button id="cancelMemeEditBtn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg font-bold hidden transition-colors">বাতিল</button>
                    </div>
                    
                    <label class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-lg font-bold w-full text-center cursor-pointer transition-colors mt-2">
                        অতিরিক্ত ছবি যোগ করুন (Overlay)
                        <input type="file" id="memeOverlayInput" accept="image/*" class="hidden">
                    </label>

                    <!-- ব্রাশ টুল এবং আনডু/রিডু কন্ট্রোল -->
                    <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded border border-gray-200 dark:border-gray-600 mt-2">
                        <div class="flex items-center justify-between mb-2">
                            <button id="memeBrushToggleBtn" class="flex-1 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white px-3 py-2 rounded font-bold hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13.5c0 2.2-2 5.5-6 5.5s-6-3.3-6-5.5a6 6 0 0 1 12 0Z"/><path d="M12 8a6 6 0 0 0-6 6"/><path d="M12 2v6"/><path d="m16.2 3.8-1.4 1.4"/><path d="m7.8 3.8 1.4 1.4"/></svg>
                                <span>ব্রাশ মোড</span>
                            </button>
                            <!-- আনডু এবং রিডু বাটন গ্রুপ -->
                            <div class="flex ml-2 gap-2">
                                <button id="memeUndoBtn" class="bg-red-100 dark:bg-red-900/50 text-red-600 dark:text-red-300 px-3 py-2 rounded hover:bg-red-200 dark:hover:bg-red-900 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="আনডু (Undo)" disabled>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>
                                </button>
                                <button id="memeRedoBtn" class="bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-300 px-3 py-2 rounded hover:bg-blue-200 dark:hover:bg-blue-900 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="রিডু (Redo)" disabled>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"/></svg>
                                </button>
                            </div>
                        </div>
                        
                        <div id="memeBrushSettings" class="hidden flex gap-2">
                            <div class="flex-1">
                                <label class="block text-xs mb-1 dark:text-gray-300">ব্রাশ কালার</label>
                                <input type="color" id="memeBrushColor" value="#ff0000" class="w-full h-8 p-0 border rounded cursor-pointer">
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs mb-1 dark:text-gray-300">ব্রাশ সাইজ: <span id="memeBrushSizeVal">5</span></label>
                                <input type="range" id="memeBrushSize" min="1" max="50" value="5" class="w-full">
                            </div>
                        </div>
                    </div>

                    <p class="text-xs text-gray-500 text-center mt-2">টিপস: টেক্সট এ ডাবল ক্লিক করে এডিট করুন। ক্যানভাসে ড্র্যাগ করে সরান। সিলেক্ট করে ডিলিট চাপলে মুছে যাবে।</p>
                </div>

                <button id="downloadMemeBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg disabled:opacity-50 transition-colors" disabled>মিম ডাউনলোড করুন</button>
            </div>
            
            <!-- ক্যানভাস প্রিভিউ এরিয়া -->
            <div class="flex items-center justify-center bg-gray-100 dark:bg-gray-800 rounded-lg p-2 min-h-[300px] overflow-hidden">
                <canvas id="memeCanvas" class="max-w-full h-auto shadow-lg touch-none"></canvas>
                <p id="memePlaceholderText" class="text-gray-400">প্রিভিউ এখানে দেখা যাবে</p>
            </div>
        </div>
    </div>
</div>
<!-- ======================================================== -->
<!-- END: Meme Generator Content -->
<!-- ======================================================== -->

<!-- ======================================================== -->
<!-- START: Internet Speed Test Content -->
<!-- ======================================================== -->
<div id="speedTestContent" class="calculator-content">
    <div class="donate-section"> <!-- Reusing styling -->
        <h3 class="text-xl font-bold text-gray-700 mb-6 dark:text-gray-200">🚀 ইন্টারনেট স্পিড টেস্ট</h3>
        
        <!-- Grid updated to 2 columns on small screens, 4 on medium+ -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-center">
            <!-- Download Speed -->
            <div class="p-4 bg-blue-50 dark:bg-gray-800 rounded-xl border border-blue-100 dark:border-gray-600">
                <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">DOWNLOAD</div>
                <div id="dlSpeed" class="text-2xl font-bold text-blue-600">0.00</div>
                <div class="text-xs text-gray-400">Mbps</div>
            </div>
            
            <!-- Upload Speed (New) -->
            <div class="p-4 bg-orange-50 dark:bg-gray-800 rounded-xl border border-orange-100 dark:border-gray-600">
                <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">UPLOAD</div>
                <div id="ulSpeed" class="text-2xl font-bold text-orange-600">0.00</div>
                <div class="text-xs text-gray-400">Mbps</div>
            </div>

            <!-- Ping -->
            <div class="p-4 bg-purple-50 dark:bg-gray-800 rounded-xl border border-purple-100 dark:border-gray-600">
                <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">PING</div>
                <div id="pingSpeed" class="text-2xl font-bold text-purple-600">0</div>
                <div class="text-xs text-gray-400">ms</div>
            </div>

            <!-- Status -->
            <div class="p-4 bg-green-50 dark:bg-gray-800 rounded-xl border border-green-100 dark:border-gray-600">
                <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">STATUS</div>
                <div id="speedStatus" class="text-lg font-bold text-green-600">Ready</div>
            </div>
        </div>

        <div class="relative w-40 h-40 mx-auto mb-6 flex items-center justify-center">
            <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="45" fill="none" stroke="#e5e7eb" stroke-width="8" />
                <circle id="speedProgress" cx="50" cy="50" r="45" fill="none" stroke="#2563eb" stroke-width="8" stroke-dasharray="283" stroke-dashoffset="283" class="transition-all duration-300" />
            </svg>
            <div class="absolute inset-0 flex items-center justify-center">
                <button id="startSpeedTestBtn" class="w-24 h-24 rounded-full bg-blue-600 hover:bg-blue-700 text-white font-bold shadow-lg hover:shadow-blue-500/50 transition-all flex flex-col items-center justify-center">
                    <span>GO</span>
                </button>
            </div>
        </div>
        <p class="text-xs text-gray-400">দ্রষ্টব্য: এটি ব্রাউজার ভিত্তিক টেস্ট, প্রকৃত স্পিড সামান্য কম-বেশি হতে পারে।</p>
    </div>
</div>
<!-- END: Internet Speed Test Content -->

<!-- Start Dashboard Content -->
<div id="dashboardContent" class="calculator-content">
    <div class="p-4 md:p-6">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">আপনার কাস্টম ড্যাশবোর্ড</h3>
        <p class="text-gray-600 dark:text-gray-400 mb-4">আপনার সবচেয়ে বেশি ব্যবহৃত টুলগুলোকে এখানে ড্র্যাগ করে এনে সাজিয়ে রাখুন। ড্যাশবোর্ড থেকে সরাতে চাইলে আইটেমের উপরের ডানদিকের 'x' বাটনে ক্লিক করুন।</p>
        <div id="dashboard-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 p-4 min-h-[200px] bg-gray-100 dark:bg-gray-700/50 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600 transition-colors duration-300">
            <!-- Draggable items will be dropped here -->
        </div>
    </div>
</div>
<!-- End Dashboard Content -->


<!-- START: Image Resizer Tab Content (ছবি রিসাইজার) -->
<!-- ======================================================== -->
<div id="imageResizerContent" class="calculator-content">
    
    <!-- START: Preview Section (Moved to top) -->
    <div class="image-resizer-preview grid grid-cols-1 sm:grid-cols-2 gap-4 p-4">
        <!-- আসল ছবির প্রিভিউ কন্টেইনার -->
        <div class="preview-box">
            <h4 class="preview-title">আসল ছবি</h4>
            <div id="originalPreviewContainer" class="image-container relative group">
                <img id="originalPreview" src="https://placehold.co/400x300/e0e7ff/3f51b5?text=Original+Image" alt="Original" class="transition-opacity duration-200">
                <!-- নতুন: Remove Button -->
                <button id="removeOriginalBtn" class="absolute top-2 right-2 z-10 w-8 h-8 bg-red-500 text-white rounded-full shadow-md flex items-center justify-center text-xl font-bold opacity-0 pointer-events-none group-hover:opacity-100 group-[.has-image]:pointer-events-auto transition-opacity duration-200" title="ছবি সরান">
                    &times;
                </button>
            </div>
            <div class="file-info-box">
                <p>সাইজ: <span id="originalSize">N/A</span></p>
                <p>ডাইমেনশন: <span id="originalDimensions">N/A</span></p>
            </div>
        </div>
        <!-- প্রসেসড ছবির প্রিভিউ কন্টেইনার -->
        <div class="preview-box">
            <h4 class="preview-title">প্রসেসড ছবি</h4>
             <div class="image-container">
                <img id="processedPreview" src="https://placehold.co/400x300/dcfce7/166534?text=Processed+Image" alt="Processed">
            </div>
            <div class="file-info-box">
                <p>সাইজ: <span id="processedSize">N/A</span></p>
                <p>ডাইমেনশন: <span id="processedDimensions">N/A</span></p>
            </div>
        </div>
    </div>
    <!-- END: Preview Section -->

    <!-- START: Controls Section (Moved to bottom) -->
    <div class="image-resizer-controls p-4">
        
        <!-- Controls Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

            <!-- Column 1: Upload & Resize -->
            <div class="flex flex-col gap-6">
                <!-- Image Upload -->
                <div class="control-section mt-0"> <!-- mt-0 for first item -->
                    <h4 class="control-title">ছবি আপলোড করুন</h4>
                    <div id="image-drop-zone" class="image-upload-area mb-0"> <!-- mb-0 to remove extra space -->
                        <label for="imageUploadInput" class="image-upload-label">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 mb-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h10a4 4 0 014 4v5a4 4 0 01-4 4H7z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 16v4a2 2 0 01-2 2H6a2 2 0 01-2-2v-4m12-4l-4-4-4 4m4 4v-4"></path></svg>
                            <span>ছবি আপলোড করুন বা এখানে টেনে আনুন</span>
                        </label>
                        <input type="file" id="imageUploadInput" accept="image/png, image/jpeg, image/webp" class="hidden">
                    </div>
                </div>

                <!-- Resize Options -->
                <div class="control-section">
                    <h4 class="control-title">রিসাইজ অপশন</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="input-group">
                            <label for="widthInput">প্রস্থ (px)</label>
                            <input type="number" id="widthInput" class="resizer-input">
                        </div>
                        <div class="input-group">
                            <label for="heightInput">উচ্চতা (px)</label>
                            <input type="number" id="heightInput" class="resizer-input">
                        </div>
                    </div>
                    <div class="flex items-center mt-2">
                        <input type="checkbox" id="aspectRatioLock" class="h-4 w-4" checked>
                        <label for="aspectRatioLock" class="ml-2 text-sm text-gray-600 dark:text-gray-300">অনুপাত ঠিক রাখুন</label>
                    </div>
                </div>
            </div>

            <!-- Column 2: Format & Adjust -->
            <div class="flex flex-col gap-6">
                <!-- Compress & Format Options -->
                <div class="control-section mt-0"> <!-- mt-0 for first item -->
                    <h4 class="control-title">কম্প্রেস ও ফরম্যাট</h4>
                    <div class="input-group">
                        <label for="qualitySlider">কোয়ালিটি: <span id="qualityValue">90</span>%</label>
                        <input type="range" id="qualitySlider" min="1" max="100" value="90" class="w-full">
                    </div>
                    <div class="input-group mt-4">
                        <label for="formatSelect">ফরম্যাট পরিবর্তন</label>
                        <select id="formatSelect" class="resizer-input">
                            <option value="image/jpeg">JPG</option>
                            <option value="image/png">PNG</option>
                            <option value="image/webp">WEBP</option>
                        </select>
                    </div>
                </div>

                <!-- ছবি অ্যাডজাস্টমেন্ট -->
                <div class="control-section">
                    <h4 class="control-title">ছবি অ্যাডজাস্টমেন্ট</h4>
                    <!-- Rotation -->
                    <div class="mb-4">
                        <label class="block text-sm text-gray-600 dark:text-gray-300 mb-2">রোটেট (Rotate)</label>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">রোটেট বা ফ্লিপ করার জন্য প্রথমে "ক্রপ মোড" চালু করুন।</p>
                        <div class="grid grid-cols-4 gap-2">
                            <button id="rotateLeftBtn" title="Rotate -90°" class="p-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M6.354 1.146a.5.5 0 0 1 0 .708L3.207 5H6a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-.5.5H5a.5.5 0 0 1-.5-.5V6H2.5a.5.5 0 0 1-.354-.854l3-3a.5.5 0 0 1 .554-.146zM8.707 6.5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M12.354 10.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-3-3a.5.5 0 1 1 .708-.708L8.5 12.793V6.5a.5.5 0 0 1 1 0v6.293l2.146-2.147a.5.5 0 0 1 .708 0z"/></svg>
                            </button>
                            <button id="rotateRightBtn" title="Rotate +90°" class="p-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M9.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708-.708L11.793 5H6a.5.5 0 0 1-.5-.5v-1A.5.5 0 0 1 6 3h.5a.5.5 0 0 1 .5.5v1h4.793L9.646 2.854a.5.5 0 0 1 0-.708z"/><path d="M7.293 10a.5.5 0 0 1 .707 0l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.707-.708L8.793 15H4a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h.5a.5.5 0 0 1 .5.5v1h4.793L7.293 11a.5.5 0 0 1 0-1z"/></svg>
                            </button>
                            <button id="flipHorizontalBtn" title="Flip Horizontal" class="p-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0M2.854 3.146a.5.5 0 0 1 0 .708L.707 6H2.5a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5H.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 0 1 .708 0m10.292 0a.5.5 0 0 0 0 .708L15.293 6H13.5a.5.5 0 0 0-.5.5v2a.5.5 0 0 0 .5.5h1.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708 0"/>
<path fill-rule="evenodd" d="M8.5 3a.5.5 0 0 0-1 0v10a.5.5 0 0 0 1 0z"/></svg>
                            </button>
                            <button id="flipVerticalBtn" title="Flip Vertical" class="p-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0M3.146 2.854a.5.5 0 0 1 .708 0L6 4.293V2.5a.5.5 0 0 1 1 0v1.793l2.146-2.147a.5.5 0 0 1 .708.708l-3 3a.5.5 0 0 1-.708 0l-3-3a.5.5 0 0 1 0-.708M3.146 13.146a.5.5 0 0 0 .708 0L6 11.707v1.793a.5.5 0 0 0 1 0v-1.793l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3a.5.5 0 0 0-.708 0l-3 3a.5.5 0 0 0 0 .708"/>
<path fill-rule="evenodd" d="M3 7.5a.5.5 0 0 0 0 1h10a.5.5 0 0 0 0-1z"/></svg>
                            </button>
                        </div>
                    </div>
                    <!-- Brightness -->
                    <div class="input-group mb-4">
                        <label for="brightnessSlider">ব্রাইটনেস: <span id="brightnessValue">100</span>%</label>
                        <input type="range" id="brightnessSlider" min="0" max="200" value="100" class="w-full" disabled>
                    </div>
                    <!-- Contrast -->
                    <div class="input-group">
                        <label for="contrastSlider">কনট্রাস্ট: <span id="contrastValue">100</span>%</label>
                        <input type="range" id="contrastSlider" min="0" max="200" value="100" class="w-full" disabled>
                    </div>
                </div>
            </div>

            <!-- Column 3: History & Actions -->
            <div class="flex flex-col gap-6">
                <!-- History section will be dynamically added here by JS -->

                <!-- ক্রপ বাটন -->
                <div class="control-section mt-0"> <!-- mt-0 for first item -->
                     <h4 class="control-title">ক্রপ</h4>
                    <button id="cropToggleBtn" class="crop-toggle-btn" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6.13 1L6 16a2 2 0 0 0 2 2h15"></path><path d="M1 6.13L16 6a2 2 0 0 1 2 2v15"></path></svg>
                        <span>ক্রপ মোড</span>
                    </button>
                </div>

                <!-- Download Button -->
                <div class="control-section">
                    <h4 class="control-title">ফলাফল</h4>
                    <button id="downloadBtn" class="download-btn" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
                        <span>প্রসেস ও ডাউনলোড করুন</span>
                    </button>
                </div>
            </div>

        </div>
    </div>
    <!-- END: Controls Section -->

</div>
<!-- END: Image Resizer Tab Content -->
<!-- ======================================================== -->


<!-- ======================================================== -->
<!-- START: আরও সেটিংস ট্যাব (More Settings) -->
<!-- ======================================================== -->
<div id="moreSettingsContent" class="calculator-content">
    <div class="settings-page-container">
        <h3 class="text-xl font-bold text-gray-700 mb-6 dark:text-gray-200">সেটিংস সমূহ</h3> 

<!-- লাইভ ক্রিকেট লিংক বক্স (আপডেটেড) -->
        <div class="setting-item mb-4">
            <div class="w-full">
                <label for="cricketUrlInput" class="font-semibold text-gray-700 dark:text-gray-300 flex items-center gap-2">
                    🏏 লাইভ ক্রিকেট স্কোর সেটআপ
                    <span class="text-xs font-normal text-gray-500 bg-gray-200 dark:bg-gray-700 px-2 py-0.5 rounded">Beta</span>
                </label>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">হোমপেজের টিকার চালু করতে Crex.com এর ম্যাচ লিংক এখানে পেস্ট করে 'সেভ করুন' চাপুন। লিংক মুছে দিলে টিকার বন্ধ হয়ে যাবে।</p>
                <div class="flex gap-2">
                    <input type="text" id="cricketUrlInput" placeholder="https://crex.live/scoreboard/..." class="flex-grow p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white focus:ring-2 focus:ring-indigo-500 text-sm">
                    <button id="saveCricketBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">
                        সেভ করুন
                    </button>
                    <!-- নতুন: মুছুন বাটন -->
                    <button id="clearCricketBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors">
                        মুছুন
                    </button>
                </div>
            </div>
        </div>
		
        <!-- জেমিনি API কী সেটিং -->
        <div class="setting-item">
            <div class="setting-text" style="flex-grow: 1; margin-right: 15px;">
                <label for="settingsApiKeyInput" class="font-semibold text-gray-700 dark:text-gray-300">জেমিনি API কী</label>
                <p class="text-sm text-gray-500 dark:text-gray-400">এআই ফিচার ব্যবহারের জন্য এখানে আপনার API কী সেভ করুন।</p>
                <div class="flex gap-2 mt-2">
                    <input type="text" id="settingsApiKeyInput" placeholder="AIzaSy..." class="flex-grow p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white focus:ring-2 focus:ring-indigo-500 text-sm">
                    <button id="saveSettingsApiKeyBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded text-sm">
                        সেভ
                    </button>
                </div>
            </div>
        </div>

        <!-- জেমিনি মডেল সিলেকশন -->
        <div class="setting-item">
            <div class="setting-text" style="flex-grow: 1; margin-right: 15px;">
                <label for="settingsGeminiModel" class="font-semibold text-gray-700 dark:text-gray-300">জেমিনি মডেল</label>
                <p class="text-sm text-gray-500 dark:text-gray-400">অ্যাপের সকল ফিচারের জন্য ডিফল্ট এআই মডেল নির্বাচন করুন।</p>
                <select id="settingsGeminiModel" class="w-full mt-2 p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white focus:ring-2 focus:ring-indigo-500">
					<option value="gemini-flash-latest">Gemini Flash Latest (Stable, Recommended)</option>
                     <option value="gemini-3-flash-preview">Gemini 3 Flash Preview</option>
                    <option value="gemini-2.5-flash-preview-tts">লেখা থেকে কথা স্পেশাল (tts only)</option>
					<option value="gemini-2.5-flash-preview-09-2025">Gemini 2.5 Flash Preview</option>
					<option value="gemini-2.0-flash">Flash 2.0</option>
                </select>
            </div>
        </div>

        <!-- Google সার্চ টগল (নতুন) -->
        <div class="setting-item">
            <div class="setting-text">
                <label for="settingsGoogleSearchToggle" class="font-semibold text-gray-700 dark:text-gray-300">Google সার্চ</label>
                <p class="text-sm text-gray-500 dark:text-gray-400">জেমিনিকে প্রশ্ন করার সময় Google থেকে লেটেস্ট তথ্য নিবে।</p>
            </div>
            <label class="switch">
                <input type="checkbox" id="settingsGoogleSearchToggle" checked>
                <span class="slider round"></span>
            </label>
        </div>

        <!-- সময় এবং তারিখ ব্যানার টগল -->
        <div class="setting-item" style="margin-top: 15px;">
            <div class="setting-text">
                <label for="timeBannerToggle" class="font-semibold text-gray-700 dark:text-gray-300">সময় এবং তারিখ ব্যানার</label>
                <p class="text-sm text-gray-500 dark:text-gray-400">হোমপেজের উপরের সময় এবং তারিখ ব্যানারটি চালু বা বন্ধ করুন।</p>
            </div>
            <label class="switch">
                <input type="checkbox" id="timeBannerToggle" checked>
                <span class="slider round"></span>
            </label>
        </div>
		
<!-- নতুন: অনলাইন তারিখ আপডেট সেটিংস (সাময়িকভাবে বন্ধ রাখা হয়েছে) -->
<!--
        <div class="setting-item">
            <div class="setting-text" style="flex-grow: 1; margin-right: 15px;">
                <label class="font-semibold text-gray-700 dark:text-gray-300">অনলাইন তারিখ আপডেট</label>
                <p class="text-sm text-gray-500 dark:text-gray-400">অনলাইন থেকে তারিখ আপডেট করুন। (মাসের শেষ ও শুরুতে অটোমেটিক চেক করবে)</p>
                <div class="flex gap-2 mt-2 items-center">
                    <button id="refreshDateBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded text-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/></svg>
                        এখনই রিফ্রেশ করুন
                    </button>
                </div>
            </div>
            <div class="flex flex-col items-center">
                <label for="autoUpdateDateToggle" class="text-xs font-semibold text-gray-500 mb-1">অটো আপডেট</label>
                <label class="switch">
                    <input type="checkbox" id="autoUpdateDateToggle">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>
-->

        <!-- NEW: হিজরি তারিখ অ্যাডজাস্টার -->
        <div class="setting-item">
            <div class="setting-text" style="flex-grow: 1; margin-right: 15px;">
                <label for="hijriDateAdjustInput" class="font-semibold text-gray-700 dark:text-gray-300">হিজরি তারিখ অ্যাডজাস্টার</label>
                <p class="text-sm text-gray-500 dark:text-gray-400">হিজরি তারিখ ১-২ দিন কম/বেশি করতে এখানে সংখ্যা লিখুন (যেমন: -1 বা 1)। ডিফল্ট: -2</p>
                <div class="flex gap-2 mt-2">
                    <input type="number" id="hijriDateAdjustInput" placeholder="-2" class="flex-grow p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white focus:ring-2 focus:ring-indigo-500 text-sm">
                    <button id="saveHijriAdjustBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded text-sm">সেভ</button>
                </div>
            </div>
        </div>

        <!-- NEW: বাংলা তারিখ অ্যাডজাস্টার -->
        <div class="setting-item">
            <div class="setting-text" style="flex-grow: 1; margin-right: 15px;">
                <label for="bengaliDateAdjustInput" class="font-semibold text-gray-700 dark:text-gray-300">বাংলা তারিখ অ্যাডজাস্টার</label>
                <p class="text-sm text-gray-500 dark:text-gray-400">বাংলা তারিখ ১ দিন কম/বেশি করতে এখানে সংখ্যা লিখুন (যেমন: -1 বা 1)। ডিফল্ট: 0</p>
                <div class="flex gap-2 mt-2">
                    <input type="number" id="bengaliDateAdjustInput" placeholder="0" class="flex-grow p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white focus:ring-2 focus:ring-indigo-500 text-sm">
                    <button id="saveBengaliAdjustBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded text-sm">সেভ</button>
                </div>
            </div>
        </div>		

        <!-- নিউজ টিকার অন/অফ টগল -->
        <div class="setting-item" style="margin-top: 15px;">
            <div class="setting-text">
                <label for="newsTickerToggle" class="font-semibold text-gray-700 dark:text-gray-300">নিউজ টিকার</label>
                <p class="text-sm text-gray-500 dark:text-gray-400">নিউজ টিকারটি চালু বা বন্ধ করুন।</p>
            </div>
            <label class="switch">
                <input type="checkbox" id="newsTickerToggle" checked>
                <span class="slider round"></span>
            </label>
        </div>
		
        <!-- নিউজ এনিমেশন টগল -->
        <div class="setting-item">
            <div class="setting-text">
                <label for="newsAnimationToggle" class="font-semibold text-gray-700 dark:text-gray-300">নিউজ এনিমেশন টগল</label>
                <p class="text-sm text-gray-500 dark:text-gray-400">নিউজ টিকারের অ্যানিমেশন স্টাইল পরিবর্তন করুন। (চালু = টাইপিং, বন্ধ = স্লাইডিং)</p>
            </div>
            <label class="switch">
                <input type="checkbox" id="newsAnimationToggle">
                <span class="slider round"></span>
            </label>
        </div>
		
        <!-- টাইটেল এনিমেশন টগল -->
        <div class="setting-item">
            <div class="setting-text">
                <label for="titleAnimationToggle" class="font-semibold text-gray-700 dark:text-gray-300">টাইটেল এনিমেশন</label>
                <p class="text-sm text-gray-500 dark:text-gray-400">বাংলা টুলবক্স টাইটেল গ্লিচ এনিমেশন চালু বা বন্ধ করুন।</p>
            </div>
            <label class="switch">
                <input type="checkbox" id="titleAnimationToggle" checked>
                <span class="slider round"></span>
            </label>
        </div>	
		
        <!-- ব্যাকগ্রাউন্ড এনিমেশন টগল -->
        <div class="setting-item" style="margin-top: 15px;">
            <div class="setting-text">
                <label for="bgAnimationToggle" class="font-semibold text-gray-700 dark:text-gray-300">ব্যাকগ্রাউন্ড এনিমেশন</label>
                <p class="text-sm text-gray-500 dark:text-gray-400">ব্যাকগ্রাউন্ডে বাবল ওড়ার এনিমেশন চালু বা বন্ধ করুন। এটি বন্ধ রাখলে CPU ব্যবহার অনেক কমে যাবে।<b style="color:red">(Recommended: Off)</b></p>
            </div>
            <label class="switch">
                <input type="checkbox" id="bgAnimationToggle">
                <span class="slider round"></span>
            </label>
        </div>
		
        <!-- অ্যাপ থিম সিলেকশন -->
        <div class="setting-item">
            <div class="setting-text">
                <label for="appThemeSelect" class="font-semibold text-gray-700 dark:text-gray-300">অ্যাপ থিম</label>
                <p class="text-sm text-gray-500 dark:text-gray-400">আপনার পছন্দমতো ডিজাইন বেছে নিন।</p>
            </div>
            <select id="appThemeSelect" class="p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white focus:ring-2 focus:ring-indigo-500">
                <option value="modern">Soft Blue</option>
                <option value="classic">Classic</option>
                <option value="nature">Nature</option>
				<option value="purple">Royal Purple</option>
				<option value="sunset">Sunset</option>
            </select>
        </div>

        <!-- নতুন: ফুলস্ক্রিন মোড টগল -->
        <div class="setting-item">
            <div class="setting-text">
                <label for="fullscreenToggle" class="font-semibold text-gray-700 dark:text-gray-300">ফুলস্ক্রিন মোড</label>
                <p class="text-sm text-gray-500 dark:text-gray-400">দুই পাশের ফাঁকা জায়গা কমিয়ে পুরো পেজ জুড়ে দেখুন।</p>
            </div>
            <label class="switch">
                <input type="checkbox" id="fullscreenToggle">
                <span class="slider round"></span>
            </label>
        </div>
        <!-- ডাটা ইমপোর্ট ও এক্সপোর্ট -->
        <div class="setting-item" style="margin-top: 15px;">
            <div class="setting-text" style="flex-grow: 1; margin-right: 15px;">
                <label class="font-semibold text-gray-700 dark:text-gray-300">ডাটা ব্যাকআপ ও রিস্টোর</label>
                <p class="text-sm text-gray-500 dark:text-gray-400">আপনার সেটিংস, নোট, ইনভয়েজ এবং অন্যান্য ডাটা সেভ করুন বা ফিরিয়ে আনুন।</p>
                <div class="flex gap-2 mt-2">
                    <button id="exportDataBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg>
                        এক্সপোর্ট (ব্যাকআপ)
                    </button>
                    <button id="importDataBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded text-sm flex items-center gap-2">

                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
                        ইমপোর্ট (রিস্টোর)
                    </button>
                    <input type="file" id="importFileInput" accept=".json" class="hidden">
                </div>
            </div>
        </div>

		
        <!-- ক্লিয়ার অ্যাপ ডাটা বাটন -->
        <div class="setting-item" style="margin-top: 15px;">
            <div class="setting-text">
                <label class="font-semibold text-gray-700 dark:text-gray-300">অ্যাপ ডাটা মুছুন</label>
                <p class="text-sm text-gray-500 dark:text-gray-400">সমস্ত সেভ করা ডাটা (নোট, ইনভয়েজ, সেটিংস ইত্যাদি) মুছে ফেলুন।</p>
            </div>
            <button id="clearAppDataBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded">
                মুছুন
            </button>
        </div>

    </div>
</div>
<!-- ======================================================== -->
<!-- END: আরও সেটিংস ট্যাব -->
<!-- ======================================================== -->

<!-- ======================================================== -->
<!-- START: ইতিহাস ট্যাব (History Tab) -->
<!-- ======================================================== -->
<div id="historyContent" class="calculator-content">
    
    <!-- আজকের ইতিহাস সেকশন -->
    <div class="history-page-container">
        
        <!-- নতুন ডিজাইন কার্ড: আজকের ইতিহাস -->
        <div class="history-header-card today">
            <div class="card-supertitle">ইতিহাস</div>
            <div id="history-title" class="card-day-name">আজকের দিনে</div>
        </div>
        
        <!-- নতুন রিফ্রেশ বাটন (আজকের দিনের জন্য) -->
        <button id="todayHistoryRefreshBtn" class="p-2 bg-indigo-500 text-white rounded-full hover:bg-indigo-600 transition-colors absolute top-5 right-5" title="আজকের ইতিহাস রিফ্রেশ করুন" style="z-index: 10;">
            <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
            </svg>
        </button>


        <!-- লোডিং স্পিনার (hidden ক্লাস সরানো হয়েছে) -->
        <div id="history-loading" class="text-center p-8"> <!-- 'hidden' ক্লাস সরানো হয়েছে -->
            <svg class="animate-spin h-10 w-10 text-indigo-600 dark:text-indigo-400 mx-auto" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-600 dark:text-gray-400">আজকের ইতিহাস লোড হচ্ছে...</p>
        </div>

        <!-- কন্টেন্ট দেখানোর স্থান -->
        <div id="history-display-area" class="hidden"> <!-- কন্টেন্ট লোড হওয়ার আগে লুকানো থাকবে -->
            <!-- জেমিনি থেকে পাওয়া কন্টেন্ট এখানে লোড হবে -->
        </div>
    </div>
    
    <!-- ======================================================== -->
    <!-- START: আগামীকালের ইতিহাস (Tomorrow's History) -->
    <!-- ======================================================== -->
    <div class="history-page-container" style="margin-top: 2rem; border-top: 2px solid #e0e7ff; padding-top: 1.5rem;">
        
        <!-- নতুন ডিজাইন কার্ড: আগামীকালের ইতিহাস -->
        <div class="history-header-card tomorrow">
            <div class="card-supertitle">ইতিহাস</div>
            <div id="history-title-tomorrow" class="card-day-name">আগামীকালের দিনে</div>
        </div>
        
        <!-- নতুন রিফ্রেশ বাটন (আগামীকালের জন্য) -->
        <button id="tomorrowHistoryRefreshBtn" class="p-2 bg-indigo-500 text-white rounded-full hover:bg-indigo-600 transition-colors absolute top-5 right-5" title="আগামীকালের ইতিহাস রিফ্রেশ করুন" style="z-index: 10;">
            <svg xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/>
                <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/>
            </svg>
        </button>

        <!-- লোডিং স্পিনার (hidden ক্লাস সরানো হয়েছে) -->
        <div id="history-loading-tomorrow" class="text-center p-8"> <!-- 'hidden' ক্লাস সরানো হয়েছে -->
            <svg class="animate-spin h-10 w-10 text-indigo-600 dark:text-indigo-400 mx-auto" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-600 dark:text-gray-400">আগামীকালের ইতিহাস লোড হচ্ছে...</p>
        </div>
    
        <div id="history-display-area-tomorrow" class="hidden"> <!-- কন্টেন্ট লোড হওয়ার আগে লুকানো থাকবে -->
            <!-- জেমিনি থেকে পাওয়া কন্টেন্ট এখানে লোড হবে -->
        </div>
    </div>
    <!-- ======================================================== -->
    <!-- END: আগামীকালের ইতিহাস -->
    <!-- ======================================================== -->
    
</div>
<!-- ======================================================== -->
<!-- END: ইতিহাস ট্যাব -->
<!-- ======================================================== -->

<!-- ======================================================== -->
<!-- START: Barcode Generator Content -->
<!-- ======================================================== -->
<div id="barcodeGenContent" class="calculator-content">
    <div class="converter-section" style="max-width: 600px; margin: 0 auto;">
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">║▌║█║ বারকোড জেনারেটর</h3>
        
        <div class="space-y-4">
            <div>
                <label class="block mb-2 font-semibold text-gray-700 dark:text-gray-300 text-left">টেক্সট বা কোড লিখুন:</label>
                <input type="text" id="barcodeInput" placeholder="যেমন: 12345678" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-indigo-500">
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block mb-2 font-semibold text-gray-700 dark:text-gray-300 text-left">ফরম্যাট:</label>
                    <select id="barcodeFormat" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="CODE128">CODE128 (ডিফল্ট)</option>
                        <option value="CODE39">CODE39</option>
                        <option value="EAN13">EAN-13</option>
                        <option value="UPC">UPC</option>
                        <option value="ITF14">ITF-14</option>
                    </select>
                </div>
                <div>
                    <label class="block mb-2 font-semibold text-gray-700 dark:text-gray-300 text-left">লাইন কালার:</label>
                    <input type="color" id="barcodeColor" value="#000000" class="w-full h-[46px] p-1 border rounded-lg cursor-pointer bg-white dark:bg-gray-700">
                </div>
            </div>

            <div class="flex items-center space-x-3 mb-4">
                <input type="checkbox" id="showBarcodeText" checked class="w-5 h-5 text-indigo-600 rounded">
                <label for="showBarcodeText" class="text-gray-700 dark:text-gray-300">নিচে টেক্সট দেখান</label>
            </div>

            <button id="generateBarcodeBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-all flex justify-center items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M7 8v8"/><path d="M11 8v8"/><path d="M15 8v8"/><path d="M19 8v8"/></svg>
                বারকোড তৈরি করুন
            </button>
        </div>

        <!-- Result Area -->
        <div id="barcodeResultArea" class="mt-8 hidden bg-white p-4 rounded-lg shadow-md flex flex-col items-center">
            <svg id="barcodeCanvas"></svg>
            <button id="downloadBarcodeBtn" class="mt-4 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                ডাউনলোড (PNG)
            </button>
        </div>
    </div>
</div>
<!-- ======================================================== -->
<!-- END: Barcode Generator Content -->
<!-- ======================================================== -->

<!-- ======================================================== -->
<!-- START: Random Picker Content -->
<!-- ======================================================== -->
<div id="randomPickerContent" class="calculator-content">
    <div class="converter-section" style="max-width: 600px; margin: 0 auto;">
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">🎲 র‍্যান্ডম পিকার / লটারি</h3>
        <p class="text-sm text-gray-500 mb-4 dark:text-gray-400">নিচে নামগুলো লিখুন (প্রতি লাইনে একটি করে নাম)। এরপর 'লটারি করুন' বাটনে ক্লিক করে একজনকে বেছে নিন।</p>
        
        <div class="relative">
            <textarea id="pickerInput" rows="6" class="w-full p-4 border-2 border-dashed border-gray-300 rounded-xl dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:border-purple-500 focus:ring-0 transition-colors resize-y" placeholder="নাম ১&#10;নাম ২&#10;নাম ৩..."></textarea>
            <button id="clearPickerBtn" class="absolute top-2 right-2 p-1 text-gray-400 hover:text-red-500 bg-white dark:bg-gray-800 rounded-full shadow-sm" title="সব মুছুন">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
            </button>
        </div>

        <div class="flex gap-3 mt-4">
            <button id="addSampleDataBtn" class="flex-1 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-semibold dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200 transition-colors">নমুনা নাম</button>
            <button id="startPickerBtn" class="flex-[2] py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-bold shadow-md transform active:scale-95 transition-all flex justify-center items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m16 10-4 4-4-4"/></svg>
                লটারি করুন
            </button>
        </div>

        <!-- Result Animation Area -->
        <div id="pickerResultArea" class="mt-6 hidden text-center">
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-2">বিজয়ী হলেন:</div>
            <div id="pickerWinner" class="text-4xl font-bold text-purple-600 dark:text-purple-300 animate-bounce py-4 bg-purple-50 dark:bg-gray-800 rounded-xl border border-purple-100 dark:border-gray-700 shadow-inner">
                ?
            </div>
            <div id="confetti-container" class="fixed top-0 left-0 w-full h-full pointer-events-none z-50 overflow-hidden hidden"></div>
        </div>
    </div>
</div>
<!-- ======================================================== -->
<!-- END: Random Picker Content -->
<!-- ======================================================== -->

<!-- ======================================================== -->
<!-- START: Unit Price Comparator Content -->
<!-- ======================================================== -->
<div id="unitPriceContent" class="calculator-content">
    <div class="converter-section" style="max-width: 600px; margin: 0 auto;">
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">⚖️ দামের তুলনা (কোনটি সাশ্রয়ী?)</h3>
        <p class="text-sm text-gray-500 mb-6 dark:text-gray-400">দুটি পণ্যের দাম ও পরিমাণ লিখুন। আমরা বলে দেব কোনটি কেনা লাভজনক।</p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- পণ্য ক (Item A) -->
            <div class="bg-blue-50 dark:bg-gray-800 p-4 rounded-lg border border-blue-200 dark:border-gray-600">
                <h4 class="font-bold text-blue-600 dark:text-blue-400 mb-3 text-lg">পণ্য ১</h4>
                <div class="mb-3">
                    <label class="block text-sm font-semibold text-gray-600 dark:text-gray-300 mb-1">দাম (টাকা)</label>
                    <input type="number" id="priceA" placeholder="যেমন: 50" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-600 dark:text-gray-300 mb-1">পরিমাণ (গ্রাম/লিটার/পিস)</label>
                    <input type="number" id="qtyA" placeholder="যেমন: 500" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white">
                </div>
            </div>

            <!-- পণ্য খ (Item B) -->
            <div class="bg-purple-50 dark:bg-gray-800 p-4 rounded-lg border border-purple-200 dark:border-gray-600">
                <h4 class="font-bold text-purple-600 dark:text-purple-400 mb-3 text-lg">পণ্য ২</h4>
                <div class="mb-3">
                    <label class="block text-sm font-semibold text-gray-600 dark:text-gray-300 mb-1">দাম (টাকা)</label>
                    <input type="number" id="priceB" placeholder="যেমন: 90" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-600 dark:text-gray-300 mb-1">পরিমাণ (গ্রাম/লিটার/পিস)</label>
                    <input type="number" id="qtyB" placeholder="যেমন: 1000" class="w-full p-2 border rounded dark:bg-gray-700 dark:text-white">
                </div>
            </div>
        </div>

        <button id="comparePriceBtn" class="w-full mt-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all flex justify-center items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" /></svg>
            তুলনা করুন
        </button>

        <!-- ফলাফল এরিয়া -->
        <div id="compareResult" class="hidden mt-6 p-5 rounded-xl border-2 text-center transition-all duration-300">
            <h4 id="winnerTitle" class="text-2xl font-bold mb-2"></h4>
            <p id="savingsText" class="text-lg font-medium"></p>
            <div class="mt-4 text-sm text-gray-600 dark:text-gray-400 grid grid-cols-2 gap-4">
                <div>পণ্য ১ এর প্রতি ইউনিটের দাম:<br><span id="unitPriceA" class="font-bold">0.00</span> টাকা</div>
                <div>পণ্য ২ এর প্রতি ইউনিটের দাম:<br><span id="unitPriceB" class="font-bold">0.00</span> টাকা</div>
            </div>
        </div>
    </div>
</div>
<!-- ======================================================== -->
<!-- END: Unit Price Comparator Content -->
<!-- ======================================================== -->

<!-- ডিজিটাল তাসবিহ সেকশন শুরু -->
<div id="tasbeehContent" class="calculator-content">
    <div class="tasbeeh-container-modern">
        
        <!-- হেডার এবং প্রোফাইল সিলেকশন -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div>
                <h3 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center gap-2">
                    📿 ডিজিটাল তাসবিহ
                </h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                    বর্তমান প্রোফাইল: <span id="currentProfileName" class="font-bold text-blue-600 dark:text-blue-400">ডিফল্ট</span>
                </p>
            </div>
            
            <button id="toggleUserListBtn" class="px-4 py-2 bg-indigo-100 dark:bg-gray-700 text-indigo-700 dark:text-indigo-300 rounded-xl font-semibold hover:bg-indigo-200 dark:hover:bg-gray-600 transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                প্রোফাইল তালিকা
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- বাম পাশ: কাউন্টার -->
            <div class="lg:col-span-2 flex flex-col items-center">
                <!-- মেইন কাউন্টার বাটন -->
                <div id="tasbeehDisplayArea" class="tasbeeh-counter-ring">
                    <div id="tasbeehCountDisplay" class="tasbeeh-count-text">০</div>
                    <div class="tasbeeh-label">গণনা করতে ক্লিক করুন</div>
                </div>

                <!-- কন্ট্রোল বাটনস -->
                <div class="flex flex-wrap justify-center gap-4 w-full max-w-md">
                    <button id="tasbeehUndoBtn" class="flex-1 px-4 py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-xl font-bold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors flex justify-center items-center gap-2 disabled:opacity-50" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>
                        আনডু
                    </button>
                    
                    <button id="tasbeehResetBtn" class="flex-1 px-4 py-3 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded-xl font-bold hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors flex justify-center items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/></svg>
                        রিসেট
                    </button>

                    <button id="tasbeehRedoBtn" class="flex-1 px-4 py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-xl font-bold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors flex justify-center items-center gap-2 disabled:opacity-50" disabled>
                        রিডু
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 14 5-5-5-5"/><path d="M20 9H9.5A5.5 5.5 0 0 0 4 14.5v0A5.5 5.5 0 0 0 9.5 20H13"/></svg>
                    </button>
                </div>
                
                <!-- টার্গেট/ম্যানুয়াল সেট -->
                <div class="mt-6 w-full max-w-md p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
                    <label class="block text-sm font-semibold text-gray-600 dark:text-gray-300 mb-2">সংখ্যা সেট করুন:</label>
                    <div class="flex gap-2">
                        <input type="number" id="tasbeehManualInput" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="0">
                        <button id="tasbeehSetBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg">সেট</button>
                    </div>
                </div>
            </div>

            <!-- ডান পাশ: ইউজার লিস্ট (ডিফল্টভাবে ডেস্কটপে দেখা যাবে, মোবাইলে টগল হবে) -->
            <div id="tasbeehUserSection" class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl border border-gray-200 dark:border-gray-700 hidden lg:block">
                <h4 class="text-lg font-bold text-gray-700 dark:text-gray-200 mb-4 border-b pb-2 dark:border-gray-600">ব্যবহারকারী / প্রোফাইল</h4>
                
                <!-- নতুন প্রোফাইল যোগ -->
                <div class="flex gap-2 mb-4">
                    <input type="text" id="newProfileName" placeholder="নতুন নাম লিখুন..." class="flex-grow p-2 text-sm border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-blue-500">
                    <button id="addProfileBtn" class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-lg" title="যোগ করুন">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>

                <!-- লিস্ট -->
                <div id="tasbeehProfilesList" class="user-list-container">
                    <!-- জাভাস্ক্রিপ্ট দিয়ে লিস্ট এখানে জেনারেট হবে -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ডিজিটাল তাসবিহ সেকশন শেষ -->

<!-- নতুন: ডিফ চেকার বিভাগ -->
<div id="diffCheckerContent" class="calculator-content">
    <div class="diff-checker-content">
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">অ্যাডভান্সড কোড/টেক্সট ডিফ চেকার</h3>
        
        <div class="diff-controls">
            <button id="compareDiffBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-8 rounded-xl shadow-lg transition-all transform hover:scale-105">তুলনা করুন (Compare)</button>
            <button id="clearDiffBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-8 rounded-xl shadow-lg transition-all transform hover:scale-105">মুছুন</button>
        </div>

        <!-- ইনপুট সেকশন -->
        <div class="diff-editor-container" id="diffInputContainer">
            <!-- বাম পাশ: অরিজিনাল -->
            <div class="diff-pane">
                <div class="diff-pane-header">
                    <span>অরিজিনাল টেক্সট (Old Version)</span>
                    <span class="text-xs bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded">Source</span>
                </div>
                <textarea id="diffInput1" class="diff-textarea" placeholder="এখানে পুরনো কোড বা লেখা পেস্ট করুন..."></textarea>
            </div>
            <!-- ডান পাশ: নতুন -->
            <div class="diff-pane">
                <div class="diff-pane-header">
                    <span>পরিবর্তিত টেক্সট (New Version)</span>
                    <span class="text-xs bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded">Changed</span>
                </div>
                <textarea id="diffInput2" class="diff-textarea" placeholder="এখানে নতুন কোড বা লেখা পেস্ট করুন..."></textarea>
            </div>
        </div>

        <!-- ফলাফল দেখানোর এরিয়া (প্রাথমিকভাবে লুকানো) -->
        <div id="diffResultContainer" class="hidden flex flex-col gap-4">
            <div class="flex justify-between items-center bg-blue-100 dark:bg-blue-900 p-3 rounded-lg border border-blue-200 dark:border-blue-700">
                <div class="flex items-center gap-4 text-sm font-semibold">
                    <span class="flex items-center gap-1 text-red-600 dark:text-red-300">
                        <span class="w-3 h-3 bg-red-500 rounded-full"></span> মুছে ফেলা হয়েছে
                    </span>
                    <span class="flex items-center gap-1 text-green-600 dark:text-green-300">
                        <span class="w-3 h-3 bg-green-500 rounded-full"></span> নতুন যুক্ত করা হয়েছে
                    </span>
                </div>
                <button id="backToDiffInputBtn" class="text-sm bg-white dark:bg-gray-800 px-4 py-2 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700 transition font-bold shadow-sm">
                    ← আবার এডিট করুন
                </button>
            </div>

            <div class="diff-result-grid">
                <!-- বাম পাশ: কি ছিল -->
                <div class="diff-result-box">
                    <div class="diff-pane-header border-b-2 border-red-200 dark:border-red-900">
                        <span class="text-red-600 dark:text-red-300">পুরানো সংস্করণ (মুছে ফেলা অংশ)</span>
                    </div>
                    <div id="diffOutputOld" class="diff-result-content"></div>
                </div>
                <!-- ডান পাশ: কি হয়েছে -->
                <div class="diff-result-box">
                    <div class="diff-pane-header border-b-2 border-green-200 dark:border-green-900">
                        <span class="text-green-600 dark:text-green-300">নতুন সংস্করণ (যুক্ত করা অংশ)</span>
                    </div>
                    <div id="diffOutputNew" class="diff-result-content"></div>
                </div>
            </div>

            <!-- নতুন: কম্বাইন্ড ভিউ (একসাথে) -->
            <div class="diff-result-box mt-2" style="min-height: 200px;">
                <div class="diff-pane-header border-b-2 border-indigo-200 dark:border-indigo-900">
                    <span class="text-indigo-600 dark:text-indigo-300">কম্বাইন্ড ভিউ (সব পরিবর্তন একসাথে)</span>
                </div>
                <div id="diffOutputCombined" class="diff-result-content"></div>
            </div>
        </div>
    </div>
</div>
<!-- শেষ: ডিফ চেকার বিভাগ -->

<!-- START: Expense Tracker Content (আয়-ব্যয় হিসাব) -->
<div id="expenseTrackerContent" class="calculator-content">
    <div class="days-observances-container"> <!-- Reusing container style -->
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">💰 আয়-ব্যয় হিসাব</h3>
        
        <!-- Summary Cards -->
        <div class="grid grid-cols-3 gap-2 mb-6">
            <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-lg border border-blue-200 dark:border-blue-700">
                <h4 class="text-xs sm:text-sm font-semibold text-blue-600 dark:text-blue-300">বর্তমান ব্যালেন্স</h4>
                <p id="expBalance" class="text-lg sm:text-xl font-bold text-blue-800 dark:text-blue-100 mt-1">৳ ০</p>
            </div>
            <div class="bg-green-100 dark:bg-green-900 p-3 rounded-lg border border-green-200 dark:border-green-700">
                <h4 class="text-xs sm:text-sm font-semibold text-green-600 dark:text-green-300">মোট আয়</h4>
                <p id="expTotalIncome" class="text-lg sm:text-xl font-bold text-green-800 dark:text-green-100 mt-1">৳ ০</p>
            </div>
            <div class="bg-red-100 dark:bg-red-900 p-3 rounded-lg border border-red-200 dark:border-red-700">
                <h4 class="text-xs sm:text-sm font-semibold text-red-600 dark:text-red-300">মোট ব্যয়</h4>
                <p id="expTotalExpense" class="text-lg sm:text-xl font-bold text-red-800 dark:text-red-100 mt-1">৳ ০</p>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-6 flex justify-center">
            <div style="width: 250px; height: 250px;">
                <canvas id="expenseChart"></canvas>
            </div>
        </div>

        <!-- Input Form -->
        <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 mb-6 text-left">
            <h4 class="font-bold text-gray-700 dark:text-gray-200 mb-3 border-b pb-2 dark:border-gray-600">নতুন লেনদেন যুক্ত করুন</h4>
            
            <div class="flex gap-2 mb-3">
                <label class="flex-1 cursor-pointer">
                    <input type="radio" name="transType" value="expense" class="peer sr-only" checked>
                    <div class="p-2 text-center rounded-md border border-red-300 bg-white text-gray-600 peer-checked:bg-red-500 peer-checked:text-white transition-all">ব্যয় (Expense)</div>
                </label>
                <label class="flex-1 cursor-pointer">
                    <input type="radio" name="transType" value="income" class="peer sr-only">
                    <div class="p-2 text-center rounded-md border border-green-300 bg-white text-gray-600 peer-checked:bg-green-500 peer-checked:text-white transition-all">আয় (Income)</div>
                </label>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="block text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">বিবরণ</label>
                    <input type="text" id="expDesc" placeholder="যেমন: বাজার খরচ" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">পরিমাণ (টাকা)</label>
                    <input type="number" id="expAmount" placeholder="0" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">ক্যাটাগরি</label>
                    <select id="expCategory" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="Food">খাবার</option>
                        <option value="Transport">যাতায়াত</option>
                        <option value="Shopping">কেনাকাটা</option>
                        <option value="Bills">বিল ও ইউটিলিটি</option>
                        <option value="Salary">বেতন/উপার্জন</option>
                        <option value="Others">অন্যান্য</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">তারিখ</label>
                    <input type="date" id="expDate" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
            </div>

            <button id="addTransactionBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow transition-colors flex justify-center items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                লেনদেন যুক্ত করুন
            </button>
        </div>

        <!-- History List -->
        <div>
            <div class="flex justify-between items-center mb-3">
                <h4 class="font-bold text-gray-700 dark:text-gray-200">লেনদেনের ইতিহাস</h4>
                <button id="clearAllTransBtn" class="text-xs text-red-500 hover:text-red-700 underline">সব মুছুন</button>
            </div>
            <div id="transactionList" class="space-y-2 max-h-80 overflow-y-auto pr-1">
                <!-- Transactions will be injected here -->
                <p class="text-center text-gray-400 text-sm py-4">কোনো লেনদেন পাওয়া যায়নি।</p>
            </div>
        </div>
    </div>
</div>
<!-- END: Expense Tracker Content -->

<!-- ======================================================== -->
<!-- START: Text Encryption Content -->
<!-- ======================================================== -->
<div id="textEncryptionContent" class="calculator-content">
    <div class="encryption-content">
        <h3 class="text-xl font-bold text-gray-700 mb-4 dark:text-gray-200">🔐 টেক্সট এনক্রিপশন ও ডিক্রিপশন</h3>
        <p class="text-sm text-gray-500 mb-6 dark:text-gray-400">আপনার গোপন তথ্য একটি পাসওয়ার্ড দিয়ে লক (এনক্রিপ্ট) করুন অথবা লক করা তথ্য আনলক (ডিক্রিপ্ট) করুন।</p>

        <!-- Input Section -->
        <div class="encryption-input-group">
            <label for="encryptionInput">টেক্সট বা মেসেজ লিখুন:</label>
            <textarea id="encryptionInput" class="encryption-textarea" placeholder="এখানে আপনার গোপন কথা বা এনক্রিপ্ট করা কোড পেস্ট করুন..."></textarea>
        </div>

        <div class="encryption-input-group">
            <label for="encryptionPassword">গোপন পাসওয়ার্ড (Key):</label>
            <div class="relative">
                <input type="text" id="encryptionPassword" class="encryption-password-input" placeholder="একটি শক্তিশালী পাসওয়ার্ড দিন">
                <p class="text-xs text-red-500 mt-1">* ডিক্রিপ্ট করার সময় এই একই পাসওয়ার্ড লাগবে।</p>
            </div>
        </div>

        <!-- Buttons -->
        <div class="encryption-btn-group">
            <button id="btnEncrypt" class="encrypt-btn flex justify-center items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                এনক্রিপ্ট (লক)
            </button>
            <button id="btnDecrypt" class="decrypt-btn flex justify-center items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>
                ডিক্রিপ্ট (আনলক)
            </button>
        </div>

        <!-- Result Section -->
        <div id="encryptionResultBox" class="encryption-result-area hidden">
            <label class="block text-left font-semibold text-gray-700 dark:text-gray-300 mb-2">ফলাফল:</label>
            <textarea id="encryptionOutput" class="encryption-textarea bg-gray-100 dark:bg-gray-800" readonly></textarea>
            
            <div class="flex gap-3 mt-3">
                <button id="btnCopyEncryption" class="font-copy-button rounded-lg flex-1">কপি করুন</button>
                <button id="btnClearEncryption" class="font-clear-button rounded-lg flex-1">মুছুন</button>
            </div>
        </div>
    </div>
</div>
<!-- ======================================================== -->
<!-- END: Text Encryption Content -->
<!-- ======================================================== -->


<!-- এখান থেকে ওপরে নতুন ট্যাবের HTML Content কোড লিখতে হবে বা বসাতে হয় বা বসাতে হবে -->
</div>

    <!-- API কী মডেল -->
    <div id="apiKeyModal" class="api-key-modal-overlay hidden">
        <div class="api-key-modal-content">
            <h3>জেমিনি API কী সেট করুন</h3>
            <input type="text" id="apiKeyInput" placeholder="আপনার API কী এখানে লিখুন..." class="rounded-lg">
            <div class="modal-buttons">
                <button id="saveApiKeyBtn" class="modal-button save rounded-lg">সেভ করুন</button>
                <button id="cancelApiKeyBtn" class="modal-button cancel rounded-lg">বাতিল করুন</button>
            </div>
			
            <div id="apiKeyMessage" class="message-area"></div>
	<!-- API Key নেওয়ার জন্য নির্দেশনাসহ লিংক -->
	<div class="mt-1 mb-2 text-center">
		<a href="https://aistudio.google.com/app/api-keys" target="_blank"
				class="text-sm font-semibold text-indigo-600 hover:text-indigo-800 transition duration-150 ease-in-out underline underline-offset-4 decoration-dashed decoration-indigo-400 p-2 rounded-lg bg-indigo-50 	hover:bg-indigo-100">
				এখান থেকে নিজস্ব এপিআই কী নিন
		</a>
		<p style="margin-top:20px"><b>অথবা টেস্ট কোড হিসেবে নিচের কোডটি পেস্ট করুন।</br>একই এপিআই কী একাধিক ব্যবহারকারী ব্যবহার করলে গুগল সেটি ব্লক করে দিতে পারে। এজন্য নিজস্ব এপিআই কী ব্যবহার করা উত্তম</br>নিচের কোড কাজ না করলে নিজস্ব কী ব্যবহার করুন।</br></b></br>ųŊŴŖŚŔŨřĺřőŨŗŴŗŨŦśũŞŏūίŨŗŨőũŝŕŨō</p>
			</div>
        </div>
		
    </div>
	
<!--css style End-->

<!--Script started from here-->

    <script>
	
// ====================================================================
// START: IndexedDB with Expiry
// ====================================================================
const DB_NAME = 'BanglaToolboxDB';
const STORE_NAME = 'converterStore';
const DB_VERSION = 1;
const TWO_YEARS_IN_MS = 730 * 24 * 60 * 60 * 1000;

let dbPromise;

function getDb() {
    if (!dbPromise) {
        dbPromise = new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onerror = (event) => {
                console.error("IndexedDB error:", request.error);
                reject("IndexedDB error: " + request.error);
            };

            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { keyPath: 'key' });
                }
            };

            request.onsuccess = (event) => {
                resolve(event.target.result);
            };
        });
    }
    return dbPromise;
}

async function idbSet(key, value, ttl = TWO_YEARS_IN_MS) {
    const db = await getDb();
    const transaction = db.transaction(STORE_NAME, 'readwrite');
    const store = transaction.objectStore(STORE_NAME);
    const now = new Date();
    const item = {
        key: key,
        value: value,
        expiry: now.getTime() + ttl,
    };
    store.put(item);
    return transaction.complete;
}

async function idbGet(key) {
    const db = await getDb();
    const transaction = db.transaction(STORE_NAME, 'readonly');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.get(key);

    return new Promise((resolve, reject) => {
        request.onsuccess = () => {
            const item = request.result;
            if (!item) {
                resolve(null);
                return;
            }
            const now = new Date();
            if (now.getTime() > item.expiry) {
                // Expired, delete it and resolve null
                const deleteTransaction = db.transaction(STORE_NAME, 'readwrite');
                deleteTransaction.objectStore(STORE_NAME).delete(key);
                resolve(null);
            } else {
                resolve(item.value);
            }
        };
        request.onerror = (event) => {
            console.error("idbGet error:", event.target.error);
            reject(event.target.error);
        };
    });
}

async function clearExpiredItems() {
    try {
        const db = await getDb();
        const transaction = db.transaction(STORE_NAME, 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.openCursor();
        const now = new Date().getTime();

        request.onsuccess = event => {
            const cursor = event.target.result;
            if (cursor) {
                if (cursor.value.expiry < now) {
                    cursor.delete();
                }
                cursor.continue();
            }
        };
    } catch (error) {
        console.error("Error clearing expired items:", error);
    }
}
// ====================================================================
// END: IndexedDB with Expiry
// ====================================================================

// ====================================================================
// START: GLOBAL HIJRI ADJUSTMENT SETTING
// ====================================================================

// হিজরি তারিখ অ্যাডজাস্টমেন্টের জন্য সেন্ট্রাল ফাংশন
function getGlobalHijriAdjustment() {
    // যদি সেটিংসে ইউজার কিছু সেট না করে থাকে, তবে এই ভ্যালুটি কাজ করবে।
    const defaultValue = '-2'; 
    
    return parseInt(localStorage.getItem('hijriDateAdjustment') || defaultValue, 10);
}

// ====================================================================
// END: GLOBAL HIJRI ADJUSTMENT SETTING
// ====================================================================

// ====================================================================
// START: DEVELOPER CRICKET TICKER SETTING
// ====================================================================
// ডেভেলপার হিসেবে এখানে লিংক বসালে সেটি ডিফল্ট হিসেবে কাজ করবে।
// তবে ব্যবহারকারী যদি সেটিংসে অন্য লিংক বসায়, তবে ব্যবহারকারীরটি প্রাধান্য পাবে।
// লিংক না দিতে চাইলে খালি রাখুন: const DEVELOPER_CRICKET_URL = "";
const DEVELOPER_CRICKET_URL = ""; 
// ====================================================================
// END: DEVELOPER CRICKET TICKER SETTING
// ====================================================================

// ====================================================================
// START: PEST PRESET SCRIPT FOR FONT CONVERTER PART
// ====================================================================	
	// Paste Preset Functionality Variables
	let pastePresetLeft = 'default';
	let customPasteValueLeft = '';
	let customSerialCounterLeft = 1;
	let pastePresetRight = 'default';
	let customPasteValueRight = '';
	let customSerialCounterRight = 1;
	let currentModalSide = null; // কোন পাশের ('left' বা 'right') মোডাল খোলা হয়েছে তা ট্র্যাক করে
	let currentModalPreset = null; // কোন প্রিসেট ('custom' বা 'custom-serial') এর জন্য ইনপুট প্রয়োজন তা ট্র্যাক করে
// ====================================================================
// END: PEST PRESET SCRIPT FOR FONT CONVERTER PART
// ====================================================================	

// ====================================================================
// Start Typing Script
// ====================================================================

document.addEventListener('DOMContentLoaded', () => {
    const typingTestTab = document.getElementById('typingTestTab');
    if (!typingTestTab) return;

    // DOM Elements
    const textSelection = document.getElementById('textSelection');
    const timeSelection = document.getElementById('timeSelection');
    const customTextInputContainer = document.getElementById('custom-text-input');
    const typingTextDisplay = document.getElementById('typingTextDisplay');
    const typingInput = document.getElementById('typingInput');
    const elapsedTimeDisplay = document.getElementById('elapsedTimeDisplay');
    const remainingTimeDisplay = document.getElementById('remainingTimeDisplay');
    const wpmDisplay = document.getElementById('wpmDisplay');
    const totalWordsDisplay = document.getElementById('totalWordsDisplay');
    const correctWordsDisplay = document.getElementById('correctWordsDisplay');
    const incorrectWordsDisplay = document.getElementById('incorrectWordsDisplay');
    const accuracyDisplay = document.getElementById('accuracyDisplay');
    const restartTypingBtn = document.getElementById('restartTypingBtn');
    const pauseResumeTypingBtn = document.getElementById('pauseResumeTypingBtn');
    const clearTypingBtn = document.getElementById('clearTypingBtn');

    // Result Report Elements
    const resultReportContainer = document.getElementById('typingTestResultReport');
    const historyTableBody = document.getElementById('typingHistoryTableBody');
    const performanceChartCanvas = document.getElementById('performanceHistoryChart');
    const slowestCharsChartCanvas = document.getElementById('slowestCharsChart');

    let performanceChart, slowestCharsChart;

    const paragraphs = {
        bn_1: "বাংলা আমার মাতৃভাষা এবং আমি এই ভাষাকে অনেক ভালোবাসি। এই ভাষার জন্য আমাদের পূর্বপুরুষেরা ১৯৫২ সালে রক্ত দিয়েছেন, যা বিশ্ব ইতিহাসে এক বিরল ঘটনা। তাঁদের সেই আত্মত্যাগের স্বীকৃতি হিসেবে ২১শে ফেব্রুয়ারি আজ আন্তর্জাতিক মাতৃভাষা দিবস হিসেবে পালিত হয়, যা আমাদের জন্য একটি অত্যন্ত গর্বের দিন। এই ভাষা আমাদের সংস্কৃতি ও পরিচয়ের মূল ভিত্তি।",
        bn_2: "বাংলাদেশ দক্ষিণ এশিয়ার একটি সুন্দর দেশ, যা তার প্রাকৃতিক সৌন্দর্যের জন্য পরিচিত। এখানে ছয়টি ঋতু পর্যায়ক্রমে আসে এবং প্রতিটি ঋতুরই নিজস্ব রূপ ও বৈশিষ্ট্য রয়েছে। বর্ষাকালে প্রচুর বৃষ্টিপাত হয়, যার ফলে নদনদী, খালবিল পানিতে ভরে যায় এবং প্রকৃতি এক নতুন সজীবতা লাভ করে। এই ঋতু আমাদের কৃষি ও জীবনযাত্রায় গভীর প্রভাব ফেলে।",
        bn_3: "তথ্যপ্রযুক্তি আমাদের দৈনন্দিন জীবনকে অনেক সহজ ও গতিময় করে দিয়েছে। ইন্টারনেট ব্যবহার করে আমরা এখন বিশ্বের যেকোনো প্রান্তের মানুষের সাথে মুহূর্তের মধ্যে যোগাযোগ করতে পারি। শিক্ষা, স্বাস্থ্য, ব্যাংকিং এবং বিনোদনের মতো গুরুত্বপূর্ণ ক্ষেত্রেও তথ্যপ্রযুক্তি ব্যাপক ও ইতিবাচক প্রভাব পড়েছে, যা আধুনিক জীবনযাত্রাকে নতুন মাত্রা দিয়েছে।",
        en_1: "The quick brown fox jumps over the lazy dog. This famous pangram contains all twenty-six letters of the English alphabet, making it an excellent tool for testing typewriters and computer keyboards. It has been used for this purpose for many decades to ensure all keys are functioning correctly and to help people practice their typing skills.",
        en_2: "Technology has profoundly revolutionized the way we live, work, and interact with one another. The internet, a global network of computers, now connects billions of people worldwide. This connectivity provides unprecedented access to information, facilitates instant communication, and creates endless opportunities for learning, business, and entertainment across the globe.",
        en_3: "To be truly successful in life, one must cultivate dedication, embrace hard work, and demonstrate unwavering perseverance. Challenges are an inevitable and essential part of the journey toward achieving any significant goal. Overcoming these obstacles not only brings us closer to success but also makes us stronger, wiser, and more resilient individuals in the long run."
    };

    let timer, timeElapsed = 0, totalTestTime = 0, isTestActive = false, isPaused = false;
    let originalParagraphForTest = "", charTimings = [], lastKeyPressTime = 0;

    // বাংলা ও ইংরেজি সংখ্যার ম্যাপিং
    const digitMap = {
        '0': '০', '1': '১', '2': '২', '3': '৩', '4': '৪', '5': '৫', '6': '৬', '7': '৭', '8': '৮', '9': '৯',
        '০': '0', '১': '1', '২': '2', '৩': '3', '৪': '4', '৫': '5', '৬': '6', '৭': '7', '৮': '8', '৯': '9'
    };

    // বাংলা অক্ষর নরমালাইজেশন ফাংশন (আপনার অনুরোধ অনুযায়ী রিপ্লেসমেন্ট)
    const normalizeBengaliChars = (text) => {
        if (!text) return "";
        return text
            .replace(/ড\u09BC/g, 'ড়') // ড+় = ড়
            .replace(/ঢ\u09BC/g, 'ঢ়') // ঢ+় = ঢ়
            .replace(/য\u09BC/g, 'য়'); // য+় = য়
    };

    // Helper function to compare words considering digit equivalence
    const compareWords = (originalWord, typedWord) => {
        if (!originalWord || !typedWord || originalWord.length !== typedWord.length) {
            return false;
        }
        for (let i = 0; i < originalWord.length; i++) {
            const originalChar = originalWord[i];
            const typedChar = typedWord[i];
            if (originalChar !== typedChar && digitMap[originalChar] !== typedChar) {
                return false;
            }
        }
        return true;
    };


    const initializeTest = () => {
        clearInterval(timer);
        isTestActive = false;
        isPaused = false;
        timeElapsed = 0;
        charTimings = [];
        // Ensure elements exist before accessing properties
        if (timeSelection) totalTestTime = parseInt(timeSelection.value, 10);
        if (typingInput) {
            typingInput.value = '';
            typingInput.disabled = false;
        }


        const selection = textSelection ? textSelection.value : 'bn_1'; // Default if not found
        
        // কাস্টম টেক্সট এবং প্যারাগ্রাফ টেক্সট উভয়কেই নরমালাইজ করা হচ্ছে
        const customText = customTextInputContainer ? normalizeBengaliChars(customTextInputContainer.value.replace(/\r\n?/g, '\n')) : '';
        const rawParagraph = (selection === 'custom' ? customText : paragraphs[selection]) || paragraphs['bn_1'];
        originalParagraphForTest = normalizeBengaliChars(rawParagraph);

        if (typingTextDisplay) {
            typingTextDisplay.innerHTML = originalParagraphForTest.split('').map(char => `<span>${char}</span>`).join('');
            typingTextDisplay.style.whiteSpace = 'pre-wrap';
            typingTextDisplay.scrollTop = 0;
            const firstSpan = typingTextDisplay.querySelector('span');
            if (firstSpan) firstSpan.classList.add('current');
        }


        updateTimeDisplays();
        ['wpmDisplay', 'totalWordsDisplay', 'correctWordsDisplay', 'incorrectWordsDisplay'].forEach(id => {
            const element = document.getElementById(id);
            if (element) element.innerText = '0';
        });
       if(accuracyDisplay) accuracyDisplay.innerText = '100%';
       if(pauseResumeTypingBtn) pauseResumeTypingBtn.innerText = 'থামান';
       if(pauseResumeTypingBtn) pauseResumeTypingBtn.disabled = true;
    };

    const updateTimeDisplays = () => {
       if(elapsedTimeDisplay) elapsedTimeDisplay.innerText = formatTime(timeElapsed);
       if(remainingTimeDisplay) remainingTimeDisplay.innerText = totalTestTime > 0 ? formatTime(Math.max(0, totalTestTime - timeElapsed)) : 'আনলিমিটেড';
    };

    const formatTime = (sec) => `${String(Math.floor(sec / 60)).padStart(2, '0')}:${String(sec % 60).padStart(2, '0')}`;

    const handleTypingInput = () => {
        if (isPaused || !typingInput || !originalParagraphForTest) return; // Add null checks
        
        // টাইপ করার সাথে সাথে অক্ষর নরমালাইজ করা হচ্ছে
        const currentVal = typingInput.value;
        const normalizedVal = normalizeBengaliChars(currentVal);
        if (currentVal !== normalizedVal) {
            typingInput.value = normalizedVal;
        }

        if (!isTestActive && typingInput.value) {
            isTestActive = true;
            lastKeyPressTime = Date.now();
            startTimer();
            if(pauseResumeTypingBtn) pauseResumeTypingBtn.disabled = false;
        }

        const typedValue = typingInput.value;
        const typedLength = typedValue.length;

        const now = Date.now();
        const timeTaken = now - lastKeyPressTime;
        lastKeyPressTime = now;

        // Ensure originalParagraphForTest is long enough before accessing characters
        if (typedLength > 0 && typedLength <= originalParagraphForTest.length) {
            const originalChar = originalParagraphForTest[typedLength - 1];
            const typedChar = typedValue[typedLength - 1];
            // এখানে digitMap ব্যবহার করে সঠিকতা যাচাই করা হচ্ছে
            const isCorrect = (typedChar === originalChar) || (digitMap[originalChar] === typedChar) || (originalChar === '\n' && (typedChar === '\n' || typedChar === ' '));
            charTimings.push({ char: originalChar, time: timeTaken, correct: isCorrect });
        } else if (typedLength > originalParagraphForTest.length) {
             // Handle cases where user types beyond the original text (optional)
             // For now, we just update stats based on the available original text length
             console.warn("Typed length exceeds original paragraph length.");
        }


        updateDisplayAndStats();

        const currentSpan = typingTextDisplay?.querySelector('span.current');
        if (currentSpan && typingTextDisplay) {
            const containerRect = typingTextDisplay.getBoundingClientRect();
            const spanRect = currentSpan.getBoundingClientRect();
            const lineHeightStyle = getComputedStyle(typingTextDisplay).lineHeight;
            // Handle 'normal' line height or provide a default
            let lineHeight = 20; // Default line height
            if (lineHeightStyle !== 'normal') {
                lineHeight = parseFloat(lineHeightStyle);
            } else {
                 // Estimate line height based on font size if it's 'normal'
                const fontSizeStyle = getComputedStyle(typingTextDisplay).fontSize;
                const fontSize = parseFloat(fontSizeStyle);
                if (!isNaN(fontSize)) {
                    lineHeight = fontSize * 1.2; // Common multiplier for line height
                }
            }


            // Check if spanRect properties are valid numbers
             if (!isNaN(spanRect.bottom) && !isNaN(containerRect.bottom) && !isNaN(lineHeight)) {

                // *** Scroll logic reverted to previous state ***
                // Only scroll based on the bottom position
                if (spanRect.bottom > (containerRect.bottom - lineHeight * 0.5)) {
                    typingTextDisplay.scrollBy({ top: lineHeight, behavior: 'smooth' });
                }
                // *** End of scroll logic change ***
            } else {
                 console.warn("Invalid rect or line height for scrolling calculation.");
            }
        }


        if (typedLength >= originalParagraphForTest.length) {
            endTest();
        }
    };

    const updateDisplayAndStats = () => {
        if (!typingTextDisplay || !typingInput || !originalParagraphForTest) return; // Add null checks

        const spans = typingTextDisplay.querySelectorAll('span');
        const typedValue = typingInput.value;
        let correctChars = 0;
        let incorrectCharsCount = 0; // ভুল অক্ষরের সংখ্যা গণনার জন্য

        spans.forEach((charSpan, index) => {
            charSpan.classList.remove('correct', 'incorrect', 'current');
            if (index < typedValue.length) {
                const typedChar = typedValue[index];
                const originalChar = charSpan.innerText;

                let isCorrect = (typedChar === originalChar) || (digitMap[originalChar] === typedChar);

                // Handle newline characters (allow spacebar for newline)
                if (originalChar === '\n' && (typedChar === '\n' || typedChar === ' ')) {
                    isCorrect = true;
                }

                if (isCorrect) {
                    charSpan.classList.add('correct');
                    correctChars++;
                } else {
                    charSpan.classList.add('incorrect');
                    incorrectCharsCount++; // ভুল অক্ষর গণনা
                }
            } else if (index === typedValue.length) {
                charSpan.classList.add('current');
            }
        });

        // নির্ভুলতা গণনা আপডেট করা হয়েছে (ভুল অক্ষরের উপর ভিত্তি করে)
        const accuracy = typedValue.length > 0 ? ((typedValue.length - incorrectCharsCount) / typedValue.length) * 100 : 100;
       if(accuracyDisplay) accuracyDisplay.innerText = `${Math.max(0, Math.round(accuracy))}%`; // নিশ্চিত করুন যেন ০% এর নিচে না যায়

        const timeInMinutes = timeElapsed / 60;
        // WPM গণনা: (মোট টাইপ করা অক্ষর / ৫) / সময় (মিনিটে)
        const grossWPM = timeInMinutes > 0 ? (typedValue.length / 5) / timeInMinutes : 0;
       if(wpmDisplay) wpmDisplay.innerText = Math.round(grossWPM > 0 ? grossWPM : 0);

        // শব্দ গণনা আপডেট করা হয়েছে (compareWords ব্যবহার করে)
        const typedWords = typedValue.trim().split(/\s+/).filter(Boolean);
        // Correct original words extraction for comparison
        const originalWordsForComparison = originalParagraphForTest.split(/\s+/).filter(Boolean);
        let correctWords = 0;
        typedWords.forEach((typedWord, index) => {
             // Ensure original word exists at the index before comparing
            if (originalWordsForComparison[index] && compareWords(originalWordsForComparison[index], typedWord)) {
                correctWords++;
            }
        });

        if(totalWordsDisplay) totalWordsDisplay.innerText = typedWords.length;
        if(correctWordsDisplay) correctWordsDisplay.innerText = correctWords;
        // Calculate incorrect words based on the difference
        if(incorrectWordsDisplay) incorrectWordsDisplay.innerText = typedWords.length - correctWords;
    };


    const startTimer = () => {
        // Clear existing timer before starting a new one
        if (timer) clearInterval(timer);
        timer = setInterval(() => {
            if (isPaused) return;
            timeElapsed++;
            updateTimeDisplays();
            updateDisplayAndStats();
            if (totalTestTime > 0 && timeElapsed >= totalTestTime) endTest();
        }, 1000);
    };

    const togglePauseResume = () => {
        if (!isTestActive || !typingInput || !pauseResumeTypingBtn) return; // Add null checks
        isPaused = !isPaused;
        if (isPaused) {
            typingInput.disabled = true;
            pauseResumeTypingBtn.innerText = 'চালু করুন';
        } else {
            lastKeyPressTime = Date.now();
            typingInput.disabled = false;
            typingInput.focus();
            pauseResumeTypingBtn.innerText = 'থামান';
        }
    };

    const endTest = async () => {
        clearInterval(timer);
        isTestActive = false;
        if(typingInput) typingInput.disabled = true;
        if(pauseResumeTypingBtn) pauseResumeTypingBtn.disabled = true;
        updateDisplayAndStats(); // Final update

        const wpmValue = wpmDisplay ? parseInt(wpmDisplay.innerText, 10) : 0;
        const accuracyValue = accuracyDisplay ? parseInt(accuracyDisplay.innerText.replace('%', ''), 10) : 0;
        const errorsValue = incorrectWordsDisplay ? parseInt(incorrectWordsDisplay.innerText, 10) : 0;

        const resultData = {
            wpm: isNaN(wpmValue) ? 0 : wpmValue,
            accuracy: isNaN(accuracyValue) ? 0 : accuracyValue,
            errors: isNaN(errorsValue) ? 0 : errorsValue,
            timestamp: new Date().toISOString(),
            charTimings: charTimings // Ensure charTimings is captured correctly
        };


        await saveResult(resultData);
        await displayResultReport();

        showCustomAlert('টাইপিং টেস্ট শেষ হয়েছে!');
    };

    const saveResult = async (result) => {
        // Ensure idbGet and idbSet are defined and imported/available
        if (typeof idbGet !== 'function' || typeof idbSet !== 'function') {
            console.error("IndexedDB functions (idbGet, idbSet) are not available.");
            // Fallback to localStorage if IndexedDB functions are missing
            try {
                let history = JSON.parse(localStorage.getItem('typingTestHistory') || '[]');
                history.unshift(result);
                history = history.slice(0, 10);
                localStorage.setItem('typingTestHistory', JSON.stringify(history));
                console.log("Typing test result saved to localStorage (fallback).");
            } catch (localError) {
                console.error("Failed to save to localStorage as well:", localError);
            }
            return;
        }

        try {
            let history = await idbGet('typingTestHistory') || [];
            history.unshift(result);
            history = history.slice(0, 10);
            await idbSet('typingTestHistory', history);
            console.log("Typing test result saved to IndexedDB.");
        } catch (error) {
            console.error("Failed to save typing test result to IndexedDB:", error);
            // Fallback to localStorage on IndexedDB error
            try {
                let history = JSON.parse(localStorage.getItem('typingTestHistory') || '[]');
                history.unshift(result);
                history = history.slice(0, 10);
                localStorage.setItem('typingTestHistory', JSON.stringify(history));
                console.log("Typing test result saved to localStorage (fallback).");
            } catch (localError) {
                console.error("Failed to save to localStorage as well:", localError);
            }
        }
    };


    const displayResultReport = async () => {
        if (!resultReportContainer || !historyTableBody) return; // Add null checks

        let history = [];
        // Ensure idbGet is available before trying to use it
        if (typeof idbGet === 'function') {
            try {
                history = await idbGet('typingTestHistory') || [];
            } catch (error) {
                console.error("Failed to get typing history from IndexedDB:", error);
                history = JSON.parse(localStorage.getItem('typingTestHistory') || '[]'); // Fallback
            }
        } else {
             history = JSON.parse(localStorage.getItem('typingTestHistory') || '[]'); // Fallback if idbGet is undefined
        }


        resultReportContainer.classList.remove('hidden');

        if (history.length === 0) {
            historyTableBody.innerHTML = '<tr><td colspan="5" class="p-3 text-center text-gray-500">কোনো পরীক্ষার ইতিহাস পাওয়া যায়নি।</td></tr>';
            renderPerformanceChart([]);
            renderSlowestCharsChart([]);
            return;
        }

        historyTableBody.innerHTML = history.map((res, index) => {
            // Ensure res.accuracy and res.errors are numbers before formatting
            const accuracy = typeof res.accuracy === 'number' ? res.accuracy : '-';
            const errors = typeof res.errors === 'number' ? res.errors : '-';
            const wpm = typeof res.wpm === 'number' ? res.wpm : '-';
            let dateString = '-';
            try {
                 dateString = new Date(res.timestamp).toLocaleString('bn-BD');
            } catch (e) { console.error("Error formatting date:", e); }

            return `
            <tr>
                <td class="p-3 text-center">${history.length - index}</td>
                <td class="p-3">${dateString}</td>
                <td class="p-3 text-center">${wpm}</td>
                <td class="p-3 text-center">${accuracy}%</td>
                <td class="p-3 text-center">${errors}</td>
            </tr>
        `}).join('');


        renderPerformanceChart(history);
        // Ensure the latest result and its charTimings exist
        if (history[0] && history[0].charTimings) {
            renderSlowestCharsChart(history[0].charTimings);
        } else {
             renderSlowestCharsChart([]); // Render empty chart if data is missing
        }
    };

    const renderPerformanceChart = (history) => {
        if (!performanceChartCanvas || typeof Chart === 'undefined') return; // Add Chart check
        if (performanceChart) performanceChart.destroy();
        const reversedHistory = [...history].reverse();

        const labels = reversedHistory.map((_, i) => `টেস্ট ${i + 1}`);
        const wpmData = reversedHistory.map(res => typeof res.wpm === 'number' ? res.wpm : 0); // Default to 0 if undefined
        const accuracyData = reversedHistory.map(res => typeof res.accuracy === 'number' ? res.accuracy : 0); // Default to 0

        const chartType = reversedHistory.length > 1 ? 'line' : 'bar';

        try {
            performanceChart = new Chart(performanceChartCanvas, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'WPM',
                        data: wpmData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        tension: 0.1
                    }, {
                        label: 'নির্ভুলতা (%)',
                        data: accuracyData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.5)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        } catch (e) {
            console.error("Error rendering performance chart:", e);
        }
    };

    const renderSlowestCharsChart = (timings) => {
        if (!slowestCharsChartCanvas || typeof Chart === 'undefined') return; // Add Chart check
        if (slowestCharsChart) slowestCharsChart.destroy();
        // Ensure timings is an array and has elements
        if (!Array.isArray(timings) || timings.length === 0) {
             console.warn("No timings data available for slowest chars chart.");
             // Optionally clear the canvas or display a message
             const ctx = slowestCharsChartCanvas.getContext('2d');
             ctx.clearRect(0, 0, slowestCharsChartCanvas.width, slowestCharsChartCanvas.height);
             ctx.textAlign = 'center';
             ctx.fillText("কোনো ডেটা নেই", slowestCharsChartCanvas.width / 2, slowestCharsChartCanvas.height / 2);
             return;
        }

        const charTimeMap = {};
        timings.forEach(({ char, time }) => {
            // Ensure char is a string and time is a number
            if (typeof char !== 'string' || typeof time !== 'number' || isNaN(time)) return;

            const normalizedChar = char === ' ' ? 'স্পেস' : (char === '\n' ? 'এন্টার' : char);
            if (!charTimeMap[normalizedChar]) charTimeMap[normalizedChar] = [];
            charTimeMap[normalizedChar].push(time);
        });


        const avgTimes = Object.keys(charTimeMap).map(char => {
            const times = charTimeMap[char];
             // Ensure times array is not empty before reducing
            if (!times || times.length === 0) return { char, avg: 0 };
            const sum = times.reduce((a, b) => a + b, 0);
            const avg = sum / times.length;
            return { char, avg };
        }).filter(item => item.avg > 0); // Filter out items with 0 average time if necessary

        const slowestChars = avgTimes.sort((a, b) => b.avg - a.avg).slice(0, 10);

        // Ensure slowestChars has data before rendering Default: ĺĵ ųľŨŊũň ŞŴŚŨ ųŊŴŖŴŚŨŔŨř ĺř ųŀŨŔőŪţ ųľŨŊĬ
         if (slowestChars.length === 0) {
             console.warn("No valid slowest character data to display.");
             return;
         }

        try {
            slowestCharsChart = new Chart(slowestCharsChartCanvas, {
                type: 'bar',
                data: {
                    labels: slowestChars.map(c => c.char),
                    datasets: [{
                        label: 'গড় সময় (ms)',
                        data: slowestChars.map(c => c.avg.toFixed(0)),
                        backgroundColor: '#fb923c'
                    }]
                },
                options: { responsive: true, indexAxis: 'y' }
            });
         } catch (e) {
             console.error("Error rendering slowest chars chart:", e);
         }
    };


    const loadLastReport = async () => {
        await displayResultReport();
    };

    // Add event listeners only if elements exist
    if (typingTestTab) {
        typingTestTab.addEventListener('click', () => {
            // Assuming showTab is defined elsewhere
            if (typeof showTab === 'function') showTab('typingTest');
            initializeTest();
            loadLastReport();
        });
    }

    if (restartTypingBtn) restartTypingBtn.addEventListener('click', initializeTest);
    if (pauseResumeTypingBtn) pauseResumeTypingBtn.addEventListener('click', togglePauseResume);
    if (clearTypingBtn) clearTypingBtn.addEventListener('click', () => { if(typingInput) typingInput.value = ''; initializeTest(); });
    if (typingInput) typingInput.addEventListener('input', handleTypingInput);

    if (textSelection) {
        textSelection.addEventListener('change', () => {
             if(customTextInputContainer) customTextInputContainer.classList.toggle('hidden', textSelection.value !== 'custom');
            initializeTest();
        });
         // Initial check for custom text visibility
         if(customTextInputContainer) customTextInputContainer.classList.toggle('hidden', textSelection.value !== 'custom');
    }

    if (timeSelection) timeSelection.addEventListener('change', initializeTest);
    if (customTextInputContainer) {
        customTextInputContainer.addEventListener('input', () => { 
            if (textSelection && textSelection.value === 'custom') {
                // কাস্টম ইনপুট লেখার সাথে সাথেও নরমালাইজ করা হবে
                customTextInputContainer.value = normalizeBengaliChars(customTextInputContainer.value);
                initializeTest(); 
            }
        });
    }

    // Initialize if the tab is already active on load
    const typingTestContent = document.getElementById('typingTestContent');
    if (typingTestContent && typingTestContent.classList.contains('active')) {
        initializeTest();
        loadLastReport();
    }
});
// ====================================================================
// End Typing Script
// ====================================================================


// ====================================================================
// START: DATE AND TIME BANNER SCRIPT (ঋতুসহ আপডেট করা হয়েছে - CPU Optimized)
// ====================================================================

        // নতুন ফাংশন: ঘড়ি ট্যাবের অ্যালার্ম সেকশনে যাওয়ার জন্য
        function switchToClockTab() {
            // ১. ঘড়ি ট্যাব ওপেন করুন
            if (typeof showTab === 'function') {
                showTab('clock');
            } else {
                const clockTabBtn = document.getElementById('clockTab');
                if (clockTabBtn) clockTabBtn.click();
            }

            // ২. অ্যালার্ম সেকশনে স্ক্রল করুন (সামান্য ডিলে দিয়ে যাতে ট্যাব রেন্ডার হতে পারে)
            setTimeout(() => {
                const alarmSection = document.querySelector('.clock-section.alarm');
                if (alarmSection) {
                    alarmSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // ব্যবহারকারীর দৃষ্টি আকর্ষণের জন্য বর্ডার বা শ্যাডো ইফেক্ট
                    alarmSection.classList.add('ring-4', 'ring-blue-500', 'ring-opacity-50');
                    setTimeout(() => {
                        alarmSection.classList.remove('ring-4', 'ring-blue-500', 'ring-opacity-50');
                    }, 2000);
                }
            }, 100);
        }

// গ্রেগরিয়ান তারিখকে বাংলা তারিখে রূপান্তর করার ফাংশন (বাংলাদেশ স্ট্যান্ডার্ড)
        function getBengaliDate(originalGregorianDate) {
            // সেটিংস থেকে বাংলা তারিখ অ্যাডজাস্টমেন্ট লোড করুন (ডিফল্ট ০)
            const adjustment = parseInt(localStorage.getItem('bengaliDateAdjustment') || '0', 10);
            
            // তারিখ কপি করে অ্যাডজাস্টমেন্ট যোগ করুন
            const gregorianDate = new Date(originalGregorianDate);
            gregorianDate.setDate(gregorianDate.getDate() + adjustment);
            // সময়ের ব্যবধান সমস্যা এড়াতে সময় রিসেট করা হলো
            gregorianDate.setHours(0, 0, 0, 0);

            const year = gregorianDate.getFullYear();
            const month = gregorianDate.getMonth(); // 0-11
            const day = gregorianDate.getDate();

            let bengaliYear;
            const bengaliMonthNames = [
                "বৈশাখ", "জ্যৈষ্ঠ", "আষাঢ়", "শ্রাবণ", "ভাদ্র", "আশ্বিন",
                "কার্তিক", "অগ্রহায়ণ", "পৌষ", "মাঘ", "ফাল্গুন", "চৈত্র"
            ];

            // পহেলা বৈশাখ ১৪ এপ্রিল
            if (month < 3 || (month === 3 && day < 14)) { 
                bengaliYear = year - 594;
            } else { 
                bengaliYear = year - 593;
            }

            // সংশোধিত ক্যালেন্ডার অনুযায়ী মাসের দিন সংখ্যা (প্রথম ৬ মাস ৩১ দিন)
            const bengaliMonthLengths = [31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 29, 30];
            
            // লিপ ইয়ার চেক: ফাল্গুন মাস যে গ্রেগরিয়ান বছরে পড়ে (অর্থাৎ পরের বছর), সেই বছর চেক করতে হবে
            const gregorianYearForBengaliLeapCheck = bengaliYear + 594;
            const isGregorianLeapYear = (gregorianYearForBengaliLeapCheck % 4 === 0 && gregorianYearForBengaliLeapCheck % 100 !== 0) || gregorianYearForBengaliLeapCheck % 400 === 0;

            if (isGregorianLeapYear) {
                bengaliMonthLengths[10] = 30; // অধিবর্ষে ফাল্গুন ৩০ দিন
            }

            // বাংলা বছরের শুরু (১৪ এপ্রিল)
            const startOfCurrentBengaliYearGregorian = new Date(year, 3, 14);
            startOfCurrentBengaliYearGregorian.setHours(0, 0, 0, 0);

            if (gregorianDate < startOfCurrentBengaliYearGregorian) {
                startOfCurrentBengaliYearGregorian.setFullYear(year - 1);
            }

            // দিনের পার্থক্য বের করা
            const diffTime = gregorianDate.getTime() - startOfCurrentBengaliYearGregorian.getTime();
            let daysPassedSinceBengaliYearStart = Math.round(diffTime / (1000 * 60 * 60 * 24));

            let currentBengaliMonthIndex = 0;
            let currentBengaliDay = 0;

            for (let i = 0; i < bengaliMonthNames.length; i++) {
                if (daysPassedSinceBengaliYearStart < bengaliMonthLengths[i]) {
                    currentBengaliMonthIndex = i;
                    currentBengaliDay = daysPassedSinceBengaliYearStart + 1; 
                    break;
                }
                daysPassedSinceBengaliYearStart -= bengaliMonthLengths[i];
            }

            const toBengaliNumber = (num) => {
                const numbers = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];
                return num.toString().split('').map(digit => numbers[parseInt(digit)]).join('');
            };

            return {
                day: currentBengaliDay,
                month: bengaliMonthNames[currentBengaliMonthIndex],
                year: bengaliYear,
                monthIndex: currentBengaliMonthIndex, 
                formatted: `${toBengaliNumber(currentBengaliDay)} ${bengaliMonthNames[currentBengaliMonthIndex]} ${toBengaliNumber(bengaliYear)} বঙ্গাব্দ`
            };
        }

        // ঋতু বের করার ফাংশন
        function getBengaliSeason(monthIndex) {
            const seasons = [
                "গ্রীষ্মকাল", "গ্রীষ্মকাল", 
                "বর্ষাকাল", "বর্ষাকাল",   
                "শরৎকাল", "শরৎকাল",   
                "হেমন্তকাল", "হেমন্তকাল", 
                "শীতকাল", "শীতকাল",     
                "বসন্তকাল", "বসন্তকাল"  
            ];
            return seasons[monthIndex] || ""; 
        }

        const arabicToBengaliNumbers = (text) => {
            const arabicDigits = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
            const bengaliDigits = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];
            let converted = text;
            for (let i = 0; i < arabicDigits.length; i++) {
                converted = converted.replace(new RegExp(arabicDigits[i], 'g'), bengaliDigits[i]);
            }
            return converted;
        };

        const hijriMonthArabicToBengali = {
            'محرم': 'মুহাররম', 'صفر': 'সফর', 'ربيع الأول': 'রবিউল আউয়াল', 'ربيع الآخر': 'রবিউস সানি',
            'جمادى الأولى': 'জমাদিউল আউয়াল', 'جمادى الآخرة': 'জমাদিউস সানি', 'رجب': 'রজব', 'شعبان': 'শাবান',
            'رمضان': 'রমজান', 'شوال': 'শাওয়াল', 'ذو القعدة': 'জিলকদ', 'ذو الحجة': 'জিলহজ'
        };

        // ক্যাশিং ভেরিয়েবল (CPU অপ্টিমাইজেশনের জন্য)
        let cachedDatePartHTML = "";
        let lastDateUpdateTimestamp = 0;
        const UPDATE_INTERVAL_MS = 10 * 60 * 1000; // ১০ মিনিট

        // অনলাইন থেকে সঠিক সময় এবং তারিখ আনার ফাংশন
        async function fetchOnlineDate() {
            try {
                // WorldTimeAPI ব্যবহার করে ঢাকার সময় আনা হচ্ছে
                const response = await fetch('https://worldtimeapi.org/api/timezone/Asia/Dhaka');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                // ডেট অবজেক্ট তৈরি
                const onlineDate = new Date(data.datetime);
                
                // লোকাল স্টোরেজে সেভ করা (ব্যানারের জন্য)
                // আমরা পুরো ডেট স্ট্রিং সেভ করছি না, বরং অফসেট বা বেস ডেট সেভ করছি
                localStorage.setItem('lastOnlineDateCheck', new Date().toISOString());
                
                return onlineDate;
            } catch (error) {
                console.error("Online date fetch failed:", error);
                return new Date(); // ফেইল করলে সিস্টেম টাইম ব্যবহার করবে
            }
        }

        // মডিফাইড updateDateTimeBanner ফাংশন (Async করা হয়েছে)
        async function updateDateTimeBanner(forceUpdate = false) {
            const bannerElement = document.getElementById('currentDateTimeBanner');
            if (!bannerElement) return;

            // সেটিংস চেক
            const isTimeBannerEnabled = localStorage.getItem('timeBannerEnabled') !== 'false';
            if (!isTimeBannerEnabled) {
                bannerElement.style.display = 'none';
                return; 
            } else {
                bannerElement.style.display = 'flex';
            }

            // বর্তমান সময় (সিস্টেম)
            let now = new Date();
            const currentTime = Date.now();
            const currentDay = now.getDate();

            // অটো আপডেট লজিক চেক (পরিবর্তিত: ডিফল্ট false করা হয়েছে)
            // পরিবর্তন: === 'true' ব্যবহার করা হয়েছে যাতে ডিফল্ট false থাকে
            const isAutoUpdate = localStorage.getItem('autoUpdateDate') === 'true';
            
            // বিশেষ শর্ত: মাসের ২৭ তারিখের পর থেকে পরবর্তী মাসের ৩ তারিখ পর্যন্ত
            const isTransitionPeriod = (currentDay >= 27 || currentDay <= 3);
            
            // লাস্ট আপডেটের সময় চেক (প্রতি ঘণ্টায় একবার অটো চেক করতে চাইলে)
            const lastCheck = localStorage.getItem('lastOnlineDateCheck');
            const shouldCheckOnline = forceUpdate || 
                                     (isAutoUpdate && (!lastCheck || (currentTime - new Date(lastCheck).getTime() > 3600000))) || 
                                     (isTransitionPeriod && (!lastCheck || (currentTime - new Date(lastCheck).getTime() > 3600000)));

            // ১০ মিনিট পর পর অথবা ফোর্স আপডেট হলে তারিখ ক্যালকুলেশন হবে
            if (forceUpdate || currentTime - lastDateUpdateTimestamp > UPDATE_INTERVAL_MS || !cachedDatePartHTML) {
                
                // যদি শর্ত মিলে, তবে অনলাইন থেকে তারিখ আনবে
                if (shouldCheckOnline) {
                    try {
                        const onlineDate = await fetchOnlineDate();
                        // সিস্টেম টাইমের সাথে অনলাইন টাইমের পার্থক্য থাকলে, আমরা অনলাইন ডেটকে বেস হিসেবে ধরবো
                        // তবে সাধারণ প্রদর্শনের জন্য আমরা 'now' ভেরিয়েবল আপডেট করছি ক্যালকুলেশনের জন্য
                        now = onlineDate; 
                    } catch (e) {
                        // ফেইল করলে সাইলেন্টলি সিস্টেম টাইমই থাকবে
                    }
                }

                const toBengaliNumber = (num) => {
                    const numbers = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];
                    return String(num).split('').map(digit => !isNaN(parseInt(digit)) ? numbers[parseInt(digit)] : digit).join('');
                };

                // Gregorian Date
                const gregorianDay = toBengaliNumber(now.getDate());
                const gregorianMonth = now.toLocaleDateString('bn-BD', { month: 'long' });
                const gregorianYear = toBengaliNumber(now.getFullYear());
                const gregorianDateString = `${gregorianDay} ${gregorianMonth} ${gregorianYear}`;
                const dayOfWeekBengali = now.toLocaleDateString('bn-BD', { weekday: 'long' });

                // Bengali Date
                const bengaliDateInfo = getBengaliDate(now);
                const bengaliDateString = bengaliDateInfo.formatted;
                const bengaliSeason = getBengaliSeason(bengaliDateInfo.monthIndex);

                // Hijri Date
                let hijriCalculationDate = new Date(now);
                
                // পরিবর্তন: এখন গ্লোবাল ফাংশন থেকে ভ্যালু নেওয়া হচ্ছে
                const hijriAdjustment = getGlobalHijriAdjustment();
                
                hijriCalculationDate.setDate(hijriCalculationDate.getDate() + hijriAdjustment);

                const hijriDateFormatter = new Intl.DateTimeFormat('ar-SA', {
                    calendar: 'islamic', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Asia/Dhaka'
                });
                const hijriParts = hijriDateFormatter.formatToParts(hijriCalculationDate);

                let hijriDay = '', hijriMonthArabic = '', hijriYear = '';
                for (const part of hijriParts) {
                    if (part.type === 'day') hijriDay = arabicToBengaliNumbers(part.value);
                    else if (part.type === 'month') hijriMonthArabic = part.value;
                    else if (part.type === 'year') hijriYear = arabicToBengaliNumbers(part.value);
                }
                const hijriMonthBengali = hijriMonthArabicToBengali[hijriMonthArabic] || hijriMonthArabic;
                const hijriDateString = `${hijriDay} ${hijriMonthBengali} ${hijriYear} হিজরি`;

                // ক্যাশ করা HTML আপডেট
                cachedDatePartHTML = `<span class="text-green-700 dark:text-green-300">আজ</span> <span class="text-green-700 dark:text-green-300">${dayOfWeekBengali}</span>, <span class="text-blue-700 dark:text-blue-300">${gregorianDateString} ইং</span>, <span class="text-green-700 dark:text-green-300">${bengaliDateString.replace('বঙ্গাব্দ', '')} বঙ্গাব্দ, ${bengaliSeason}</span>, <span class="text-purple-700 dark:text-purple-300">${hijriDateString}</span>, <span class="text-green-700 dark:text-green-300">এখন সময়</span>`;
                
                lastDateUpdateTimestamp = currentTime;
                
                // লোকাল স্টোরেজে ক্যালকুলেটেড ডাটা সেভ রাখা (যদি পরে অফলাইনে দরকার হয়)
                localStorage.setItem('cachedBannerData', JSON.stringify({
                    html: cachedDatePartHTML,
                    timestamp: currentTime
                }));
            } else {
                // পেজ লোডের সময় যদি ভেরিয়েবল খালি থাকে তবে স্টোরেজ থেকে নেয়ার চেষ্টা
                if (!cachedDatePartHTML) {
                    const savedData = JSON.parse(localStorage.getItem('cachedBannerData') || '{}');
                    if (savedData.html) {
                        cachedDatePartHTML = savedData.html;
                    }
                }
            }

            // Time (সময়) - এটি সিস্টেম ক্লক থেকেই চলবে যাতে সেকেন্ডের কাঁটা স্মুথ থাকে
            const timeNow = new Date();
            const timeString = timeNow.toLocaleTimeString('bn-BD', {
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true, timeZone: 'Asia/Dhaka'
            });

            // সেকেন্ডের ফেড এফেক্ট
            if (timeNow.getSeconds() === 0) bannerElement.style.opacity = '1';
            else if (timeNow.getSeconds() === 59) bannerElement.style.opacity = '0';
            else if (timeNow.getSeconds() === 1 && bannerElement.style.opacity !== '1') bannerElement.style.opacity = '1';

            // ফাইনাল আউটপুট
            bannerElement.innerHTML = `${cachedDatePartHTML}<span class="text-green-700 dark:text-green-300 cursor-pointer hover:underline" onclick="switchToClockTab()" title="অ্যালার্ম সেট করতে ক্লিক করুন"> ${timeString}</span>`;
        }

        // প্রতি সেকেন্ডে আপডেট হবে
        setInterval(() => updateDateTimeBanner(false), 1000);
        updateDateTimeBanner(false); // শুরুতে একবার কল করা

// ====================================================================
// END: DATE AND TIME BANNER SCRIPT
// ====================================================================


// ====================================================================
// START: DARK MODE / LIGHT MODE TOGGLE SCRIPT
// ====================================================================
        const themeToggleBtn = document.getElementById('theme-toggle');

        // পৃষ্ঠা লোড হওয়ার সাথে সাথে থিম পরীক্ষা করুন
        if (localStorage.getItem('color-theme') === 'dark' || 
           (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        themeToggleBtn.addEventListener('click', function() {
            // 'dark' ক্লাস টগল করুন
            document.documentElement.classList.toggle('dark');

            // লোকাল স্টোরেজে পছন্দ সেভ করুন
            if (document.documentElement.classList.contains('dark')) {
                localStorage.setItem('color-theme', 'dark');
            } else {
                localStorage.setItem('color-theme', 'light');
            }
        });
// ====================================================================
// END: DARK MODE / LIGHT MODE TOGGLE SCRIPT
// ====================================================================

// ====================================================================
// START: FONT CONVERTER SCRIPT
// ====================================================================
        // ইউনিকোড থেকে বিজয় রূপান্তরের জন্য ম্যাপিং
        const unicodeToBijoyMap = {
            // স্বরবর্ণ সেকশন
            "অ": "A",        "আ": "Av",       "ই": "B",        "ঈ": "C",        "উ": "D",        "ঊ": "E",        "ঋ": "F",        "এ": "G",        "ঐ": "H",        "ও": "I",
            "ঔ": "J",

            // ব্যাঞ্জনবর্ণ সেকশন
            "ক": "K",        "খ": "L",        "গ": "M",        "ঘ": "N",        "ঙ": "O",        "চ": "P",        "ছ": "Q",        "জ": "R",        "ঝ": "S",        "ঞ": "T",
            "ট": "U",        "ঠ": "V",        "ড": "W",        "ঢ": "X",        "ণ": "Y",        "ত": "Z",        "থ": "_",        "দ": "`",        "ধ": "a",        "ন": "b",
            "প": "c",        "ফ": "d",        "ব": "e",        "ভ": "f",        "ম": "g",        "য": "h",        "র": "i",        "ল": "j",        "শ": "k",        "ষ": "l",
            "স": "m",        "হ": "n",        "ড়": "o",        "ঢ়": "p",        "য়": "q",        "ৎ": "r",        "ং": "s",        "ঃ": "t",        "ঁ": "u",        "ৰ": "v", "ড়": "o",        "ঢ়": "p",        "য়": "q",
             "র্বৃ": "e„©",       "ৱ": "w",     "ড়ে": "‡o",        "ঢ়ে": "‡p",        "য়ে": "‡q",   "ড়ৈ": "‰o",        "ঢ়ৈ": "‰p",        "য়ৈ": "‰q",    "ড়ি": "wo",   "ড়ো" :"‡ov",     "ঢ়ি": "wp",  	"য়ো": "‡qv",      "য়ি": "wq",
             
			 // নতুন যুক্ত করা ক্যারেক্টারসমূহ
             "ড়ৌ": "‡oŠ",      "ঢ়ো": "‡pv",      "ঢ়ৌ": "‡pŠ",      "য়ৌ": "‡qŠ",
			 
            // নম্বর সেকশন
            "০": "0",        "১": "1",        "২": "2",        "৩": "3",        "৪": "4",        "৫": "5",        "৬": "6",        "৭": "7",        "৮": "8",        "৯": "9",
            "৳": "৳",        "₹": "₹",

            // কার চিহ্ন সেকশন
            "া": "v",        "ি": "w",        "ী": "x",        "ু": "y",        "ূ": "~",        "ৃ": "„",

            // ফলা সেকশন
            "্র": "ª",        "্য": "¨",        "র্": "©",	

            // ওকার ঔকার সেকশন
            "ে": "‡",        "ৈ": "‰",        "ো": "‡v",       "ৌ": "‡Š",       "ৗ": "Š",

            // জয়েনার সেকশন
            "্": "&",

            // বিবিধ
            "।": "|",        "॥": "||",       "‘": "Ô",        "’": "Õ",        "“": "Ò",        "”": "Ó",        "৷": "৷",        "৥": "৥",


			
            // যুক্তবর্ণ সেকশন
            "ক্ক": "°",      "ক্ট": "±",      "ক্ত": "³",      "ক্ব": "K¡",     "ক্র": "µ",   "ক্লি": "wK¬",    "ক্ল": "K¬",     "ক্ষ": "¶",      "ক্স": "·",      "খ্র": "Lª",     "গ্দ": "M&`", 
            "গ্ধ": "»",      "গ্ন": "Mœ",     "গ্ম": "M¥",     "গ্র": "MÖ",     "গ্ল": "Mø",     "ঙ্ক": "¼",      "ঙ্খ": "•L",     "ঙ্গ": "½",      "ঙ্ঘ": "•N",     "চ্চ": "”P", 
            "চ্ছ": "”Q", "“ছ": "ÒQ",    "জ্জ": "¾",      "জ্ঝ": "À",      "জ্ঞ": "Á",      "জ্ব": "R¡",     "জ্র": "Rª",     "ঞ্চ": "Â",      "ঞ্ছ": "Ã",      "ঞ্জ": "Ä",	"ন্ব": "š^",
            "ঞ্ঝ": "Å",      "ট্ট": "Æ",      "ট্ব": "U¡",     "ট্ম": "U¥",     "ট্র": "Uª",     "ড্ড": "Ç",      "ড্র": "Wª",     "ঢ্র": "Xª",     "ণ্ট": "È",		"ত্ব": "Z¡",
            "ণ্ঠ": "É",      "ণ্ড": "Ð",      "ণ্ণ": "Yœ",     "ত্ত": "Ë",      "ত্থ": "Ì",      "ত্ন": "Zœ",     "ত্ম": "Z¥",     "ত্র": "Î",      "দ্দ": "Ï",		"ঙ্ম": "•g",	
            "দ্ধ": "×",      "দ্ব": "Ø",      "দ্ভ": "™¢",     "দ্ম": "Ù",      "দ্র": "`ª",     "ধ্ব": "aŸ",     "ধ্ম": "a¥",     "ন্ত": "šÍ",     "ন্থ": "š’",	"ক্ম": "´",
            "ন্দ": "›`",     "ন্ধ": "Ü",      "ন্ন": "bœ",     "ন্ম": "b¥",     "প্ট": "Þ",      "প্ত": "ß",      "প্ন": "cœ",     "প্প": "à",      "প্র": "cÖ",		"ক্ষ্ণ": "ÿè",
            "প্ল": "cø",     "প্স": "á",      "ফ্র": "d«",     "ফ্ল": "d¬",     "ব্জ": "â",      "ব্দ": "ã",      "ব্ধ": "ä",      "ব্ব": "eŸ",     "ব্র": "eª",	"গ্গ": "¹",
            "ব্ল": "eø",     "ভ্র": "å",      "ম্ন": "gœ",     "ম্ফ": "ç",      "ম্ব": "¤^",     "ম্ভ": "¤¢",     "ম্ম": "¤§",     "ম্র": "gª",     "ম্ল": "¤ø",	 "থ্ব": "_¡",
            "ল্ক": "é",      "ল্গ": "ê",      "ল্ট": "ë",      "ল্ড": "ì",      "ল্প": "í",      "ল্ব": "j¦",     "ল্ম": "j¥",     "ল্ল": "jø",     "শ্চ": "ð",	 "দ্দ্ব": "Ï¡",
            "শ্ন": "kœ",     "শ্ব": "k¦",     "শ্ম": "k¥",     "শ্ল": "kø",     "ষ্ক": "®‹",     "ষ্ট": "ó",      "ষ্ঠ": "ô",      "ষ্ণ": "ò",      "ষ্প": "®ú",	 "ন্ত্ব": "šÍ¡",
            "ষ্ফ": "õ",      "ষ্ম": "®§",     "স্ক": "¯‹",     "স্খ": "ö",      "স্ট": "÷",      "স্ত": "¯Í",     "স্থ": "¯’",     "স্ন": "mœ",     "স্প": "¯ú",	 "স্রূ": "¯ªƒ",
            "স্ফ": "ù",      "স্ব": "¯^",     "স্ম": "¯§",     "স্ল": "¯ø",     "হ্ণ": "nè",     "হ্ন": "ý",      "হ্ম": "þ",      "হ্ল": "n¬",     "হু": "û",		"ড়ু": "o–", 
            "হৃ": "ü",      "গু": "¸",      "শু": "ï",      "ক্ত্র": "³ª",     "ক্ন": "Kè",     "ক্ষ্ণ": "òœ",     "ক্ষ্ম": "²",      "ক্ষ্র": "ÿ«",     "গ্ব": "M&e",	"য়ু": "qy", 
            "ঘ্ন": "Nœ",     "ঘ্র": "Nª",     "ঙ্গু": "½y",     "জ্জ্ব": "¾¡",   "ত্ত্ব": "Ë¡",     "ত্রু": "Îæ",     "দ্রু": "`ªæ",    "ভ্রু": "åæ",     "শ্রু": "kÖæ",	"য়ূ": "q~",
            "ম্প": "¤ú",     "্র্য": "ª‍¨",    "র‌্য": "i¨",     "ক্য": "K¨",     "ল্যু": "j¨y",    "ক্লু": "K¬z",    "ত্র্য": "Î¨",     "স্থ্য": "¯’¨",    "দ্য": "`¨", 
            "ক্য": "K¨",     "ভ্য": "f¨",     "ল্য": "j¨", 	"দ্যু": "`y¨",     "ম্য": "g¨",     "ন্য": "b¨",     "ণ্য": "Y¨",     "কার্য": "Kvh©",   "র্ষ": "l©",       "র্য": "h©",		"উদ্‌যা": "D`&‌hv",
		"ব্যু": "ey¨",   "ত্ব": "Z¡",	"হ্ব": "nŸ",	"গ্নু": "Mœy",	"র্ু": "z©",       "৳": "$",      "র্ষূ": "l~©",        "র্ষু": "ly©",    "–": "-","৷": "|",	"ড়ূ": "o~",  "“ছ": "ÒQ", "স্ন": "¯œ",
       

		
		};

        // বিজয় থেকে ইউনিকোড রূপান্তরের জন্য ম্যাপিং
        const bijoyToUnicodeMap = {
            // স্বরবর্ণ সেকশন
            "A": "অ",        "Av": "আ",       "B": "ই",        "C": "ঈ",        "D": "উ",        "E": "ঊ",        "F": "ঋ",        "G": "এ",        "H": "ঐ",        "I": "ও",
            "J": "ঔ",

            // *** সংশোধিত অংশ শুরু ***
            "†": "ে", // 'এ' এর পরিবর্তে 'ে' (e-kar)
            "ˆ": "ৈ", // 'ঐ' এর পরিবর্তে 'ৈ' (oi-kar)
            // *** সংশোধিত অংশ শেষ ***
			"‡": "ে", // 'এ' এর পরিবর্তে 'ে' (e-kar)
            "‰": "ৈ",
            // ব্যাঞ্জনবর্ণ সেকশন
            "K": "ক",        "L": "খ",        "M": "গ",        "N": "ঘ",        "O": "ঙ",        "P": "চ",        "Q": "ছ",        "R": "জ",        "S": "ঝ",        "T": "ঞ",
            "U": "ট",        "V": "ঠ",        "W": "ড",        "X": "ঢ",        "Y": "ণ",        "Z": "ত",        "_": "থ",        "`": "দ",        "a": "ধ",        "b": "ন",
            "c": "প",        "d": "ফ",        "e": "ব",        "f": "ভ",        "g": "ম",        "h": "য",        "i": "র",        "j": "ল",        "k": "শ",        "l": "ষ",
            "m": "স",        "n": "হ",        "o": "ড়",        "p": "ঢ়",        "q": "য়",        "r": "ৎ",        "s": "ং",        "t": "ঃ",        "u": "ঁ",

            // নম্বর সেকশন
            "0": "০",        "1": "১",        "2": "২",        "3": "৩",        "4": "৪",        "5": "৫",        "6": "৬",        "7": "৭",        "8": "৮",        "9": "৯",
            "৳": "৳",

            // কার চিহ্ন সেকশন
            "v": "া",        "w": "ি",        "x": "ী",        "y": "ু",        "~": "ূ",        "„": "ৃ",		"‡v": "ো", 	"z": "ু", 	"†v": "ো",		"†Š": "ৌ", 	"‡Š": "ৌ",

            // ফলা সেকশন
            "ª": "্র",        "¨": "্য",        "©": "র্", 	"Ö": "্র",

            // ওকার ঔকার সেকশন
            "‡": "ে",        "‰": "ৈ",        "Š": "ৗ",

            // জয়েনার সেকশন
            "&": "্",

            // বিবিধ
           	"¯’": "¯’",		"”Q": "”Q",		 "|": "।",        "||": "॥",       "Ô": "‘",        "Õ": "’",        "Ò": "“",        "Ó": "”",        " ": " ",        ".": ".",        ",": ",",        "-": "-",
            "?": "?",        "!": "!",        "'": "'",        "(": "(",        ")": ")",	"iæ": "রু",	"eªæ": "ব্রু", 	"Zz": "তু",	"nŸ": "হ্ব",

            // যুক্তবর্ণ সেকশন
            "°": "ক্ক",      "±": "ক্ট",      "³": "ক্ত",      "K¡": "ক্ব",     "µ": "ক্র",  "wK¬": "ক্লি",     "K¬": "ক্ল",     "¶": "ক্ষ",      "·": "ক্স",      "Lª": "খ্র",     "M&`": "গ্দ",
            "»": "গ্ধ",      "Mœ": "গ্ন",     "M¥": "গ্ম",     "MÖ": "গ্র",     "Mø": "গ্ল",     "¼": "ঙ্ক",      "•L": "ঙ্খ",     "½": "ঙ্গ",      "•N": "ঙ্ঘ",     "”P": "চ্চ", 
            "”Q": "চ্ছ",     "¾": "জ্জ",      "À": "জ্ঝ",      "Á": "জ্ঞ",      "R¡": "জ্ব",     "Rª": "জ্র",     "Â": "ঞ্চ",      "Ã": "ঞ্ছ",      "Ä": "ঞ্জ",	"cÖæ": "প্রু",
            "Å": "ঞ্ঝ",      "Æ": "ট্ট",      "U¡": "ট্ব",     "U¥": "ট্ম",     "Uª": "ট্র",     "Ç": "ড্ড",      "Wª": "ড্র",     "Xª": "ঢ্র",     "È": "ণ্ট",	"MÖæ": "গ্রু",
            "É": "ণ্ঠ",      "Ð": "ণ্ড",      "Yœ": "ণ্ণ",     "Ë": "ত্ত",      "Ì": "ত্থ",      "Zœ": "ত্ন",     "Z¥": "ত্ম",     "Î": "ত্র",      "Ï": "দ্দ",	"¯ª": "স্র",
            "×": "দ্ধ",      "Ø": "দ্ব",      "™¢": "দ্ভ",     "Ù": "দ্ম",      "`ª": "দ্র",     "aŸ": "ধ্ব",     "a¥": "ধ্ম",     "šÍ": "ন্ত",     "š’": "ন্থ",   "e„©": "র্বৃ",
            "›`": "ন্দ",     "Ü": "ন্ধ",      "bœ": "ন্ন",     "b¥": "ন্ম",     "Þ": "প্ট",      "ß": "প্ত",      "cœ": "প্ন",     "à": "প্প",      "cÖ": "প্র", 	"¤œ": "ম্ন",
            "cø": "প্ল",     "á": "প্স",      "d«": "ফ্র",     "d¬": "ফ্ল",     "â": "ব্জ",      "ã": "ব্দ",      "ä": "ব্ধ",      "eŸ": "ব্ব",     "eª": "ব্র",	 "´": "ক্ম",
            "eø": "ব্ল",     "å": "ভ্র",      "gœ": "ম্ন",     "ç": "ম্ফ",      "¤^": "ম্ব",     "¤¢": "ম্ভ",     "¤§": "ম্ম",     "gª": "ম্র",     "¤ø": "ম্ল",		"ÿè": "ক্ষ্ন",
            "é": "ল্ক",      "ê": "ল্গ",      "ë": "ল্ট",      "ì": "ল্ড",      "í": "ল্প",      "j¦": "ল্ব",     "j¥": "ল্ম",     "jø": "ল্ল",     "ð": "শ্চ",		"ÿ&Y": "ক্ষ্ণ",
            "kœ": "শ্ন",     "k¦": "শ্ব",     "k¥": "শ্ম",     "kø": "শ্ল",     "®‹": "ষ্ক",     "ó": "ষ্ট",      "ô": "ষ্ঠ",      "ò": "ষ্ণ",      "®ú": "ষ্প",		"¹": "গ্গ",
            "õ": "ষ্ফ",      "®§": "ষ্ম",     "¯‹": "স্ক",     "ö": "স্খ",      "÷": "স্ট",      "¯Í": "স্ত",     "¯’": "স্থ",     "mœ": "স্ন",     "¯ú": "স্প",	"M&M": "গ্গ",
            "ù": "স্ফ",      "¯^": "স্ব",     "¯§": "স্ম",     "¯ø": "স্ল",     "nè": "হ্ণ",     "ý": "হ্ন",      "þ": "হ্ম",      "n¬": "হ্ল",     "û": "হু",	"_¡": "থ্ব",
            "ü": "হৃ",      "¸": "গু",      "ï": "শু",      "³ª": "ক্ত্র",     "Kè": "ক্ন",     "òœ": "ক্ষ্ণ",     "²": "ক্ষ্ম",      "ÿ«": "ক্ষ্র",     "M&e": "গ্ব",	"Ï¡": "দ্দ্ব",
            "Nœ": "ঘ্ন",     "Nª": "ঘ্র",     "½y": "ঙ্গু",     "¾¡": "জ্জ্ব",   "Ë¡": "ত্ত্ব",     "Îæ": "ত্রু",     "`ªæ": "দ্রু",     "åæ": "ভ্রু",     "kÖæ": "শ্রু",	"šÍ¡": "ন্ত্ব",
            "¤ú": "ম্প",     "ª‍¨": "্র্য",    "i¨": "র‌্য",     "K¨": "ক্য",     "j¨y": "ল্যু",    "K¬z": "ক্লু",    "Î¨": "ত্র্য",     "¯’¨": "স্থ্য",    "`¨": "দ্য",	"gø": "ম্ল",
            "f¨": "ভ্য",     "j¨": "ল্য",     "g¨": "ম্য",     "b¨": "ন্য",     "Y¨": "ণ্য",     "Kv¨": "ক্যা",      	"ÿ": "ক্ষ",		"åƒ": "ভ্রূ",	"¯ªƒ": "স্রূ", "”Q¡": "চ্ছ্ব",
		"Z¡": "ত্ব",	"Û": "ন্ড",	"š¿": "ন্ত্র",    "z©": "র্ু", 	"y¨": "্যু",      "©…": "র্ৃ",     "z©": "র্ু",   "z©": "র্ু",    "‚©": "র্ূ",  "•ÿ": "ঙ্ক্ষ", "b¦": "ন্ব",	"¯cø": "স্প্ল",
		"~¨": "্যূ",   "z¨": "্যু",        "‚¨": "্যূ",  	"Kz©¨": "র্ক্যু",   "K‚©¨": "র্ক্যূ",  "³": "ক্ত",       "¯‘": "স্তু", 	"¯¿": "স্ত্র", 	"vu": "াঁ", 	"œ": "্ন",	"¼Í": "ঙ্ক্ত",
		"uv": "াঁ",	 "›Uª": "ন্ট্র",     "n«": "হ্র",	    "š‘": "ন্তু",	    "Z…": "তৃ",	    "K…": "কৃ",	    "P‚": "চূ",	    "f‚": "ভূ",	    "iƒ": "রূ",	  "¦": "্ব",
		"›U": "ন্ট",	    "«": "্র",	    "…": "ৃ",	    "‚": "ূ", 	     "æ": "ু",      "Ý": "ন্স",      "š^": "ন্ব",    "MÖƒ": "গ্রূ", "cÖƒ": "প্রূ", 
			"eªƒ": "ব্রূ", "kÖƒ": "শ্রূ",	"_¦": "থ্ব", "˜M": "দ্গ", "˜N": "দ্ঘ", "Ï": "দ্দ", "$": "৳", "K¥": "ক্ম", "òœ": "ক্ষ্ণ", "M&M": "গ্গ", "º": "গ্দ", "˜M": "দ্গ", "O¥": "ঙ্ম", "”T": "চ্ঞ", "D`&‌hv": "উদ্‌যা", "D`&‌&‌hv": "উদ্‌যা",
"Y&X": "ণ্ঢ", "Y¥": "ণ্ম", "Zø": "ত্ল", "Îƒ": "ত্রূ", "_¦": "থ্ব", "_ø": "থ্ল", "™£": "দ্ভ্র", "`ªƒ": "দ্রূ", "Ú": "ন্ঠ", "šÍ¦": "ন্ত্ব", "š’": "ন্থ", "åƒ": "ভ্রূ", "fø": "ভ্ল", "¤£": "ম্ভ্র", "¤ø": "ম্ল",
"î": "ল্ফ", "ñ": "শ্ছ", "®Œ": "ষ্ক্র", "¯Œ": "স্ক্র", "¯’": "স্থ", "¯ª~": "স্রূ", "¯ø": "স্ল", "—M": "ড়্গ", "aªƒ": "ধ্রূ", "¯úø": "স্প্ল", "¤úø": "ম্প্ল", "•g": "ঙ্ম", 	"mø": "স্ল", "¯": "্স",  "Zz¨": "ত্যু",	"¨~": "্যূ",	"o–": "ড়ু", "›Ø": "ন্দ্ব",
"¯œ": "স্ন",
				
		};
        // ====================================================================
        // ম্যানুয়াল আনসি (বিজয়) রিপ্লেসমেন্ট ম্যাপ
        // ইউনিকোড থেকে বিজয় কনভার্সনের পর নির্দিষ্ট ভুল সংশোধনের জন্য ব্যবহৃত হয়।
        // ফরম্যাট: "ভুল স্ট্রিং": "সঠিক স্ট্রিং"
        const manualAnsiReplacements = {
            // নিচেরগুলোর মতো ম্যানুয়ালী বসাতে হবে সিকুয়েন্স, যদি আন্সিতে কোনো ভুল আউটপুট আসে।
            // ভবিষ্যতে আরও রিপ্লেসমেন্ট নিয়ম এখানে যোগ করুন
            "GZ‡": "G‡Z", // "এতে" GZ‡ কে G‡Z দিয়ে প্রতিস্থাপন করা হয়েছে, আন্সিতে ভুল আউটপুট এখানে এভাবে অ্যাড করতে হবে, আন্সি ভুল টু আন্সি সঠিক
			"‡ga¨": "g‡a¨",        "P&P": "”P",      "¨y": "y¨",       "©„": "©…",        "—": "-",        	"¯’": "¯’",		"”Q": "”Q",
			"+‡": "+†",        "+‰": "+ˆ",       "vu": "uv",       "xu": "ux",       "Šu": "uŠ",      "`¨y": "`y¨",           "Ô‡": "Ô†",       "Ò‡": "Ò†",      "-‡": "-†",       "(‡": "(†",       "Ô‰": "Ôˆ", // Corrected from "ˆ"
			"Ò‰": "Òˆ",        "-‰": "-ˆ",       "(‰": "ˆ",       "¶y": "ÿz",       "ww¯’Z": "w¯’wZ",      "cz©": "c©y",     "‡‡": "‡",        "††": "†",	"©z": "z©",
			"‰‰": "‰",         "ˆˆ": "ˆ",        "yy": "y",        "~~": "~",        "©©": "©",       "„„": "„",        "&&": "&",        "ªª": "ª",        "ŠŠ": "Š",
			"/‡": "/†",        "/‰": "(ˆ",       "=‡": "=†",       "=‰": "=ˆ",       "[‡": "[†",      "[‰": "[ˆ",      "{‡": "{†",       "{‰": "{ˆ",       " ‡": " †",
			" ‰": " ˆ",         "&;": "Ê",        "&|": "\\",      "&~": "E",        "&„": "F",        "&‡": "G",        "&‰": "H",
			"&b": "œ",         "&e": "¦",        "&g": "¥",        "&I": "I",        "&I&h": "I¨",    "&I&i": "Iª",     "&j": "ø",        "&Ô": "“",        "&Š": "J",
			"&v": "Av",        "&w": "B",        "&x": "C",        "&y": "D",        "&Z": "Í",        "(A)i": "(A)i",  "_&_": "Ì",       "_&e": "_¡",       "_&h": "_¨",
			"_&i": "_ª",        "_ª": "_ª",        "_u_": "Ì",       "`&`": "Ï",       "`&a": "×",       "`&e": "Ø",        "`&f": "™¢",      "`&g": "Ù",        "`&h": "`¨",
			"`&i": "`ª",        "`&M": "˜M",       "`&N": "˜N",       "`ª": "`ª",       "`ª~": "`ªƒ",      "`ªy": "`ªæ",      "¯’~": "¯’‚",      "¯’„": "¯’…",      "¯’y": "¯’z",
			"¯‹&i": "¯Œ",       "¯‹&iæ": "¯Œz",   "¯‹&j": "¯‹¬",    "¯‹~": "¯‹‚",      "¯‹„": "¯‹…",      "¯‹¬y": "¯‹¬z",   "¯‹ª": "¯Œ",      "¯‹y": "¯‹z",      "¯Í&e": "¯Í¡",
			"¯Í&i": "¯¿",       "¯Í~": "¯Í‚",      "¯Í„": "¯Í…",      "¯Íª": "¯¿",       "¯Íy": "¯‘",      "¯Œ~": "¯Œ‚",      "¯Œ„": "¯Œ…",      "¯Œy": "¯Œz",      "¯ú&j": "¯úø",
			"˜M&y": "`&¸",      "”P~": "”P‚",      "”P„": "”P…",      "”Py": "”Pz",      "”Q&e": "”Q¡",    "”Q~": "”Q‚",      "”Q„": "”Q…",      "”Qª": "”Q«",      "”Qy": "”Qz",
			"”T~": "”T‚",      "”T„": "”T…",      "”Ty": "”Tz",      "›`&e": "›Ø",     "›`ª~": "›`ªƒ",   "›`ªy": "›`ªæ",   "›U~": "›U‚",      "›U„": "›U…",      "›Uy": "›Uz",
			"¤¢&i": "¤£",      "¤¢ª": "¤£",      "¤ú&i": "¤úª",    "¤ú&j": "¤úø",    "±~": "±‚",       "±„": "±…",       "±y": "±z",       "»~": "»‚",       "»„": "»…",
			"»y": "»z",        "×~": "×‚",       "×„": "×…",       "×y": "×z",       "÷~": "÷‚",      "÷„": "÷…",       "÷y": "÷z",       "®‹~": "®‹‚",      "®‹„": "®‹…",
			"®‹ª": "®Œ",       "®‹y": "®‹z",      "®Œ~": "®Œ‚",      "®Œ„": "®Œ„",      "®Œy": "®Œz",      "®úª": "®úÖ",    "®úª~": "®úÖƒ",   "®úªy": "®úÖæ",   "°~": "°‚",
			"°„": "°…",        "°y": "°z",        "µ~": "µ‚",       "µ„": "µ…",       "µy": "µz",       "•ÿ~": "•ÿ‚",      "•ÿ„": "•ÿ…",      "•ÿy": "•ÿz",      "¼&l": "•ÿ",
			"¼~": "¼‚",        "¼„": "¼…",       "¼«~": "¼«‚",      "¼«„": "¼«…",      "¼«y": "¼«z",      "¼ª": "¼«",       "¼y": "¼z",       "¾&e": "¾¡",      "³~": "³‚",
			"³„": "³…",        "³ª": "³«",       "³y": "³z",       "a&e": "aŸ",       "a&g": "a¥",       "a&h": "a¨",       "A&h": "A¨",       "a&i": "aª",       "A&i": "Aª",
			"Á~": "Á‚",        "À~": "À‚",       "ä~": "ä‚",       "Ã~": "Ã‚",       "å~": "åƒ",       "Â‚": "Â‚",       "Á„": "Á…",       "À„": "À…",       "ä„": "ä…",
			"Ã„": "Ã…",        "Â…": "Â…",       "aª": "aª",       "Aª": "Aª",       "aª~": "aªƒ",      "aªy": "aªæ",      "Æ~": "Æ‚",       "Æ„": "Æ…",       "Æy": "Æz",
			"Av&h": "Av¨",     "Av&i": "Avª",    "Avª": "Avª",      "Áy": "Áz",       "Ây": "Âz",       "äy": "äz",       "Ãy": "Ãz",       "åy": "åæ",       "Àz": "Àz",
			"b&_": "š’",       "b&`": "›`",      "b&a": "Ü",       "b&b": "bœ",       "b&e": "š^",       "b&g": "b¥",       "b&h": "b¨",       "B&h": "B¨",       "b&i": "bª",
			"B&i": "Bª",        "b&m": "Ý",        "b&U": "›U",      "b&V": "Ú",       "b&W": "Û",       "b&Z": "šÍ",      "b&Z&i": "š¿",    "b&Zª": "š¿",      "bª": "bª",
			"Bª": "Bª",         "c&b": "cœ",       "c&c": "à",       "c&h": "c¨",       "C&h": "C¨",       "c&i": "cÖ",       "C&i": "Cª",       "c&j": "cø",       "c&m": "á",
			"c&U": "Þ",        "c&Z": "ß",       "ç~": "ç‚",       "Ç~": "Ç‚",       "ç„": "ç…",       "Ç„": "Ç…",       "cª": "cÖ",       "Cª": "Cª",       "cª~": "cÖƒ",
			"cªy": "cÖæ",      "cÖ~": "cÖƒ",      "cÖy": "cÖæ",      "çy": "çz",       "Çy": "Çz",       "d&h": "d¨",       "d&i": "d«",       "D&i": "Dª",       "d&j": "d¬",
			"d~": "d‚",        "ð~": "ð‚",       "Ð~": "Ð‚",       "d„": "d…",       "ð„": "ð…",       "Ð„": "Ð…",       "d«~": "d«‚",      "d«„": "d«…",      "d«y": "d«z",
			"d¬~": "d¬‚",      "d¬„": "d¬„",      "d¬y": "d¬z",      "dª": "d«",       "dy": "dz",       "ðy": "ðz",       "Ðy": "Ðz",       "e&`": "ã",       "e&a": "ä",
			"e&e": "eŸ",       "Ë&e": "Ë¡",      "e&h": "e¨",       "e&i": "eª",       "E&i": "Eª",       "e&j": "eø",       "e&R": "â",       "é~": "é‚",       "É~": "É‚",
			"È~": "È‚",        "ë~": "ë‚",      "Ë~": "Ë‚",       "é„": "é…",       "É„": "É…",       "È„": "È…",       "ë„": "ë…",       "Ë„": "Ë…",       "eª": "eª",
			"eª~": "eªƒ",      "eªy": "eªæ",      "éy": "éz",       "Éy": "Éz",       "Èy": "Èz",       "ëy": "ëz",       "Ëy": "Ëz",       "f&h": "f¨",       "F&h": "F¨",
			"f&i": "å",        "F&i": "Fª",       "f&j": "fø",      "f~": "f‚",       "f„": "f…",       "fª": "å",        "Fª": "Fª",       "fª~": "åƒ",      "fªy": "åæ",
			"fy": "fz",        "g&b": "¤œ",       "g&c": "¤ú",      "g&d": "ç",       "g&e": "¤^",       "g&f": "¤¢",       "g&f&i": "¤£",    "g&fª": "¤£",      "g&g": "¤§",
			"g&h": "g¨",       "G&h": "G¨",       "g&i": "¤ª",      "G&i": "Î",       "g&j": "¤ø",       "gª": "¤ª",       "Gª": "Gª",       "h&h": "h¨",       "H&h": "H¨",
			"h&i": "hª",       "H&i": "Hª",       "hª": "hª",       "Hª": "Hª",       "i&&I": "I©",     "i&_": "_©",       "i&`": "`©",      "i&a": "a©",       "i&A": "A©",
			"i&Av": "Av©",     "i&b": "b©",       "i&B": "B©",       "i&c": "c©",       "i&C": "C©",       "i&d": "d©",       "i&D": "D©",       "i&e": "e©",       "i&E": "E©",
			"i&f": "f©",       "i&F": "F©",       "i&g": "g©",       "i&G": "G©",       "i&h": "h©",       "i&H": "H©",       "i&i": "iª",       "i&I": "I©",       "I&i": "Iª",
			"i&j": "j©",       "i&J": "J©",       "i&k": "k©",       "i&K": "K©",       "i&l": "l©",       "i&L": "L©",       "i&m": "m©",       "i&M": "M©",       "i&n": "n©",
			"i&N": "N©",       "i&o": "o©",       "i&O": "O©",       "i&p": "p©",       "i&P": "P©",       "i&q": "q©",       "i&Q": "Q©",       "i&R": "R©",       "i&S": "S©",
			"i&T": "T©",       "i&U": "U©",       "i&V": "V©",       "i&W": "W©",       "i&X": "X©",       "i&Y": "Y©",       "i&Z": "Z©",       "i~": "iƒ",        "î~": "î~",
			"Î~": "Îƒ",       "î„": "î…",       "iª": "iª",        "Iª": "Iª",        "îª": "î«",       "iy": "iæ",        "îy": "îz",        "Îy": "Îæ",       "j&c": "í",
			"j&d": "î",        "j&d&i": "î«",     "j&dª": "î«",      "j&e": "j¦",       "j&g": "j¥",       "j&h": "j¨",       "J&h": "J¨",       "j&i": "jª",       "j&j": "jø",
			"j&K": "é",        "j&M": "ê",        "j&U": "ë",       "j&W": "ì",        "jª": "jª",        "Jª": "Jª",        "k&b": "kœ",       "K&b": "Kè",       "k&e": "k¦",
			"K&e": "K¡",       "k&g": "k¥",       "K&g": "´",        "k&h": "k¨",       "K&h": "K¨",       "k&i": "kÖ",       "K&i": "µ",        "K&j": "K¬",       "K&K": "°",
			"K&l": "ÿ",        "K&m": "·",        "k&P": "ð",       "k&Q": "ñ",        "K&U": "±",       "K&Z": "³",       "K&Zª": "³«",      "K~": "K‚",        "K„": "K…",
			"K¬~": "K¬‚",      "K¬„": "K¬…",      "K¬y": "K¬z",      "kª": "kÖ",       "Kª": "µ",        "kª~": "kÖƒ",      "Kª~": "µ’",      "kªy": "kÖæ",      "Kªy": "µ",
			"Kè~": "Kè‚",      "Kè„": "Kè…",      "Kèy": "Kèz",      "kÖ~": "kÖƒ",      "kÖy": "kÖæ",      "ky": "ï",        "Ky": "Kz",        "l&c": "®ú",      "l&d": "õ",
			"l&g": "®§",       "l&h": "l¨",       "L&h": "L¨",       "l&i": "lª",       "L&i": "Lª",       "l&K": "®‹",       "l&U": "ó",       "l&V": "ô",       "l&Y": "ò",
			"lª": "lª",        "Lª": "Lª",        "Lª~": "Lªƒ",      "Lªy": "Lªæ",      "m&_": "¯’",       "M&`": "º",       "M&a": "»",       "m&b": "¯œ",       "M&b": "Mœ",
			"m&c": "¯ú",       "m&d": "ù",        "m&e": "¯^",       "M&e": "M¦",       "m&g": "¯§",       "M&g": "M¥",       "m&h": "m¨",       "M&h": "M¨",       "m&i": "¯ª",
			"M&i": "MÖ",       "m&j": "¯ø",       "M&j": "Mø",       "m&K": "¯‹",       "m&K&i": "¯Œ",     "m&K&iy": "¯Œz",  "m&Kª": "¯Œ",      "m&Kªy": "¯Œz",    "m&L": "ö",
			"m&U": "÷",        "m&Z": "¯Í",      "mª": "¯ª",       "Mª": "MÖ",       "Mª~": "MÖƒ",      "Mªy": "MÖæ",      "MÖ~": "MÖƒ",      "MÖy": "MÖæ",      "My": "¸",
			"n&b": "ý",        "N&b": "Nœ",       "n&e": "nŸ",       "n&e2": "n¡",     "n&g": "þ",        "n&h": "n¨",       "N&h": "N¨",       "n&i": "n«",       "N&i": "Nª",
			"n&j": "n¬",       "n&Y": "nè",       "ñ~": "ñ‚",       "n„": "ü",        "ñ„": "ñ…",       "nª": "n«",       "Nª": "Nª",       "Nª~": "Nªƒ",      "Nªy": "Nªæ",
			"ny": "û",         "ñy": "ñz",        "O&g": "•g",       "o&h": "o¨",       "O&h": "O¨",       "o&i": "oª",       "O&i": "Oª",       "O&K": "¼",       "O&L": "•L",
			"o&M": "—M",       "O&M": "½",        "O&N": "•N",       "O~": "O‚",        "ó~": "ó‚",       "ò~": "ò‚",       "ô~": "ô‚",       "õ~": "õ‚",       "O„": "O…",
			"ó„": "ó…",        "ò„": "ò…",       "ô„": "ô…",       "õ„": "õ…",       "oª": "oª",       "Oª": "Oª",       "oy": "o–",       "Oy": "Oz",        "óy": "óz",
			"òy": "òz",        "ôy": "ôz",       "õy": "õz",       "p&h": "p¨",       "P&h": "P¨",       "p&i": "pª",       "P&i": "Pª",       "P&P": "”P",       "P&Q": "”Q",
			"P&T": "”T",       "P~": "P‚",        "P„": "P…",       "pª": "pª",       "Pª": "Pª",       "Puv": "Pvu",      "Py": "Pz",        "q&h": "q¨",       "Q&h": "Q¨",
			"q&i": "qª",       "Q&i": "Q«",       "Q~": "Q‚",        "Q„": "Q…",       "qª": "qª",       "Qª": "Q«",       "Qy": "Qz",        "R&e": "R¡",       "R&h": "R¨",
			"R&i": "Rª",       "R&R": "¾",        "R&S": "À",        "R&T": "Á",       "Rª": "Rª",       "rª\t": "rª",     "S&h": "S¨",       "S&i": "Sª",       "S~": "S‚",
			"š’~": "š’‚",      "š’„": "š’…",      "š’y": "š’z",      "S„": "S…",       "sª": "sª",       "Sª": "Sª",       "šÍ&i": "š¿",     "šÍ~": "šÍ‚",      "šÍ„": "šÍ…",
			"šÍª": "š¿",       "šÍy": "š‘",       "ß~": "ß‚",       "ß„": "ß…",       "ßy": "ßz",       "Sy": "Sz",        "T&h": "T¨",       "T&i": "Tª",       "T&P": "Â",
			"T&Q": "Ã",        "T&R": "Ä",        "T&S": "Å",        "T~": "T‚",        "T„": "T…",       "tª": "tª",       "Tª": "Tª",       "þ~": "þ~",        "Þ~": "Þ‚",
			"þ„": "þ„",        "Þ„": "Þ…",       "þy": "þz",       "Þy": "Þz",       "Ty": "Tz",        "™¢~": "™¢‚",      "™¢„": "™¢…",      "™¢ª": "™£",      "™¢y": "™¢z",
			"™£~": "™£ƒ",      "™£y": "™£æ",      "U&e": "U¡",       "U&g": "U¥",       "U&h": "U¨",       "U&i": "Uª",       "U&U": "Æ",       "U~": "U‚",        "Ú~": "Ú‚",
			"ù~": "ù‚",        "Û~": "Û‚",       "Ü~": "Ü‚",       "U„": "U…",       "Ú„": "Ú…",       "ù„": "ù…",       "Û„": "Û…",       "Ü„": "Ü…",       "ù«~": "ù«‚",
			"Ü«~": "Ü«‚",      "Ü«„": "Ü«…",      "ù«y": "ù«z",      "Ü«y": "Ü«z",      "Uª": "Uª",       "ùª": "ù«",       "Üª": "Ü«",       "uŠ": "Šu",        "ux": "xu",
			"uy": "yu",        "Uy": "Uz",        "Úy": "Úz",       "ùy": "ùz",       "Ûy": "Ûz",       "Üy": "Üz",       "V&h": "V¨",       "V&i": "Vª",       "V~": "V‚",
			"V„": "V…",        "Vª": "Vª",        "Vy": "Vz",        "W&h": "W¨",       "W&i": "Wª",       "W&W": "Ç",       "W~": "W‚",        "W„": "W…",       "Wª": "Wª",
			"Wy": "Wz",        "X&h": "X¨",       "X&i": "Xª",       "X~": "X‚",        "X„": "X…",       "Xª": "Xª",       "Xy": "Xz",        "Y&b": "Yœ",       "ÿ&b": "ÿè",
			"Y&e": "Y¦",       "ÿ&g": "²",        "Y&h": "Y¨",       "Y&i": "Yª",       "Y&U": "È",       "Y&V": "É",       "Y&W": "Ð",       "ÿ~": "ÿ‚",         "ÿ„": "ÿ…",
			"Yª": "Yª",        "ÿè~": "ÿè‚",      "ÿè„": "ÿè…",      "ÿèy": "ÿèz",      "ÿy": "ÿz",       "Z&_": "Ì",       "Z&b": "Zœ",       "Z&e": "Z¡",          "Z&g": "Z¥",
			"Z&h": "Z¨",       "Z&i": "Î",        "Z&Z": "Ë",       "Z~": "Z‚",        "Z„": "Z…",       "Zª": "Î",        "Zª~": "Îƒ",          "Zªy": "Îæ",           "Zy": "Zz",
			"|‡": "|†",			",‡": ",†",			".‡": ".†",			"-‡": "-†",			"?‡": "?†",		":‡": ":†",			"=‡": "=†",			"|‰": "|ˆ",	     "K©~": "K‚©",	
			",‰": ",ˆ",		"f¨~": "f‚¨",				"f©~": "f‚©",		".‰": ".ˆ",		"-‰": "-ˆ",			"?‰": "?ˆ",			":‰": ":ˆ",		"=‰": "=ˆ",   "wwK¬": "wK¬w",
			"e©…": "e„©",	   "e¨~": "e~¨",    	  "P©~": "P‚©Ó",   		 "P©y": "Pz©",     "K©y" :"Kz©", 			"f©y": "fz©",		 "Ky": "Kz",	"v©": "©v",		"x©": "©x",
			"Š©": "©Š", 		"¯Õ": "¯’",			"ÓQ": "”Q", 
			
			//"ÒQ": "”Q",Default:ΝŨťŚŨ ňŬŚΝǑ ĺř ųŊŴŖŚŔŨř  ĺř őŨŗ ųŗŨŦ śũŞŏūίŨŗŨő ũŝŕŨō
			
			"wwó": "wów",	"šÔ": "š‘",	"dÖ": "d«",  "f’": "f‚",	"šÕ": "š’", "¯Ô": "¯‘",	"ÓP": "”P", "ÓT": "”T", "e«": "eª", 	"g…": "g„",	"e…" : "e„",	"U«" : "Uª",	"d«" : "d«",	"k«" : "kÖ",	"'‡" : "'†",	"D`¨vc": "D`&&hvc", "D`¨vwc": "D`&&hvwc", "D`¨vcx": "D`&&hvcx",
			"'‰" : "'ˆ",		"gœ": "¤œ",		"Auv": "Avu",		"iÒ": "iæ",		"M«": "MÖ",	"KÍ¡": "³¦", "¯-":"¯Í", 	"U©y": "Uz©",	"¨~": "‚¨", 		"©¨y": "y©¨", "©¨~": "~¨",	"¨©": "©¨",	"©¨z": "z©¨", "©¨‚": "‚©¨",	"©z": "z©",	"©‚": "‚©",	"©y": "y©", "©~": "~©", "P‚©Ó": "P‚©",	"MÖÒ": "MÖæ",	"Ê": "æ",	"­": "ø",
			"b‚": "b~", "”Q¦": "”Q¡", "h়": "q","h‡়v": "‡qv","h‡়": "‡q","Ww়": "wo", "›`«": "›`ª", "fÕZ": "f‚Z", "fÕwg": "f‚wg", "fÕgx": "f‚gx", "fÕ‡g": "f‚‡g", "fÕ†g": "f‚‡g", "bz": "by",
			"ÎÒ": "Îæ", "_ªÒ": "_ªæ", "×Ÿ": "×¦", "`ªÒ": "`ªæ", "š-": "šÍ", "š-¡": "šÍ¦", "c&Î": "ßª", "cÖÒ": "cÖæ", "eªÒ": "eªæ", "åÒ": "åæ", "kÖÒ": "kÖæ", "¯ªÒ": "¯ªæ", "c«": "cÖ",	"÷«": "÷ª",	"U«": "Uª", "n¦": "nŸ",
			"Z¨z" : "Zz¨", "wL«": "wLª", "`«": "`ª",  "c…": "c„",  "¯§…": "¯§„", "N«": "Nª",
        };

        // ম্যানুয়াল ইউনিকোড রিপ্লেসমেন্ট ম্যাপ (নতুন সেকশন)
        // বিজয় থেকে ইউনিকোড কনভার্সনের পর নির্দিষ্ট ভুল সংশোধনের জন্য ব্যবহৃত হয়।
        // ফরম্যাট: "ভুল স্ট্রিং": "সঠিক স্ট্রিং"
        const manualUnicodeReplacements = {
            // "ভুল ইউনিকোড": "সঠিক ইউনিকোড",
            // উদাহরণ: "উদাহরণ": "উদাহরণ", 
			
			"র্তু্য": "র্ত্যু",
			"র্তূ্য": "র্ত্যূ",
			"র্ভূ্য": "র্ভ্যূ",
			"র্ভু্য": "র্ভ্যু",
			"উদ্্যা": "উদ্‌যা",
        };
        // ====================================================================


        // দীর্ঘতম থেকে ছোট ক্রমে কীগুলি সাজান যাতে দীর্ঘ ক্রমগুলি প্রথমে হ্যান্ডেল করা যায়
        const sortedUnicodeKeys = Object.keys(unicodeToBijoyMap).sort((a, b) => b.length - a.length);
        const sortedBijoyKeys = Object.keys(bijoyToUnicodeMap).sort((a, b) => b.length - a.length);

	function convertLeftToRight() {
            const textAreaLeft = document.getElementById('textAreaLeft');
            const textAreaRight = document.getElementById('textAreaRight');
            let unicodeInput = textAreaLeft ? textAreaLeft.value : '';

            // --- নরমালাইজেশন (Normalization) [নতুন যুক্ত করা হয়েছে] ---
            // ইনপুট থেকে ডিকম্পোজড অক্ষরগুলো (যেমন: য়, ড়, ঢ়) সঠিক ইউনিকোড ক্যারেক্টারে রূপান্তর
            unicodeInput = unicodeInput
                .replace(/য়/g, 'য়')
                .replace(/ড়/g, 'ড়')
                .replace(/ঢ়/g, 'ঢ়');

            // --- ক্যারেক্টার ডেফিনিশন ---
            const bengaliConsonants = 'কখগঘঙচছজঝঞটঠডঢণতথদধনপফবভমযরলশষসহড়ঢ়য়';
            const unicodeIkar = '\u09BF'; // ি
            const unicodeEkar = '\u09C7'; // ে
            const unicodeOikar = '\u09C8'; // ৈ
            const unicodeOkar = '\u09CB'; // ো
            const unicodeOukar = '\u09CC'; // ৌ
            const unicodeAkar = '\u09BE'; // া
            const unicodeOuKarPart2 = '\u09D7'; // ৗ
            const unicodeHasanta = '\u09CD'; // ্
            const unicodeRefChar = '\u09B0\u09CD'; // র্ (র + হসন্ত)
            const unicodeJaPhala = '\u09CD\u09AF'; // ্য (হসন্ত + য)
            const unicodeRaPhala = '\u09CD\u09B0'; // ্র (হসন্ত + র)

            // --- প্রি-প্রসেসিং ধাপ ---

            // ধাপ ১: ও-কার এবং ঔ-কারকে তাদের উপাদান অংশে বিভক্ত করুন
            const consonantOrConjunct = `(?:(?:[${bengaliConsonants}]${unicodeHasanta})+[${bengaliConsonants}]|[${bengaliConsonants}])`;
            const o_ou_kar_regex = new RegExp(`(${consonantOrConjunct})(${unicodeOkar}|${unicodeOukar})`, 'g');
            unicodeInput = unicodeInput.replace(o_ou_kar_regex, (match, base, vowelSign) => {
                if (vowelSign === unicodeOkar) return base + unicodeEkar + unicodeAkar;
                if (vowelSign === unicodeOukar) return base + unicodeEkar + unicodeOuKarPart2;
                return match;
            });

            // ধাপ ২: বিজয় লেআউটের জন্য কার-চিহ্ন (ি, ে, ৈ) আগে আনুন
            const precedingVowelRegex = new RegExp(`(${unicodeRefChar})?(${consonantOrConjunct})((?:${unicodeJaPhala}|${unicodeRaPhala})?)(${unicodeIkar}|${unicodeEkar}|${unicodeOikar})`, 'g');
            unicodeInput = unicodeInput.replace(precedingVowelRegex, (match, reph, base, phala, vowel) => {
                return vowel + (reph || '') + base + (phala || '');
            });
            
            // ধাপ ৩: মূল কনভার্সন লুপ
            let bijoyOutput = '';
            let k = 0;
            while (k < unicodeInput.length) {
                let foundMatch = false;

                // রেফ ('র্') এর জন্য বিশেষ হ্যান্ডলিং (যাতে © চিহ্নটি সঠিক জায়গায় বসে)
                if (unicodeInput.substring(k, k + 2) === unicodeRefChar) {
                    let baseCluster = '';
                    let clusterLen = 0;
                    // রেফের পরে দীর্ঘতম যুক্তবর্ণটি খুঁজুন
                    for (const key of sortedUnicodeKeys) {
                        if (key.length > 0 && unicodeInput.substring(k + 2, k + 2 + key.length) === key) {
                            baseCluster = key;
                            clusterLen = key.length;
                            break;
                        }
                    }
                    
                    if (clusterLen > 0) {
                        bijoyOutput += unicodeToBijoyMap[baseCluster] + '©';
                        k += 2 + clusterLen;
                        foundMatch = true;
                    }
                }

                // সাধারণ ম্যাপিং
                if (!foundMatch) {
                    for (const key of sortedUnicodeKeys) {
                        if (key.length > 0 && unicodeInput.substring(k, k + key.length) === key) {
                            bijoyOutput += unicodeToBijoyMap[key];
                            k += key.length;
                            foundMatch = true;
                            break;
                        }
                    }
                }

                // যদি কোনো ম্যাচ না পাওয়া যায়
                if (!foundMatch) {
                    bijoyOutput += unicodeInput[k];
                    k++;
                }
            }

            // ধাপ ৪: ম্যানুয়াল আনসি রিপ্লেসমেন্ট প্রয়োগ
            for (const [wrong, correct] of Object.entries(manualAnsiReplacements)) {
                if (wrong) { // খালি কী এড়িয়ে চলুন
                    const regex = new RegExp(wrong.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                    bijoyOutput = bijoyOutput.replace(regex, correct);
                }
            }

            // ধাপ ৫: ব্যবহারকারীর অনুরোধ অনুযায়ী অতিরিক্ত রিপ্লেসমেন্ট (লাইনের শুরু এবং দাড়ির পর)
            bijoyOutput = bijoyOutput.replace(/^‡/gm, '†'); // লাইনের শুরুতে
            bijoyOutput = bijoyOutput.replace(/\|‡/g, '|†');   // দাড়ির পরে
            bijoyOutput = bijoyOutput.replace(/^‰/gm, 'ˆ'); // লাইনের শুরুতে
            bijoyOutput = bijoyOutput.replace(/\|‰/g, '|ˆ');   // দাড়ির পরে

            if (textAreaRight) {
                textAreaRight.value = bijoyOutput;
                addState('textAreaRight');
            }
            
            // স্বয়ংক্রিয়ভাবে ফিক্স ফাংশন কল করুন
            fixAnsiText(false);
        }

        function convertRightToLeft() {
            const textAreaLeft = document.getElementById('textAreaLeft');
            const textAreaRight = document.getElementById('textAreaRight');
            let bijoyInput = textAreaRight ? textAreaRight.value : '';

            // ধাপ ০: প্রথমে fixAnsiText ফাংশন কল করুন
            // showAlert প্যারামিটার false পাঠানো হয়েছে যাতে কোনো পপ-আপ বার্তা না আসে।
            fixAnsiText(false); 
            bijoyInput = textAreaRight ? textAreaRight.value : ''; // ফিক্সড টেক্সট পুনরায় লোড করুন

            // --- ধাপ ১: বিজয় থেকে ইউনিকোড ম্যাপিং ---
            let unicodeOutput = '';
            let i = 0;
            while (i < bijoyInput.length) {
                let foundMatch = false;
                for (const key of sortedBijoyKeys) {
                    if (bijoyInput.substring(i, i + key.length) === key) {
                        unicodeOutput += bijoyToUnicodeMap[key];
                        i += key.length;
                        foundMatch = true;
                        break;
                    }
                }
                if (!foundMatch) {
                    unicodeOutput += bijoyInput[i];
                    i++;
                }
            }

            // --- ধাপ ২: ইউনিকোড ডোমেইনে পুনঃক্রম এবং সংমিশ্রণ ---

            // ধ্রুবকগুলি সংজ্ঞায়িত করুন
            const unicodeIkar = '\u09BF'; // ি
            const unicodeEkar = '\u09C7'; // ে
            const unicodeOikar = '\u09C8'; // ৈ
            const unicodeConsonants = '\\u0995-\\u09B9\\u09DC-\\u09DF';
            const unicodeHasanta = '\\u09CD';
            const unicodeRef = '\\u09B0' + unicodeHasanta;

            // ধাপ ২.১: রেফ (র্) পুনঃক্রম করুন
            const unicodeVowelSigns = '[\\u09BE-\\u09C4\\u09C7-\\u09C8\\u09CB-\\u09CC\\u09D7]'; // সকল কার-চিহ্ন
            const consonantCluster = `(?:[${unicodeConsonants}](?:${unicodeHasanta}[${unicodeConsonants}])*)`;
            const fullClusterWithVowel = `(${consonantCluster}(?:${unicodeVowelSigns})?)`;
            const robustRephReorder = new RegExp(`${fullClusterWithVowel}(${unicodeRef})`, 'g');
            unicodeOutput = unicodeOutput.replace(robustRephReorder, '$2$1');

            // ধাপ ২.২: প্রি-সিডিং কার-চিহ্ন (ি, ে, ৈ) সঠিক স্থানে আনুন 
            const consonantClusterPattern = `(?:${unicodeRef})?(?:[${unicodeConsonants}](?:${unicodeHasanta}[${unicodeConsonants}])*)`;
            const reorderRegex = new RegExp(`([${unicodeIkar}${unicodeEkar}${unicodeOikar}])(${consonantClusterPattern})`, 'g');
            unicodeOutput = unicodeOutput.replace(reorderRegex, '$2$1');

            // ধাপ ২.৩: ও-কার এবং ঔ-কার গঠন করুন
            const unicodeAkar = '\u09BE'; // া
            const unicodeOkar = '\u09CB'; // ো
            unicodeOutput = unicodeOutput.replace(new RegExp(`(${unicodeEkar})(${unicodeAkar})`, 'g'), unicodeOkar);

            const unicodeOuKarPart2 = '\u09D7'; // ৗ
            const unicodeOukar = '\u09CC'; // ৌ
            unicodeOutput = unicodeOutput.replace(new RegExp(`(${unicodeEkar})(${unicodeOuKarPart2})`, 'g'), unicodeOukar);


            // ধাপ ৩: ম্যানুয়াল ইউনিকোড রিপ্লেসমেন্ট প্রয়োগ (যদি প্রয়োজন হয়)
            for (const [wrong, correct] of Object.entries(manualUnicodeReplacements)) {
                if (wrong) {
                    const regex = new RegExp(wrong.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                    unicodeOutput = unicodeOutput.replace(regex, correct);
                }
            }

            if (textAreaLeft) {
                textAreaLeft.value = unicodeOutput;
                addState('textAreaLeft');
            }
        }
        // ====================================================================
        // END: UPDATED FUNCTION
        // ====================================================================

// ====================================================================
// START: ANSI TEXT FIX FUNCTION (UPDATED FOR WORD LIST & SILENT MODE)
// ====================================================================

        // এই লিস্টে যে শব্দগুলো যোগ করবেন, "ফিক্স করুন" বাটন সেগুলোকে পরিবর্তন করবে না।
        const wordsToIgnore = [
            '—M',
			"”P",
			"”T",
			"¯‘",
			"o–",
			"ÒQÓ",
			"ÒQ",
			"D`&&hv",
            // এখানে কমা দিয়ে আরও শব্দ যোগ করুন, যেমন: 'كلمة', 'word'
        ];

        // *** পরিবর্তিত ফাংশন: showAlert প্যারামিটার যোগ করা হয়েছে ***
        function fixAnsiText(showAlert = true) {
            const textAreaRight = document.getElementById('textAreaRight');
            if (!textAreaRight) return;

            let textToFix = textAreaRight.value;
            const placeholders = {};

            // ধাপ ০: লিস্টে থাকা শব্দগুলোকে সাময়িকভাবে প্লেসহোল্ডার দিয়ে প্রতিস্থাপন করুন
            wordsToIgnore.forEach((word, index) => {
                const placeholder = `___IGNORE_WORD_${index}___`;
                placeholders[placeholder] = word;
                const regex = new RegExp(word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                textToFix = textToFix.replace(regex, placeholder);
            });

            // ধাপ ১: বিজয় টেক্সটবক্সে ভুলবশত থাকা ইউনিকোড অক্ষরগুলিকে তাদের আনসি সমতুল্য দিয়ে প্রতিস্থাপন করুন।
            for (const key of sortedUnicodeKeys) {
                if (key.length > 0 && textToFix.includes(key)) {
                    const regex = new RegExp(key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                    textToFix = textToFix.replace(regex, unicodeToBijoyMap[key]);
                }
            }

            // ধাপ ২: ম্যানুয়াল আনসি রিপ্লেসমেন্ট ম্যাপ প্রয়োগ করুন
            for (const [wrong, correct] of Object.entries(manualAnsiReplacements)) {
                if (wrong) {
                    const regex = new RegExp(wrong.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                    textToFix = textToFix.replace(regex, correct);
                }
            }
            
            // ধাপ ৩: বিশেষ কেস হ্যান্ডলিং
            textToFix = textToFix.replace(/(^|\s|\|)‡/gm, '$1†');
            textToFix = textToFix.replace(/(^|\s|\|)‰/gm, '$1ˆ');

            // ধাপ ৪: প্লেসহোল্ডারগুলোকে আবার আসল শব্দ দিয়ে প্রতিস্থাপন করুন
            for (const placeholder in placeholders) {
                if (Object.hasOwnProperty.call(placeholders, placeholder)) {
                    const originalWord = placeholders[placeholder];
                    const regex = new RegExp(placeholder, 'g');
                    textToFix = textToFix.replace(regex, originalWord);
                }
            }

            textAreaRight.value = textToFix;
            addState('textAreaRight');
            
            // *** নতুন সংযোজন: শর্তসাপেক্ষে বার্তা দেখানো ***
            if (showAlert) {
                showCustomAlert('লেখা ফিক্স করা হয়েছে!');
            }
        }
// ====================================================================
// END: ANSI TEXT FIX FUNCTION
// ====================================================================
		
// ====================================================================
// START: COPY SCRIT FOR FONT CONVERTER
// ====================================================================
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.select();
                element.setSelectionRange(0, 99999); // মোবাইল ডিভাইসের জন্য

                try {
                    document.execCommand('copy');
                    // অ্যালার্টের পরিবর্তে কাস্টম মেসেজ বক্স
                    showCustomAlert('আউটপুট কপি করা হয়েছে!');
                } catch (err) {
                    console.error('কপি করতে ব্যর্থ:', err);
                    showCustomAlert('কপি করতে ব্যর্থ হয়েছে। অনুগ্রহ করে ম্যানুয়ালি কপি করুন।');
                }
            }
        }
// ====================================================================
// END: COPY SCRIT FOR FONT CONVERTER
// ====================================================================

// ====================================================================
// END: FONT CONVERTER SCRIPT
// ====================================================================

// ====================================================================
    // START: NEW FILE UPLOAD SCRIPT FOR TEXT ASSISTANT
    // ====================================================================

        const fileUploadInput = document.getElementById('fileUploadInput');
        const filePreviewContainer = document.getElementById('filePreviewContainer');
        let uploadedFile = null; // আপলোড করা ফাইলের তথ্য সংরক্ষণ করতে

        if (fileUploadInput) {
            fileUploadInput.addEventListener('change', handleFileSelect);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            // ফাইলের ধরন এবং আকার যাচাই করুন
            const allowedTypes = ['image/png', 'image/jpeg', 'image/webp', 'text/plain', 'audio/mpeg', 'audio/wav', 'video/mp4', 'video/webm'];
            if (!allowedTypes.includes(file.type)) {
                showCustomAlert('শুধুমাত্র ছবি, টেক্সট, অডিও, এবং ভিডিও ফাইল আপলোড করা যাবে।');
                fileUploadInput.value = ''; // ইনপুট রিসেট করুন
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedFile = {
                    name: file.name,
                    type: file.type,
                    base64: e.target.result.split(',')[1], // Base64 ডেটা পান
                    dataUrl: e.target.result // প্রিভিউ এর জন্য ডেটা URL
                };
                displayFilePreview();
            };
            reader.onerror = function() {
                showCustomAlert('ফাইলটি পড়তে একটি ত্রুটি হয়েছে।');
                uploadedFile = null;
            };
            reader.readAsDataURL(file);
        }

        function displayFilePreview() {
            if (!uploadedFile || !filePreviewContainer) return;

            filePreviewContainer.innerHTML = ''; // আগের প্রিভিউ পরিষ্কার করুন
            filePreviewContainer.classList.remove('hidden');

            const previewWrapper = document.createElement('div');
            previewWrapper.className = 'relative flex items-center gap-3 p-2';

            let previewElement;
            if (uploadedFile.type.startsWith('image/')) {
                previewElement = document.createElement('img');
                previewElement.src = uploadedFile.dataUrl;
            } else if (uploadedFile.type.startsWith('video/')) {
                previewElement = document.createElement('video');
                previewElement.src = uploadedFile.dataUrl;
                previewElement.controls = false; // কন্ট্রোল দেখাবেন না
            } else if (uploadedFile.type.startsWith('audio/')) {
                previewElement = document.createElement('div');
                previewElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600 dark:text-gray-300"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>`;
            } else { // টেক্সট বা অন্যান্য ফাইলের জন্য
                previewElement = document.createElement('div');
                previewElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600 dark:text-gray-300"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>`;
            }

            if (previewElement.tagName === 'IMG' || previewElement.tagName === 'VIDEO') {
                previewElement.className = 'w-16 h-16 object-cover rounded-lg';
            }


            const fileInfo = document.createElement('div');
            fileInfo.className = 'file-info';
            fileInfo.textContent = uploadedFile.name;

            const removeBtn = document.createElement('button');
            removeBtn.id = 'removeFileBtn';
            removeBtn.innerHTML = '&times;';
            removeBtn.title = 'ফাইল সরান';
            removeBtn.onclick = removeFile;

            previewWrapper.appendChild(removeBtn);
            previewWrapper.appendChild(previewElement);
            previewWrapper.appendChild(fileInfo);
            filePreviewContainer.appendChild(previewWrapper);
        }

        function removeFile() {
            uploadedFile = null;
            fileUploadInput.value = ''; // ফাইল ইনপুট রিসেট করুন
            filePreviewContainer.innerHTML = '';
            filePreviewContainer.classList.add('hidden');
        }

        // চ্যাট উইন্ডোতে ফাইলসহ বার্তা যোগ করার জন্য ফাংশন আপডেট করুন
    function addMessageToChat(text, sender, file = null) {
        const chatWindow = document.getElementById('chatWindow');
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', `${sender}-message`);

        // Text content
        const textElement = document.createElement('p');
        textElement.innerText = text;
        messageElement.appendChild(textElement);

        // Image content (if any)
        if (file && file.type.startsWith('image/')) {
            const imgElement = document.createElement('img');
            imgElement.src = file.dataUrl;
            messageElement.appendChild(imgElement);
        }

        // --- NEW: Copy Button ---
        // Only add copy button if there is text to copy
        if (text && text.trim().length > 0) {
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-message-btn';
            copyBtn.title = 'কপি করুন';
            // SVG icon for copy
            copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z"/></svg>`;
            
            // Set onclick to call the new copy function
            copyBtn.onclick = function() { copyMessageToClipboard(this); };
            
            messageElement.appendChild(copyBtn);
        }
        // --- END: Copy Button ---

        if (chatWindow) {
            chatWindow.appendChild(messageElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
    }
    // ====================================================================
    // START: Copy to Clipboard FUNCTION
    // (Add this near your other helper functions like copyToClipboard)
    // ====================================================================
    function copyMessageToClipboard(buttonElement) {
        const messageElement = buttonElement.closest('.message');
        if (!messageElement) return;

        // Find the <p> tag which contains the text
        const textElement = messageElement.querySelector('p');
        if (!textElement) return;

        const textToCopy = textElement.innerText;

        // Create a temporary textarea to hold the text
        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = textToCopy;
        tempTextArea.style.position = 'absolute';
        tempTextArea.style.left = '-9999px';
        document.body.appendChild(tempTextArea);
        
        tempTextArea.select();
        tempTextArea.setSelectionRange(0, 99999); // For mobile devices

        try {
            // Use execCommand for iframe compatibility
            document.execCommand('copy');
            showCustomAlert('চ্যাটের লেখা কপি করা হয়েছে!');
        } catch (err) {
            console.error('চ্যাট কপি করতে ব্যর্থ:', err);
            showCustomAlert('কপি করতে ব্যর্থ হয়েছে।');
        } finally {
            document.body.removeChild(tempTextArea);
        }
    }
    // ====================================================================
    // END: Copy to Clipboard FUNCTION
    // ====================================================================
	
 // ====================================================================
 // END: NEW FILE UPLOAD SCRIPT FOR TEXT ASSISTANT PART
 // ====================================================================
		
// ====================================================================
// START: GOOGLE MAP SCRIPT
// ====================================================================		
        // --- গুগল ম্যাপ ফিচার ---
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const myLocationBtn = document.getElementById('myLocationBtn');
        const directionsFrom = document.getElementById('directionsFrom');
        const directionsTo = document.getElementById('directionsTo');
        const directionsBtn = document.getElementById('directionsBtn');

        // 1. স্থান খোঁজার জন্য ইভেন্ট লিসেনার
        if (searchBtn) {
            searchBtn.addEventListener('click', () => {
                const query = searchInput.value.trim();
                if (query) {
                    const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
                    window.open(url, '_blank');
                } else {
                    showCustomAlert('অনুগ্রহ করে খোঁজার জন্য একটি স্থানের নাম লিখুন।');
                }
            });
             // Enter চেপে সার্চ করার সুবিধা
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    searchBtn.click();
                }
            });
        }

        // 2. আমার অবস্থানের জন্য ইভেন্ট লিসেনার
        if (myLocationBtn) {
            myLocationBtn.addEventListener('click', () => {
                // এই URLটি গুগল ম্যাপকে ব্যবহারকারীর বর্তমান অবস্থান খুঁজতে বলবে
                const url = 'https://www.google.com/maps/search/My+Location';
                window.open(url, '_blank');
            });
        }

        // 3. দিকনির্দেশনার জন্য ইভেন্ট লিসেনার
        if (directionsBtn) {
            directionsBtn.addEventListener('click', () => {
                const origin = directionsFrom.value.trim();
                const destination = directionsTo.value.trim();
                if (origin && destination) {
                    const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}`;
                    window.open(url, '_blank');
                } else {
                    showCustomAlert('অনুগ্রহ করে শুরু এবং গন্তব্য উভয় স্থান লিখুন।');
                }
            });
            // Enter চেপে দিকনির্দেশনা খোঁজার সুবিধা
            directionsTo.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    directionsBtn.click();
                }
            });
             directionsFrom.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    directionsBtn.click();
                }
            });
        }
    });
// ====================================================================
// END: GOOGLE MAP SCRIPT
// ====================================================================
	
// ====================================================================
// START: নামাজের সময়সূচি
// ====================================================================

// নতুন: নামাজের সময়সূচি ট্যাব এর জন্য ফাংশন (API ইন্টিগ্রেশন এবং লোকাল স্টোরেজ সহ)
function initializePrayerTimeTab() {
    const districtSelect = document.getElementById('district-select');
    const prayerTimeDate = document.getElementById('prayerTimeDate');
    const manualTimeToggle = document.getElementById('manualTimeToggle');
    const manualTimeInputsContainer = document.getElementById('manualTimeInputs');

    // ম্যানুয়াল ইনপুট ক্ষেত্র
    const manualInputs = {
        sehri: document.getElementById('manualSehri'),
        fajr: document.getElementById('manualFajr'),
        dhuhr: document.getElementById('manualDhuhr'),
        asr: document.getElementById('manualAsr'),
        iftar: document.getElementById('manualIftar'),
        isha: document.getElementById('manualIsha')
    };

    if (!districtSelect || !manualTimeToggle || !manualTimeInputsContainer) return;

    // API কলের জন্য বাংলা জেলার নামের সাথে ইংরেজি নামের ম্যাপিং
    const districtMap = {
        "ঢাকা": "Dhaka", "গাইবান্ধা": "Gaibandha", "বরগুনা": "Barguna", "বরিশাল": "Barisal", "ভোলা": "Bhola", "ঝালকাঠি": "Jhalokati", "পটুয়াখালী": "Patuakhali", "পিরোজপুর": "Pirojpur",
        "বান্দরবান": "Bandarban", "ব্রাহ্মণবাড়িয়া": "Brahmanbaria", "চাঁদপুর": "Chandpur", "চট্টগ্রাম": "Chattogram", "কুমিল্লা": "Cumilla", "কক্সবাজার": "Cox's Bazar", "ফেনী": "Feni", "খাগড়াছড়ি": "Khagrachhari", "লক্ষ্মীপুর": "Lakshmipur", "নোয়াখালী": "Noakhali", "রাঙ্গামাটি": "Rangamati",
        "ফরিদপুর": "Faridpur", "গাজীপুর": "Gazipur", "গোপালগঞ্জ": "Gopalganj", "কিশোরগঞ্জ": "Kishoreganj", "মাদারীপুর": "Madaripur", "মানিকগঞ্জ": "Manikganj", "মুন্সিগঞ্জ": "Munshiganj", "নারায়ণগঞ্জ": "Narayanganj", "নরসিংদী": "Narsingdi", "রাজবাড়ী": "Rajbari", "শরীয়তপুর": "Shariatpur", "টাঙ্গাইল": "Tangail",
        "বাগেরহাট": "Bagerhat", "চুয়াডাঙ্গা": "Chuadanga", "যশোর": "Jashore", "ঝিনাইদহ": "Jhenaidah", "খুলনা": "Khulna", "কুষ্টিয়া": "Kushtia", "মাগুরা": "Magura", "মেহেরপুর": "Meherpur", "নড়াইল": "Narail", "সাতক্ষীরা": "Satkhira",
        "জামালপুর": "Jamalpur", "ময়মনসিংহ": "Mymensingh", "নেত্রকোনা": "Netrokona", "শেরপুর": "Sherpur",
        "বগুড়া": "Bogura", "জয়পুরহাট": "Joypurhat", "নওগাঁ": "Naogaon", "নাটোর": "Natore", "চাঁপাইনবাবগঞ্জ": "Chapainawabganj", "পাবনা": "Pabna", "রাজশাহী": "Rajshahi", "সিরাজগঞ্জ": "Sirajganj",
        "দিনাজপুর": "Dinajpur", "কুড়িগ্রাম": "Kurigram", "লালমনিরহাট": "Lalmonirhat", "নীলফামারী": "Nilphamari", "পঞ্চগড়": "Panchagarh", "রংপুর": "Rangpur", "ঠাকুরগাঁও": "Thakurgaon",
        "হবিগঞ্জ": "Habiganj", "মৌলভীবাজার": "Moulvibazar", "সুনামগঞ্জ": "Sunamganj", "সিলেট": "Sylhet"
    };


    // START: সেটিংস সেভ এবং লোড করার ফাংশন


    // সকল সেটিংস লোকাল স্টোরেজে সেভ করার ফাংশন
    const saveSettings = () => {
        const settings = {
            isManual: manualTimeToggle.checked,
            district: districtSelect.value,
            manualTimes: {
                sehri: manualInputs.sehri.value,
                fajr: manualInputs.fajr.value,
                dhuhr: manualInputs.dhuhr.value,
                asr: manualInputs.asr.value,
                iftar: manualInputs.iftar.value,
                isha: manualInputs.isha.value,
            }
        };
        localStorage.setItem('prayerTimeSettings', JSON.stringify(settings));
        console.log('সেটিংস সেভ করা হয়েছে:', settings);
    };

    // লোকাল স্টোরেজ থেকে সেটিংস লোড করার ফাংশন
    const loadSettings = () => {
        const savedSettings = localStorage.getItem('prayerTimeSettings');
        if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            console.log('সেটিংস লোড করা হয়েছে:', settings);

            // টগল অবস্থা পুনরুদ্ধার করুন
            manualTimeToggle.checked = settings.isManual;

            // জেলা নির্বাচন পুনরুদ্ধার করুন
            if (settings.district) {
                // জেলা ড্রপডাউন লোড হওয়ার জন্য একটু অপেক্ষা করুন
                setTimeout(() => {
                    districtSelect.value = settings.district;
                }, 100);
            }

            // ম্যানুয়াল সময় পুনরুদ্ধার করুন
            if (settings.manualTimes) {
                manualInputs.sehri.value = settings.manualTimes.sehri || '04:00';
                manualInputs.fajr.value = settings.manualTimes.fajr || '04:10';
                manualInputs.dhuhr.value = settings.manualTimes.dhuhr || '12:00';
                manualInputs.asr.value = settings.manualTimes.asr || '16:30';
                manualInputs.iftar.value = settings.manualTimes.iftar || '18:45';
                manualInputs.isha.value = settings.manualTimes.isha || '20:00';
            }
        }
    };


    // END: সেটিংস সেভ এবং লোড করার ফাংশন

	
    // 24-ঘণ্টার সময়কে 12-ঘণ্টার ফরম্যাটে রূপান্তর করার ফাংশন
    function formatTo12Hour(time24) {
        if (!time24 || typeof time24 !== 'string') return '--:--';
        const [hour, minute] = time24.split(':').map(Number);
        const period = hour >= 12 ? 'PM' : 'AM';
        const hour12 = hour % 12 || 12;
        return `${hour12.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')} ${period}`;
    }

    // ম্যানুয়াল সময় প্রদর্শন করার ফাংশন
    function displayManualTimes() {
        document.getElementById('sehri-time').textContent = formatTo12Hour(manualInputs.sehri.value);
        document.getElementById('fajr-time').textContent = formatTo12Hour(manualInputs.fajr.value);
        document.getElementById('dhuhr-time').textContent = formatTo12Hour(manualInputs.dhuhr.value);
        document.getElementById('asr-time').textContent = formatTo12Hour(manualInputs.asr.value);
        document.getElementById('iftar-time').textContent = formatTo12Hour(manualInputs.iftar.value);
        document.getElementById('isha-time').textContent = formatTo12Hour(manualInputs.isha.value);
        districtSelect.disabled = true;
    }

    // API থেকে ডেটা নিয়ে আসার এবং প্রদর্শনের ফাংশন
    async function fetchAndDisplayPrayerTimes(district) {
        const prayerTimesP = document.querySelectorAll('.prayer-times-grid p');
        prayerTimesP.forEach(p => p.textContent = 'লোড হচ্ছে...');
        districtSelect.disabled = false;

        const englishDistrict = districtMap[district];
        if (!englishDistrict) {
            prayerTimesP.forEach(p => p.textContent = 'ত্রুটি');
            showCustomAlert('জেলা খুঁজে পাওয়া যায়নি।');
            return;
        }

        const today = new Date();
        const dateString = `${today.getDate()}-${today.getMonth() + 1}-${today.getFullYear()}`;
        const url = `https://api.aladhan.com/v1/timingsByCity/${dateString}?city=${englishDistrict}&country=Bangladesh&method=1`;

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`API থেকে সাড়া পাওয়া যায়নি (স্ট্যাটাস: ${response.status})`);
            const data = await response.json();

            if (data.code === 200) {
                const times = data.data.timings;
                const [fajrHour, fajrMinute] = times.Fajr.split(':').map(Number);
                const fajrDate = new Date();
                fajrDate.setHours(fajrHour, fajrMinute, 0, 0);
                fajrDate.setMinutes(fajrDate.getMinutes() - 10);
                const sehriTime24 = `${fajrDate.getHours().toString().padStart(2, '0')}:${fajrDate.getMinutes().toString().padStart(2, '0')}`;

                document.getElementById('sehri-time').textContent = formatTo12Hour(sehriTime24);
                document.getElementById('fajr-time').textContent = formatTo12Hour(times.Fajr);
                document.getElementById('dhuhr-time').textContent = formatTo12Hour(times.Dhuhr);
                document.getElementById('asr-time').textContent = formatTo12Hour(times.Asr);
                document.getElementById('iftar-time').textContent = formatTo12Hour(times.Maghrib);
                document.getElementById('isha-time').textContent = formatTo12Hour(times.Isha);
            } else {
                throw new Error('API থেকে ডেটা সঠিকভাবে আসেনি।');
            }
        } catch (error) {
            console.error('Prayer Times Error:', error);
            prayerTimesP.forEach(p => p.textContent = 'ব্যর্থ');
            showCustomAlert(`সময় আনতে সমস্যা হয়েছে: ${error.message}`);
        }
    }

    // টগল সুইচের পরিবর্তন হ্যান্ডেল করুন
    manualTimeToggle.addEventListener('change', () => {
        if (manualTimeToggle.checked) {
            manualTimeInputsContainer.classList.remove('hidden');
            displayManualTimes();
        } else {
            manualTimeInputsContainer.classList.add('hidden');
            fetchAndDisplayPrayerTimes(districtSelect.value);
        }
        saveSettings(); // পরিবর্তন সেভ করুন
    });

    // ম্যানুয়াল ইনপুট পরিবর্তন হলে সময় আপডেট এবং সেভ করুন
    Object.values(manualInputs).forEach(input => {
        input.addEventListener('input', () => {
            if (manualTimeToggle.checked) {
                displayManualTimes();
            }
            saveSettings(); // পরিবর্তন সেভ করুন
        });
    });

    // জেলা পরিবর্তন হলে সময় আপডেট এবং সেভ করুন
    districtSelect.addEventListener('change', (e) => {
        if (!manualTimeToggle.checked) {
            fetchAndDisplayPrayerTimes(e.target.value);
        }
        saveSettings(); // পরিবর্তন সেভ করুন
    });

    // ড্রপডাউন এ জেলার নাম যোগ করা
    if (districtSelect.options.length <= 1) {
        Object.keys(districtMap).forEach(district => {
            const option = document.createElement('option');
            option.value = district;
            option.textContent = district;
            districtSelect.appendChild(option);
        });
    }

    // --- মূল التنفيذ লজিক ---
    loadSettings(); // প্রথমে সেভ করা সেটিংস লোড করুন

    // লোড করা সেটিংসের উপর ভিত্তি করে প্রাথমিক অবস্থা নির্ধারণ করুন
    if (manualTimeToggle.checked) {
        manualTimeInputsContainer.classList.remove('hidden');
        displayManualTimes();
    } else {
        manualTimeInputsContainer.classList.add('hidden');
        fetchAndDisplayPrayerTimes(districtSelect.value || "ঢাকা");
    }

    // আজকের তারিখ প্রদর্শন
    const today = new Date();
    prayerTimeDate.textContent = today.toLocaleDateString('bn-BD', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}

    // যখন নামাজের সময়সূচি ট্যাব ক্লিক করা হবে, তখন এই ফাংশনটি চালু হবে
    document.getElementById('prayerTimeTab')?.addEventListener('click', initializePrayerTimeTab);
    
    // 페이지 로드 시 기도 시간 탭이 활성화되어 있으면 초기화
    if (document.getElementById('prayerTimeContent')?.classList.contains('active')) {
        initializePrayerTimeTab();
    }
// ====================================================================
// END: নামাজের সময়সূচি
// ====================================================================

// ====================================================================
// START: NEW FILE UPLOAD SCRIPT FOR TEXT ASSISTANT
// ====================================================================
    // জেমিনিকে জিজ্ঞাসা করার ফাংশন আপডেট করুন
    async function handleAskGemini() {
        const assistantInput = document.getElementById('assistantInput');
        const assistantLoading = document.getElementById('assistantLoading');
        const askGeminiBtn = document.getElementById('askGeminiBtn');
        const chatWindow = document.getElementById('chatWindow');
        const modelSelection = document.getElementById('modelSelection');
        
        let chatHistory = window.chatHistory || [];

        const promptText = assistantInput.value.trim();
        if (!promptText && !uploadedFile) return;

        // ব্যবহারকারীর বার্তা প্রদর্শন করুন
        addMessageToChat(promptText, 'user', uploadedFile);
        assistantInput.value = '';

        let userParts = [];
        if (promptText) {
            userParts.push({
                text: promptText
            });
        }
        if (uploadedFile) {
            userParts.push({
                inlineData: {
                    mimeType: uploadedFile.type,
                    data: uploadedFile.base64
                }
            });
        }

        chatHistory.push({
            role: "user",
            parts: userParts
        });
        window.chatHistory = chatHistory;

        // ফাইল পাঠানোর পর প্রিভিউ সরিয়ে ফেলুন
        removeFile();

        if (assistantLoading) assistantLoading.style.display = 'block';
        if (askGeminiBtn) askGeminiBtn.disabled = true;

        try {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                addMessageToChat('জেমিনি API কী সেট করা হয়নি। অনুগ্রহ করে "API কী সেট করুন" বাটনে ক্লিক করে কী সেট করুন।', 'gemini-error');
                return;
            }

            const payload = {
                contents: chatHistory
            };

            // --- আপডেট: সেটিংস থেকে Google সার্চ স্ট্যাটাস চেক করুন (ডিফল্ট: চালু) ---
            const isGoogleSearchEnabled = localStorage.getItem('googleSearchEnabled') !== 'false';

            // যদি সেটিংস চালু থাকে, তাহলে payload-এ 'tools' যুক্ত করুন
            if (isGoogleSearchEnabled) {
                payload.tools = [{ "google_search": {} }];
            }
            // --- শেষ: আপডেট ---


			// --- সেটিংস থেকে গ্লোবাল মডেল ব্যবহার ---
            const model = localStorage.getItem('geminiModel') || "gemini-flash-latest";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            // --- পরিবর্তন শেষ ---

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload) // পরিবর্তিত payload এখানে ব্যবহৃত হচ্ছে
            });

            const result = await response.json();
            let geminiText;

            if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                geminiText = result.candidates[0].content.parts[0].text;
                chatHistory.push({
                    role: "model",
                    parts: [{
                        text: geminiText
                    }]
                });
                window.chatHistory = chatHistory;
            } else {
                geminiText = 'দুঃখিত, এই মুহূর্তে উত্তর দেওয়া সম্ভব হচ্ছেনা। অনুগ্রহ করে কানেকশন চেক করে আবার চেষ্টা করুন অথবা এপিআইটি বৈধ বা সঠিক নয়, চেক করে দেখুন অথবা সেটিংস থেকে জেমিনি মডেল পরিবর্তন করে আবার চেষ্টা করুন।';
                console.error('API Response Error:', result);
            }
            addMessageToChat(geminiText, 'gemini');

        } catch (error) {
            const errorMessage = 'একটি ত্রুটি ঘটেছে: ' + error.message;
            addMessageToChat(errorMessage, 'gemini-error');
            console.error('API Call Error:', error);
        } finally {
            if (assistantLoading) assistantLoading.style.display = 'none';
            if (askGeminiBtn) askGeminiBtn.disabled = false;
        }
    }
    // ====================================================================
    // END: NEW FILE UPLOAD SCRIPT FOR TEXT ASSISTANT SCRIPT
    // ====================================================================

// ====================================================================
// START: UNIT CONVERTER (MEASUREMENT) SCRIPT (CORRECTED)
// ====================================================================
function initializeUnitConverters() {
    // শুধুমাত্র পরিমাপ সেকশনের ভেতরের ইনপুট ও সিলেক্ট এলিমেন্টগুলোই ধরবে
    const unitInputs = document.querySelectorAll('#measurementContent .unit-input');
    const unitSelects = document.querySelectorAll('#measurementContent .unit-select');

    const factors = {
        length: { // base: meter
            meter: 1,
            kilometer: 1000,
            centimeter: 0.01,
            millimeter: 0.001,
            mile: 1609.34,
            yard: 0.9144,
            foot: 0.3048,
            inch: 0.0254
        },
        weight: { // base: gram
            gram: 1,
            kilogram: 1000,
            milligram: 0.001,
            tonne: 1000000,
            pound: 453.592,
            ounce: 28.3495
        },
        area: { // base: square meter
            sq_meter: 1,
            sq_kilometer: 1000000,
            sq_foot: 0.092903,
            sq_inch: 0.00064516,
            hectare: 10000,
            acre: 4046.86,
            bigha: 1337.8, // Approximate value for Bangladesh
            katha: 66.89, // 1 Bigha = 20 Katha
            shotok: 40.4686 // 1 Acre = 100 Shotok
        }
    };

    function performConversion(sourceElement) {
        if (!sourceElement) return;

        const converterType = sourceElement.dataset.converter.replace('_rev', '');
        const isReverse = sourceElement.dataset.converter.includes('_rev');

        // সোর্স এবং টার্গেট এলিমেন্টগুলো শনাক্ত করুন
        const fromValueEl = document.getElementById(`${converterType}FromValue`);
        const fromUnitEl = document.getElementById(`${converterType}FromUnit`);
        const toValueEl = document.getElementById(`${converterType}ToValue`);
        const toUnitEl = document.getElementById(`${converterType}ToUnit`);

        const sourceValueEl = isReverse ? toValueEl : fromValueEl;
        const sourceUnitEl = isReverse ? toUnitEl : fromUnitEl;
        const targetValueEl = isReverse ? fromValueEl : toValueEl;
        const targetUnitEl = isReverse ? fromUnitEl : toUnitEl;

        const sourceValue = parseFloat(sourceValueEl.value);
        
        if (isNaN(sourceValue)) {
            targetValueEl.value = '';
            return;
        }

        const fromUnit = sourceUnitEl.value;
        const toUnit = targetUnitEl.value;
        let result;

        if (converterType === 'temperature') {
            // তাপমাত্রা রূপান্তরের লজিক
            if (fromUnit === toUnit) {
                result = sourceValue;
            } else if (fromUnit === 'celsius') {
                result = toUnit === 'fahrenheit' ? (sourceValue * 9 / 5) + 32 : sourceValue + 273.15;
            } else if (fromUnit === 'fahrenheit') {
                result = toUnit === 'celsius' ? (sourceValue - 32) * 5 / 9 : ((sourceValue - 32) * 5 / 9) + 273.15;
            } else if (fromUnit === 'kelvin') {
                result = toUnit === 'celsius' ? sourceValue - 273.15 : ((sourceValue - 273.15) * 9 / 5) + 32;
            }
        } else {
            // ফ্যাক্টর-ভিত্তিক রূপান্তরের লজিক
            const conversionFactors = factors[converterType];
            const valueInBaseUnit = sourceValue * conversionFactors[fromUnit];
            result = valueInBaseUnit / conversionFactors[toUnit];
        }

        // একটি নির্দিষ্ট দশমিক স্থান পর্যন্ত ফলাফল প্রদর্শন করুন
        targetValueEl.value = Number(result.toFixed(6));
    }

    unitInputs.forEach(input => {
        input.addEventListener('input', (e) => {
            performConversion(e.target);
        });
    });

    unitSelects.forEach(select => {
        select.addEventListener('change', (e) => {
            // কোন ইনপুটটি সোর্স হিসেবে ব্যবহৃত হবে তা নির্ধারণ করুন
            const converterType = e.target.dataset.converter;
            const fromValueEl = document.getElementById(`${converterType}FromValue`);
            // যখন ইউনিট পরিবর্তন হয়, তখন সবসময় 'From' ফিল্ড থেকে গণনা শুরু করুন
            performConversion(fromValueEl);
        });
    });

    // পেজ লোড হওয়ার সাথে সাথে সকল কনভার্টার চালু করুন
    ['length', 'weight', 'area', 'temperature'].forEach(type => {
        const fromValueEl = document.getElementById(`${type}FromValue`);
        if(fromValueEl) {
             performConversion(fromValueEl);
        }
    });
}
// BMI Calculator Script - শুরু
const weightInput = document.getElementById('bmi-weight');
const heightFeetInput = document.getElementById('bmi-height-feet');
const heightInchesInput = document.getElementById('bmi-height-inches');
const calculateBtn = document.getElementById('bmi-calculate-btn');
const resultDiv = document.getElementById('bmi-result');

if (calculateBtn) {
    calculateBtn.addEventListener('click', () => {
        const weight = parseFloat(weightInput.value);
        const feet = parseFloat(heightFeetInput.value) || 0;
        const inches = parseFloat(heightInchesInput.value) || 0;

        if (isNaN(weight) || weight <= 0) {
            showResult('অনুগ্রহ করে সঠিক ওজন লিখুন।', 'bmi-obese');
            return;
        }

        if ((isNaN(feet) && isNaN(inches)) || (feet <= 0 && inches <= 0)) {
            showResult('অনুগ্রহ করে সঠিক উচ্চতা লিখুন।', 'bmi-obese');
            return;
        }

        // Convert height to meters
        const totalInches = (feet * 12) + inches;
        const heightInMeters = totalInches * 0.0254;

        if (heightInMeters <= 0) {
            showResult('অনুগ্রহ করে সঠিক উচ্চতা লিখুন।', 'bmi-obese');
            return;
        }

        // Calculate BMI
        const bmi = weight / (heightInMeters * heightInMeters);
        const bmiFormatted = bmi.toFixed(2);

        // Determine BMI category
        let category = '';
        let categoryClass = '';
        if (bmi < 18.5) {
            category = 'কম ওজন (Underweight)';
            categoryClass = 'bmi-underweight';
        } else if (bmi >= 18.5 && bmi <= 24.9) {
            category = 'স্বাভাবিক ওজন (Normal)';
            categoryClass = 'bmi-normal';
        } else if (bmi >= 25 && bmi <= 29.9) {
            category = 'অতিরিক্ত ওজন (Overweight)';
            categoryClass = 'bmi-overweight';
        } else {
            category = 'স্থূলতা (Obese)';
            categoryClass = 'bmi-obese';
        }

        const resultText = `আপনার BMI: <strong>${bmiFormatted}</strong><br>আপনি '${category}' শ্রেণীতে আছেন।`;
        showResult(resultText, categoryClass);
    });
}


function showResult(message, className) {
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = message;
    // Reset classes
    resultDiv.className = 'bmi-result-section';
    // Add new class
    if(className) {
        resultDiv.classList.add(className);
    }
}
// BMI Calculator Script - শেষ


// START: Time Converter (24-hour to 12-hour) Script

function initializeTimeConverter() {
const time24HourInput = document.getElementById('time24Hour');
const time12HourInput = document.getElementById('time12Hour');
const timeAmPmSelect = document.getElementById('timeAmPm');

// নিশ্চিত করুন যে উপাদানগুলি বিদ্যমান আছে
if (!time24HourInput || !time12HourInput || !timeAmPmSelect) {
    console.error("Time converter elements not found!");
    return;
}

// ফাংশন: ২৪-ঘণ্টা থেকে ১২-ঘণ্টা ফরম্যাটে রূপান্তর
const convertTo12Hour = () => {
    const hour24 = parseInt(time24HourInput.value, 10);

    if (isNaN(hour24) || hour24 < 0 || hour24 > 23) {
        time12HourInput.value = '';
        return;
    }

    const period = hour24 >= 12 ? 'PM' : 'AM';
    let hour12 = hour24 % 12;

    if (hour12 === 0) { // মধ্যরাত (00:xx) এবং দুপুর (12:xx) এর জন্য
        hour12 = 12;
    }

    time12HourInput.value = hour12;
    timeAmPmSelect.value = period;
};

// ফাংশন: ১২-ঘণ্টা থেকে ২৪-ঘণ্টা ফরম্যাটে রূপান্তর
const convertTo24Hour = () => {
    let hour12 = parseInt(time12HourInput.value, 10);
    const period = timeAmPmSelect.value;

    if (isNaN(hour12) || hour12 < 1 || hour12 > 12) {
        time24HourInput.value = '';
        return;
    }

    let hour24 = 0;
    if (period === 'PM' && hour12 < 12) {
        hour24 = hour12 + 12;
    } else if (period === 'AM' && hour12 === 12) { // মধ্যরাতের জন্য বিশেষ নিয়ম
        hour24 = 0;
    } else {
        hour24 = hour12;
    }

    time24HourInput.value = hour24;
};

// ইনপুট এবং পরিবর্তনের জন্য ইভেন্ট লিসেনার যুক্ত করুন
time24HourInput.addEventListener('input', convertTo12Hour);
time12HourInput.addEventListener('input', convertTo24Hour);
timeAmPmSelect.addEventListener('change', convertTo24Hour);

}

// DOMContentLoaded ইভেন্টের মধ্যে এই ফাংশনটি কল করুন
document.addEventListener('DOMContentLoaded', () => {
initializeTimeConverter();
});

// END: Time Converter Script


// ====================================================================
// END: UNIT CONVERTER (MEASUREMENT) SCRIPT (CORRECTED)
// ====================================================================

// ====================================================================
// START: CUSTOM POPUP MESSAGE বার্তা দেখানোর স্ক্রিপ্ট (আপডেটেড: টোস্ট স্টাইল)
// ====================================================================
	// কাস্টম অ্যালার্ট বক্স বাস্তবায়ন New
    // কাস্টম টোস্ট অ্যালার্ট (উপরে ব্যানারের ওপর দেখাবে)
function showCustomAlert(message) {
        // আগের কোনো অ্যালার্ট থাকলে সরিয়ে ফেলুন
        const existingAlert = document.querySelector('.custom-toast-alert');
        if (existingAlert) existingAlert.remove();

        const alertBox = document.createElement('div');
        const banner = document.getElementById('currentDateTimeBanner');
        
        let topPosition = '20px'; // ডিফল্ট পজিশন
        let minHeight = '50px';   // ডিফল্ট মিনিমাম হাইট
        let maxWidth = '90%';     // ডিফল্ট সর্বোচ্চ প্রস্থ (মোবাইলের জন্য)

        // ব্যানারের পজিশন এবং হাইট ডায়নামিকালি ক্যালকুলেট করা
        if (banner && banner.offsetParent !== null) { 
            const rect = banner.getBoundingClientRect();
            
            // যদি ব্যানারটি স্ক্রিনের টপে দৃশ্যমান থাকে (নেগেটিভ টপ না হয়)
            if (rect.top >= 0) {
                topPosition = `${rect.top}px`;
                minHeight = `${rect.height}px`; // ব্যানারের হাইটকে মিনিমাম হাইট হিসেবে সেট করা হলো
                maxWidth = `${rect.width}px`;   // সর্বোচ্চ প্রস্থ ব্যানারের প্রস্থের সমান হবে
            } else {
                // ব্যানার স্ক্রল করে উপরে চলে গেলে টোস্টটি স্ট্যান্ডার্ড পজিশনে দেখাবে
                topPosition = '20px';
                minHeight = '50px'; 
                maxWidth = '90%';
            }
        }

        // টোস্ট স্টাইলিং
        alertBox.classList.add(
            'custom-toast-alert',
            'fixed', 'left-1/2', 'transform', '-translate-x-1/2', // পজিশন
            'bg-gray-900', 'dark:bg-gray-100', // ব্যাকগ্রাউন্ড
            'text-white', 'dark:text-gray-900', // টেক্সট
            'px-6', 'py-1', // ডানে-বামে প্যাডিং এবং উপরে-নিচে সামান্য প্যাডিং (পরিবর্তিত: py-2 থেকে py-1 করা হয়েছে যাতে ছোট ব্যানারে হাইট ঠিক থাকে)
            'rounded-full', // সম্পূর্ণ রাউন্ডেড
            'shadow-2xl', 'border', 'border-gray-700', 'dark:border-gray-300',
            'z-[100]',
            'text-sm', 'font-semibold', 'tracking-wide',
            'flex', 'items-center', 'justify-center', 'gap-3', // ফ্লেক্সবক্স দিয়ে ভার্টিক্যাল সেন্টার
            'transition-all', 'duration-300', 'ease-out',
            'opacity-0', '-translate-y-4' // অ্যানিমেশনের শুরুর অবস্থা
        );

        // ডায়নামিক স্টাইল অ্যাপ্লাই
        alertBox.style.top = topPosition;
        alertBox.style.minHeight = minHeight; // হাইট ফিক্সড না রেখে মিনিমাম রাখা হলো যাতে বড় টেক্সটে হাইট বাড়তে পারে
        alertBox.style.maxWidth = maxWidth;   // সর্বোচ্চ প্রস্থ সেট করা হলো
        // ফিক্স: fit-content এর পরিবর্তে max-content ব্যবহার করা হয়েছে যাতে টেক্সট পুরো জায়গা না নেওয়া পর্যন্ত লাইন ব্রেক না করে
        alertBox.style.width = 'max-content'; 

        // আইকন এবং মেসেজ সেট করা
        // টেক্সট র‍্যাপ করার জন্য 'white-space: nowrap' সরিয়ে 'word-break' এবং 'text-align' যোগ করা হয়েছে
        alertBox.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-green-400 dark:text-green-600 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
            </svg>
            <span style="word-break: break-word; text-align: center; line-height: 1.4;">${message}</span>
        `;

        document.body.appendChild(alertBox);

        // স্লাইড ডাউন অ্যানিমেশন
        requestAnimationFrame(() => {
            alertBox.classList.remove('opacity-0', '-translate-y-4');
            alertBox.classList.add('opacity-100', 'translate-y-0');
        });

        // ৩ সেকেন্ড পর অটোমেটিক রিমুভ
        setTimeout(() => {
            alertBox.classList.remove('opacity-100', 'translate-y-0');
            alertBox.classList.add('opacity-0', '-translate-y-4');
            
            setTimeout(() => {
                if (alertBox.parentNode) alertBox.parentNode.removeChild(alertBox);
            }, 300);
        }, 3000);
    }

// ====================================================================
// END: CUSTOM POPUP MESSAGE বার্তা দেখানোর স্ক্রিপ্ট
// ====================================================================

// ====================================================================
// START: UNDO REDO FOR FONT CONVERTER (History Limit Added)
// ====================================================================
        // টেক্সটএরিয়াগুলির জন্য আনডু/রিডু ইতিহাস
        const MAX_HISTORY_SIZE = 300; // সর্বোচ্চ ৩০০টি ধাপ মনে রাখবে (মেমোরি বাঁচাতে)
        let historyLeft = [];
        let historyIndexLeft = -1;
        let historyRight = [];
        let historyIndexRight = -1;

        async function addState(textareaId) {
            const textarea = document.getElementById(textareaId);
            let history, historyIndex;

            if (textareaId === 'textAreaLeft') {
                history = historyLeft;
                historyIndex = historyIndexLeft;
            } else {
                history = historyRight;
                historyIndex = historyIndexRight;
            }

            // যদি আমরা ইতিহাসের শেষে না থাকি, তবে পরবর্তী ধাপগুলো মুছে ফেলুন (নতুন ব্রাঞ্চ তৈরি করতে)
            if (historyIndex < history.length - 1) {
                history.splice(historyIndex + 1);
            }

            history.push(textarea.value);

            // --- নতুন: হিস্টোরি লিমিট চেক ---
            // যদি ইতিহাসের আকার সীমার বেশি হয়, তবে সবচেয়ে পুরনো এন্ট্রিটি সরিয়ে ফেলুন
            if (history.length > MAX_HISTORY_SIZE) {
                history.shift(); 
            }
            
            historyIndex = history.length - 1;

            if (textareaId === 'textAreaLeft') {
                historyLeft = history;
                historyIndexLeft = historyIndex;
                // Save state to IndexedDB
                await idbSet('converterTextLeft', textarea.value);
                await idbSet('converterHistoryLeft', { history: historyLeft, index: historyIndexLeft });
            } else {
                historyRight = history;
                historyIndexRight = historyIndex;
                // Save state to IndexedDB
                await idbSet('converterTextRight', textarea.value);
                await idbSet('converterHistoryRight', { history: historyRight, index: historyIndexRight });
            }
            updateButtonStates(textareaId);
        }

        function undoText(textareaId) {
            const textarea = document.getElementById(textareaId);
            const liveConvertToggle = document.getElementById('live-convert-toggle');
            
            // মূল আনডু লজিক, যা পুনরায় ব্যবহার করা যাবে
            const performUndo = () => {
                let history = textareaId === 'textAreaLeft' ? historyLeft : historyRight;
                let historyIndex = textareaId === 'textAreaLeft' ? historyIndexLeft : historyIndexRight;

                if (historyIndex > 0) {
                    historyIndex--;
                    textarea.value = history[historyIndex];
                }

                if (textareaId === 'textAreaLeft') {
                    historyIndexLeft = historyIndex;
                } else {
                    historyIndexRight = historyIndex;
                }
                updateButtonStates(textareaId);
            };

            // একবার আনডু করুন
            performUndo();

            // যদি লাইভ মোড চালু থাকে এবং এটি ডানদিকের টেক্সটবক্স হয়, তবে আবার আনডু করুন
            if (liveConvertToggle && liveConvertToggle.checked && textareaId === 'textAreaRight') {
                performUndo();
            }

            // লাইভ কনভার্ট টগল চালু থাকলে কনভার্সন ট্রিগার করুন
            if (liveConvertToggle && liveConvertToggle.checked) {
                if (textareaId === 'textAreaLeft') {
                    setTimeout(convertLeftToRight, 0);
                } else if (textareaId === 'textAreaRight') {
                    const originalFixAnsiText = window.fixAnsiText;
                    window.fixAnsiText = () => {}; // সাময়িকভাবে নিষ্ক্রিয় করুন
                    setTimeout(() => {
                        convertRightToLeft();
                        window.fixAnsiText = originalFixAnsiText; // আবার সক্রিয় করুন
                    }, 0);
                }
            }
        }

        function redoText(textareaId) {
            const textarea = document.getElementById(textareaId);
            const liveConvertToggle = document.getElementById('live-convert-toggle');

            // মূল রিডু লজিক, যা পুনরায় ব্যবহার করা যাবে
            const performRedo = () => {
                 let history = textareaId === 'textAreaLeft' ? historyLeft : historyRight;
                 let historyIndex = textareaId === 'textAreaLeft' ? historyIndexLeft : historyIndexRight;

                if (historyIndex < history.length - 1) {
                    historyIndex++;
                    textarea.value = history[historyIndex];
                }

                if (textareaId === 'textAreaLeft') {
                    historyIndexLeft = historyIndex;
                } else {
                    historyIndexRight = historyIndex;
                }
                updateButtonStates(textareaId);
            };

            // একবার রিডু করুন
            performRedo();

            // যদি লাইভ মোড চালু থাকে এবং এটি ডানদিকের টেক্সটবক্স হয়, তবে আবার রিডু করুন
            if (liveConvertToggle && liveConvertToggle.checked && textareaId === 'textAreaRight') {
                performRedo();
            }

            // লাইভ কনভার্ট টগল চালু থাকলে কনভার্সন ট্রিগার করুন
            if (liveConvertToggle && liveConvertToggle.checked) {
                if (textareaId === 'textAreaLeft') {
                    setTimeout(convertLeftToRight, 0);
                } else if (textareaId === 'textAreaRight') {
                     const originalFixAnsiText = window.fixAnsiText;
                    window.fixAnsiText = () => {}; // সাময়িকভাবে নিষ্ক্রিয় করুন
                    setTimeout(() => {
                        convertRightToLeft();
                        window.fixAnsiText = originalFixAnsiText; // আবার সক্রিয় করুন
                    }, 0);
                }
            }
        }

        function clearTextarea(textareaId) {
            const textarea = document.getElementById(textareaId);
            if (textarea) {
                textarea.value = '';
                addState(textareaId); // এই ক্লিয়ার অ্যাকশনটি ইতিহাসে যোগ করুন
            }
        }

        function clearAllTextareas() {
            clearTextarea('textAreaLeft');
            clearTextarea('textAreaRight');
        }

        function updateButtonStates(textareaId) {
            let undoBtn = document.getElementById(textareaId === 'textAreaLeft' ? 'undoButtonLeft' : 'undoButtonRight');
            let redoBtn = document.getElementById(textareaId === 'textAreaLeft' ? 'redoButtonLeft' : 'redoButtonRight');
            let history = textareaId === 'textAreaLeft' ? historyLeft : historyRight;
            let historyIndex = textareaId === 'textAreaLeft' ? historyIndexLeft : historyIndexRight;

            if (undoBtn) undoBtn.disabled = historyIndex <= 0;
            if (redoBtn) redoBtn.disabled = historyIndex >= history.length - 1;
        }

// ====================================================================
// END: UNDO REDO FOR FONT CONVERTER
// ====================================================================

// ====================================================================
// START: Load Converter Data from IndexedDB on page load
// ====================================================================
document.addEventListener('DOMContentLoaded', async () => {
		
try {
    // Clear expired items on startup
    await clearExpiredItems();

    const textAreaLeft = document.getElementById('textAreaLeft');
    const textAreaRight = document.getElementById('textAreaRight');

    // Load text for Left Textarea
    const savedTextLeft = await idbGet('converterTextLeft');
    if (savedTextLeft && textAreaLeft) {
        textAreaLeft.value = savedTextLeft;
    }

    // Load text for Right Textarea
    const savedTextRight = await idbGet('converterTextRight');
    if (savedTextRight && textAreaRight) {
        textAreaRight.value = savedTextRight;
    }

    // Load history for Left Textarea
    const savedHistoryLeft = await idbGet('converterHistoryLeft');
    if (savedHistoryLeft) {
        historyLeft = savedHistoryLeft.history || [textAreaLeft.value];
        historyIndexLeft = savedHistoryLeft.index !== undefined ? savedHistoryLeft.index : historyLeft.length - 1;
    } else {
        // Initialize if no history found
        historyLeft = [textAreaLeft ? textAreaLeft.value : ''];
        historyIndexLeft = 0;
    }

    // Load history for Right Textarea
    const savedHistoryRight = await idbGet('converterHistoryRight');
    if (savedHistoryRight) {
        historyRight = savedHistoryRight.history || [textAreaRight.value];
        historyIndexRight = savedHistoryRight.index !== undefined ? savedHistoryRight.index : historyRight.length - 1;
    } else {
        // Initialize if no history found
        historyRight = [textAreaRight ? textAreaRight.value : ''];
        historyIndexRight = 0;
    }

    // Update button states after loading history
    updateButtonStates('textAreaLeft');
    updateButtonStates('textAreaRight');
} catch (e) {
    console.error("Error loading converter data from IndexedDB:", e);
    // In case of error, you might want to clear the store, but for now, just log it.
}
// ====================================================================
// END: Load Converter Data from IndexedDB
// ====================================================================

// ====================================================================
// START: CONST SECTION FOR TAB
// ====================================================================	
// --- ট্যাব পরিবর্তন লজিক ---
//এখানে নতুন ট্যাবের const দুটি যুক্ত করতে হয় বা বসাতে হয় ।

            console.log('DOMContentLoaded ইভেন্ট চালু হয়েছে। স্ক্রিপ্ট চলছে।');
            try {
                const basicCalcTab = document.getElementById('basicCalcTab');
                const ageCalcTab = document.getElementById('ageCalcTab');
                const dateCalcTab = document.getElementById('dateCalcTab');
                const scientificCalcTab = document.getElementById('scientificCalcTab');
                const imageResizerTab = document.getElementById('imageResizerTab');
				const imageResizerContent = document.getElementById('imageResizerContent');
                const converterTab = document.getElementById('converterTab');
                const measurementTab = document.getElementById('measurementTab'); // Add this line
                const textAssistantTab = document.getElementById('textAssistantTab');
                const allFeaturesTab = document.getElementById('allFeaturesTab');
                const setApiKeyBtn = document.getElementById('setApiKeyBtn');
                const spellCheckTab = document.getElementById('spellCheckTab');
                const textBeautifierTab = document.getElementById('textBeautifierTab');
                const wordMeaningTab = document.getElementById('wordMeaningTab');
                const ttsTab = document.getElementById('ttsTab'); // TTS ট্যাব
                const sttTab = document.getElementById('sttTab'); // STT ট্যাব
				const typingTestTab = document.getElementById('typingTestTab'); // এই লাইনটি যোগ করুন
                const basicCalculatorContent = document.getElementById('basicCalculatorContent');
                const ageCalculatorContent = document.getElementById('ageCalculatorContent');
                const dateCalculatorContent = document.getElementById('dateCalculatorContent');
                const scientificCalculatorContent = document.getElementById('scientificCalculatorContent');
                const newsContent = document.getElementById('newsContent');
                const converterContent = document.getElementById('converterContent');
                const measurementContent = document.getElementById('measurementContent'); // Add this line
                const textAssistantContent = document.getElementById('textAssistantContent');
                const allFeaturesContent = document.getElementById('allFeaturesContent');
                const spellCheckerContent = document.getElementById('spellCheckerContent');
                const textBeautifierContent = document.getElementById('textBeautifierContent');
                const wordMeaningContent = document.getElementById('wordMeaningContent');
                const textToSpeechContent = document.getElementById('textToSpeechContent'); // TTS কন্টেন্ট
                const speechToTextContent = document.getElementById('speechToTextContent'); // STT কন্টেন্ট
				const mapTab = document.getElementById('mapTab');
				const mapContent = document.getElementById('mapContent');
				const prayerTimeTab = document.getElementById('prayerTimeTab'); // এই লাইনটি যুক্ত করুন
				const prayerTimeContent = document.getElementById('prayerTimeContent'); // এই লাইনটি যুক্ত করুন
				const playerTab = document.getElementById('playerTab');
				const playerContent = document.getElementById('playerContent');
				const zakatCalcTab = document.getElementById('zakatCalcTab');
				const zakatCalculatorContent = document.getElementById('zakatCalculatorContent');
				const qrCodeTab = document.getElementById('qrCodeTab');
				const qrCodeContent = document.getElementById('qrCodeContent');
				const emergencyNumbersTab = document.getElementById('emergencyNumbersTab');
				const importantLinksTab = document.getElementById('importantLinksTab');
				const importantLinksContent = document.getElementById('importantLinksContent');
				const emergencyNumbersContent = document.getElementById('emergencyNumbersContent');
				const healthLifestyleTab = document.getElementById('healthLifestyleTab');
				const healthLifestyleContent = document.getElementById('healthLifestyleContent');
				const daysObservancesTab = document.getElementById('daysObservancesTab');
				const daysObservancesContent = document.getElementById('daysObservancesContent');
				const holidayListTab = document.getElementById('holidayListTab');
				const holidayListContent = document.getElementById('holidayListContent');
				const quizTab = document.getElementById('quizTab');
				const quizContent = document.getElementById('quizContent');
				const donateTab = document.getElementById('donateTab');
				const donateContent = document.getElementById('donateContent');
				const invoiceTab = document.getElementById('invoiceTab');
				const invoiceContent = document.getElementById('invoiceContent');
				const colorPickerTab = document.getElementById('colorPickerTab');
				const colorPickerContent = document.getElementById('colorPickerContent');
				const historyTab = document.getElementById('historyTab');
				const barcodeGenTab = document.getElementById('barcodeGenTab');
				const barcodeGenContent = document.getElementById('barcodeGenContent');
				const randomPickerTab = document.getElementById('randomPickerTab');
				const randomPickerContent = document.getElementById('randomPickerContent');
				const unitPriceTab = document.getElementById('unitPriceTab');
				const unitPriceContent = document.getElementById('unitPriceContent');
				const tasbeehTab = document.getElementById('tasbeehTab');
				const tasbeehContent = document.getElementById('tasbeehContent');

const webSearchTab = document.getElementById('webSearchTab');
const webSearchContent = document.getElementById('webSearchContent');
// নতুন ফিচার ট্যাব ও কন্টেন্ট ভেরিয়েবল
const screenRecorderTab = document.getElementById('screenRecorderTab');
const screenRecorderContent = document.getElementById('screenRecorderContent');
const jsonFormatterTab = document.getElementById('jsonFormatterTab');
const jsonFormatterContent = document.getElementById('jsonFormatterContent');
const memeGenTab = document.getElementById('memeGenTab');
const memeGenContent = document.getElementById('memeGenContent');
const speedTestTab = document.getElementById('speedTestTab');
const speedTestContent = document.getElementById('speedTestContent');
const diffCheckerTab = document.getElementById('diffCheckerTab');
const diffCheckerContent = document.getElementById('diffCheckerContent');
const expenseTrackerTab = document.getElementById('expenseTrackerTab');
const expenseTrackerContent = document.getElementById('expenseTrackerContent');
const textEncryptionTab = document.getElementById('textEncryptionTab');
const textEncryptionContent = document.getElementById('textEncryptionContent');

// ====================================================================
// END: CONST SECTION FOR TAB
// ====================================================================

// ====================================================================
// START: PASTE PRESET BUTTON SCRIPT PART
// ====================================================================

//pest button code start
// প্রিসেট ড্রপডাউন এবং মোডাল এর উপাদানগুলো সিলেক্ট করুন
const presetButtonLeft = document.getElementById('presetButtonLeft');
const dropdownMenuLeft = document.getElementById('dropdownMenuLeft');
const presetButtonRight = document.getElementById('presetButtonRight');
const dropdownMenuRight = document.getElementById('dropdownMenuRight');
loadSavedPresets();
const customPresetModal = document.getElementById('customPresetModal');
const customModalTitle = document.getElementById('customModalTitle');
const customModalDesc = document.getElementById('customModalDesc');
const customPresetInput = document.getElementById('customPresetInput');
const saveCustomPresetBtn = document.getElementById('saveCustomPresetBtn');
const cancelCustomPresetBtn = document.getElementById('cancelCustomPresetBtn');

// ড্রপডাউন খোলা এবং বন্ধ করার জন্য ফাংশন
const toggleDropdown = (button, menu) => {
    menu.classList.toggle('hidden');
    button.classList.toggle('open');
};

if (presetButtonLeft) {
    presetButtonLeft.addEventListener('click', (e) => {
        e.stopPropagation(); // পেজ-জুড়ে ক্লিক ইভেন্ট প্রতিরোধ করতে
        toggleDropdown(presetButtonLeft, dropdownMenuLeft);
        dropdownMenuRight.classList.add('hidden'); // অন্য ড্রপডাউন বন্ধ করুন
        presetButtonRight.classList.remove('open');
    });
}

if (presetButtonRight) {
    presetButtonRight.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleDropdown(presetButtonRight, dropdownMenuRight);
        dropdownMenuLeft.classList.add('hidden'); // অন্য ড্রপডাউন বন্ধ করুন
        presetButtonLeft.classList.remove('open');
    });
}



// সমস্ত ড্রপডাউন আইটেমের জন্য ইভেন্ট লিসেনার যুক্ত করুন
document.querySelectorAll('#dropdownMenuLeft a').forEach(item => {
    item.addEventListener('click', (e) => handlePresetSelection(e, 'left'));
});
document.querySelectorAll('#dropdownMenuRight a').forEach(item => {
    item.addEventListener('click', (e) => handlePresetSelection(e, 'right'));
});

// নতুন ফাংশন: পেজ লোড হওয়ার সময় localStorage থেকে সেভ করা প্রিসেট লোড করার জন্য।
function loadSavedPresets() {
    const presetButtonLeft = document.getElementById('presetButtonLeft');
    const presetButtonRight = document.getElementById('presetButtonRight');

    // বাম দিকের প্রিসেট লোড করুন
    const savedPresetLeftValue = localStorage.getItem('presetLeftValue');
    const savedPresetLeftText = localStorage.getItem('presetLeftText');
    if (savedPresetLeftValue && savedPresetLeftText && presetButtonLeft) {
        pastePresetLeft = savedPresetLeftValue;
        presetButtonLeft.childNodes[0].nodeValue = `${savedPresetLeftText} `;
        if (savedPresetLeftValue === 'custom' || savedPresetLeftValue === 'custom-serial') {
            customPasteValueLeft = localStorage.getItem('customPasteValueLeft') || '';
        }
    }

    // ডান দিকের প্রিসেট লোড করুন
    const savedPresetRightValue = localStorage.getItem('presetRightValue');
    const savedPresetRightText = localStorage.getItem('presetRightText');
    if (savedPresetRightValue && savedPresetRightText && presetButtonRight) {
        pastePresetRight = savedPresetRightValue;
        presetButtonRight.childNodes[0].nodeValue = `${savedPresetRightText} `;
        if (savedPresetRightValue === 'custom' || savedPresetRightValue === 'custom-serial') {
            customPasteValueRight = localStorage.getItem('customPasteValueRight') || '';
        }
    }
}

// এই ফাংশনটি আপনার পুরনো handlePresetSelection ফাংশনের পরিবর্তে ব্যবহার করুন।
// এখানে প্রিসেট সিলেক্ট করার সাথে সাথে localStorage-এ সেভ করার কোড যোগ করা হয়েছে।
const handlePresetSelection = (event, side) => {
    event.preventDefault();
    const presetValue = event.target.dataset.preset;
    const presetText = event.target.textContent.trim();
    const presetButtonLeft = document.getElementById('presetButtonLeft');
    const presetButtonRight = document.getElementById('presetButtonRight');

    if (presetValue === 'custom' || presetValue === 'custom-serial') {
        currentModalSide = side;
        currentModalPreset = presetValue;
        
        customModalTitle.textContent = presetValue === 'custom' ? 'কাস্টম প্রিসেট' : 'সিরিয়ালসহ কাস্টম প্রিসেট';
        customModalDesc.textContent = presetValue === 'custom' 
            ? 'প্রতিবার পেস্ট করার আগে যে টেক্সট যুক্ত করতে চান তা লিখুন।'
            : 'এখানে আপনার টেক্সট লিখুন। সিরিয়াল নম্বরের জন্য {serial} ব্যবহার করুন (যেমন: Step {serial}:)।';
        
        const currentCustomValue = (side === 'left') ? customPasteValueLeft : customPasteValueRight;
        customPresetInput.value = currentCustomValue;
        
        customPresetModal.classList.remove('hidden');
    } else {
        if (side === 'left') {
            pastePresetLeft = presetValue;
            presetButtonLeft.childNodes[0].nodeValue = `${presetText} `;
            // localStorage-এ সেভ করুন
            localStorage.setItem('presetLeftValue', presetValue);
            localStorage.setItem('presetLeftText', presetText);
        } else {
            pastePresetRight = presetValue;
            presetButtonRight.childNodes[0].nodeValue = `${presetText} `;
            // localStorage-এ সেভ করুন
            localStorage.setItem('presetRightValue', presetValue);
            localStorage.setItem('presetRightText', presetText);
        }
    }
    
    const dropdown = (side === 'left') ? document.getElementById('dropdownMenuLeft') : document.getElementById('dropdownMenuRight');
    const button = (side === 'left') ? presetButtonLeft : presetButtonRight;
    dropdown.classList.add('hidden');
    button.classList.remove('open');
};

// আপনার পুরনো saveCustomPresetBtn এর click event listener-এর পরিবর্তে এটি ব্যবহার করুন।
// এখানে কাস্টম প্রিসেট সেভ করার সাথে সাথে localStorage-এ সেভ করার কোড যোগ করা হয়েছে।
if (saveCustomPresetBtn) {
    saveCustomPresetBtn.addEventListener('click', () => {
        const customValue = customPresetInput.value;
        const presetText = currentModalPreset === 'custom-serial' ? 'সিরিয়ালসহ কাস্টম' : 'কাস্টম প্রিসেট';
        const presetButtonLeft = document.getElementById('presetButtonLeft');
        const presetButtonRight = document.getElementById('presetButtonRight');

        if (currentModalSide === 'left') {
            pastePresetLeft = currentModalPreset;
            customPasteValueLeft = customValue;
            presetButtonLeft.childNodes[0].nodeValue = `${presetText} `;

            // localStorage-এ সেভ করুন
            localStorage.setItem('presetLeftValue', currentModalPreset);
            localStorage.setItem('presetLeftText', presetText);
            localStorage.setItem('customPasteValueLeft', customValue);

        } else {
            pastePresetRight = currentModalPreset;
            customPasteValueRight = customValue;
            presetButtonRight.childNodes[0].nodeValue = `${presetText} `;
            
            // localStorage-এ সেভ করুন
            localStorage.setItem('presetRightValue', currentModalPreset);
            localStorage.setItem('presetRightText', presetText);
            localStorage.setItem('customPasteValueRight', customValue);
        }
        customPresetModal.classList.add('hidden');
    });
}

if (cancelCustomPresetBtn) {
    cancelCustomPresetBtn.addEventListener('click', () => {
        customPresetModal.classList.add('hidden');
    });
}

// বাইরে ক্লিক করলে ড্রপডাউন বন্ধ করার জন্য
window.addEventListener('click', () => {
    if (!dropdownMenuLeft.classList.contains('hidden')) {
        dropdownMenuLeft.classList.add('hidden');
        presetButtonLeft.classList.remove('open');
    }
    if (!dropdownMenuRight.classList.contains('hidden')) {
        dropdownMenuRight.classList.add('hidden');
        presetButtonRight.classList.remove('open');
    }
});

//paste button code end
// ====================================================================
// END: PASTE PRESET BUTTON SCRIPT PART
// ====================================================================

// ====================================================================
// START: API KEY SCRIPT PART
// ====================================================================
                // API কী মডেল উপাদান
                const apiKeyModal = document.getElementById('apiKeyModal');
                const apiKeyInput = document.getElementById('apiKeyInput');
                const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
                const cancelApiKeyBtn = document.getElementById('cancelApiKeyBtn');
                const apiKeyMessage = document.getElementById('apiKeyMessage');

                // নিশ্চিত করুন যে সমস্ত DOM উপাদান সঠিকভাবে নির্বাচিত হয়েছে
                console.log('basicCalcTab:', basicCalcTab);
                console.log('setApiKeyBtn:', setApiKeyBtn);
                console.log('apiKeyModal:', apiKeyModal);

                // প্রাথমিক ট্যাব প্রদর্শন
                showTab('converter'); // লোডে মৌলিক ক্যালকুলেটরকে সক্রিয় হিসাবে সেট করুন

                // API কী বোতামের স্টাইল আপডেট করার ফাংশন
function updateApiKeyButton() {
    const settingsMenuBtn = document.getElementById('settingsMenuBtn'); // নতুন মেনু বাটনকে টার্গেট করুন
    if (settingsMenuBtn) {
        const apiKey = localStorage.getItem('geminiApiKey');
        if (apiKey) {
            settingsMenuBtn.style.backgroundColor = '#28a745'; // সবুজ
            settingsMenuBtn.style.color = 'white';
        } else {
            settingsMenuBtn.style.backgroundColor = '#ef5350'; // লাল
            settingsMenuBtn.style.color = 'white';
        }
    }
}

                // লোডে কল করুন
                updateApiKeyButton();
// ====================================================================
// END: API KEY SCRIPT PART
// ====================================================================

// ====================================================================
// START: DROPDOWN MENU LOGIC
// ====================================================================
const moreMenuBtn = document.getElementById('moreMenuBtn');
const moreMenuDropdown = document.getElementById('moreMenuDropdown');
const settingsMenuBtn = document.getElementById('settingsMenuBtn');
const settingsMenuDropdown = document.getElementById('settingsMenuDropdown');

if (moreMenuBtn) {
    moreMenuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        moreMenuDropdown.classList.toggle('hidden');
        moreMenuBtn.querySelector('svg').classList.toggle('rotate-180');
        // অন্য মেনুটি বন্ধ করুন
        if (settingsMenuDropdown) settingsMenuDropdown.classList.add('hidden');
        if (settingsMenuBtn) settingsMenuBtn.querySelector('svg').classList.remove('rotate-180');
    });
}

if (settingsMenuBtn) {
    settingsMenuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        settingsMenuDropdown.classList.toggle('hidden');
        settingsMenuBtn.querySelector('svg').classList.toggle('rotate-180');
        // অন্য মেনুটি বন্ধ করুন
        if (moreMenuDropdown) moreMenuDropdown.classList.add('hidden');
        if (moreMenuBtn) moreMenuBtn.querySelector('svg').classList.remove('rotate-180');
    });
}

// মেনুর বাইরে যেকোনো জায়গায় ক্লিক করলে মেনু বন্ধ হয়ে যাবে
window.addEventListener('click', (e) => {
    if (moreMenuDropdown && !moreMenuDropdown.classList.contains('hidden')) {
        moreMenuDropdown.classList.add('hidden');
        moreMenuBtn.querySelector('svg').classList.remove('rotate-180');
    }
    if (settingsMenuDropdown && !settingsMenuDropdown.classList.contains('hidden')) {
        settingsMenuDropdown.classList.add('hidden');
        settingsMenuBtn.querySelector('svg').classList.remove('rotate-180');
    }
});
// ====================================================================
// END: DROPDOWN MENU LOGIC
// ====================================================================

// ====================================================================
// START: TAB AND CONTENT SECTION FOR TAB
// ====================================================================
// সমস্ত ট্যাব এর নাম এবং ট্যাব এর কন্টেন্ট নাম এখানে বসাতে হয়, এই দুটি সেকশনে নতুন ট্যাবের নাম এবং কনটেন্ট নাম যুক্ত করতে হয় বা বসাতে হয় ।

// নতুন ফাংশন: কনভার্টার ট্যাব অ্যাকটিভ হলে অন্য সকল ভারী কার্যক্রম বন্ধ করার জন্য
function stopOtherTabActivities() {
    // ১. বিশ্ব ঘড়ি আপডেট থামান (ঘড়ি ট্যাবের লাইভ টাইম আপডেট বন্ধ করা)
    if (window.worldClockIntervalId) {
        clearInterval(window.worldClockIntervalId);
    }
    // ২. আবহাওয়া আপডেট থামান (নতুন যোগ করা হয়েছে)
    if (window.weatherRefreshIntervalId) {
        clearInterval(window.weatherRefreshIntervalId);
        console.log("Weather refresh stopped to save resources.");
    }
}

function showTab(tabId) {
    const tabs = [
        basicCalcTab,colorPickerTab, dashboardTab,imageResizerTab,moreSettingsTab,historyTab,currencyTab, emiCalcTab, ipInfoTab, recipeTab, pdfToolsTab,screenRecorderTab, jsonFormatterTab, memeGenTab, speedTestTab,
        ageCalcTab, dateCalcTab, scientificCalcTab,  converterTab, measurementTab, typingTestTab, zakatCalcTab,healthLifestyleTab,donateTab,barcodeGenTab, randomPickerTab,
        translatorTab, mapTab, prayerTimeTab, imageToTextTab, wordCounterTab, weatherTab, notepadTab, clockTab,playerTab,daysObservancesTab,
        qrCodeTab,emergencyNumbersTab, spellCheckTab, textBeautifierTab, wordMeaningTab, ttsTab, sttTab, importantLinksTab,invoiceTab, webSearchTab, 
        textAssistantTab,holidayListTab,quizTab,unitPriceTab,tasbeehTab,diffCheckerTab,expenseTrackerTab,textEncryptionTab,
        allFeaturesTab
    ];
    const contents = [
        basicCalculatorContent,colorPickerContent,dashboardContent,imageResizerContent,moreSettingsContent,historyContent,currencyContent, emiCalcContent, ipInfoContent, recipeContent, pdfToolsContent,screenRecorderContent, jsonFormatterContent, memeGenContent, speedTestContent,
        ageCalculatorContent, dateCalculatorContent, emergencyNumbersContent,scientificCalculatorContent,  converterContent,healthLifestyleContent,daysObservancesContent,holidayListContent,quizContent,invoiceContent, webSearchContent,
        measurementContent, typingTestContent, translatorContent, mapContent,  prayerTimeContent, imageToTextContent, wordCounterContent, donateContent, barcodeGenContent, randomPickerContent,
        weatherContent, notepadContent, clockContent, playerContent,qrCodeContent, spellCheckerContent, textBeautifierContent, wordMeaningContent,
        textToSpeechContent, speechToTextContent, textAssistantContent, zakatCalculatorContent,importantLinksContent,unitPriceContent,tasbeehContent,
		diffCheckerContent,expenseTrackerContent,textEncryptionContent,
        allFeaturesContent
    ];

    // সমস্ত ট্যাব বোতাম থেকে 'active' ক্লাস সরিয়ে দিন
    tabs.forEach(tab => {
        if (tab) tab.classList.remove('active');
    });

    // নতুন: ড্রপডাউন মেনুর প্যারেন্ট বাটন থেকে 'active' ক্লাস সরিয়ে দিন (রিসেট)
    const moreMenuBtn = document.getElementById('moreMenuBtn');
    const settingsMenuBtn = document.getElementById('settingsMenuBtn');
    if (moreMenuBtn) moreMenuBtn.classList.remove('active');
    if (settingsMenuBtn) settingsMenuBtn.classList.remove('active');

    // সমস্ত কন্টেন্ট বিভাগ লুকান
    contents.forEach(content => {
        if (content) content.classList.remove('active');
    });

    // ============================================================
    // কনফিগারেশন: কনভার্টার ট্যাব চালু থাকলে ব্যাকগ্রাউন্ড অ্যাক্টিভিটি (ঘড়ি, আবহাওয়া) বন্ধ হবে কিনা?
    // true = বন্ধ হবে (রিসোর্স বাঁচবে)
    // false = বন্ধ হবে না (সব চলতে থাকবে)
    const stopActivitiesOnConverter = false; 
    // ============================================================

    // *** নতুন লজিক: কনভার্টার ট্যাব সিলেক্ট করা হলে এবং কনফিগারেশন অন থাকলে অন্য কার্যক্রম বন্ধ করুন ***
    if (tabId === 'converter' && stopActivitiesOnConverter) {
        stopOtherTabActivities();
    }

    // নির্বাচিত ট্যাব সক্রিয় করুন এবং এর কন্টেন্ট দেখান
    let activeTab, activeContent;
// ====================================================================
// END: TAB AND CONTENT SECTION FOR TAB
// ====================================================================

// ====================================================================
// START: CASE AND BREAK SECTION FOR TAB
// ====================================================================	
//নিচের অংশে নতুন ট্যাবের কেস যুক্ত করতে হয় বা বসাতে হয় ।

    switch (tabId) {
case 'basic':
            activeTab = basicCalcTab;
            activeContent = basicCalculatorContent;
            // ডেস্কটপে (নন-টাচ ডিভাইস) ফোকাস ক্লিয়ার করা যাতে সরাসরি টাইপ করা যায়
            setTimeout(() => {
                if (!window.matchMedia("(pointer: coarse)").matches) {
                    // বর্তমানে ফোকাস থাকা এলিমেন্ট (যেমন ট্যাব বাটন) থেকে ফোকাস সরিয়ে নিন
                    if (document.activeElement instanceof HTMLElement) {
                        document.activeElement.blur();
                    }
                }
            }, 100);
            break;
        case 'age':
            activeTab = ageCalcTab;
            activeContent = ageCalculatorContent;
            break;
            case 'imageResizer':
                activeTab = imageResizerTab;
                activeContent = imageResizerContent;
                initializeImageResizer();
            break;
        case 'date':
            activeTab = dateCalcTab;
            activeContent = dateCalculatorContent;
        break;
			case 'expenseTracker':
			activeTab = expenseTrackerTab;
			activeContent = expenseTrackerContent;
			initializeExpenseTracker();
		break;
		case 'scientific':
            activeTab = scientificCalcTab;
            activeContent = scientificCalculatorContent;
            // নতুন: ডেস্কটপে (নন-টাচ ডিভাইস) অটো-ফোকাস লজিক
            setTimeout(() => {
                // টাচ ডিভাইস না হলে এবং ইনপুট এলিমেন্ট থাকলে ফোকাস করুন
                if (scientificExpressionInput && !window.matchMedia("(pointer: coarse)").matches) {
                    scientificExpressionInput.focus();
                }
            }, 100); 
            break;
        case 'converter':
            activeTab = converterTab;
            activeContent = converterContent;
            break;
		case 'diffChecker':
			activeTab = diffCheckerTab;
			activeContent = diffCheckerContent;
			initializeDiffChecker();
		break;
        case 'measurement':
            activeTab = measurementTab;
            activeContent = measurementContent;
            break;
        case 'typingTest':
            activeTab = typingTestTab;
            activeContent = typingTestContent;
            break;
        case 'translator':
            activeTab = translatorTab;
            activeContent = translatorContent;
            break;
        case 'map':
            activeTab = mapTab;
            activeContent = mapContent;
            break;
        case 'prayerTime':
            activeTab = prayerTimeTab;
            activeContent = prayerTimeContent;
            initializePrayerTimeTab();
        break;
			case 'tasbeeh':
			activeTab = tasbeehTab;
			activeContent = tasbeehContent;
			initializeTasbeeh();
		break;
        case 'daysObservances':
            activeTab = daysObservancesTab;
            activeContent = daysObservancesContent;
            initializeDaysObservancesTab();
        break;
        case 'zakat':
            activeTab = zakatCalcTab;
            activeContent = zakatCalculatorContent;
            break;
			    case 'unitPrice':
        activeTab = unitPriceTab;
        activeContent = unitPriceContent;
        initializeUnitPriceComparator();
        break;
        case 'imageToText':
            activeTab = imageToTextTab;
            activeContent = imageToTextContent;
            break;
        case 'wordCounter':
            activeTab = wordCounterTab;
            activeContent = wordCounterContent;
            break;
        case 'healthLifestyle':
            activeTab = healthLifestyleTab;
            activeContent = healthLifestyleContent;
            break;
        case 'weather': // নতুন এই case টি যোগ করুন
            activeTab = weatherTab;
            activeContent = weatherContent;
            break;
        case 'notepad':
            activeTab = notepadTab;
            activeContent = notepadContent;
            break;
        case 'clock':
            activeTab = clockTab;
            activeContent = clockContent;
            initializeClockTab(); // নতুন ফাংশন কল করুন
            break;
        case 'qrCode':
            activeTab = qrCodeTab;
            activeContent = qrCodeContent;
            break;
        case 'history':
            activeTab = historyTab;
            activeContent = historyContent;
            initializeHistoryTab(); 
            break;
        case 'importantLinks':
            activeTab = importantLinksTab;
            activeContent = importantLinksContent;
            break;
        case 'holiday':
            activeTab = holidayListTab;
            activeContent = holidayListContent;
            initializeHolidayListTab();
            break;
        case 'player':
            activeTab = playerTab;
            activeContent = playerContent;
            break;
        case 'spellCheck':
            activeTab = spellCheckTab;
            activeContent = spellCheckerContent;
            break;
        case 'beautify':
            activeTab = textBeautifierTab;
            activeContent = textBeautifierContent;
            break;
        case 'meaning':
            activeTab = wordMeaningTab;
            activeContent = wordMeaningContent;
            break;
        case 'tts':
            activeTab = ttsTab;
            activeContent = textToSpeechContent;
            break;
        case 'stt':
            activeTab = sttTab;
            activeContent = speechToTextContent;
            break;
        case 'textAssistant':
            activeTab = textAssistantTab;
            activeContent = textAssistantContent;
            break;
        case 'emergency':
            activeTab = emergencyNumbersTab;
            activeContent = emergencyNumbersContent;
            initializeEmergencyNumbers(); // Tab-টি চালু করার সময় ফাংশন কল করুন
            break;
        case 'quiz':
            activeTab = quizTab;
            activeContent = quizContent;
            initializeQuiz(); // এই ফাংশন কুইজ শুরু করবে
            break;
        case 'moreSettings': 
            activeTab = moreSettingsTab;
            activeContent = moreSettingsContent;
            initializeMoreSettings(); // শুধুমাত্র এই নতুন ফাংশনটি থাকবে
            break;
        case 'colorPicker':
            activeTab = colorPickerTab;
            activeContent = colorPickerContent;
            initializeColorPicker(); // ট্যাব দেখানোর সময় ফাংশনটি কল করুন
            break;
        case 'donate':
            activeTab = donateTab;
            activeContent = donateContent;
            break;
        case 'invoice':
            activeTab = invoiceTab;
            activeContent = invoiceContent;
            break;
        case 'allFeatures':
            activeTab = allFeaturesTab;
            activeContent = allFeaturesContent;
            break;
        case 'dashboard':
            activeTab = dashboardTab;
            activeContent = dashboardContent;
            break;
            case 'webSearch':
            activeTab = webSearchTab;
            activeContent = webSearchContent;
            initializeWebSearch(); // নিচে এই ফাংশনটি ডিফাইন করা হয়েছে
            break;
			// switch (tabId) ব্লকে যোগ করুন:
case 'currency':
    activeTab = currencyTab;
    activeContent = currencyContent;
    initializeCurrencyConverter();
    break;
case 'emi':
    activeTab = emiCalcTab;
    activeContent = emiCalcContent;
    initializeEMICalculator();
    break;
case 'ip':
    activeTab = ipInfoTab;
    activeContent = ipInfoContent;
    initializeIpInfo();
    if(window.fetchIpInfo) window.fetchIpInfo(); // Auto load
    break;
case 'recipe':
    activeTab = recipeTab;
    activeContent = recipeContent;
    initializeRecipeGenerator();
    break;
case 'pdf':
    activeTab = pdfToolsTab;
    activeContent = pdfToolsContent;
    initializePdfTools();
    break;
    case 'screenRecorder':
    activeTab = screenRecorderTab;
    activeContent = screenRecorderContent;
    initializeScreenRecorder();
    break;
case 'jsonFormatter':
    activeTab = jsonFormatterTab;
    activeContent = jsonFormatterContent;
    initializeJsonFormatter();
    break;
case 'memeGen':
    activeTab = memeGenTab;
    activeContent = memeGenContent;
    initializeMemeGenerator();
    break;
case 'barcode':
    activeTab = barcodeGenTab;
    activeContent = barcodeGenContent;
    initializeBarcodeGenerator();
    break;
case 'randomPicker':
    activeTab = randomPickerTab;
    activeContent = randomPickerContent;
    initializeRandomPicker();
    break;
    case 'encryption':
    activeTab = textEncryptionTab;
    activeContent = textEncryptionContent;
    initializeTextEncryption();
    break;
case 'speedTest':
    activeTab = speedTestTab;
    activeContent = speedTestContent;
	initializeSpeedTest();
    break; // স্পিড টেস্টে বাটনে ক্লিক করলে ফাংশন কল হবে
    
    }

    if (activeTab) activeTab.classList.add('active');
    if (activeContent) activeContent.classList.add('active');

    // --- নতুন: সাইডবারে একটিভ ট্যাব হাইলাইট করা ---
    // সাইডবারের লিংকগুলো খুঁজে বের করে স্টাইল আপডেট করুন
    const sidebarItems = document.querySelectorAll('#sidebar-tool-list a');
    if (sidebarItems.length > 0) {
        sidebarItems.forEach(item => {
            // ডিফল্ট স্টাইল (ইনঅ্যাক্টিভ) - আগের স্টাইলে রিসেট
            item.className = "block w-full text-left p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 transition-colors duration-200";
            
            // যদি এটি একটিভ ট্যাব হয়
            if (activeTab && item.dataset.tabId === activeTab.id) {
                // একটিভ স্টাইল (নীল ব্যাকগ্রাউন্ড, সাদা টেক্সট)
                item.className = "block w-full text-left p-2 rounded-lg bg-indigo-600 text-white shadow-md font-semibold transition-colors duration-200";
            }
        });
    }

    // --- নতুন: ড্রপডাউন মেনু হাইলাইট করার লজিক ---
    // 'আরও' মেনুর অন্তর্ভুক্ত ট্যাব আইডি সমূহ tabidmap
    const moreMenuTabs = [
        'clock', 'player', 'quiz', 'history', 'daysObservances', 'tasbeeh','diffChecker',
        'holiday', 'zakat', 'qrCode', 'colorPicker', 'invoice', 'unitPrice',
        'imageResizer', 'emergency', 'healthLifestyle', 'expenseTracker',
        'currency', 'emi', 'ip', 'recipe', 'pdf', 'randomPicker','barcode',
        'screenRecorder', 'jsonFormatter', 'memeGen', 'speedTest', 'encryption',
        'allFeatures', 'importantLinks', 'donate'
    ];

    // 'সেটিংস' মেনুর অন্তর্ভুক্ত ট্যাব আইডি সমূহ
    const settingsMenuTabs = ['moreSettings'];

    // যদি বর্তমান ট্যাবটি 'আরও' মেনুর অন্তর্ভুক্ত হয়
    if (moreMenuBtn && moreMenuTabs.includes(tabId)) {
        moreMenuBtn.classList.add('active');
    }

    // যদি বর্তমান ট্যাবটি 'সেটিংস' মেনুর অন্তর্ভুক্ত হয়
    if (settingsMenuBtn && settingsMenuTabs.includes(tabId)) {
        settingsMenuBtn.classList.add('active');
    }

    console.log(`ট্যাব পরিবর্তন করা হয়েছে: ${tabId}`);
}
// ====================================================================
// END: CASE AND BREAK SECTION FOR TAB
// ====================================================================

// ====================================================================
// START: IF SECTION FOR TAB
// ====================================================================
//নিচের এই সেকশনে নতুন ট্যাবের ইফ লাইনটি যুক্ত করতে হয় বা বসাতে হয় ।

    if (basicCalcTab) basicCalcTab.addEventListener('click', () => showTab('basic'));
    if (ageCalcTab) ageCalcTab.addEventListener('click', () => showTab('age'));
    if (dateCalcTab) dateCalcTab.addEventListener('click', () => showTab('date'));
    if (scientificCalcTab) scientificCalcTab.addEventListener('click', () => showTab('scientific'));
    if (converterTab) converterTab.addEventListener('click', () => showTab('converter'));
    if (measurementTab) measurementTab.addEventListener('click', () => showTab('measurement')); 
    if (spellCheckTab) spellCheckTab.addEventListener('click', () => showTab('spellCheck'));
    if (textBeautifierTab) textBeautifierTab.addEventListener('click', () => showTab('beautify'));
    if (wordMeaningTab) wordMeaningTab.addEventListener('click', () => showTab('meaning'));
    if (ttsTab) ttsTab.addEventListener('click', () => showTab('tts')); 
    if (sttTab) sttTab.addEventListener('click', () => showTab('stt')); 
    if (typingTestTab) typingTestTab.addEventListener('click', () => showTab('typingTest')); 
    if (mapTab) mapTab.addEventListener('click', () => showTab('map'));
    if (prayerTimeTab) prayerTimeTab.addEventListener('click', () => showTab('prayerTime')); 
    if (imageToTextTab) imageToTextTab.addEventListener('click', () => showTab('imageToText'));
    if (wordCounterTab) wordCounterTab.addEventListener('click', () => showTab('wordCounter'));
    if (weatherTab) weatherTab.addEventListener('click', () => showTab('weather'));
    if (quizTab) quizTab.addEventListener('click', () => showTab('quiz'));
    if (donateTab) donateTab.addEventListener('click', () => showTab('donate'));
    if (notepadTab) notepadTab.addEventListener('click', async () => {
        showTab('notepad');
        await initializeNotepad(); // Notepad চালু করার জন্য এই ফাংশন কল করুন
    });
    if (webSearchTab) webSearchTab.addEventListener('click', () => showTab('webSearch'));
    if (healthLifestyleTab) healthLifestyleTab.addEventListener('click', () => {showTab('healthLifestyle');	initializeHealthLifestyleTab();});
    if (clockTab) clockTab.addEventListener('click', () => showTab('clock'));
    if (playerTab) playerTab.addEventListener('click', () => showTab('player'));
    if (zakatCalcTab) zakatCalcTab.addEventListener('click', () => showTab('zakat'));
    if (imageResizerTab) imageResizerTab.addEventListener('click', () => showTab('imageResizer'));
    if (qrCodeTab) qrCodeTab.addEventListener('click', () => showTab('qrCode'));
    if (importantLinksTab) importantLinksTab.addEventListener('click', () => showTab('importantLinks'));
    if (textAssistantTab) textAssistantTab.addEventListener('click', () => showTab('textAssistant'));
    if (allFeaturesTab) allFeaturesTab.addEventListener('click', () => showTab('allFeatures'));
    if (emergencyNumbersTab) emergencyNumbersTab.addEventListener('click', () => showTab('emergency'));
    if (daysObservancesTab) daysObservancesTab.addEventListener('click', () => showTab('daysObservances'));
    if (holidayListTab) holidayListTab.addEventListener('click', () => showTab('holiday'));
    if (invoiceTab) invoiceTab.addEventListener('click', () => showTab('invoice'));
    if (colorPickerTab) colorPickerTab.addEventListener('click', () => showTab('colorPicker'));
    if (dashboardTab) dashboardTab.addEventListener('click', () => showTab('dashboard'));
    if (moreSettingsTab) moreSettingsTab.addEventListener('click', () => showTab('moreSettings'));
    if (historyTab) historyTab.addEventListener('click', () => showTab('history'));
	if (currencyTab) currencyTab.addEventListener('click', () => showTab('currency'));
if (emiCalcTab) emiCalcTab.addEventListener('click', () => showTab('emi'));
if (unitPriceTab) unitPriceTab.addEventListener('click', () => showTab('unitPrice'));
if (ipInfoTab) ipInfoTab.addEventListener('click', () => showTab('ip'));
if (recipeTab) recipeTab.addEventListener('click', () => showTab('recipe'));
if (pdfToolsTab) pdfToolsTab.addEventListener('click', () => showTab('pdf'));
if (screenRecorderTab) screenRecorderTab.addEventListener('click', () => showTab('screenRecorder'));
if (jsonFormatterTab) jsonFormatterTab.addEventListener('click', () => showTab('jsonFormatter'));
if (memeGenTab) memeGenTab.addEventListener('click', () => showTab('memeGen'));
if (speedTestTab) speedTestTab.addEventListener('click', () => showTab('speedTest'));
if (textEncryptionTab) textEncryptionTab.addEventListener('click', () => showTab('encryption'));
if (barcodeGenTab) barcodeGenTab.addEventListener('click', () => showTab('barcode'));
if (randomPickerTab) randomPickerTab.addEventListener('click', () => showTab('randomPicker'));
if (tasbeehTab) {tasbeehTab.addEventListener('click', () => {showTab('tasbeeh');
        initializeTasbeeh(); // ফাংশনটি কল করুন
    });
}
if (diffCheckerTab) diffCheckerTab.addEventListener('click', () => showTab('diffChecker'));
if (expenseTrackerTab) expenseTrackerTab.addEventListener('click', () => {    showTab('expenseTracker');    initializeExpenseTracker(); });

	
// ====================================================================
// END: IF SECTION FOR TAB
// ====================================================================

// ====================================================================
// START: API KEY SCRIPT
// ====================================================================
                // API কী সেটিং বোতাম এবং মডেল লজিক
                
                // নিশ্চিত করুন যে পেজ লোড হওয়ার সময় মডেলটি লুকানো আছে (অটোমেটিক আসা বন্ধ করতে)
                if (apiKeyModal) {
                    apiKeyModal.classList.add('hidden');
                }

                if (setApiKeyBtn) {
                    setApiKeyBtn.addEventListener('click', () => {
                        console.log('API কী সেট করুন বোতামে ক্লিক করা হয়েছে।');
                        // শুধুমাত্র এই বাটনে ক্লিক করলেই মডেলটি ওপেন হবে
                        if (apiKeyModal) {
                            apiKeyModal.classList.remove('hidden');
                            if (apiKeyInput) apiKeyInput.value = localStorage.getItem('geminiApiKey') || ''; // বর্তমান কী থাকলে দেখান
                            if (apiKeyMessage) apiKeyMessage.innerText = ''; // পূর্ববর্তী বার্তা পরিষ্কার করুন
                            console.log('API কী মডেল দেখানো হয়েছে।');
                        } else {
                            console.error('API কী মডেল উপাদান পাওয়া যায়নি।');
                        }
                    });
                } else {
                    console.error('API কী সেট করুন বোতাম পাওয়া যায়নি।');
                }

                if (saveApiKeyBtn) {
                    saveApiKeyBtn.addEventListener('click', () => {
                        console.log('API কী সেভ করুন বোতামে ক্লিক করা হয়েছে।');
                        const newApiKey = apiKeyInput ? apiKeyInput.value.trim() : '';
                        if (newApiKey) {
                            localStorage.setItem('geminiApiKey', newApiKey);
                            if (apiKeyMessage) {
                                apiKeyMessage.innerText = 'API কী সফলভাবে সেট করা হয়েছে!';
                                apiKeyMessage.classList.remove('error');
                                apiKeyMessage.classList.add('success');
                            }
                            console.log('API কী সফলভাবে সেভ করা হয়েছে।');
                            updateApiKeyButton(); // অবিলম্বে বোতামের স্টাইল আপডেট করুন
                            setTimeout(() => {
                                if (apiKeyModal) apiKeyModal.classList.add('hidden');
                            }, 1500); // 1.5 সেকেন্ড পর মডেল লুকান
                        } else {
                            if (apiKeyMessage) {
                                apiKeyMessage.innerText = 'অনুগ্রহ করে একটি বৈধ API কী লিখুন।';
                                apiKeyMessage.classList.remove('success');
                                apiKeyMessage.classList.add('error');
                            }
                            console.warn('অবৈধ API কী প্রবেশ করানো হয়েছে।');
                        }
                    });
                }

                if (cancelApiKeyBtn) {
                    cancelApiKeyBtn.addEventListener('click', () => {
                        console.log('API কী বাতিল করুন বোতামে ক্লিক করা হয়েছে।');
                        if (apiKeyModal) apiKeyModal.classList.add('hidden');
                    });
                }
// ====================================================================
// END: API KEY SCRIPT
// ====================================================================

// ====================================================================
// START: ক্যালকুলেটর লজিক
// ====================================================================
                // --- মৌলিক ক্যালকুলেটর ক্লাস এবং লজিক ---
                class Calculator {
                    constructor(previousOperandTextElement, currentOperandTextElement) {
                        this.previousOperandTextElement = previousOperandTextElement;
                        this.currentOperandTextElement = currentOperandTextElement;
                        this.clear();
                        this.loadHistory(); // ক্যালকুলেটর লোড হওয়ার সময় হিস্টোরি লোড হবে
                    }

                    clear() {
                        this.currentOperand = '';
                        this.previousOperand = '';
                        this.operation = undefined;
                        this.updateDisplay();
                        // Clearing history is handled by the clearHistoryBtn
                    }

                    delete() {
                        this.currentOperand = this.currentOperand.toString().slice(0, -1);
                        this.updateDisplay();
                    }

                    appendNumber(number) {
                        if (number === '.' && this.currentOperand.includes('.')) return;
                        this.currentOperand = this.currentOperand.toString() + number.toString();
                        this.updateDisplay();
                    }

                    chooseOperation(operation) {
                        if (this.currentOperand === '') return;
                        
                        // % এর জন্য বিশেষ লজিক (আপডেট করা হয়েছে)
                        if (operation === '%') {
                            const current = parseFloat(this.currentOperand);
                            const prev = parseFloat(this.previousOperand);

                            if (isNaN(current)) return;

                            // Case 1: Unary Percentage (e.g., 10%) - শুধুমাত্র সংখ্যাকে 100 দিয়ে ভাগ করবে
                            if (this.previousOperand === '' || this.operation === undefined) {
                                this.currentOperand = current / 100;
                                this.updateDisplay();
                                return;
                            }
                            // Case 2: Binary Percentage (e.g., 400 * 10% or 100 - 10%) - সম্পূর্ণ গণনাটি % চাপার সাথে সাথেই শেষ হবে
                            else {
                                if (isNaN(prev)) return;

                                let percentageOperand;
                                
                                // যোগ/বিয়োগ: বর্তমান সংখ্যাটি হলো পূর্বের সংখ্যার শতকরা হার। (যেমন: 100 - 10% = 100 - (10% of 100))
                                if (this.operation === '+' || this.operation === '-') {
                                    percentageOperand = (prev * current) / 100;
                                } 
                                // গুণ/ভাগ: বর্তমান সংখ্যাটিকে দশমিকে রূপান্তর করা হবে। (যেমন: 400 * 10% = 400 * 0.1)
                                else { 
                                    percentageOperand = current / 100;
                                }
                                
                                // পার্সেন্টেজ ভ্যালু ব্যবহার করে সম্পূর্ণ গণনা
                                let computation;
                                switch (this.operation) {
                                    case '+':
                                        computation = prev + percentageOperand;
                                        break;
                                    case '-':
                                        computation = prev - percentageOperand;
                                        break;
                                    case '×':
                                        computation = prev * percentageOperand;
                                        break;
                                    case '÷':
                                        if (percentageOperand === 0) {
                                            computation = 'Error';
                                        } else {
                                            computation = prev / percentageOperand;
                                        }
                                        break;
                                }

                                // Update history, display, and reset state
                                if (computation !== 'Error' && computation !== undefined) {
                                    this.addHistoryEntry(`${this.getDisplayNumber(prev)} ${this.operation} ${this.getDisplayNumber(current)}% = ${this.getDisplayNumber(computation)}`);
                                }
                                
                                this.currentOperand = computation;
                                this.operation = undefined;
                                this.previousOperand = '';
                                this.updateDisplay();
                                return;
                            }
                        }

                        if (this.previousOperand !== '') {
                            this.compute();
                        }
                        this.operation = operation;
                        this.previousOperand = this.currentOperand;
                        this.currentOperand = '';
                        this.updateDisplay();
                    }

                    compute() {
                        let computation;
                        const prev = parseFloat(this.previousOperand);
                        const current = parseFloat(this.currentOperand);
                        if (isNaN(prev) || isNaN(current)) return;

                        // নিয়মিত অপারেশনের গণনা
                        switch (this.operation) {
                            case '+':
                                computation = prev + current;
                                break;
                            case '-':
                                computation = prev - current;
                                break;
                            case '×':
                                computation = prev * current;
                                break;
                            case '÷':
                                if (current === 0) {
                                    computation = 'Error';
                                } else {
                                    computation = prev / current;
                                }
                                break;
                            default:
                                return;
                        }

                        // Add to history ONLY if computation is valid
                        if (computation !== 'Error') {
                            this.addHistoryEntry(`${this.getDisplayNumber(prev)} ${this.operation} ${this.getDisplayNumber(current)} = ${this.getDisplayNumber(computation)}`);
                        }

                        this.currentOperand = computation;
                        this.operation = undefined;
                        this.previousOperand = '';
                        this.updateDisplay();
                    }

                    getDisplayNumber(number) {
                        const stringNumber = number.toString();
                        const integerDigits = parseFloat(stringNumber.split('.')[0]);
                        const decimalDigits = stringNumber.split('.')[1];
                        let integerDisplay;
                        if (isNaN(integerDigits)) {
                            integerDisplay = '';
                        } else {
                            integerDisplay = integerDigits.toLocaleString('en', {
                                maximumFractionDigits: 0
                            });
                        }
                        if (decimalDigits != null) {
                            return `${integerDisplay}.${decimalDigits}`;
                        } else {
                            return integerDisplay;
                        }
                    }

                    updateDisplay() {
                        if (this.currentOperandTextElement) {
                            this.currentOperandTextElement.innerText = this.getDisplayNumber(this.currentOperand);
                        }
                        if (this.previousOperandTextElement) {
                            if (this.operation != null) {
                                this.previousOperandTextElement.innerText =
                                    `${this.getDisplayNumber(this.previousOperand)} ${this.operation}`;
                            } else {
                                this.previousOperandTextElement.innerText = '';
                            }
                        }
                    }

                    // Basic Calculator History function (Updated: Persistent & No Limit)
                    addHistoryEntry(entry) {
                        const historyList = document.getElementById('history-list');
                        if (historyList) {
                            const listItem = document.createElement('li');
                            listItem.innerText = entry;
                            historyList.prepend(listItem); // Add to top of list
                            this.saveHistoryToStorage(entry); // লোকাল স্টোরেজে সেভ করুন
                        }
                    }

                    // নতুন: হিস্টোরি সেভ করার ফাংশন
                    saveHistoryToStorage(entry) {
                        let history = JSON.parse(localStorage.getItem('basicCalcHistory') || '[]');
                        history.unshift(entry);
                        localStorage.setItem('basicCalcHistory', JSON.stringify(history));
                    }

                    // নতুন: হিস্টোরি লোড করার ফাংশন
                    loadHistory() {
                        const historyList = document.getElementById('history-list');
                        if (!historyList) return;
                        
                        const history = JSON.parse(localStorage.getItem('basicCalcHistory') || '[]');
                        historyList.innerHTML = '';
                        
                        history.forEach(entry => {
                            const listItem = document.createElement('li');
                            listItem.innerText = entry;
                            historyList.appendChild(listItem);
                        });
                    }
                }

                // মৌলিক ক্যালকুলেটর DOM উপাদান এবং ইনিশিয়ালাইজেশন
                const numberButtons = document.querySelectorAll('[data-number]');
                const operatorButtons = document.querySelectorAll('[data-operator]');
                const equalsButton = document.querySelector('[data-equals]');
                const deleteButton = document.querySelector('[data-delete]');
                const allClearButton = document.querySelector('[data-all-clear]');
                const previousOperandTextElement = document.querySelector('[data-previous-operand]');
                const currentOperandTextElement = document.querySelector('[data-current-operand]');
                // Basic Calculator History elements
                const historyList = document.getElementById('history-list');
                const clearHistoryBtn = document.getElementById('clearHistoryBtn');

                if (previousOperandTextElement && currentOperandTextElement) {
                    const basicCalculator = new Calculator(previousOperandTextElement, currentOperandTextElement);

                    // মৌলিক ক্যালকুলেটর বোতামগুলির জন্য ইভেন্ট লিসেনার
                    numberButtons.forEach(button => {
                        button.addEventListener('click', () => {
                            console.log('সংখ্যা বোতামে ক্লিক করা হয়েছে:', button.innerText);
                            basicCalculator.appendNumber(button.innerText);
                        });
                    });

                    operatorButtons.forEach(button => {
                        button.addEventListener('click', () => {
                            console.log('অপারেটর বোতামে ক্লিক করা হয়েছে:', button.innerText);
                            basicCalculator.chooseOperation(button.innerText);
                        });
                    });

                    if (equalsButton) {
                        equalsButton.addEventListener('click', () => {
                            console.log('সমান বোতামে ক্লিক করা হয়েছে।');
                            basicCalculator.compute();
                        });
                    }

                    if (allClearButton) {
                        allClearButton.addEventListener('click', () => {
                            console.log('সব পরিষ্কার বোতামে ক্লিক করা হয়েছে।');
                            basicCalculator.clear();
                        });
                    }

                    if (deleteButton) {
                        deleteButton.addEventListener('click', () => {
                            console.log('মুছুন বোতামে ক্লিক করা হয়েছে।');
                            basicCalculator.delete();
                        });
                    }

                    // Basic Calculator History Clear Button (Updated for persistence)
                    if (clearHistoryBtn) {
                        clearHistoryBtn.addEventListener('click', () => {
                            if (historyList) {
                                historyList.innerHTML = '';
                                localStorage.removeItem('basicCalcHistory'); // লোকাল স্টোরেজ থেকে মুছুন
                                showCustomAlert('হিস্টোরি পরিষ্কার করা হয়েছে!');
                            }
                        });
                    }

                    // মৌলিক ক্যালকুলেটরের জন্য কীবোর্ড ইনপুট সমর্থন
                    document.addEventListener('keydown', e => {
                        if (!basicCalculatorContent || !basicCalculatorContent.classList.contains('active')) return;

                        if (e.key >= '0' && e.key <= '9' || e.key === '.') {
                            basicCalculator.appendNumber(e.key);
                        } else if (e.key === '+' || e.key === '-' || e.key === '*' || e.key === '/' || e.key === '%') {
                            let operatorKey = e.key;
                            if (operatorKey === '*') operatorKey = '×';
                            if (operatorKey === '/') operatorKey = '÷';
                            basicCalculator.chooseOperation(operatorKey);
                        } else if (e.key === 'Enter' || e.key === '=') {
                            e.preventDefault();
                            basicCalculator.compute();
                        } else if (e.key === 'Backspace') {
                            basicCalculator.delete();
                        } else if (e.key === 'Escape' || e.key === 'Delete') {
                            basicCalculator.clear();
                        }
                    });
                } else {
                    console.error('মৌলিক ক্যালকুলেটর ডিসপ্লে উপাদান পাওয়া যায়নি।');
                }


                // মৌলিক ক্যালকুলেটর ব্যাখ্যা বৈশিষ্ট্য (আপডেট করা হয়েছে: হিস্টোরি থেকে ডেটা নেওয়া হবে)
                const explainBasicBtn = document.getElementById('explainBasicBtn');
                const basicExplanation = document.getElementById('basicExplanation');
                const basicExplanationLoading = document.getElementById('basicExplanationLoading');

                if (explainBasicBtn && basicExplanation && basicExplanationLoading) {
                    explainBasicBtn.addEventListener('click', async () => {
                        console.log('মৌলিক ব্যাখ্যা বোতামে ক্লিক করা হয়েছে।');
                        
                        // পরিবর্তন: হিস্টোরির প্রথম আইটেম থেকে এক্সপ্রেশন নেওয়া হচ্ছে
                        let fullExpression = '';
                        if (historyList && historyList.firstElementChild) {
                            fullExpression = historyList.firstElementChild.innerText.trim();
                        }

                        if (!fullExpression) {
                            basicExplanation.innerText = 'ব্যাখ্যার জন্য অনুগ্রহ করে প্রথমে একটি ক্যালকুলেশন করুন।';
                            return;
                        }

                        basicExplanation.innerText = '';
                        basicExplanationLoading.style.display = 'block';
                        explainBasicBtn.disabled = true;

                        try {
                            const apiKey = localStorage.getItem('geminiApiKey');
                            if (!apiKey) {
                                basicExplanation.innerText = 'জেমিনি API কী সেট করা হয়নি। অনুগ্রহ করে "API কী সেট করুন" বাটনে ক্লিক করে কী সেট করুন।';
                                basicExplanationLoading.style.display = 'none';
                                explainBasicBtn.disabled = false;
                                return;
                            }

                            let chatHistory = [];
                            chatHistory.push({
                                role: "user",
                                parts: [{
                                    text: `এই গাণিতিক এক্সপ্রেশনটি সহজ ভাষায় ব্যাখ্যা করুন: "${fullExpression}"। এটি কী করে এবং এর মূল ধারণা কী?`
                                }]
                            });
                            const payload = {
                                contents: chatHistory
                            };
                            // সেটিংস থেকে মডেল নেওয়া হচ্ছে, না থাকলে ডিফল্ট মডেল ব্যবহার হবে
                            const model = localStorage.getItem('geminiModel') || "gemini-flash-latest";
                            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

                            const response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(payload)
                            });

                            const result = await response.json();

                            if (result.candidates && result.candidates.length > 0 &&
                                result.candidates[0].content && result.candidates[0].content.parts &&
                                result.candidates[0].content.parts.length > 0) {
                                const text = result.candidates[0].content.parts[0].text;
                                basicExplanation.innerText = text;
                            } else {
                                basicExplanation.innerText = 'জেমিনি থেকে কোনো প্রতিক্রিয়া পাওয়া যায়নি।';
                                console.error('জেমিনি API প্রতিক্রিয়া অপ্রত্যাশিত:', result);
                            }
                        } catch (error) {
                            basicExplanation.innerText = 'জেমিনি API কল করার সময় একটি ত্রুটি হয়েছে: ' + error.message;
                            console.error('জেমিনি API ত্রুটি:', error);
                        } finally {
                            basicExplanationLoading.style.display = 'none';
                            explainBasicBtn.disabled = false;
                        }
                    });
                } else {
                    console.error('মৌলিক ব্যাখ্যা উপাদান পাওয়া যায়নি।');
                }
// ====================================================================
// END: ক্যালকুলেটর লজিক
// ====================================================================

// ====================================================================
// START:  বয়স ক্যালকুলেটর লজিক
// ====================================================================
                // --- বয়স ক্যালকুলেটর লজিক ---
                const birthDateInput = document.getElementById('birthDate');
                const currentDateInput = document.getElementById('currentDate');
                const calculateAgeBtn = document.getElementById('calculateAgeBtn');
                const ageResult = document.getElementById('ageResult');
                const ageErrorMessage = document.getElementById('ageErrorMessage');


                // বর্তমান তারিখ ইনপুটের জন্য বর্তমান তারিখ ডিফল্ট হিসাবে সেট করুন
                const todayCurrentDate = new Date();
                const todayCurrentDateString = todayCurrentDate.toISOString().split('T')[0];
                if (currentDateInput) currentDateInput.value = todayCurrentDateString;

                if (calculateAgeBtn) {
                    calculateAgeBtn.addEventListener('click', () => {
                        console.log('বয়স গণনা করুন বোতামে ক্লিক করা হয়েছে।');
                        calculateAge();
                    });
                }

                function calculateAge() {
                    const birthDateValue = birthDateInput ? birthDateInput.value : '';
                    const currentDateValue = currentDateInput ? currentDateInput.value : '';

                    // পূর্ববর্তী বার্তা পরিষ্কার করুন
                    if (ageResult) ageResult.innerText = '';
                    if (ageErrorMessage) ageErrorMessage.innerText = '';

                    if (!birthDateValue || !currentDateValue) {
                        if (ageErrorMessage) ageErrorMessage.innerText = 'অনুগ্রহ করে জন্ম তারিখ এবং বর্তমান তারিখ উভয়ই নির্বাচন করুন।';
                        return;
                    }

                    const birthDate = new Date(birthDateValue);
                    const currentDate = new Date(currentDateValue);

                    if (birthDate > currentDate) {
                        if (ageErrorMessage) ageErrorMessage.innerText = 'জন্ম তারিখ বর্তমান তারিখের চেয়ে বেশি হতে পারে না।';
                        return;
                    }

                    let years = currentDate.getFullYear() - birthDate.getFullYear();
                    let months = currentDate.getMonth() - birthDate.getMonth();
                    let days = currentDate.getDate() - birthDate.getDate();

                    // দিনগুলি নেতিবাচক হলে মাস এবং বছর সামঞ্জস্য করুন
                    if (days < 0) {
                        months--;
                        // বর্তমান তারিখের পূর্ববর্তী মাসের দিনের সংখ্যা পান
                        const prevMonthLastDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0).getDate();
                        days += prevMonthLastDay;
                    }

                    // মাসগুলি নেতিবাচক হলে বছর সামঞ্জস্য করুন
                    if (months < 0) {
                        years--;
                        months += 12;
                    }

                    if (ageResult) ageResult.innerText = `আপনার বয়স: ${years} বছর, ${months} মাস, ${days} দিন।`;
                }
// --- বছর/তারিখ ক্যালকুলেটর লজিক (আপডেটেড) ---
                const yearCalcDateInput = document.getElementById('yearCalcDateInput');
                const calcYearsInput = document.getElementById('calcYears');
                const calcMonthsInput = document.getElementById('calcMonths');
                const calcDaysInput = document.getElementById('calcDays');
                const calcHoursInput = document.getElementById('calcHours');
                const calcMinutesInput = document.getElementById('calcMinutes');
                
                const calculateYearsBtn = document.getElementById('calculateYearsBtn');
                const yearCalcResult = document.getElementById('yearCalcResult');

                if (calculateYearsBtn) {
                    calculateYearsBtn.addEventListener('click', () => {
                        console.log('তারিখ ক্যালকুলেটর বোতামে ক্লিক করা হয়েছে।');
                        calculateAndDisplayDateDiff();
                    });
                }

                function calculateAndDisplayDateDiff() {
                    const startDateValue = yearCalcDateInput.value;
                    
                    const years = parseInt(calcYearsInput.value) || 0;
                    const months = parseInt(calcMonthsInput.value) || 0;
                    const days = parseInt(calcDaysInput.value) || 0;
                    const hours = parseInt(calcHoursInput.value) || 0;
                    const minutes = parseInt(calcMinutesInput.value) || 0;

                    yearCalcResult.innerHTML = '';

                    if (years === 0 && months === 0 && days === 0 && hours === 0 && minutes === 0) {
                        yearCalcResult.innerHTML = '<p class="error-message">অনুগ্রহ করে অন্তত একটি মান (বছর, মাস, দিন ইত্যাদি) লিখুন।</p>';
                        return;
                    }

                    const startDate = startDateValue ? new Date(startDateValue) : new Date();

                    if (isNaN(startDate.getTime())) {
                        yearCalcResult.innerHTML = '<p class="error-message">অনুগ্রহ করে একটি সঠিক তারিখ নির্বাচন করুন।</p>';
                        return;
                    }

                    const toBangla = (n) => n.toLocaleString('bn-BD');

                    // ভবিষ্যতের তারিখ গণনা
                    const futureDate = new Date(startDate);
                    futureDate.setFullYear(futureDate.getFullYear() + years);
                    futureDate.setMonth(futureDate.getMonth() + months);
                    futureDate.setDate(futureDate.getDate() + days);
                    futureDate.setHours(futureDate.getHours() + hours);
                    futureDate.setMinutes(futureDate.getMinutes() + minutes);

                    // অতীতের তারিখ গণনা
                    const pastDate = new Date(startDate);
                    pastDate.setFullYear(pastDate.getFullYear() - years);
                    pastDate.setMonth(pastDate.getMonth() - months);
                    pastDate.setDate(pastDate.getDate() - days);
                    pastDate.setHours(pastDate.getHours() - hours);
                    pastDate.setMinutes(pastDate.getMinutes() - minutes);

                    const options = { 
                        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
                        hour: '2-digit', minute: '2-digit', hour12: true 
                    };
                    const dateFormatter = new Intl.DateTimeFormat('bn-BD', options);

                    let descParts = [];
                    if(years) descParts.push(`${toBangla(years)} বছর`);
                    if(months) descParts.push(`${toBangla(months)} মাস`);
                    if(days) descParts.push(`${toBangla(days)} দিন`);
                    if(hours) descParts.push(`${toBangla(hours)} ঘণ্টা`);
                    if(minutes) descParts.push(`${toBangla(minutes)} মিনিট`);
                    const desc = descParts.join(', ');

                    yearCalcResult.innerHTML = `
                        <div class="result-item mb-3 p-3 bg-green-50 dark:bg-green-900/30 rounded-lg border border-green-200 dark:border-green-700">
                            <h3 class="text-green-700 dark:text-green-300 font-bold mb-1 text-lg">${desc} পরে হবে:</h3>
                            <p class="text-xl font-semibold future-date">${dateFormatter.format(futureDate)}</p>
                        </div>
                        <div class="result-item p-3 bg-red-50 dark:bg-red-900/30 rounded-lg border border-red-200 dark:border-red-700">
                            <h3 class="text-red-700 dark:text-red-300 font-bold mb-1 text-lg">${desc} আগে ছিল:</h3>
                            <p class="text-xl font-semibold past-date">${dateFormatter.format(pastDate)}</p>
                        </div>
                    `;
                }
// ====================================================================
// END:  বয়স ক্যালকুলেটর লজিক
// ====================================================================

// ====================================================================
// START:  তারিখ ও সময় ক্যালকুলেটর লজিক
// ====================================================================
                
                const showTodayDatesBtn = document.getElementById('showTodayDatesBtn');
                const showTomorrowDatesBtn = document.getElementById('showTomorrowDatesBtn');

                const todayResultSection = document.getElementById('todayResultSection');
                const tomorrowResultSection = document.getElementById('tomorrowResultSection');

                const todayGregorianDateDisplay = document.getElementById('todayGregorianDateDisplay');
                const todayBengaliDateDisplay = document.getElementById('todayBengaliDateDisplay');
                const todayHijriDateDisplay = document.getElementById('todayHijriDateDisplay');
                const todayDayDisplay = document.getElementById('todayDayDisplay'); // আজকের দিনের জন্য নতুন উপাদান
                const todayTimeDisplay = document.getElementById('todayTimeDisplay');

                const tomorrowGregorianDateDisplay = document.getElementById('tomorrowGregorianDateDisplay');
                const tomorrowBengaliDateDisplay = document.getElementById('tomorrowBengaliDateDisplay');
                const tomorrowHijriDateDisplay = document.getElementById('tomorrowHijriDateDisplay');
                const tomorrowDayDisplay = document.getElementById('tomorrowDayDisplay'); // আগামীকালের দিনের জন্য নতুন উপাদান
                const tomorrowTimeDisplay = document.getElementById('tomorrowTimeDisplay');

                // নতুন তারিখ কনভার্টার DOM উপাদান
                const englishDateInput = document.getElementById('englishDateInput');
                const convertEnglishToBengaliBtn = document.getElementById('convertEnglishToBengaliBtn');
                const convertedBengaliDate = document.getElementById('convertedBengaliDate');
                const convertedDayDisplay = document.getElementById('convertedDayDisplay'); // রূপান্তরিত দিনের জন্য নতুন উপাদান


                if (showTodayDatesBtn) {
                    showTodayDatesBtn.addEventListener('click', () => {
                        console.log('আজকের তারিখ দেখান বোতামে ক্লিক করা হয়েছে।');
                        displayDates('today');
                    });
                }
                if (showTomorrowDatesBtn) {
                    showTomorrowDatesBtn.addEventListener('click', () => {
                        console.log('আগামীকালের তারিখ দেখান বোতামে ক্লিক করা হয়েছে।');
                        displayDates('tomorrow');
                    });
                }

                function displayDates(period) {
                    console.log(`তারিখগুলি প্রদর্শন করা হচ্ছে: ${period}`);
                    // প্রথমে উভয় বিভাগ পরিষ্কার করুন
                    if (todayResultSection) todayResultSection.style.display = 'none';
                    if (tomorrowResultSection) tomorrowResultSection.style.display = 'none';

                    // পূর্ববর্তী কন্টেন্ট পরিষ্কার করুন
                    if (todayGregorianDateDisplay) todayGregorianDateDisplay.innerHTML = '';
                    if (todayBengaliDateDisplay) todayBengaliDateDisplay.innerHTML = '';
                    if (todayHijriDateDisplay) todayHijriDateDisplay.innerHTML = '';
                    if (todayDayDisplay) todayDayDisplay.innerHTML = ''; // দিনের ডিসপ্লে পরিষ্কার করুন
                    if (todayTimeDisplay) todayTimeDisplay.innerHTML = '';

                    if (tomorrowGregorianDateDisplay) tomorrowGregorianDateDisplay.innerHTML = '';
                    if (tomorrowBengaliDateDisplay) tomorrowBengaliDateDisplay.innerHTML = '';
                    if (tomorrowHijriDateDisplay) tomorrowHijriDateDisplay.innerHTML = '';
                    if (tomorrowDayDisplay) tomorrowDayDisplay.innerHTML = ''; // দিনের ডিসপ্লে পরিষ্কার করুন
                    if (tomorrowTimeDisplay) tomorrowTimeDisplay.innerHTML = '';

                    let dateToDisplay = new Date(); // ডিফল্ট হিসাবে আজ
                    if (period === 'tomorrow') {
                        dateToDisplay.setDate(dateToDisplay.getDate() + 1); // আগামীকালের তারিখের জন্য
                    }

                    // --- তারিখ গণনা ---
                    // গ্রেগরিয়ান তারিখ
                    const gregorianDateFormatted = dateToDisplay.toLocaleDateString('bn-BD', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    const dayOfWeek = dateToDisplay.toLocaleDateString('bn-BD', {
                        weekday: 'long'
                    }); // সপ্তাহের দিন পান

                    // বাংলা তারিখ
                    const bengaliDateInfo = getBengaliDate(dateToDisplay);
                    const bengaliDateFormatted = bengaliDateInfo.formatted;
                    const bengaliSeason = getBengaliSeason(bengaliDateInfo.monthIndex); // *** নতুন: ঋতু আনা হয়েছে ***

                    // হিজরি তারিখ (সেটিংস থেকে অ্যাডজাস্টমেন্ট সহ)
                    let hijriCalculationDate = new Date(dateToDisplay);
                    
                    // পরিবর্তন: এখন গ্লোবাল ফাংশন থেকে ভ্যালু নেওয়া হচ্ছে
                    const hijriAdjustment = getGlobalHijriAdjustment();
                    
                    hijriCalculationDate.setDate(hijriCalculationDate.getDate() + hijriAdjustment);

                    const hijriDateFormatter = new Intl.DateTimeFormat('ar-SA', {
                        calendar: 'islamic',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        timeZone: 'Asia/Dhaka'
                    });
                    const hijriParts = hijriDateFormatter.formatToParts(hijriCalculationDate);

                    let hijriDay = '';
                    let hijriMonthArabic = '';
                    let hijriYear = '';

                    for (const part of hijriParts) {
                        if (part.type === 'day') {
                            hijriDay = arabicToBengaliNumbers(part.value);
                        } else if (part.type === 'month') {
                            hijriMonthArabic = part.value;
                        } else if (part.type === 'year') {
                            hijriYear = arabicToBengaliNumbers(part.value);
                        }
                    }
                    const hijriMonthBengali = hijriMonthArabicToBengali[hijriMonthArabic] || hijriMonthArabic;
                    const hijriDateFormatted = `${hijriDay} ${hijriMonthBengali} ${hijriYear} হিজরি`;

                    // সময়
                    const timeFormatted = dateToDisplay.toLocaleTimeString('bn-BD', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true,
                        timeZone: 'Asia/Dhaka' // বাংলাদেশের সময়ের জন্য স্পষ্টভাবে সেট করুন
                    });

                    // 26 বা তার বেশি তারিখের জন্য হাইলাইট লজিক
                    let gregorianHighlightClass = '';
                    if (dateToDisplay.getDate() >= 26) {
                        gregorianHighlightClass = 'text-red-800'; // গাঢ় লাল
                    }

                    let bengaliHighlightClass = '';
                    if (bengaliDateInfo.day >= 26) {
                        bengaliHighlightClass = 'text-red-800'; // গাঢ় লাল
                    }

                    let hijriHighlightClass = '';
                    // তুলনার জন্য hijriDay কে সংখ্যায় রূপান্তর করুন
                    if (parseInt(hijriDay) >= 26) {
                        hijriHighlightClass = 'text-red-800'; // গাঢ় লাল
                    }


                    if (period === 'today') {
                        if (todayResultSection) todayResultSection.style.display = 'block';
                        if (todayGregorianDateDisplay) todayGregorianDateDisplay.innerHTML = `<strong>খ্রিষ্টাব্দ:</strong> <span class="${gregorianHighlightClass}">${gregorianDateFormatted}</span>`;
                        if (todayBengaliDateDisplay) todayBengaliDateDisplay.innerHTML = `<strong>বাংলা তারিখ:</strong> <span class="${bengaliHighlightClass}">${bengaliDateFormatted.replace('বঙ্গাব্দ', '')}, ${bengaliSeason}</span>`; // *** পরিবর্তিত: ঋতু যোগ করা হয়েছে ***
                        if (todayHijriDateDisplay) todayHijriDateDisplay.innerHTML = `<strong>হিজরি:</strong> <span class="${hijriHighlightClass}">${hijriDateFormatted}</span>`;
                        if (todayDayDisplay) todayDayDisplay.innerHTML = `<strong>বার:</strong> ${dayOfWeek}`; // দিন প্রদর্শন করুন
                        if (todayTimeDisplay) todayTimeDisplay.innerHTML = `<strong>সময়:</strong> ${timeFormatted}`;
                    } else if (period === 'tomorrow') {
                        if (tomorrowResultSection) tomorrowResultSection.style.display = 'block';
                        if (tomorrowGregorianDateDisplay) tomorrowGregorianDateDisplay.innerHTML = `<strong>খ্রিষ্টাব্দ:</strong> <span class="${gregorianHighlightClass}">${gregorianDateFormatted}</span>`;
                        if (tomorrowBengaliDateDisplay) tomorrowBengaliDateDisplay.innerHTML = `<strong>বাংলা তারিখ:</strong> <span class="${bengaliHighlightClass}">${bengaliDateFormatted.replace('বঙ্গাব্দ', '')}, ${bengaliSeason}</span>`; // *** পরিবর্তিত: ঋতু যোগ করা হয়েছে ***
                        if (tomorrowHijriDateDisplay) tomorrowHijriDateDisplay.innerHTML = `<strong>হিজরি:</strong> <span class="${hijriHighlightClass}">${hijriDateFormatted}</span>`;
                        if (tomorrowDayDisplay) tomorrowDayDisplay.innerHTML = `<strong>বার:</strong> ${dayOfWeek}`; // দিন প্রদর্শন করুন
                        if (tomorrowTimeDisplay) tomorrowTimeDisplay.innerHTML = `<strong>সময়:</strong> ${timeFormatted}`;
                    }
                }

// ইংরেজি থেকে বাংলা ও হিজরি তারিখ রূপান্তর লজিক
                if (convertEnglishToBengaliBtn) {
                    convertEnglishToBengaliBtn.addEventListener('click', () => {
                        console.log('ইংরেজি থেকে বাংলা ও হিজরি রূপান্তর বোতামে ক্লিক করা হয়েছে।');
                        const englishDateValue = englishDateInput ? englishDateInput.value : '';
                        const convertedHijriDate = document.getElementById('convertedHijriDate'); // হিজরি ডিসপ্লে এলিমেন্ট

                        if (!englishDateValue) {
                            if (convertedBengaliDate) convertedBengaliDate.innerText = 'অনুগ্রহ করে একটি ইংরেজি তারিখ নির্বাচন করুন।';
                            if (convertedHijriDate) convertedHijriDate.innerText = '';
                            if (convertedDayDisplay) convertedDayDisplay.innerText = '';
                            return;
                        }

                        const gregorianDate = new Date(englishDateValue);
                        if (isNaN(gregorianDate.getTime())) {
                            if (convertedBengaliDate) convertedBengaliDate.innerText = 'অবৈধ তারিখ ফরম্যাট।';
                            return;
                        }

                        // ১. বাংলা তারিখ বের করা
                        const bengaliDateInfo = getBengaliDate(gregorianDate);
                        const bengaliSeason = getBengaliSeason(bengaliDateInfo.monthIndex);
                        const dayOfWeek = gregorianDate.toLocaleDateString('bn-BD', { weekday: 'long' });

                        // ২. হিজরি তারিখ বের করা (সেটিংস থেকে অ্যাডজাস্টমেন্ট সহ)
                        let hijriCalculationDate = new Date(gregorianDate);
                        
                        // পরিবর্তন: এখন গ্লোবাল ফাংশন থেকে ভ্যালু নেওয়া হচ্ছে
                        const hijriAdjustment = getGlobalHijriAdjustment();
                        
                        hijriCalculationDate.setDate(hijriCalculationDate.getDate() + hijriAdjustment);

                        const hijriDateFormatter = new Intl.DateTimeFormat('ar-SA', {
                            calendar: 'islamic',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            timeZone: 'Asia/Dhaka'
                        });
                        const hijriParts = hijriDateFormatter.formatToParts(hijriCalculationDate);

                        let hijriDay = '', hijriMonthArabic = '', hijriYear = '';
                        for (const part of hijriParts) {
                            if (part.type === 'day') hijriDay = arabicToBengaliNumbers(part.value);
                            else if (part.type === 'month') hijriMonthArabic = part.value;
                            else if (part.type === 'year') hijriYear = arabicToBengaliNumbers(part.value);
                        }
                        const hijriMonthBengali = hijriMonthArabicToBengali[hijriMonthArabic] || hijriMonthArabic;
                        const hijriDateFormatted = `${hijriDay} ${hijriMonthBengali} ${hijriYear} হিজরি`;

                        // ৩. ফলাফল প্রদর্শন
                        if (convertedBengaliDate) convertedBengaliDate.innerHTML = `<strong>বাংলা:</strong> ${bengaliDateInfo.formatted.replace('বঙ্গাব্দ', '')}, ${bengaliSeason}`;
                        if (convertedHijriDate) convertedHijriDate.innerHTML = `<strong>হিজরি:</strong> ${hijriDateFormatted}`;
                        if (convertedDayDisplay) convertedDayDisplay.innerHTML = `<strong>বার:</strong> ${dayOfWeek}`;
                    });
                }

// --- নতুন: বাংলা থেকে ইংরেজি তারিখ রূপান্তর লজিক ---
    const bengaliYearInput = document.getElementById('bengaliYearInput');
    const bengaliMonthInput = document.getElementById('bengaliMonthInput');
    const bengaliDayInput = document.getElementById('bengaliDayInput');
    const convertBengaliToEnglishBtn = document.getElementById('convertBengaliToEnglishBtn');
    const convertedEnglishDate = document.getElementById('convertedEnglishDate');
    const convertedEnglishDayDisplay = document.getElementById('convertedEnglishDayDisplay');

    if (convertBengaliToEnglishBtn) {
        
        // হেল্পার ফাংশন
        const toBengaliNumber = (num) => {
            const numbers = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];
            return num.toString().split('').map(digit => {
                if (!isNaN(parseInt(digit))) {
                    return numbers[parseInt(digit)];
                }
                return digit;
            }).join('');
        };

        convertBengaliToEnglishBtn.addEventListener('click', () => {
            console.log('বাংলা থেকে ইংরেজি রূপান্তর বোতামে ক্লিক করা হয়েছে।');
            
            const bengaliYear = parseInt(bengaliYearInput.value, 10);
            const bengaliMonthIndex = parseInt(bengaliMonthInput.value, 10);
            const bengaliDay = parseInt(bengaliDayInput.value, 10);

            if (isNaN(bengaliYear) || isNaN(bengaliMonthIndex) || isNaN(bengaliDay) || bengaliDay < 1) {
                convertedEnglishDate.innerText = 'অনুগ্রহ করে সঠিক বাংলা সন, মাস ও দিন লিখুন।';
                convertedEnglishDayDisplay.innerText = '';
                return;
            }

// বাংলা মাসের দিন সংখ্যা (বাংলাদেশ সরকার কর্তৃক ২০১৯ সালের সংশোধিত ক্যালেন্ডার অনুযায়ী)
            // বৈশাখ থেকে আশ্বিন (প্রথম ৬ মাস) ৩১ দিন, ফাল্গুন ২৯ দিন (লিপ ইয়ারে ৩০), বাকি সব ৩০ দিন
            const bengaliMonthLengths = [31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 29, 30];

            // অধিবর্ষ পরীক্ষা
            // ফাল্গুন মাস যেহেতু ইংরেজি ক্যালেন্ডারের পরের বছরে পড়ে (যেমন: ১৪৩০ সালের ফাল্গুন ২০২৪ সালে),
            // তাই লিপ ইয়ার চেক করার জন্য বাংলা সালের সাথে ৫৯৪ যোগ করতে হবে (৫৯৩ এর পরিবর্তে)
            const gregorianYearForLeapCheck = bengaliYear + 594; 
            const isGregorianLeapYear = (gregorianYearForLeapCheck % 4 === 0 && gregorianYearForLeapCheck % 100 !== 0) || gregorianYearForLeapCheck % 400 === 0;

            if (isGregorianLeapYear) {
                bengaliMonthLengths[10] = 30; // অধিবর্ষে ফাল্গুন ৩০ দিন (স্বাভাবিকভাবে ২৯)
            }

            // তারিখটি বৈধ কিনা তা পরীক্ষা করুন
            if (bengaliDay > bengaliMonthLengths[bengaliMonthIndex]) {
                const monthName = bengaliMonthInput.options[bengaliMonthIndex].text;
                convertedEnglishDate.innerText = `অবৈধ তারিখ। ${monthName} মাস ${toBengaliNumber(bengaliMonthLengths[bengaliMonthIndex])} দিনের বেশি হতে পারে না।`;
                convertedEnglishDayDisplay.innerText = '';
                return;
            }

            // গণনা শুরু
            // বাংলা বছরের শুরু (পহেলা বৈশাখ) গ্রেগরিয়ান তারিখে - ১৪ এপ্রিল (ফিক্সড)
            const startOfBengaliYearGregorian = new Date(bengaliYear + 593, 3, 14); // এপ্রিল ১৪

            let daysPassed = 0;
            // নির্বাচিত মাসের আগ পর্যন্ত দিন যোগ করুন
            for (let i = 0; i < bengaliMonthIndex; i++) {
                daysPassed += bengaliMonthLengths[i];
            }
            // বর্তমান মাসের দিন যোগ করুন
            // এখানে (bengaliDay - 1) রাখা হয়েছে কারণ আমরা ১৪ এপ্রিল (১ম দিন) থেকে শুরু করছি।
            // ১লা বৈশাখের জন্য (১-১) = ০ দিন যোগ হবে।
            daysPassed += (bengaliDay - 1);

            // চূড়ান্ত গ্রেগরিয়ান তারিখ গণনা করুন
            const targetGregorianDate = new Date(startOfBengaliYearGregorian.getTime());
            targetGregorianDate.setDate(targetGregorianDate.getDate() + daysPassed);

            // *** সেটিংসের অ্যাডজাস্টমেন্টের সাথে সমন্বয় (নতুন সংযোজন) ***
            // ইংরেজি -> বাংলা কনভার্টারে অ্যাডজাস্টমেন্ট যোগ করা হয়, তাই রিভার্সে বিয়োগ করতে হবে।
            const bengaliAdjustment = parseInt(localStorage.getItem('bengaliDateAdjustment') || '0', 10);
            targetGregorianDate.setDate(targetGregorianDate.getDate() - bengaliAdjustment);

            // ফলাফল প্রদর্শন করুন
            const gregorianDateFormatted = targetGregorianDate.toLocaleDateString('bn-BD', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const dayOfWeek = targetGregorianDate.toLocaleDateString('bn-BD', {
                weekday: 'long'
            });

            convertedEnglishDate.innerHTML = `<strong>ইংরেজি তারিখ:</strong> ${gregorianDateFormatted}`;
            convertedEnglishDayDisplay.innerHTML = `<strong>বার:</strong> ${dayOfWeek}`;
        });
    }

// --- নতুন: হিজরি থেকে ইংরেজি তারিখ রূপান্তর লজিক ---
    const hijriYearInput = document.getElementById('hijriYearInput');
    const hijriMonthInput = document.getElementById('hijriMonthInput');
    const hijriDayInput = document.getElementById('hijriDayInput');
    const convertHijriToEnglishBtn = document.getElementById('convertHijriToEnglishBtn');
    const convertedEnglishFromHijriDate = document.getElementById('convertedEnglishFromHijriDate');
    const convertedEnglishFromHijriDayDisplay = document.getElementById('convertedEnglishFromHijriDayDisplay');

    // হিজরি থেকে গ্রেগরিয়ান কনভার্সন ফাংশন (কুয়েতি অ্যালগরিদম ভিত্তিক বা সাধারণ গাণিতিক)
    function hijriToGregorian(hYear, hMonth, hDay) {
        var jd = Math.floor((11 * hYear + 3) / 30) + 354 * hYear + 30 * hMonth - Math.floor((hMonth - 1) / 2) + hDay + 1948440 - 385;
        var l = jd + 68569;
        var n = Math.floor((4 * l) / 146097);
        l = l - Math.floor((146097 * n + 3) / 4);
        var i = Math.floor((4000 * (l + 1)) / 1461001);
        l = l - Math.floor((1461 * i) / 4) + 31;
        var j = Math.floor((80 * l) / 2447);
        var d = l - Math.floor((2447 * j) / 80);
        l = Math.floor(j / 11);
        var m = j + 2 - 12 * l;
        var y = 100 * (n - 49) + i + l;
        return new Date(y, m - 1, d);
    }

    if (convertHijriToEnglishBtn) {
        convertHijriToEnglishBtn.addEventListener('click', () => {
            console.log('হিজরি থেকে ইংরেজি রূপান্তর বোতামে ক্লিক করা হয়েছে।');
            
            const hYear = parseInt(hijriYearInput.value, 10);
            const hMonth = parseInt(hijriMonthInput.value, 10);
            const hDay = parseInt(hijriDayInput.value, 10);

            if (isNaN(hYear) || isNaN(hMonth) || isNaN(hDay) || hDay < 1 || hDay > 30) {
                convertedEnglishFromHijriDate.innerText = 'অনুগ্রহ করে সঠিক হিজরি সন, মাস ও দিন লিখুন।';
                convertedEnglishFromHijriDayDisplay.innerText = '';
                return;
            }

            const gregDate = hijriToGregorian(hYear, hMonth, hDay);
            
            // *** সেটিংসের অ্যাডজাস্টমেন্টের সাথে সমন্বয় ***
            // পরিবর্তন: এখন গ্লোবাল ফাংশন থেকে ভ্যালু নেওয়া হচ্ছে
            const hijriAdjustment = getGlobalHijriAdjustment();
            
            // হিজরি -> ইংরেজি কনভার্সনের জন্য ডাইনামিক অ্যাডজাস্টমেন্ট লজিক:
            // যদি hijriAdjustment = -2 হয়, তাহলে (-2 + 1) = -1 (১ দিন কমবে)।
            // যদি hijriAdjustment = -1 হয়, তাহলে (-1 + 1) = 0 (অপরিবর্তিত থাকবে)।
            
            gregDate.setDate(gregDate.getDate() + (hijriAdjustment + 2));

            const gregorianDateFormatted = gregDate.toLocaleDateString('bn-BD', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const dayOfWeek = gregDate.toLocaleDateString('bn-BD', {
                weekday: 'long'
            });

            convertedEnglishFromHijriDate.innerHTML = `<strong>ইংরেজি তারিখ:</strong> ${gregorianDateFormatted}`;
            convertedEnglishFromHijriDayDisplay.innerHTML = `<strong>বার:</strong> ${dayOfWeek}`;
        });
    }
	   // --- নতুন: সময়ের ব্যবধান ক্যালকুলেটর লজিক (NEW) ---
    const calcTimeDiffBtn = document.getElementById('calcTimeDiffBtn');
    const timeDiffResultArea = document.getElementById('timeDiffResult');
    const diffOutputContent = document.getElementById('diffOutputContent');

    if (calcTimeDiffBtn) {
        // সংখ্যা বাংলায় রূপান্তর করার হেল্পার
        const toBanglaNum = (n) => n.toString().replace(/\d/g, d => "০১২৩৪৫৬৭৮৯"[d]);

        calcTimeDiffBtn.addEventListener('click', () => {
            const startDateVal = document.getElementById('diffStartDate').value;
            const startTimeVal = document.getElementById('diffStartTime').value;
            const endDateVal = document.getElementById('diffEndDate').value;
            const endTimeVal = document.getElementById('diffEndTime').value;

            // ইনপুট ভ্যালিডেশন: সময় অটোমেটিক ১২ ঘণ্টা থেকে ২৪ ঘণ্টায় কনভার্ট হবে ব্রাউজারের ইনপুট টাইপ 'time' এর কারণে।
            // ব্যবহারকারী যদি ম্যানুয়ালি ২৪ ঘণ্টা ইনপুট দেয়, তাও ঠিক আছে।

            // শুধু সময়ের ব্যবধান (তারিখ ছাড়া)
            if (!startDateVal && !endDateVal) {
                if (!startTimeVal || !endTimeVal) {
                    showCustomAlert('অনুগ্রহ করে অন্তত দুটি সময় নির্বাচন করুন।');
                    return;
                }
                
                const today = new Date().toISOString().split('T')[0];
                let startObj = new Date(`${today}T${startTimeVal}`);
                let endObj = new Date(`${today}T${endTimeVal}`);

                if (endObj < startObj) {
                    endObj.setDate(endObj.getDate() + 1); // পরের দিন ধরে নেওয়া
                }

                const diffMs = endObj - startObj;
                const hours = Math.floor(diffMs / 3600000);
                const minutes = Math.floor((diffMs % 3600000) / 60000);
                const seconds = Math.floor((diffMs % 60000) / 1000);

                timeDiffResultArea.classList.remove('hidden');
                diffOutputContent.innerHTML = `<p class="text-lg">⏲️ সময়ের ব্যবধান: <strong>${toBanglaNum(hours)} ঘণ্টা, ${toBanglaNum(minutes)} মিনিট, ${toBanglaNum(seconds)} সেকেন্ড</strong></p>`;
                return;
            }

            // তারিখ ও সময়ের ব্যবধান (বছর, মাস সহ)
            if (!startDateVal || !endDateVal) {
                showCustomAlert('পুরো হিসাবের জন্য শুরুর এবং শেষের তারিখ নির্বাচন করুন।');
                return;
            }

            let startObj = new Date(`${startDateVal}T${startTimeVal || '00:00'}`);
            let endObj = new Date(`${endDateVal}T${endTimeVal || '00:00'}`);

            if (endObj < startObj) {
                [startObj, endObj] = [endObj, startObj]; // Swap
            }

            // ১. মোট ব্যবধান
            const totalDiffMs = endObj - startObj;
            const totalSeconds = Math.floor(totalDiffMs / 1000);
            const totalMinutes = Math.floor(totalSeconds / 60);
            const totalHours = Math.floor(totalMinutes / 60);
            const totalDays = Math.floor(totalHours / 24);

            // ২. বছর, মাস, দিন ক্যালকুলেশন
            let y = endObj.getFullYear() - startObj.getFullYear();
            let m = endObj.getMonth() - startObj.getMonth();
            let d = endObj.getDate() - startObj.getDate();
            
            let h = endObj.getHours() - startObj.getHours();
            let min = endObj.getMinutes() - startObj.getMinutes();
            let sec = endObj.getSeconds() - startObj.getSeconds();

            if (sec < 0) { sec += 60; min--; }
            if (min < 0) { min += 60; h--; }
            if (h < 0) { h += 24; d--; }

            if (d < 0) {
                m--;
                const prevMonthDate = new Date(endObj.getFullYear(), endObj.getMonth(), 0);
                d += prevMonthDate.getDate();
            }
            if (m < 0) {
                y--;
                m += 12;
            }

            // আউটপুট তৈরি
            timeDiffResultArea.classList.remove('hidden');
            diffOutputContent.innerHTML = `
                <div class="mb-4">
                    <p class="font-bold text-lg text-blue-600 dark:text-blue-400">বিস্তারিত হিসাব:</p>
                    <p class="text-xl">📅 ${toBanglaNum(y)} বছর, ${toBanglaNum(m)} মাস, ${toBanglaNum(d)} দিন</p>
                    <p class="text-lg">⏰ ${toBanglaNum(h)} ঘণ্টা, ${toBanglaNum(min)} মিনিট, ${toBanglaNum(sec)} সেকেন্ড</p>
                </div>
                <div class="border-t border-gray-300 dark:border-gray-600 pt-2">
                    <p class="font-bold text-sm text-gray-500 dark:text-gray-400">মোট হিসাব (বিকল্প):</p>
                    <ul class="list-disc list-inside text-sm">
                        <li>মোট দিন: ${toBanglaNum(totalDays)}</li>
                        <li>মোট ঘণ্টা: ${toBanglaNum(totalHours)}</li>
                        <li>মোট মিনিট: ${toBanglaNum(totalMinutes)}</li>
                        <li>মোট সেকেন্ড: ${toBanglaNum(totalSeconds)}</li>
                    </ul>
                </div>
            `;
        });
    }
// ====================================================================
// END:  তারিখ ও সময় ক্যালকুলেটর লজিক
// ====================================================================

// ====================================================================
// START:  বৈজ্ঞানিক ক্যালকুলেটর লজিক (আপডেটেড: কার্সর পজিশন ফিক্স v2)
// ====================================================================
                
                const scientificExpressionInput = document.getElementById('scientificExpressionInput');
                const scientificHistoryDisplay = document.getElementById('scientificHistoryDisplay');
                const scientificButtons = document.querySelectorAll('.scientific-buttons-grid button');
                const scientificErrorMessage = document.getElementById('scientificErrorMessage');
                const explainScientificBtn = document.getElementById('explainScientificBtn');
                const scientificExplanation = document.getElementById('scientificExplanation');
                const scientificExplanationLoading = document.getElementById('scientificExplanationLoading');

                const functionsWithParentheses = ['sin', 'cos', 'tan', 'log', 'ln', 'sqrt'];

                // কার্সরের সর্বশেষ অবস্থান মনে রাখার ভেরিয়েবল
                let lastSciCursorPos = 0;

                // ইনপুট ফিল্ডে অ্যাক্টিভিটি ট্র্যাক করা (blur বাদ দেওয়া হয়েছে)
                if (scientificExpressionInput) {
                    ['click', 'keyup', 'input', 'focus', 'mouseup'].forEach(evt => {
                        scientificExpressionInput.addEventListener(evt, () => {
                            if (scientificExpressionInput.selectionStart !== null) {
                                lastSciCursorPos = scientificExpressionInput.selectionStart;
                            }
                        });
                    });
                }

                // স্মার্ট ফোকাস ফাংশন
                function smartFocus(input) {
                    const isTouchDevice = window.matchMedia("(pointer: coarse)").matches; 
                    if (!isTouchDevice) {
                        input.focus();
                    }
                }

                // হেল্পার ফাংশন: কার্সরের স্থানে টেক্সট ইনসার্ট করা
                function insertAtCursor(input, textToInsert) {
                    const text = input.value;
                    
                    // ফোকাস থাকলে লাইভ পজিশন নিন, নাহলে সেভ করা পজিশন ব্যবহার করুন
                    let start = (document.activeElement === input) ? input.selectionStart : lastSciCursorPos;
                    
                    // বাউন্ডারি চেক
                    if (start === null || start > text.length) {
                        start = text.length;
                    }

                    const end = (document.activeElement === input) ? input.selectionEnd : start;

                    const newValue = text.substring(0, start) + textToInsert + text.substring(end);
                    input.value = newValue;
                    
                    // নতুন কার্সর পজিশন আপডেট করুন
                    const newCursorPos = start + textToInsert.length;
                    lastSciCursorPos = newCursorPos;
                    input.selectionStart = newCursorPos;
                    input.selectionEnd = newCursorPos;
                    
                    smartFocus(input);
                }

                // এক্সপ্রেশন ইনপুটে বোতামের মান যোগ করুন
                scientificButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault(); 

                        const value = button.dataset.sciInput;
                        const inputElement = scientificExpressionInput;

                        if (!inputElement) return;

                        // C বাটন (All Clear)
                        if (value === 'C') {
                            inputElement.value = '';
                            lastSciCursorPos = 0; // পজিশন রিসেট
                            if (scientificHistoryDisplay) scientificHistoryDisplay.innerText = '';
                            if (scientificErrorMessage) scientificErrorMessage.innerText = '';
                            if (scientificExplanation) scientificExplanation.innerText = '';
                            smartFocus(inputElement);
                        } 
                        // DEL বাটন
                        else if (value === 'DEL') {
                            const text = inputElement.value;
                            let start = (document.activeElement === inputElement) ? inputElement.selectionStart : lastSciCursorPos;
                            let end = (document.activeElement === inputElement) ? inputElement.selectionEnd : start;

                            if (start > text.length) start = text.length;

                            // যদি কোনো টেক্সট সিলেক্ট করা না থাকে, তবে কার্সরের পেছনের একটা অক্ষর মুছবে
                            if (start === end) {
                                if (start > 0) {
                                    inputElement.value = text.substring(0, start - 1) + text.substring(end);
                                    const newCursorPos = start - 1;
                                    lastSciCursorPos = newCursorPos;
                                    inputElement.selectionStart = newCursorPos;
                                    inputElement.selectionEnd = newCursorPos;
                                }
                            } else {
                                // সিলেক্ট করা অংশ মুছবে
                                inputElement.value = text.substring(0, start) + text.substring(end);
                                lastSciCursorPos = start;
                                inputElement.selectionStart = start;
                                inputElement.selectionEnd = start;
                            }
                            smartFocus(inputElement);
                        } 
                        else if (button.dataset.sciEquals !== undefined) {
                            evaluateScientificExpression();
                        } 
                        else if (functionsWithParentheses.includes(value)) {
                            // () ফাংশন
                            const textToInsert = value + '()';
                            const text = inputElement.value;
                            let start = (document.activeElement === inputElement) ? inputElement.selectionStart : lastSciCursorPos;
                            
                            // যদি সিলেকশন থাকে, সেটা রিপ্লেস না করে ইনসার্ট করছি (সাধারণ ক্যালকুলেটরের মতো আচরণ)
                            // অথবা আপনি চাইলে রিপ্লেস লজিকও রাখতে পারেন
                            const end = (document.activeElement === inputElement) ? inputElement.selectionEnd : start;

                            inputElement.value = text.substring(0, start) + textToInsert + text.substring(end);
                            
                            // কার্সর ব্র্যাকেটের ভেতরে নেওয়া
                            const cursorPosition = start + value.length + 1;
                            lastSciCursorPos = cursorPosition;
                            inputElement.selectionStart = cursorPosition;
                            inputElement.selectionEnd = cursorPosition;
                            smartFocus(inputElement);
                        } 
                        else if (value) {
                            insertAtCursor(inputElement, value);
                        }
                    });
                });

                // কীবোর্ড ইনপুট সমর্থন (আপডেটেড: Delete বাটন সাপোর্ট যোগ করা হয়েছে)
                if (scientificExpressionInput) {
                    scientificExpressionInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            evaluateScientificExpression();
                        } else if (e.key === 'Escape' || e.key === 'Delete') { // Escape অথবা Delete চাপলে ক্লিয়ার হবে
                            scientificExpressionInput.value = '';
                            lastSciCursorPos = 0;
                            if (scientificHistoryDisplay) scientificHistoryDisplay.innerText = '';
                            if (scientificErrorMessage) scientificErrorMessage.innerText = '';
                            if (scientificExplanation) scientificExplanation.innerText = '';
                        }
                    });
                }

                function evaluateScientificExpression() {
                    const inputElement = scientificExpressionInput;
                    const expression = inputElement ? inputElement.value : '';
                    
                    if (scientificErrorMessage) scientificErrorMessage.innerText = '';
                    if (scientificExplanation) scientificExplanation.innerText = '';

                    if (expression.trim() === '') {
                        return;
                    }

                    try {
                        let processedExpression = expression.replace(/(\d+(?:\.\d+)?)\s*([\+\-])\s*(\d+(?:\.\d+)?)%/g, (match, p1, operator, p3) => {
                            return `${p1}${operator}(${p1}*${p3}/100)`;
                        });

                        processedExpression = processedExpression
                            .replace(/sin\(/g, 'Math.sin(Math.PI / 180 * ')
                            .replace(/cos\(/g, 'Math.cos(Math.PI / 180 * ')
                            .replace(/tan\(/g, 'Math.tan(Math.PI / 180 * ')
                            .replace(/log\(/g, 'Math.log10(')
                            .replace(/ln\(/g, 'Math.log(')
                            .replace(/sqrt\(/g, 'Math.sqrt(')
                            .replace(/\^/g, '**')
                            .replace(/π/g, 'Math.PI')
                            .replace(/e/g, 'Math.E')
                            .replace(/×/g, '*') 
                            .replace(/÷/g, '/')
                            .replace(/%/g, '/100');

                        let result = eval(processedExpression);

                        if (isNaN(result) || !isFinite(result)) {
                            if (scientificErrorMessage) scientificErrorMessage.innerText = 'অবৈধ এক্সপ্রেশন বা ফলাফল।';
                        } else {
                            if (scientificHistoryDisplay) scientificHistoryDisplay.innerText = expression + ' =';
                            const formattedResult = parseFloat(result.toFixed(10));
                            inputElement.value = formattedResult;
                            // রেজাল্ট দেখানোর পর কার্সর শেষে নিয়ে যাওয়া Default: ΝŨťŚŨňŬŚΝǑ ĴũŕũŝţŨŚ ļŴţΝŝŨĵň ũŚťľ: ΝŨťŚŨňŬŚΝǑŊňũŀňŞŨňŊňĴŨĵļ
                            lastSciCursorPos = inputElement.value.length;
                        }
                    } catch (error) {
                        if (scientificErrorMessage) scientificErrorMessage.innerText = 'ত্রুটি!';
                        console.error('বৈজ্ঞানিক ক্যালকুলেটর ত্রুটি:', error);
                    }
                }

                // বৈজ্ঞানিক এক্সপ্রেশন ব্যাখ্যা (জেমিনি API)
                if (explainScientificBtn) {
                    explainScientificBtn.addEventListener('click', async () => {
                        let expressionToExplain = scientificExpressionInput ? scientificExpressionInput.value.trim() : '';
                        
                        if (scientificHistoryDisplay && scientificHistoryDisplay.innerText.includes('=') && !isNaN(expressionToExplain)) {
                             expressionToExplain = scientificHistoryDisplay.innerText.replace('=', '').trim();
                        }

                        if (!expressionToExplain) {
                            if (scientificExplanation) scientificExplanation.innerText = 'ব্যাখ্যার জন্য একটি এক্সপ্রেশন লিখুন।';
                            return;
                        }

                        if (scientificExplanation) scientificExplanation.innerText = '';
                        if (scientificExplanationLoading) scientificExplanationLoading.style.display = 'block';
                        explainScientificBtn.disabled = true;

                        try {
                            const apiKey = localStorage.getItem('geminiApiKey');
                            if (!apiKey) {
                                if (scientificExplanation) scientificExplanation.innerText = 'জেমিনি API কী সেট করা হয়নি।';
                                if (scientificExplanationLoading) scientificExplanationLoading.style.display = 'none';
                                explainScientificBtn.disabled = false;
                                return;
                            }

                            let chatHistory = [];
                            chatHistory.push({
                                role: "user",
                                parts: [{
                                    text: `এই গাণিতিক এক্সপ্রেশনটি সহজ ভাষায় ব্যাখ্যা করুন: "${expressionToExplain}"।`
                                }]
                            });
                            const payload = { contents: chatHistory };
                            const model = localStorage.getItem('geminiModel') || "gemini-flash-latest";
            				const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

                            const response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });

                            const result = await response.json();

                            if (result.candidates && result.candidates.length > 0) {
                                const text = result.candidates[0].content.parts[0].text;
                                if (scientificExplanation) scientificExplanation.innerText = text;
                            } else {
                                if (scientificExplanation) scientificExplanation.innerText = 'কোনো ব্যাখ্যা পাওয়া যায়নি।';
                            }
                        } catch (error) {
                            if (scientificExplanation) scientificExplanation.innerText = 'ত্রুটি: ' + error.message;
                        } finally {
                            if (scientificExplanationLoading) scientificExplanationLoading.style.display = 'none';
                            explainScientificBtn.disabled = false;
                        }
                    });
                }
// ====================================================================
// END:  বৈজ্ঞানিক ক্যালকুলেটর লজিক
// ====================================================================

// ====================================================================
// START: AUTO REPLACE FOR FONT CONVERTER য় ড় ঢ়
// ====================================================================
                if (textAreaLeft) {
                    addState('textAreaLeft');
                    textAreaLeft.addEventListener('input', () => {
                        // অটোমেটিক অক্ষর রিপ্লেসমেন্ট
                        const value = textAreaLeft.value;
                        const selectionStart = textAreaLeft.selectionStart;

                        // রিপ্লেসমেন্টের তালিকা
                        // decomposed form (letter + nukta) থেকে precomposed form-এ পরিবর্তন করা হচ্ছে
                        let newValue = value
                            .replace(/য়/g, 'য়') // U+09AF U+09BC  -> U+09DF
                            .replace(/ড়/g, 'ড়') // U+09A1 U+09BC  -> U+09DC
                            .replace(/ঢ়/g, 'ঢ়'); // U+09A2 U+09BC  -> U+09DD
                        
                        // যদি কোনো পরিবর্তন হয়ে থাকে, তাহলে টেক্সটবক্স আপডেট করুন
                        if (newValue !== value) {
                            textAreaLeft.value = newValue;
                            // টাইপ করার সময় কার্সরের অবস্থান ঠিক রাখার জন্য
                            textAreaLeft.setSelectionRange(selectionStart, selectionStart);
                        }

                        addState('textAreaLeft'); // আপনার বিদ্যমান আনডু/রিডু কার্যকারিতার জন্য
                    });
                }
                if (textAreaRight) {
                    addState('textAreaRight');
                    textAreaRight.addEventListener('input', () => addState('textAreaRight'));
                }
// ====================================================================
// END: AUTO REPLACE FOR FONT CONVERTER য় ড় ঢ়
// ====================================================================

// ====================================================================
// START: BANAN SHONGSHODHON বাংলা বানান সংশোধন লজিক (অর্থসহ উন্নত)
// ==================================================================== 
                const checkSpellingBtn = document.getElementById('checkSpellingBtn');
                const spellCheckInput = document.getElementById('spellCheckInput');
                const spellCheckResult = document.getElementById('spellCheckResult');
                const spellCheckLoading = document.getElementById('spellCheckLoading');
                const clearSpellCheckBtn = document.getElementById('clearSpellCheckBtn'); // Get the clear button

                if (checkSpellingBtn) {
                    checkSpellingBtn.addEventListener('click', async () => {
                        const textToCorrect = spellCheckInput.value.trim();
                        if (!textToCorrect) {
                            spellCheckResult.innerText = 'অনুগ্রহ করে পরীক্ষা করার জন্য কিছু লেখা দিন।';
                            return;
                        }

                        spellCheckResult.innerText = '';
                        spellCheckLoading.style.display = 'block';
                        checkSpellingBtn.disabled = true;

                        try {
                            const apiKey = localStorage.getItem('geminiApiKey');
                            if (!apiKey) {
                                spellCheckResult.innerText = 'জেমিনি API কী সেট করা হয়নি। অনুগ্রহ করে "API কী সেট করুন" বাটনে ক্লিক করে কী সেট করুন।';
                                return;
                            }

                            // উন্নত প্রম্পট যা সংশোধিত শব্দের অর্থ এবং ব্যাখ্যা চাইবে
                            const prompt = `নিচের বাংলা লেখাটির বানান এবং ব্যাকরণগত ভুল সংশোধন করো। তোমার উত্তরটি দুটি অংশে বিভক্ত থাকবে।

প্রথম অংশ: 'সংশোধিত লেখা:' শিরোনাম দিয়ে সম্পূর্ণ সঠিক লেখাটি দাও।
দ্বিতীয় অংশ: 'সংশোধিত শব্দাবলি:' শিরোনাম দিয়ে, তুমি যে শব্দগুলো পরিবর্তন করেছ শুধুমাত্র সেগুলোর একটি তালিকা তৈরি করো। প্রতিটি পরিবর্তিত শব্দের জন্য, মূল ভুল শব্দটি উল্লেখ করো, তারপর সঠিক শব্দটি, তার অর্থ এবং একটি সহজ ব্যাখ্যা দাও।

যদি কোনো ভুল না থাকে, তাহলে শুধু 'লেখাটি সঠিক আছে' লিখে দাও।

মূল লেখা:
"${textToCorrect}"`;

                            let chatHistory = [{
                                role: "user",
                                parts: [{
                                    text: prompt
                                }]
                            }];
                            const payload = {
                                contents: chatHistory
                            };
             // --- গ্লোবাল মডেল ব্যবহার ---
            const model = localStorage.getItem('geminiModel') || "gemini-flash-latest";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

                            const response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(payload)
                            });

                            const result = await response.json();

                            if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                                const correctedText = result.candidates[0].content.parts[0].text;
                                spellCheckResult.innerText = correctedText;
                            } else {
                                spellCheckResult.innerText = 'দুঃখিত, কোনো উত্তর পাওয়া যায়নি। অনুগ্রহ করে আবার চেষ্টা করুন।';
                                console.error('API Response Error:', result);
                            }
                        } catch (error) {
                            spellCheckResult.innerText = 'একটি ত্রুটি ঘটেছে: ' + error.message;
                            console.error('API Call Error:', error);
                        } finally {
                            spellCheckLoading.style.display = 'none';
                            checkSpellingBtn.disabled = false;
                        }
                    });
                }

                // Add event listener for Clear button in Spell Checker
                if (clearSpellCheckBtn) {
                    clearSpellCheckBtn.addEventListener('click', () => {
                        if (spellCheckInput) spellCheckInput.value = '';
                        if (spellCheckResult) spellCheckResult.innerText = '';
                        showCustomAlert('বানান সংশোধনের লেখা পরিষ্কার করা হয়েছে!');
                    });
                }
// ====================================================================
// END: BANAN SHONGSHODHON
// ====================================================================

// ====================================================================
// START: LEKHA SHAJANO SCRIPT
// ====================================================================
                const beautifyTextBtn = document.getElementById('beautifyTextBtn');
                const beautifyInput = document.getElementById('beautifyInput');
                const beautifyResult = document.getElementById('beautifyResult');
                const beautifyLoading = document.getElementById('beautifyLoading');
                const copyBeautifiedTextBtn = document.getElementById('copyBeautifiedTextBtn');
                const clearBeautifyTextBtn = document.getElementById('clearBeautifyTextBtn');

                if (beautifyTextBtn) {
                    beautifyTextBtn.addEventListener('click', async () => {
                        const textToBeautify = beautifyInput.value.trim();
                        if (!textToBeautify) {
                            beautifyResult.innerText = 'অনুগ্রহ করে সাজানোর জন্য কিছু লেখা দিন।';
                            return;
                        }

                        beautifyResult.innerText = '';
                        beautifyLoading.style.display = 'block';
                        beautifyTextBtn.disabled = true;

                        try {
                            const apiKey = localStorage.getItem('geminiApiKey');
                            if (!apiKey) {
                                beautifyResult.innerText = 'জেমিনি API কী সেট করা হয়নি। অনুগ্রহ করে "API কী সেট করুন" বাটনে ক্লিক করে কী সেট করুন।';
                                return;
                            }

                            const prompt = `নিচের বাংলা লেখাটিকে সহজ, সুন্দর, প্রাঞ্জল এবং সাবলীল ভাষায় গুছিয়ে লেখো। কোনো ভূমিকা বা অতিরিক্ত ব্যাখ্যা ছাড়াই শুধুমাত্র সাজানো লেখাটি দাও:\n\n"${textToBeautify}"`;

                            let chatHistory = [{
                                role: "user",
                                parts: [{
                                    text: prompt
                                }]
                            }];
                            const payload = {
                                contents: chatHistory
                            };
           // --- গ্লোবাল মডেল ব্যবহার ---
            const model = localStorage.getItem('geminiModel') || "gemini-flash-latest";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

                            const response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(payload)
                            });

                            const result = await response.json();

                            if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                                const beautifiedText = result.candidates[0].content.parts[0].text;
                                beautifyResult.innerText = beautifiedText;
                            } else {
                                beautifyResult.innerText = 'দুঃখিত, কোনো উত্তর পাওয়া যায়নি। অনুগ্রহ করে আবার চেষ্টা করুন।';
                                console.error('API Response Error:', result);
                            }
                        } catch (error) {
                            beautifyResult.innerText = 'একটি ত্রুটি ঘটেছে: ' + error.message;
                            console.error('API Call Error:', error);
                        } finally {
                            beautifyLoading.style.display = 'none';
                            beautifyTextBtn.disabled = false;
                        }
                    });
                }

                if (copyBeautifiedTextBtn) {
                    copyBeautifiedTextBtn.addEventListener('click', () => {
                        const textToCopy = beautifyResult.innerText;
                        if (textToCopy) {
                            const tempTextArea = document.createElement('textarea');
                            tempTextArea.value = textToCopy;
                            document.body.appendChild(tempTextArea);
                            tempTextArea.select();
                            tempTextArea.setSelectionRange(0, 99999);
                            try {
                                document.execCommand('copy');
                                showCustomAlert('সাজানো লেখা কপি করা হয়েছে!');
                            } catch (err) {
                                console.error('কপি করতে ব্যর্থ:', err);
                                showCustomAlert('কপি করতে ব্যর্থ হয়েছে।');
                            }
                            document.body.removeChild(tempTextArea);
                        }
                    });
                }

                if (clearBeautifyTextBtn) {
                    clearBeautifyTextBtn.addEventListener('click', () => {
                        beautifyInput.value = '';
                        beautifyResult.innerText = '';
                        showCustomAlert('লেখা সাজানোর ইনপুট পরিষ্কার করা হয়েছে!');
                    });
                }
// ====================================================================
// END: LEKHA SHAJANO SCRIPT
// ====================================================================

// ====================================================================
// START: WORD MEANING SCRIPT
// ====================================================================
                const findMeaningBtn = document.getElementById('findMeaningBtn');
                const wordMeaningInput = document.getElementById('wordMeaningInput');
                const wordMeaningResult = document.getElementById('wordMeaningResult');
                const wordMeaningLoading = document.getElementById('wordMeaningLoading');
                const clearWordMeaningBtn = document.getElementById('clearWordMeaningBtn'); // Get the clear button

                if (findMeaningBtn) {
                    findMeaningBtn.addEventListener('click', handleFindMeaning);
                }
                if (wordMeaningInput) {
                    wordMeaningInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            handleFindMeaning();
                        }
                    });
                }

                async function handleFindMeaning() {
                    const wordToFind = wordMeaningInput.value.trim();
                    if (!wordToFind) {
                        wordMeaningResult.innerText = 'অনুগ্রহ করে অর্থ খোঁজার জন্য একটি শব্দ লিখুন।';
                        return;
                    }

                    wordMeaningResult.innerHTML = '';
                    wordMeaningLoading.style.display = 'block';
                    findMeaningBtn.disabled = true;

                    try {
                        const apiKey = localStorage.getItem('geminiApiKey');
                        if (!apiKey) {
                            wordMeaningResult.innerText = 'জেমিনি API কী সেট করা হয়নি। অনুগ্রহ করে "API কী সেট করুন" বাটনে ক্লিক করে কী সেট করুন।';
                            return;
                        }

                        const prompt = `"${wordToFind}" - এই শব্দটির বিস্তারিত অর্থ, প্রতিশব্দ, বিপরীত শব্দ (যদি থাকে), এবং একটি সহজ উদাহরণসহ ব্যাখ্যা দাও। ফলাফলটি সুন্দরভাবে ফরম্যাট করে দাও। ভুল বানান এর ক্ষেত্রে তোমার উত্তরের শুরুতে বানানটি ভুল উল্লেখ করে শব্দটির সঠিক বানানটিও উল্লেখ করো।`;

                        let chatHistory = [{
                            role: "user",
                            parts: [{
                                text: prompt
                            }]
                        }];
                        const payload = {
                            contents: chatHistory
                        };
       // --- গ্লোবাল মডেল ব্যবহার ---
        const model = localStorage.getItem('geminiModel') || "gemini-flash-latest";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });

                        const result = await response.json();

                        if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                            const meaningText = result.candidates[0].content.parts[0].text;
                            wordMeaningResult.innerText = meaningText;
                        } else {
                            wordMeaningResult.innerText = 'দুঃখিত, কোনো উত্তর পাওয়া যায়নি। অনুগ্রহ করে আবার চেষ্টা করুন।';
                            console.error('API Response Error:', result);
                        }
                    } catch (error) {
                        wordMeaningResult.innerText = 'একটি ত্রুটি ঘটেছে: ' + error.message;
                        console.error('API Call Error:', error);
                    } finally {
                        wordMeaningLoading.style.display = 'none';
                        findMeaningBtn.disabled = false;
                    }
                }

                // Add event listener for Clear button in Word Meaning
                if (clearWordMeaningBtn) {
                    clearWordMeaningBtn.addEventListener('click', () => {
                        if (wordMeaningInput) wordMeaningInput.value = '';
                        if (wordMeaningResult) wordMeaningResult.innerHTML = '';
                        showCustomAlert('শব্দের অর্থ পরিষ্কার করা হয়েছে!');
                    });
                }
// ====================================================================
// END: WORD MEANING SCRIPT
// ====================================================================

// ====================================================================
// START: GEMINI API TEXT-TO-SPEECH (TTS) SCRIPT
// ====================================================================

// TTS এর জন্য প্রয়োজনীয় উপাদান নির্বাচন
const ttsInput = document.getElementById('ttsInput');
const speakBtn = document.getElementById('speakBtn');
const pauseBtn = document.getElementById('pauseBtn');
const resumeBtn = document.getElementById('resumeBtn');
const stopBtn = document.getElementById('stopBtn');
const clearTtsBtn = document.getElementById('clearTtsBtn');
const downloadTtsBtn = document.getElementById('downloadTtsBtn');

// ভয়েস এবং পিচ/রেট কন্ট্রোলগুলি এখন জেমিনি দ্বারা নিয়ন্ত্রিত হবে, তাই UI থেকে সরানো হয়েছে
const ttsControls = document.querySelector('.tts-controls');
if (ttsControls) ttsControls.style.display = 'none';

let ttsAudio; // অডিও প্লেয়ার অবজেক্ট
let downloadableAudioBlob = null; // ডাউনলোডের জন্য অডিও ডেটা

// Base64 স্ট্রিং থেকে ArrayBuffer এ রূপান্তর করার হেল্পার ফাংশন
function base64ToArrayBuffer(base64) {
    const binaryString = window.atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
}

// PCM অডিও ডেটা থেকে WAV ফাইল তৈরি করার হেল্পার ফাংশন
function pcmToWav(pcmData, sampleRate) {
    const header = new ArrayBuffer(44);
    const view = new DataView(header);
    const numChannels = 1;
    const bitsPerSample = 16;
    const blockAlign = numChannels * bitsPerSample / 8;
    const byteRate = sampleRate * blockAlign;

    function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    }

    // WAV হেডার তৈরি
    writeString(view, 0, 'RIFF');
    view.setUint32(4, 36 + pcmData.byteLength, true);
    writeString(view, 8, 'WAVE');
    writeString(view, 12, 'fmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true); // PCM ফরম্যাট
    view.setUint16(22, numChannels, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, byteRate, true);
    view.setUint16(32, blockAlign, true);
    view.setUint16(34, bitsPerSample, true);
    writeString(view, 36, 'data');
    view.setUint32(40, pcmData.byteLength, true);

    return new Blob([header, pcmData], { type: 'audio/wav' });
}

// জেমিনি API ব্যবহার করে টেক্সট থেকে অডিও তৈরি করার মূল ফাংশন
async function handleGeminiTTS() {
    const textToSpeak = ttsInput.value.trim();
    if (!textToSpeak) {
        showCustomAlert('অনুগ্রহ করে কথা বলার জন্য কিছু টেক্সট লিখুন।');
        return;
    }

    const apiKey = localStorage.getItem('geminiApiKey');
    if (!apiKey) {
        showCustomAlert('জেমিনি API কী সেট করা হয়নি। অনুগ্রহ করে সেটিংস থেকে API কী সেট করুন।');
        return;
    }

    // আগের অডিও বন্ধ এবং রিসেট করা
    if (ttsAudio) {
        ttsAudio.pause();
        ttsAudio.currentTime = 0;
    }
    downloadableAudioBlob = null;
    if (downloadTtsBtn) downloadTtsBtn.disabled = true;

    speakBtn.disabled = true;
    speakBtn.innerText = 'লোড হচ্ছে...';

    try {
        // --- স্মার্ট মডেল সিলেকশন লজিক (সংশোধিত) ---
        // Google Doc অনুযায়ী: 'native-audio' মডেলগুলো Live API (WebSocket) এর জন্য।
        // সাধারণ HTTP রিকোয়েস্ট (generateContent) এর জন্য 'gemini-2.5-flash-preview-tts' ব্যবহার করতে হবে।
        
        let selectedModel = localStorage.getItem('geminiModel');
        const REST_SUPPORTED_TTS_MODEL = "gemini-2.5-flash-preview-tts"; // এটি নিশ্চিতভাবে কাজ করে
        let modelToUse;
        
        // যদি ইউজার সেটিংসে এমন কোনো মডেল সিলেক্ট করে যা 'native-audio' ধারণ করে, 
        // তবে আমরা জোর করে সঠিক REST সাপোর্টেড মডেলে সুইচ করব।
        if (selectedModel && selectedModel.includes('native-audio')) {
            console.log(`Model fallback: '${selectedModel}' is a Live API model. Switching to '${REST_SUPPORTED_TTS_MODEL}' for REST compatibility.`);
            modelToUse = REST_SUPPORTED_TTS_MODEL;
        } 
        // যদি ইউজার অন্য কোনো ভ্যালিড TTS মডেল সিলেক্ট করে থাকে
        else if (selectedModel && selectedModel.includes('tts')) {
            modelToUse = selectedModel;
        } 
        // ডিফল্ট ফলব্যাক
        else {
            modelToUse = REST_SUPPORTED_TTS_MODEL;
        }

        const payload = {
            contents: [{ parts: [{ text: textToSpeak }] }],
            generationConfig: { 
                responseModalities: ["AUDIO"],
                speechConfig: {
                    voiceConfig: {
                        prebuiltVoiceConfig: {
                            voiceName: "Kore" // ডিফল্ট ভয়েস
                        }
                    }
                }
            }
        };

        // সঠিক এন্ডপয়েন্ট এবং মডেল ব্যবহার করা হচ্ছে
        let apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelToUse}:generateContent?key=${apiKey}`;
        
        let response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        let result = await response.json();

        // এরর হ্যান্ডলিং (বাংলায়)
        if (result.error) {
            console.error('Gemini TTS API Error:', result.error);
            const errorMsgLower = (result.error.message || '').toLowerCase();
            const errorCode = result.error.code;
            
            // বিশেষ এরর কোড চেক করে বাংলায় বার্তা
            if (errorCode === 429 || errorMsgLower.includes('resource has been exhausted')) {
                throw new Error('আজকের জন্য আপনার কোটা শেষ হয়ে গেছে। দয়া করে আগামীকাল চেষ্টা করুন অথবা নতুন API Key ব্যবহার করুন।');
            } else if (errorCode === 503 || errorMsgLower.includes('overloaded') || errorMsgLower.includes('busy')) {
                throw new Error('সার্ভার বর্তমানে অতিরিক্ত ব্যস্ত (Model Overloaded)। অনুগ্রহ করে কিছুক্ষণ পর আবার চেষ্টা করুন।');
            } else if (errorCode === 400 || errorMsgLower.includes('invalid argument') || errorMsgLower.includes('not supported')) {
                throw new Error(`মডেলটি এই রিকোয়েস্ট সাপোর্ট করছে না। আমরা অটোমেটিক ফিক্স করার চেষ্টা করেছি, কিন্তু সমস্যাটি রয়ে গেছে। (${result.error.message})`);
            } else {
                throw new Error(`অডিও জেনারেট করতে সমস্যা হয়েছে। (${result.error.message})`);
            }
        }
        
        // রেসপন্স প্রসেসিং
        const part = result?.candidates?.[0]?.content?.parts?.[0];
        const audioData = part?.inlineData?.data;
        const mimeType = part?.inlineData?.mimeType;

        if (audioData && mimeType && mimeType.startsWith("audio/")) {
            // স্যাম্পল রেট বের করা (ডিফল্ট ২৪০০০)
            const sampleRateMatch = mimeType.match(/rate=(\d+)/);
            const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
            
            // অডিও প্রসেসিং
            const pcmData = base64ToArrayBuffer(audioData);
            const pcm16 = new Int16Array(pcmData);
            const wavBlob = pcmToWav(pcm16, sampleRate);
            
            downloadableAudioBlob = wavBlob;
            
            const audioUrl = URL.createObjectURL(wavBlob);
            ttsAudio = new Audio(audioUrl);
            
            // অডিও প্লে করা
            ttsAudio.play();
            
            if (downloadTtsBtn) downloadTtsBtn.disabled = false;

            ttsAudio.onended = () => {
                speakBtn.innerText = 'লোড করুন';
                speakBtn.disabled = false;
            };

        } else {
            throw new Error('API থেকে কোনো অডিও ডেটা পাওয়া যায়নি।');
        }
    } catch (error) {
        console.error('TTS Error:', error);
        showCustomAlert(`${error.message}`);
        
        speakBtn.innerText = 'লোড করুন';
        speakBtn.disabled = false;
        if (downloadTtsBtn) downloadTtsBtn.disabled = true;
    }
}

// ইভেন্ট লিসেনার যোগ করা
if (speakBtn) speakBtn.addEventListener('click', handleGeminiTTS);

if (pauseBtn) pauseBtn.addEventListener('click', () => {
    if (ttsAudio) ttsAudio.pause();
});

if (resumeBtn) resumeBtn.addEventListener('click', () => {
    if (ttsAudio) ttsAudio.play();
});

if (stopBtn) stopBtn.addEventListener('click', () => {
    if (ttsAudio) {
        ttsAudio.pause();
        ttsAudio.currentTime = 0;
        speakBtn.innerText = 'লোড করুন';
        speakBtn.disabled = false;
        if (downloadTtsBtn) downloadTtsBtn.disabled = true;
        downloadableAudioBlob = null;
    }
});

if (clearTtsBtn) clearTtsBtn.addEventListener('click', () => {
    ttsInput.value = '';
    if (ttsAudio) {
        ttsAudio.pause();
        ttsAudio.currentTime = 0;
    }
    speakBtn.innerText = 'লোড করুন';
    speakBtn.disabled = false;
    if (downloadTtsBtn) downloadTtsBtn.disabled = true;
    downloadableAudioBlob = null;
});

if (downloadTtsBtn) {
    downloadTtsBtn.addEventListener('click', () => {
        if (downloadableAudioBlob) {
            const url = URL.createObjectURL(downloadableAudioBlob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'bangla-toolbox-tts.wav';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
        } else {
            showCustomAlert('ডাউনলোড করার জন্য কোনো অডিও নেই।');
        }
    });
}

// ====================================================================
// END: GEMINI API TEXT-TO-SPEECH (TTS) SCRIPT
// ====================================================================

// ====================================================================
// START: GEMINI API BASED SPEECH-TO-TEXT (STT) SCRIPT
// ====================================================================
const sttOutput = document.getElementById('sttOutput');
const sttStatus = document.getElementById('sttStatus');
const startSttBtn = document.getElementById('startSttBtn');
const uploadAudioBtn = document.getElementById('uploadAudioBtn');
const audioFileInput = document.getElementById('audioFileInput');
const copySttBtn = document.getElementById('copySttBtn');
const clearSttBtn = document.getElementById('clearSttBtn');

let mediaRecorder;
let audioChunks = [];
let audioBlob = null;
let isRecording = false;

// Helper function to insert text at the current cursor position
function insertTextAtCursor(textarea, text) {
    if (!textarea) return;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const oldText = textarea.value;
    const newText = oldText.substring(0, start) + text + oldText.substring(end);
    textarea.value = newText;
    // Place cursor after the inserted text
    textarea.selectionStart = textarea.selectionEnd = start + text.length;
    textarea.focus();
}

// Main function to transcribe audio using Gemini API
async function transcribeAudioWithGemini(audioFile) {
    const apiKey = localStorage.getItem('geminiApiKey');
    if (!apiKey) {
        showCustomAlert('জেমিনি API কী সেট করা হয়নি।');
        sttStatus.innerText = 'অবস্থা: API কী প্রয়োজন।';
        return;
    }

    sttStatus.innerText = 'অবস্থা: অডিও প্রসেসিং ও জেমিনিকে পাঠানো হচ্ছে...';
    if(startSttBtn) startSttBtn.disabled = true;
    if(uploadAudioBtn) uploadAudioBtn.disabled = true;


    // Convert audio blob/file to Base64
    const reader = new FileReader();
    reader.readAsDataURL(audioFile);
    reader.onloadend = async () => {
        const base64Audio = reader.result.split(',')[1];
        const mimeType = audioFile.type.split(';')[0]; // Get MIME type without codecs

        try {
            const prompt = "Transcribe the following audio. Provide only the transcribed text without any additional comments, explanations, or introductory phrases.";

            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        {
                            inlineData: {
                                mimeType: mimeType,
                                data: base64Audio
                            }
                        }
                    ]
                }]
            };

            // --- গ্লোবাল মডেল ব্যবহার ---
            const model = localStorage.getItem('geminiModel') || "gemini-flash-latest";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (response.ok && result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                const transcribedText = result.candidates[0].content.parts[0].text.trim();
                insertTextAtCursor(sttOutput, transcribedText + " "); // Add a space after inserting
                sttStatus.innerText = 'অবস্থা: সফলভাবে টেক্সটে রূপান্তরিত হয়েছে! ✅';
            } else {
                const errorText = result?.error?.message || 'একটি অজানা ত্রুটি ঘটেছে। অডিও থেকে লেখা বের করা যায়নি।';
                sttStatus.innerText = `অবস্থা: ব্যর্থ হয়েছে - ${errorText}`;
                console.error('STT API Response Error:', result);
                showCustomAlert(`ট্রান্সক্রাইব করতে ব্যর্থ: ${errorText}`);
            }
        } catch (error) {
            sttStatus.innerText = `অবস্থা: একটি ত্রুটি ঘটেছে - ${error.message}`;
            console.error('STT API Call Error:', error);
            showCustomAlert(`একটি ত্রুটি ঘটেছে: ${error.message}`);
        } finally {
             // Reset the record button state
             if(startSttBtn) {
                 startSttBtn.dataset.state = 'record';
                 startSttBtn.innerText = 'রেকর্ড করুন';
                 startSttBtn.disabled = false;
             }
             if(uploadAudioBtn) uploadAudioBtn.disabled = false;
        }
    };
    reader.onerror = (error) => {
        console.error('File Reader Error:', error);
        sttStatus.innerText = 'অবস্থা: ফাইল পড়তে সমস্যা হয়েছে।';
        showCustomAlert('ফাইলটি পড়তে একটি ত্রুটি হয়েছে।');
        if(startSttBtn) startSttBtn.disabled = false;
        if(uploadAudioBtn) uploadAudioBtn.disabled = false;
    };
}


// Event listener for the record/send button
if (startSttBtn) {
    startSttBtn.addEventListener('click', async () => {
        const state = startSttBtn.dataset.state;

        if (state === 'record') {
            // Start recording
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = []; // Clear previous chunks

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                // This onstop handler will now create the blob and trigger the transcription
                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    if (audioBlob) {
                        transcribeAudioWithGemini(audioBlob);
                        audioBlob = null; // Clear blob after processing
                    }
                    // Stop microphone track to turn off the indicator
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;
                startSttBtn.dataset.state = 'recording'; // State is now 'recording'
                startSttBtn.innerText = 'পাঠান'; // Text changes to 'পাঠান'
                sttStatus.innerText = 'অবস্থা: রেকর্ডিং চলছে... 🎙️';
            } catch (err) {
                console.error("Microphone access error:", err);
                sttStatus.innerText = 'অবস্থা: মাইক্রোফোন অ্যাক্সেস করা যায়নি।';
                showCustomAlert('মাইক্রোফোন ব্যবহারের অনুমতি প্রয়োজন।');
            }
        } else if (state === 'recording') { // This state now means "Send" is clicked
            // Stop recording, which will trigger the onstop handler to send the data
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                startSttBtn.disabled = true; // Disable button while processing
                sttStatus.innerText = 'অবস্থা: প্রসেসিং...';
            }
        }
    });
}


// Event listeners for the upload functionality
if (uploadAudioBtn) {
    uploadAudioBtn.addEventListener('click', () => {
        if(audioFileInput) audioFileInput.click();
    });
}
if (audioFileInput) {
    audioFileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            transcribeAudioWithGemini(file);
            audioFileInput.value = ''; // Reset input for the next upload
        }
    });
}


// Event listeners for copy and clear buttons
if (copySttBtn) {
    copySttBtn.addEventListener('click', () => copyToClipboard('sttOutput'));
}

if (clearSttBtn) {
    clearSttBtn.addEventListener('click', () => {
        if (sttOutput) sttOutput.value = '';
        if (isRecording) {
            mediaRecorder.stop(); // Stop recording if active
        }
        // Reset button to initial state
        if(startSttBtn) {
            startSttBtn.dataset.state = 'record';
            startSttBtn.innerText = 'রেকর্ড করুন';
            startSttBtn.disabled = false;
        }
        if(sttStatus) sttStatus.innerText = 'অবস্থা: নিষ্ক্রিয় ✅';
    });
}
// ====================================================================
// END: GEMINI API BASED SPEECH-TO-TEXT (STT) SCRIPT
// ====================================================================

// ====================================================================
// START: TRANSLATOR SCRIPT (GEMINI API)
// ====================================================================

// প্রথমে, DOMContentLoaded এর শুরুতে অন্য ট্যাবগুলোর সাথে এগুলোও যোগ করুন
// const translatorTab = document.getElementById('translatorTab');
// const translatorContent = document.getElementById('translatorContent');

// ট্রান্সলেটরের জন্য DOM উপাদান
const translateBtn = document.getElementById('translateBtn');
const translatorInput = document.getElementById('translatorInput');
const translatorOutput = document.getElementById('translatorOutput');
const targetLanguageSelect = document.getElementById('targetLanguage');
const translatorLoading = document.getElementById('translatorLoading');
const copyTranslatedTextBtn = document.getElementById('copyTranslatedTextBtn');
const clearTranslatorTextBtn = document.getElementById('clearTranslatorTextBtn');

// ড্রপডাউনের জন্য ভাষার তালিকা
const languages = {
    'en': 'English',
    'bn': 'Bengali (বাংলা)',
    'hi': 'Hindi (हिन्दी)',
    'ar': 'Arabic (العربية)',
    'es': 'Spanish (Español)',
    'fr': 'French (Français)',
    'de': 'German (Deutsch)',
    'ja': 'Japanese (日本語)',
    'ko': 'Korean (한국어)',
    'ru': 'Russian (Русский)',
    'zh': 'Chinese (中文)',
    'pt': 'Portuguese (Português)',
    'it': 'Italian (Italiano)',
    'id': 'Indonesian (Bahasa Indonesia)',
    'ms': 'Malay (Bahasa Melayu)',
    'tr': 'Turkish (Türkçe)',
    'vi': 'Vietnamese (Tiếng Việt)',
    'th': 'Thai (ภาษาไทย)',
    'ur': 'Urdu (اردو)'
};

// ভাষার ড্রপডাউনটি পূরণ করার ফাংশন
function populateLanguageDropdown() {
    if (!targetLanguageSelect) return;
    targetLanguageSelect.innerHTML = ''; // আগের অপশন মুছে ফেলুন
    for (const code in languages) {
        const option = document.createElement('option');
        option.value = code;
        option.textContent = languages[code];
        targetLanguageSelect.appendChild(option);
    }
    // ডিফল্ট ভাষা হিসেবে বাংলা সেট করুন
    targetLanguageSelect.value = 'bn';
}

// মূল অনুবাদ ফাংশন
async function handleTranslate() {
    const textToTranslate = translatorInput.value.trim();
    const langCode = targetLanguageSelect.value;
    const langName = languages[langCode];

    if (!textToTranslate) {
        showCustomAlert('অনুগ্রহ করে অনুবাদ করার জন্য কিছু টেক্সট লিখুন।');
        return;
    }

    const apiKey = localStorage.getItem('geminiApiKey');
    if (!apiKey) {
        showCustomAlert('জেমিনি API কী সেট করা হয়নি। অনুগ্রহ করে "API কী সেট করুন" বাটনে ক্লিক করে কী সেট করুন।');
        translatorOutput.value = 'API কী প্রয়োজন।';
        return;
    }

    translatorLoading.style.display = 'block';
    translateBtn.disabled = true;
    translatorOutput.value = '';

    try {
        const prompt = `Translate the following text to ${langName}. Provide only the translated text without any additional explanations, introductory phrases, or quotation marks.\n\nText to translate:\n"${textToTranslate}"`;

        const payload = {
            contents: [{
                parts: [{ text: prompt }]
            }]
        };
        // --- গ্লোবাল মডেল ব্যবহার ---
        const model = localStorage.getItem('geminiModel') || "gemini-flash-latest";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        
        if (response.ok && result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
            translatorOutput.value = result.candidates[0].content.parts[0].text.trim();
        } else {
            const errorText = result?.error?.message || 'একটি অজানা ত্রুটি ঘটেছে।';
            translatorOutput.value = `অনুবাদ ব্যর্থ হয়েছে: ${errorText}`;
            console.error('API Response Error:', result);
        }

    } catch (error) {
        translatorOutput.value = `একটি ত্রুটি ঘটেছে: ${error.message}`;
        console.error('API Call Error:', error);
    } finally {
        translatorLoading.style.display = 'none';
        translateBtn.disabled = false;
    }
}

// ট্রান্সলেটরের জন্য ইভেন্ট লিসেনার যোগ করুন
if (translatorTab) {
    translatorTab.addEventListener('click', () => showTab('translator'));
}

if (translateBtn) {
    translateBtn.addEventListener('click', handleTranslate);
}

if (copyTranslatedTextBtn) {
    copyTranslatedTextBtn.addEventListener('click', () => {
        if (translatorOutput.value) {
            copyToClipboard('translatorOutput');
        } else {
            showCustomAlert('কপি করার জন্য কোনো লেখা নেই।');
        }
    });
}

if (clearTranslatorTextBtn) {
    clearTranslatorTextBtn.addEventListener('click', () => {
        translatorInput.value = '';
        translatorOutput.value = '';
        showCustomAlert('অনুবাদকের লেখা পরিষ্কার করা হয়েছে!');
    });
}

// স্ক্রিপ্ট লোড হওয়ার সময় ড্রপডাউনটি পূরণ করুন
populateLanguageDropdown();
// ====================================================================
// END: TRANSLATOR SCRIPT (GEMINI API)
// ====================================================================

// ====================================================================
// START: IMAGE TO TEXT (OCR) SCRIPT (Drag & Drop Updated)
// ====================================================================
const ocrImageInput = document.getElementById('ocrImageInput');
const imageUploadArea = document.querySelector('.image-upload-area'); // আপলোড এরিয়া সিলেক্ট করা হয়েছে
const ocrImagePreview = document.getElementById('ocrImagePreview');
const extractTextBtn = document.getElementById('extractTextBtn');
const ocrLoading = document.getElementById('ocrLoading');
const ocrResultText = document.getElementById('ocrResultText');
const copyOcrTextBtn = document.getElementById('copyOcrTextBtn');
const clearOcrBtn = document.getElementById('clearOcrBtn');

let ocrUploadedFile = null;

// ফাইল প্রসেস করার জন্য একটি ফাংশন তৈরি করা হয়েছে
function handleOcrFile(file) {
    if (!file) return;
    
    // ফাইলটি ছবি কিনা তা পরীক্ষা করা হচ্ছে
    const allowedTypes = ['image/png', 'image/jpeg', 'image/webp'];
    if (!allowedTypes.includes(file.type)) {
        showCustomAlert('শুধুমাত্র PNG, JPEG, বা WEBP ফরম্যাটের ছবি আপলোড করুন।');
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        ocrUploadedFile = {
            type: file.type,
            base64: e.target.result.split(',')[1],
            dataUrl: e.target.result
        };
        displayOcrImagePreview();
    };
    reader.onerror = () => {
        showCustomAlert('ফাইলটি পড়তে একটি ত্রুটি হয়েছে।');
    };
    reader.readAsDataURL(file);
}

// ইনপুট থেকে ফাইল সিলেক্ট হ্যান্ডেল করা
if (ocrImageInput) {
    ocrImageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        handleOcrFile(file);
    });
}

// Drag and Drop ইভেন্ট লিসেনার যোগ করা হয়েছে
if (imageUploadArea) {
    // ডিফল্ট আচরণ বন্ধ করা
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        imageUploadArea.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });

    // ড্র্যাগ করে ছবির উপরে আনলে আপলোড এরিয়া হাইলাইট হবে
    ['dragenter', 'dragover'].forEach(eventName => {
        imageUploadArea.addEventListener(eventName, () => {
            imageUploadArea.classList.add('drag-over');
        }, false);
    });

    // ড্র্যাগ করে ছবি সরিয়ে নিলে হাইলাইট চলে যাবে
    ['dragleave', 'drop'].forEach(eventName => {
        imageUploadArea.addEventListener(eventName, () => {
            imageUploadArea.classList.remove('drag-over');
        }, false);
    });

    // ফাইল ড্রপ করলে হ্যান্ডেল করা হবে
    imageUploadArea.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length > 0) {
            handleOcrFile(files[0]); // প্রথম ফাইলটি প্রসেস করা হবে
        }
    }, false);
}

// বাকি ফাংশনগুলো আগের মতোই থাকছে
function displayOcrImagePreview() {
    if (!ocrUploadedFile) return;
    ocrImagePreview.innerHTML = `
        <img src="${ocrUploadedFile.dataUrl}" alt="Uploaded Image Preview">
        <button class="remove-image-btn" title="ছবি সরান">&times;</button>
    `;
    ocrImagePreview.classList.remove('hidden');
    ocrImagePreview.querySelector('.remove-image-btn').addEventListener('click', clearOcrAreas);
}

function clearOcrAreas() {
    ocrUploadedFile = null;
    if(ocrImageInput) ocrImageInput.value = '';
    if(ocrImagePreview) ocrImagePreview.innerHTML = '';
    if(ocrImagePreview) ocrImagePreview.classList.add('hidden');
    if(ocrResultText) ocrResultText.value = '';
    if(ocrLoading) ocrLoading.style.display = 'none';
}

if (clearOcrBtn) {
    clearOcrBtn.addEventListener('click', () => {
         clearOcrAreas();
         showCustomAlert('সমস্ত কিছু মুছে ফেলা হয়েছে!');
    });
}

if (extractTextBtn) {
    extractTextBtn.addEventListener('click', async () => {
        if (!ocrUploadedFile) {
            showCustomAlert('অনুগ্রহ করে প্রথমে একটি ছবি নির্বাচন করুন।');
            return;
        }

        const apiKey = localStorage.getItem('geminiApiKey');
        if (!apiKey) {
            showCustomAlert('জেমিনি API কী সেট করা হয়নি।');
            return;
        }

        ocrLoading.style.display = 'block';
        extractTextBtn.disabled = true;
        ocrResultText.value = '';

        try {
            const prompt = "Extract all text from this image, including any text in different languages. Provide only the extracted text without any additional comments or explanations.";
            
            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        {
                            inlineData: {
                                mimeType: ocrUploadedFile.type,
                                data: ocrUploadedFile.base64
                            }
                        }
                    ]
                }]
            };

           // --- গ্লোবাল মডেল ব্যবহার ---
            const model = localStorage.getItem('geminiModel') || "gemini-flash-latest";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const result = await response.json();

            if (response.ok && result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                ocrResultText.value = result.candidates[0].content.parts[0].text.trim();
            } else {
                const errorText = result?.error?.message || 'একটি অজানা ত্রুটি ঘটেছে। ছবিটি থেকে লেখা বের করা যায়নি।';
                ocrResultText.value = `ব্যর্থ হয়েছে: ${errorText}`;
                console.error('OCR API Response Error:', result);
            }

        } catch (error) {
            ocrResultText.value = `একটি ত্রুটি ঘটেছে: ${error.message}`;
            console.error('OCR API Call Error:', error);
        } finally {
            ocrLoading.style.display = 'none';
            extractTextBtn.disabled = false;
        }
    });
}

if(copyOcrTextBtn){
    copyOcrTextBtn.addEventListener('click', () => {
        if(ocrResultText.value){
            copyToClipboard('ocrResultText');
        } else {
            showCustomAlert('কপি করার জন্য কোনো লেখা নেই।');
        }
    });
}
// ====================================================================
// END: IMAGE TO TEXT (OCR) SCRIPT
// ====================================================================

// ====================================================================
// START: WORD COUNTER SCRIPT
// ====================================================================
function initializeWordCounter() {
    const wordCounterInput = document.getElementById('wordCounterInput');
    const wordCountEl = document.getElementById('wordCount');
    const charCountEl = document.getElementById('charCount');
    const sentenceCountEl = document.getElementById('sentenceCount');
    const paragraphCountEl = document.getElementById('paragraphCount');

    if (!wordCounterInput) return;

    wordCounterInput.addEventListener('input', () => {
        const text = wordCounterInput.value;

        // Character Count
        const charCount = text.length;
        charCountEl.textContent = new Intl.NumberFormat('bn-BD').format(charCount);

        // Word Count
        const words = text.trim().split(/\s+/).filter(word => word.length > 0);
        const wordCount = words.length;
        wordCountEl.textContent = text.trim() === '' ? '০' : new Intl.NumberFormat('bn-BD').format(wordCount);

        // Sentence Count (handles English and Bengali terminators)
        const sentences = text.trim().split(/[.!?।]/).filter(sentence => sentence.trim().length > 0);
        const sentenceCount = sentences.length;
        sentenceCountEl.textContent = new Intl.NumberFormat('bn-BD').format(sentenceCount);

        // Paragraph Count
        const paragraphs = text.trim().split(/\n+/).filter(para => para.trim().length > 0);
        const paragraphCount = paragraphs.length;
        paragraphCountEl.textContent = new Intl.NumberFormat('bn-BD').format(paragraphCount);
    });
}

// Initialize the word counter when the tab is shown
if (wordCounterTab) {
    wordCounterTab.addEventListener('click', initializeWordCounter);
}
// If it's the default active tab, initialize it on load
if (wordCounterContent && wordCounterContent.classList.contains('active')) {
    initializeWordCounter();
}
// ====================================================================
// END: WORD COUNTER SCRIPT
// ====================================================================


// ====================================================================
// START: NOTEPAD / TO-DO LIST SCRIPT (UPDATED WITH FORMATTING TOOLBAR)
// ====================================================================
async function initializeNotepad() {
    const taskInput = document.getElementById('taskInput'); // now a div
    const addTaskBtn = document.getElementById('addTaskBtn');
    const taskList = document.getElementById('taskList');
    const actionToolbar = document.getElementById('notepadActionToolbar');

    // নতুন ফিচারগুলোর জন্য DOM এলিমেন্ট
    const exportTxtBtn = document.getElementById('exportTxtBtn');
    const exportHtmlBtn = document.getElementById('exportHtmlBtn');
    const findInput = document.getElementById('notepadFindInput');
    const findBtn = document.getElementById('notepadFindBtn');
    let lastSearchQuery = '';

    if (!taskInput || !addTaskBtn || !taskList || !actionToolbar) return;
	
    if (taskInput.getAttribute('data-notepad-initialized') === 'true') {
        return; 
    }
    taskInput.setAttribute('data-notepad-initialized', 'true');
	
    // --- Action Toolbar Logic ---
    let currentTargetElement = null; // কোন এলিমেন্ট এডিট করা হচ্ছে তা ট্র্যাক করার জন্য
    let savedRange = null; // সিলেকশন সেভ করার জন্য

    const showToolbar = () => {
        const selection = window.getSelection();
        if (selection.rangeCount > 0 && !selection.isCollapsed) { // শুধু টেক্সট সিলেক্ট করা থাকলেই দেখাবে
            savedRange = selection.getRangeAt(0).cloneRange(); // সিলেকশন সেভ করুন
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            const containerRect = taskList.closest('.notepad-container').getBoundingClientRect();

            actionToolbar.style.display = 'flex';
            
            setTimeout(() => {
                actionToolbar.style.opacity = '1';
                actionToolbar.style.transform = 'translateY(0)';
            }, 10);
            
            let top = rect.top - containerRect.top - actionToolbar.offsetHeight - 8;
            let left = rect.left - containerRect.left + (rect.width / 2) - (actionToolbar.offsetWidth / 2);

            if (top < 0) top = rect.bottom - containerRect.top + 8;
            if (left < 0) left = 5;
            if (left + actionToolbar.offsetWidth > containerRect.width) {
                left = containerRect.width - actionToolbar.offsetWidth - 5;
            }

            actionToolbar.style.top = `${top}px`;
            actionToolbar.style.left = `${left}px`;
        } else {
            hideToolbar();
        }
    };

    const hideToolbar = () => {
        // কালার পিকার ওপেন থাকলে টুলবার হাইড করবেন না
        if (document.activeElement && document.activeElement.type === 'color') return;

        actionToolbar.style.opacity = '0';
        actionToolbar.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            if (actionToolbar.style.opacity === '0') {
                actionToolbar.style.display = 'none';
            }
        }, 150); 
    };
    
    // ফরম্যাটিং কমান্ড প্রয়োগ করার ফাংশন (আপডেট করা - ভ্যালু প্যারামিটার সহ)
    const applyFormat = (command, value = null) => {
        const selection = window.getSelection();
        // যদি সিলেকশন হারিয়ে যায়, সেভ করা রেঞ্জ ব্যবহার করুন
        if ((!selection || selection.rangeCount === 0) && savedRange) {
            selection.removeAllRanges();
            selection.addRange(savedRange);
        } else if (selection.rangeCount > 0) {
            savedRange = selection.getRangeAt(0).cloneRange();
        }

        if (command === 'increaseFontSize' || command === 'decreaseFontSize') {
            document.execCommand("fontSize", false, "1"); // একটি অস্থায়ী ফন্ট সাইজ প্রয়োগ করা হয়
            const fontElements = (currentTargetElement || document).getElementsByTagName("font");
            Array.from(fontElements).forEach(fontElement => {
                if (fontElement.size == "1") {
                    const parent = fontElement.parentElement;
                    const currentSize = parseFloat(window.getComputedStyle(parent, null).getPropertyValue('font-size')) || 16;
                    let newSize = currentSize + (command === 'increaseFontSize' ? 2 : -2);
                    if (newSize < 10) newSize = 10;
                    if (newSize > 72) newSize = 72;
                    
                    fontElement.removeAttribute("size");
                    fontElement.style.fontSize = newSize + "px";
                }
            });

        } else if (command === 'removeFormat') {
            if (!selection || selection.rangeCount === 0) return;

            const range = selection.getRangeAt(0);
            const contentFragment = range.extractContents();

            const tempDiv = document.createElement('div');
            tempDiv.appendChild(contentFragment);
            let processedHtml = tempDiv.innerHTML;
            
            processedHtml = processedHtml.replace(/<\/(div|p)>/gi, '<br>');
            processedHtml = processedHtml.replace(/(<br\s*\/?>\s*){2,}/gi, '<br>');
            const cleanedHtml = processedHtml.replace(/<\/?(?!(br|BR)\s*\/?)[^>]+>/g, '');
            
            document.execCommand('insertHTML', false, cleanedHtml);
            saveTasks();

        } else {
            // সাধারণ কমান্ড এবং কালার কমান্ড হ্যান্ডলিং
            document.execCommand(command, false, value);
        }

        if(currentTargetElement) {
            // currentTargetElement.focus(); // ফোকাস রাখলে কালার পিকার বারবার বন্ধ হতে পারে, তাই এটি শর্তসাপেক্ষ
            const currentSelection = window.getSelection();
            if (currentSelection.rangeCount > 0) {
                savedRange = currentSelection.getRangeAt(0).cloneRange();
            }
        }
    };

    // সাধারণ বাটনের জন্য মাউস ইভেন্ট
    actionToolbar.addEventListener('mousedown', (e) => {
        const button = e.target.closest('.toolbar-btn');
        // কালার ইনপুট হলে preventDefault করবেন না
        if (button && !button.querySelector('input[type="color"]')) {
            e.preventDefault(); 
            const command = button.dataset.command;
            applyFormat(command);
        }
    });

    // কালার ইনপুটের জন্য ইনপুট ইভেন্ট লিসেনার
    actionToolbar.addEventListener('input', (e) => {
        const target = e.target;
        if (target.tagName === 'INPUT' && target.type === 'color') {
            const command = target.dataset.command;
            const value = target.value;
            applyFormat(command, value);
        }
    });
    
    document.addEventListener('selectionchange', () => {
        const selection = window.getSelection();
        const parent = selection.anchorNode ? (selection.anchorNode.nodeType === 3 ? selection.anchorNode.parentNode : selection.anchorNode) : null;
        const editableParent = parent ? parent.closest('.notepad-container [contenteditable="true"]') : null;
        if(editableParent){
             currentTargetElement = editableParent;
             showToolbar();
        } else {
            hideToolbar();
        }
    });

    document.addEventListener('mousedown', (e) => {
        if (!e.target.closest('.notepad-action-toolbar') && !e.target.closest('[contenteditable="true"]')) {
            hideToolbar();
        }
    });

    // --- Core Notepad Logic (Updated for contenteditable) ---
    await loadTasks();

    async function addTextTask() {
        const content = taskInput.innerHTML.trim();
        if (content === '' || content === '<br>') {
            showCustomAlert('অনুগ্রহ করে একটি কাজ বা নোট লিখুন।');
            return;
        }
        createTaskElement({ type: 'text', content, completed: false, pinned: false });
		showCustomAlert('নোট সফলভাবে যোগ করা হয়েছে!');
        taskInput.innerHTML = '';
        await saveTasks();
        await loadTasks();
    }

    async function addImageTask(base64Image) {
        if (!base64Image) return;
        createTaskElement({ type: 'image', content: base64Image, caption: '', completed: false, pinned: false });
        showCustomAlert('ছবি সফলভাবে যোগ করা হয়েছে!');
        await saveTasks();
        await loadTasks();
    }

    async function loadTasks() {
        let tasks = await idbGet('notepadTasks') || [];
        tasks.sort((a, b) => (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0));
        taskList.innerHTML = '';
        tasks.forEach(task => createTaskElement(task));
        updateTaskNumbers();
    }

    async function saveTasks() {
        const tasks = Array.from(document.querySelectorAll('.task-item')).map(item => {
            const textSpan = item.querySelector('.task-text');
            const imageEl = item.querySelector('.task-image');
            if (textSpan) {
                return { type: 'text', content: textSpan.innerHTML, completed: item.classList.contains('completed'), pinned: item.classList.contains('pinned') };
            } else if (imageEl) {
                const captionEl = item.querySelector('.task-image-caption');
                return { type: 'image', content: imageEl.src, caption: captionEl ? captionEl.innerText : '', completed: item.classList.contains('completed'), pinned: item.classList.contains('pinned') };
            }
            return null;
        }).filter(Boolean);
        await idbSet('notepadTasks', tasks);
    }
    
    function createTaskElement(task) {
        const { type, content, completed, pinned, caption } = task;

        const li = document.createElement('li');
        li.className = `task-item ${completed ? 'completed' : ''} ${pinned ? 'pinned' : ''}`;
        li.setAttribute('draggable', 'true');

        const numberSpan = document.createElement('span');
        numberSpan.className = 'task-number';

        const contentWrapper = document.createElement('div');
        contentWrapper.style.flexGrow = '1';

        if (type === 'image') {
             contentWrapper.innerHTML = `
                <div>
                    <img src="${content}" class="task-image" style="width: 100%; height: auto; max-height: 300px; object-fit: cover; border-radius: 8px; margin-top: 5px;">
                    <p class="task-image-caption" style="font-size: 0.9em; color: grey; margin-top: 8px; padding: 4px; border-radius: 4px; word-break: break-word; text-align: justify;">${caption || 'ক্যাপশন যোগ করতে ডাবল-ক্লিক করুন...'}</p>
                </div>
            `;
            const captionEl = contentWrapper.querySelector('.task-image-caption');
            const enableCaptionEdit = (e) => {
                e.stopPropagation();
                if (captionEl.innerText === 'ক্যাপশন যোগ করতে ডাবল-ক্লিক করুন...') captionEl.innerText = '';
                captionEl.contentEditable = true;
                captionEl.focus();
                captionEl.style.outline = '2px solid #3b82f6';
                const originalCaption = captionEl.innerText;
                const saveOnBlur = async () => {
                    captionEl.contentEditable = false;
                    captionEl.style.outline = 'none';
                    if (captionEl.innerText.trim() === '') captionEl.innerText = 'ক্যাপশন যোগ করতে ডাবল-ক্লিক করুন...';
                    if (captionEl.innerText !== originalCaption) await saveTasks();
                };
                captionEl.addEventListener('blur', saveOnBlur, { once: true });
            };
            contentWrapper.querySelector('.task-image').addEventListener('dblclick', enableCaptionEdit);
            captionEl.addEventListener('dblclick', enableCaptionEdit);
        } else {
            const textSpan = document.createElement('div');
            textSpan.className = 'task-text';
            textSpan.innerHTML = content;
            textSpan.contentEditable = true;
            textSpan.spellcheck = false;
            textSpan.addEventListener('blur', saveTasks);
            contentWrapper.appendChild(textSpan);
        }

        contentWrapper.addEventListener('click', async (e) => {
            if (e.target.closest('[contenteditable="true"]')) return;
            li.classList.toggle('completed');
            await saveTasks();
        });

        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'actions';
        actionsDiv.innerHTML = `
            <button class="action-btn pin ${pinned ? 'active' : ''}" title="পিন/আনপিন করুন"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4.146.146A.5.5 0 0 1 4.5 0h7a.5.5 0 0 1 .5.5c0 .68-.342 1.174-.646 1.479-.126.125-.25.224-.354.298v4.431l.078.048c.203.127.476.314.751.555C12.36 7.775 13 8.527 13 9.5a.5.5 0 0 1-.5.5h-4v4.5c0 .276-.224 1.5-.5 1.5s-.5-1.224-.5-1.5V10h-4a.5.5 0 0 1-.5-.5c0-.973.64-1.725 1.17-2.176a6 6 0 0 1 .751-.555l.078-.048V2.147a3.2 3.2 0 0 1-.354-.298C3.842 1.674 3.5 1.18 3.5.5a.5.5 0 0 1 .646-.354m.354 1.354a.5.5 0 0 0-.708 0l-.5.5A.5.5 0 0 0 3 2.5V3h10V2.5a.5.5 0 0 0-.293-.45l-.5-.5a.5.5 0 0 0-.707 0l-.001.002-.002.001-.002.001a.5.5 0 0 1-.17.036H5.02a.5.5 0 0 1-.17-.036l-.002-.001-.002-.001L4.5 1.5z"/></svg></button>
            <button class="action-btn copy" title="কপি করুন"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z"/></svg></button>
            <button class="action-btn delete" title="মুছে ফেলুন"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg></button>
        `;

        actionsDiv.querySelector('.pin').addEventListener('click', async () => { li.classList.toggle('pinned'); await saveTasks(); await loadTasks(); });
        
        actionsDiv.querySelector('.copy').addEventListener('click', () => {
             if (type === 'text') {
                const contentToCopy = li.querySelector('.task-text').innerHTML;
                const tempEl = document.createElement('div');
                tempEl.style.position = 'absolute';
                tempEl.style.left = '-9999px';
                tempEl.innerHTML = contentToCopy;
                document.body.appendChild(tempEl);
                try {
                    const range = document.createRange();
                    range.selectNodeContents(tempEl);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showCustomAlert('নোটের লেখা ফরম্যাটিং সহ কপি করা হয়েছে!');
                    } else {
                        showCustomAlert('কপি করতে ব্যর্থ হয়েছে।');
                    }
                } catch (err) {
                    console.error('কপি করতে ব্যর্থ:', err);
                    showCustomAlert('কপি করতে ব্যর্থ হয়েছে। অনুগ্রহ করে ম্যানুয়ালি কপি করুন।');
                } finally {
                    document.body.removeChild(tempEl);
                    window.getSelection().removeAllRanges();
                }
            } else if (type === 'image') {
                const capEl = li.querySelector('.task-image-caption');
                if (capEl && capEl.innerText && capEl.innerText !== 'ক্যাপশন যোগ করতে ডাবল-ক্লিক করুন...') {
                    navigator.clipboard.writeText(capEl.innerText).then(() => showCustomAlert('ছবির ক্যাপশন কপি করা হয়েছে!'));
                } else {
                    showCustomAlert('ছবি সরাসরি কপি করা যায় না এবং কোনো ক্যাপশন নেই।');
                }
            }
        });

       actionsDiv.querySelector('.delete').addEventListener('click', async () => {
            if (confirm('আপনি কি নিশ্চিতভাবে এই নোটটি মুছে ফেলতে চান?')) {
                li.remove();
                await saveTasks();
                updateTaskNumbers();
                showCustomAlert('নোট সফলভাবে মুছে ফেলা হয়েছে!');
            }
        });

        li.appendChild(numberSpan);
        li.appendChild(contentWrapper);
        li.appendChild(actionsDiv);
        taskList.appendChild(li);
    }
    
    addTaskBtn.addEventListener('click', addTextTask);

    taskInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.execCommand('insertLineBreak');
        }
    });

    taskInput.addEventListener('paste', (event) => {
        const items = (event.clipboardData || window.clipboardData).items;
        for (const item of items) { if (item.type.includes('image')) { event.preventDefault(); const blob = item.getAsFile(); const reader = new FileReader(); reader.onload = (e) => addImageTask(e.target.result); reader.readAsDataURL(blob); return; } }
    });

    let draggingItem = null;
    
	    // *** MODIFIED dragstart listener ***
    taskList.addEventListener('dragstart', e => {
        // Check if the target is a draggable item AND if a text element inside the taskList is currently being edited
        const activeElement = document.activeElement;
        const isEditingText = activeElement && activeElement.classList.contains('task-text') && taskList.contains(activeElement);

        if (e.target.classList.contains('task-item') && !isEditingText) {
            draggingItem = e.target;
            setTimeout(() => e.target.classList.add('dragging'), 0);
        } else {
            // Prevent dragging if editing text
            e.preventDefault();
        }
    });
	
    taskList.addEventListener('dragend', async () => { if (draggingItem) { draggingItem.classList.remove('dragging'); draggingItem = null; await saveTasks(); updateTaskNumbers(); } });
    
	    // *** MODIFIED dragover listener ***
    taskList.addEventListener('dragover', e => {
        // Check if a text element inside the taskList is currently being edited
        const activeElement = document.activeElement;
        const isEditingText = activeElement && activeElement.classList.contains('task-text') && taskList.contains(activeElement);

        // Allow dropping ONLY if not editing text and a valid item is being dragged
        if (draggingItem && !isEditingText) {
            e.preventDefault(); // Only prevent default if dropping is allowed
            const afterElement = getDragAfterElement(taskList, e.clientY);
            taskList.insertBefore(draggingItem, afterElement);
        }
        // If editing text, the default behavior (no drop) is allowed to happen
    });

    function updateTaskNumbers() {
        taskList.querySelectorAll('.task-item').forEach((task, index) => { task.querySelector('.task-number').textContent = index + 1; });
    }

    function getDragAfterElement(container, y) {
        return [...container.querySelectorAll('.task-item:not(.dragging)')].reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            return (offset < 0 && offset > closest.offset) ? { offset, element: child } : closest;
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // --- নতুন ফাংশন (এক্সপোর্ট এবং ফাইন্ড) ---
    const downloadFile = (content, fileName, contentType) => {
        const a = document.createElement("a");
        const file = new Blob([content], { type: `${contentType};charset=utf-8` });
        a.href = URL.createObjectURL(file);
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(a.href);
    };

    const exportNotepadAsTXT = () => {
        const tasks = Array.from(taskList.querySelectorAll('.task-item'));
        if (tasks.length === 0) {
            showCustomAlert('এক্সপোর্ট করার জন্য কোনো নোট নেই।');
            return;
        }
        let textContent = `বাংলা টুলবক্স - নোটপ্যাড\r\n${new Date().toLocaleString('bn-BD')}\r\n====================================\r\n\r\n`;

        tasks.forEach((item, index) => {
            textContent += `নোট ${index + 1}:\r\n`;
            const textEl = item.querySelector('.task-text');
            const imgEl = item.querySelector('.task-image');

            if (textEl) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = textEl.innerHTML.replace(/<br\s*\/?>/gi, '\r\n').replace(/<\/p>/gi, '\r\n').replace(/<\/div>/gi, '\r\n');
                textContent += tempDiv.textContent || tempDiv.innerText || '';
            } else if (imgEl) {
                const captionEl = item.querySelector('.task-image-caption');
                textContent += `[ছবি]`;
                if (captionEl && captionEl.innerText !== 'ক্যাপশন যোগ করতে ডাবল-ক্লিক করুন...') {
                    textContent += `\r\nক্যাপশন: ${captionEl.innerText}`;
                }
            }
            textContent += `\r\n\r\n------------------------------------\r\n\r\n`;
        });
        
        downloadFile(textContent, 'bangla-toolbox-notes.txt', 'text/plain');
    };

const exportNotepadAsHTML = () => {
        const tasks = Array.from(taskList.querySelectorAll('.task-item'));
        if (tasks.length === 0) {
            showCustomAlert('এক্সপোর্ট করার জন্য কোনো নোট নেই।');
            return;
        }
        
        let bodyContent = '';
        
        tasks.forEach((item, index) => {
            // পিন করা নোট কিনা যাচাই করা হচ্ছে
            const isPinned = item.classList.contains('pinned');
            
            // পিন করা হলে ব্যাকগ্রাউন্ড কালার এবং বর্ডার স্টাইল সেট করা হচ্ছে Default: ŴŊŴŖŴŚŨŔŨř ųŞŨţŨňŝĴƏŨŔ : ļţŨŊňũŗŝΥƏŨśũŅŴřŨļţŨőŊŨΝŚŴŝŴŖőĺĵňŴŕŨřŴŝŴŖőňŬőŨĵőũŝǑŴŕŨř
            const itemStyle = isPinned 
                ? 'background-color: #fef3c7; border: 1px solid #f59e0b; border-left: 5px solid #f59e0b;' 
                : 'background-color: #ffffff; border: 1px solid #e2e8f0;';

            bodyContent += `<div class="note-item" style="${itemStyle}">`;
            
            // নোটের শিরোনাম বা নম্বর (পিন আইকন সহ যদি পিন করা থাকে)
            bodyContent += `<div class="note-header" style="display:flex; justify-content:space-between; align-items:center;">
                                <strong>নোট ${index + 1}</strong>
                                ${isPinned ? '<span style="font-size:12px; background:#f59e0b; color:white; padding:2px 6px; border-radius:4px;">📌 Pinned</span>' : ''}
                            </div>`;
            
            const textEl = item.querySelector('.task-text');
            const imgEl = item.querySelector('.task-image');

            if (textEl) {
                // টেক্সট ফরম্যাটিং (কালার, বোল্ড, হাইলাইট) হুবহু কপি করা হচ্ছে
                bodyContent += `<div class="note-content">${textEl.innerHTML}</div>`;
            } else if (imgEl) {
                // ছবির ক্ষেত্রে
                const captionEl = item.querySelector('.task-image-caption');
                const captionText = (captionEl && captionEl.innerText !== 'ক্যাপশন যোগ করতে ডাবল-ক্লিক করুন...') ? captionEl.innerText : '';
                
                bodyContent += `<div class="note-content" style="text-align:center;">
                                    <img src="${imgEl.src}" style="max-width: 100%; border-radius: 8px; margin-bottom: 10px;">
                                    ${captionText ? `<p style="font-style: italic; color: #555; background: #eee; padding: 5px; border-radius: 4px;">${captionText}</p>` : ''}
                                </div>`;
            }
            bodyContent += `</div>`;
        });

        // HTML ফাইলের পূর্ণাঙ্গ স্ট্রাকচার
        const htmlContent = `
            <!DOCTYPE html>
            <html lang="bn">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>এক্সপোর্ট করা নোটসমূহ - বাংলা টুলবক্স</title>
                <style>
                    body { font-family: 'SolaimanLipi', 'Arial', sans-serif; line-height: 1.6; padding: 40px 20px; max-width: 800px; margin: auto; background-color: #f8f9fa; }
                    h1 { text-align: center; color: #3f51b5; border-bottom: 2px solid #e0e7ff; padding-bottom: 15px; }
                    .meta-info { text-align: center; color: #666; margin-bottom: 30px; font-size: 0.9rem; }
                    .note-item { border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
                    .note-header { border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 10px; margin-bottom: 15px; color: #555; font-size: 0.95rem; }
                    .note-content { font-size: 1.1rem; color: #333; white-space: pre-wrap; word-wrap: break-word; }
                    /* ফরম্যাটিং ঠিক রাখার জন্য */
                    .note-content b { font-weight: bold; }
                    .note-content i { font-style: italic; }
                    .note-content u { text-decoration: underline; }
                    .note-content s { text-decoration: line-through; }
                </style>
            </head>
            <body>
                <h1>আমার নোটসমূহ</h1>
                <p class="meta-info">তৈরির সময়: ${new Date().toLocaleString('bn-BD')}</p>
                ${bodyContent}
                <div style="text-align:center; margin-top:50px; color:#aaa; font-size:12px;">Generated by Bangla Toolbox</div>
            </body>
            </html>`;
        
        downloadFile(htmlContent, 'bangla-toolbox-notes.html', 'text/html');
    };

const findInNotepad = () => {
    const query = findInput.value.trim();
    
    // Remove previous highlights
    taskList.querySelectorAll('mark').forEach(mark => {
        const parent = mark.parentNode;
        if (parent) {
            parent.replaceChild(document.createTextNode(mark.textContent), mark);
            parent.normalize(); // Merges adjacent text nodes
        }
    });

    if (!query) {
        lastSearchQuery = '';
        return; // Exit if query is empty
    }

    // Avoid re-searching for the same query
    if (query.toLowerCase() === lastSearchQuery.toLowerCase()) return;
    lastSearchQuery = query;

    const regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
    let matchCount = 0;

    taskList.querySelectorAll('.task-text, .task-image-caption').forEach(task => {
        const treeWalker = document.createTreeWalker(task, NodeFilter.SHOW_TEXT);
        let currentNode;
        const nodesToReplace = [];

        while (currentNode = treeWalker.nextNode()) {
            if (regex.test(currentNode.nodeValue)) {
                nodesToReplace.push(currentNode);
            }
        }
        
        nodesToReplace.forEach(node => {
            const parent = node.parentNode;
            if (!parent) return;

            const fragment = document.createDocumentFragment();
            let lastIndex = 0;
            node.nodeValue.replace(regex, (match, offset) => {
                fragment.appendChild(document.createTextNode(node.nodeValue.substring(lastIndex, offset)));
                const mark = document.createElement('mark');
                mark.style.backgroundColor = '#ffda79'; // Custom highlight color
                mark.style.color = '#000';
                mark.textContent = match;
                fragment.appendChild(mark);
                lastIndex = offset + match.length;
                matchCount++;
            });
            fragment.appendChild(document.createTextNode(node.nodeValue.substring(lastIndex)));
            parent.replaceChild(fragment, node);
        });
    });

    if (matchCount > 0) {
        showCustomAlert(`${matchCount.toLocaleString('bn-BD')} টি মিল পাওয়া গেছে।`);
        const firstMatch = taskList.querySelector('mark');
        if (firstMatch) {
            firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    } else {
        showCustomAlert("কোনো ফলাফল পাওয়া যায়নি।");
    }
};

    if(exportTxtBtn) exportTxtBtn.addEventListener('click', exportNotepadAsTXT);
    if(exportHtmlBtn) exportHtmlBtn.addEventListener('click', exportNotepadAsHTML);
    if(findBtn) findBtn.addEventListener('click', findInNotepad);
    if(findInput) {
        findInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') findInNotepad();
            if (e.key === 'Escape') {
                findInput.value = '';
                findInNotepad();
            }
        });
        findInput.addEventListener('input', () => {
            if(findInput.value.trim() === '') findInNotepad();
        });
    }
}

// ====================================================================
// END: NOTEPAD SCRIPT
// ====================================================================

// ====================================================================
// START: CLOCK TAB SCRIPT (STOPWATCH, ALARM, WORLD CLOCK)
// ====================================================================

// --- গ্লোবাল ভেরিয়েবল ---
let globalAlarmTimeValue = null;
let globalActiveAlarmSound = null;
let hasGlobalAlarmRung = false;
let globalAudioContext = null;
let globalAlarmCheckInterval = null;
let defaultSoundTimeout = null; 

// --- টাইমার ফিক্স: গ্লোবাল টাইমার ভেরিয়েবল (যাতে ডুপ্লিকেট না হয়) ---
let globalStopwatchTimer = null;
let globalCountdownInterval = null;
// window.worldClockIntervalId ইতিমধ্যে গ্লোবাল হিসেবে আছে

// গ্লোবাল ফাংশন: ঘড়ি ট্যাবের নির্দিষ্ট সেকশনে যাওয়ার জন্য (ওভাররাইড)
window.switchToClockTab = function(section = 'alarm') {
    // ১. ঘড়ি ট্যাব সক্রিয় করুন
    if (typeof showTab === 'function') {
        showTab('clock');
    } else {
        const clockTabBtn = document.getElementById('clockTab');
        if (clockTabBtn) clockTabBtn.click();
    }

    // ২. স্ক্রলিং লজিক (Retry Mechanism সহ)
    let attempts = 0;
    const maxAttempts = 15; // ১৫ বার চেষ্টা করবে
    
    const attemptScroll = () => {
        const targetSection = document.querySelector(`.clock-section.${section}`);
        
        // এলিমেন্ট আছে এবং দৃশ্যমান কিনা চেক
        if (targetSection && targetSection.offsetParent !== null) {
            // একটু সময় দিয়ে স্ক্রল করা যাতে ট্যাব রেন্ডারিং শেষ হয়
            setTimeout(() => {
                targetSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                targetSection.classList.add('ring-4', 'ring-indigo-500', 'ring-opacity-50');
                setTimeout(() => {
                    targetSection.classList.remove('ring-4', 'ring-indigo-500', 'ring-opacity-50');
                }, 2000);
            }, 50);
        } else {
            attempts++;
            if (attempts < maxAttempts) {
                setTimeout(attemptScroll, 100); 
            }
        }
    };

    setTimeout(attemptScroll, 100);
}

// IndexedDB হেল্পার
async function idbDelete(key) {
    try {
        const db = await getDb();
        const transaction = db.transaction(STORE_NAME, 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        store.delete(key);
        return transaction.complete;
    } catch(e) { console.error("IDB Delete error", e); }
}

// --- সিস্টেম ইনিশিয়ালাইজেশন ---
async function initBackgroundAlarmSystem() {
    try {
        setupDOMInterceptor();

        const savedAlarm = await idbGet('activeAlarm');
        if (savedAlarm && savedAlarm.time) {
            globalAlarmTimeValue = savedAlarm.time;
            forceUpdateBanner();
        }

        const unlockEvents = ['click', 'touchstart', 'keydown', 'mousedown', 'pointerdown'];
        const unlockHandler = () => {
            unlockAudioContext();
            unlockEvents.forEach(evt => document.body.removeEventListener(evt, unlockHandler));
        };
        
        unlockEvents.forEach(evt => 
            document.body.addEventListener(evt, unlockHandler, { once: true })
        );

        startAlarmMonitoring();

    } catch (e) {
        console.error("Alarm init error:", e);
    }
}

// --- DOM ইন্টারসেপ্টর ---
function setupDOMInterceptor() {
    if (document.getElementById.isProxy) return;

    const originalGetElementById = document.getElementById.bind(document);

    document.getElementById = function(id) {
        const element = originalGetElementById(id);
        
        if (id === 'currentDateTimeBanner' && element) {
            return new Proxy(element, {
                set(target, prop, value) {
                    if (prop === 'innerHTML') {
                        const alarmHtml = getAlarmBannerHTML();
                        const countdownHtml = getCountdownBannerHTML();
                        
                        let combinedHtml = value;
                        if (alarmHtml) combinedHtml += alarmHtml;
                        if (countdownHtml) combinedHtml += countdownHtml;
                        
                        value = combinedHtml;
                    }
                    target[prop] = value;
                    return true;
                },
                get(target, prop) {
                    const value = target[prop];
                    if (typeof value === 'function') {
                        return value.bind(target);
                    }
                    return value;
                }
            });
        }
        return element;
    };
    
    document.getElementById.isProxy = true;
}

// --- মনিটরিং লুপ ---
function startAlarmMonitoring() {
    if (globalAlarmCheckInterval) clearInterval(globalAlarmCheckInterval);
    
    globalAlarmCheckInterval = setInterval(() => {
        if (globalAlarmTimeValue) {
            checkAlarmTrigger();
            updateAlarmStatusUI();
        }
    }, 500);
}

// --- ফোর্স ব্যানার আপডেট ---
function forceUpdateBanner() {
    const banner = document.getElementById('currentDateTimeBanner');
    if (banner) {
        let cleanHTML = banner.innerHTML;
        cleanHTML = cleanHTML.split('<span id="bannerAlarmStatus"')[0];
        cleanHTML = cleanHTML.split('<span id="bannerCountdownStatus"')[0];
        
        banner.innerHTML = cleanHTML; 
    }
}

// --- অ্যালার্ম ব্যানার HTML ---
function getAlarmBannerHTML() {
    if (!globalAlarmTimeValue) return '';

    const [tHours, tMinutes] = globalAlarmTimeValue.split(':').map(Number);
    const now = new Date();
    const target = new Date();
    target.setHours(tHours, tMinutes, 0, 0);

    if (target <= now && !hasGlobalAlarmRung) {
        target.setDate(target.getDate() + 1);
    }

    if (hasGlobalAlarmRung) {
        return `<span id="bannerAlarmStatus" onclick="switchToClockTab('alarm')" class="text-red-600 dark:text-red-400 font-bold animate-pulse ml-4 cursor-pointer align-middle select-none" title="অ্যালার্ম বন্ধ করতে ক্লিক করুন"> | 🔔 অ্যালার্ম বাজছে!</span>`;
    }

    const diff = target - now;
    if (diff < 0) return '';

    const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
    const m = Math.floor((diff / (1000 * 60)) % 60);
    const s = Math.floor((diff / 1000) % 60);

    const timeStr = formatTo12Hour(globalAlarmTimeValue);
    const remainingStr = h > 0 
        ? `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`
        : `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;

    return `<span id="bannerAlarmStatus" onclick="switchToClockTab('alarm')" class="text-red-600 dark:text-red-300 ml-4 text-sm cursor-pointer align-middle select-none" title="অ্যালার্ম সেকশনে যেতে ক্লিক করুন"> | 🔔 ${timeStr} (${remainingStr})</span>`;
}

// --- কাউন্টডাউন ব্যানার HTML ---
function getCountdownBannerHTML() {
    try {
        const savedState = JSON.parse(localStorage.getItem('countdownState'));
        if (!savedState || !savedState.isRunning || !savedState.endTime) return '';

        const now = Date.now();
        const timeLeft = Math.ceil((savedState.endTime - now) / 1000);

        if (timeLeft <= 0) return '';

        const d = Math.floor(timeLeft / (3600 * 24));
        const h = Math.floor((timeLeft % (3600 * 24)) / 3600);
        const m = Math.floor((timeLeft % 3600) / 60);
        const s = timeLeft % 60;

        let timeStr = "";
        if (d > 0) {
            timeStr = `${d}d ${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        } else {
            timeStr = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }
        
        const title = savedState.title ? ` (${savedState.title})` : '';

        return `<span id="bannerCountdownStatus" onclick="switchToClockTab('countdown')" class="text-blue-600 dark:text-blue-300 ml-4 text-sm cursor-pointer align-middle select-none" title="কাউন্টডাউন টাইমার দেখতে ক্লিক করুন"> | ⏳ ${timeStr}${title}</span>`;
    } catch (e) {
        return '';
    }
}

// --- ট্রিগার লজিক ---
function checkAlarmTrigger() {
    const now = new Date();
    const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

    if (currentTime === globalAlarmTimeValue && now.getSeconds() === 0) {
        if (!hasGlobalAlarmRung) {
            playGlobalAlarmSound();
            showCustomAlert(`⏰ অ্যালার্ম! এখন সময় ${formatTo12Hour(globalAlarmTimeValue)}`);
            
            const stopBtn = document.getElementById('stopAlarmBtn');
            if (stopBtn) stopBtn.classList.remove('hidden');
            
            hasGlobalAlarmRung = true;
            forceUpdateBanner();
        }
    } else if (currentTime !== globalAlarmTimeValue) {
        if (hasGlobalAlarmRung) {
            hasGlobalAlarmRung = false; 
        }
    }
}

// --- অডিও লজিক ---
function unlockAudioContext() {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    if (!globalAudioContext && AudioContext) {
        globalAudioContext = new AudioContext();
    }
    
    if (globalAudioContext) {
        if (globalAudioContext.state === 'suspended') {
            globalAudioContext.resume().then(() => {
                console.log("AudioContext resumed on interaction.");
            });
        }
        try {
            const buffer = globalAudioContext.createBuffer(1, 1, 22050);
            const source = globalAudioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(globalAudioContext.destination);
            source.start(0);
        } catch (e) {
            console.error("Failed to play silent buffer:", e);
        }
    }
}

async function playGlobalAlarmSound() {
    stopGlobalAlarmSound(); 

    try {
        const soundData = await idbGet('customAlarmSound');
        if (soundData && soundData.data) {
            const blob = new Blob([soundData.data], { type: soundData.type });
            const audioUrl = URL.createObjectURL(blob);
            const customAudio = new Audio(audioUrl);
            
            customAudio.loop = false;
            globalActiveAlarmSound = customAudio;
            
            const playPromise = customAudio.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.error("Custom audio play failed:", error);
                });
            }
            
            customAudio.onended = () => {
                URL.revokeObjectURL(audioUrl);
                stopGlobalAlarmSound(); 
            };
            return;
        }
    } catch (e) { console.error("Custom audio error", e); }

    try {
        if (!globalAudioContext) unlockAudioContext();
        const ctx = globalAudioContext;
        if (!ctx) return;

        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        
        const selectedSound = localStorage.getItem('alarmSound') || 'beep';
        const now = ctx.currentTime;

        if (selectedSound === 'chime') {
            oscillator.type = 'sine';
            for(let i = 0; i < 5; i++) { 
                let startTime = now + (i * 2);
                oscillator.frequency.setValueAtTime(880, startTime); 
                oscillator.frequency.setValueAtTime(1046.50, startTime + 0.6);
                gainNode.gain.setValueAtTime(0.5, startTime);
                gainNode.gain.linearRampToValueAtTime(0.1, startTime + 1.5);
                gainNode.gain.setValueAtTime(0, startTime + 1.9);
            }
        } else if (selectedSound === 'radar') {
            oscillator.type = 'sawtooth';
            oscillator.frequency.setValueAtTime(600, now);
            for(let i = 0; i < 10; i++) { 
                let startTime = now + i;
                gainNode.gain.setValueAtTime(0.5, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + 0.5);
            }
        } else { // beep
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(440, now);
            for(let i = 0; i < 10; i++) { 
                let startTime = now + i;
                gainNode.gain.setValueAtTime(0.5, startTime);
                gainNode.gain.setValueAtTime(0.5, startTime + 0.5);
                gainNode.gain.setValueAtTime(0, startTime + 0.51);
            }
        }

        oscillator.start(now);
        oscillator.stop(now + 10); 
        
        globalActiveAlarmSound = oscillator;
        oscillator.stopSound = function() { try { this.stop(); } catch(e){} };

        if (defaultSoundTimeout) clearTimeout(defaultSoundTimeout);
        defaultSoundTimeout = setTimeout(() => {
            stopGlobalAlarmSound();
        }, 10000); 

    } catch(e) { console.error("Oscillator error:", e); }
}

function stopGlobalAlarmSound() {
    if (globalActiveAlarmSound) {
        if (globalActiveAlarmSound.stopSound) globalActiveAlarmSound.stopSound();
        else if (globalActiveAlarmSound.pause) {
            globalActiveAlarmSound.pause();
            globalActiveAlarmSound.currentTime = 0;
        }
        globalActiveAlarmSound = null;
    }
    
    if (defaultSoundTimeout) clearTimeout(defaultSoundTimeout);

    const stopBtn = document.getElementById('stopAlarmBtn');
    if (stopBtn) stopBtn.classList.add('hidden');
    
    hasGlobalAlarmRung = false; 
    forceUpdateBanner();
}

// --- UI হেল্পার ---
function formatTo12Hour(timeString24) { 
    if (!timeString24) return '--:--'; 
    const [hours, minutes] = timeString24.split(':'); 
    const h = parseInt(hours, 10); 
    const m = parseInt(minutes, 10); 
    const ampm = h >= 12 ? 'PM' : 'AM'; 
    const hour12 = h % 12 || 12; 
    return `${String(hour12).padStart(2, '0')}:${String(m).padStart(2, '0')} ${ampm}`; 
}

function updateAlarmStatusUI() {
    const alarmStatus = document.getElementById('alarmStatus');
    if (!alarmStatus || !globalAlarmTimeValue) return;

    const time12hr = formatTo12Hour(globalAlarmTimeValue);
    const [tHours, tMinutes] = globalAlarmTimeValue.split(':').map(Number);
    const now = new Date();
    const target = new Date();
    target.setHours(tHours, tMinutes, 0, 0);
    if (target <= now && !hasGlobalAlarmRung) target.setDate(target.getDate() + 1);
    
    const diff = target - now;
    let remainingText = "";
    
    if (diff > 0) {
        const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
        const m = Math.floor((diff / (1000 * 60)) % 60);
        const s = Math.floor((diff / 1000) % 60);
        remainingText = `<br><span class="countdown text-sm text-gray-500">বাকি আছে: ${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}</span>`;
    }

    alarmStatus.innerHTML = `অ্যালার্ম সেট করা হয়েছে: ${time12hr} ${remainingText}`;
    alarmStatus.classList.add('active');
}

// --- ইনিশিয়ালাইজেশন কল ---
if (document.readyState === 'complete' || document.readyState === 'interactive') {
    initBackgroundAlarmSystem();
} else {
    document.addEventListener('DOMContentLoaded', initBackgroundAlarmSystem);
}


// --- ২. মেইন ট্যাব UI (ক্লক ট্যাব ফাংশনালিটি) ---
function initializeClockTab() {
    // স্টপওয়াচ ভেরিয়েবল
    const stopwatchDisplay = document.querySelector('.stopwatch-display');
    const startBtn = document.getElementById('startStopwatch');
    const stopBtn = document.getElementById('stopStopwatch');
    const resetBtn = document.getElementById('resetStopwatch');
    const lapBtn = document.getElementById('lapStopwatch');
    const lapsList = document.getElementById('lapsList');
    
    // টাইমার ভেরিয়েবল (এখন গ্লোবাল ব্যবহার করা হচ্ছে)
    let startTime = 0, elapsedTime = 0, isRunning = false, lapCounter = 0;

    // অ্যালার্ম ভেরিয়েবল
    const alarmTimeInput = document.getElementById('alarmTimeInput');
    const setAlarmBtn = document.getElementById('setAlarmBtn');
    const clearAlarmBtn = document.getElementById('clearAlarmBtn');
    const stopAlarmBtn = document.getElementById('stopAlarmBtn'); 
    const alarmStatus = document.getElementById('alarmStatus');
    const alarmSoundSelect = document.getElementById('alarmSoundSelect');
    const customAlarmSoundInput = document.getElementById('customAlarmSoundInput');
    const customAlarmFileName = document.getElementById('customAlarmFileName');
    const removeCustomAlarmSound = document.getElementById('removeCustomAlarmSound');

    // স্টপওয়াচ ফাংশন
    function formatStopwatchTime(ms) { 
        const date = new Date(ms); 
        const min = String(date.getUTCMinutes()).padStart(2, '0'); 
        const sec = String(date.getUTCSeconds()).padStart(2, '0'); 
        const mil = String(date.getUTCMilliseconds()).padStart(3, '0').substring(0, 2); 
        return `${min}:${sec}.${mil}`; 
    }
    function updateStopwatchDisplay() { if(stopwatchDisplay) stopwatchDisplay.textContent = formatStopwatchTime(elapsedTime); }
    
    // ফিক্স: গ্লোবাল টাইমার ব্যবহার
    if(startBtn && !startBtn.onclick) startBtn.onclick = () => { 
        if (!isRunning) { 
            startTime = Date.now() - elapsedTime; 
            if(globalStopwatchTimer) clearInterval(globalStopwatchTimer);
            globalStopwatchTimer = setInterval(() => { elapsedTime = Date.now() - startTime; updateStopwatchDisplay(); }, 10); 
            isRunning = true; 
        } 
    };
    if(stopBtn && !stopBtn.onclick) stopBtn.onclick = () => { 
        if (isRunning) { 
            clearInterval(globalStopwatchTimer); 
            isRunning = false; 
        } 
    };
    if(resetBtn && !resetBtn.onclick) resetBtn.onclick = () => { 
        clearInterval(globalStopwatchTimer); 
        isRunning = false; 
        elapsedTime = 0; 
        lapCounter = 0; 
        updateStopwatchDisplay(); 
        if(lapsList) lapsList.innerHTML = ''; 
    };
    if(lapBtn && !lapBtn.onclick) lapBtn.onclick = () => { 
        if (isRunning && lapsList) { 
            lapCounter++; 
            const li = document.createElement('li'); 
            li.innerHTML = `<span>ল্যাপ ${lapCounter}</span><span>${formatStopwatchTime(elapsedTime)}</span>`; 
            lapsList.prepend(li); 
        } 
    };

    // অ্যালার্ম ফাংশন
    async function setupAlarmUI(timeValue) {
        if (timeValue) {
            globalAlarmTimeValue = timeValue;
            hasGlobalAlarmRung = false;
            await idbSet('activeAlarm', { time: timeValue });
            
            forceUpdateBanner();
            updateAlarmStatusUI();
            showCustomAlert(`অ্যালার্ম ${formatTo12Hour(timeValue)} এর জন্য সেট করা হয়েছে।`);
        }
    }

    async function clearAlarmUI() {
        stopGlobalAlarmSound();
        globalAlarmTimeValue = null;
        hasGlobalAlarmRung = false;
        if(alarmTimeInput) alarmTimeInput.value = '';
        if(alarmStatus) { 
            alarmStatus.textContent = 'কোনো অ্যালার্ম সেট করা নেই।'; 
            alarmStatus.classList.remove('active'); 
        }
        
        await idbDelete('activeAlarm');
        forceUpdateBanner(); 
    }

    // ইভেন্ট লিসেনার
    if(setAlarmBtn) setAlarmBtn.onclick = () => { const val = alarmTimeInput.value; if(val) setupAlarmUI(val); else showCustomAlert('সময় সেট করুন।'); };
    if(clearAlarmBtn) clearAlarmBtn.onclick = () => { clearAlarmUI(); showCustomAlert('মুছে ফেলা হয়েছে।'); };
    if(stopAlarmBtn) stopAlarmBtn.onclick = () => { stopGlobalAlarmSound(); };

    // কাস্টম সাউন্ড হ্যান্ডলিং
    async function loadCustomAlarmSoundUI() {
        try {
            const soundData = await idbGet('customAlarmSound');
            if (soundData && soundData.data && customAlarmFileName) {
                customAlarmFileName.textContent = soundData.name;
                if(removeCustomAlarmSound) removeCustomAlarmSound.classList.remove('hidden');
            } else if(customAlarmFileName) {
                customAlarmFileName.textContent = 'কোনো ফাইল নেই';
                if(removeCustomAlarmSound) removeCustomAlarmSound.classList.add('hidden');
            }
        } catch (e) {}
    }

    if(customAlarmSoundInput) {
        customAlarmSoundInput.onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                await idbSet('customAlarmSound', { name: file.name, type: file.type, data: ev.target.result });
                loadCustomAlarmSoundUI();
                showCustomAlert('সাউন্ড সেট করা হয়েছে।');
            };
            reader.readAsArrayBuffer(file);
        };
    }
    
    if(removeCustomAlarmSound) {
        removeCustomAlarmSound.onclick = async () => { await idbDelete('customAlarmSound'); loadCustomAlarmSoundUI(); showCustomAlert('সাউন্ড মুছে ফেলা হয়েছে।'); };
    }

    if(alarmSoundSelect) {
        alarmSoundSelect.value = localStorage.getItem('alarmSound') || 'beep';
        alarmSoundSelect.onchange = () => localStorage.setItem('alarmSound', alarmSoundSelect.value);
    }

    if (globalAlarmTimeValue) {
        if(alarmTimeInput) alarmTimeInput.value = globalAlarmTimeValue;
        updateAlarmStatusUI();
        if (globalActiveAlarmSound && stopAlarmBtn) stopAlarmBtn.classList.remove('hidden');
    }
    loadCustomAlarmSoundUI();
	
    // --- কাউন্টডাউন টাইমার লজিক (আপডেটেড) ---
    const cdTitleInput = document.getElementById('cdTitle');
    const cdDaysInput = document.getElementById('cdDays');
    const cdHoursInput = document.getElementById('cdHours');
    const cdMinutesInput = document.getElementById('cdMinutes');
    const cdSecondsInput = document.getElementById('cdSeconds');
    const cdTargetDateTime = document.getElementById('cdTargetDateTime');
    const countdownDisplay = document.getElementById('countdownDisplay');
    const startCountBtn = document.getElementById('startCountdown');
    const pauseCountBtn = document.getElementById('pauseCountdown');
    const resetCountBtn = document.getElementById('resetCountdown');
    
    // মোড সিলেকশন রেডিও বাটন
    const cdModeRadios = document.getElementsByName('cdMode');
    const durationInputsDiv = document.getElementById('cdDurationInputs');
    const targetInputsDiv = document.getElementById('cdDateTimeInputs');

    let endTime = 0;
    let remainingTime = 0;
    let isCountdownRunning = false;
    let currentMode = 'duration'; // 'duration' or 'datetime'

    // মোড চেঞ্জ লজিক
    cdModeRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            currentMode = e.target.value;
            if (currentMode === 'duration') {
                durationInputsDiv.classList.remove('hidden');
                targetInputsDiv.classList.add('hidden');
                durationInputsDiv.style.display = 'grid'; 
            } else {
                durationInputsDiv.classList.add('hidden');
                durationInputsDiv.style.display = 'none'; 
                targetInputsDiv.classList.remove('hidden');
            }
        });
    });

// লোড স্টেট
    function loadCountdownState() {
        const savedState = JSON.parse(localStorage.getItem('countdownState'));
        if (savedState) {
            if (cdTitleInput) cdTitleInput.value = savedState.title || '';
            currentMode = savedState.mode || 'duration';
            
            // রেডিও বাটন আপডেট
            const radioToSelect = document.querySelector(`input[name="cdMode"][value="${currentMode}"]`);
            if (radioToSelect) {
                radioToSelect.checked = true;
                radioToSelect.dispatchEvent(new Event('change'));
            }

            if (savedState.isRunning) {
                const now = Date.now();
                const timeLeft = Math.ceil((savedState.endTime - now) / 1000);
                
                if (timeLeft > 0) {
                    endTime = savedState.endTime;
                    remainingTime = timeLeft;
                    isCountdownRunning = true;
                    
                    if(savedState.inputs) {
                        if(cdDaysInput) cdDaysInput.value = savedState.inputs.d || '';
                        cdHoursInput.value = savedState.inputs.h;
                        cdMinutesInput.value = savedState.inputs.m;
                        cdSecondsInput.value = savedState.inputs.s;
                        if(cdTargetDateTime) cdTargetDateTime.value = savedState.inputs.target || '';
                    }
                    
                    disableInputs(true);
                    updateButtons(true);
                    startInterval();
                } else {
                    // --- পরিবর্তন: রিফ্রেশ বা অন্য ট্যাবে থাকা অবস্থায় সময় শেষ হলে অ্যালার্ম বাজানো ---
                    
                    // ১. অ্যালার্ম বাজান
                    if(typeof playGlobalAlarmSound === 'function') playGlobalAlarmSound();
                
                    // ২. অ্যালার্ম স্টপ বাটন দৃশ্যমান করা (যাতে সাইডবার হাইলাইট হয়)
                    const stopAlarmBtn = document.getElementById('stopAlarmBtn');
                    if (stopAlarmBtn) stopAlarmBtn.classList.remove('hidden');

                    // ৩. পপআপ অ্যালার্ট দেখানো
                    const title = savedState.title || 'কাউন্টডাউন';
                    showCustomAlert(`⏳ ${title} শেষ!`);

                    // ৪. রিসেট করা
                    resetCountdown();
                    countdownDisplay.textContent = "সময় শেষ!";
                }
            } else if (savedState.remaining > 0) {
                remainingTime = savedState.remaining;
                if(savedState.inputs) {
                    if(cdDaysInput) cdDaysInput.value = savedState.inputs.d || '';
                    cdHoursInput.value = savedState.inputs.h;
                    cdMinutesInput.value = savedState.inputs.m;
                    cdSecondsInput.value = savedState.inputs.s;
                    if(cdTargetDateTime) cdTargetDateTime.value = savedState.inputs.target || '';
                }
                updateDisplay(remainingTime);
                disableInputs(true);
                startCountBtn.textContent = 'চালিয়ে যান';
                startCountBtn.classList.remove('hidden');
                pauseCountBtn.classList.add('hidden');
            }
        }
    }

    // সেভ স্টেট
    function saveCountdownState() {
        const state = {
            title: cdTitleInput.value,
            isRunning: isCountdownRunning,
            endTime: endTime,
            remaining: remainingTime,
            mode: currentMode,
            inputs: {
                d: cdDaysInput ? cdDaysInput.value : '',
                h: cdHoursInput.value,
                m: cdMinutesInput.value,
                s: cdSecondsInput.value,
                target: cdTargetDateTime ? cdTargetDateTime.value : ''
            }
        };
        localStorage.setItem('countdownState', JSON.stringify(state));
    }

    function updateDisplay(seconds) {
        const d = Math.floor(seconds / (3600 * 24));
        const h = Math.floor((seconds % (3600 * 24)) / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;

        let displayStr = "";
        const toBanglaNum = (n) => n.toString().replace(/\d/g, d => "০১২৩৪৫৬৭৮৯"[d]);
        
        if (d > 0) {
             displayStr = `${toBanglaNum(String(d).padStart(2, '0'))} দিন ${toBanglaNum(String(h).padStart(2, '0'))} : ${toBanglaNum(String(m).padStart(2, '0'))} : ${toBanglaNum(String(s).padStart(2, '0'))}`;
             countdownDisplay.style.fontSize = "1.8rem";
        } else {
             displayStr = `${toBanglaNum(String(h).padStart(2, '0'))} : ${toBanglaNum(String(m).padStart(2, '0'))} : ${toBanglaNum(String(s).padStart(2, '0'))}`;
             countdownDisplay.style.fontSize = "2.5rem";
        }
        
        countdownDisplay.textContent = displayStr;
        if(typeof forceUpdateBanner === 'function') forceUpdateBanner(); 
    }

function startInterval() {
        clearInterval(globalCountdownInterval);
        
        const tick = () => {
            const now = Date.now();
            const left = Math.ceil((endTime - now) / 1000);
            
            if (left <= 0) {
                clearInterval(globalCountdownInterval);
                isCountdownRunning = false;
                remainingTime = 0;
                updateDisplay(0);
                if(typeof playGlobalAlarmSound === 'function') playGlobalAlarmSound();
                
                // নতুন: কাউন্টডাউন শেষ হলে অ্যালার্ম স্টপ বাটন দৃশ্যমান করা (এর ফলে সাইডবার হাইলাইট হবে)
                const stopAlarmBtn = document.getElementById('stopAlarmBtn');
                if (stopAlarmBtn) stopAlarmBtn.classList.remove('hidden');

                showCustomAlert(`⏳ ${cdTitleInput.value || 'কাউন্টডাউন'} শেষ!`);
                
                startCountBtn.classList.remove('hidden');
                startCountBtn.textContent = "শুরু";
                pauseCountBtn.classList.add('hidden');
                disableInputs(false);
                
                localStorage.removeItem('countdownState');
                if(typeof forceUpdateBanner === 'function') forceUpdateBanner();
                
            } else {
                remainingTime = left;
                updateDisplay(remainingTime);
            }
        };

        tick();
        globalCountdownInterval = setInterval(tick, 1000);
    }

    function startCountdown() {
        if (isCountdownRunning) return;

        if (remainingTime > 0 && startCountBtn.textContent === 'চালিয়ে যান') {
            endTime = Date.now() + remainingTime * 1000;
        } else {
            let totalSec = 0;

            if (currentMode === 'duration') {
                const d = parseInt(cdDaysInput.value) || 0;
                const h = parseInt(cdHoursInput.value) || 0;
                const m = parseInt(cdMinutesInput.value) || 0;
                const s = parseInt(cdSecondsInput.value) || 0;
                totalSec = (d * 86400) + (h * 3600) + (m * 60) + s;
                endTime = Date.now() + totalSec * 1000;
            } else {
                // Target Date Mode
                const targetVal = cdTargetDateTime.value;
                if (!targetVal) {
                    showCustomAlert('অনুগ্রহ করে তারিখ ও সময় নির্বাচন করুন।');
                    return;
                }
                const targetTime = new Date(targetVal).getTime();
                const now = Date.now();
                totalSec = Math.floor((targetTime - now) / 1000);
                endTime = targetTime;
            }

            if (totalSec <= 0) {
                showCustomAlert('অনুগ্রহ করে ভবিষ্যতের কোনো সময় সেট করুন।');
                return;
            }
            remainingTime = totalSec;
        }

        isCountdownRunning = true;
        disableInputs(true);
        updateButtons(true);
        startInterval();
        saveCountdownState();
    }

    function pauseCountdown() {
        clearInterval(globalCountdownInterval);
        isCountdownRunning = false;
        updateButtons(false);
        startCountBtn.textContent = 'চালিয়ে যান';
        saveCountdownState();
        if(typeof forceUpdateBanner === 'function') forceUpdateBanner();
    }

    function resetCountdown() {
        clearInterval(globalCountdownInterval);
        isCountdownRunning = false;
        remainingTime = 0;
        endTime = 0;
        
        if(cdDaysInput) cdDaysInput.value = '';
        cdHoursInput.value = '';
        cdMinutesInput.value = '';
        cdSecondsInput.value = '';
        if(cdTargetDateTime) cdTargetDateTime.value = '';
        
        countdownDisplay.textContent = "০০ : ০০ : ০০ : ০০";
        
        disableInputs(false);
        updateButtons(false);
        startCountBtn.textContent = 'শুরু';
        
        localStorage.removeItem('countdownState');
        if(typeof forceUpdateBanner === 'function') forceUpdateBanner();
    }

    function disableInputs(disabled) {
        if(cdDaysInput) cdDaysInput.disabled = disabled;
        cdHoursInput.disabled = disabled;
        cdMinutesInput.disabled = disabled;
        cdSecondsInput.disabled = disabled;
        if(cdTargetDateTime) cdTargetDateTime.disabled = disabled;
        cdModeRadios.forEach(r => r.disabled = disabled);
    }

    function updateButtons(running) {
        if (running) {
            startCountBtn.classList.add('hidden');
            pauseCountBtn.classList.remove('hidden');
        } else {
            startCountBtn.classList.remove('hidden');
            pauseCountBtn.classList.add('hidden');
        }
    }

    if (startCountBtn) startCountBtn.onclick = startCountdown;
    if (pauseCountBtn) pauseCountBtn.onclick = pauseCountdown;
    if (resetCountBtn) resetCountBtn.onclick = resetCountdown;
    
    if (cdTitleInput) {
        cdTitleInput.addEventListener('input', () => {
            if (!isCountdownRunning && remainingTime === 0) {
                 localStorage.setItem('countdownState', JSON.stringify({ title: cdTitleInput.value }));
            } else {
                saveCountdownState();
            }
        });
    }

    loadCountdownState();
    // --- কাউন্টডাউন টাইমার লজিক শেষ ---
	
    // ওয়ার্ল্ড ক্লক ইনিশিয়ালাইজেশন
    initializeWorldClock();
}

// ওয়ার্ল্ড ক্লক ফাংশন
function initializeWorldClock() {
    const worldClockGrid = document.querySelector('.world-clock-grid');
    const timezoneSelect = document.getElementById('timezone-select');
    const timezonesWithCountries = [
        { zone: 'Asia/Dhaka', city: 'ঢাকা', country: 'বাংলাদেশ' }, { zone: 'Asia/Kolkata', city: 'কলকাতা', country: 'ভারত' },
        { zone: 'Asia/Karachi', city: 'করাচি', country: 'পাকিস্তান' }, { zone: 'Asia/Riyadh', city: 'রিয়াদ', country: 'সৌদি আরব' },
        { zone: 'Asia/Dubai', city: 'দুবাই', country: 'সংযুক্ত আরব আমিরাত' }, { zone: 'Asia/Muscat', city: 'মাস্কাট', country: 'ওমান' },
        { zone: 'Asia/Qatar', city: 'দোহা', country: 'কাতার' }, { zone: 'Asia/Kuwait', city: 'কুয়েত সিটি', country: 'কুয়েত' },
        { zone: 'Asia/Bahrain', city: 'মানামা', country: 'বাহরাইন' }, { zone: 'Asia/Kuala_Lumpur', city: 'কুয়ালালামপুর', country: 'মালয়েশিয়া' },
        { zone: 'Asia/Singapore', city: 'সিঙ্গাপুর', country: 'সিঙ্গাপুর' }, { zone: 'Asia/Tokyo', city: 'টোকিও', country: 'জাপান' },
        { zone: 'Asia/Seoul', city: 'সিওল', country: 'দক্ষিণ কোরিয়া' }, { zone: 'Europe/London', city: 'লন্ডন', country: 'যুক্তরাজ্য' },
        { zone: 'Europe/Rome', city: 'রোম', country: 'ইতালি' }, { zone: 'Europe/Paris', city: 'প্যারিস', country: 'ফ্রান্স' },
        { zone: 'Europe/Berlin', city: 'বার্লিন', country: 'জার্মানি' }, { zone: 'Europe/Moscow', city: 'মস্কো', country: 'রাশিয়া' },
        { zone: 'America/New_York', city: 'নিউ ইয়র্ক', country: 'মার্কিন যুক্তরাষ্ট্র' }, { zone: 'America/Los_Angeles', city: 'লস অ্যাঞ্জেলেস', country: 'মার্কিন যুক্তরাষ্ট্র' },
        { zone: 'America/Toronto', city: 'টরন্টো', country: 'কানাডা' }, { zone: 'Australia/Sydney', city: 'সিডনি', country: 'অস্ট্রেলিয়া' }
    ];
    const defaultTimezones = timezonesWithCountries.filter(tz => ['Asia/Dhaka', 'Asia/Kolkata', 'Europe/London', 'America/New_York', 'Asia/Tokyo', 'Australia/Sydney', 'Asia/Dubai', 'Europe/Moscow'].includes(tz.zone));

    function createWorldClockCard(tz, selectedZone) {
        const card = document.createElement('div');
        card.className = 'world-clock-card';
        if (selectedZone && tz.zone === selectedZone) card.id = 'selected-timezone-card';
        const timeId = `time-${tz.zone.replace(/\//g, '-')}`;
        const dateId = `date-${tz.zone.replace(/\//g, '-')}`;
        card.innerHTML = `<div class="city">${tz.city}</div><div class="country">${tz.country || ''}</div><div class="time" id="${timeId}">--:--:--</div><div class="date" id="${dateId}">...</div>`;
        return card;
    }

    function rebuildWorldClockGrid() {
        if (!worldClockGrid) return;
        worldClockGrid.innerHTML = '';
        const selectedZone = timezoneSelect ? timezoneSelect.value : null;
        let displayList = [...defaultTimezones];
        
        if (selectedZone) {
            const selectedTz = timezonesWithCountries.find(tz => tz.zone === selectedZone);
            if (selectedTz) {
                displayList = [selectedTz, ...displayList.filter(tz => tz.zone !== selectedZone)];
            }
        }
        
        const uniqueMap = new Map();
        displayList.forEach(item => uniqueMap.set(item.zone, item));
        const uniqueList = Array.from(uniqueMap.values());

        uniqueList.forEach(tz => worldClockGrid.appendChild(createWorldClockCard(tz, selectedZone)));
        updateWorldClocksText();
    }

    function updateWorldClocksText() {
        if (!worldClockGrid) return;
        const now = new Date();
        const cards = worldClockGrid.querySelectorAll('.world-clock-card');
        cards.forEach(card => {
            const timeEl = card.querySelector('.time');
            const dateEl = card.querySelector('.date');
            const zoneId = timeEl.id.replace('time-', '').replace(/-/g, '/');
            const foundTz = timezonesWithCountries.find(tz => timeEl.id === `time-${tz.zone.replace(/\//g, '-')}`);
            
            if (foundTz) {
                timeEl.textContent = now.toLocaleTimeString('bn-BD', { timeZone: foundTz.zone, hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
                dateEl.textContent = now.toLocaleDateString('bn-BD', { timeZone: foundTz.zone, weekday: 'short', day: 'numeric', month: 'long' });
            }
        });
    }

    if (timezoneSelect && timezoneSelect.children.length <= 1) {
        timezonesWithCountries.forEach(tz => { 
            const option = document.createElement('option'); 
            option.value = tz.zone; 
            option.textContent = `${tz.city}, ${tz.country}`; 
            timezoneSelect.appendChild(option); 
        }); 
        const savedZone = localStorage.getItem('selectedWorldClockTimezone');
        if (savedZone) timezoneSelect.value = savedZone;
        
        timezoneSelect.onchange = () => {
            const val = timezoneSelect.value;
            if (val) localStorage.setItem('selectedWorldClockTimezone', val);
            else localStorage.removeItem('selectedWorldClockTimezone');
            rebuildWorldClockGrid();
        };
    }

    if (window.worldClockIntervalId) clearInterval(window.worldClockIntervalId);
    rebuildWorldClockGrid();
    window.worldClockIntervalId = setInterval(updateWorldClocksText, 1000);
}

// ====================================================================
// END: CLOCK TAB SCRIPT (STOPWATCH, ALARM, WORLD CLOCK)
// ====================================================================

// ====================================================================
// START: VISITOR COUNTER SCRIPT (গুরুত্বপূর্ণ লিংকসমূহ ট্যাব)
// ====================================================================

// --- ভিজিট গণনা এবং সেভ করার লজিক (এই অংশটি পেজ লোড হওয়ার সাথে সাথে একবারই রান হবে) ---
(function incrementVisitCounters() {
    // মোট ভিজিট গণনা
    let totalVisits = localStorage.getItem('totalVisits');
    totalVisits = totalVisits ? parseInt(totalVisits, 10) + 1 : 1;
    localStorage.setItem('totalVisits', totalVisits);

    // আজকের ভিজিট গণনা
    const today = new Date().toISOString().split('T')[0];
    let todaysData = localStorage.getItem('todaysData');
    try {
        todaysData = todaysData ? JSON.parse(todaysData) : { date: today, count: 0 };
    } catch (e) {
        todaysData = { date: today, count: 0 };
    }

    if (todaysData.date === today) {
        todaysData.count += 1;
    } else {
        todaysData = { date: today, count: 1 };
    }
    localStorage.setItem('todaysData', JSON.stringify(todaysData));
})(); // Immediately Invoked Function Expression (IIFE) to run once on script load.


// --- সেভ করা ভিজিট সংখ্যা প্রদর্শনের ফাংশন ---
function displayVisitorCount() {
    const todayVisitsEl = document.getElementById('today-visits');
    const totalVisitsEl = document.getElementById('total-visits');

    if (todayVisitsEl && totalVisitsEl) {
        const totalVisits = localStorage.getItem('totalVisits') || '1';
        const todaysData = JSON.parse(localStorage.getItem('todaysData')) || { count: 1 };
        
        totalVisitsEl.textContent = parseInt(totalVisits).toLocaleString('bn-BD');
        todayVisitsEl.textContent = todaysData.count.toLocaleString('bn-BD');
    }
}

// যখন "গুরুত্বপূর্ণ লিংকসমূহ" ট্যাবটি দেখানো হবে, তখন কাউন্টার প্রদর্শন করুন
const importantLinksTabForCounter = document.getElementById('importantLinksTab');
if (importantLinksTabForCounter) {
    importantLinksTabForCounter.addEventListener('click', () => {
        // Tab click করলে DOM এ এলিমেন্টগুলো থাকবে, তাই এখানে display function কল করা নিরাপদ
        setTimeout(displayVisitorCount, 0); 
    });
    
    // পেজ লোডের সময় ট্যাবটি সক্রিয় থাকলে কাউন্টার প্রদর্শন করুন
    if (importantLinksTabForCounter.classList.contains('active')) {
         displayVisitorCount();
    }
}
// ====================================================================
// END: VISITOR COUNTER SCRIPT
// ====================================================================

// ====================================================================
// START: WEB SEARCH BROWSER SCRIPT (Updated Modal Style)
// ====================================================================
function initializeWebSearch() {
    const webSearchContent = document.getElementById('webSearchContent');
    const addressBar = document.getElementById('browserAddress');
    const goBtn = document.getElementById('browserGoBtn');
    const openExternalBtn = document.getElementById('browserOpenExternalBtn');
    const homeBtn = document.getElementById('browserHomeBtn');
    const iframe = document.getElementById('browserFrame');
    const addShortcutBtn = document.getElementById('addShortcutBtn');
    const shortcutsContainer = document.getElementById('shortcutsContainer');

    if (!webSearchContent || !iframe) return;

    // ডিফল্ট হোমপেজ - Bangla Toolbox Search (igu=1 প্যারামিটারসহ যা আইফ্রেম সাপোর্ট করে)
    const homePage = "https://www.google.com/search?igu=1&q=Bangla+Toolbox"; 

    // ১. লেজি লোডিং এবং রিসেট
    if (!iframe.getAttribute('src') || iframe.getAttribute('src') === "" || iframe.getAttribute('src') === "about:blank") {
        iframe.setAttribute('src', homePage);
    }

    // ২. ডুপ্লিকেট ইভেন্ট লিসেনার রোধ
    if (webSearchContent.getAttribute('data-browser-initialized') === 'true') {
        return; 
    }
    webSearchContent.setAttribute('data-browser-initialized', 'true');

    // --- ৩. প্রো-অ্যাক্টিভ ব্লক লিস্ট (অনেক সাইট আইফ্রেম ব্লক করে) ---
    const blockedDomains = [
        'facebook.com', 'www.facebook.com', 'm.facebook.com',
        'instagram.com', 'www.instagram.com',
        'twitter.com', 'x.com', 'mobile.twitter.com',
        'linkedin.com', 'www.linkedin.com',
        'youtube.com', 'www.youtube.com', 'youtu.be', 'm.youtube.com',
        'github.com', 'www.github.com',
        'pinterest.com', 'www.pinterest.com',
        'reddit.com', 'www.reddit.com',
        'netflix.com', 'www.netflix.com',
        'quora.com', 'www.quora.com',
        'tiktok.com', 'www.tiktok.com',
        'chatgpt.com', 'openai.com',
        'whatsapp.com', 'web.whatsapp.com',
        'messenger.com', 'www.messenger.com',
        'amazon.com', 'www.amazon.com',
        'yahoo.com', 'www.yahoo.com', 'mail.yahoo.com',
        'stackoverflow.com',
        'medium.com',
        'udemy.com',
        'coursera.org',
        'spotify.com', 'open.spotify.com'
    ];

    // --- নতুন: কাস্টম কনফার্মেশন মডাল (আইফ্রেম এরর এর জন্য) ---
    function showWebConfirmation(url) {
        // আগের কোনো মডাল থাকলে সরিয়ে ফেলুন
        const existingModal = document.getElementById('web-custom-modal');
        if (existingModal) existingModal.remove();

        const overlay = document.createElement('div');
        overlay.id = 'web-custom-modal';
        overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(3px); animation: fadeIn 0.2s ease-out;';
        
        const modal = document.createElement('div');
        // জরুরি নাম্বারের মতো স্টাইল
        modal.style.cssText = 'background: white; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.3); max-width: 380px; width: 90%; transform: scale(0.9); transition: transform 0.2s ease;';
        
        // ডার্ক মোড সাপোর্ট
        if (document.documentElement.classList.contains('dark')) {
            modal.style.background = '#2d3748';
            modal.style.color = '#e2e8f0';
            modal.style.borderColor = '#4a5568';
        }

        modal.innerHTML = `
            <div style="margin-bottom: 15px; color: #f59e0b; font-size: 3rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="margin: 0 auto;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 10px;">ওয়েবসাইট লোড করা যাচ্ছে না!</h3>
            <p style="margin-bottom: 25px; font-size: 1rem; line-height: 1.5; opacity: 0.9;">এই ওয়েবসাইটটি আইফ্রেমে সাপোর্ট করে না। আপনি কি এটি <b>নতুন ট্যাবে</b> খুলতে চান?</p>
            <div style="display: flex; justify-content: center; gap: 15px;">
                <button id="webModalYes" style="padding: 10px 25px; border: none; border-radius: 8px; background: #10b981; color: white; cursor: pointer; font-weight: 600; flex: 1; transition: transform 0.1s;">হ্যাঁ</button>
                <button id="webModalNo" style="padding: 10px 25px; border: none; border-radius: 8px; background: #ef4444; color: white; cursor: pointer; font-weight: 600; flex: 1; transition: transform 0.1s;">না</button>
            </div>
        `;
        
        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // এনিমেশন
        setTimeout(() => {
            modal.style.transform = 'scale(1)';
        }, 10);

        const closeModal = () => {
            modal.style.transform = 'scale(0.9)';
            overlay.style.opacity = '0';
            setTimeout(() => {
                if (overlay.parentNode) document.body.removeChild(overlay);
            }, 200);
        };

        document.getElementById('webModalYes').onclick = () => {
            window.open(url, '_blank');
            closeModal();
        };
        
        document.getElementById('webModalNo').onclick = closeModal;
        
        // ব্যাকগ্রাউন্ডে ক্লিক করলে বন্ধ
        overlay.onclick = (e) => {
            if (e.target === overlay) closeModal();
        };
    }

    // --- নতুন: শর্টকাট ডিলিট করার জন্য কাস্টম কনফার্মেশন মডাল ---
    function showShortcutDeleteConfirmation(name, onConfirm) {
        // আগের কোনো মডাল থাকলে সরিয়ে ফেলুন
        const existingModal = document.getElementById('web-custom-modal');
        if (existingModal) existingModal.remove();

        const overlay = document.createElement('div');
        overlay.id = 'web-custom-modal'; // Reusing ID for consistency
        overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(3px); animation: fadeIn 0.2s ease-out;';
        
        const modal = document.createElement('div');
        modal.style.cssText = 'background: white; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.3); max-width: 380px; width: 90%; transform: scale(0.9); transition: transform 0.2s ease;';
        
        if (document.documentElement.classList.contains('dark')) {
            modal.style.background = '#2d3748';
            modal.style.color = '#e2e8f0';
            modal.style.borderColor = '#4a5568';
        }

        // ট্র্যাশ আইকন ব্যবহার করা হয়েছে
        modal.innerHTML = `
            <div style="margin-bottom: 15px; color: #ef4444; font-size: 3rem;">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="margin: 0 auto;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </div>
            <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 10px;">শর্টকাট মুছে ফেলতে চান?</h3>
            <p style="margin-bottom: 25px; font-size: 1rem; line-height: 1.5; opacity: 0.9;">আপনি কি নিশ্চিত যে আপনি <b>"${name}"</b> শর্টকাটটি মুছে ফেলতে চান?</p>
            <div style="display: flex; justify-content: center; gap: 15px;">
                <button id="webModalYes" style="padding: 10px 25px; border: none; border-radius: 8px; background: #ef4444; color: white; cursor: pointer; font-weight: 600; flex: 1; transition: transform 0.1s;">হ্যাঁ, মুছুন</button>
                <button id="webModalNo" style="padding: 10px 25px; border: none; border-radius: 8px; background: #6b7280; color: white; cursor: pointer; font-weight: 600; flex: 1; transition: transform 0.1s;">না</button>
            </div>
        `;
        
        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        setTimeout(() => {
            modal.style.transform = 'scale(1)';
        }, 10);

        const closeModal = () => {
            modal.style.transform = 'scale(0.9)';
            overlay.style.opacity = '0';
            setTimeout(() => {
                if (overlay.parentNode) document.body.removeChild(overlay);
            }, 200);
        };

        document.getElementById('webModalYes').onclick = () => {
            onConfirm();
            closeModal();
        };
        
        document.getElementById('webModalNo').onclick = closeModal;
        
        overlay.onclick = (e) => {
            if (e.target === overlay) closeModal();
        };
    }

    // ইউআরএল প্রসেস এবং নেভিগেশন ফাংশন (গো বাটন/এন্টার এর জন্য)
    function navigateToUrl() {
        let query = addressBar.value.trim();
        if (!query) return;

        let url;
        // ইউআরএল ভ্যালিডেশন এবং ফরম্যাটিং
        if (/^(http|https):\/\/[^ "]+$/.test(query)) {
            url = query;
        } else if (/^[^ "]+(\.[a-z]{2,})+/.test(query)) {
            url = "https://" + query;
        } else {
            // সার্চের জন্য গুগল ব্যবহার করা নিরাপদ (igu=1)
            url = `https://www.google.com/search?igu=1&q=${encodeURIComponent(query)}`;
        }

        // --- ব্লকড ডোমেইন চেক ---
        const lowerUrl = url.toLowerCase();
        const isBlocked = blockedDomains.some(domain => lowerUrl.includes(domain));

        if (isBlocked) {
            // যদি ব্লকড তালিকায় থাকে, তবে কাস্টম পপআপ দেখান (কারণ এটি আইফ্রেমে লোড হবে না)
            showWebConfirmation(url);
        } else {
            // অন্যথায় আইফ্রেমে লোড করার চেষ্টা করুন
            iframe.src = url;
        }
    }

    // লাল বাটন (বাইরে খুলুন) এর জন্য লজিক - এখন সরাসরি নতুন ট্যাবে খুলবে (পপআপ ছাড়া)
    function openExternalUrl() {
        let query = addressBar.value.trim();
        let url;
        
        if (!query) {
            // যদি ইনপুট খালি থাকে, তবে ডিফল্ট গুগল খুলুন
             url = "https://www.google.com";
        } else {
            if (/^(http|https):\/\/[^ "]+$/.test(query)) {
                url = query;
            } else if (/^[^ "]+(\.[a-z]{2,})+/.test(query)) {
                url = "https://" + query;
            } else {
                url = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
            }
        }
        
        // লাল বাটনে ক্লিক করলে সরাসরি নতুন ট্যাবে ওপেন হবে
        window.open(url, '_blank');
    }

    function goHome() {
        iframe.src = homePage;
        addressBar.value = "";
    }

    // --- কাস্টম শর্টকাট লজিক ---
    function loadShortcuts() {
        const savedShortcuts = JSON.parse(localStorage.getItem('customWebShortcuts') || '[]');
        const existingCustomBtns = shortcutsContainer.querySelectorAll('.custom-shortcut-btn');
        existingCustomBtns.forEach(btn => btn.remove());

        savedShortcuts.forEach((shortcut, index) => {
            createShortcutButton(shortcut.name, shortcut.url, index);
        });
    }

    function createShortcutButton(name, url, index) {
        const btn = document.createElement('button');
        btn.className = 'custom-shortcut-btn px-3 py-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-full text-sm font-semibold hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors text-gray-700 dark:text-gray-200';
        btn.textContent = name;
        btn.title = `খুলুন: ${url} (মুছতে রাইট ক্লিক করুন)`;
        btn.onclick = () => window.open(url, '_blank');
        btn.oncontextmenu = (e) => {
            e.preventDefault();
            // কাস্টম ডিলিট কনফার্মেশন পপআপ ব্যবহার করা হচ্ছে
            showShortcutDeleteConfirmation(name, () => {
                deleteShortcut(index);
            });
        };
        shortcutsContainer.insertBefore(btn, addShortcutBtn);
    }

    function addNewShortcut() {
        const name = prompt("শর্টকাটের নাম দিন (যেমন: LinkedIn):");
        if (!name || name.trim() === "") return;
        let url = prompt("ওয়েবসাইটের লিংক দিন (যেমন: linkedin.com):");
        if (!url || url.trim() === "") return;
        if (!/^https?:\/\//i.test(url)) url = 'https://' + url;

        const shortcuts = JSON.parse(localStorage.getItem('customWebShortcuts') || '[]');
        shortcuts.push({ name: name.trim(), url: url.trim() });
        localStorage.setItem('customWebShortcuts', JSON.stringify(shortcuts));
        loadShortcuts();
        showCustomAlert('শর্টকাট যুক্ত হয়েছে!');
    }

    function deleteShortcut(index) {
        const shortcuts = JSON.parse(localStorage.getItem('customWebShortcuts') || '[]');
        shortcuts.splice(index, 1);
        localStorage.setItem('customWebShortcuts', JSON.stringify(shortcuts));
        loadShortcuts();
        showCustomAlert('শর্টকাট মুছে ফেলা হয়েছে!');
    }

    // --- ইভেন্ট লিসেনার ---
    if (goBtn) goBtn.onclick = navigateToUrl;
    if (openExternalBtn) openExternalBtn.onclick = openExternalUrl; // লাল বাটনে ক্লিক করলে এখন সরাসরি ওপেন হবে
    if (homeBtn) homeBtn.onclick = goHome;
    if (addShortcutBtn) addShortcutBtn.onclick = addNewShortcut;

    if (addressBar) {
        addressBar.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                navigateToUrl();
            }
        });
    }

    loadShortcuts();
}
// ====================================================================
// END: WEB SEARCH BROWSER SCRIPT
// ====================================================================
// ========================================================
// START: NEW FEATURES FUNCTIONS (রেকর্ডার, জেসন, মিম, স্পিড)
// ========================================================

// 1. Screen Recorder Function
// ========================================================
// START: Screen Recorder Function (Updated with Delete Button)
// ========================================================
function initializeScreenRecorder() {
    const startBtn = document.getElementById('startRecordBtn');
    const stopBtn = document.getElementById('stopRecordBtn');
    const preview = document.getElementById('recordingPreview');
    const downloadBtn = document.getElementById('downloadVideoBtn');
    
    // ডিলিট বাটন তৈরি এবং সেটআপ (যদি না থাকে)
    let deleteBtn = document.getElementById('deleteRecordBtn');
    if (!deleteBtn && downloadBtn) {
        deleteBtn = document.createElement('button');
        deleteBtn.id = 'deleteRecordBtn';
        deleteBtn.className = 'hidden bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg ml-2';
        deleteBtn.innerText = 'মুছুন';
        // ডাউনলোড বাটনের পরে ইনজেক্ট করুন
        downloadBtn.parentNode.insertBefore(deleteBtn, downloadBtn.nextSibling);
    }

    let mediaRecorder;
    let recordedChunks = [];
    let stream = null;

    if(!startBtn) return;

    startBtn.onclick = async () => {
        try {
            // অডিও সহ স্ক্রিন রেকর্ড করার পারমিশন
            stream = await navigator.mediaDevices.getDisplayMedia({ 
                video: true, 
                audio: true 
            });
            
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };

            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                
                // প্রিভিউ ভিডিও সেটআপ
                preview.src = url;
                preview.classList.remove('hidden');
                preview.controls = true;
                preview.load(); 
                
                downloadBtn.href = url;
                downloadBtn.download = `screen-recording-${Date.now()}.webm`;
                downloadBtn.classList.remove('hidden'); // ডাউনলোড বাটন দৃশ্যমান করা
                deleteBtn.classList.remove('hidden'); // ডিলিট বাটন দৃশ্যমান করা
                
                stopBtn.classList.add('hidden');
                startBtn.classList.remove('hidden');
                startBtn.innerText = "নতুন রেকর্ডিং শুরু করুন";
                
                // স্ট্রিম পুরোপুরি বন্ধ করা
                if (stream) stream.getTracks().forEach(track => track.stop());
            };

            mediaRecorder.start();
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            stopBtn.disabled = false;
            
            // রিসেট
            recordedChunks = [];
            preview.classList.add('hidden');
            downloadBtn.classList.add('hidden');
            deleteBtn.classList.add('hidden');

        } catch (err) {
            console.error("Error: " + err);
            showCustomAlert("রেকর্ডিং শুরু করা যায়নি বা বাতিল করা হয়েছে। শুধুমাত্র ডেক্সটপে রেকর্ড করা যাবে।");
        }
    };

    stopBtn.onclick = () => {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
    };

    // ডিলিট বাটনের লজিক
    deleteBtn.onclick = () => {
        if (confirm("আপনি কি নিশ্চিত যে আপনি রেকর্ডিংটি মুছে ফেলতে চান?")) {
            preview.src = "";
            preview.classList.add('hidden');
            downloadBtn.classList.add('hidden');
            deleteBtn.classList.add('hidden');
            recordedChunks = [];
            showCustomAlert("রেকর্ডিং মুছে ফেলা হয়েছে।");
        }
    };
}
// ========================================================
// END: Screen Recorder Function
// ========================================================

// 2. JSON Formatter Function
// ========================================================
// START: JSON Formatter Function
// ========================================================
function initializeJsonFormatter() {
    const input = document.getElementById('jsonInput');
    const output = document.getElementById('jsonOutput');
    const formatBtn = document.getElementById('formatJsonBtn');
    const minifyBtn = document.getElementById('minifyJsonBtn');
    const copyBtn = document.getElementById('copyJsonBtn');
    const clearBtn = document.getElementById('clearJsonBtn');

    if(!formatBtn) return;

    formatBtn.onclick = () => {
        try {
            const raw = JSON.parse(input.value);
            output.value = JSON.stringify(raw, null, 4); // 4 space indent
            output.style.color = ''; 
        } catch (e) {
            output.value = "অবৈধ JSON: " + e.message;
            output.style.color = 'red';
        }
    };

    minifyBtn.onclick = () => {
        try {
            const raw = JSON.parse(input.value);
            output.value = JSON.stringify(raw);
            output.style.color = '';
        } catch (e) {
            output.value = "অবৈধ JSON: " + e.message;
            output.style.color = 'red';
        }
    };

    copyBtn.onclick = () => {
        const textToCopy = output.value;
        if(textToCopy && !textToCopy.startsWith("অবৈধ JSON")) {
            // আইফ্রেম বা সাধারণ পরিবেশে কাজ করার জন্য নিরাপদ পদ্ধতি
            const tempTextArea = document.createElement("textarea");
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand("copy");
            document.body.removeChild(tempTextArea);
            
            showCustomAlert('JSON ফলাফল কপি করা হয়েছে!');
        } else {
            showCustomAlert('কপি করার জন্য সঠিক আউটপুট নেই।');
        }
    };

    clearBtn.onclick = () => {
        input.value = '';
        output.value = '';
    };
}
// ========================================================
// END: JSON Formatter Function
// ========================================================

// 3. Meme Generator Function
// ========================================================
// START: Meme Generator Function (Updated with Text Edit on Double Click)
// ========================================================
function initializeMemeGenerator() {
    const container = document.getElementById('memeGenContent');
    if (!container) return;

    const imageInput = document.getElementById('memeImageInput');
    const textInput = document.getElementById('memeTextInput');
    const addTextBtn = document.getElementById('addMemeTextBtn');
    const cancelEditBtn = document.getElementById('cancelMemeEditBtn'); // নতুন বাটন
    const overlayInput = document.getElementById('memeOverlayInput');
    const colorInput = document.getElementById('memeTextColor');
    const noFillCheckbox = document.getElementById('memeNoFill'); // নতুন ফিল নেই চেকবক্স
    const borderColorInput = document.getElementById('memeBorderColor');
    const noBorderCheckbox = document.getElementById('memeNoBorder'); // নতুন বর্ডার নেই চেকবক্স
    const fontSizeInput = document.getElementById('memeFontSize');
    const canvas = document.getElementById('memeCanvas');
    const ctx = canvas.getContext('2d');
    const downloadBtn = document.getElementById('downloadMemeBtn');
    const placeholder = document.getElementById('memePlaceholderText');

    const alignLeftBtn = document.getElementById('alignLeftBtn');
    const alignCenterBtn = document.getElementById('alignCenterBtn');
    const alignRightBtn = document.getElementById('alignRightBtn');
    
    // শেপ বাটন
    const addRectBtn = document.getElementById('addRectBtn');
    const addCircleBtn = document.getElementById('addCircleBtn');
    const addTriangleBtn = document.getElementById('addTriangleBtn');
    const addStarBtn = document.getElementById('addStarBtn');

    // ব্রাশ টুল এবং হিস্টোরি ভেরিয়েবল
    const brushToggleBtn = document.getElementById('memeBrushToggleBtn');
    const brushSettings = document.getElementById('memeBrushSettings');
    const brushColorInput = document.getElementById('memeBrushColor');
    const brushSizeInput = document.getElementById('memeBrushSize');
    const brushSizeVal = document.getElementById('memeBrushSizeVal');
    const undoBtn = document.getElementById('memeUndoBtn');
    const redoBtn = document.getElementById('memeRedoBtn');

    let currentAlign = 'center';
    let baseImage = null;
    let canvasObjects = []; 
    let selectedObjectIndex = -1;
    let isDragging = false;
    let isResizing = false;
    let dragStartX, dragStartY;
    let initialObjState = {};
    
    // হিস্টোরি স্টেট
    let history = [];
    let historyIndex = -1;
    
    // ব্রাশ মোড এবং এডিট মোড স্টেট
    let isBrushMode = false;
    let isDrawing = false;
    let isEditingText = false; // এডিট মোড ফ্ল্যাগ

    // --- হিস্টোরি ম্যানেজমেন্ট ফাংশন ---
    function saveState() {
        if (historyIndex < history.length - 1) {
            history = history.slice(0, historyIndex + 1);
        }
        
        const currentState = canvasObjects.map(obj => {
            const newObj = { ...obj };
            if (obj.type === 'drawing' && obj.points) {
                newObj.points = obj.points.map(p => ({...p}));
            }
            return newObj;
        });
        
        history.push(currentState);
        historyIndex++;
        
        if (history.length > 50) {
            history.shift();
            historyIndex--;
        }
        
        updateHistoryButtons();
    }

    function updateHistoryButtons() {
        if (undoBtn) undoBtn.disabled = historyIndex <= 0;
        if (redoBtn) redoBtn.disabled = historyIndex >= history.length - 1;
    }

    function restoreState(index) {
        if (index >= 0 && index < history.length) {
            historyIndex = index;
            canvasObjects = history[index].map(obj => {
                const newObj = { ...obj };
                if (obj.type === 'drawing' && obj.points) {
                    newObj.points = obj.points.map(p => ({...p}));
                }
                return newObj;
            });
            resetTextForm(); // স্টেট রিস্টোর হলে সিলেকশন ও ফর্ম রিসেট
            renderCanvas();
            updateHistoryButtons();
        }
    }

    // --- ইভেন্ট লিসেনারস ---

    brushSizeInput.addEventListener('input', () => {
        brushSizeVal.textContent = brushSizeInput.value;
    });

    brushToggleBtn.addEventListener('click', () => {
        isBrushMode = !isBrushMode;
        if (isBrushMode) {
            brushToggleBtn.classList.remove('bg-gray-200', 'dark:bg-gray-600', 'text-gray-800', 'dark:text-white');
            brushToggleBtn.classList.add('bg-blue-600', 'text-white');
            brushSettings.classList.remove('hidden');
            canvas.style.cursor = 'crosshair';
            resetTextForm(); // ব্রাশ মোডে টেক্সট এডিট বন্ধ
            renderCanvas();
        } else {
            brushToggleBtn.classList.add('bg-gray-200', 'dark:bg-gray-600', 'text-gray-800', 'dark:text-white');
            brushToggleBtn.classList.remove('bg-blue-600', 'text-white');
            brushSettings.classList.add('hidden');
            canvas.style.cursor = 'default';
        }
    });

    undoBtn.addEventListener('click', () => {
        if (historyIndex > 0) {
            restoreState(historyIndex - 1);
        }
    });

    redoBtn.addEventListener('click', () => {
        if (historyIndex < history.length - 1) {
            restoreState(historyIndex + 1);
        }
    });

    function renderCanvas() {
        if (!baseImage) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(baseImage, 0, 0);

        canvasObjects.forEach((obj, index) => {
            ctx.save();
            if (obj.type === 'text') {
                ctx.font = `bold ${obj.fontSize}px Impact, sans-serif`;
                
                // ফিল কালার হ্যান্ডলিং (স্বচ্ছ হলে ফিল হবে না)
                if (obj.color && obj.color !== 'transparent') {
                    ctx.fillStyle = obj.color;
                    ctx.fillTextLogic = true;
                } else {
                    ctx.fillTextLogic = false;
                }
                
                // বর্ডার কালার হ্যান্ডলিং (স্বচ্ছ হলে স্ট্রোক হবে না)
                if (obj.borderColor && obj.borderColor !== 'transparent') {
                    ctx.strokeStyle = obj.borderColor;
                    ctx.lineWidth = obj.fontSize / 15;
                    ctx.strokeTextLogic = true;
                } else {
                    ctx.strokeTextLogic = false;
                }
                
                ctx.textAlign = obj.align || 'center'; 
                ctx.textBaseline = 'top';
                
                const lines = obj.content.split('\n');
                const lineHeight = obj.fontSize * 1.2;
                
                lines.forEach((line, i) => {
                    if (ctx.strokeTextLogic) {
                        ctx.strokeText(line, obj.x, obj.y + (i * lineHeight));
                    }
                    if (ctx.fillTextLogic) {
                        ctx.fillText(line, obj.x, obj.y + (i * lineHeight));
                    }
                });
                
                if (index === selectedObjectIndex && !isBrushMode) {
                    const metrics = measureTextObj(obj);
                    let boxX = obj.x;
                    if (obj.align === 'center') boxX = obj.x - metrics.width / 2;
                    if (obj.align === 'right') boxX = obj.x - metrics.width;
                    
                    drawSelectionBox(boxX - 5, obj.y - 5, metrics.width + 10, metrics.height + 10);
                }

            } else if (obj.type === 'image') {
                ctx.drawImage(obj.content, obj.x, obj.y, obj.width, obj.height);
                if (index === selectedObjectIndex && !isBrushMode) {
                    drawSelectionBox(obj.x, obj.y, obj.width, obj.height);
                }
            } else if (obj.type === 'shape') {
                if (obj.color && obj.color !== 'transparent') {
                    ctx.fillStyle = obj.color;
                } else {
                    ctx.fillStyle = 'rgba(0,0,0,0)'; // Transparent
                }
                
                if (obj.borderColor && obj.borderColor !== 'transparent') {
                    ctx.strokeStyle = obj.borderColor;
                    ctx.lineWidth = 5;
                }

                ctx.beginPath();
                if (obj.shapeType === 'rect') {
                    ctx.rect(obj.x, obj.y, obj.width, obj.height);
                } else if (obj.shapeType === 'circle') {
                    // Ellipse supports resizing width and height independently
                    ctx.ellipse(
                        obj.x + obj.width / 2, 
                        obj.y + obj.height / 2, 
                        Math.abs(obj.width / 2), 
                        Math.abs(obj.height / 2), 
                        0, 0, 2 * Math.PI
                    );
                } else if (obj.shapeType === 'triangle') {
                    ctx.moveTo(obj.x + obj.width / 2, obj.y);
                    ctx.lineTo(obj.x + obj.width, obj.y + obj.height);
                    ctx.lineTo(obj.x, obj.y + obj.height);
                    ctx.closePath();
                } else if (obj.shapeType === 'star') {
                    drawStar(ctx, obj.x + obj.width / 2, obj.y + obj.height / 2, 5, obj.width / 2, obj.width / 4);
                }
                
                if (obj.color && obj.color !== 'transparent') {
                    ctx.fill();
                }
                if (obj.borderColor && obj.borderColor !== 'transparent') {
                    ctx.stroke();
                }

                if (index === selectedObjectIndex && !isBrushMode) {
                    drawSelectionBox(obj.x, obj.y, obj.width, obj.height);
                }
            } else if (obj.type === 'drawing') {
                ctx.beginPath();
                ctx.strokeStyle = obj.color;
                ctx.lineWidth = obj.width;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                if (obj.points.length > 0) {
                    ctx.moveTo(obj.points[0].x, obj.points[0].y);
                    for (let i = 1; i < obj.points.length; i++) {
                        ctx.lineTo(obj.points[i].x, obj.points[i].y);
                    }
                }
                ctx.stroke();
            }
            ctx.restore();
        });
    }

    // Helper to draw star
    function drawStar(ctx, cx, cy, spikes, outerRadius, innerRadius) {
        let rot = Math.PI / 2 * 3;
        let x = cx;
        let y = cy;
        let step = Math.PI / spikes;

        ctx.beginPath();
        ctx.moveTo(cx, cy - outerRadius);
        for (let i = 0; i < spikes; i++) {
            x = cx + Math.cos(rot) * outerRadius;
            y = cy + Math.sin(rot) * outerRadius;
            ctx.lineTo(x, y);
            rot += step;

            x = cx + Math.cos(rot) * innerRadius;
            y = cy + Math.sin(rot) * innerRadius;
            ctx.lineTo(x, y);
            rot += step;
        }
        ctx.lineTo(cx, cy - outerRadius);
        ctx.closePath();
    }

    function measureTextObj(obj) {
        ctx.font = `bold ${obj.fontSize}px Impact, sans-serif`;
        const lines = obj.content.split('\n');
        let maxWidth = 0;
        lines.forEach(line => {
            const w = ctx.measureText(line).width;
            if (w > maxWidth) maxWidth = w;
        });
        const totalHeight = lines.length * (obj.fontSize * 1.2);
        return { width: maxWidth, height: totalHeight };
    }

    function drawSelectionBox(x, y, w, h) {
        ctx.strokeStyle = '#00BFFF';
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
        ctx.strokeRect(x, y, w, h);
        
        ctx.setLineDash([]);
        ctx.fillStyle = '#00BFFF';
        ctx.fillRect(x + w - 10, y + h - 10, 20, 20); 
    }

    // --- ফর্ম রিসেট এবং এডিট মোড হ্যান্ডলিং ---
    function resetTextForm() {
        isEditingText = false;
        selectedObjectIndex = -1;
        textInput.value = '';
        addTextBtn.textContent = 'টেক্সট যোগ করুন';
        addTextBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
        addTextBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        cancelEditBtn.classList.add('hidden');
        renderCanvas();
    }

    function populateFormForEdit(obj, index) {
        isEditingText = true;
        selectedObjectIndex = index;
        textInput.value = obj.content;
        fontSizeInput.value = obj.fontSize;
        
        // ফিল কালার লজিক আপডেট
        if (obj.color === 'transparent') {
            noFillCheckbox.checked = true;
            colorInput.disabled = true;
        } else {
            noFillCheckbox.checked = false;
            colorInput.disabled = false;
            colorInput.value = obj.color;
        }
        
        if (obj.borderColor === 'transparent') {
            noBorderCheckbox.checked = true;
            borderColorInput.disabled = true; // অপশনাল: ডিসেবল করে রাখা
        } else {
            noBorderCheckbox.checked = false;
            borderColorInput.disabled = false;
            borderColorInput.value = obj.borderColor;
        }
        
        // অ্যালাইনমেন্ট বাটন আপডেট
        currentAlign = obj.align || 'center';
        updateAlignButtonsUI();

        // বাটন পরিবর্তন
        addTextBtn.textContent = 'আপডেট করুন';
        addTextBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        addTextBtn.classList.add('bg-green-600', 'hover:bg-green-700');
        cancelEditBtn.classList.remove('hidden');
        
        renderCanvas();
    }

    function handleTextBtnClick() {
        const text = textInput.value; 
        if (!text.trim()) return showCustomAlert('অনুগ্রহ করে কিছু টেক্সট লিখুন।');
        
        const fontSize = parseInt(fontSizeInput.value) || 40;
        const color = noFillCheckbox.checked ? 'transparent' : colorInput.value;
        const borderColor = noBorderCheckbox.checked ? 'transparent' : borderColorInput.value;

        if (isEditingText && selectedObjectIndex !== -1) {
            // আপডেট মোড
            const obj = canvasObjects[selectedObjectIndex];
            obj.content = text;
            obj.fontSize = fontSize;
            obj.color = color;
            obj.borderColor = borderColor;
            obj.align = currentAlign;
            showCustomAlert('টেক্সট আপডেট করা হয়েছে!');
        } else {
            // নতুন যোগ করার মোড
            canvasObjects.push({
                type: 'text',
                content: text,
                x: canvas.width / 2,
                y: canvas.height / 2 - 20,
                fontSize: fontSize,
                color: color,
                borderColor: borderColor,
                align: currentAlign,
                width: 0, 
                height: 0 
            });
            showCustomAlert('টেক্সট যোগ করা হয়েছে!');
        }
        
        // সেভ এবং রিসেট
        saveState(); 
        resetTextForm();
    }

    addTextBtn.addEventListener('click', handleTextBtnClick);
    
    // এডিট বাতিল বাটন
    if (cancelEditBtn) {
        cancelEditBtn.addEventListener('click', resetTextForm);
    }

    // ফিল নেই চেকবক্স লজিক
    noFillCheckbox.addEventListener('change', () => {
        if (selectedObjectIndex !== -1) {
             const obj = canvasObjects[selectedObjectIndex];
             if (obj.type === 'text' || obj.type === 'shape') {
                 obj.color = noFillCheckbox.checked ? 'transparent' : colorInput.value;
                 colorInput.disabled = noFillCheckbox.checked;
                 renderCanvas();
             }
        } else {
             colorInput.disabled = noFillCheckbox.checked;
        }
    });

    // বর্ডার নেই চেকবক্স লজিক (আপডেট)
    noBorderCheckbox.addEventListener('change', () => {
        if (selectedObjectIndex !== -1) {
             const obj = canvasObjects[selectedObjectIndex];
             if (obj.type === 'text' || obj.type === 'shape') {
                 obj.borderColor = noBorderCheckbox.checked ? 'transparent' : borderColorInput.value;
                 borderColorInput.disabled = noBorderCheckbox.checked;
                 renderCanvas();
             }
        } else {
             borderColorInput.disabled = noBorderCheckbox.checked;
        }
    });

    // ইনপুট চেঞ্জ হলে লাইভ আপডেট (আপডেট)
    const inputsToWatch = [textInput, fontSizeInput, colorInput, borderColorInput];
    inputsToWatch.forEach(input => {
        input.addEventListener('input', () => {
            if (selectedObjectIndex !== -1) {
                const obj = canvasObjects[selectedObjectIndex];
                
                if (input === colorInput && !noFillCheckbox.checked) obj.color = colorInput.value;
                if (input === borderColorInput && !noBorderCheckbox.checked) obj.borderColor = borderColorInput.value;

                if (obj.type === 'text') {
                    if (input === textInput && isEditingText) obj.content = textInput.value;
                    if (input === fontSizeInput) obj.fontSize = parseInt(fontSizeInput.value) || 20;
                }
                
                renderCanvas();
            }
        });
    });

    function addImageOverlay(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const scale = Math.min(canvas.width, canvas.height) * 0.3 / Math.max(img.width, img.height);
                canvasObjects.push({
                    type: 'image',
                    content: img,
                    x: (canvas.width - img.width * scale) / 2,
                    y: (canvas.height - img.height * scale) / 2,
                    width: img.width * scale,
                    height: img.height * scale,
                    aspectRatio: img.width / img.height
                });
                selectedObjectIndex = canvasObjects.length - 1;
                
                if (isBrushMode) brushToggleBtn.click();
                resetTextForm(); // ওভারলে যোগ করলে টেক্সট এডিট মোড বন্ধ
                saveState(); 
                renderCanvas();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    overlayInput.addEventListener('change', (e) => {
        if (e.target.files[0]) addImageOverlay(e.target.files[0]);
        e.target.value = '';
    });

    // --- Shape Addition Functions ---
    function addShape(shapeType) {
        if (!baseImage) {
            showCustomAlert('অনুগ্রহ করে প্রথমে একটি ব্যাকগ্রাউন্ড ছবি আপলোড করুন।');
            return;
        }
        
        const size = 100;
        const centerX = (canvas.width - size) / 2;
        const centerY = (canvas.height - size) / 2;
        
        canvasObjects.push({
            type: 'shape',
            shapeType: shapeType,
            x: centerX,
            y: centerY,
            width: size,
            height: size,
            color: noFillCheckbox.checked ? 'transparent' : (colorInput.value || '#ff0000'),
            borderColor: noBorderCheckbox.checked ? 'transparent' : (borderColorInput.value || '#000000')
        });
        
        selectedObjectIndex = canvasObjects.length - 1;
        if (isBrushMode) brushToggleBtn.click();
        resetTextForm();
        saveState();
        renderCanvas();
    }

    if(addRectBtn) addRectBtn.addEventListener('click', () => addShape('rect'));
    if(addCircleBtn) addCircleBtn.addEventListener('click', () => addShape('circle'));
    if(addTriangleBtn) addTriangleBtn.addEventListener('click', () => addShape('triangle'));
    if(addStarBtn) addStarBtn.addEventListener('click', () => addShape('star'));


    function updateAlignButtonsUI() {
        alignLeftBtn.className = "p-2 hover:bg-gray-300 dark:hover:bg-gray-600 rounded";
        alignCenterBtn.className = "p-2 hover:bg-gray-300 dark:hover:bg-gray-600 rounded";
        alignRightBtn.className = "p-2 hover:bg-gray-300 dark:hover:bg-gray-600 rounded";
        
        if (currentAlign === 'left') alignLeftBtn.className += " bg-gray-300 dark:bg-gray-500";
        if (currentAlign === 'center') alignCenterBtn.className += " bg-gray-300 dark:bg-gray-500";
        if (currentAlign === 'right') alignRightBtn.className += " bg-gray-300 dark:bg-gray-500";
    }

    [alignLeftBtn, alignCenterBtn, alignRightBtn].forEach(btn => {
        btn.addEventListener('click', () => {
            if (btn === alignLeftBtn) currentAlign = 'left';
            if (btn === alignCenterBtn) currentAlign = 'center';
            if (btn === alignRightBtn) currentAlign = 'right';
            
            updateAlignButtonsUI();

            if (selectedObjectIndex !== -1 && canvasObjects[selectedObjectIndex].type === 'text') {
                canvasObjects[selectedObjectIndex].align = currentAlign;
                saveState(); 
                renderCanvas();
            }
        });
    });

    const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
    };

    const getObjectBounds = (obj) => {
        let x = obj.x, y = obj.y, w, h;
        if (obj.type === 'text') {
            const m = measureTextObj(obj);
            w = m.width; h = m.height;
            if (obj.align === 'center') x = obj.x - w / 2;
            if (obj.align === 'right') x = obj.x - w;
        } else {
            w = obj.width; h = obj.height;
        }
        return {x, y, w, h};
    };

    const isHit = (obj, mx, my) => {
        if (obj.type === 'drawing') return false;
        const b = getObjectBounds(obj);
        return (mx >= b.x - 10 && mx <= b.x + b.w + 10 && my >= b.y - 10 && my <= b.y + b.h + 10);
    };

    const isResizeHandleHit = (obj, mx, my) => {
        if (obj.type === 'drawing') return false;
        const b = getObjectBounds(obj);
        const hx = b.x + b.w;
        const hy = b.y + b.h;
        return (mx >= hx - 10 && mx <= hx + 10 && my >= hy - 10 && my <= hy + 10);
    };

    const handleStart = (e) => {
        if (!baseImage) return;
        if (isBrushMode && e.type === 'touchstart') e.preventDefault();
        
        if (e.type === 'mousedown') e.preventDefault();
        const { x, y } = getPos(e);
        
        if (isBrushMode) {
            isDrawing = true;
            const newDrawing = {
                type: 'drawing',
                points: [{x, y}],
                color: brushColorInput.value,
                width: parseInt(brushSizeInput.value),
            };
            canvasObjects.push(newDrawing);
            renderCanvas();
            return;
        }

        dragStartX = x;
        dragStartY = y;
        isDragging = false;
        isResizing = false;

        // চেক করুন রিসাইজ হ্যান্ডেলে ক্লিক হয়েছে কিনা
        if (selectedObjectIndex !== -1) {
            if (isResizeHandleHit(canvasObjects[selectedObjectIndex], x, y)) {
                isResizing = true;
                initialObjState = JSON.parse(JSON.stringify(canvasObjects[selectedObjectIndex])); 
                return;
            }
        }

        // চেক করুন কোনো অবজেক্টে ক্লিক হয়েছে কিনা
        let clickedObject = false;
        for (let i = canvasObjects.length - 1; i >= 0; i--) {
            const obj = canvasObjects[i];
            if (isHit(obj, x, y)) {
                clickedObject = true;
                selectedObjectIndex = i;
                isDragging = true;
                initialObjState = { x: obj.x, y: obj.y };
                
                if (obj.type === 'text' || obj.type === 'shape') {
                    // ফিল কালার সিঙ্ক
                    if (obj.color === 'transparent') {
                        noFillCheckbox.checked = true;
                        colorInput.disabled = true;
                    } else {
                        noFillCheckbox.checked = false;
                        colorInput.disabled = false;
                        colorInput.value = obj.color;
                    }
                    
                    // বর্ডার কালার সিঙ্ক
                    if (obj.borderColor === 'transparent') {
                        noBorderCheckbox.checked = true;
                        borderColorInput.disabled = true;
                    } else {
                        noBorderCheckbox.checked = false;
                        borderColorInput.disabled = false;
                        borderColorInput.value = obj.borderColor;
                    }
                    
                    // টেক্সট হলে ফন্ট সাইজ সিঙ্ক
                    if (obj.type === 'text') {
                        fontSizeInput.value = obj.fontSize;
                    }
                }
                
                renderCanvas();
                return;
            }
        }
        
        // যদি ফাঁকা জায়গায় ক্লিক হয়
        if (!clickedObject && selectedObjectIndex !== -1) {
            resetTextForm(); // সিলেকশন এবং এডিট মোড বাতিল
        }
    };

    const handleMove = (e) => {
        e.preventDefault();
        const { x, y } = getPos(e);

        if (isBrushMode && isDrawing) {
            const currentDrawing = canvasObjects[canvasObjects.length - 1];
            currentDrawing.points.push({x, y});
            renderCanvas();
            return;
        }

        if (isResizing && selectedObjectIndex !== -1) {
            const obj = canvasObjects[selectedObjectIndex];
            const dx = x - dragStartX;
            
            if (obj.type === 'text') {
                let newSize = initialObjState.fontSize + (dx / 2);
                if (newSize < 10) newSize = 10;
                obj.fontSize = newSize;
                // এডিট মোডে থাকলে ইনপুট আপডেট করুন
                if(isEditingText) fontSizeInput.value = parseInt(newSize);
            } else {
                let newW = initialObjState.width + dx;
                if (newW < 20) newW = 20;
                obj.width = newW;
                obj.height = newW / initialObjState.aspectRatio;
            }
            renderCanvas();
        } else if (isDragging && selectedObjectIndex !== -1) {
            const obj = canvasObjects[selectedObjectIndex];
            const dx = x - dragStartX;
            const dy = y - dragStartY;
            obj.x = initialObjState.x + dx;
            obj.y = initialObjState.y + dy;
            renderCanvas();
        }
    };

    const handleEnd = () => { 
        if (isDragging || isResizing || isDrawing) {
            saveState();
        }
        isDragging = false; 
        isResizing = false; 
        isDrawing = false; 
    };

    // --- ডাবল ক্লিক হ্যান্ডলার (টেক্সট এডিটের জন্য) ---
    const handleDoubleClick = (e) => {
        e.preventDefault();
        const { x, y } = getPos(e);

        // ক্লিক করা অবজেক্ট খুঁজুন (উপর থেকে নিচে)
        for (let i = canvasObjects.length - 1; i >= 0; i--) {
            const obj = canvasObjects[i];
            if (isHit(obj, x, y)) {
                if (obj.type === 'text') {
                    // টেক্সট অবজেক্ট পাওয়া গেলে ফর্ম পপুলেট করুন এবং এডিট মোড চালু করুন
                    populateFormForEdit(obj, i);
                }
                return; 
            }
        }
    };

    canvas.addEventListener('mousedown', handleStart);
    canvas.addEventListener('mousemove', handleMove);
    canvas.addEventListener('mouseup', handleEnd);
    canvas.addEventListener('touchstart', handleStart, {passive: false});
    canvas.addEventListener('touchmove', handleMove, {passive: false});
    canvas.addEventListener('touchend', handleEnd);
    
    // ডাবল ক্লিক ইভেন্ট লিসেনার
    canvas.addEventListener('dblclick', handleDoubleClick);

    document.addEventListener('keydown', (e) => {
        const contentDiv = document.getElementById('memeGenContent');
        if (contentDiv && contentDiv.classList.contains('active') && selectedObjectIndex !== -1) {
            if (e.key === 'Delete' || e.key === 'Backspace') {
                if (document.activeElement !== textInput) {
                    canvasObjects.splice(selectedObjectIndex, 1);
                    resetTextForm(); // ডিলিট হলে সিলেকশন ক্লিয়ার
                    saveState(); 
                    renderCanvas();
                }
            }
        }
    });

    imageInput.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    baseImage = img;
                    canvas.width = img.width;
                    canvas.height = img.height;
                    placeholder.style.display = 'none';
                    canvasObjects = [];
                    history = [];
                    historyIndex = -1;
                    resetTextForm();
                    saveState(); 
                    
                    renderCanvas();
                    downloadBtn.disabled = false;
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }
    };

    downloadBtn.onclick = () => {
        const tempSelection = selectedObjectIndex;
        selectedObjectIndex = -1; 
        renderCanvas();
        
        const link = document.createElement('a');
        link.download = 'bangla-toolbox-meme.png';
        link.href = canvas.toDataURL();
        link.click();
        
        selectedObjectIndex = tempSelection; 
        renderCanvas();
    };
    
    updateHistoryButtons();
}
// ========================================================
// END: Meme Generator Function
// ========================================================

// 4. Internet Speed Test Function
// ========================================================
// START: Internet Speed Test Function (Fixed & Robust)
// ========================================================
function initializeSpeedTest() {
    const startBtn = document.getElementById('startSpeedTestBtn');
    const dlSpeedEl = document.getElementById('dlSpeed');
    const ulSpeedEl = document.getElementById('ulSpeed'); // নতুন আপলোড এলিমেন্ট
    const pingEl = document.getElementById('pingSpeed');
    const statusEl = document.getElementById('speedStatus');
    const progressRing = document.getElementById('speedProgress');

    // বাটন না থাকলে ফাংশন থামিয়ে দিন
    if(!startBtn) return;

    // UI রিসেট করার ফাংশন
    const resetUI = () => {
        if(dlSpeedEl) dlSpeedEl.innerText = '0.00';
        if(ulSpeedEl) ulSpeedEl.innerText = '0.00';
        if(pingEl) pingEl.innerText = '0';
        if(statusEl) {
            statusEl.innerText = 'Ready';
            statusEl.className = 'text-lg font-bold text-green-600';
        }
        if(progressRing) progressRing.style.strokeDashoffset = 283; // সার্কেল রিসেট
    };

    startBtn.onclick = async () => {
        // টেস্ট চলাকালীন বাটন ডিজেবল রাখা
        startBtn.disabled = true;
        startBtn.classList.add('opacity-50', 'cursor-not-allowed');
        startBtn.innerHTML = '<span>...</span>'; // লোডিং টেক্সট
        
        resetUI();
        
        // প্রোগ্রেস বার এনিমেশন ভেরিয়েবল
        let progress = 0;
        let progressInterval;

        const startProgress = () => {
            clearInterval(progressInterval);
            progressInterval = setInterval(() => {
                progress += (progress < 90) ? 0.5 : 0; 
                if(progressRing) {
                    const offset = 283 - (283 * progress / 100);
                    progressRing.style.strokeDashoffset = offset;
                }
            }, 50);
        };

        const stopProgress = () => {
            clearInterval(progressInterval);
            if(progressRing) progressRing.style.strokeDashoffset = 0; // পূর্ণ সার্কেল
        };

        startProgress();

        try {
            // ১. পিং টেস্ট (Ping Test)
            if(statusEl) statusEl.innerText = 'Testing Ping...';
            const pingStart = performance.now();
            
            try {
                await fetch('https://www.google.com/generate_204', { 
                    method: 'HEAD',
                    mode: 'no-cors',
                    cache: 'no-store'
                });
                const pingEnd = performance.now();
                const pingTime = Math.round(pingEnd - pingStart);
                if(pingEl) pingEl.innerText = pingTime;
            } catch (e) {
                if(pingEl) pingEl.innerText = Math.max(1, Math.round(performance.now() - pingStart)); 
            }

            // ২. ডাউনলোড স্পিড টেস্ট (Download Test)
            if(statusEl) {
                statusEl.innerText = 'Testing Download...';
                statusEl.className = 'text-lg font-bold text-blue-600';
            }
            
            // Cloudflare এর ২ এমবি ফাইল ডাউনলোড করে স্পিড মাপা
            const dlStartTime = new Date().getTime();
            const dlResponse = await fetch("https://speed.cloudflare.com/__down?bytes=2000000&t=" + new Date().getTime());
            const dlBlob = await dlResponse.blob();
            const dlEndTime = new Date().getTime();
            
            const dlDuration = (dlEndTime - dlStartTime) / 1000;
            const dlBitsLoaded = dlBlob.size * 8;
            const dlSpeedBps = dlBitsLoaded / dlDuration;
            const dlSpeedMbps = (dlSpeedBps / (1024 * 1024)).toFixed(2);
            
            if(dlSpeedEl) dlSpeedEl.innerText = dlSpeedMbps;

            // ৩. আপলোড স্পিড টেস্ট (Upload Test - New)
            if(statusEl) {
                statusEl.innerText = 'Testing Upload...';
                statusEl.className = 'text-lg font-bold text-orange-600';
            }

            // ১ এমবি ডামি ডেটা তৈরি
            const uploadSize = 1000000; // ১ এমবি
            const uploadContent = new Uint8Array(uploadSize); 
            const upStartTime = new Date().getTime();

            // httpbin এ পোস্ট রিকোয়েস্ট পাঠানো (CORS সাপোর্টেড)
            await fetch('https://httpbin.org/post', {
                method: 'POST',
                body: uploadContent
            });

            const upEndTime = new Date().getTime();
            const upDuration = (upEndTime - upStartTime) / 1000;
            const upBitsLoaded = uploadSize * 8;
            const upSpeedBps = upBitsLoaded / upDuration;
            const upSpeedMbps = (upSpeedBps / (1024 * 1024)).toFixed(2);

            if(ulSpeedEl) ulSpeedEl.innerText = upSpeedMbps;

            // ৪. কমপ্লিট
            stopProgress();
            if(statusEl) {
                statusEl.innerText = 'Completed';
                statusEl.className = 'text-lg font-bold text-green-600';
            }
            
        } catch (error) {
            stopProgress();
            console.error(error);
            
            if(statusEl) {
                statusEl.innerText = 'Error';
                statusEl.className = 'text-lg font-bold text-red-600';
            }
            showCustomAlert("ইন্টারনেট কানেকশন চেক করুন।");
        } finally {
            startBtn.disabled = false;
            startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            startBtn.innerHTML = '<span>GO</span>';
        }
    };
    
    resetUI();
}
// ========================================================
// END: Internet Speed Test Function
// ========================================================

// ========================================================
// END: NEW FEATURES FUNCTIONS
// ========================================================


//নতুন কোনো ট্যাব যুক্ত করলে তার স্ক্রিপ্ট এটির আগে অ্যাড করতে হবে।

// ====================================================================
// END: TRANSLATOR SCRIPT
// ====================================================================

// ====================================================================
// START: TEXT ASSISTANT PART
// ====================================================================
                // --- টেক্সট অ্যাসিস্ট্যান্ট (চ্যাট) লজিক ---
                const assistantInput = document.getElementById('assistantInput');
                const askGeminiBtn = document.getElementById('askGeminiBtn');
                const chatWindow = document.getElementById('chatWindow');
                const clearChatBtn = document.getElementById('clearChatBtn');

                window.chatHistory = []; // কথোপকথনের ইতিহাস সংরক্ষণ করে

                // চ্যাট মুছুন বোতামের কার্যকারিতা
                if (clearChatBtn) {
                    clearChatBtn.addEventListener('click', () => {
                        if (chatWindow) chatWindow.innerHTML = '';
                        window.chatHistory = []; // ইতিহাস রিসেট করুন
                        addMessageToChat('হ্যালো! আমি আপনার টেক্সট অ্যাসিস্ট্যান্ট। আমি আপনাকে কীভাবে সাহায্য করতে পারি?', 'gemini');
                    });
                }

                // জেমিনিকে জিজ্ঞাসা করার বোতামের কার্যকারিতা
                if (askGeminiBtn) {
                    askGeminiBtn.addEventListener('click', handleAskGemini);
                }

                // Enter চেপে বার্তা পাঠানোর সুবিধা
                if (assistantInput) {
                    assistantInput.addEventListener('keydown', (e) => {
                        // Shift+Enter চাপলে নতুন লাইন তৈরি হবে, শুধু Enter চাপলে বার্তা যাবে
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault(); // ডিফল্ট Enter আচরণ (নতুন লাইন) বন্ধ করুন
                            handleAskGemini();
                        }
                    });
                }
// ====================================================================
// END: TEXT ASSISTANT PART
// ====================================================================

// --- ফন্ট কনভার্টার লিসেনার ---
// ====================================================================
// START: PASTE FROM CLIPBOARD FUNCTIONALITY (স্ক্রল এবং কার্সর ফিক্সড - উভয় পাশে)
// ====================================================================
async function pasteFromClipboard(textareaId) {
    const textarea = document.getElementById(textareaId);
    if (!textarea) return;

    try {
        let clipboardText = await navigator.clipboard.readText();
        if (!clipboardText) {
            showCustomAlert('ক্লিপবোর্ডে কোনো টেক্সট নেই।');
            return;
        }
        
        // --- নতুন: পেস্ট করার সময়ই নরমালাইজেশন ---
        clipboardText = clipboardText
            .replace(/য়/g, 'য়')
            .replace(/ড়/g, 'ড়')
            .replace(/ঢ়/g, 'ঢ়');

        let textToInsert = '';
        let preset, customValue, serialCounter, updateSerialCounter, resetSerialCounter;

        // কোন দিকের টেক্সটবক্স এবং তার সেটিংস নির্ধারণ
        if (textareaId === 'textAreaLeft') {
            preset = pastePresetLeft;
            customValue = customPasteValueLeft;
            serialCounter = customSerialCounterLeft;
            updateSerialCounter = (val) => { customSerialCounterLeft = val; };
            resetSerialCounter = () => { customSerialCounterLeft = 1; };
        } else {
            preset = pastePresetRight;
            customValue = customPasteValueRight;
            serialCounter = customSerialCounterRight;
            updateSerialCounter = (val) => { customSerialCounterRight = val; };
            resetSerialCounter = () => { customSerialCounterRight = 1; };
        }

        if (preset !== 'custom-serial') {
            resetSerialCounter();
        }

        // প্রিসেট অনুযায়ী টেক্সট প্রসেসিং
        switch (preset) {
            case 'double-enter-v2': {
                let processedText = clipboardText.trim().replace(/(\r?\n\s*){2,}/g, '\n');
                if (textarea.value.trim() !== '') {
                    textToInsert = '\n\n' + processedText;
                } else {
                    textToInsert = processedText;
                }
                break;
            }
            case 'double-enter-v3': {
                let processedText = clipboardText.trim().replace(/(\r?\n\s*){2,}/g, '\n');
                processedText = processedText.replace(/^\s+/gm, ''); 
                if (textarea.value.trim() !== '') {
                    textToInsert = '\n\n' + processedText;
                } else {
                    textToInsert = processedText;
                }
                break;
            }
            case 'custom-serial': {
                const prefix = customValue ? customValue.replace(/\{serial\}/g, serialCounter) : '';
                updateSerialCounter(serialCounter + 1);
                textToInsert = prefix + clipboardText;
                break;
            }
            default: {
                let prefix = '';
                if (preset === 'custom') {
                    prefix = customValue || '';
                    textToInsert = prefix + clipboardText;
                } else {
                    if (textarea.value.trim() !== '') {
                        if (preset === 'single-space') prefix = ' ';
                        else if (preset === 'double-space') prefix = '  ';
                        else if (preset === 'four-space') prefix = '    ';
                        else if (preset === 'single-enter') prefix = '\n';
                        else if (preset === 'double-enter') prefix = '\n\n';
                    }
                    textToInsert = prefix + clipboardText;
                }
                break;
            }
        }
        
        // কার্সরের বর্তমান পজিশন
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const currentValue = textarea.value;
        
        // টেক্সট ইনসার্ট করা
        textarea.value = currentValue.substring(0, start) + textToInsert + currentValue.substring(end);
        
        // কার্সরকে একদম শেষে নিয়ে যাওয়া
        const newCursorPosition = textarea.value.length;
        textarea.selectionStart = newCursorPosition;
        textarea.selectionEnd = newCursorPosition;
        textarea.focus();

        // স্ক্রোলবার নিচে নামানো
        setTimeout(() => {
            textarea.scrollTop = textarea.scrollHeight;
        }, 10);

        // হিস্টোরিতে যোগ করা
        addState(textareaId);
        showCustomAlert('টেক্সট পেস্ট করা হয়েছে!');

        // লাইভ কনভার্ট ট্রিগার
        const liveConvertToggle = document.getElementById('live-convert-toggle');
        if (liveConvertToggle && liveConvertToggle.checked) {
            if (textareaId === 'textAreaLeft') {
                setTimeout(() => {
                    convertLeftToRight();
                    const rightArea = document.getElementById('textAreaRight');
                    if (rightArea) {
                        rightArea.scrollTop = rightArea.scrollHeight;
                    }
                }, 0);
            } else if (textareaId === 'textAreaRight') {
                setTimeout(() => {
                    convertRightToLeft();
                    const leftArea = document.getElementById('textAreaLeft');
                    if (leftArea) {
                        leftArea.scrollTop = leftArea.scrollHeight;
                    }
                }, 0);
            }
        }

    } catch (err) {
        console.error('পেস্ট করতে ব্যর্থ:', err);
        showCustomAlert('পেস্ট করতে ব্যর্থ হয়েছে। ব্রাউজার পারমিশন চেক করুন।');
    }
}
// ====================================================================
// END: PASTE FROM CLIPBOARD FUNCTIONALITY
// ====================================================================

// ====================================================================
// START: ANSI FIX AND PEST FOR LIVE CONVERT
// ====================================================================
			
                const fixAnsiButton = document.getElementById('fixAnsiButton');
                if (fixAnsiButton) {
                    fixAnsiButton.addEventListener('click', () => fixAnsiText(true));
                }

                // *** সংশোধিত: প্রাথমিক বার্তাটি এখানে যোগ করা হয়েছে ***
                if (chatWindow && chatWindow.children.length === 0) {
                     addMessageToChat('হ্যালো! আমি আপনার টেক্সট অ্যাসিস্ট্যান্ট। আমি আপনাকে কীভাবে সাহায্য করতে পারি?', 'gemini');
                }
                
                // ইউনিট কনভার্টার ইনিশিয়ালাইজ করুন
                initializeUnitConverters();

// --- ফন্ট কনভার্টার লিসেনার যোগ করুন ---
const pasteButtonLeft = document.getElementById('pasteButtonLeft');
const pasteButtonRight = document.getElementById('pasteButtonRight');
// ====================================================================
// END: ANSI FIX AND PASTE FOR LIVE CONVERT
// ====================================================================

// ====================================================================
// START: LIVE CONVERT TOGGLE FUNCTIONALITY (রিফ্রেশ-সহ আপডেট করা হয়েছে)
// ====================================================================

const liveConvertToggle = document.getElementById('live-convert-toggle');
const textAreaLeftForLive = document.getElementById('textAreaLeft');
const textAreaRightForLive = document.getElementById('textAreaRight');

if (liveConvertToggle && textAreaLeftForLive && textAreaRightForLive) {

    // --- নতুন: পেইজ লোড হওয়ার সময় সেভ করা মোড লোড করুন ---
    const savedLiveConvertMode = localStorage.getItem('liveConvertMode');
    
    // পরিবর্তন: ডিফল্টভাবে অন (true) রাখার জন্য লজিক আপডেট করা হয়েছে
    // যদি ব্যবহারকারী আগে ম্যানুয়ালি বন্ধ করে থাকেন ('false'), তবেই এটি বন্ধ থাকবে।
    // অন্যথায় (প্রথমবার লোড বা 'true') এটি চালু থাকবে।
    if (savedLiveConvertMode === 'false') {
        liveConvertToggle.checked = false;
    } else {
        liveConvertToggle.checked = true; // ডিফল্ট 'true' (অন)
    }

    // --- নতুন: টগল করার সময় মোড সেভ করুন ---
    liveConvertToggle.addEventListener('change', () => {
        localStorage.setItem('liveConvertMode', liveConvertToggle.checked);
    });
    
    // ইউনিকোড টেক্সটবক্সে লাইভ টাইপিং এবং পেস্ট হ্যান্ডেল করা
    const handleUnicodeInput = () => {
        if (liveConvertToggle.checked) {
            // সামান্য ডিলে দেওয়া হয় যাতে পেস্ট হওয়া টেক্সট ঠিকভাবে প্রসেস হয়
            setTimeout(() => convertLeftToRight(), 0);
        }
    };

    // বিজয় টেক্সটবক্সে লাইভ টাইপিং এবং পেস্ট হ্যান্ডেল করা
    const handleBijoyInput = () => {
        if (liveConvertToggle.checked) {
            // সামান্য ডিলে দেওয়া হয় যাতে যুক্তবর্ণ লেখার সময় অক্ষর হারিয়ে না যায়
            setTimeout(() => convertRightToLeft(), 0);
        }
    };

    // 'input' ইভেন্টটি টাইপিং এবং পেস্ট উভয় ক্ষেত্রেই কাজ করবে
    textAreaLeftForLive.addEventListener('input', handleUnicodeInput);
    textAreaRightForLive.addEventListener('input', handleBijoyInput);

} else {
    console.error("Live convert elements could not be found.");
}

// ====================================================================
// END: LIVE CONVERT TOGGLE FUNCTIONALITY
// ====================================================================

// ====================================================================
// START: PASTE BUTTON SCRIPT FOR FONT CONVERTER
// ====================================================================
if (pasteButtonLeft) {
    pasteButtonLeft.addEventListener('click', () => pasteFromClipboard('textAreaLeft'));
}

if (pasteButtonRight) {
    pasteButtonRight.addEventListener('click', () => pasteFromClipboard('textAreaRight'));
}

            } catch (e) {
                console.error('DOMContentLoaded এক্সিকিউশনের সময় একটি ত্রুটি ঘটেছে:', e);
                const mainContainer = document.querySelector('.main-container');
                if (mainContainer) {
                    const errorMessageDiv = document.createElement('div');
                    errorMessageDiv.className = 'text-red-600 font-bold mt-4 p-4 border border-red-300 rounded-lg';
                    errorMessageDiv.innerText = 'অ্যাপ লোড করতে সমস্যা হয়েছে। অনুগ্রহ করে কনসোল চেক করুন।';
                    mainContainer.prepend(errorMessageDiv);
                }
            }
			
        });
// ====================================================================
// END: PASTE BUTTON FOR FONT CONVERTER
// ====================================================================

// ====================================================================
// START: COMBINED & UPDATED WEATHER SCRIPT (Optimized - 10 min update)
// ====================================================================

// --- প্রথম আবহাওয়া সেকশনের জন্য উপাদান (OpenWeatherMap) ---
const cityInput = document.getElementById('cityInput');
const searchWeatherBtn = document.getElementById('searchWeatherBtn');
const weatherResult = document.getElementById('weatherResult');
const weatherLoading = document.getElementById('weatherLoading');
const weatherApiKey = '4a5a19a6db3c60132629d8bd29949841'; // আপনার OpenWeatherMap API কী

// --- দ্বিতীয় আবহাওয়া সেকশনের জন্য উপাদান (Open-Meteo) ---
const searchInputForecast = document.getElementById('location-search-input');
const searchButtonForecast = document.getElementById('search-weather-button');
const forecastContainer = document.getElementById('forecast-container');
const weatherSection = document.getElementById('weather-section');
const locationNameEl = document.getElementById('location-name');


// --- প্রথম সেকশনের জন্য হেল্পার ফাংশন ---
function formatTime(timestamp) {
    const date = new Date(timestamp * 1000);
    return date.toLocaleTimeString('bn-BD', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
    });
}

// --- দ্বিতীয় সেকশনের জন্য হেল্পার ফাংশন ---
const weatherCodes = {
    0: { text: "পরিষ্কার আকাশ", icon: "☀️" }, 1: { text: "প্রধানত পরিষ্কার", icon: "🌤️" },
    2: { text: "আংশিক মেঘলা", icon: "⛅" }, 3: { text: "মেঘলা", icon: "☁️" },
    45: { text: "কুয়াশা", icon: "🌫️" }, 48: { text: "হিম কুয়াশা", icon: "🌫️" },
    51: { text: "হালকা গুঁড়ি গুঁড়ি বৃষ্টি", icon: "🌧️" }, 53: { text: "মাঝারি গুঁড়ি গুঁড়ি বৃষ্টি", icon: "🌧️" },
    55: { text: "ঘন গুঁড়ি গুঁড়ি বৃষ্টি", icon: "🌧️" }, 61: { text: "হালকা বৃষ্টি", icon: "🌧️" },
    63: { text: "মাঝারি বৃষ্টি", icon: "🌧️" }, 65: { text: "প্রবল বৃষ্টি", icon: "🌧️" },
    71: { text: "হালকা তুষারপাত", icon: "🌨️" }, 73: { text: "মাঝারি তুষারপাত", icon: "🌨️" },
    75: { text: "প্রবল তুষারপাত", icon: "🌨️" }, 77: { text: "তুষার দানা", icon: "❄️" },
    80: { text: "হালকা বৃষ্টি", icon: "🌧️" }, 81: { text: "মাঝারি বৃষ্টি", icon: "🌧️" },
    82: { text: "প্রবল বৃষ্টি", icon: "🌧️" }, 95: { text: "বজ্রপাতসহ ঝড়", icon: "⛈️" },
    96: { text: "বজ্রপাতসহ হালকা শিলাবৃষ্টি", icon: "⛈️" }, 99: { text: "বজ্রপাতসহ প্রবল শিলাবৃষ্টি", icon: "⛈️" }
};

function getBanglaDay(date) {
    const days = ['রবিবার', 'সোমবার', 'মঙ্গলবার', 'বুধবার', 'বৃহস্পতিবার', 'শুক্রবার', 'শনিবার'];
    return days[date.getDay()];
}

// --- প্রথম সেকশনের মূল ফাংশন ---
async function getWeather(city) {
    if (weatherApiKey === '') {
        weatherResult.innerHTML = '<p class="text-red-500 font-semibold">আবহাওয়া API কী সেট করা হয়নি।</p>';
        return;
    }
    weatherLoading.style.display = 'block';

    try {
        const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${weatherApiKey}&units=metric&lang=bn`);
        if (!response.ok) {
            throw new Error(response.status === 404 ? 'শহরটি খুঁজে পাওয়া যায়নি।' : 'একটি সমস্যা হয়েছে।');
        }
        const data = await response.json();
        displayWeather(data);
        localStorage.setItem('lastSearchedWeatherCity', city);
    } catch (error) {
        if (weatherResult) weatherResult.innerHTML = `<p class="text-red-500 font-semibold">${error.message}</p>`;
    } finally {
        if (weatherLoading) weatherLoading.style.display = 'none';
    }
}

function displayWeather(data) {
    const { name, main, weather, wind, sys } = data;
    const iconUrl = `https://openweathermap.org/img/wn/${weather[0].icon}@4x.png`;
    if (weatherResult) {
        weatherResult.innerHTML = `
            <h4>${name}</h4>
            <img src="${iconUrl}" alt="${weather[0].description}" class="weather-icon">
            <p class="temp">${Math.round(main.temp)}&deg;C</p>
            <p class="description">${weather[0].description}</p>
            <p class="weather-feels-like"> অনুভূত হচ্ছে: ${Math.round(main.feels_like)}&deg;C</p>
            <div class="weather-extra-details">
                <div class="detail-item"><strong>সর্বোচ্চ তাপমাত্রা</strong><span>${Math.round(main.temp_max)}&deg;C</span></div>
                <div class="detail-item"><strong>সর্বনিম্ন তাপমাত্রা</strong><span>${Math.round(main.temp_min)}&deg;C</span></div>
                <div class="detail-item"><strong>আর্দ্রতা</strong><span>${main.humidity}%</span></div>
                <div class="detail-item"><strong>বাতাসের গতি</strong><span>${wind.speed.toFixed(1)} মি/সে</span></div>
                <div class="detail-item"><strong>সূর্যোদয়</strong><span>${formatTime(sys.sunrise)}</span></div>
                <div class="detail-item"><strong>সূর্যাস্ত</strong><span>${formatTime(sys.sunset)}</span></div>
            </div>
        `;
    }
}

// --- দ্বিতীয় সেকশনের মূল ফাংশন ---
async function fetchAndDisplayWeather(latitude, longitude, locationName) {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=8`;
    try {
        const response = await fetch(url);
        const data = await response.json();
        if (data.daily) {
            forecastContainer.innerHTML = '';
            locationNameEl.textContent = locationName;
            for (let i = 0; i < data.daily.time.length; i++) {
                const date = new Date(data.daily.time[i]);
                const day = i === 0 ? "আজ" : getBanglaDay(date);
                const maxTemp = Math.round(data.daily.temperature_2m_max[i]);
                const minTemp = Math.round(data.daily.temperature_2m_min[i]);
                const weatherInfo = weatherCodes[data.daily.weathercode[i]] || { text: 'তথ্য নেই', icon: '❓' };
                const cardHtml = `
                    <div class="bg-gray-700 p-4 rounded-lg text-center text-white shadow-md transform transition-transform hover:scale-105">
                        <p class="text-xl font-bold">${day}</p>
                        <p class="text-4xl my-2">${weatherInfo.icon}</p>
                        <p class="text-lg font-semibold">${weatherInfo.text}</p>
                        <p class="text-sm">সর্বোচ্চ: ${maxTemp}°C</p>
                        <p class="text-sm">সর্বনিম্ন: ${minTemp}°C</p>
                    </div>`;
                forecastContainer.innerHTML += cardHtml;
            }
            weatherSection.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Forecast data error:', error);
    }
}

async function searchLocation(locationName) {
    const geocodingUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(locationName)}&count=1&language=bn`;
    try {
        const response = await fetch(geocodingUrl);
        const data = await response.json();
        if (data.results && data.results.length > 0) {
            const firstResult = data.results[0];
            fetchAndDisplayWeather(firstResult.latitude, firstResult.longitude, firstResult.name);
            localStorage.setItem('lastSearchedWeatherLocation', locationName);
        } else {
            locationNameEl.textContent = 'অবস্থান খুঁজে পাওয়া যায়নি।';
        }
    } catch (error) {
        console.error('Location search error:', error);
        locationNameEl.textContent = 'অবস্থান অনুসন্ধানের সময় একটি ত্রুটি হয়েছে।';
    }
}

// --- DOMContentLoaded: ইভেন্ট লিসেনার এবং অটো-রিফ্রেশ সেটআপ ---
document.addEventListener('DOMContentLoaded', () => {
    // প্রথম সেকশনের ইভেন্ট লিসেনার
    if (searchWeatherBtn) {
        searchWeatherBtn.addEventListener('click', () => {
            const city = cityInput.value.trim();
            if (city) getWeather(city);
            else showCustomAlert('অনুগ্রহ করে একটি শহরের নাম লিখুন।');
        });
    }
    if (cityInput) {
        cityInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') searchWeatherBtn.click();
        });
    }

    // দ্বিতীয় সেকশনের ইভেন্ট লিসেনার
    if (searchButtonForecast) {
        searchButtonForecast.addEventListener('click', () => {
            const location = searchInputForecast.value.trim();
            if (location) searchLocation(location);
        });
    }
    if (searchInputForecast) {
        searchInputForecast.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const location = searchInputForecast.value.trim();
                if (location) searchLocation(location);
            }
        });
    }

    // পেজ লোড হলে সর্বশেষ সার্চ করা শহরগুলো লোড করা
    const savedCity1 = localStorage.getItem('lastSearchedWeatherCity');
    if (savedCity1 && cityInput) {
        cityInput.value = savedCity1;
        getWeather(savedCity1);
    }
    const savedCity2 = localStorage.getItem('lastSearchedWeatherLocation') || 'Dhaka';
    if (searchInputForecast) searchInputForecast.value = savedCity2;
    searchLocation(savedCity2);

    // *** নতুন: প্রতি ১০ মিনিটে ডেটা রিফ্রেশ করার জন্য setInterval (গ্লোবাল ভেরিয়েবলে অ্যাসাইন করা হয়েছে) ***
    if (window.weatherRefreshIntervalId) clearInterval(window.weatherRefreshIntervalId);
    
    window.weatherRefreshIntervalId = setInterval(() => {
        console.log("Refreshing weather data (Every 10 mins)...");
        // প্রথম সেকশন রিফ্রেশ করুন
        const lastCity1 = localStorage.getItem('lastSearchedWeatherCity');
        if (lastCity1) {
            console.log(`Refreshing weather for ${lastCity1}...`);
            if(weatherResult) weatherResult.innerHTML = '';
            getWeather(lastCity1);
        }

        // দ্বিতীয় সেকশন রিফ্রেশ করুন
        const lastCity2 = localStorage.getItem('lastSearchedWeatherLocation');
        if (lastCity2) {
            console.log(`Refreshing forecast for ${lastCity2}...`);
            searchLocation(lastCity2);
        }
    }, 600000); // ৬০০০০০ মিলিসেকেন্ড = ১০ মিনিট
});

// ====================================================================
// END: COMBINED & UPDATED WEATHER SCRIPT
// ====================================================================

// ====================================================================
// START: RAPID UNDO/REDO ON HOLD SCRIPT FOR FONT CONVERTER (নতুন যুক্ত করা হয়েছে)
// ====================================================================

/**
 * বাটন চেপে ধরে রাখলে দ্রুত কাজ করার ফাংশন সেটআপ করে।
 * @param {string} buttonId - বাটনের আইডি।
 * @param {function} actionFunction - যে ফাংশনটি বারবার কল করা হবে (যেমন: undoText)।
 * @param {string} textareaId - যে টেক্সটএরিয়ার ওপর কাজটি হবে।
 */
function setupHoldableButton(buttonId, actionFunction, textareaId) {
    const button = document.getElementById(buttonId);
    if (!button) return;

    let holdTimeoutId = null;
    let repeatIntervalId = null;

    const startRepeating = () => {
        // আগের কোনো ইন্টারভ্যাল থাকলে তা পরিষ্কার করুন
        if (repeatIntervalId) clearInterval(repeatIntervalId);
        
        // কাজটি রিপিট করা শুরু করুন
        repeatIntervalId = setInterval(() => {
            actionFunction(textareaId);
            // যদি বাটনটি নিষ্ক্রিয় হয়ে যায়, তাহলে রিপিট করা বন্ধ করুন
            if (button.disabled) {
                stopRepeating();
            }
        }, 120); // প্রতি 120 মিলিসেকেন্ডে কাজটি রিপিট করুন
    };

    const stopRepeating = () => {
        clearTimeout(holdTimeoutId);
        clearInterval(repeatIntervalId);
        holdTimeoutId = null;
        repeatIntervalId = null;
    };

    const handlePress = (e) => {
        // টেক্সট সিলেকশন বা অন্যান্য ডিফল্ট আচরণ বন্ধ করুন
        if (e.cancelable) {
            e.preventDefault();
        }

        // প্রেস করার সাথে সাথে একবার কাজটি করুন
        actionFunction(textareaId);
        
        // একটি নির্দিষ্ট সময় পর কাজটি রিপিট করা শুরু করুন
        holdTimeoutId = setTimeout(startRepeating, 400); // 400ms পর রিপিট শুরু হবে
    };

    // মাউসের জন্য ইভেন্ট লিসেনার
    button.addEventListener('mousedown', handlePress);
    button.addEventListener('mouseup', stopRepeating);
    button.addEventListener('mouseleave', stopRepeating);
    
    // মোবাইলের টাচ ইভেন্টের জন্য লিসেনার
    button.addEventListener('touchstart', handlePress, { passive: false });
    button.addEventListener('touchend', stopRepeating);
    button.addEventListener('touchcancel', stopRepeating);
}

// DOMContentLoaded এর মধ্যে এই সেটআপ ফাংশনগুলো কল করুন যাতে বাটনগুলো লোড হওয়ার পর ইভেন্ট যুক্ত হয়।
document.addEventListener('DOMContentLoaded', () => {
    setupHoldableButton('undoButtonLeft', undoText, 'textAreaLeft');
    setupHoldableButton('redoButtonLeft', redoText, 'textAreaLeft');
    setupHoldableButton('undoButtonRight', undoText, 'textAreaRight');
    setupHoldableButton('redoButtonRight', redoText, 'textAreaRight');
});

// ====================================================================
// END: RAPID UNDO/REDO ON HOLD SCRIPT FOR FONT CONVERTE
// ====================================================================

// ====================================================================
// START: PLAYER TAB SCRIPT (প্লেব্যাক রিসেট ও মেমোরি ম্যানেজমেন্ট ফিক্সড)
// ====================================================================
function initializePlayerTab() {
    const playerContentDiv = document.getElementById('playerContent');
    if (playerContentDiv.getAttribute('data-player-initialized') === 'true') {
        return; 
    }
    playerContentDiv.setAttribute('data-player-initialized', 'true');

    // Audio Elements
    const audioInput = document.getElementById('audioInput');
    const audioPlayer = document.getElementById('audioPlayer');
    const audioFileName = document.getElementById('audioFileName');
    const audioDropZone = audioInput?.closest('.player-section');
    const audioLoopToggle = document.getElementById('audioLoopToggle');
    const clearAudioBtn = document.getElementById('clearAudioBtn');

    // Image Elements
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    const imageDropZone = imageInput?.closest('.player-section');
    const clearImageBtn = document.getElementById('clearImageBtn');

    // Video Elements
    const videoInput = document.getElementById('videoInput');
    const videoPlayer = document.getElementById('videoPlayer');
    const videoDropZone = videoInput?.closest('.player-section');
    const videoLoopToggle = document.getElementById('videoLoopToggle');
    const clearVideoBtn = document.getElementById('clearVideoBtn');
    
    const moveToAudioBtn = document.getElementById('moveToAudioBtn');
    let currentVideoFile = null;

    // URL ট্র্যাক করার জন্য গ্লোবাল ভেরিয়েবল
    let currentAudioUrl = null;
    let currentVideoUrl = null;

    // --- IndexedDB Delete Helper (অভ্যন্তরীণ ফাংশন) ---
    async function deleteFromDb(key) {
        try {
            // গ্লোবাল getDb() ফাংশন ব্যবহার করা হচ্ছে
            const db = await getDb();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(key);

                transaction.oncomplete = () => {
                    console.log(`Deleted ${key} from IndexedDB successfully.`);
                    resolve(true);
                };
                transaction.onerror = (event) => {
                    console.error(`Failed to delete ${key}:`, event.target.error);
                    reject(event.target.error);
                };
            });
        } catch (e) {
            console.error("Error accessing DB for deletion:", e);
        }
    }

    // --- MediaSession সেটআপ ---
    function setupMediaSession(fileName, playerType) {
        if ('mediaSession' in navigator) {
            const player = playerType === 'video' ? videoPlayer : audioPlayer;
            const artIcon = playerType === 'video' 
                ? 'https://placehold.co/128x128/e0e7ff/3f51b5?text=Video' 
                : 'https://placehold.co/128x128/e0e7ff/3f51b5?text=Audio';

            navigator.mediaSession.metadata = new MediaMetadata({
                title: fileName,
                artist: 'Bangla Toolbox Player',
                album: 'Local Media',
                artwork: [{ src: artIcon, sizes: '128x128', type: 'image/png' }]
            });

            navigator.mediaSession.setActionHandler('play', () => player.play());
            navigator.mediaSession.setActionHandler('pause', () => player.pause());
            navigator.mediaSession.setActionHandler('seekbackward', (details) => {
                player.currentTime = Math.max(player.currentTime - (details.seekOffset || 10), 0);
            });
            navigator.mediaSession.setActionHandler('seekforward', (details) => {
                player.currentTime = Math.min(player.currentTime + (details.seekOffset || 10), player.duration);
            });
        }
    }

    // ১. অডিও হ্যান্ডলার
    async function handleAudioFile(file) {
        if (!file || !audioPlayer || !audioFileName) return;

        if (videoPlayer && !videoPlayer.paused) videoPlayer.pause();

        if (currentAudioUrl) URL.revokeObjectURL(currentAudioUrl);

        currentAudioUrl = URL.createObjectURL(file);
        audioPlayer.src = currentAudioUrl;
        audioFileName.textContent = file.name;
        
        if (clearAudioBtn) clearAudioBtn.classList.remove('hidden');
        
        audioPlayer.onloadedmetadata = () => {
             audioPlayer.play()
                .then(() => setupMediaSession(file.name, 'audio'))
                .catch(err => console.log("Auto-play blocked"));
        };

        // IndexedDB সেভ
        if (file.size < 100 * 1024 * 1024) { // ১০০ এমবি লিমিট
            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    await idbSet('persistedPlayerAudio', {
                        name: file.name,
                        type: file.type,
                        content: e.target.result
                    });
                };
                reader.readAsArrayBuffer(file);
            } catch (err) {}
        }
    }

    // ২. ভিডিও হ্যান্ডলার
    function handleVideoFile(file) {
        if (!file || !videoPlayer) return;
        
        if (audioPlayer && !audioPlayer.paused) audioPlayer.pause();

        if (currentVideoUrl) URL.revokeObjectURL(currentVideoUrl);

        currentVideoFile = file;
        currentVideoUrl = URL.createObjectURL(file);
        
        videoPlayer.src = currentVideoUrl;
        videoPlayer.load(); 
        
        if (clearVideoBtn) clearVideoBtn.classList.remove('hidden');
        if (moveToAudioBtn) moveToAudioBtn.classList.remove('hidden');
        
        videoPlayer.onloadedmetadata = () => {
            videoPlayer.play()
               .then(() => setupMediaSession(file.name, 'video'))
               .catch(err => console.log("Video Play blocked"));
       };
        
        videoPlayer.onerror = () => {
            console.error("Video loading error");
            if(currentVideoUrl) URL.revokeObjectURL(currentVideoUrl);
        };
    }

    // ৩. ছবি হ্যান্ডলার
    function handleImageFile(file) {
        if (!file || !imagePreview) return;
        const objectURL = URL.createObjectURL(file);
        imagePreview.src = objectURL;
        imagePreview.onload = () => URL.revokeObjectURL(objectURL);
        
        if (clearImageBtn) clearImageBtn.classList.remove('hidden');
    }

    // ইনপুট লিসেনার
    if (audioInput) {
        audioInput.addEventListener('change', e => {
            if (e.target.files[0]) {
                handleAudioFile(e.target.files[0]);
                e.target.value = ''; 
            }
        });
    }
    if (imageInput) {
        imageInput.addEventListener('change', e => {
            if (e.target.files[0]) {
                handleImageFile(e.target.files[0]);
                e.target.value = '';
            }
        });
    }
    if (videoInput) {
        videoInput.addEventListener('change', e => {
            if (e.target.files[0]) {
                handleVideoFile(e.target.files[0]);
                e.target.value = '';
            }
        });
    }

    // ক্লিয়ার বাটন লিসেনার (Audio) - ফিক্সড ভার্সন
    if (clearAudioBtn) {
        clearAudioBtn.addEventListener('click', async () => {
            // ১. প্লেয়ার থামান এবং রিসেট করুন
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.removeAttribute('src'); // src পুরোপুরি রিমুভ
                audioPlayer.load();
            }
            // ২. URLrevoke করুন
            if (currentAudioUrl) {
                URL.revokeObjectURL(currentAudioUrl);
                currentAudioUrl = null;
            }
            // ৩. UI আপডেট করুন
            if (audioFileName) audioFileName.textContent = '';
            if (audioInput) audioInput.value = '';
            clearAudioBtn.classList.add('hidden');
            
            // ৪. স্টোরেজ থেকে ডিলিট করুন (await ব্যবহার করে নিশ্চিত করা হচ্ছে)
            await deleteFromDb('persistedPlayerAudio');
            showCustomAlert('অডিও মুছে ফেলা হয়েছে।');
        });
    }

    // ক্লিয়ার বাটন লিসেনার (Image)
    if (clearImageBtn) {
        clearImageBtn.addEventListener('click', () => {
             if (imagePreview) imagePreview.src = 'https://placehold.co/600x400/e2e8f0/4a5568?text=ছবি+লোড+করুন';
             if (imageInput) imageInput.value = '';
             clearImageBtn.classList.add('hidden');
        });
    }

    // ক্লিয়ার বাটন লিসেনার (Video)
    if (clearVideoBtn) {
        clearVideoBtn.addEventListener('click', () => {
            if (currentVideoUrl) URL.revokeObjectURL(currentVideoUrl);
            if (videoPlayer) {
                videoPlayer.pause();
                videoPlayer.src = '';
                videoPlayer.load();
            }
            if (videoInput) videoInput.value = '';
            clearVideoBtn.classList.add('hidden');
            if (moveToAudioBtn) moveToAudioBtn.classList.add('hidden');
            currentVideoFile = null;
        });
    }

    // মুভ টু অডিও
    if (moveToAudioBtn) {
        moveToAudioBtn.addEventListener('click', () => {
            if (currentVideoFile) {
                if (videoPlayer) videoPlayer.pause();
                handleAudioFile(currentVideoFile);
                const audioSection = document.querySelector('.player-section');
                if (audioSection) {
                    audioSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    audioSection.classList.add('ring-4', 'ring-indigo-500');
                    setTimeout(() => audioSection.classList.remove('ring-4', 'ring-indigo-500'), 1500);
                }
            }
        });
    }

    // লুপ সেটিংস
    if (audioLoopToggle && audioPlayer) {
        audioPlayer.loop = audioLoopToggle.checked;
        audioLoopToggle.addEventListener('change', () => audioPlayer.loop = audioLoopToggle.checked);
    }
    if (videoLoopToggle && videoPlayer) {
        videoPlayer.loop = videoLoopToggle.checked;
        videoLoopToggle.addEventListener('change', () => videoPlayer.loop = videoLoopToggle.checked);
    }

    // ড্র্যাগ অ্যান্ড ড্রপ
    function setupDragAndDrop(dropZone, type, handler) {
        if (!dropZone) return;
        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const file = e.dataTransfer?.files[0];
            if (file && file.type.startsWith(type)) handler(file);
        });
    }

    setupDragAndDrop(audioDropZone, 'audio/', handleAudioFile);
    setupDragAndDrop(imageDropZone, 'image/', handleImageFile);
    setupDragAndDrop(videoDropZone, 'video/', handleVideoFile);

    // রিফ্রেশে অডিও লোড (যদি স্টোরেজে থাকে)
    async function loadPersistedAudio() {
        if (!audioPlayer) return;
        try {
            const savedData = await idbGet('persistedPlayerAudio');
            if (savedData && savedData.content) {
                const blob = new Blob([savedData.content], { type: savedData.type });
                currentAudioUrl = URL.createObjectURL(blob);
                audioPlayer.src = currentAudioUrl;
                audioFileName.textContent = savedData.name + " (সংরক্ষিত)";
                setupMediaSession(savedData.name, 'audio');
                if (clearAudioBtn) clearAudioBtn.classList.remove('hidden');
            }
        } catch (err) {}
    }
    loadPersistedAudio();
}

document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('playerContent')?.classList.contains('active')) initializePlayerTab();
    document.getElementById('playerTab')?.addEventListener('click', initializePlayerTab);
});
// ====================================================================
// END: PLAYER TAB SCRIPT
// ====================================================================



// ====================================================================
// START: QR CODE GENERATOR SCRIPT (Updated with Live Generation & Unicode Fix)
// ====================================================================
document.addEventListener('DOMContentLoaded', () => {
    const qrContent = document.getElementById('qrCodeContent');
    if (!qrContent) return; // যদি ট্যাবের কন্টেন্ট না থাকে, তবে কিছুই করবেন না।

    const qrInput = document.getElementById('qrInput');
    const downloadQrBtn = document.getElementById('downloadQrBtn');
    const clearQrBtn = document.getElementById('clearQrBtn');
    const qrcodeContainer = document.getElementById('qrcode');
    const qrcodePlaceholder = document.getElementById('qrcode-placeholder');
    const qrFileInput = document.getElementById('qrFileInput');
    const dropZone = document.querySelector('.qr-code-content'); // QR সেকশনের প্রধান কন্টেইনার

    let qrCodeInstance = null;
    let debounceTimer; // লাইভ আপডেটের জন্য টাইমার

// QR কোড তৈরি করার ফাংশন (লাইভ এবং ইউনিকোড সাপোর্টেড)
const generateQRCode = () => {
    // পরিবর্তন: .trim() সরিয়ে দেওয়া হয়েছে যাতে ব্যবহারকারী চাইলে স্পেসসহ কোড তৈরি করতে পারে।
    const text = qrInput.value;

    // যদি ইনপুট খালি থাকে, তাহলে QR কোড এরিয়া রিসেট করুন
    if (!text) {
        resetQrCodeArea();
        return;
    }

    if (qrcodeContainer) qrcodeContainer.innerHTML = '';
    if (qrcodePlaceholder) qrcodePlaceholder.style.display = 'none';

    try {
        // মূল পরিবর্তন: এখানে encodeURIComponent ব্যবহার করা হয়নি।
        // লাইব্রেরীটি সরাসরি বাংলাসহ যেকোনো UTF-8 টেক্সট হ্যান্ডেল করতে পারে।
        qrCodeInstance = new QRCode(qrcodeContainer, {
            text: text, // সরাসরি মূল টেক্সট ব্যবহার করা হয়েছে
            width: 256,
            height: 256,
            colorDark: "#000000",
            colorLight: "#ffffff",
            // পরিবর্তন: Error Correction Level 'H' (High) থেকে 'L' (Low) করা হয়েছে।
            // এর ফলে একই পরিমাণ ডেটার জন্য QR কোডটি কম ঘন (অল্পসংখ্যক দাগ) হবে।
            // এটি বাংলাসহ যেকোনো ভাষার জন্য কাজ করবে।
            correctLevel: QRCode.CorrectLevel.L
        });
        if (downloadQrBtn) downloadQrBtn.disabled = false;
    } catch (error) {
        console.error("QR Code generation error:", error);
        showCustomAlert("কিউআর কোড তৈরিতে একটি সমস্যা হয়েছে।");
        resetQrCodeArea();
    }
};

    // QR কোড ডাউনলোড করার ফাংশন
    const downloadQRCode = () => {
        if (!qrcodeContainer) return;
        const canvas = qrcodeContainer.querySelector('canvas');
        if (!canvas) {
            showCustomAlert('ডাউনলোড করার জন্য কোনো কিউআর কোড নেই।');
            return;
        }

        const dataUrl = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = 'qrcode.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    // ইনপুট এবং ফলাফল পরিষ্কার করার ফাংশন
    const resetQrCodeArea = () => {
        if (qrInput) qrInput.value = '';
        if (qrcodeContainer) qrcodeContainer.innerHTML = '';
        if (qrcodePlaceholder) qrcodePlaceholder.style.display = 'flex';
        if (downloadQrBtn) downloadQrBtn.disabled = true;
        qrCodeInstance = null;
    };

    // আপলোড বা ড্রপ করা ফাইল হ্যান্ডেল করার ফাংশন
    const handleQrFile = (file) => {
        if (!file || !file.type.startsWith('image/')) {
            showCustomAlert('অনুগ্রহ করে একটি ছবি ফাইল নির্বাচন করুন।');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d', { willReadFrequently: true });
                canvas.width = img.width;
                canvas.height = img.height;
                context.drawImage(img, 0, 0, img.width, img.height);
                const imageData = context.getImageData(0, 0, img.width, img.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    // QR কোড থেকে পাওয়া ডেটা সরাসরি টেক্সটবক্সে দেখানো হচ্ছে।
                    if (qrInput) qrInput.value = code.data;
                    showCustomAlert('QR কোড থেকে তথ্য পাওয়া গেছে!');
                    generateQRCode(); // তথ্য পাওয়ার পর সাথে সাথে নতুন QR কোড তৈরি করা হচ্ছে
                } else {
                    showCustomAlert('দুঃখিত, কোনো QR কোড খুঁজে পাওয়া যায়নি।');
                }
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    };

    // --- নতুন: লাইভ আপডেটের জন্য ইভেন্ট লিসেনার ---
    if (qrInput) {
        qrInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            // ব্যবহারকারী টাইপ থামানোর ৩০০ মিলিসেকেন্ড পর QR কোড তৈরি হবে
            debounceTimer = setTimeout(() => {
                generateQRCode();
            }, 300);
        });
    }

    // বাটনগুলোর জন্য ইভেন্ট লিসেনার
    if (downloadQrBtn) downloadQrBtn.addEventListener('click', downloadQRCode);
    if (clearQrBtn) {
        clearQrBtn.addEventListener('click', () => {
            resetQrCodeArea();
            showCustomAlert('ইনপুট এবং কিউআর কোড পরিষ্কার করা হয়েছে।');
        });
    }

    // ফাইল আপলোডের জন্য ইভেন্ট লিসেনার
    if (qrFileInput) {
        qrFileInput.addEventListener('change', (e) => {
            handleQrFile(e.target.files[0]);
            e.target.value = ''; // একই ফাইল আবার আপলোড করার জন্য ইনপুট রিসেট করুন
        });
    }
    
    // --- ড্র্যাগ অ্যান্ড ড্রপ ইভেন্ট লিসেনার ---
    if (dropZone) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
        });
        dropZone.addEventListener('drop', (e) => {
            handleQrFile(e.dataTransfer.files[0]);
        }, false);
    }
});
// ====================================================================
// END: QR CODE GENERATOR SCRIPT
// ====================================================================

// ====================================================================
// START: EMERGENCY NUMBERS SCRIPT
// ====================================================================
function initializeEmergencyNumbers() {
    const locationSelect = document.getElementById('location-select');
    const numbersDisplay = document.getElementById('emergency-numbers-display');
    const addCardBtn = document.getElementById('addEmergencyCardBtn'); // নতুন বাটন

    const districtNameMap = {
        "national": "জাতীয় জরুরি সেবা", "Bagerhat": "বাগেরহাট", "Bandarban": "বান্দরবান", "Barguna": "বরগুনা", "Barisal": "বরিশাল", "Bhola": "ভোলা", "Bogra": "বগুড়া", "Brahmanbaria": "ব্রাহ্মণবাড়িয়া", "Chandpur": "চাঁদপুর", "Chapai Nawabganj": "চাঁপাইনবাবগঞ্জ", "Chittagong": "চট্টগ্রাম", "Chuadanga": "চুয়াডাঙ্গা", "Comilla": "কুমিল্লা", "Cox's Bazar": "কক্সবাজার", "Dhaka": "ঢাকা", "Dinajpur": "দিনাজপুর", "Faridpur": "ফরিদপুর", "Feni": "ফেনী", "Gaibandha": "গাইবান্ধা", "Gazipur": "গাজীপুর", "Gopalganj": "গোপালগঞ্জ", "Habiganj": "হবিগঞ্জ", "Jamalpur": "জামালপুর", "Jessore": "যশোর", "Jhalokati": "ঝালকাঠি", "Jhenaidah": "ঝিনাইদহ", "Joypurhat": "জয়পুরহাট", "Khagrachhari": "খাগড়াছড়ি", "Khulna": "খুলনা", "Kishoreganj": "কিশোরগঞ্জ", "Kurigram": "কুড়িগ্রাম", "Kushtia": "কুষ্টিয়া", "Lakshmipur": "লক্ষ্মীপুর", "Lalmonirhat": "লালমনিরহাট", "Madaripur": "মাদারীপুর", "Magura": "মাগুরা", "Manikganj": "মানিকগঞ্জ", "Meherpur": "মেহেরপুর", "Moulvibazar": "মৌলভীবাজার", "Munshiganj": "মুন্সিগঞ্জ", "Mymensingh": "ময়মনসিংহ", "Naogaon": "নওগাঁ", "Narail": "নড়াইল", "Narayanganj": "নারায়ণগঞ্জ", "Narsingdi": "নরসিংদী", "Natore": "নাটোর", "Netrokona": "নেত্রকোনা", "Nilphamari": "নীলফামারী", "Noakhali": "নোয়াখালী", "Pabna": "পাবনা", "Panchagarh": "পঞ্চগড়", "Patuakhali": "পটুয়াখালী", "Pirojpur": "পিরোজপুর", "Rajbari": "রাজবাড়ী", "Rajshahi": "রাজশাহী", "Rangamati": "রাঙ্গামাটি", "Rangpur": "রংপুর", "Satkhira": "সাতক্ষীরা", "Shariatpur": "শরীয়তপুর", "Sherpur": "শেরপুর", "Sirajganj": "সিরাজগঞ্জ", "Sunamganj": "সুনামগঞ্জ", "Sylhet": "সিলেট", "Tangail": "টাঙ্গাইল", "Thakurgaon": "ঠাকুরগাঁও"
    };
    const emergencyNumbersData = {
        "national": [
            { name: "জাতীয় জরুরি সেবা", number: "999" }, { name: "নারী ও শিশু নির্যাতন প্রতিরোধ", number: "109" }, { name: "শিশু সহায়তা", number: "1098" }, { name: "সরকারি আইন সেবা", number: "16430" }, { name: "দুর্নীতি দমন কমিশন", number: "106" }, { name: "স্বাস্থ্য বাতায়ন", number: "16263" }, { name: "দুর্যোগের আগাম বার্তা", number: "1090" }, { name: "বাংলাদেশ ব্যাংক", number: "16236" },
        ],
        "Gaibandha": [
            { name: "পুলিশ সুপার, গাইবান্ধা", number: "01320132500" }, { name: "ফায়ার সার্ভিস, গাইবান্ধা", number: "0541-62222" }, { name: "সদর হাসপাতাল, গাইবান্ধা", number: "+88054161400" }, { name: "সিভিল সার্জন, গাইবান্ধা", number: "01730324729" }, { name: "অ্যাম্বুলেন্স, সদর হাসপাতাল", number: "01730324765" }, { name: "গাইবান্ধা পল্লী বিদ্যুৎ", number: "01769403505" },
        ],
        "Dhaka": [
            { name: "ডিএমপি কন্ট্রোল রুম", number: "01320-042000" }, { name: "ফায়ার সার্ভিস হেডকোয়ার্টার", number: "02-223355555" }, { name: "ঢাকা মেডিকেল কলেজ হাসপাতাল", number: "+880-2-55165000" }, { name: "বঙ্গবন্ধু শেখ মুজিব মেডিকেল বিশ্ববিদ্যালয়", number: "+880-2-55165760" }, { name: "ঢাকা বিদ্যুৎ বিতরণ কর্তৃপক্ষ", number: "16116" },
        ],
        "Bagerhat": [{ name: "পুলিশ সুপার, বাগেরহাট", number: "01320142100" }, { name: "ফায়ার সার্ভিস, বাগেরহাট", number: "02-47772222" }, { name: "সদর হাসপাতাল, বাগেরহাট", number: "+88046863232" }], "Bandarban": [{ name: "পুলিশ সুপার, বান্দরবান", number: "01320142200" }, { name: "ফায়ার সার্ভিস, বান্দরবান", number: "0361-62555" }, { name: "সদর হাসপাতাল, বান্দরবান", number: "+88036162544" }], "Barguna": [{ name: "পুলিশ সুপার, বরগুনা", number: "01320142300" }, { name: "ফায়ার সার্ভিস, বরগুনা", number: "0448-62444" }, { name: "সদর হাসপাতাল, বরগুনা", number: "+88044862234" }], "Barisal": [{ name: "পুলিশ সুপার, বরিশাল", number: "01320142400" }, { name: "ফায়ার সার্ভিস, বরিশাল", number: "0431-63888" }, { name: "শের-ই-বাংলা মেডিকেল কলেজ হাসপাতাল", number: "+880431-2173314" }], "Bhola": [{ name: "পুলিশ সুপার, ভোলা", number: "01320142600" }, { name: "ফায়ার সার্ভিস, ভোলা", number: "0491-61333" }, { name: "সদর হাসপাতাল, ভোলা", number: "+88049161291" }], "Bogra": [{ name: "পুলিশ সুপার, বগুড়া", number: "01320132900" }, { name: "ফায়ার সার্ভিস, বগুড়া", number: "051-65555" }, { name: "শহীদ জিয়াউর রহমান মেডিকেল কলেজ", number: "+88051-78701" }], "Brahmanbaria": [{ name: "পুলিশ সুপার, ব্রাহ্মণবাড়িয়া", number: "01320133200" }, { name: "ফায়ার সার্ভিস, ব্রাহ্মণবাড়িয়া", number: "0851-61444" }, { name: "সদর হাসপাতাল, ব্রাহ্মণবাড়িয়া", number: "+88085158494" }], "Chandpur": [{ name: "পুলিশ সুপার, চাঁদপুর", number: "01320133400" }, { name: "ফায়ার সার্ভিস, চাঁদপুর", number: "0841-63333" }, { name: "সদর হাসপাতাল, চাঁদপুর", number: "+88084163497" }], "Chapai Nawabganj": [{ name: "পুলিশ সুপার, চাঁপাইনবাবগঞ্জ", number: "01320133500" }, { name: "ফায়ার সার্ভিস, চাঁপাইনবাবগঞ্জ", number: "0781-52333" }, { name: "সদর হাসপাতাল, চাঁপাইনবাবগঞ্জ", number: "+88078152341" }], "Chittagong": [{ name: "সিএমপি কন্ট্রোল রুম", number: "01676-123123" }, { name: "ফায়ার সার্ভিস, আগ্রাবাদ", number: "031-634444" }, { name: "চট্টগ্রাম মেডিকেল কলেজ হাসপাতাল", number: "+88031619620" }], "Chuadanga": [{ name: "পুলিশ সুপার, চুয়াডাঙ্গা", number: "01320143000" }, { name: "ফায়ার সার্ভিস, চুয়াডাঙ্গা", number: "0761-62333" }, { name: "সদর হাসপাতাল, চুয়াডাঙ্গা", number: "+88076162312" }], "Comilla": [{ name: "পুলিশ সুপার, কুমিল্লা", number: "01320134000" }, { name: "ফায়ার সার্ভিস, কুমিল্লা", number: "081-76333" }, { name: "কুমিল্লা মেডিকেল কলেজ হাসপাতাল", number: "+8808168788" }], "Cox's Bazar": [{ name: "পুলিশ সুপার, কক্সবাজার", number: "01320134300" }, { name: "ফায়ার সার্ভিস, কক্সবাজার", number: "0341-64333" }, { name: "সদর হাসপাতাল, কক্সবাজার", number: "+88034164222" }], "Dinajpur": [{ name: "পুলিশ সুপার, দিনাজপুর", number: "01320134800" }, { name: "ফায়ার সার্ভিস, দিনাজপুর", number: "0531-64444" }, { name: "এম আব্দুর রহিম মেডিকেল কলেজ হাসপাতাল", number: "+88053163152" }], "Faridpur": [{ name: "পুলিশ সুপার, ফরিদপুর", number: "01320135100" }, { name: "ফায়ার সার্ভিস, ফরিদপুর", number: "0631-63333" }, { name: "বঙ্গবন্ধু শেখ মুজিব মেডিকেল কলেজ", number: "+88063162758" }], "Feni": [{ name: "পুলিশ সুপার, ফেনী", number: "01320135300" }, { name: "ফায়ার সার্ভিস, ফেনী", number: "0331-63333" }, { name: "সদর হাসপাতাল, ফেনী", number: "+88033162000" }], "Gazipur": [{ name: "জিএমপি কন্ট্রোল রুম", number: "01320042000" }, { name: "ফায়ার সার্ভিস, গাজীপুর", number: "02-9263333" }, { name: "শহীদ তাজউদ্দীন আহমদ মেডিকেল কলেজ", number: "+88029263004" }], "Gopalganj": [{ name: "পুলিশ সুপার, গোপালগঞ্জ", number: "01320135800" }, { name: "ফায়ার সার্ভিস, গোপালগঞ্জ", number: "0668-61333" }, { name: "সদর হাসপাতাল, গোপালগঞ্জ", number: "+88066861250" }], "Habiganj": [{ name: "পুলিশ সুপার, হবিগঞ্জ", number: "01320136000" }, { name: "ফায়ার সার্ভিস, হবিগঞ্জ", number: "0831-64444" }, { name: "সদর হাসপাতাল, হবিগঞ্জ", number: "+88083162094" }], "Jamalpur": [{ name: "পুলিশ সুপার, জামালপুর", number: "01320136200" }, { name: "ফায়ার সার্ভিস, জামালপুর", number: "0981-63333" }, { name: "সদর হাসপাতাল, জামালপুর", number: "+88098163450" }], "Jessore": [{ name: "পুলিশ সুপার, যশোর", number: "01320143400" }, { name: "ফায়ার সার্ভিস, যশোর", number: "0421-68888" }, { name: "সদর হাসপাতাল, যশোর", number: "+88042165215" }], "Jhalokati": [{ name: "পুলিশ সুপার, ঝালকাঠি", number: "01320142800" }, { name: "ফায়ার সার্ভিস, ঝালকাঠি", number: "0498-63333" }, { name: "সদর হাসপাতাল, ঝালকাঠি", number: "+88049863453" }], "Jhenaidah": [{ name: "পুলিশ সুপার, ঝিনাইদহ", number: "01320143700" }, { name: "ফায়ার সার্ভিস, ঝিনাইদহ", number: "0451-62333" }, { name: "সদর হাসপাতাল, ঝিনাইদহ", number: "+88045162300" }], "Joypurhat": [{ name: "পুলিশ সুপার, জয়পুরহাট", number: "01320136400" }, { name: "ফায়ার সার্ভিস, জয়পুরহাট", number: "0571-62333" }, { name: "সদর হাসপাতাল, জয়পুরহাট", number: "+88057162241" }], "Khagrachhari": [{ name: "পুলিশ সুপার, খাগড়াছড়ি", number: "01320136600" }, { name: "ফায়ার সার্ভিস, খাগড়াছড়ি", number: "0371-61555" }, { name: "সদর হাসপাতাল, খাগড়াছড়ি", number: "+88037161828" }], "Khulna": [{ name: "কেএমপি কন্ট্রোল রুম", number: "01320-043100" }, { name: "ফায়ার সার্ভিস, খুলনা", number: "041-762222" }, { name: "খুলনা মেডিকেল কলেজ হাসপাতাল", number: "+88041761699" }], "Kishoreganj": [{ name: "পুলিশ সুপার, কিশোরগঞ্জ", number: "01320136800" }, { name: "ফায়ার সার্ভিস, কিশোরগঞ্জ", number: "0941-61999" }, { name: "সদর হাসপাতাল, কিশোরগঞ্জ", number: "+88094161962" }], "Kurigram": [{ name: "পুলিশ সুপার, কুড়িগ্রাম", number: "01320137000" }, { name: "ফায়ার সার্ভিস, কুড়িগ্রাম", number: "0581-61666" }, { name: "সদর হাসপাতাল, কুড়িগ্রাম", number: "+88058161541" }], "Kushtia": [{ name: "পুলিশ সুপার, কুষ্টিয়া", number: "01320144200" }, { name: "ফায়ার সার্ভিস, কুষ্টিয়া", number: "071-62222" }, { name: "সদর হাসপাতাল, কুষ্টিয়া", number: "+8807162339" }], "Lakshmipur": [{ name: "পুলিশ সুপার, লক্ষ্মীপুর", number: "01320137300" }, { name: "ফায়ার সার্ভিস, লক্ষ্মীপুর", number: "0381-61444" }, { name: "সদর হাসপাতাল, লক্ষ্মীপুর", number: "+88038161350" }], "Lalmonirhat": [{ name: "পুলিশ সুপার, লালমনিরহাট", number: "01320137500" }, { name: "ফায়ার সার্ভিস, লালমনিরহাট", number: "0591-61333" }, { name: "সদর হাসপাতাল, লালমনিরহাট", number: "+88059161300" }], "Madaripur": [{ name: "পুলিশ সুপার, মাদারীপুর", number: "01320137700" }, { name: "ফায়ার সার্ভিস, মাদারীপুর", number: "0661-61777" }, { name: "সদর হাসপাতাল, মাদারীপুর", number: "+88066161835" }], "Magura": [{ name: "পুলিশ সুপার, মাগুরা", number: "01320144400" }, { name: "ফায়ার সার্ভিস, মাগুরা", number: "0488-62444" }, { name: "সদর হাসপাতাল, মাগুরা", number: "+88048862441" }], "Manikganj": [{ name: "পুলিশ সুপার, মানিকগঞ্জ", number: "01320137900" }, { name: "ফায়ার সার্ভিস, মানিকগঞ্জ", number: "02-7710333" }, { name: "সদর হাসপাতাল, মানিকগঞ্জ", number: "+88027710202" }], "Meherpur": [{ name: "পুলিশ সুপার, মেহেরপুর", number: "01320144600" }, { name: "ফায়ার সার্ভিস, মেহেরপুর", number: "0791-62333" }, { name: "সদর হাসপাতাল, মেহেরপুর", number: "+88079162234" }], "Moulvibazar": [{ name: "পুলিশ সুপার, মৌলভীবাজার", number: "01320138100" }, { name: "ফায়ার সার্ভিস, মৌলভীবাজার", number: "0861-52333" }, { name: "সদর হাসপাতাল, মৌলভীবাজার", number: "+88086152285" }], "Munshiganj": [{ name: "পুলিশ সুপার, মুন্সিগঞ্জ", number: "01320138300" }, { name: "ফায়ার সার্ভিস, মুন্সিগঞ্জ", number: "02-7612222" }, { name: "সদর হাসপাতাল, মুন্সিগঞ্জ", number: "+88027612140" }], "Mymensingh": [{ name: "পুলিশ সুপার, ময়মনসিংহ", number: "01320138500" }, { name: "ফায়ার সার্ভিস, ময়মনসিংহ", number: "091-65555" }, { name: "ময়মনসিংহ মেডিকেল কলেজ হাসপাতাল", number: "+8809166060" }], "Naogaon": [{ name: "পুলিশ সুপার, নওগাঁ", number: "01320138800" }, { name: "ফায়ার সার্ভিস, নওগাঁ", number: "0741-62333" }, { name: "সদর হাসপাতাল, নওগাঁ", number: "+88074162351" }], "Narail": [{ name: "পুলিশ সুপার, নড়াইল", number: "01320144800" }, { name: "ফায়ার সার্ভিস, নড়াইল", number: "0481-62444" }, { name: "সদর হাসপাতাল, নড়াইল", number: "+88048162268" }], "Narayanganj": [{ name: "পুলিশ সুপার, নারায়ণগঞ্জ", number: "01320139000" }, { name: "ফায়ার সার্ভিস, নারায়ণগঞ্জ", number: "02-7647333" }, { name: "সদর হাসপাতাল, নারায়ণগঞ্জ", number: "+88027649501" }], "Narsingdi": [{ name: "পুলিশ সুপার, নরসিংদী", number: "01320139200" }, { name: "ফায়ার সার্ভিস, নরসিংদী", number: "02-9462333" }, { name: "সদর হাসপাতাল, নরসিংদী", number: "+88029462270" }], "Natore": [{ name: "পুলিশ সুপার, নাটোর", number: "01320139400" }, { name: "ফায়ার সার্ভিস, নাটোর", number: "0771-66333" }, { name: "সদর হাসপাতাল, নাটোর", number: "+88077166556" }], "Netrokona": [{ name: "পুলিশ সুপার, নেত্রকোনা", number: "01320139600" }, { name: "ফায়ার সার্ভিস, নেত্রকোনা", number: "0951-61444" }, { name: "সদর হাসপাতাল, নেত্রকোনা", number: "+88095161560" }], "Nilphamari": [{ name: "পুলিশ সুপার, নীলফামারী", number: "01320139800" }, { name: "ফায়ার সার্ভিস, নীলফামারী", number: "0551-61444" }, { name: "সদর হাসপাতাল, নীলফামারী", number: "+88055161300" }], "Noakhali": [{ name: "পুলিশ সুপার, নোয়াখালী", number: "01320140000" }, { name: "ফায়ার সার্ভিস, নোয়াখালী", number: "0321-62222" }, { name: "আব্দুল মালেক উকিল মেডিকেল কলেজ", number: "+88032161217" }], "Pabna": [{ name: "পুলিশ সুপার, পাবনা", number: "01320140300" }, { name: "ফায়ার সার্ভিস, পাবনা", number: "0731-66000" }, { name: "সদর হাসপাতাল, পাবনা", number: "+88073165354" }], "Panchagarh": [{ name: "পুলিশ সুপার, পঞ্চগড়", number: "01320140500" }, { name: "ফায়ার সার্ভিস, পঞ্চগড়", number: "0568-61333" }, { name: "সদর হাসপাতাল, পঞ্চগড়", number: "+88056861250" }], "Patuakhali": [{ name: "পুলিশ সুপার, পটুয়াখালী", number: "01320145000" }, { name: "ফায়ার সার্ভিস, পটুয়াখালী", number: "0441-62333" }, { name: "সদর হাসপাতাল, পটুয়াখালী", number: "+88044162483" }], "Pirojpur": [{ name: "পুলিশ সুপার, পিরোজপুর", number: "01320145200" }, { name: "ফায়ার সার্ভিস, পিরোজপুর", number: "0461-62444" }, { name: "সদর হাসপাতাল, পিরোজপুর", number: "+88046162350" }], "Rajbari": [{ name: "পুলিশ সুপার, রাজবাড়ী", number: "01320140700" }, { name: "ফায়ার সার্ভিস, রাজবাড়ী", number: "0641-65333" }, { name: "সদর হাসপাতাল, রাজবাড়ী", number: "+88064165561" }], "Rajshahi": [{ name: "আরএমপি কন্ট্রোল রুম", number: "01320-041000" }, { name: "ফায়ার সার্ভিস, রাজশাহী", number: "0721-772222" }, { name: "রাজশাহী মেডিকেল কলেজ হাসপাতাল", number: "+880721772428" }], "Rangamati": [{ name: "পুলিশ সুপার, রাঙ্গামাটি", number: "01320141200" }, { name: "ফায়ার সার্ভিস, রাঙ্গামাটি", number: "0351-63333" }, { name: "সদর হাসপাতাল, রাঙ্গামাটি", number: "+88035162211" }], "Rangpur": [{ name: "পুলিশ সুপার, রংপুর", number: "01320141400" }, { name: "ফায়ার সার্ভিস, রংপুর", number: "0521-62222" }, { name: "রংপুর মেডিকেল কলেজ হাসপাতাল", number: "+88052162121" }], "Satkhira": [{ name: "পুলিশ সুপার, সাতক্ষীরা", number: "01320145400" }, { name: "ফায়ার সার্ভিস, সাতক্ষীরা", number: "0471-63333" }, { name: "সদর হাসপাতাল, সাতক্ষীরা", number: "+88047163283" }], "Shariatpur": [{ name: "পুলিশ সুপার, শরীয়তপুর", number: "01320141700" }, { name: "ফায়ার সার্ভিস, শরীয়তপুর", number: "0601-61444" }, { name: "সদর হাসপাতাল, শরীয়তপুর", number: "+88060161453" }], "Sherpur": [{ name: "পুলিশ সুপার, শেরপুর", number: "01320141900" }, { name: "ফায়ার সার্ভিস, শেরপুর", number: "0931-61333" }, { name: "সদর হাসপাতাল, শেরপুর", number: "+88093161281" }], "Sirajganj": [{ name: "পুলিশ সুপার, সিরাজগঞ্জ", number: "01320142100" }, { name: "ফায়ার সার্ভিস, সিরাজগঞ্জ", number: "0751-62333" }, { name: "সদর হাসপাতাল, সিরাজগঞ্জ", number: "+88075162499" }], "Sunamganj": [{ name: "পুলিশ সুপার, সুনামগঞ্জ", number: "01320142300" }, { name: "ফায়ার সার্ভিস, সুনামগঞ্জ", number: "0871-61444" }, { name: "সদর হাসপাতাল, সুনামগঞ্জ", number: "+88087161300" }], "Sylhet": [{ name: "এসএমপি কন্ট্রোল রুম", number: "01320-099999" }, { name: "ফায়ার সার্ভিস, সিলেট", number: "0821-714444" }, { name: "এম.এ.জি. ওসমানী মেডিকেল কলেজ", number: "+880821716970" }], "Tangail": [{ name: "পুলিশ সুপার, টাঙ্গাইল", number: "01320142700" }, { name: "ফায়ার সার্ভিস, টাঙ্গাইল", number: "0921-62222" }, { name: "সদর হাসপাতাল, টাঙ্গাইল", number: "+88092163456" }], "Thakurgaon": [{ name: "পুলিশ সুপার, ঠাকুরগাঁও", number: "01320142900" }, { name: "ফায়ার সার্ভিস, ঠাকুরগাঁও", number: "0561-52444" }, { name: "সদর হাসপাতাল, ঠাকুরগাঁও", number: "+88056152026" }]
    };


    // ডিলিট করার আগে সতর্কতা দেখানোর জন্য ফাংশন
    function showDeleteConfirmation(message, onConfirm) {
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: flex; align-items: center; justify-content: center;';
        
        const modal = document.createElement('div');
        modal.style.cssText = 'background: white; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-width: 350px;';
        
        if (document.documentElement.classList.contains('dark')) {
            modal.style.background = '#2d3748';
            modal.style.color = '#e2e8f0';
        }

        modal.innerHTML = `
            <p style="margin-bottom: 20px; font-size: 1.1rem;">${message}</p>
            <div style="display: flex; justify-content: space-around; gap: 10px;">
                <button id="confirmBtn" style="padding: 10px 20px; border: none; border-radius: 8px; background: #ef4444; color: white; cursor: pointer; flex: 1;">হ্যাঁ, মুছুন</button>
                <button id="cancelBtn" style="padding: 10px 20px; border: none; border-radius: 8px; background: #6c757d; color: white; cursor: pointer; flex: 1;">বাতিল করুন</button>
            </div>
        `;
        
        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        const closeDialog = () => document.body.removeChild(overlay);

        modal.querySelector('#confirmBtn').onclick = () => { onConfirm(); closeDialog(); };
        modal.querySelector('#cancelBtn').onclick = closeDialog;
    }

    // নতুন কার্ড মুছে ফেলার ফাংশন
    const deleteEmergencyCard = async (keyToDelete) => {
        const customNumbers = await idbGet('customEmergencyNumbers') || {};
        if (customNumbers[keyToDelete]) {
            delete customNumbers[keyToDelete];
            await idbSet('customEmergencyNumbers', customNumbers);
            showCustomAlert('কার্ড মুছে ফেলা হয়েছে!');
            displayNumbers(locationSelect.value); // তালিকা পুনরায় রেন্ডার করুন
        }
    };

    const displayNumbers = async (location) => {
        if (!numbersDisplay) return;
        numbersDisplay.innerHTML = '';
        
        const customNumbers = await idbGet('customEmergencyNumbers') || {};
        const defaultNumbers = emergencyNumbersData[location] || [];

        const allNumbers = [];

        // ডিফল্ট নম্বর যোগ করুন
        defaultNumbers.forEach((item, index) => {
            const itemKey = `${location}-${index}`;
            const savedCustomData = customNumbers[itemKey];
            const number = savedCustomData ? savedCustomData.number : item.number;
            const name = savedCustomData ? savedCustomData.name : item.name;
            allNumbers.push({ ...item, name, number, key: itemKey, isCustom: false });
        });

        // কাস্টম নম্বর যোগ করুন
        for (const key in customNumbers) {
            if (key.startsWith(`${location}-custom-`)) {
                allNumbers.push({ ...customNumbers[key], key: key, isCustom: true });
            }
        }

        if (allNumbers.length === 0) {
            numbersDisplay.innerHTML = `<p class="text-gray-500 dark:text-gray-400 col-span-full text-center">এই জেলার জন্য কোনো নম্বর যোগ করা হয়নি।</p>`;
            return;
        }

        allNumbers.forEach(item => {
            const card = document.createElement('div');
            card.className = 'emergency-card';

            const deleteButtonHTML = item.isCustom ? `
                <button class="action-btn delete" title="কার্ড মুছে ফেলুন">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
                </button>
            ` : '';

            card.innerHTML = `
                <div>
                    <h4 class="card-title" data-key="${item.key}">${item.name}</h4>
                    <p class="card-number" data-key="${item.key}">${item.number}</p>
                </div>
                <div class="actions">
                     <button class="action-btn edit" title="এডিট করুন"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/></svg></button>
                    <button class="action-btn copy" title="নম্বর কপি করুন"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z"/></svg></button>
                    ${deleteButtonHTML}
                </div>
                <a href="tel:${item.number}" class="call-button"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.6 17.6 0 0 0 4.168 6.608 17.6 17.6 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.68.68 0 0 0-.58-.122l-2.19.547a1.75 1.75 0 0 1-1.657-.459L5.482 8.062a1.75 1.75 0 0 1-.46-1.657l.548-2.19a.68.68 0 0 0-.122-.58zM1.884.511a1.745 1.745 0 0 1 2.612.163L6.29 2.98c.329.423.445.974.315 1.494l-.547 2.19a.68.68 0 0 0 .178.643l2.457 2.457a.68.68 0 0 0 .644.178l2.189-.547a1.75 1.75 0 0 1 1.494.315l2.306 1.794c.829.645.905 1.87.163 2.611l-1.034 1.034c-.74.74-1.846 1.065-2.877.702a18.6 18.6 0 0 1-7.01-4.42 18.6 18.6 0 0 1-4.42-7.009c-.363-1.03-.038-2.137.703-2.877z"/></svg>কল করুন</a>
            `;
            numbersDisplay.appendChild(card);
            
            const titleEl = card.querySelector('.card-title');
            const numberEl = card.querySelector('.card-number');
            const editBtn = card.querySelector('.action-btn.edit');
            const copyBtn = card.querySelector('.action-btn.copy');
            const deleteBtn = card.querySelector('.action-btn.delete');
            const callBtn = card.querySelector('.call-button');

            editBtn.addEventListener('click', () => { 
                titleEl.contentEditable = true;
                numberEl.contentEditable = true;
                numberEl.focus();
            });

            copyBtn.addEventListener('click', () => { 
                const textToCopy = `${titleEl.textContent.trim()}\n${numberEl.textContent.trim()}`;
                navigator.clipboard.writeText(textToCopy).then(() => showCustomAlert('নাম ও নম্বর কপি করা হয়েছে!'));
            });
            
            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => {
                    showDeleteConfirmation(`আপনি কি '${item.name}' কার্ডটি মুছে ফেলতে চান?`, () => {
                        deleteEmergencyCard(item.key);
                    });
                });
            }
            
            const saveChanges = async () => {
                titleEl.contentEditable = false;
                numberEl.contentEditable = false;

                const newName = titleEl.textContent.trim();
                const newNumber = numberEl.textContent.trim();
                const key = numberEl.dataset.key;

                callBtn.href = `tel:${newNumber}`;

                const allCustomNumbers = await idbGet('customEmergencyNumbers') || {};
                const originalDefaultItem = defaultNumbers.find(d => `${location}-${defaultNumbers.indexOf(d)}` === key);

                // যদি কোনো কিছু পরিবর্তন হয়, তবেই সেভ করুন
                if (newName !== item.name || newNumber !== item.number) {
                    allCustomNumbers[key] = { name: newName, number: newNumber };
                    await idbSet('customEmergencyNumbers', allCustomNumbers);
                    showCustomAlert('পরিবর্তন সেভ করা হয়েছে!');
                }
            };
            
            titleEl.addEventListener('blur', saveChanges);
            numberEl.addEventListener('blur', saveChanges);
            
            const handleKeydown = e => { if (e.key === 'Enter') { e.preventDefault(); e.target.blur(); }};
            titleEl.addEventListener('keydown', handleKeydown);
            numberEl.addEventListener('keydown', handleKeydown);
        });
    };

    const addNewEmergencyCard = async () => {
        const name = prompt("সেবার নাম লিখুন:", "");
        if (name === null || name.trim() === "") return;
        const number = prompt("নম্বরটি লিখুন:", "");
        if (number === null || number.trim() === "") return;

        const location = locationSelect.value;
        const key = `${location}-custom-${Date.now()}`;
        
        const customNumbers = await idbGet('customEmergencyNumbers') || {};
        customNumbers[key] = { name: name.trim(), number: number.trim() };
        await idbSet('customEmergencyNumbers', customNumbers);

        showCustomAlert('নতুন কার্ড যুক্ত করা হয়েছে!');
        displayNumbers(location);
    };

    const populateDropdown = () => {
        if (!locationSelect) return;
        const currentSelection = locationSelect.value;
        locationSelect.innerHTML = '';

        const nationalOption = document.createElement('option');
        nationalOption.value = "national";
        nationalOption.textContent = districtNameMap["national"];
        locationSelect.appendChild(nationalOption);

        Object.keys(emergencyNumbersData)
            .filter(key => key !== "national")
            .sort((a, b) => districtNameMap[a].localeCompare(districtNameMap[b], 'bn'))
            .forEach(districtKey => {
                const option = document.createElement('option');
                option.value = districtKey;
                option.textContent = districtNameMap[districtKey];
                locationSelect.appendChild(option);
            });
        
        if (currentSelection) {
            locationSelect.value = currentSelection;
        }
    };
    
    if (locationSelect) {
        locationSelect.addEventListener('change', (e) => {
            const selectedLocation = e.target.value;
            displayNumbers(selectedLocation);
            localStorage.setItem('selectedEmergencyLocation', selectedLocation);
        });
    }
    if (addCardBtn) addCardBtn.addEventListener('click', addNewEmergencyCard);
    
    // ইনিশিয়ালাইজেশন
    populateDropdown();
    const savedLocation = localStorage.getItem('selectedEmergencyLocation');
    
    if (locationSelect) {
        if (savedLocation && (emergencyNumbersData[savedLocation] || Object.keys(idbGet('customEmergencyNumbers') || {}).some(k => k.startsWith(savedLocation)))) {
            locationSelect.value = savedLocation;
        } else {
            locationSelect.value = 'Gaibandha'; // ডিফল্ট লোকেশন
            localStorage.setItem('selectedEmergencyLocation', 'Gaibandha');
        }
        displayNumbers(locationSelect.value);
    }
}

// ====================================================================
// END: EMERGENCY NUMBERS SCRIPT
// ====================================================================

// ====================================================================
// START: ZAKAT CALCULATOR SCRIPT
// ====================================================================
function initializeZakatCalculator() {
    // Input elements
    const silverPriceInput = document.getElementById('silverPrice');
    const goldPriceInput = document.getElementById('goldPrice');
    const goldAmountInput = document.getElementById('goldAmount');
    const silverAmountInput = document.getElementById('silverAmount');
    const cashAmountInput = document.getElementById('cashAmount');
    const businessAssetsInput = document.getElementById('businessAssets');
    const otherAssetsInput = document.getElementById('otherAssets');
    const debtAmountInput = document.getElementById('debtAmount');

    // Button and display elements
    const calculateBtn = document.getElementById('calculateZakatBtn');
    const nisabAmountSpan = document.getElementById('nisabAmount');
    const resultArea = document.getElementById('zakatResultArea');

    // Helper function to get number value from input
    const getValue = (el) => parseFloat(el.value) || 0;

    // Function to calculate and update Nisab
    const updateNisab = () => {
        const silverPrice = getValue(silverPriceInput);
        const nisabValue = silverPrice * 52.5;
        nisabAmountSpan.textContent = `৳ ${nisabValue.toLocaleString('bn-BD', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        return nisabValue;
    };

    // Function to calculate Zakat
    const calculateZakat = () => {
        const nisab = updateNisab();

        // Get all asset values
        const goldPrice = getValue(goldPriceInput);
        const goldAmount = getValue(goldAmountInput);
        const silverPrice = getValue(silverPriceInput);
        const silverAmount = getValue(silverAmountInput);
        const cashAmount = getValue(cashAmountInput);
        const businessAssets = getValue(businessAssetsInput);
        const otherAssets = getValue(otherAssetsInput);
        
        // Get liability value
        const debtAmount = getValue(debtAmountInput);

        // Calculate total assets
        const totalGoldValue = goldAmount * goldPrice;
        const totalSilverValue = silverAmount * silverPrice;
        const totalAssets = totalGoldValue + totalSilverValue + cashAmount + businessAssets + otherAssets;

        // Calculate net zakatable assets
        const netAssets = totalAssets - debtAmount;

        // Display logic
        resultArea.style.display = 'block';
        resultArea.classList.remove('not-payable');
        
        if (netAssets < nisab) {
            resultArea.classList.add('not-payable');
            resultArea.innerHTML = `
                <h4>আপনার যাকাত প্রযোজ্য নয়</h4>
                <p>আপনার মোট যাকাতযোগ্য সম্পদ (৳ ${netAssets.toLocaleString('bn-BD')}) নিসাব পরিমাণ (৳ ${nisab.toLocaleString('bn-BD')}) অপেক্ষা কম।</p>
            `;
        } else {
            const zakatAmount = netAssets * 0.025;
            resultArea.innerHTML = `
                <h4>আপনার যাকাতের হিসাব</h4>
                <p>মোট সম্পদ: ৳ ${totalAssets.toLocaleString('bn-BD')}</p>
                <p>বাদযোগ্য দেনা: ৳ ${debtAmount.toLocaleString('bn-BD')}</p>
                <p>যাকাতযোগ্য নিট সম্পদ: ৳ ${netAssets.toLocaleString('bn-BD')}</p>
                <p class="final-zakat">আপনার প্রদেয় যাকাতের পরিমাণ: ৳ ${zakatAmount.toLocaleString('bn-BD', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
            `;
        }
    };

    // Event Listeners
    if (silverPriceInput) {
        silverPriceInput.addEventListener('input', updateNisab);
    }
    
    if (calculateBtn) {
        calculateBtn.addEventListener('click', calculateZakat);
    }

    // Initial Nisab calculation on load
    updateNisab();
}

// Initialize when the tab is shown or page loads if it's active
document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('zakatCalculatorContent')?.classList.contains('active')) {
        initializeZakatCalculator();
    }
    document.getElementById('zakatCalcTab')?.addEventListener('click', initializeZakatCalculator);
});
// ====================================================================
// END: ZAKAT CALCULATOR SCRIPT
// ====================================================================

// ====================================================================
// START: Animated Bangla Toolbox Heading (Updated with Settings Toggle)
// ====================================================================
document.addEventListener('DOMContentLoaded', () => {
const mainHeading = document.getElementById('main-heading');

if (mainHeading) {
    // প্রতি সেকেন্ডে সময় পরীক্ষা করার জন্য
    setInterval(() => {
        const seconds = new Date().getSeconds();
        
        // সেটিংস থেকে চেক করুন এনিমেশন চালু আছে কিনা (ডিফল্ট true)
        const isTitleAnimationEnabled = localStorage.getItem('titleAnimationEnabled') !== 'false';

        // ব্যানারের মিনিটের শুরু থেকে 30 সেকেন্ড হলে এবং সেটিং চালু থাকলে, তখন অ্যানিমেশন ট্রিগার করুন
        if (isTitleAnimationEnabled && (seconds === 30) && !mainHeading.classList.contains('glitch-effect')) {
            mainHeading.classList.add('glitch-effect');
        }
    }, 1000);

    // অ্যানিমেশন শেষ হলে ক্লাসটি সরিয়ে দিন যাতে এটি আবার ট্রিগার হতে পারে
    mainHeading.addEventListener('animationend', (event) => {
        if (event.animationName === 'glitch-duration') {
             mainHeading.classList.remove('glitch-effect');
        }
    });
}

});
// ====================================================================
// END: Animated Bangla Toolbox Heading
// ====================================================================

// ====================================================================
// START: Animated News Ticker Script (Updated: 1h/8h Tiles, 5min Refresh & Manual Refresh)
// ====================================================================
document.addEventListener('DOMContentLoaded', () => {
    const tickerContainer = document.getElementById('news-ticker-container');
    const tickerContent = document.getElementById('news-ticker-content'); 
    const tickerTextElement = document.getElementById('news-ticker-text');
    const prevBtn = document.getElementById('prev-news');
    const nextBtn = document.getElementById('next-news');
    
    // Summary & Headlines Elements
    const summaryBtn = document.getElementById('summary-news-btn');
    const refreshSummaryBtn = document.getElementById('refresh-summary-btn'); 
    const refreshHeadlinesBtn = document.getElementById('refresh-headlines-btn'); 
    const viewHeadlinesBtn = document.getElementById('view-headlines-btn'); 
    const summaryView = document.getElementById('news-summary-view');
    const summaryStartView = document.getElementById('news-summary-start-view');
    const btnLoadSummary = document.getElementById('btn-load-summary');
    const headlinesView = document.getElementById('news-headlines-view'); 
    const summaryList = document.getElementById('news-summary-list');
    const headlinesList = document.getElementById('news-headlines-list'); 
    const summaryLoading = document.getElementById('news-summary-loading');
    const iconSummary = document.getElementById('icon-summary');
    const iconClose = document.getElementById('icon-close');
    const tickerRightControls = document.getElementById('ticker-right-controls');

    if (!tickerContainer || !tickerContent || !tickerTextElement) {
        console.error("News ticker elements not found.");
        return;
    }

    // --- Settings Check ---
    const isNewsTickerEnabled = localStorage.getItem('newsTickerEnabled') !== 'false';
    if (!isNewsTickerEnabled) {
        tickerContainer.style.display = 'none';
    }

    // Animation Type Check
    const useTypingAnimation = localStorage.getItem('newsAnimationType') === 'typing';

    // --- Apply Styles Based on Animation ---
    if (isNewsTickerEnabled) {
        if (useTypingAnimation) {
            tickerContainer.style.height = 'auto';
            tickerContainer.style.overflow = 'visible';
            tickerContainer.style.lineHeight = ''; 
            tickerContainer.style.display = 'flex'; 
            tickerContainer.style.alignItems = 'center';
            tickerContainer.style.justifyContent = 'center';
            tickerContent.style.overflow = 'visible';
            tickerContent.style.height = 'auto';
        } else {
            tickerContainer.style.height = 'auto';
            tickerContainer.style.overflow = 'hidden'; 
            tickerContainer.style.lineHeight = '1.5'; 
            tickerContainer.style.display = 'block'; 
            tickerContent.style.overflow = 'hidden'; 
            tickerContent.style.height = 'auto'; 
        }
    }

    const customMessages = [
        { title: "বাংলা টুলবক্স-এ আপনাকে স্বাগতম!", link: "#", source: "Bangla Toolbox", time: null },
        { title: "আপনার টুলস ব্যবহারের অভিজ্ঞতা কেমন?", link: "#", source: "Bangla Toolbox", time: null },
        { title: "যেকোনো মতামতের জন্য আমাদের সাথে যোগাযোগ করুন।", link: "https://bio.link/mdsifatbiolink", source: "Developer", time: null }
    ];

    let allMessages = [];    // ৮ ঘন্টার সব নিউজ (লিস্টের জন্য)
    let tickerMessages = []; // ১ ঘন্টার নিউজ (টিকারের জন্য)
    let messageIndex = 0;
    let autoPlayInterval = null;
    let transitionTimeout = null; 
    let isTransitioning = false; 
    const ANIMATION_DURATION = 500; 
    const AUTO_PLAY_INTERVAL = useTypingAnimation ? 10000 : 5000;
    
    // Cache Constants
    const NEWS_CACHE_KEY = 'bangla_toolbox_news_cache';
    const NEWS_LAST_FETCH_KEY = 'bangla_toolbox_news_last_fetch';
    const REFRESH_INTERVAL = 5 * 60 * 1000; // 5 Minutes Refresh & Cache Time
    
    // View States
    let activeView = 'none'; // 'none', 'summary', 'headlines'
    let summaryGeneratedTime = 0;
    const SUMMARY_CACHE_DURATION = 30 * 60 * 1000; // 30 Minutes Cache for Summary

// --- Fetch News Function (Direct XML Parsing & 8 Hours Filter with Caching) ---
    async function fetchNewsHeadlines() {
        const now = new Date().getTime();
        const lastFetch = localStorage.getItem(NEWS_LAST_FETCH_KEY);
        const cachedData = localStorage.getItem(NEWS_CACHE_KEY);

        // ১. ক্যাশ চেক করা (৫ মিনিটের মধ্যে হলে সরাসরি ক্যাশ থেকে রিটার্ন করবে)
        if (cachedData && lastFetch && (now - parseInt(lastFetch) < REFRESH_INTERVAL)) {
            try {
                return JSON.parse(cachedData);
            } catch (e) {
                console.error("Cache parse error", e);
            }
        }

        // সরাসরি XML ফিড লিংক (CORS প্রক্সির মাধ্যমে ব্যবহার করা হবে)
        const feeds = [
            { name: 'বাংলাদেশ প্রতিদিন', url: 'https://www.bd-pratidin.com/rss.xml' },
            { name: 'কালের কণ্ঠ', url: 'https://www.kalerkantho.com/rss.xml' },
            { name: 'সময়ের কণ্ঠস্বর', url: 'https://somoyerkonthosor.com/feed' },
            { name: 'আজকের পত্রিকা', url: 'https://www.ajkerpatrika.com/feed' },
            { name: 'প্রথম আলো', url: 'https://www.prothomalo.com/feed/' },
            { name: 'বিবিসি বাংলা', url: 'https://feeds.bbci.co.uk/bengali/rss.xml' },
            { name: 'চ্যানেল আই', url: 'https://www.channelionline.com/feed' },
            { name: 'বাংলা ট্রিবিউন', url: 'https://www.banglatribune.com/feed/' }
        ];

        // সময়সীমা নির্ধারণ: বর্তমান সময় থেকে ৮ ঘণ্টা আগে (লিস্টের জন্য)
        const timeLimit = 8 * 60 * 60 * 1000; // ৮ ঘণ্টা মিলিসেকেন্ডে
        const eightHoursAgo = new Date(now - timeLimit);

        try {
            // সব ফিড থেকে প্যারালাল ফেচিং
            const promises = feeds.map(async (feed) => {
                try {
                    // CORS বাইপাস করার জন্য আপনার Cloudflare Worker ব্যবহার
                    const proxyUrl = `https://news.banglatoolbox.workers.dev/?url=${encodeURIComponent(feed.url)}`;
                    
                    const response = await fetch(proxyUrl);
                    if (!response.ok) return null;
                    
                    const xmlText = await response.text();
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                    
                    // RSS (item) এবং Atom (entry) উভয় সাপোর্ট করার লজিক
                    let items = Array.from(xmlDoc.querySelectorAll("item"));
                    let isAtom = false;
                    
                    // যদি item না পাওয়া যায়, তবে entry (Atom Feed) চেক করুন - প্রথম আলোর জন্য ফিক্স
                    if (items.length === 0) {
                        items = Array.from(xmlDoc.querySelectorAll("entry"));
                        isAtom = true;
                    }
                    
                    let feedNews = [];

                    items.forEach(item => {
                        const title = item.querySelector("title")?.textContent;
                        
                        // লিংক বের করা (RSS vs Atom)
                        let link = item.querySelector("link")?.textContent;
                        if (isAtom) {
                            const linkNode = item.querySelector("link");
                            if (linkNode && linkNode.getAttribute("href")) {
                                link = linkNode.getAttribute("href");
                            }
                        }

                        // তারিখ বের করা (RSS: pubDate, Atom: published/updated)
                        const pubDateStr = item.querySelector("pubDate")?.textContent || 
                                           item.querySelector("published")?.textContent || 
                                           item.querySelector("updated")?.textContent;

                        if (title && link && pubDateStr) {
                            let pubDate = new Date(pubDateStr);

                            // *** ফিক্স: বাংলাদেশ প্রতিদিন ও কালের কণ্ঠের ৬ ঘণ্টা সময়ের সমস্যা সমাধান ***
                            // এই পত্রিকাগুলোর আরএসএস ফিড মাঝে মাঝে ভুল টাইমজোন ফরম্যাট দেয়, তাই ম্যানুয়ালি ৬ ঘণ্টা কমানো হলো
                            if (feed.name === 'বাংলাদেশ প্রতিদিন' || feed.name === 'কালের কণ্ঠ') {
                                pubDate = new Date(pubDate.getTime() - (6 * 60 * 60 * 1000));
                            }
                            
                            // ফিল্টারিং লজিক: ৮ ঘণ্টার মধ্যে প্রকাশিত হতে হবে
                            if (pubDate >= eightHoursAgo && pubDate <= new Date(now + 60000)) { 
                                // আপডেট: তারিখ ও সময় একসাথে দেখানোর জন্য পরিবর্তন করা হয়েছে
                                const timeStr = pubDate.toLocaleString('bn-BD', { 
                                    day: 'numeric',
                                    month: 'short',
                                    hour: '2-digit', 
                                    minute: '2-digit',
                                    timeZone: 'Asia/Dhaka' 
                                });
                                
                                feedNews.push({ 
                                    title: title.trim(), 
                                    link: link.trim(), 
                                    source: feed.name,
                                    time: `${timeStr}`, 
                                    timestamp: pubDate.getTime() // টাইমস্ট্যাম্প রাখা হলো ফিল্টারিংয়ের জন্য
                                }); 
                            } 
                        } 
                    }); 
                    return feedNews;
                } catch (err) {
                    console.warn(`Error fetching ${feed.name}:`, err);
                    return null; 
                }
            });

            const results = await Promise.all(promises);
            // সব রেজাল্ট একত্রিত করা
            let allHeadlines = results.flat().filter(item => item !== null);
            
            // --- নতুন লজিক: ক্যাশ হ্যান্ডলিং ---
            
            // যদি নতুন কোনো সংবাদ পাওয়া যায় (> ০)
            if (allHeadlines.length > 0) {
                 // একদম নতুন খবর সবার আগে দেখানোর জন্য সর্টিং
                allHeadlines.sort((a, b) => b.timestamp - a.timestamp);
                
                // ২. নতুন ডেটা দিয়ে ক্যাশ আপডেট করা (পুরাতন ক্যাশ মুছে যাবে)
                localStorage.setItem(NEWS_CACHE_KEY, JSON.stringify(allHeadlines));
                localStorage.setItem(NEWS_LAST_FETCH_KEY, now.toString());
                
                return allHeadlines;
            } 
            else {
                // যদি ফেচ করে কোনো সংবাদ না পাওয়া যায় (নেটওয়ার্ক থাকলেও নিউজ নেই, অথবা সব ফেইল)
                // ৩. পুরাতন ক্যাশ আছে কিনা চেক করা
                if (cachedData) {
                    console.log("No new news fetched, serving from cache.");
                    return JSON.parse(cachedData); // ক্যাশ থেকে দেখাবে
                } else {
                    // ৪. ক্যাশও নেই, নতুন নিউজও নেই -> কাস্টম মেসেজ
                    return customMessages.map(m => ({...m, timestamp: 0}));
                }
            }

        } catch (error) { 
            console.error('Error fetching news:', error);
            
            // কোনো এরর হলে (যেমন নেটওয়ার্ক ফেইল)
            // ৩. পুরাতন ক্যাশ আছে কিনা চেক করা
            if (cachedData) {
                console.log("Fetch error, serving from cache.");
                return JSON.parse(cachedData); // ক্যাশ থেকে দেখাবে
            }
            
            // ৪. ক্যাশ না থাকলে কাস্টম মেসেজ
            return customMessages.map(m => ({...m, timestamp: 0})); 
        }
    }

    // --- Display Headline Logic (Modified for Ticker Messages) ---
    function displayCurrentHeadline(direction = 'up') {
        clearTimeout(transitionTimeout); 
        isTransitioning = true; 

        // টিকারের জন্য যদি মেসেজ না থাকে (ফলব্যাক)
        if (tickerMessages.length === 0) {
            tickerTextElement.textContent = "Bangla Toolbox";
            return;
        }

        if (messageIndex < 0) messageIndex = tickerMessages.length - 1;
        if (messageIndex >= tickerMessages.length) messageIndex = 0;

        const currentMessage = tickerMessages[messageIndex];
        const timeBadge = currentMessage.time ? `<span class="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-xs px-1 rounded ml-1">${currentMessage.time}</span>` : '';
        const displayText = ` ● ${currentMessage.title} - <span class="news-source text-indigo-600 dark:text-indigo-400 italic">${currentMessage.source}</span> ${timeBadge}`;

        if (useTypingAnimation) {
            tickerTextElement.className = `news-ticker-text typing-animation text-indigo-800 dark:!text-white font-semibold`;
            tickerTextElement.href = currentMessage.link;
            tickerTextElement.innerHTML = displayText;
            tickerTextElement.style.position = 'static';
            tickerTextElement.style.lineHeight = 'normal'; 
            tickerTextElement.style.animation = 'none';
            tickerTextElement.offsetHeight; // trigger reflow

            const textLength = currentMessage.title.length + currentMessage.source.length + 5;
            const duration = Math.max(3.5, textLength * 0.1);

            tickerTextElement.style.whiteSpace = 'nowrap';
            tickerTextElement.style.width = '0';
            tickerTextElement.style.animationDuration = `${duration}s`;
            tickerTextElement.style.animationTimingFunction = `steps(${textLength}, end)`;
            tickerTextElement.style.animationName = 'typing';
            tickerTextElement.style.animationFillMode = 'forwards';

            const handleTypingEnd = () => {
                tickerTextElement.style.whiteSpace = 'normal';
                tickerTextElement.style.width = 'auto';
                isTransitioning = false;
            };
            tickerTextElement.removeEventListener('animationend', handleTypingEnd);
            tickerTextElement.addEventListener('animationend', handleTypingEnd, { once: true });

        } else {
            tickerTextElement.className = `news-ticker-text text-indigo-800 dark:!text-white font-semibold`;
            tickerTextElement.style.animation = 'none';
            tickerTextElement.style.position = 'absolute';
            tickerTextElement.style.width = '100%';
            tickerTextElement.style.lineHeight = '1.5';
            tickerTextElement.style.whiteSpace = 'normal';
            
            tickerTextElement.href = currentMessage.link;
            tickerTextElement.innerHTML = displayText;
            
            tickerTextElement.style.top = '-9999px';
            tickerTextElement.style.opacity = '0';
            
            const newHeight = tickerTextElement.offsetHeight || 24; 
            tickerContent.style.height = `${newHeight}px`;

            const startTop = (direction === 'up') ? `${newHeight + 20}px` : `-${newHeight + 20}px`;
            tickerTextElement.style.top = startTop;
            tickerTextElement.style.transition = 'none';
            
            setTimeout(() => {
                tickerTextElement.style.transition = `top ${ANIMATION_DURATION / 1000}s ease-in-out, opacity ${ANIMATION_DURATION / 1000}s ease-in-out`;
                tickerTextElement.style.top = '0px'; 
                tickerTextElement.style.opacity = '1';
                isTransitioning = false;
            }, 50);
        }
    }

    function triggerTransition(nextIndexFunction, exitDirection) {
        if (useTypingAnimation || isTransitioning) return;
        isTransitioning = true;
        
        const currentHeight = tickerTextElement.offsetHeight;
        const exitTop = (exitDirection === 'up') ? `-${currentHeight + 20}px` : `${currentHeight + 20}px`;
        
        tickerTextElement.style.transition = `top ${ANIMATION_DURATION / 1000}s ease-in-out, opacity ${ANIMATION_DURATION / 1000}s ease-in-out`;
        tickerTextElement.style.top = exitTop;
        tickerTextElement.style.opacity = '0';

        transitionTimeout = setTimeout(() => {
            nextIndexFunction();
            const entryDirection = (exitDirection === 'up') ? 'up' : 'down';
            displayCurrentHeadline(entryDirection); 
        }, ANIMATION_DURATION);
    }

    function showNextHeadline() {
        if (useTypingAnimation) {
            messageIndex++;
            displayCurrentHeadline();
        } else {
            triggerTransition(() => { messageIndex++; }, 'up');
        }
    }

    function showPrevHeadline() {
        if (useTypingAnimation) {
             messageIndex--;
             displayCurrentHeadline();
        } else {
             triggerTransition(() => { messageIndex--; }, 'down');
        }
    }

    function startAutoPlay() {
        stopAutoPlay();
        if (!isNewsTickerEnabled || activeView !== 'none') return;
        autoPlayInterval = setInterval(showNextHeadline, AUTO_PLAY_INTERVAL);
    }

    function stopAutoPlay() {
        clearInterval(autoPlayInterval);
        autoPlayInterval = null;
    }

    // --- View State Management (Updated to manage button visibility) ---
    function updateViewUI() {
        if (activeView !== 'none') {
            stopAutoPlay();
            tickerContainer.style.height = '400px'; 
            
            // Toggle Controls
            iconSummary.classList.add('hidden');
            iconClose.classList.remove('hidden');
            
            tickerRightControls.style.top = '20px'; 
            tickerRightControls.classList.remove('transform', '-translate-y-1/2');
            if(prevBtn) prevBtn.style.display = 'none';
            if(nextBtn) nextBtn.style.display = 'none';
        } else {
            tickerContainer.style.height = useTypingAnimation ? '' : 'auto'; 
            if(useTypingAnimation) tickerContainer.style.height = 'auto';
            
            // Toggle Controls
            iconSummary.classList.remove('hidden');
            iconClose.classList.add('hidden');
            
            tickerRightControls.style.top = '50%'; 
            tickerRightControls.classList.add('transform', '-translate-y-1/2');
            if(prevBtn) prevBtn.style.display = '';
            if(nextBtn) nextBtn.style.display = '';
            
            startAutoPlay();
        }

        // Manage Specific Views
        if (activeView === 'summary') {
            summaryView.classList.remove('hidden');
            headlinesView.classList.add('hidden');
            if (refreshSummaryBtn) refreshSummaryBtn.classList.remove('hidden');
            if (refreshHeadlinesBtn) refreshHeadlinesBtn.classList.add('hidden'); // Ensure hidden
            if (viewHeadlinesBtn) viewHeadlinesBtn.classList.remove('hidden'); 
            
            if (summaryStartView) summaryStartView.classList.remove('hidden');
            if (summaryList) summaryList.classList.add('hidden');
            if (summaryLoading) summaryLoading.classList.add('hidden');
            
        } else if (activeView === 'headlines') {
            headlinesView.classList.remove('hidden');
            summaryView.classList.add('hidden');
            if (refreshSummaryBtn) refreshSummaryBtn.classList.add('hidden');
            if (refreshHeadlinesBtn) refreshHeadlinesBtn.classList.remove('hidden'); // Show this
            if (viewHeadlinesBtn) viewHeadlinesBtn.classList.add('hidden'); 
            renderHeadlinesList();
        } else {
            // None
            summaryView.classList.add('hidden');
            headlinesView.classList.add('hidden');
            if (refreshSummaryBtn) refreshSummaryBtn.classList.add('hidden');
            if (refreshHeadlinesBtn) refreshHeadlinesBtn.classList.add('hidden');
            if (viewHeadlinesBtn) viewHeadlinesBtn.classList.add('hidden'); // HIDE THIS (User request)
        }
    }

    // --- Headlines View Logic (Updated: 1h & 8h Tiles) ---
    function renderHeadlinesList() {
        // ১ ঘন্টার টাইম ক্যালকুলেশন
        const oneHourAgo = new Date().getTime() - (60 * 60 * 1000);

        // দুই ভাগে ফিল্টার করা
        let recentNews = allMessages.filter(msg => msg.timestamp >= oneHourAgo);
        // কাস্টম মেসেজ (timestamp 0) এবং পুরনো নিউজ আলাদা করা
        const olderNews = allMessages.filter(msg => msg.timestamp < oneHourAgo && msg.timestamp > 0);

        // যদি ১ ঘণ্টার মধ্যে কোনো নিউজ না থাকে, তবে কাস্টম মেসেজগুলো সাম্প্রতিক হিসেবে দেখান
        // (যদি allMessages এ কাস্টম মেসেজ লোড হয়ে থাকে)
        if (recentNews.length === 0 && olderNews.length === 0 && allMessages.length > 0 && allMessages[0].timestamp === 0) {
            recentNews = allMessages; // Custom messages
        }

        let htmlContent = '';

        if (allMessages.length === 0) {
            headlinesList.innerHTML = '<p class="text-center text-gray-500">কোনো সংবাদ পাওয়া যায়নি।</p>';
            return;
        }

        // ১. সর্বশেষ ১ ঘণ্টা টাইল
        if (recentNews.length > 0) {
            const title = (recentNews[0].timestamp === 0) ? "বিজ্ঞপ্তি" : "সর্বশেষ ১ ঘণ্টা";
            const icon = (recentNews[0].timestamp === 0) ? "📢" : "🔥";
            
            htmlContent += `
                <div class="sticky top-0 z-10 bg-indigo-50 dark:bg-gray-700 py-2 px-3 mb-2 rounded-md font-bold text-indigo-800 dark:text-indigo-200 shadow-sm border border-indigo-100 dark:border-gray-600 text-sm flex items-center gap-2">
                    <span class="animate-pulse">${icon}</span> ${title}
                    <span class="ml-auto bg-indigo-200 dark:bg-gray-600 text-xs px-2 py-0.5 rounded-full">${recentNews.length}টি</span>
                </div>
            `;
            htmlContent += recentNews.map(m => generateNewsItemHTML(m)).join('');
        }

        // ২. সর্বশেষ ৮ ঘণ্টা টাইল (যদি থাকে)
        if (olderNews.length > 0) {
            const marginTop = recentNews.length > 0 ? 'mt-6' : ''; // গ্যাপ বাড়ানোর জন্য
            htmlContent += `
                <div class="sticky top-0 z-10 bg-gray-100 dark:bg-gray-700 py-2 px-3 mb-2 ${marginTop} rounded-md font-bold text-gray-700 dark:text-gray-300 shadow-sm border border-gray-200 dark:border-gray-600 text-sm flex items-center gap-2">
                    <span>🕒</span> সর্বশেষ ৮ ঘণ্টা
                     <span class="ml-auto bg-gray-200 dark:bg-gray-600 text-xs px-2 py-0.5 rounded-full">${olderNews.length}টি</span>
                </div>
            `;
            htmlContent += olderNews.map(m => generateNewsItemHTML(m)).join('');
        }

        headlinesList.innerHTML = htmlContent;
    }

    // নিউজ আইটেম HTML জেনারেটর হেল্পার
    function generateNewsItemHTML(m) {
        const timeDisplay = m.time ? `<span class="flex items-center gap-1 text-xs text-gray-400"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> ${m.time}</span>` : '';
        return `
            <div class="bg-white dark:bg-gray-800 p-3 rounded border border-gray-200 dark:border-gray-600 hover:bg-indigo-50 dark:hover:bg-gray-700 transition-colors mb-2 shadow-sm">
                <a href="${m.link}" target="_blank" class="text-base font-bold text-gray-800 dark:text-gray-200 hover:text-indigo-600 dark:hover:text-indigo-400 hover:underline block mb-1 leading-snug">${m.title}</a>
                <div class="flex justify-between items-center mt-2">
                    <span class="text-xs bg-indigo-100 dark:bg-indigo-900/50 text-indigo-800 dark:text-indigo-200 px-2 py-0.5 rounded font-semibold border border-indigo-100 dark:border-indigo-800">${m.source}</span>
                    ${timeDisplay}
                </div>
            </div>
        `;
    }

    // --- Buttons Event Listeners ---
    if (summaryBtn) {
        summaryBtn.addEventListener('click', () => {
            if (activeView !== 'none') {
                activeView = 'none'; 
            } else {
                activeView = 'summary'; 
            }
            updateViewUI();
        });
    }
    
    if (btnLoadSummary) {
        btnLoadSummary.addEventListener('click', () => {
            if (summaryStartView) summaryStartView.classList.add('hidden');
            if (Date.now() - summaryGeneratedTime > SUMMARY_CACHE_DURATION || summaryList.children.length === 0) {
                generateNewsSummary();
            } else {
                if (summaryList) summaryList.classList.remove('hidden');
            }
        });
    }

    if (viewHeadlinesBtn) {
        viewHeadlinesBtn.addEventListener('click', () => {
            if (activeView === 'headlines') {
                activeView = 'none'; 
            } else {
                activeView = 'headlines'; 
            }
            updateViewUI();
        });
    }

    if (refreshSummaryBtn) {
        refreshSummaryBtn.addEventListener('click', () => {
            if (summaryStartView) summaryStartView.classList.add('hidden'); 
            generateNewsSummary();
        });
    }

    // NEW: Refresh Headlines Button Listener
    if (refreshHeadlinesBtn) {
        refreshHeadlinesBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            refreshHeadlinesBtn.querySelector('svg').classList.add('animate-spin'); // স্পিন এনিমেশন
            showCustomAlert('সংবাদ রিফ্রেশ করা হচ্ছে...');
            
            // ক্যাশ ক্লিয়ার করে ফোর্স রিফ্রেশ
            localStorage.removeItem(NEWS_LAST_FETCH_KEY);
            initializeTicker().then(() => {
                setTimeout(() => {
                    refreshHeadlinesBtn.querySelector('svg').classList.remove('animate-spin'); // এনিমেশন বন্ধ
                    showCustomAlert('সংবাদ আপডেট হয়েছে!');
                }, 1000);
            });
        });
    }

    // --- Gemini Summary Generation (Uses allMessages) ---
    async function generateNewsSummary() {
        if (!allMessages || allMessages.length === 0) {
            summaryList.innerHTML = '<p class="text-center text-gray-500">কোনো সংবাদ পাওয়া যায়নি।</p>';
            if(summaryList) summaryList.classList.remove('hidden');
            return;
        }

        summaryLoading.classList.remove('hidden');
        summaryList.classList.add('hidden'); 
        summaryList.innerHTML = '';
        
        // টপ ১০ টি খবর সামারির জন্য পাঠানো হচ্ছে
        const headlines = allMessages.slice(0, 10).map(m => `- ${m.title} (${m.source})`).join('\n');
        
        const prompt = `
        Summarize the following news headlines in Bengali.
        For each headline, provide a very brief summary (1-2 sentences).
        Output strictly as a JSON array of objects.
        Each object format: { "title": "Headline", "summary": "Short summary in Bengali", "source": "Source Name" }
        Headlines:
        ${headlines}
        `;

        try {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) throw new Error("API Key missing");

            const model = localStorage.getItem('geminiModel') || "gemini-flash-latest";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            
            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (!text) throw new Error("No data");

            const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
            const summaries = JSON.parse(jsonStr);
            
            summaryList.innerHTML = summaries.map((item, index) => {
                const original = allMessages.find(m => m.title.includes(item.title) || item.title.includes(m.title)) || allMessages[index];
                const link = original ? original.link : '#';
                const timeDisplay = original && original.time ? `<span class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> ${original.time}</span>` : '';
                
                return `
                <div class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg border border-gray-200 dark:border-gray-600 transition hover:shadow-md">
                    <a href="${link}" target="_blank" class="text-lg font-bold text-indigo-700 dark:text-indigo-300 hover:underline block mb-2 leading-tight">${item.title}</a>
                    <div class="flex items-center gap-3 text-xs text-gray-500 dark:text-gray-400 mb-2">
                        <span class="bg-indigo-100 dark:bg-indigo-900/50 text-indigo-800 dark:text-indigo-200 px-2 py-0.5 rounded font-semibold">${item.source}</span>
                        ${timeDisplay}
                    </div>
                    <p class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed">${item.summary}</p>
                </div>
                `;
            }).join('');
            
            summaryGeneratedTime = Date.now();

        } catch (e) {
            console.error("Summary Gen Error", e);
            const apiKeyMissing = !localStorage.getItem('geminiApiKey');
            const errorMsg = apiKeyMissing ? 'API কী সেট করা নেই।' : 'নেটওয়ার্ক সমস্যা বা জেমিনি রেসপন্স করেনি।';
            
            summaryList.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded mb-4 text-center text-sm font-semibold">${errorMsg} নিচে সাধারণ তালিকা দেখানো হলো:</div>`;
             renderHeadlinesList(); 
             const fallbackHTML = headlinesList.innerHTML;
             summaryList.innerHTML += fallbackHTML;
        } finally {
            summaryLoading.classList.add('hidden');
            summaryList.classList.remove('hidden'); 
        }
    }


// --- Initialization & Logic Update ---

    // হেল্পার: আপডেট মেসেজ তৈরি করা
    const getUpdateMessage = () => {
        const timeStr = new Date().toLocaleTimeString('bn-BD', { 
            hour: '2-digit', 
            minute: '2-digit', 
            hour12: true,
            timeZone: 'Asia/Dhaka' 
        });
        return { 
            title: "সাম্প্রতিক সংবাদ", 
            link: "#", 
            source: "লাইভ", 
            time: timeStr,
            timestamp: Date.now() // সর্টিংয়ের জন্য, তবে আমরা ম্যানুয়ালি সবার উপরে রাখব
        };
    };

    async function initializeTicker() {
        if (isNewsTickerEnabled) {
             // ১. সব সংবাদ (৮ ঘণ্টার) আনুন
             allMessages = await fetchNewsHeadlines();
             
             // ২. টিকারের জন্য আলাদা করে গত ১ ঘণ্টার (৬০ মিনিট) নিউজ ফিল্টার করুন
             const oneHourAgo = new Date().getTime() - (60 * 60 * 1000);
             tickerMessages = allMessages.filter(msg => msg.timestamp >= oneHourAgo);

             // পরিবর্তন: ১ ঘণ্টার নিউজ না থাকলে ৮ ঘণ্টার নিউজ, তাও না থাকলে কাস্টম মেসেজ
             if (tickerMessages.length === 0) {
                 if (allMessages.length > 0) {
                     tickerMessages = [...allMessages]; // ৮ ঘণ্টার নিউজ ব্যবহার করুন (Reference break করতে spread operator)
                 } else {
                     tickerMessages = [...customMessages]; // তাও না থাকলে কাস্টম মেসেজ
                 }
             }

             // ৩. "সাম্প্রতিক খবর- আপডেট" মেসেজ সবার শুরুতে যুক্ত করুন (যদি আসল নিউজ থাকে)
             // customMessages থাকলে আপডেট মেসেজ দেখানোর প্রয়োজন নেই
             if (tickerMessages.length > 0 && tickerMessages[0].timestamp !== 0) {
                 tickerMessages.unshift(getUpdateMessage());
             }

        } else {
             allMessages = [...customMessages];
             tickerMessages = [...customMessages];
        }
        
        messageIndex = 0; // রিসেট: যাতে আপডেট মেসেজটি প্রথমে দেখায়
        displayCurrentHeadline(); 
        startAutoPlay();
        
        // লিস্ট ভিউ খোলা থাকলে সেটিও আপডেট করুন
        if (activeView === 'headlines') {
            renderHeadlinesList();
        }
    }

    nextBtn.addEventListener('click', () => { showNextHeadline(); startAutoPlay(); });
    prevBtn.addEventListener('click', () => { showPrevHeadline(); startAutoPlay(); });

    tickerContainer.addEventListener('mouseenter', stopAutoPlay);
    tickerContainer.addEventListener('mouseleave', () => {
        if(activeView === 'none') startAutoPlay();
    });

    initializeTicker();

    // Background news update every 5 mins (Refresh Interval)
    setInterval(async () => {
        // ক্যাশ ক্লিয়ার না করে কল করা হবে, কিন্তু fetchNewsHeadlines ক্যাশ এক্সপায়ার হলে নতুন ডেটা আনবে
        if (isNewsTickerEnabled) {
            // ৫ মিনিট পর পর অটোমেটিক নতুন ডেটা চেক করার জন্য ক্যাশ ভ্যালিডেশন fetchNewsHeadlines এর ভেতরেই আছে
            const news = await fetchNewsHeadlines();
            
            if (news && news.length > 0) {
                // Check if new content is different
                const currentTitles = allMessages.map(m => m.title).join();
                const newTitles = news.map(m => m.title).join();
                
                if (currentTitles !== newTitles) {
                    allMessages = news;
                    
                    // আপডেট হলে টিকারও রিফ্রেশ করুন (১ ঘণ্টার লজিক সহ)
                    const oneHourAgo = new Date().getTime() - (60 * 60 * 1000);
                    tickerMessages = allMessages.filter(msg => msg.timestamp >= oneHourAgo);
                    
                    // পরিবর্তন: আপডেট লজিকেও ফলব্যাক হ্যান্ডেল করা হয়েছে
                    if (tickerMessages.length === 0) {
                        if (allMessages.length > 0) {
                             tickerMessages = [...allMessages];
                        } else {
                             tickerMessages = [...customMessages];
                        }
                    }

                    // আপডেট মেসেজ যোগ করা (যদি আসল নিউজ থাকে)
                    if (tickerMessages.length > 0 && tickerMessages[0].timestamp !== 0) {
                        tickerMessages.unshift(getUpdateMessage());
                    }

                    if (!isTransitioning && activeView === 'none') {
                        messageIndex = 0; // আপডেট হলে শুরুতে নিয়ে যান (আপডেট মেসেজ দেখাবে)
                        displayCurrentHeadline();
                    }
                    
                    // লিস্ট ভিউ আপডেট
                    if (activeView === 'headlines') {
                        renderHeadlinesList();
                    }
                }
            }
        }
    }, REFRESH_INTERVAL); 
});
// ====================================================================
// END: Animated News Ticker Script
// ====================================================================

// ====================================================================
// START: HEALTH & LIFESTYLE TAB SCRIPT
// ====================================================================
function initializeHealthLifestyleTab() {
    // --- Pregnancy Due Date Calculator Elements ---
    const lmpDateInput = document.getElementById('lmpDate');
    const calculateDueDateBtn = document.getElementById('calculateDueDateBtn');
    const dueDateResultArea = document.getElementById('dueDateResultArea');

    // --- Water Intake Calculator Elements ---
    const userAgeInput = document.getElementById('userAge');
    const userWeightInput = document.getElementById('userWeight');
    const activityLevelSelect = document.getElementById('activityLevel');
    const calculateWaterIntakeBtn = document.getElementById('calculateWaterIntakeBtn');
    const waterIntakeResultArea = document.getElementById('waterIntakeResultArea');

    // --- Pregnancy Calculator Logic ---
    function calculateDueDate() {
        if (!lmpDateInput.value) {
            dueDateResultArea.innerHTML = `<p class="text-red-600">অনুগ্রহ করে আপনার শেষ মাসিকের প্রথম দিন নির্বাচন করুন।</p>`;
            return;
        }

        const lmp = new Date(lmpDateInput.value);
        
        // Naegele's rule: LMP + 280 days (40 weeks)
        const dueDate = new Date(lmp);
        dueDate.setDate(dueDate.getDate() + 280);

        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const formattedDueDate = dueDate.toLocaleDateString('bn-BD', options);
        
        dueDateResultArea.innerHTML = `<h4>আপনার সম্ভাব্য ডিউ ডেট</h4><p>${formattedDueDate}</p>`;
    }

    // --- Water Intake Calculator Logic ---
    function calculateWaterIntake() {
        const age = parseInt(userAgeInput.value);
        const weight = parseFloat(userWeightInput.value);
        const activityMinutes = parseInt(activityLevelSelect.value);

        if (isNaN(age) || isNaN(weight) || age <= 0 || weight <= 0) {
            waterIntakeResultArea.innerHTML = `<p class="text-red-600">অনুগ্রহ করে সঠিক বয়স ও ওজন লিখুন।</p>`;
            return;
        }
        
        // Base intake: 30-35 ml per kg of body weight
        let baseIntakeMl = weight * 33;

        // Adjust for activity: Add 350-400 ml for every 30 mins of exercise
        let activityIntakeMl = (activityMinutes / 30) * 375;

        const totalIntakeMl = baseIntakeMl + activityIntakeMl;
        const totalIntakeLiters = (totalIntakeMl / 1000).toFixed(1);

        waterIntakeResultArea.innerHTML = `<h4>আপনার দৈনিক পানির চাহিদা</h4><p>আপনার প্রতিদিন প্রায় ${totalIntakeLiters} লিটার পানি পান করা উচিত।</p>`;
    }

    // --- Event Listeners ---
    if (calculateDueDateBtn) {
        calculateDueDateBtn.addEventListener('click', calculateDueDate);
    }
    if (calculateWaterIntakeBtn) {
        calculateWaterIntakeBtn.addEventListener('click', calculateWaterIntake);
    }
}
// ====================================================================
// END: HEALTH & LIFESTYLE TAB SCRIPT
// ====================================================================


// ====================================================================
// START: DAYS/OBSERVANCES SCRIPT (দিবসসমূহ)
// ====================================================================
function initializeDaysObservancesTab() {
    // DOM Elements
    const yearSelectInput = document.getElementById('observanceYearSelect');
    const bangladeshiDaysList = document.getElementById('bangladeshiDaysList');
    const internationalDaysList = document.getElementById('internationalDaysList');
    // নতুন সেকশনের জন্য DOM Elements
    const upcomingNationalDayCard = document.getElementById('upcomingNationalDay');
    const upcomingInternationalDayCard = document.getElementById('upcomingInternationalDay');
    const todayNationalDayCard = document.getElementById('todayNationalDay');
    const todayInternationalDayCard = document.getElementById('todayInternationalDay');

    if (!yearSelectInput || !bangladeshiDaysList || !internationalDaysList) return;



// Data for Bangladeshi observances (Updated and Verified)
    const bangladeshiObservances = [
        // JANUARY (month: 0)
        { name: "জাতীয় সমাজসেবা দিবস", month: 0, day: 2 },
        { name: "বঙ্গবন্ধুর স্বদেশ প্রত্যাবর্তন দিবস", month: 0, day: 10 },
        { name: "শহীদ আসাদ দিবস", month: 0, day: 20 }, // নতুন যুক্ত করা হয়েছে
        { name: "গণঅভ্যুত্থান দিবস", month: 0, day: 24 }, // নতুন যুক্ত করা হয়েছে
        
        // FEBRUARY (month: 1)
        { name: "জাতীয় গ্রন্থাগার দিবস", month: 1, day: 5 },
        { name: "সুন্দরবন দিবস", month: 1, day: 14 }, // নতুন যুক্ত করা হয়েছে
        { name: "শহীদ দিবস ও আন্তর্জাতিক মাতৃভাষা দিবস", month: 1, day: 21 },
        { name: "জাতীয় স্থানীয় সরকার দিবস", month: 1, day: 25 }, // নতুন যুক্ত করা হয়েছে (সাম্প্রতিক)

        // MARCH (month: 2)
        { name: "জাতীয় বিমা দিবস", month: 2, day: 1 },
        { name: "জাতীয় ভোটার দিবস", month: 2, day: 2 },
        { name: "জাতীয় পতাকা উত্তোলন দিবস", month: 2, day: 2 },
        { name: "জাতীয় পাট দিবস", month: 2, day: 6 },
        { name: "জাতীয় দুর্যোগ প্রস্তুতি দিবস", month: 2, day: 10 }, // আন্তর্জাতিক তালিকা থেকে এখানে আনা হয়েছে
        { name: "জাতীয় শিশু দিবস (বঙ্গবন্ধুর জন্মদিন)", month: 2, day: 17 },
        { name: "গণহত্যা দিবস", month: 2, day: 25 },
        { name: "স্বাধীনতা দিবস", month: 2, day: 26 },

        // APRIL (month: 3)
        { name: "জাতীয় চলচ্চিত্র দিবস", month: 3, day: 3 },
        { name: "পহেলা বৈশাখ (বাংলা নববর্ষ)", month: 3, day: 14 },
        { name: "মুজিবনগর দিবস", month: 3, day: 17 },
        { name: "জাতীয় স্বাস্থ্য ও পুষ্টি দিবস", month: 3, day: 23 },
        { name: "জাতীয় আইনগত সহায়তা দিবস", month: 3, day: 28 },

        // MAY (month: 4)
        { name: "শ্রমিক দিবস (মে দিবস)", month: 4, day: 1 },
        { name: "রবীন্দ্রজয়ন্তী (২৫ বৈশাখ)", month: 4, day: 8 },
        { name: "বুদ্ধ পূর্ণিমা", month: 4, day: 11 }, // Date approximate/varies
        { name: "নজরুলজয়ন্তী (১১ জ্যৈষ্ঠ)", month: 4, day: 25 },
        { name: "নিরাপদ মাতৃত্ব দিবস", month: 4, day: 28 },

        // JUNE (month: 5)
        { name: "জাতীয় চা দিবস", month: 5, day: 4 },
        { name: "ঐতিহাসিক ৬-দফা দিবস", month: 5, day: 7 },
        { name: "পলাশী দিবস", month: 5, day: 23 },

        // JULY (month: 6)
        { name: "ঢাকা বিশ্ববিদ্যালয় দিবস", month: 6, day: 1 },
        { name: "জুলাই শহীদ দিবস", month: 6, day: 16 },
        { name: "জাতীয় পাবলিক সার্ভিস দিবস", month: 6, day: 23 },

        // AUGUST (month: 7)
        { name: "ছাত্র-গণ অভ্যুত্থান দিবস", month: 7, day: 5 }, 
        { name: "জাতীয় জ্বালানি নিরাপত্তা দিবস", month: 7, day: 9 },
        { name: "জাতীয় শোক দিবস", month: 7, day: 15 },
        { name: "শুভ জন্মাষ্টমী", month: 7, day: 16 }, // Date approximate/varies

        // SEPTEMBER (month: 8)
        { name: "শিক্ষা দিবস", month: 8, day: 17 },
        { name: "জাতীয় কন্যা শিশু দিবস", month: 8, day: 30 }, // নতুন যুক্ত করা হয়েছে

        // OCTOBER (month: 9)
        { name: "দুর্গাপূজা (মহানবমী)", month: 9, day: 1 }, // Date approximate/varies
        { name: "দুর্গাপূজা (বিজয়া দশমী)", month: 9, day: 2 }, // Date approximate/varies
        { name: "জাতীয় উত্পাদনশীলতা দিবস", month: 9, day: 2 },
        { name: "জাতীয় জন্ম ও মৃত্যু নিবন্ধন দিবস", month: 9, day: 6 }, // আন্তর্জাতিক তালিকা থেকে এখানে আনা হয়েছে
        { name: "জাতীয় নিরাপদ সড়ক দিবস", month: 9, day: 22 },

        // NOVEMBER (month: 10)
        { name: "জাতীয় যুব দিবস", month: 10, day: 1 }, // নতুন যুক্ত করা হয়েছে
        { name: "জাতীয় সমবায় দিবস", dateFn: (year) => getNthWeekdayOfMonth(year, 10, 6, 1) }, // Nov 1st Sat
        { name: "জেল হত্যা দিবস", month: 10, day: 3 },
        { name: "সংবিধান দিবস", month: 10, day: 4 },
        { name: "জাতীয় সংহতি ও বিপ্লব দিবস", month: 10, day: 7 },
        { name: "সশস্ত্র বাহিনী দিবস", month: 10, day: 21 },
        { name: "আয়কর দিবস", month: 10, day: 30 }, // নতুন যুক্ত করা হয়েছে

        // DECEMBER (month: 11)
        { name: "মুক্তিযোদ্ধা দিবস", month: 11, day: 1 }, // নতুন যুক্ত করা হয়েছে
        { name: "জাতীয় বস্ত্র দিবস", month: 11, day: 4 },
        { name: "স্বৈরাচার পতন দিবস", month: 11, day: 6 }, // নতুন যুক্ত করা হয়েছে
        { name: "বেগম রোকেয়া দিবস", month: 11, day: 9 },
        { name: "জাতীয় ভ্যাট দিবস", month: 11, day: 10 }, // নতুন যুক্ত করা হয়েছে
        { name: "ডিজিটাল বাংলাদেশ দিবস", month: 11, day: 12 },
        { name: "শহীদ বুদ্ধিজীবী দিবস", month: 11, day: 14 },
        { name: "বিজয় দিবস", month: 11, day: 16 },
        { name: "বাংলাদেশ সুপ্রিম কোর্ট দিবস", month: 11, day: 18 }, // নতুন যুক্ত করা হয়েছে
        { name: "বর্ডার গার্ড বাংলাদেশ (বিজিবি) দিবস", month: 11, day: 20 }, // নতুন যুক্ত করা হয়েছে
        { name: "বড়দিন", month: 11, day: 25 },
    ];

    // Data for International observances (Updated with the comprehensive list)
    const internationalObservances = [
        // JANUARY
        { name: "নববর্ষ", month: 0, day: 1 },
        { name: "বিশ্ব ব্রেইল দিবস", month: 0, day: 4 },
        { name: "আন্তর্জাতিক শিক্ষা দিবস", month: 0, day: 24 },
        { name: "আন্তর্জাতিক পরিচ্ছন্ন শক্তি দিবস", month: 0, day: 26 },
        { name: "হলোকাস্টের শিকারদের স্মরণে আন্তর্জাতিক দিবস", month: 0, day: 27 },

        // FEBRUARY
        { name: "বিশ্ব জলাভূমি দিবস", month: 1, day: 2 },
        { name: "বিশ্ব ক্যান্সার দিবস", month: 1, day: 4 },
        { name: "আন্তর্জাতিক মানব ভ্রাতৃত্ব দিবস", month: 1, day: 4 },
        { name: "নারী খৎনা’র প্রতি শূন্য সহনশীলতা আন্তর্জাতিক দিবস", month: 1, day: 6 },
        { name: "বিশ্ব ডাল দিবস", month: 1, day: 10 },
        { name: "বিজ্ঞানে নারী ও মেয়েদের আন্তর্জাতিক দিবস", month: 1, day: 11 },
        { name: "সহিংস চরমপন্থা প্রতিরোধ আন্তর্জাতিক দিবস", month: 1, day: 12 },
        { name: "বিশ্ব বেতার দিবস", month: 1, day: 13 },
        { name: "বিশ্ব ভালোবাসা দিবস", month: 1, day: 14 },
        { name: "বিশ্ব সামাজিক ন্যায়বিচার দিবস", month: 1, day: 20 },
        { name: "জাতিসংঘ আন্তর্জাতিক মাতৃভাষা দিবস", month: 1, day: 21 }, // (Added UN prefix for clarity)

        // MARCH
        { name: "বিশ্ব সিগ্রাস দিবস", month: 2, day: 1 },
        { name: "জাতিসংঘ শূন্য বৈষম্য দিবস", month: 2, day: 1 },
        { name: "শ্রবণশক্তি হ্রাস প্রতিরোধ আন্তর্জাতিক দিবস", month: 2, day: 3 },
        { name: "বিশ্ব বন্যপ্রাণী দিবস", month: 2, day: 3 },
        { name: "নিরস্ত্রীকরণ ও বিস্তার রোধ সচেতনতা আন্তর্জাতিক দিবস", month: 2, day: 5 },
        { name: "আন্তর্জাতিক নারী দিবস", month: 2, day: 8 },
        { name: "আন্তর্জাতিক নারী বিচারক দিবস", month: 2, day: 10 },
        { name: "ইসলামোফোবিয়া মোকাবিলা আন্তর্জাতিক দিবস", month: 2, day: 15 },
        { name: "আন্তর্জাতিক সুখ দিবস", month: 2, day: 20 },
        { name: "ফরাসি ভাষা দিবস", month: 2, day: 20 },
        { name: "আন্তর্জাতিক বর্ণবৈষম্য বিলোপ দিবস", month: 2, day: 21 },
        { name: "বিশ্ব কবিতা দিবস", month: 2, day: 21 },
        { name: "আন্তর্জাতিক নওরোজ দিবস", month: 2, day: 21 },
        { name: "বিশ্ব ডাউন সিনড্রোম দিবস", month: 2, day: 21 },
        { name: "আন্তর্জাতিক বন দিবস", month: 2, day: 21 },
        { name: "বিশ্ব হিমবাহ দিবস", month: 2, day: 21 },
        { name: "বিশ্ব পানি দিবস", month: 2, day: 22 },
        { name: "বিশ্ব আবহাওয়া দিবস", month: 2, day: 23 },
        { name: "বিশ্ব যক্ষ্মা দিবস", month: 2, day: 24 },
        { name: "গুরুতর মানবাধিকার লঙ্ঘনের সত্য জানার অধিকার আন্তর্জাতিক দিবস", month: 2, day: 24 },
        { name: "দাসত্ব ও ট্রান্সআটলান্টিক দাস বাণিজ্যের শিকারদের স্মরণ আন্তর্জাতিক দিবস", month: 2, day: 25 },
        { name: "আটক ও নিখোঁজ কর্মীদের সাথে সংহতি আন্তর্জাতিক দিবস", month: 2, day: 25 },
        { name: "আন্তর্জাতিক শূন্য বর্জ্য দিবস", month: 2, day: 30 },

        // APRIL
        { name: "বিশ্ব অটিজম সচেতনতা দিবস", month: 3, day: 2 },
        { name: "খনি সচেতনতা ও সহায়তা আন্তর্জাতিক দিবস", month: 3, day: 4 },
        { name: "আন্তর্জাতিক বিবেক দিবস", month: 3, day: 5 },
        { name: "উন্নয়ন ও শান্তির জন্য আন্তর্জাতিক ক্রীড়া দিবস", month: 3, day: 6 },
        { name: "বিশ্ব স্বাস্থ্য দিবস", month: 3, day: 7 },
        { name: "রুয়ান্ডা গণহত্যার প্রতিফলন আন্তর্জাতিক দিবস", month: 3, day: 7 },
        { name: "আন্তর্জাতিক মানব মহাকাশ যাত্রা দিবস", month: 3, day: 12 },
        { name: "বিশ্ব চাগাস রোগ দিবস", month: 3, day: 14 },
        { name: "বিশ্ব শিল্পকলা দিবস", month: 3, day: 15 },
        { name: "ধরিত্রী দিবস (আন্তর্জাতিক মাতৃ ধরিত্রী দিবস)", month: 3, day: 22 },
        { name: "চীনা ভাষা দিবস", month: 3, day: 20 },
        { name: "বিশ্ব সৃজনশীলতা ও উদ্ভাবন দিবস", month: 3, day: 21 },
        { name: "বিশ্ব বই ও কপিরাইট দিবস", month: 3, day: 23 },
        { name: "স্প্যানিশ ভাষা দিবস", month: 3, day: 23 },
        { name: "ইংরেজি ভাষা দিবস", month: 3, day: 23 },
        { name: "বহুপাক্ষিকতা ও শান্তির জন্য কূটনীতি আন্তর্জাতিক দিবস", month: 3, day: 24 },
        { name: "আইসিটিতে আন্তর্জাতিক নারী দিবস (আনুমানিক)", month: 3, day: 24 }, // Date may vary
        { name: "আন্তর্জাতিক প্রতিনিধি দিবস", month: 3, day: 25 },
        { name: "বিশ্ব ম্যালেরিয়া দিবস", month: 3, day: 25 },
        { name: "বিশ্ব মেধাস্বত্ব দিবস", month: 3, day: 26 },
        { name: "আন্তর্জাতিক চেরনোবিল দুর্যোগ স্মরণ দিবস", month: 3, day: 26 },
        { name: "কর্মক্ষেত্রে নিরাপত্তা ও স্বাস্থ্য বিশ্ব দিবস", month: 3, day: 28 },
        { name: "আন্তর্জাতিক জ্যাজ দিবস", month: 3, day: 30 },

        // MAY
        { name: "বিশ্ব টুনা দিবস", month: 4, day: 2 },
        { name: "বিশ্ব প্রেস স্বাধীনতা দিবস", month: 4, day: 3 },
        { name: "দ্বিতীয় বিশ্বযুদ্ধে নিহতদের স্মরণ সময়", month: 4, day: 8 }, // 8-9 May
        { name: "আন্তর্জাতিক আরগানিয়া দিবস", month: 4, day: 10 },
        { name: "বিশ্ব পরিযায়ী পাখি দিবস", month: 4, day: 10 }, // Date varies
        { name: "আন্তর্জাতিক উদ্ভিদ স্বাস্থ্য দিবস", month: 4, day: 12 },
        { name: "আন্তর্জাতিক পরিবার দিবস", month: 4, day: 15 },
        { name: "শান্তিতে একত্রে বসবাস আন্তর্জাতিক দিবস", month: 4, day: 16 },
        { name: "আন্তর্জাতিক আলো দিবস", month: 4, day: 16 },
        { name: "বিশ্ব টেলিযোগাযোগ ও তথ্য সমাজ দিবস", month: 4, day: 17 },
        { name: "বিশ্ব মৌমাছি দিবস", month: 4, day: 20 },
        { name: "সংলাপ ও উন্নয়নের জন্য বিশ্ব সাংস্কৃতিক বৈচিত্র্য দিবস", month: 4, day: 21 },
        { name: "আন্তর্জাতিক চা দিবস", month: 4, day: 21 },
        { name: "আন্তর্জাতিক জীববৈচিত্র্য দিবস", month: 4, day: 22 },
        { name: "আন্তর্জাতিক প্রসূতি ফিস্টুলা নির্মূল দিবস", month: 4, day: 23 },
        { name: "আন্তর্জাতিক ভেসাক দিবস (বুদ্ধ পূর্ণিমা)", month: 4, day: 23 }, // Date varies
        { name: "আন্তর্জাতিক মারখোর দিবস", month: 4, day: 24 },
        { name: "আফ্রিকা দিবস", month: 4, day: 25 },
        { name: "বিশ্ব ফুটবল দিবস", month: 4, day: 25 },
        { name: "জাতিসংঘ শান্তিরক্ষী আন্তর্জাতিক দিবস", month: 4, day: 29 },
        { name: "আন্তর্জাতিক আলু দিবস", month: 4, day: 30 },
        { name: "বিশ্ব তামাকমুক্ত দিবস", month: 4, day: 31 },
        { name: "মা দিবস", dateFn: (year) => getNthWeekdayOfMonth(year, 4, 0, 2) }, // 2nd Sunday of May

        // JUNE
        { name: "বিশ্ব পরিবেশ দিবস", month: 5, day: 5 },
        { name: "বিশ্ব বাইসাইকেল দিবস", month: 5, day: 3 },
        { name: "আগ্রাসনের শিকার নিরীহ শিশুদের আন্তর্জাতিক দিবস", month: 5, day: 4 },
        { name: "অবৈধ, অপ্রতিবেদিত ও অনিয়ন্ত্রিত মাছ ধরা বন্ধের আন্তর্জাতিক দিবস", month: 5, day: 5 },
        { name: "রুশ ভাষা দিবস", month: 5, day: 6 },
        { name: "বিশ্ব খাদ্য নিরাপত্তা দিবস", month: 5, day: 7 },
        { name: "সভ্যতার মধ্যে সংলাপের আন্তর্জাতিক দিবস", month: 5, day: 10 },
        { name: "আন্তর্জাতিক খেলা দিবস", month: 5, day: 11 },
        { name: "বিশ্ব শিশুশ্রম বিরোধী দিবস", month: 5, day: 12 },
        { name: "আন্তর্জাতিক অ্যালবিনিজম সচেতনতা দিবস", month: 5, day: 13 },
        { name: "বিশ্ব রক্তদাতা দিবস", month: 5, day: 14 },
        { name: "বিশ্ব প্রবীণ নির্যাতন সচেতনতা দিবস", month: 5, day: 15 },
        { name: "পারিবারিক রেমিটেন্স আন্তর্জাতিক দিবস", month: 5, day: 16 },
        { name: "বিশ্ব মরুকরণ ও খরা প্রতিরোধ দিবস", month: 5, day: 17 },
        { name: "টেকসই গ্যাস্ট্রোনমি দিবস", month: 5, day: 18 },
        { name: "ঘৃণাত্মক বক্তব্য প্রতিহত করার আন্তর্জাতিক দিবস", month: 5, day: 18 },
        { name: "সংঘর্ষে যৌন সহিংসতা নির্মূল আন্তর্জাতিক দিবস", month: 5, day: 19 },
        { name: "বিশ্ব শরণার্থী দিবস", month: 5, day: 20 },
        { name: "আন্তর্জাতিক যোগ দিবস", month: 5, day: 21 },
        { name: "সংক্রান্তি উদযাপন আন্তর্জাতিক দিবস", month: 5, day: 21 },
        { name: "জাতিসংঘ জনসেবা দিবস", month: 5, day: 23 },
        { name: "আন্তর্জাতিক বিধবা দিবস", month: 5, day: 23 },
        { name: "কূটনীতিতে নারী আন্তর্জাতিক দিবস", month: 5, day: 24 },
        { name: "আন্তর্জাতিক নাবিক দিবস", month: 5, day: 25 },
        { name: "আন্তর্জাতিক মাদকদ্রব্যের অপব্যবহার বিরোধী দিবস", month: 5, day: 26 },
        { name: "নির্যাতনের শিকারদের সমর্থনে আন্তর্জাতিক দিবস", month: 5, day: 26 },
        { name: "ক্ষুদ্র, ছোট ও মাঝারি উদ্যোগ দিবস", month: 5, day: 27 },
        { name: "আন্তর্জাতিক গ্রীষ্মমন্ডল দিবস", month: 5, day: 29 },
        { name: "আন্তর্জাতিক সংসদীয় দিবস", month: 5, day: 30 },
        { name: "আন্তর্জাতিক গ্রহাণু দিবস", month: 5, day: 30 },
        { name: "বাবা দিবস", dateFn: (year) => getNthWeekdayOfMonth(year, 5, 0, 3) }, // 3rd Sunday of June
        { name: "আন্তর্জাতিক সমবায় দিবস", month: 6, day: 5 }, // Date varies (1st Saturday)

        // JULY
        { name: "বিশ্ব গ্রামীণ উন্নয়ন দিবস", month: 6, day: 6 },
        { name: "বিশ্ব জনসংখ্যা দিবস", month: 6, day: 11 },
        { name: "স্রেব্রেনিৎসা গণহত্যা স্মরণ ও স্মরণ আন্তর্জাতিক দিবস", month: 6, day: 11 },
        { name: "আন্তর্জাতিক আশা দিবস", month: 6, day: 12 },
        { name: "বালি ও ধূলিঝড় মোকাবিলা আন্তর্জাতিক দিবস", month: 6, day: 12 },
        { name: "বিশ্ব যুব দক্ষতা দিবস", month: 6, day: 15 },
        { name: "আন্তর্জাতিক অপরাধ বিচার দিবস", month: 6, day: 17 },
        { name: "নেলসন ম্যান্ডেলা আন্তর্জাতিক দিবস", month: 6, day: 18 },
        { name: "আন্তর্জাতিক চাঁদ দিবস", month: 6, day: 20 },
        { name: "বিশ্ব দাবা দিবস", month: 6, day: 20 },
        { name: "বিচারিক সুস্থতা আন্তর্জাতিক দিবস", month: 6, day: 25 },
        { name: "আফ্রিকান বংশোদ্ভূত নারী ও মেয়েদের আন্তর্জাতিক দিবস", month: 6, day: 25 },
        { name: "বিশ্ব ডুবে যাওয়া প্রতিরোধ দিবস", month: 6, day: 25 },
        { name: "বিশ্ব হেপাটাইটিস দিবস", month: 6, day: 28 },
        { name: "মানব পাচার বিরোধী বিশ্ব দিবস", month: 6, day: 30 },
        { name: "আন্তর্জাতিক বন্ধুত্ব দিবস", month: 6, day: 30 },

        // AUGUST
        { name: "স্থলবেষ্টিত উন্নয়নশীল দেশগুলোর চ্যালেঞ্জ সচেতনতা আন্তর্জাতিক দিবস", month: 7, day: 6 },
        { name: "বিশ্ব আদিবাসী জনগোষ্ঠী আন্তর্জাতিক দিবস", month: 7, day: 9 },
        { name: "আন্তর্জাতিক যুব দিবস", month: 7, day: 12 },
        { name: "বিশ্ব মানবিক দিবস", month: 7, day: 19 },
        { name: "সন্ত্রাসবাদের শিকারদের স্মরণ ও শ্রদ্ধা আন্তর্জাতিক দিবস", month: 7, day: 21 },
        { name: "ধর্ম বা বিশ্বাসের ভিত্তিতে সহিংসতা শিকারদের স্মরণ আন্তর্জাতিক দিবস", month: 7, day: 22 },
        { name: "দাস বাণিজ্য ও এর বিলুপ্তি স্মরণ আন্তর্জাতিক দিবস", month: 7, day: 23 },
        { name: "বিশ্ব হ্রদ দিবস", month: 7, day: 29 },
        { name: "পারমাণবিক পরীক্ষা বিরোধী আন্তর্জাতিক দিবস", month: 7, day: 29 },
        { name: "গুমের শিকারদের আন্তর্জাতিক দিবস", month: 7, day: 30 },
        { name: "আফ্রিকান বংশোদ্ভূতদের জন্য আন্তর্জাতিক দিবস", month: 7, day: 31 },

        // SEPTEMBER
        { name: "আন্তর্জাতিক দাতব্য দিবস", month: 8, day: 5 },
        { name: "নীল আকাশের জন্য আন্তর্জাতিক পরিচ্ছন্ন বায়ু দিবস", month: 8, day: 7 },
        { name: "আন্তর্জাতিক সাক্ষরতা দিবস", month: 8, day: 8 },
        { name: "আক্রমণ থেকে শিক্ষাকে রক্ষা করার আন্তর্জাতিক দিবস", month: 8, day: 9 },
        { name: "আত্মহত্যা প্রতিরোধ সচেতনতা দিবস", month: 8, day: 10 },
        { name: "দক্ষিণ-দক্ষিণ সহযোগিতা জাতিসংঘ দিবস", month: 8, day: 12 },
        { name: "আন্তর্জাতিক গণতন্ত্র দিবস", month: 8, day: 15 },
        { name: "দক্ষিণের জন্য বিজ্ঞান, প্রযুক্তি ও উদ্ভাবন আন্তর্জাতিক দিবস", month: 8, day: 16 },
        { name: "ওজোন স্তর সংরক্ষণের জন্য আন্তর্জাতিক দিবস", month: 8, day: 16 },
        { name: "বিশ্ব রোগী নিরাপত্তা দিবস", month: 8, day: 17 },
        { name: "আন্তর্জাতিক সমান বেতন দিবস", month: 8, day: 18 },
        { name: "বিশ্ব পরিচ্ছন্নতা দিবস", month: 8, day: 20 }, // Date varies
        { name: "আন্তর্জাতিক শান্তি দিবস", month: 8, day: 21 },
        { name: "আন্তর্জাতিক সাংকেতিক ভাষা দিবস", month: 8, day: 23 },
        { name: "বিশ্ব নৌ দিবস", month: 8, day: 25 }, // Date varies
        { name: "পারমাণবিক অস্ত্র সম্পূর্ণ নির্মূল আন্তর্জাতিক দিবস", month: 8, day: 26 },
        { name: "বিশ্ব পর্যটন দিবস", month: 8, day: 27 },
        { name: "বিশ্ব নদী দিবস", month: 8, day: 28 }, // Date varies
        { name: "তথ্যে সার্বজনীন প্রবেশাধিকার আন্তর্জাতিক দিবস", month: 8, day: 28 },
        { name: "খাদ্য অপচয় ও বর্জ্য হ্রাস সচেতনতা আন্তর্জাতিক দিবস", month: 8, day: 29 },
        { name: "আন্তর্জাতিক অনুবাদ দিবস", month: 8, day: 30 },

        // OCTOBER
        { name: "আন্তর্জাতিক প্রবীণ দিবস", month: 9, day: 1 },
        { name: "আন্তর্জাতিক অহিংসা দিবস", month: 9, day: 2 },
        { name: "বিশ্ব শিক্ষক দিবস", month: 9, day: 5 },
        { name: "বিশ্ব বাসস্থান দিবস", month: 9, day: 7 }, // Date varies (1st Monday)
        { name: "বিশ্ব ডাক দিবস", month: 9, day: 9 },
        { name: "বিশ্ব মানসিক স্বাস্থ্য দিবস", month: 9, day: 10 },
        { name: "আন্তর্জাতিক কন্যাশিশু দিবস", month: 9, day: 11 },
        { name: "আন্তর্জাতিক দুর্যোগ ঝুঁকি হ্রাস দিবস", month: 9, day: 13 },
        { name: "বিশ্ব পরিযায়ী পাখি দিবস", month: 9, day: 14 }, // Date varies
        { name: "বিশ্ব হাত ধোয়া দিবস", month: 9, day: 15 }, // ADDED: Global Handwashing Day
        { name: "আন্তর্জাতিক গ্রামীণ নারী দিবস", month: 9, day: 15 },
        { name: "বিশ্ব খাদ্য দিবস", month: 9, day: 16 },
        { name: "দারিদ্র্য বিমোচন আন্তর্জাতিক দিবস", month: 9, day: 17 },
        { name: "বিশ্ব পরিসংখ্যান দিবস", month: 9, day: 20 },
        { name: "জাতিসংঘ দিবস", month: 9, day: 24 },
        { name: "বিশ্ব উন্নয়ন তথ্য দিবস", month: 9, day: 24 },
        { name: "অডিওভিজ্যুয়াল ঐতিহ্য বিশ্ব দিবস", month: 9, day: 27 },
        { name: "আন্তর্জাতিক যত্ন ও সহায়তা দিবস", month: 9, day: 29 },
        { name: "বিশ্ব শহর দিবস", month: 9, day: 31 },
        { name: "হ্যালোউইন", month: 9, day: 31 },

        // NOVEMBER
        { name: "সাংবাদিকদের বিরুদ্ধে অপরাধের দায়মুক্তি অবসানের আন্তর্জাতিক দিবস", month: 10, day: 2 },
        { name: "বিশ্ব সুনামি সচেতনতা দিবস", month: 10, day: 5 },
        { name: "যুদ্ধ ও সশস্ত্র সংঘাতে পরিবেশের শোষণ প্রতিরোধের আন্তর্জাতিক দিবস", month: 10, day: 6 },
        { name: "বিশ্ব বিজ্ঞান দিবস (শান্তি ও উন্নয়নের জন্য)", month: 10, day: 10 },
        { name: "আন্তর্জাতিক টিকাদান দিবস", month: 10, day: 10 }, // Date is often April, but included as requested
        { name: "বিশ্ব ডায়াবেটিস দিবস", month: 10, day: 14 },
        { name: "আন্তঃদেশীয় সংগঠিত অপরাধের বিরুদ্ধে লড়াই ও প্রতিরোধের আন্তর্জাতিক দিবস", month: 10, day: 15 },
        { name: "আন্তর্জাতিক সহনশীলতা দিবস", month: 10, day: 16 },
        { name: "বিশ্ব টয়লেট দিবস", month: 10, day: 19 },
        { name: "সড়ক দুর্ঘটনায় ক্ষতিগ্রস্তদের স্মরণে বিশ্ব দিবস", month: 10, day: 19 }, // Date varies (3rd Sunday)
        { name: "আফ্রিকা শিল্পায়ন দিবস", month: 10, day: 20 },
        { name: "বিশ্ব শিশু দিবস", month: 10, day: 20 },
        { name: "বিশ্ব দর্শন দিবস", month: 10, day: 21 }, // Date varies (3rd Thursday)
        { name: "বিশ্ব টেলিভিশন দিবস", month: 10, day: 21 },
        { name: "বিশ্ব মৎস্য দিবস", month: 10, day: 21 },
        { name: "নারীর প্রতি সহিংসতা দূরীকরণের আন্তর্জাতিক দিবস", month: 10, day: 25 },
        { name: "বিশ্ব টেকসই পরিবহন দিবস", month: 10, day: 26 },
        { name: "ফিলিস্তিনি জনগণের সাথে সংহতি আন্তর্জাতিক দিবস", month: 10, day: 29 },
        { name: "সকল রাসায়নিক যুদ্ধের শিকারদের স্মরণ দিবস", month: 10, day: 30 },

        // DECEMBER
        { name: "বিশ্ব এইডস দিবস", month: 11, day: 1 },
        { name: "দাসত্ব বিলোপ আন্তর্জাতিক দিবস", month: 11, day: 2 },
        { name: "আন্তর্জাতিক প্রতিবন্ধী দিবস", month: 11, day: 3 },
        { name: "আন্তর্জাতিক ব্যাংক দিবস", month: 11, day: 4 },
        { name: "আন্তর্জাতিক স্বেচ্ছাসেবক দিবস", month: 11, day: 5 },
        { name: "বিশ্ব মৃত্তিকা দিবস", month: 11, day: 5 },
        { name: "আন্তর্জাতিক বেসামরিক বিমান চলাচল দিবস", month: 11, day: 7 },
        { name: "আন্তর্জাতিক দুর্নীতি বিরোধী দিবস", month: 11, day: 9 },
        { name: "গণহত্যা অপরাধের শিকারদের স্মরণ ও মর্যাদার আন্তর্জাতিক দিবস", month: 11, day: 9 },
        { name: "মানবাধিকার দিবস", month: 11, day: 10 },
        { name: "আন্তর্জাতিক পর্বত দিবস", month: 11, day: 11 },
        { name: "সার্বজনীন স্বাস্থ্য কভারেজ দিবস", month: 11, day: 12 },
        { name: "আন্তর্জাতিক নিরপেক্ষতা দিবস", month: 11, day: 12 },
        { name: "আন্তর্জাতিক অভিবাসী দিবস", month: 11, day: 18 },
        { name: "আরবি ভাষা দিবস", month: 11, day: 18 },
        { name: "আন্তর্জাতিক মানব সংহতি দিবস", month: 11, day: 20 },
        { name: "আন্তর্জাতিক মহামারী প্রস্তুতি দিবস", month: 11, day: 27 },

        // আপনার তালিকা থেকে নতুন যোগ করা হয়েছে (খ ও গ)
        { name: "বার্ষিক প্রশিক্ষণ দিবস", month: 0, day: 23 },
        { name: "জাতীয় নিরাপদ খাদ্য দিবস", month: 1, day: 2 },
        { name: "জাতীয় শহীদ সেনা দিবস", month: 1, day: 25 },
        { name: "জাতীয় দুর্যোগ প্রস্তুতি দিবস", month: 2, day: 10 },
        { name: "জাতীয় আইনগত সহায়তা দিবস", month: 3, day: 28 },
        { name: "আন্তর্জাতিক রেডক্রস ও রেড ক্রিসেন্ট দিবস", month: 4, day: 8 },
        { name: "বিশ্ব অ্যাক্রেডিটেশন দিবস", month: 5, day: 9 },
        { name: "বিশ্ব হার্ট দিবস", dateFn: (year) => getNthWeekdayOfMonth(year, 8, 0, 4) }, // Sep 4th Sun
        { name: "শিশু অধিকার দিবস", dateFn: (year) => getNthWeekdayOfMonth(year, 9, 1, 1) }, // Oct 1st Mon
        { name: "জাতীয় জন্ম ও মৃত্যু নিবন্ধন দিবস", month: 9, day: 6 },
        { name: "বিশ্ব সাদা ছড়ি দিবস", month: 9, day: 15 },
        { name: "জাতীয় স্বেচ্ছায় রক্তদান ও মরণোত্তর চক্ষুদান দিবস", month: 10, day: 2 },
        { name: "জাতীয় জীববৈচিত্র্য দিবস", month: 11, day: 29 },
    ];

    function getNthWeekdayOfMonth(year, month, weekday, n) {
        const date = new Date(year, month, 1);
        let count = 0;
        while (date.getDay() !== weekday) {
            date.setDate(date.getDate() + 1);
        }
        date.setDate(date.getDate() + (n - 1) * 7);
        return date;
    }
    // নতুন ফাংশন: আজকের দিবস খুঁজে বের করার জন্য
    function findTodayDay(observances, today) {
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth();
        const currentDay = today.getDate();

        const todayObservances = observances
            .map(obs => {
                const date = obs.dateFn ? obs.dateFn(currentYear) : new Date(currentYear, obs.month, obs.day);
                return { name: obs.name, date: date };
            })
            .filter(obs => 
                obs.date.getMonth() === currentMonth && 
                obs.date.getDate() === currentDay
            );

        return todayObservances; // আজকের সকল দিবসের একটি অ্যারে রিটার্ন করুন
    }
    // নতুন ফাংশন: আগত দিবস খুঁজে বের করার জন্য
    function findUpcomingDay(observances, today) {
        const currentYear = today.getFullYear();
        
        const upcoming = observances.map(obs => {
            let date = obs.dateFn ? obs.dateFn(currentYear) : new Date(currentYear, obs.month, obs.day);
            // যদি তারিখটি ইতোমধ্যে চলে গিয়ে থাকে (বা আজ হয়), তবে পরের বছরের তারিখ গণনা করুন
            if (date <= today) {
                date = obs.dateFn ? obs.dateFn(currentYear + 1) : new Date(currentYear + 1, obs.month, obs.day);
            }
            return { name: obs.name, date: date };
        })
        .sort((a, b) => a.date - b.date); // তারিখ অনুযায়ী সাজান

        return upcoming[0]; // সবচেয়ে কাছের তারিখটি রিটার্ন করুন
    }

    // নতুন ফাংশন: আগত দিবসের কার্ড আপডেট করার জন্য
    function displayTodayAndUpcomingObservances() {
        const today = new Date();
        today.setHours(0, 0, 0, 0); // শুধুমাত্র তারিখ তুলনা করার জন্য সময় রিসেট করুন

        // --- ১. আজকের দিবস (নতুন) ---
        const todayNational = findTodayDay(bangladeshiObservances, today);
        const todayInternational = findTodayDay(internationalObservances, today);
        
        const dateFormatter = new Intl.DateTimeFormat('bn-BD', { day: 'numeric', month: 'long' });
        const weekdayFormatter = new Intl.DateTimeFormat('bn-BD', { weekday: 'long' });

        if (todayNationalDayCard) {
            if (todayNational.length > 0) {
                todayNationalDayCard.innerHTML = `
                    <div class="card-supertitle">আজকের জাতীয় দিবস</div>
                    <div class="card-day-name">${todayNational.map(d => d.name).join('<br>')}</div>
                    <div class="card-day-date">${dateFormatter.format(today)} (${weekdayFormatter.format(today)})</div>
                `;
            } else {
                todayNationalDayCard.innerHTML = `
                    <div class="card-supertitle">আজকের জাতীয় দিবস</div>
                    <div class="card-day-name">আজ কোনো জাতীয় দিবস নেই</div>
                    <div class="card-day-date">${dateFormatter.format(today)}</div>
                `;
            }
        }
        
        if (todayInternationalDayCard) {
            if (todayInternational.length > 0) {
                todayInternationalDayCard.innerHTML = `
                    <div class="card-supertitle">আজকের আন্তর্জাতিক দিবস</div>
                    <div class="card-day-name">${todayInternational.map(d => d.name).join('<br>')}</div>
                    <div class="card-day-date">${dateFormatter.format(today)} (${weekdayFormatter.format(today)})</div>
                `;
            } else {
                todayInternationalDayCard.innerHTML = `
                    <div class="card-supertitle">আজকের আন্তর্জাতিক দিবস</div>
                    <div class="card-day-name">আজ কোনো আন্তর্জাতিক দিবস নেই</div>
                    <div class="card-day-date">${dateFormatter.format(today)}</div>
                `;
            }
        }

        // --- ২. আগত দিবস (বিদ্যমান) ---
        const upcomingNational = findUpcomingDay(bangladeshiObservances, today);
        const upcomingInternational = findUpcomingDay(internationalObservances, today);

        if (upcomingNationalDayCard && upcomingNational) {
            upcomingNationalDayCard.innerHTML = `
                <div class="card-supertitle">আগত জাতীয় দিবস</div>
                <div class="card-day-name">${upcomingNational.name}</div>
                <div class="card-day-date">${dateFormatter.format(upcomingNational.date)} (${weekdayFormatter.format(upcomingNational.date)})</div>
            `;
        }
        
        if (upcomingInternationalDayCard && upcomingInternational) {
            upcomingInternationalDayCard.innerHTML = `
                <div class="card-supertitle">আগত আন্তর্জাতিক দিবস</div>
                <div class="card-day-name">${upcomingInternational.name}</div>
                <div class="card-day-date">${dateFormatter.format(upcomingInternational.date)} (${weekdayFormatter.format(upcomingInternational.date)})</div>
            `;
        }
    }


    function displayObservances(year) {
        bangladeshiDaysList.innerHTML = '';
        internationalDaysList.innerHTML = '';

        const dateFormatter = new Intl.DateTimeFormat('bn-BD', { day: 'numeric', month: 'long' });
        const weekdayFormatter = new Intl.DateTimeFormat('bn-BD', { weekday: 'long' });

        bangladeshiObservances.forEach(obs => {
            const date = obs.dateFn ? obs.dateFn(year) : new Date(year, obs.month, obs.day);
            renderDayItem(date, obs.name, bangladeshiDaysList, dateFormatter, weekdayFormatter);
        });

        internationalObservances.forEach(obs => {
            const date = obs.dateFn ? obs.dateFn(year) : new Date(year, obs.month, obs.day);
            renderDayItem(date, obs.name, internationalDaysList, dateFormatter, weekdayFormatter);
        });
    }
    
    function renderDayItem(date, name, listElement, dateFormatter, weekdayFormatter) {
        const dateString = dateFormatter.format(date);
        const weekdayString = weekdayFormatter.format(date);

        const item = document.createElement('div');
        item.className = 'day-item';
        item.innerHTML = `
            <div class="day-name">${name}</div>
            <div class="day-date">${dateString} (${weekdayString})</div>
        `;
        listElement.appendChild(item);
    }

    yearSelectInput.addEventListener('input', () => {
        const year = parseInt(yearSelectInput.value, 10);
        if (!isNaN(year) && year > 1900 && year < 2100) {
            displayObservances(year);
        }
    });

    // Initial setup
    const currentYear = new Date().getFullYear();
    yearSelectInput.value = currentYear;
    displayObservances(currentYear);
    displayTodayAndUpcomingObservances(); // আপডেট করা নতুন ফাংশনটি কল করুন
}
// ====================================================================
// END: DAYS/OBSERVANCES SCRIPT
// ====================================================================

// ====================================================================
// START: HOLIDAY LIST SCRIPT (ছুটির তালিকা) - Gemini API ইন্টিগ্রেটেড
// ====================================================================
function initializeHolidayListTab() {
    const yearSelectInput = document.getElementById('holidayYearSelect');
    const holidayTableBody = document.querySelector('#holidayTable tbody');
    const upcomingHolidayCard = document.getElementById('upcomingHolidayCard');
    const refreshButton = document.getElementById('refreshHolidayListBtn'); // নতুন বাটন

    if (!yearSelectInput || !holidayTableBody || !upcomingHolidayCard || !refreshButton) return;

    // The holidayCache is no longer needed as a local variable.
    // We will use sessionStorage directly to cache data for the session.

    // Nager.Date API ব্যর্থ হলে অফলাইন ফলব্যাক ডেটা
    const localHolidayData = {
        2024: [
            { date: '2024-02-21', localName: 'শহীদ দিবস ও আন্তর্জাতিক মাতৃভাষা দিবস', name: 'Shaheed Day' },
            { date: '2024-02-26', localName: 'শব-ই-বরাত', name: 'Shab-e-Barat' },
            { date: '2024-03-17', localName: 'বঙ্গবন্ধুর জন্মদিন', name: 'Sheikh Mujibur Rahman\'s Birthday' },
            { date: '2024-03-26', localName: 'স্বাধীনতা দিবস', name: 'Independence Day' },
            { date: '2024-04-05', localName: 'জুমাতুল বিদা', name: 'Jumatul Bidah' },
            { date: '2024-04-07', localName: 'শব-ই-কদর', name: 'Shab-e-Qadr' },
            { date: '2024-04-10', localName: 'ঈদ-উল-ফিতরের আগের দিন', name: 'Eid al-Fitr Holiday' },
            { date: '2024-04-11', localName: 'ঈদ-উল-ফিতর', name: 'Eid al-Fitr' },
            { date: '2024-04-12', localName: 'ঈদ-উল-ফিতরের পরের দিন', name: 'Eid al-Fitr Holiday' },
            { date: '2024-04-14', localName: 'পহেলা বৈশাখ', name: 'Pahela Baishakh' },
            { date: '2024-05-01', localName: 'মে দিবস', name: 'May Day' },
            { date: '2024-05-22', localName: 'বুদ্ধ পূর্ণিমা', name: 'Buddha Purnima' },
            { date: '2024-06-16', localName: 'ঈদ-উল-আযহার আগের দিন', name: 'Eid al-Adha Holiday' },
            { date: '2024-06-17', localName: 'ঈদ-উল-আযহা', name: 'Eid al-Adha' },
            { date: '2024-06-18', localName: 'ঈদ-উল-আযহার পরের দিন', name: 'Eid al-Adha Holiday' },
            { date: '2024-07-17', localName: 'আশুরা', name: 'Ashura' },
            { date: '2024-08-15', localName: 'জাতীয় শোক দিবস', name: 'National Mourning Day' },
            { date: '2024-08-26', localName: 'শুভ জন্মাষ্টমী', name: 'Janmashtami' },
            { date: '2024-09-16', localName: 'ঈদ-ই-মিলাদুন্নবী (ﷺ)', name: 'Eid-e-Milad un-Nabi' },
            { date: '2024-10-13', localName: 'দুর্গাপূজা (বিজয়া দশমী)', name: 'Durga Puja' },
            { date: '2024-12-16', localName: 'বিজয় দিবস', name: 'Victory Day' },
            { date: '2024-12-25', localName: 'বড়দিন', name: 'Christmas Day' },
        ],
        2025: [
             { date: '2025-02-14', localName: 'শব-ই-মিরাজ', name: 'Shab-e-Meraj' },
             { date: '2025-02-21', localName: 'শহীদ দিবস ও আন্তর্জাতিক মাতৃভাষা দিবস', name: 'Shaheed Day' },
             { date: '2025-03-03', localName: 'শব-ই-বরাত', name: 'Shab-e-Barat' },
             { date: '2025-03-17', localName: 'বঙ্গবন্ধুর জন্মদিন', name: 'Sheikh Mujibur Rahman\'s Birthday' },
             { date: '2025-03-26', localName: 'স্বাধীনতা দিবস', name: 'Independence Day' },
             { date: '2025-03-28', localName: 'জুমাতুল বিদা', name: 'Jumatul Bidah' },
             { date: '2025-03-30', localName: 'ঈদ-উল-ফিতরের আগের দিন', name: 'Eid al-Fitr Holiday' },
             { date: '2025-03-31', localName: 'ঈদ-উল-ফিতর', name: 'Eid al-Fitr' },
             { date: '2025-04-01', localName: 'ঈদ-উল-ফিতরের পরের দিন', name: 'Eid al-Fitr Holiday' },
             { date: '2025-04-14', localName: 'পহেলা বৈশাখ', name: 'Pahela Baishakh' },
             { date: '2025-05-01', localName: 'মে দিবস', name: 'May Day' },
             { date: '2025-05-12', localName: 'বুদ্ধ পূর্ণিমা', name: 'Buddha Purnima' },
             { date: '2025-06-06', localName: 'ঈদ-উল-আযহার আগের দিন', name: 'Eid al-Adha Holiday' },
             { date: '2025-06-07', localName: 'ঈদ-উল-আযহা', name: 'Eid al-Adha' },
             { date: '2025-06-08', localName: 'ঈদ-উল-আযহার পরের দিন', name: 'Eid al-Adha Holiday' },
             { date: '2025-07-06', localName: 'আশুরা', name: 'Ashura' },
             { date: '2025-08-15', localName: 'জাতীয় শোক দিবস', name: 'National Mourning Day' },
             { date: '2025-08-16', localName: 'শুভ জন্মাষ্টমী', name: 'Janmashtami' },
             { date: '2025-09-05', localName: 'ঈদ-ই-মিলাদুন্নবী (ﷺ)', name: 'Eid-e-Milad un-Nabi' },
             { date: '2025-10-02', localName: 'দুর্গাপূজা (বিজয়া দশমী)', name: 'Durga Puja' },
             { date: '2025-12-16', localName: 'বিজয় দিবস', name: 'Victory Day' },
             { date: '2025-12-25', localName: 'বড়দিন', name: 'Christmas Day' },
        ]
    };

    const moonSightingKeywords = [
        'ঈদ', 'ফিতর', 'আযহা', 'শব-ই-বরাত', 'শব-ই-কদর',
        'শব-ই-মিরাজ', 'আশুরা', 'জুমাতুল বিদা', 'মিলাদুন্নবী'
    ];
    
    // Fallback function using Nager.Date API
    async function fetchHolidaysFromNager(year) {
        showCustomAlert('Gemini API থেকে ডেটা আনা যায়নি। বিকল্প উৎস থেকে চেষ্টা করা হচ্ছে।');
        const nagerCacheKey = `nager_holidays_${year}`;
        
        // sessionStorage থেকে ডেটা চেক করুন
        const cachedData = sessionStorage.getItem(nagerCacheKey);
        if (cachedData) {
            console.log(`Nager data for ${year} loaded from session cache.`);
            processAndRenderHolidays(JSON.parse(cachedData), year);
            return;
        }

        try {
            const response = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/BD`);
            if (!response.ok) {
                throw new Error(`Nager API থেকে ডেটা আনা সম্ভব হয়নি (Status: ${response.status})`);
            }
            const apiHolidays = await response.json();
            // sessionStorage-এ ডেটা সেভ করুন
            sessionStorage.setItem(nagerCacheKey, JSON.stringify(apiHolidays));
            processAndRenderHolidays(apiHolidays, year);
        } catch (nagerError) {
            console.error("Nager.Date API fetch error:", nagerError);
            if (localHolidayData[year]) {
                showCustomAlert('বিকল্প উৎস থেকেও ডেটা আনা যায়নি। অফলাইন তালিকা দেখানো হচ্ছে।');
                processAndRenderHolidays(localHolidayData[year], year);
            } else {
                holidayTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-4 text-red-500">ছুটির তালিকা লোড করতে সমস্যা হয়েছে।</td></tr>`;
                upcomingHolidayCard.innerHTML = `<div class="card-supertitle">আগত ছুটি</div><div class="card-day-name text-red-300">তথ্য পাওয়া যায়নি</div>`;
            }
        }
    }

    // Main function to load holidays, trying Gemini first
    async function loadAndDisplayHolidays(year) {
        holidayTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-4">ছুটির তালিকা লোড হচ্ছে...</td></tr>`;
        upcomingHolidayCard.innerHTML = `<div class="card-supertitle">আগত ছুটি</div><div class="card-day-name">লোড হচ্ছে...</div>`;
        
        const geminiCacheKey = `gemini_holidays_${year}`;
        
        // sessionStorage থেকে ডেটা চেক করুন
        const cachedData = sessionStorage.getItem(geminiCacheKey);
        if (cachedData) {
            console.log(`Gemini data for ${year} loaded from session cache.`);
            processAndRenderHolidays(JSON.parse(cachedData), year);
            return;
        }

        const apiKey = localStorage.getItem('geminiApiKey');
        if (!apiKey) {
            fetchHolidaysFromNager(year); // Fallback if no API key
            return;
        }

        try {
            const prompt = `Provide a list of all public holidays in Bangladesh for the year ${year}. The response must be a valid JSON array of objects. Each object must have two keys: "date" (in "YYYY-MM-DD" format) and "localName" (the name of the holiday in Bengali, including any relevant notes like 'চাঁদ দেখার উপর নির্ভরশীল'). Do not include any text, explanations, or markdown formatting outside of the JSON array.`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }]
            };
            // --- গ্লোবাল মডেল ব্যবহার ---
            const model = localStorage.getItem('geminiModel') || "gemini-flash-latest";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`Gemini API error! Status: ${response.status}`);
            }

            const result = await response.json();
            const rawText = result.candidates?.[0]?.content?.parts?.[0]?.text;

            if (!rawText) {
                throw new Error("Gemini API থেকে কোনো ডেটা পাওয়া যায়নি।");
            }
            
            // Clean the response text to ensure it's valid JSON
            const jsonText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
            const geminiHolidays = JSON.parse(jsonText);
            
            if (!Array.isArray(geminiHolidays)) {
                 throw new Error("Gemini API থেকে পাওয়া ডেটা সঠিক ফরম্যাটে নেই।");
            }

            // sessionStorage-এ ডেটা সেভ করুন
            sessionStorage.setItem(geminiCacheKey, JSON.stringify(geminiHolidays));
            processAndRenderHolidays(geminiHolidays, year);

        } catch (error) {
            console.error("Gemini API Holiday fetch error:", error);
            fetchHolidaysFromNager(year); // Fallback to Nager.Date API on any error
        }
    }

    // ডেটা প্রসেস এবং টেবিল ও কার্ডে প্রদর্শন করার ফাংশন
    function processAndRenderHolidays(apiHolidays, year) {
        let allHolidays = [];

        // বছরের সকল শুক্রবার ও শনিবার বের করুন
        for (let month = 0; month < 12; month++) {
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dayOfWeek = currentDate.getDay();
                if (dayOfWeek === 5 || dayOfWeek === 6) { // 5 = Friday, 6 = Saturday
                    allHolidays.push({
                        date: currentDate,
                        occasion: 'সাপ্তাহিক ছুটি',
                        type: 'weekend'
                    });
                }
            }
        }
        
        // API থেকে পাওয়া সরকারি ছুটি যোগ করুন
        apiHolidays.forEach(holiday => {
            const holidayDate = new Date(holiday.date);
            // API timezone 이슈 해결을 위해 UTC 기준으로 날짜를 맞춥니다.
            const utcDate = new Date(Date.UTC(holidayDate.getFullYear(), holidayDate.getMonth(), holidayDate.getDate()));

            const isMoonSighting = moonSightingKeywords.some(keyword => holiday.name?.includes(keyword) || holiday.localName.includes(keyword) || holiday.localName.includes('চাঁদ'));
            const holidayType = isMoonSighting ? 'moon-sighting' : 'gov';
            
            const existingHolidayIndex = allHolidays.findIndex(h => h.date.getTime() === utcDate.getTime());
            
            if (existingHolidayIndex !== -1) {
                // যদি সাপ্তাহিক ছুটির দিনে সরকারি ছুটি থাকে
                allHolidays[existingHolidayIndex].occasion = holiday.localName;
                allHolidays[existingHolidayIndex].type = holidayType;
            } else {
                allHolidays.push({
                    date: utcDate,
                    occasion: holiday.localName,
                    type: holidayType
                });
            }
        });

        // তারিখ অনুযায়ী ছুটিগুলো সাজান
        allHolidays.sort((a, b) => a.date - b.date);

        // টেবিল তৈরি করুন
        holidayTableBody.innerHTML = '';
        const dateFormatter = new Intl.DateTimeFormat('bn-BD', { day: 'numeric', month: 'long', year: 'numeric' });
        const weekdayFormatter = new Intl.DateTimeFormat('bn-BD', { weekday: 'long' });

        allHolidays.forEach(holiday => {
            const tr = document.createElement('tr');
            tr.className = `${holiday.type}-holiday`;
            tr.innerHTML = `
                <td class="px-6 py-4">${dateFormatter.format(holiday.date)}</td>
                <td class="px-6 py-4">${weekdayFormatter.format(holiday.date)}</td>
                <td class="px-6 py-4 font-semibold">${holiday.occasion}</td>
            `;
            holidayTableBody.appendChild(tr);
        });

        // আগত ছুটি খুঁজে বের করে কার্ডে দেখান
        const today = new Date();
        today.setHours(0, 0, 0, 0); // শুধুমাত্র তারিখ তুলনা করার জন্য
        const upcomingHoliday = allHolidays.find(h => h.date >= today && h.type !== 'weekend'); // শুধু সরকারি ছুটি খুঁজুন

        if (upcomingHoliday) {
            upcomingHolidayCard.innerHTML = `
                <div class="card-supertitle">পরবর্তী ছুটি</div>
                <div class="card-day-name">${upcomingHoliday.occasion}</div>
                <div class="card-day-date">${dateFormatter.format(upcomingHoliday.date)} (${weekdayFormatter.format(upcomingHoliday.date)})</div>
            `;
        } else {
            upcomingHolidayCard.innerHTML = `
                <div class="card-supertitle">আগত ছুটি</div>
                <div class="card-day-name">এই বছরে আর কোনো সরকারি ছুটি নেই</div>
            `;
        }
    }

    yearSelectInput.addEventListener('input', () => {
        const year = parseInt(yearSelectInput.value, 10);
        if (!isNaN(year) && year > 2000 && year < 2050) {
            loadAndDisplayHolidays(year);
        }
    });

    // নতুন: রিফ্রেশ বাটনের জন্য ইভেন্ট লিসেনার
    refreshButton.addEventListener('click', () => {
        const year = parseInt(yearSelectInput.value, 10);
        if (!isNaN(year)) {
            // ক্যাশ পরিষ্কার করুন
            sessionStorage.removeItem(`gemini_holidays_${year}`);
            sessionStorage.removeItem(`nager_holidays_${year}`);
            showCustomAlert(`${year} সালের ছুটির তালিকা রিফ্রেশ করা হচ্ছে...`);
            // ডেটা আবার লোড করুন
            loadAndDisplayHolidays(year);
        }
    });

    // ইনিশিয়ালাইজেশন
    const currentYear = new Date().getFullYear();
    yearSelectInput.value = currentYear;
    loadAndDisplayHolidays(currentYear);
}
// ====================================================================
// END: HOLIDAY LIST SCRIPT
// ====================================================================

// ====================================================================
// START: QUIZ TAB SCRIPT (Gemini API Integrated & State Preserved)
// ====================================================================

// Global variables to preserve quiz state across tab switches
let quizQuestions = [];
let currentQuestionIndex = 0;
let quizScore = 0;
let quizState = 'not_started'; // 'not_started', 'loading', 'in_progress', 'finished'

function initializeQuiz() {
// DOM Elements
const setupContainer = document.getElementById('quiz-setup-container');
const mainContainer = document.getElementById('quiz-main-container');
const resultContainer = document.getElementById('quiz-result-container');
const startBtn = document.getElementById('start-quiz-btn');
const categorySelect = document.getElementById('quiz-category');
const customCategoryInput = document.getElementById('quiz-custom-category'); // নতুন
const difficultySelect = document.getElementById('quiz-difficulty');
const questionCountSelect = document.getElementById('quiz-question-count');
const loadingEl = document.getElementById('quiz-loading');

const questionNumberEl = document.getElementById('question-number');
const scoreEl = document.getElementById('quiz-score');
const questionTextEl = document.getElementById('question-text');
const optionsContainer = document.getElementById('options-container');
const feedbackEl = document.getElementById('quiz-feedback');
const nextBtn = document.getElementById('next-question-btn');

const restartBtn = document.getElementById('restart-quiz-btn');
const finalScoreEl = document.getElementById('final-score');
const finalFeedbackEl = document.getElementById('final-feedback');

// নতুন: কাস্টম ক্যাটাগরি ইনপুট দেখানোর জন্য ইভেন্ট লিসেনার
if (categorySelect) {
    categorySelect.addEventListener('change', () => {
        if (categorySelect.value === 'custom') {
            customCategoryInput.classList.remove('hidden');
        } else {
            customCategoryInput.classList.add('hidden');
        }
    });
}

// Attach event listeners only once
const setupEventListeners = (() => {
    let listenersAttached = false;
    return () => {
        if (listenersAttached || !startBtn || !nextBtn || !restartBtn) return;
        startBtn.addEventListener('click', startQuiz);
        nextBtn.addEventListener('click', handleNextQuestion);
        restartBtn.addEventListener('click', () => {
            quizState = 'not_started';
            updateUI();
        });
        listenersAttached = true;
    };
})();

async function fetchQuizDataFromGemini(category, difficulty, count) {
    quizState = 'loading';
    updateUI();

    const apiKey = localStorage.getItem('geminiApiKey');
    if (!apiKey) {
        showCustomAlert('জেমিনি API কী সেট করা হয়নি। অনুগ্রহ করে সেটিংস থেকে API কী সেট করুন।');
        quizState = 'not_started';
        updateUI();
        return false;
    }

    try {
        const prompt = `
            Generate ${count} multiple-choice quiz questions for me in Bangladeshi Bengali.
            The category is "${category}" and the difficulty level is "${difficulty}".
            The questions should be relevant for general knowledge.
            Your response MUST be a valid JSON array of objects. Do not include any text, explanations, or markdown formatting outside of the JSON array.
            Each object in the array must have these four keys: "question", "options" (an array of 4 strings), "answer" (a string that exactly matches one of the options), and "type" (a string describing the question category and difficulty, e.g., "সাধারণ জ্ঞান (মধ্যম)").
        `;
        
        const payload = { contents: [{ parts: [{ text: prompt }] }] };
        // --- গ্লোবাল মডেল ব্যবহার ---
        const model = localStorage.getItem('geminiModel') || "gemini-flash-latest";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error(`API Error: ${response.status}`);

        const result = await response.json();
        const rawText = result.candidates?.[0]?.content?.parts?.[0]?.text;
        if (!rawText) throw new Error("API থেকে কোনো প্রশ্ন পাওয়া যায়নি।");

        const jsonText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
        const parsedQuestions = JSON.parse(jsonText);
        
        if (Array.isArray(parsedQuestions) && parsedQuestions.length > 0) {
            quizQuestions = parsedQuestions;
            return true;
        } else {
            throw new Error("API থেকে সঠিক ফরম্যাটে প্রশ্ন পাওয়া যায়নি।");
        }
    } catch (error) {
        console.error("Quiz Fetch Error:", error);
        showCustomAlert(`প্রশ্ন আনতে সমস্যা হয়েছে: ${error.message}`);
        quizState = 'not_started';
        updateUI();
        return false;
    }
}

async function startQuiz() {
    let category = categorySelect.value;
    const difficulty = difficultySelect.value;
    const count = questionCountSelect.value;
    
    if (category === 'custom') {
        category = customCategoryInput.value.trim();
        if (!category) {
            showCustomAlert('অনুগ্রহ করে একটি কাস্টম ক্যাটাগরি লিখুন।');
            return;
        }
    }
    
    const success = await fetchQuizDataFromGemini(category, difficulty, count);
    
    if (success) {
        quizState = 'in_progress';
        currentQuestionIndex = 0;
        quizScore = 0;
        updateUI();
        loadQuestion();
    }
}

function loadQuestion() {
    feedbackEl.textContent = '';
    feedbackEl.className = 'quiz-feedback';
    optionsContainer.innerHTML = '';
    nextBtn.style.display = 'none';

    const currentQuestion = quizQuestions[currentQuestionIndex];
    questionTextEl.innerHTML = currentQuestion.question;
    
    const questionTypeEl = document.createElement('span');
    questionTypeEl.id = 'question-type';
    // কাস্টম ক্যাটাগরির জন্য type হ্যান্ডেল করা
    let currentCategory = categorySelect.value === 'custom' ? customCategoryInput.value.trim() : categorySelect.value;
    questionTypeEl.textContent = currentQuestion.type || `${currentCategory} (${difficultySelect.value})`;
    questionTextEl.appendChild(document.createElement('br'));
    questionTextEl.appendChild(questionTypeEl);

    questionNumberEl.textContent = `প্রশ্ন: ${currentQuestionIndex + 1}/${quizQuestions.length}`;
    scoreEl.textContent = `স্কোর: ${quizScore}`;

    const shuffledOptions = [...currentQuestion.options].sort(() => Math.random() - 0.5);
    shuffledOptions.forEach(option => {
        const button = document.createElement('button');
        button.innerHTML = option;
        button.classList.add('option-btn');
        button.addEventListener('click', selectAnswer);
        optionsContainer.appendChild(button);
    });
}

function selectAnswer(e) {
    const selectedBtn = e.target;
    const correct = selectedBtn.innerHTML === quizQuestions[currentQuestionIndex].answer;

    if (correct) {
        quizScore++;
        selectedBtn.classList.add('correct');
        feedbackEl.textContent = 'সঠিক উত্তর!';
        feedbackEl.classList.add('correct');
    } else {
        selectedBtn.classList.add('incorrect');
        feedbackEl.textContent = `ভুল! সঠিক উত্তর: ${quizQuestions[currentQuestionIndex].answer}`;
        feedbackEl.classList.add('incorrect');
    }
    
    Array.from(optionsContainer.children).forEach(button => {
        if (button.innerHTML === quizQuestions[currentQuestionIndex].answer) {
            button.classList.add('correct');
        }
        button.disabled = true;
    });

    scoreEl.textContent = `স্কোর: ${quizScore}`;
    nextBtn.textContent = (currentQuestionIndex < quizQuestions.length - 1) ? 'পরবর্তী প্রশ্ন' : 'ফলাফল দেখুন';
    nextBtn.style.display = 'block';
}

function handleNextQuestion() {
    currentQuestionIndex++;
    if (currentQuestionIndex < quizQuestions.length) {
        loadQuestion();
    } else {
        showResults();
    }
}

function showResults() {
    quizState = 'finished';
    updateUI();

    finalScoreEl.textContent = `আপনি ${quizQuestions.length} টির মধ্যে ${quizScore} টি সঠিক উত্তর দিয়েছেন!`;

    let feedbackText = '';
    const percentage = (quizScore / quizQuestions.length) * 100;
    if (percentage === 100) feedbackText = 'অসাধারণ! আপনার জ্ঞান চমৎকার।';
    else if (percentage >= 70) feedbackText = 'খুব ভালো! চালিয়ে যান।';
    else if (percentage >= 40) feedbackText = 'ভালো করেছেন, আরও চেষ্টা করুন।';
    else feedbackText = 'অনুশীলন চালিয়ে যেতে হবে।';
    finalFeedbackEl.textContent = feedbackText;
}

 function updateUI() {
    setupContainer.classList.toggle('hidden', quizState !== 'not_started' && quizState !== 'loading');
    mainContainer.classList.toggle('hidden', quizState !== 'in_progress');
    resultContainer.classList.toggle('hidden', quizState !== 'finished');
    loadingEl.style.display = (quizState === 'loading') ? 'block' : 'none';
    startBtn.disabled = (quizState === 'loading');
}

// --- Main Logic ---
setupEventListeners();
updateUI();

}
// ====================================================================
// END: QUIZ TAB SCRIPT
// ====================================================================

// ====================================================================
// START: DONATE NUMBER COPY SCRIPT
// ====================================================================
const copyDonateNumberBtn = document.getElementById('copyDonateNumberBtn');
const donateNumberText = document.getElementById('donate-number-text');

if (copyDonateNumberBtn && donateNumberText) {
    copyDonateNumberBtn.addEventListener('click', () => {
        // টেক্সট থেকে শুধুমাত্র নম্বরটি খুঁজে বের করুন
        const numberToCopy = donateNumberText.textContent.match(/(\d{11})/);
        if (numberToCopy && numberToCopy[0]) {
            navigator.clipboard.writeText(numberToCopy[0]).then(() => {
                showCustomAlert('নম্বর (01778472964) কপি করা হয়েছে!');
            }).catch(err => {
                console.error('Could not copy text: ', err);
                showCustomAlert('কপি করতে ব্যর্থ হয়েছে।');
            });
        } else {
            showCustomAlert('কোনো নম্বর খুঁজে পাওয়া যায়নি।');
        }
    });
}
// ====================================================================
// END: DONATE NUMBER COPY SCRIPT
// ====================================================================

// ====================================================================
// START: INVOICE TAB SCRIPT (ইনভয়েজ ট্যাব)
// ====================================================================
document.addEventListener('DOMContentLoaded', () => {
    // শুধুমাত্র ইনভয়েজ ট্যাব সক্রিয় থাকলেই এই স্ক্রিপ্ট কাজ করবে
    const observer = new MutationObserver((mutations) => {
        for (const mutation of mutations) {
            if (mutation.attributeName === 'class') {
                const invoiceContent = document.getElementById('invoiceContent');
                if (invoiceContent && invoiceContent.classList.contains('active')) {
                    initializeInvoiceTab();
                    observer.disconnect(); // একবার ইনিশিয়ালাইজ হওয়ার পর আর পর্যবেক্ষণ করবে না
                    break;
                }
            }
        }
    });

    const invoiceContentElement = document.getElementById('invoiceContent');
    if (invoiceContentElement) {
        observer.observe(invoiceContentElement, { attributes: true });
        // যদি পেজ লোড হওয়ার সময়ই ট্যাবটি সক্রিয় থাকে
        if (invoiceContentElement.classList.contains('active')) {
            initializeInvoiceTab();
            observer.disconnect();
        }
    }

    // ইনভয়েজ ট্যাবের সকল ইভেন্ট ও ফাংশন এখানে থাকবে
function initializeInvoiceTab() {
    // --- বাংলা সংখ্যা রূপান্তরের জন্য হেল্পার ফাংশন ---
    const toBengali = (numStr) => {
        if (numStr === null || numStr === undefined) return '';
        const bengaliNumerals = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];
        return String(numStr).split('').map(char => {
            if (!isNaN(parseInt(char)) && char !== '.') {
                return bengaliNumerals[parseInt(char)];
            }
            return char;
        }).join('');
    };

    const toEnglish = (bengaliStr) => {
        if (bengaliStr === null || bengaliStr === undefined) return '';
        const bengaliNumerals = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];
        return String(bengaliStr).split('').map(char => {
            const index = bengaliNumerals.indexOf(char);
            return index !== -1 ? String(index) : char;
        }).join('');
    };

    // --- ইনপুট ফিল্ডে রিয়েল-টাইমে সংখ্যা বাংলায় রূপান্তরের জন্য ফাংশন ---
    function handleInvoiceNumberInput(event) {
        const input = event.target;
        const cursorPos = input.selectionStart;
        const originalValue = input.value;
        const englishValue = toEnglish(originalValue);
        const sanitizedValue = englishValue.replace(/[^\d.]/g, '').replace(/(\..*)\./g, '$1');
        const bengaliValue = toBengali(sanitizedValue);
        if (originalValue !== bengaliValue) {
            const diff = bengaliValue.length - originalValue.length;
            input.value = bengaliValue;
            input.setSelectionRange(cursorPos + diff, cursorPos + diff);
        }
    }

    // --- IndexedDB Helper Functions ---
    const DB_NAME = 'invoiceDB';
    const INVOICE_STORE_NAME = 'invoices';
    const PRODUCT_STORE_NAME = 'products';
    const DB_VERSION = 2; // ভার্সন আপগ্রেড করা হয়েছে
    let db;

    function openDb() {
        return new Promise((resolve, reject) => {
            if (db) return resolve(db);
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = (event) => reject('IndexedDB error: ' + request.error);
            request.onsuccess = (event) => { db = event.target.result; resolve(db); };
            request.onupgradeneeded = (event) => {
                const dbInstance = event.target.result;
                if (!dbInstance.objectStoreNames.contains(INVOICE_STORE_NAME)) {
                    const invoiceStore = dbInstance.createObjectStore(INVOICE_STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    invoiceStore.createIndex('date', 'date', { unique: false });
                }
                if (!dbInstance.objectStoreNames.contains(PRODUCT_STORE_NAME)) {
                    const productStore = dbInstance.createObjectStore(PRODUCT_STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    productStore.createIndex('name', 'name', { unique: false });
                }
            };
        });
    }
    // Invoice DB functions
    async function addInvoice(invoiceData) { const db = await openDb(); return new Promise((resolve, reject) => { const t = db.transaction(INVOICE_STORE_NAME, 'readwrite'); t.objectStore(INVOICE_STORE_NAME).add(invoiceData); t.oncomplete = () => resolve(true); t.onerror = (e) => reject('Error adding invoice: ' + e.target.error); }); }
    async function getAllInvoices() { const db = await openDb(); return new Promise((resolve, reject) => { const r = db.transaction(INVOICE_STORE_NAME, 'readonly').objectStore(INVOICE_STORE_NAME).getAll(); r.onsuccess = () => resolve(r.result.sort((a, b) => b.id - a.id)); r.onerror = (e) => reject('Error getting invoices: ' + e.target.error); }); }
    async function getInvoiceById(id) { const db = await openDb(); return new Promise((resolve, reject) => { const r = db.transaction(INVOICE_STORE_NAME, 'readonly').objectStore(INVOICE_STORE_NAME).get(id); r.onsuccess = () => resolve(r.result); r.onerror = (e) => reject('Error getting invoice by ID: ' + e.target.error); }); }
    async function deleteInvoice(id) { const db = await openDb(); return new Promise((resolve, reject) => { const t = db.transaction(INVOICE_STORE_NAME, 'readwrite'); t.objectStore(INVOICE_STORE_NAME).delete(id); t.oncomplete = () => resolve(true); t.onerror = (e) => reject('Error deleting invoice: ' + e.target.error); }); }
    async function clearAllInvoices() { const db = await openDb(); return new Promise((resolve, reject) => { const t = db.transaction(INVOICE_STORE_NAME, 'readwrite'); t.objectStore(INVOICE_STORE_NAME).clear(); t.oncomplete = () => resolve(true); t.onerror = (e) => reject('Error clearing invoices: ' + e.target.error); }); }

    // Product DB functions
    async function addProduct(product) { const db = await openDb(); return new Promise((resolve, reject) => { const t = db.transaction(PRODUCT_STORE_NAME, 'readwrite'); t.objectStore(PRODUCT_STORE_NAME).add(product); t.oncomplete = () => resolve(true); t.onerror = (e) => reject('Error adding product: ' + e.target.error); }); }
    async function getAllProducts() { const db = await openDb(); return new Promise((resolve, reject) => { const r = db.transaction(PRODUCT_STORE_NAME, 'readonly').objectStore(PRODUCT_STORE_NAME).getAll(); r.onsuccess = () => resolve(r.result.sort((a, b) => a.name.localeCompare(b.name, 'bn'))); r.onerror = (e) => reject('Error getting products: ' + e.target.error); }); }
    async function updateProduct(product) { const db = await openDb(); return new Promise((resolve, reject) => { const t = db.transaction(PRODUCT_STORE_NAME, 'readwrite'); t.objectStore(PRODUCT_STORE_NAME).put(product); t.oncomplete = () => resolve(true); t.onerror = (e) => reject('Error updating product: ' + e.target.error); }); }
    async function deleteProduct(id) { const db = await openDb(); return new Promise((resolve, reject) => { const t = db.transaction(PRODUCT_STORE_NAME, 'readwrite'); t.objectStore(PRODUCT_STORE_NAME).delete(id); t.oncomplete = () => resolve(true); t.onerror = (e) => reject('Error deleting product: ' + e.target.error); }); }

async function checkAndClearOldInvoices() {
    const lastCheckMonth = localStorage.getItem('invoiceMonth');
    const currentMonth = new Date().getMonth().toString();

    // শুধুমাত্র নতুন মাস শুরু হলেই এই কোডটি রান হবে
    if (lastCheckMonth !== currentMonth) {
        console.log('New month detected. Checking for old invoices to clear...');
        const invoices = await getAllInvoices();
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonthIndex = now.getMonth(); // 0-11

        // আগের মাসের হিসাব
        const prevMonthIndex = currentMonthIndex === 0 ? 11 : currentMonthIndex - 1;
        const prevMonthYear = currentMonthIndex === 0 ? currentYear - 1 : currentYear;

        // বাংলা মাস এবং তাদের মাস সংখ্যার একটি তালিকা
        const bengaliMonths = {
            'জানুয়ারী': 0, 'ফেব্রুয়ারী': 1, 'মার্চ': 2, 'এপ্রিল': 3, 'মে': 4, 'জুন': 5,
            'জুলাই': 6, 'আগস্ট': 7, 'সেপ্টেম্বর': 8, 'অক্টোবর': 9, 'নভেম্বর': 10, 'ডিসেম্বর': 11
        };

        let deletedCount = 0;
        const promisesToDelete = [];

        // সব ইনভয়েজ চেক করা হবে
        for (const invoice of invoices) {
            try {
                const dateString = invoice.date;
                const parts = dateString.replace(/,/g, '').split(' ');
                if (parts.length < 3) continue; // ভুল ফরম্যাটের তারিখ উপেক্ষা করুন

                const day = parseInt(toEnglish(parts[0]));
                const month = bengaliMonths[parts[1]];
                const year = parseInt(toEnglish(parts[2]));

                if (isNaN(day) || month === undefined || isNaN(year)) {
                    console.warn(`Could not parse date: ${dateString}`);
                    continue; // যে তারিখ বোঝা যাবে না, সেটি উপেক্ষা করুন
                }

                // ইনভয়েজটি আগের মাসের কিনা এবং বকেয়া ঠিক শূন্য কিনা তা পরীক্ষা করা হচ্ছে
                if (year === prevMonthYear && month === prevMonthIndex && invoice.finalDue === 0) {
                    deletedCount++;
                    promisesToDelete.push(deleteInvoice(invoice.id));
                }
            } catch (e) {
                console.error(`Error processing invoice ID ${invoice.id}:`, e);
            }
        }

        // যোগ্য সব ইনভয়েজ মুছে ফেলা হচ্ছে
        await Promise.all(promisesToDelete);

        if (deletedCount > 0) {
            showCustomAlert(`নতুন মাস শুরু হওয়ায় আগের মাসের ${toBengali(deletedCount)}টি পরিশোধিত ইনভয়েস মুছে ফেলা হয়েছে।`);
            await renderInvoiceList(); // UI তে তালিকাটি রিফ্রেশ করা হচ্ছে
        } else {
            console.log('No paid invoices from the previous month found to delete.');
        }
        
        // বর্তমান মাস localStorage এ সেভ করা হচ্ছে
        localStorage.setItem('invoiceMonth', currentMonth);
    }
}

    // --- DOM Elements ---
    const invoiceContainer = document.getElementById('invoice-container');
    const logoUpload = document.getElementById('logo-upload');
    const invoiceLogo = document.getElementById('invoice-logo');
    const addItemBtn = document.getElementById('add-item-btn');
    const itemsTableBody = document.querySelector('#invoice-items-table tbody');
    const printInvoiceBtn = document.getElementById('print-invoice-btn');
    const saveToListBtn = document.getElementById('save-to-list-btn');
    const clearCurrentInvoiceBtn = document.getElementById('clear-current-invoice-btn');
    const savedInvoicesContainer = document.getElementById('saved-invoices-container');
    const savedInvoicesTable = document.getElementById('saved-invoices-table');
    const noInvoicesMessage = document.getElementById('no-invoices-message');
    const invoiceDateEl = document.getElementById('invoice-date');

    // --- Generic Confirmation Modal ---
    function showConfirmationModal(message, onConfirm) {
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1001; display: flex; align-items: center; justify-content: center;';
        
        const modal = document.createElement('div');
        modal.style.cssText = 'background: white; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-width: 350px;';
        
        if (document.documentElement.classList.contains('dark')) {
            modal.style.background = '#2d3748';
            modal.style.color = '#e2e8f0';
        }

        modal.innerHTML = `
            <p style="margin-bottom: 20px; font-size: 1.1rem;">${message}</p>
            <div style="display: flex; justify-content: space-around; gap: 10px;">
                <button id="confirmBtn" style="padding: 10px 20px; border: none; border-radius: 8px; background: #ef4444; color: white; cursor: pointer; flex: 1;">হ্যাঁ</button>
                <button id="cancelBtn" style="padding: 10px 20px; border: none; border-radius: 8px; background: #6c757d; color: white; cursor: pointer; flex: 1;">না</button>
            </div>
        `;
        
        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        const closeDialog = () => document.body.removeChild(overlay);

        modal.querySelector('#confirmBtn').onclick = () => { onConfirm(); closeDialog(); };
        modal.querySelector('#cancelBtn').onclick = closeDialog;
    }

    // --- Product Management UI ---
    let activeProductDropdown = null;

    function showProductModal(product = {}, onSave) {
        const isEdit = product.id !== undefined;
        const title = isEdit ? 'পণ্য আপডেট করুন' : 'নতুন পণ্য যুক্ত করুন';
        const confirmText = isEdit ? 'আপডেট' : 'সেভ';
        
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: flex; align-items: center; justify-content: center;';
        
        const modal = document.createElement('div');
        modal.style.cssText = 'background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px;';
        if (document.documentElement.classList.contains('dark')) {
            modal.style.background = '#2d3748';
            modal.style.color = '#e2e8f0';
        }
        modal.innerHTML = `
            <h3 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">${title}</h3>
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem;">পণ্যের নাম</label>
                <input id="productNameInput" type="text" value="${product.name || ''}" style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid #ccc;" class="dark:bg-gray-600 dark:border-gray-500">
            </div>
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem;">একক মূল্য</label>
                <input id="productPriceInput" type="text" value="${toBengali(product.price) || ''}" style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid #ccc;" inputmode="decimal" class="dark:bg-gray-600 dark:border-gray-500">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 0.75rem;">
                <button id="cancelProductBtn" style="padding: 0.5rem 1rem; border-radius: 6px; background: #6c757d; color: white; border: none; cursor: pointer;">বাতিল</button>
                <button id="saveProductBtn" style="padding: 0.5rem 1rem; border-radius: 6px; background: #28a745; color: white; border: none; cursor: pointer;">${confirmText}</button>
            </div>
        `;
        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        const nameInput = modal.querySelector('#productNameInput');
        const priceInput = modal.querySelector('#productPriceInput');
        nameInput.focus();
        priceInput.addEventListener('input', handleInvoiceNumberInput);
        
        const close = () => document.body.removeChild(overlay);
        modal.querySelector('#cancelProductBtn').onclick = close;
        modal.querySelector('#saveProductBtn').onclick = () => {
            const name = nameInput.value.trim();
            const price = parseFloat(toEnglish(priceInput.value)) || 0;
            if (!name) return showCustomAlert('পণ্যের নাম আবশ্যক।');
            onSave({ ...product, name, price });
            close();
        };
    }

    function closeProductDropdown() {
        if (activeProductDropdown) {
            activeProductDropdown.remove();
            activeProductDropdown = null;
        }
    }

    async function renderProductDropdown(targetInput) {
        closeProductDropdown();
        
        try {
            const products = await getAllProducts();
            const dropdown = document.createElement('div');
            dropdown.className = 'product-dropdown';
            
            const rect = targetInput.getBoundingClientRect();
            dropdown.style.left = `${rect.left}px`;
            dropdown.style.top = `${rect.bottom + window.scrollY}px`;
            dropdown.style.width = `${rect.width}px`;

            const addNew = document.createElement('div');
            addNew.className = 'product-dropdown-item add-new';
            addNew.textContent = '＋ নতুন পণ্য যুক্ত করুন';
            addNew.onclick = async () => {
                closeProductDropdown();
                showProductModal({}, async (newProduct) => {
                    await addProduct(newProduct);
                    targetInput.value = newProduct.name;
                    const priceInput = targetInput.closest('tr').querySelector('.item-price');
                    priceInput.value = toBengali(newProduct.price);
                    updateInvoiceTotals();
                    showCustomAlert('নতুন পণ্য যুক্ত হয়েছে।');
                });
            };
            dropdown.appendChild(addNew);

            products.forEach(p => {
                const item = document.createElement('div');
                item.className = 'product-dropdown-item';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = p.name;
                item.onclick = () => {
                    targetInput.value = p.name;
                    const row = targetInput.closest('tr');
                    row.querySelector('.item-price').value = toBengali(p.price);
                    row.querySelector('.item-qty').value = toBengali(1);
                    row.querySelector('.item-qty').focus();
                    updateInvoiceTotals();
                    closeProductDropdown();
                };

                const actions = document.createElement('div');
                actions.className = 'product-item-actions';
                actions.innerHTML = `
                    <svg class="edit-icon cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path></svg>
                    <svg class="delete-icon cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                `;
                
                actions.querySelector('.edit-icon').onclick = (e) => {
                    e.stopPropagation();
                    closeProductDropdown();
                    showProductModal(p, async (updatedProduct) => {
                        await updateProduct(updatedProduct);
                        showCustomAlert('পণ্য আপডেট হয়েছে।');
                    });
                };

                actions.querySelector('.delete-icon').onclick = (e) => {
                    e.stopPropagation();
                    closeProductDropdown();
                    showConfirmationModal(`আপনি কি "${p.name}" পণ্যটি মুছে ফেলতে চান?`, async () => {
                        try {
                           await deleteProduct(p.id);
                           showCustomAlert('পণ্য মুছে ফেলা হয়েছে।');
                        } catch(err) {
                           showCustomAlert('পণ্য মুছতে সমস্যা হয়েছে।');
                           console.error("Delete product error:", err);
                        }
                    });
                };

                item.appendChild(nameSpan);
                item.appendChild(actions);
                dropdown.appendChild(item);
            });
            
            document.body.appendChild(dropdown);
            activeProductDropdown = dropdown;
        } catch (error) {
            console.error("Failed to render product dropdown:", error);
            showCustomAlert("পণ্য তালিকা লোড করা যায়নি।");
        }
    }

    // --- Persistence Functions ---
    function saveCurrentInvoiceState() {
        const state = { logoSrc: invoiceLogo.src, fields: {}, items: [] };
        invoiceContainer.querySelectorAll('[contenteditable="true"], input:not([type="file"])').forEach(el => {
            if(el.id) {
                const value = el.matches('[contenteditable="true"]') ? el.innerHTML : el.value;
                state.fields[el.id] = toEnglish(value);
            }
        });
        itemsTableBody.querySelectorAll('tr').forEach(row => {
            state.items.push({
                name: row.querySelector('.item-name').value,
                qty: toEnglish(row.querySelector('.item-qty').value),
                price: toEnglish(row.querySelector('.item-price').value),
                discount: toEnglish(row.querySelector('.item-discount').value)
            });
        });
        localStorage.setItem('currentInvoiceState', JSON.stringify(state));
    }
    
    function loadCurrentInvoiceState() {
        const stateJSON = localStorage.getItem('currentInvoiceState');
        if (!stateJSON) {
            if (itemsTableBody.rows.length === 0) addNewItemRow();
            return;
        }

        const state = JSON.parse(stateJSON);
        if (state.logoSrc) invoiceLogo.src = state.logoSrc;

        for (const id in state.fields) {
            const el = document.getElementById(id);
            if (el) {
                if(el.matches('[contenteditable="true"]')) {
                    el.innerHTML = toBengali(state.fields[id]);
                } else {
                    el.value = toBengali(state.fields[id]);
                }
            }
        }
        
        itemsTableBody.innerHTML = '';
        if (state.items && state.items.length > 0) {
            state.items.forEach(item => addNewItemRow(item));
        } else {
            addNewItemRow();
        }
        updateInvoiceTotals();
    }
    
    function startNewInvoice() {
        showConfirmationModal('আপনি কি একটি নতুন ইনভয়েজ শুরু করতে চান? বর্তমান তথ্য মুছে যাবে।', () => {
            const invoiceNumberEl = document.getElementById('invoice-number');
            if (invoiceNumberEl) {
                const currentNumStr = toEnglish(invoiceNumberEl.textContent.trim());
                const currentNum = parseInt(currentNumStr, 10);
                if (!isNaN(currentNum)) {
                    const newNumStr = (currentNum + 1).toString().padStart(currentNumStr.length, '0');
                    invoiceNumberEl.textContent = toBengali(newNumStr);
                }
            }
            document.getElementById('customer-name').innerHTML = 'ক্রেতার নাম';
            document.getElementById('customer-address').innerHTML = 'ক্রেতার ঠিকানা';
			document.getElementById('invoice-comments').innerHTML = 'মন্তব্য:';
            document.getElementById('extra-discount').value = '';
            document.getElementById('prev-due').value = '';
            document.getElementById('paid-amount').value = '';
            setDate();
            itemsTableBody.innerHTML = '';
            addNewItemRow();
            updateInvoiceTotals(); 
            showCustomAlert('নতুন ইনভয়েজ শুরু হয়েছে।');
        });
    }
    
    function loadSelectedInvoice(invoiceState) {
        if (!invoiceState || !invoiceState.fullData) return showCustomAlert('ইনভয়েজ ডেটা লোড করা যায়নি।');

        const state = invoiceState.fullData;
        if (state.logoSrc) invoiceLogo.src = state.logoSrc;

        for (const id in state.fields) {
            const el = document.getElementById(id);
            if (el) {
                if (el.matches('[contenteditable="true"]')) {
                    // সংশোধন: এখানে toBengali() যুক্ত করা হয়েছে
                    el.innerHTML = toBengali(state.fields[id]);
                } else {
                    el.value = toBengali(state.fields[id]);
                }
            }
        }
        
        itemsTableBody.innerHTML = '';
        if (state.items && state.items.length > 0) {
            state.items.forEach(item => addNewItemRow(item));
        } else {
            addNewItemRow();
        }

        updateInvoiceTotals();
        showCustomAlert(`ইনভয়েজ #${toBengali(invoiceState.id)} (${invoiceState.customerName}) লোড করা হয়েছে।`);
        window.scrollTo(0, 0);
    }

    // --- Core Functions ---
        function setDate() {
        // পরিবর্তন: তারিখের ঘর খালি আছে কিনা, সেই শর্তটি তুলে দেওয়া হয়েছে।
        // এর ফলে, ফাংশনটি কল হলেই তারিখ আপডেট হবে।
        if (invoiceDateEl) {
            const today = new Date();
            invoiceDateEl.textContent = today.toLocaleDateString('bn-BD', { day: 'numeric', month: 'long', year: 'numeric' });
        }
    }
    
    function loadSelectedInvoice(invoiceState) {
        if (!invoiceState || !invoiceState.fullData) return showCustomAlert('ইনভয়েজ ডেটা লোড করা যায়নি।');

        const state = invoiceState.fullData;
        if (state.logoSrc) invoiceLogo.src = state.logoSrc;

        for (const id in state.fields) {
            const el = document.getElementById(id);
            if (el) {
                if (el.matches('[contenteditable="true"]')) {
                    // সংশোধন: এখানে toBengali() যুক্ত করা হয়েছে
                    el.innerHTML = toBengali(state.fields[id]);
                } else {
                    el.value = toBengali(state.fields[id]);
                }
            }
        }
        
        itemsTableBody.innerHTML = '';
        if (state.items && state.items.length > 0) {
            state.items.forEach(item => addNewItemRow(item));
        } else {
            addNewItemRow();
        }

        updateInvoiceTotals();
        showCustomAlert(`ইনভয়েজ #${toBengali(invoiceState.id)} (${invoiceState.customerName}) লোড করা হয়েছে।`);
        window.scrollTo(0, 0);
    }

    // --- Core Functions ---

    function addNewItemRow(item = { name: '', qty: '', price: '', discount: '' }) {
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td class="p-2 relative"><input type="text" placeholder="পণ্যের নাম" class="item-name w-full bg-gray-50 dark:bg-gray-700" value="${item.name}" autocomplete="off"></td>
            <td class="p-2"><input type="text" placeholder="০" class="item-qty w-full text-center bg-gray-50 dark:bg-gray-700" value="${toBengali(item.qty)}" inputmode="numeric"></td>
            <td class="p-2"><input type="text" placeholder="০.০০" class="item-price w-full text-right bg-gray-50 dark:bg-gray-700" value="${toBengali(item.price)}" inputmode="decimal"></td>
            <td class="p-2"><input type="text" placeholder="০.০০" class="item-discount w-full text-right bg-gray-50 dark:bg-gray-700" value="${toBengali(item.discount)}" inputmode="decimal"></td>
            <td class="p-2 text-right item-total">০.০০</td>
            <td class="p-2 text-center no-print">
                <svg class="delete-item-btn w-5 h-5 mx-auto text-red-500 hover:text-red-700 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </td>
        `;
        itemsTableBody.appendChild(newRow);
        newRow.querySelectorAll('.item-qty, .item-price, .item-discount').forEach(input => {
            input.addEventListener('input', handleInvoiceNumberInput);
        });
    }

    function updateInvoiceTotals() {
        let subtotal = 0;
        let totalItemDiscounts = 0;
        itemsTableBody.querySelectorAll('tr').forEach(row => {
            const qty = parseFloat(toEnglish(row.querySelector('.item-qty').value)) || 0;
            const price = parseFloat(toEnglish(row.querySelector('.item-price').value)) || 0;
            const discount = parseFloat(toEnglish(row.querySelector('.item-discount').value)) || 0;
            const grossTotal = qty * price;
            const netTotal = grossTotal - discount;
            row.querySelector('.item-total').textContent = toBengali(netTotal.toFixed(2));
            subtotal += grossTotal;
            totalItemDiscounts += discount;
        });
        const extraDiscount = parseFloat(toEnglish(document.getElementById('extra-discount').value)) || 0;
        const prevDue = parseFloat(toEnglish(document.getElementById('prev-due').value)) || 0;
        const paidAmount = parseFloat(toEnglish(document.getElementById('paid-amount').value)) || 0;
        const grandTotal = (subtotal - totalItemDiscounts - extraDiscount) + prevDue;
        const finalDue = grandTotal - paidAmount;
        document.getElementById('subtotal').textContent = toBengali(subtotal.toFixed(2));
        document.getElementById('item-discounts-total').textContent = `- ${toBengali(totalItemDiscounts.toFixed(2))}`;
        document.getElementById('grand-total').textContent = toBengali(grandTotal.toFixed(2));
        document.getElementById('final-due').textContent = toBengali(finalDue.toFixed(2));
        saveCurrentInvoiceState();
    }
	
	async function handleSaveToList() {
        try {
            const invoiceData = JSON.parse(localStorage.getItem('currentInvoiceState')) || {};
            const dataToSave = {
                date: document.getElementById('invoice-date').textContent,
                customerName: document.getElementById('customer-name').textContent,
                paidAmount: parseFloat(toEnglish(document.getElementById('paid-amount').value)) || 0,
                finalDue: parseFloat(toEnglish(document.getElementById('final-due').textContent)) || 0,
                fullData: invoiceData
            };
            await addInvoice(dataToSave);
            showCustomAlert('ইনভয়েজ সফলভাবে সেভ করা হয়েছে!');
            await renderInvoiceList();
        } catch(err) {
            showCustomAlert('ইনভয়েজ সেভ করতে সমস্যা হয়েছে।');
            console.error("Save invoice error:", err);
        }
	}

	async function renderInvoiceList() {
		try {
            const invoices = await getAllInvoices();
            const tableBody = savedInvoicesTable.querySelector('tbody');
            tableBody.innerHTML = '';
            if (invoices.length === 0) {
                savedInvoicesTable.classList.add('hidden');
                noInvoicesMessage.classList.remove('hidden');
            } else {
                noInvoicesMessage.classList.add('hidden');
                savedInvoicesTable.classList.remove('hidden');
                invoices.forEach(inv => {
                    const row = document.createElement('tr');
                    row.className = 'border-b dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-800';
                    row.innerHTML = `
                        <td class="p-2">${inv.date}</td>
                        <td class="p-2">${inv.customerName}</td>
                        <td class="p-2 text-right">${toBengali((inv.paidAmount || 0).toFixed(2))}</td>
                        <td class="p-2 text-right">${toBengali((inv.finalDue || 0).toFixed(2))}</td>
                        <td class="p-2 text-center">
                            <button class="load-saved-invoice-btn text-blue-500 hover:text-blue-700 mr-4 font-semibold" data-id="${inv.id}">লোড</button>
                            <button class="delete-saved-invoice-btn text-red-500 hover:text-red-700 font-semibold" data-id="${inv.id}">মুছুন</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        } catch(err) {
            console.error("Failed to render invoice list:", err);
            noInvoicesMessage.textContent = 'তালিকা লোড করা যায়নি।';
            noInvoicesMessage.classList.remove('hidden');
            savedInvoicesTable.classList.add('hidden');
        }
	}

    // --- Event Listeners ---
    logoUpload.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (event) => { invoiceLogo.src = event.target.result; saveCurrentInvoiceState(); }; reader.readAsDataURL(file); } });
    addItemBtn.addEventListener('click', () => { addNewItemRow(); saveCurrentInvoiceState(); });
    invoiceContainer.addEventListener('input', (e) => { if (e.target.closest('#invoice-items-table') || e.target.closest('.justify-end')) { updateInvoiceTotals(); } else { saveCurrentInvoiceState(); }});
    itemsTableBody.addEventListener('click', (e) => { if (e.target.closest('.delete-item-btn')) { if (itemsTableBody.rows.length > 1) { e.target.closest('tr').remove(); updateInvoiceTotals(); } else { showCustomAlert('শেষ আইটেমটি মোছা যাবে না।'); } } });
    printInvoiceBtn.addEventListener('click', () => window.print());
    saveToListBtn.addEventListener('click', handleSaveToList);
    clearCurrentInvoiceBtn.addEventListener('click', startNewInvoice);
    savedInvoicesContainer.addEventListener('click', async (e) => {
        const target = e.target;
        if (target.classList.contains('delete-saved-invoice-btn')) {
            const id = parseInt(target.dataset.id, 10);
            const invoiceToDelete = await getInvoiceById(id);
            const customerName = invoiceToDelete ? invoiceToDelete.customerName : `ইনভয়েজ #${toBengali(id)}`;
            showConfirmationModal(`আপনি কি "${customerName}" এর ইনভয়েজটি মুছে ফেলতে চান?`, async () => {
                await deleteInvoice(id);
                showCustomAlert('ইনভয়েজ মুছে ফেলা হয়েছে।');
                await renderInvoiceList();
            });
        } else if (target.classList.contains('load-saved-invoice-btn')) {
            const id = parseInt(target.dataset.id, 10);
            const invoiceToLoad = await getInvoiceById(id);
            if (invoiceToLoad) loadSelectedInvoice(invoiceToLoad);
            else showCustomAlert('ইনভয়েজটি খুঁজে পাওয়া যায়নি।');
        }
    });

    // --- New Event Listeners for Products ---
    itemsTableBody.addEventListener('focusin', (e) => {
        if (e.target.classList.contains('item-name')) {
            renderProductDropdown(e.target);
        }
    });
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.item-name') && !e.target.closest('.product-dropdown')) {
            closeProductDropdown();
        }
    });

    // --- Initialization ---
    async function init() {
        const style = document.createElement('style');
        style.textContent = `
            .product-dropdown { position: absolute; z-index: 100; background: #fff; border: 1px solid #d1d5db; border-radius: 0.375rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); max-height: 250px; overflow-y: auto; }
            .dark .product-dropdown { background: #374151; border-color: #4b5563; }
            .product-dropdown-item { padding: 0.5rem 0.75rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
            .product-dropdown-item:hover { background-color: #eff6ff; }
            .dark .product-dropdown-item:hover { background-color: #4b5563; }
            .product-dropdown-item.add-new { font-weight: 600; color: #2563eb; }
            .dark .product-dropdown-item.add-new { color: #60a5fa; }
            .product-item-actions { display: none; }
            .product-dropdown-item:hover .product-item-actions { display: flex; }
            .product-item-actions svg { width: 1rem; height: 1rem; margin-left: 0.5rem; color: #6b7280; }
            .dark .product-item-actions svg { color: #9ca3af; }
            .product-item-actions svg.edit-icon:hover { color: #3b82f6; }
            .product-item-actions svg.delete-icon:hover { color: #ef4444; }
        `;
        document.head.appendChild(style);

        await checkAndClearOldInvoices();
        setDate();
        loadCurrentInvoiceState();
        await renderInvoiceList();
        
        invoiceContainer.querySelectorAll('input[type="number"]').forEach(input => {
            input.type = 'text';
            input.inputMode = 'decimal';
            input.placeholder = toBengali(input.placeholder);
        });
        invoiceContainer.querySelectorAll('.item-qty, .item-price, .item-discount, #extra-discount, #prev-due, #paid-amount')
            .forEach(input => {
                input.addEventListener('input', handleInvoiceNumberInput);
            });
        console.log("Invoice tab with Product Management initialized successfully.");
    }
    
    init();
}

});
// ====================================================================
// END: INVOICE TAB SCRIPT
// ====================================================================

/* ==================================================================== */
/*  শুরু: নতুন "রঙ বাছাইকারী" ট্যাবের জন্য JavaScript ফাংশন */
/* ==================================================================== */

function initializeColorPicker() {
    const colorPickerInput = document.getElementById('colorPickerInput');
    const colorPreview = document.getElementById('colorPreview');
    const hexValueInput = document.getElementById('hexValue');
    const rgbValueInput = document.getElementById('rgbValue');
    const hslValueInput = document.getElementById('hslValue');
    const copyButtons = document.querySelectorAll('.copy-color-btn');

    if (!colorPickerInput) return;

    // --- Color Conversion Functions ---
    function hexToRgb(hex) {
        let r = 0, g = 0, b = 0;
        if (hex.length == 4) {
            r = "0x" + hex[1] + hex[1]; g = "0x" + hex[2] + hex[2]; b = "0x" + hex[3] + hex[3];
        } else if (hex.length == 7) {
            r = "0x" + hex[1] + hex[2]; g = "0x" + hex[3] + hex[4]; b = "0x" + hex[5] + hex[6];
        }
        return { r: +r, g: +g, b: +b };
    }

    function rgbToHsl(r, g, b) {
        r /= 255; g /= 255; b /= 255;
        let max = Math.max(r, g, b), min = Math.min(r, g, b);
        let h, s, l = (max + min) / 2;
        if (max == min) {
            h = s = 0;
        } else {
            let d = max - min;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            switch (max) {
                case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                case g: h = (b - r) / d + 2; break;
                case b: h = (r - g) / d + 4; break;
            }
            h /= 6;
        }
        return { h: Math.round(h * 360), s: Math.round(s * 100), l: Math.round(l * 100) };
    }
    
    function updateAllValues(source, value) {
        let hex = value;
        const rgb = hexToRgb(hex);
        const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);

        if(hex && rgb && hsl) {
            colorPickerInput.value = hex;
            hexValueInput.value = hex.toUpperCase();
            rgbValueInput.value = `${rgb.r}, ${rgb.g}, ${rgb.b}`;
            hslValueInput.value = `${hsl.h}, ${hsl.s}%, ${hsl.l}%`;
            colorPreview.style.backgroundColor = hex;
        }
    }

    // --- Event Listeners ---
    colorPickerInput.addEventListener('input', (e) => updateAllValues('picker', e.target.value));
    
    copyButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            const targetId = e.target.dataset.target;
            const inputToCopy = document.getElementById(targetId);
            if (inputToCopy && inputToCopy.value) {
                navigator.clipboard.writeText(inputToCopy.value).then(() => {
                    showCustomAlert(`${targetId.toUpperCase()} মান কপি করা হয়েছে!`);
                });
            }
        });
    });

    // Initial call
    updateAllValues('picker', colorPickerInput.value);
}

/* ==================================================================== */
/*  শেষ: নতুন "রঙ বাছাইকারী" ট্যাবের জন্য JavaScript ফাংশন */
/* ==================================================================== */


/* ======================================================== */
/* START: NEW SIDEBAR, DASHBOARD & INTERACTIVITY SCRIPT (UPDATED) */
/* ======================================================== */
document.addEventListener('DOMContentLoaded', () => {
    
    // --- Initialize all new features ---
    initializeSidebar();
    initializeDraggableDashboard();
    makeAllFeaturesInteractive();

    // --- Sidebar Functionality (Updated: Auto Scroll including Yellow Highlight) ---
    function initializeSidebar() {
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarCloseBtn = document.getElementById('sidebarClose'); // ক্লোজ বাটন
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const sidebarSearch = document.getElementById('sidebarSearch');
        const toolList = document.getElementById('sidebar-tool-list');

        if (!sidebar || !sidebarToggle || !sidebarOverlay || !sidebarSearch || !toolList || !sidebarCloseBtn) return;
        
        // মিডিয়া প্লেয়ার চালু আছে কিনা চেক করার ফাংশন
        const isMediaPlaying = () => {
            const audio = document.getElementById('audioPlayer');
            const video = document.getElementById('videoPlayer');
            const isAudioPlaying = audio && !audio.paused && !audio.ended && audio.currentTime > 0;
            const isVideoPlaying = video && !video.paused && !video.ended && video.currentTime > 0;
            return isAudioPlaying || isVideoPlaying;
        };

        // ওয়েব সার্চে অডিও/ভিডিও বাজছে কিনা চেক করার ফাংশন
        const isWebSearchPlaying = () => {
            try {
                const iframe = document.getElementById('browserFrame');
                if (iframe && iframe.contentDocument) {
                    const medias = iframe.contentDocument.querySelectorAll('audio, video');
                    for (let media of medias) {
                        if (!media.paused && !media.ended && media.currentTime > 0) return true;
                    }
                }
            } catch (e) {
                return false;
            }
            return false;
        };

        // সাইডবার হাইলাইট আপডেট করার ফাংশন
        const updateSidebarHighlights = () => {
            const links = toolList.querySelectorAll('a');
            
            let isAlarmActive = false;
            const stopAlarmBtn = document.getElementById('stopAlarmBtn');
            if (stopAlarmBtn && !stopAlarmBtn.classList.contains('hidden')) {
                isAlarmActive = true;
            }

            let isAnyMediaActive = false;

            links.forEach(a => {
                const targetTabId = a.dataset.tabId;
                const targetElement = document.getElementById(targetTabId);
                const isActive = targetElement && targetElement.classList.contains('active');

                if (!a.dataset.originalText) {
                    a.dataset.originalText = a.textContent;
                }
                const originalText = a.dataset.originalText;

                let newClass = "block w-full text-left p-2 rounded-lg transition-colors duration-200 flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-indigo-500"; // ফোকাস রিং যোগ করা হয়েছে
                let iconHtml = ""; 

                if (targetTabId === 'clockTab' && isAlarmActive) {
                    newClass += ' bg-yellow-400 text-black font-bold shadow-md animate-pulse';
                    iconHtml = '<span>🔔</span>';
                    isAnyMediaActive = true;
                }
                else if ((targetTabId === 'playerTab' && isMediaPlaying()) || 
                         (targetTabId === 'webSearchTab' && isWebSearchPlaying())) {
                    newClass += ' bg-yellow-400 text-black font-bold shadow-md';
                    iconHtml = `
                        <span class="playing-icon" title="মিডিয়া বাজছে">
                            <span class="bar"></span>
                            <span class="bar"></span>
                            <span class="bar"></span>
                        </span>`;
                    isAnyMediaActive = true;
                }
                else if (isActive) {
                    newClass += ' bg-indigo-600 text-white shadow-md font-semibold';
                } 
                else {
                    newClass += ' hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300';
                }

                if (a.className !== newClass) {
                    a.className = newClass;
                }
                
                const newInnerHtml = `<span>${originalText}</span>${iconHtml}`;
                if (a.innerHTML !== newInnerHtml) {
                    a.innerHTML = newInnerHtml;
                }
            });

            if (sidebarToggle) {
                const currentState = sidebarToggle.getAttribute('data-visualizer-active');
                const newState = isAnyMediaActive ? 'true' : 'false';

                if (currentState !== newState) {
                    if (isAnyMediaActive) {
                        sidebarToggle.innerHTML = `
                            <span class="playing-icon" style="margin:0; width: 24px; height: 24px; gap: 4px;">
                                <span class="bar" style="width: 3px; background-color: white;"></span>
                                <span class="bar" style="width: 3px; background-color: white; animation-delay: 0.2s;"></span>
                                <span class="bar" style="width: 3px; background-color: white; animation-delay: 0.4s;"></span>
                            </span>`;
                    } else {
                        sidebarToggle.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>`;
                    }
                    sidebarToggle.setAttribute('data-visualizer-active', newState);
                }
            }
        };

        const tabButtons = document.querySelectorAll('.tab-button');
        if (toolList.children.length === 0) { 
            tabButtons.forEach(button => {
                let buttonText = button.textContent.trim();
                if (button.id === 'moreMenuBtn') buttonText = 'আরও';
                if (button.id === 'settingsMenuBtn') buttonText = 'সেটিংস';

                if (button.id && buttonText) { 
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = "#";
                    a.textContent = buttonText;
                    
                    let targetTabId = button.id;
                    if (button.id === 'moreMenuBtn') targetTabId = 'allFeaturesTab'; 
                    else if (button.id === 'settingsMenuBtn') targetTabId = 'moreSettingsTab'; 
                    
                    a.dataset.tabId = targetTabId;
                    
                    // ফোকাস স্টাইল যোগ করা হয়েছে
                    a.className = "block w-full text-left p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 transition-colors duration-200 flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-indigo-500";

                    a.addEventListener('click', (e) => {
                        e.preventDefault();
                        const targetTab = document.getElementById(a.dataset.tabId);
                        if (targetTab) {
                            targetTab.click(); 
                        }
                        closeSidebar();
                    });
                    
                    // কিবোর্ড ইভেন্ট: এন্টার চাপলে ক্লিক হবে
                    a.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            a.click();
                        }
                    });

                    li.appendChild(a);
                    toolList.appendChild(li);
                }
            });
        }

        function closeSidebar() {
            document.body.classList.remove('sidebar-open');
            // সাইডবার বন্ধ হলে টগল বাটনে ফোকাস ফেরত দিন (অ্যাক্সেসিবিলিটির জন্য)
            if(sidebarToggle) sidebarToggle.focus();
        }

        // টগল বাটন ক্লিক - আপডেট করা হয়েছে
        sidebarToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            
            // সাইডবার খোলার আগে হাইলাইট আপডেট করুন
            if (!document.body.classList.contains('sidebar-open')) {
                updateSidebarHighlights();
            }
            document.body.classList.toggle('sidebar-open');
            
            // সাইডবার ওপেন হলে একটিভ ট্যাবে স্ক্রল করুন
            if (document.body.classList.contains('sidebar-open')) {
                setTimeout(() => {
                    // একটিভ লিংক খুঁজে বের করা (যেটিতে bg-indigo-600 অথবা bg-yellow-400 ক্লাস আছে)
                    const activeLink = toolList.querySelector('a.bg-indigo-600, a.bg-yellow-400');
                    if (activeLink) {
                        activeLink.scrollIntoView({ block: 'center', behavior: 'smooth' });
                    }
                }, 300); // ট্রানজিশন শেষ হওয়ার জন্য সময় দেওয়া হলো
            }
        });
        
        sidebarCloseBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            closeSidebar();
        });

        sidebarOverlay.addEventListener('click', closeSidebar);

        // --- সাইডবার কিবোর্ড নেভিগেশন ---
        
        // ১. সাইডবার ওপেন অবস্থায় ডাউন অ্যারো চাপলে সার্চে ফোকাস
        document.addEventListener('keydown', (e) => {
            if (document.body.classList.contains('sidebar-open')) {
                const active = document.activeElement;
                // যদি ফোকাস বর্তমানে সাইডবারের কোনো উপাদানে না থাকে
                const isFocusInSidebar = sidebar.contains(active);
                
                if (!isFocusInSidebar && e.key === 'ArrowDown') {
                    e.preventDefault();
                    sidebarSearch.focus();
                }
            }
        });

        // ২. সার্চ বক্সে ফোকাস থাকা অবস্থায় কিবোর্ড নেভিগেশন
        sidebarSearch.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                // সার্চ বক্স থেকে নিচের অ্যারো চাপলে প্রথম টুলে ফোকাস যাবে
                const visibleLinks = Array.from(toolList.querySelectorAll('li:not([style*="display: none"]) a'));
                if (visibleLinks.length > 0) {
                    visibleLinks[0].focus();
                }
            }
        });

        // ৩. লিস্ট আইটেমে ফোকাস থাকা অবস্থায় কিবোর্ড নেভিগেশন
        toolList.addEventListener('keydown', (e) => {
            const visibleLinks = Array.from(toolList.querySelectorAll('li:not([style*="display: none"]) a'));
            const currentIndex = visibleLinks.indexOf(document.activeElement);

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                const nextIndex = currentIndex + 1;
                if (nextIndex < visibleLinks.length) {
                    visibleLinks[nextIndex].focus();
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                const prevIndex = currentIndex - 1;
                if (prevIndex >= 0) {
                    visibleLinks[prevIndex].focus();
                } else {
                    // তালিকার শুরুতে থাকলে এবং আপ অ্যারো চাপলে সার্চ বক্সে ফিরে যান
                    sidebarSearch.focus();
                }
            }
        });

        // সার্চ ফাংশনালিটি
        sidebarSearch.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const toolSynonyms = {
                'imageResizerTab': ['picture', 'photo', 'crop', 'resize', 'jpg', 'png', 'image editor', 'রিসাইজ', 'ছবি'],
                'basicCalcTab': ['math', 'calculation', 'add', 'subtract', 'হিসাব', 'গণনা', 'যোগ', 'ক্যালকুলেটর'],
                'scientificCalcTab': ['science', 'math', 'complex', 'cos', 'sin', 'বিজ্ঞান'],
                'notepadTab': ['write', 'todo', 'list', 'text', 'save', 'নোট', 'লিখুন', 'খাতা'],
                'weatherTab': ['temperature', 'rain', 'sun', 'forecast', 'আবহাওয়া', 'তাপমাত্রা', 'বৃষ্টি'],
                'translatorTab': ['language', 'english', 'bengali', 'translate', 'অনুবাদ', 'ভাষা'],
                'converterTab': ['bijoy', 'avro', 'unicode', 'font', 'writing', 'বিজয়', 'অভ্র', 'কনভার্ট'],
                'ageCalcTab': ['birthday', 'years', 'old', 'জন্মদিন', 'বয়স'],
                'dateCalcTab': ['calendar', 'time', 'day', 'তারিখ', 'সময়'],
                'qrCodeTab': ['scan', 'generate', 'code', 'কিউআর', 'কোড'],
                'prayerTimeTab': ['salah', 'namaz', 'azan', 'time', 'নামাজ', 'আজান', 'সূচি'],
                'textAssistantTab': ['ai', 'chat', 'gemini', 'gpt', 'help', 'এআই', 'চ্যাট', 'বট'],
                'colorPickerTab': ['hex', 'rgb', 'palette', 'রঙ', 'কালার'],
                'speedTestTab': ['internet', 'wifi', 'data', 'mbps', 'নেট', 'স্পিড', 'গতি'],
                'screenRecorderTab': ['video', 'capture', 'record', 'রেকর্ড', 'স্ক্রিন'],
                'memeGenTab': ['funny', 'troll', 'caption', 'মিম', 'জোকস'],
                'pdfToolsTab': ['document', 'convert', 'merge', 'পিডিএফ', 'ফাইল'],
                'sttTab': ['voice', 'speech', 'record', 'কথা', 'ভয়েস'],
                'ttsTab': ['listen', 'read', 'speech', 'শোনা', 'পাঠ'],
                'mapTab': ['location', 'gps', 'navigation', 'মানচিত্র', 'ম্যাপ'],
                'currencyTab': ['money', 'dollar', 'taka', 'exchange', 'মুদ্রা', 'টাকা'],
                'emiCalcTab': ['loan', 'interest', 'bank', 'ঋণ', 'কিস্তি'],
                'healthLifestyleTab': ['bmi', 'water', 'health', 'শরীর', 'স্বাস্থ্য'],
                'zakatCalcTab': ['islam', 'donation', 'charity', 'যাকাত', 'দান'],
                'unitPriceTab': ['compare', 'price', 'shop', 'বাজার', 'দাম'],
                'barcodeGenTab': ['product', 'scan', 'বারকোড'],
                'randomPickerTab': ['lottery', 'winner', 'draw', 'লটারি', 'ভাগ্য'],
                'jsonFormatterTab': ['code', 'developer', 'debug', 'জেসন'],
                'diffCheckerTab': ['compare text', 'code compare', 'পার্থক্য'],
                'expenseTrackerTab': ['cost', 'budget', 'income', 'খরচ', 'হিসাব'],
                'tasbeehTab': ['zikr', 'count', 'pray', 'তাসবিহ', 'জিকির'],
                'historyTab': ['today', 'past', 'event', 'ইতিহাস'],
                'holidayListTab': ['vacation', 'off day', 'calendar', 'ছুটি']
            };

            toolList.querySelectorAll('li').forEach(li => {
                const link = li.querySelector('a');
                const toolName = li.textContent.toLowerCase();
                const tabId = link ? link.dataset.tabId : '';
                const synonyms = toolSynonyms[tabId] || [];
                const hasSynonymMatch = synonyms.some(s => s.toLowerCase().includes(searchTerm));

                if (toolName.includes(searchTerm) || hasSynonymMatch) {
                    li.style.display = 'block';
                } else {
                    li.style.display = 'none';
                }
            });
        });

        if (window.sidebarHighlightInterval) clearInterval(window.sidebarHighlightInterval);
        window.sidebarHighlightInterval = setInterval(updateSidebarHighlights, 500);
        updateSidebarHighlights();
    }

    // --- Draggable Dashboard Functionality ---
    function initializeDraggableDashboard() {
        const dashboardGrid = document.getElementById('dashboard-grid');
        const allTabs = document.querySelectorAll('.tab-button');
        const DOCK_KEY = 'dashboardItems_v2'; 

        if (!dashboardGrid) return;
        
        let draggedTabId = null; 
        let draggingCard = null; 
        
        allTabs.forEach(tab => {
            const buttonText = tab.textContent.trim();
            if (tab.id && buttonText && tab.id !== 'dashboardTab') { 
                tab.setAttribute('draggable', 'true');
                tab.addEventListener('dragstart', (e) => {
                    draggedTabId = e.target.id;
                    draggingCard = null; 
                    e.target.classList.add('dragging');
                });
                tab.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                });
            } else {
                tab.setAttribute('draggable', 'false');
            }
        });

        dashboardGrid.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (!draggingCard) { 
                 dashboardGrid.classList.add('drag-over');
            } else { 
                const afterElement = getDragAfterElement(dashboardGrid, e.clientX);
                let shouldMove = true;
                if (afterElement === null) {
                    if (draggingCard === dashboardGrid.lastElementChild) shouldMove = false;
                } else {
                    if (draggingCard === afterElement.previousElementSibling) shouldMove = false;
                }

                if (shouldMove) {
                    if (afterElement == null) dashboardGrid.appendChild(draggingCard);
                    else dashboardGrid.insertBefore(draggingCard, afterElement);
                }
            }
        });

        dashboardGrid.addEventListener('dragleave', () => dashboardGrid.classList.remove('drag-over'));
        
        dashboardGrid.addEventListener('drop', (e) => {
            e.preventDefault();
            dashboardGrid.classList.remove('drag-over');
            if (draggedTabId) {
                addToDashboard(draggedTabId);
                draggedTabId = null;
            }
        });

        function addToDashboard(tabId) {
            const tabButton = document.getElementById(tabId);
            if (!tabButton) return;
            
            const savedItems = getDashboardItems();
            if (savedItems.includes(tabId)) {
                showCustomAlert('এই টুলটি ইতোমধ্যে ড্যাশবোর্ডে আছে।');
                return;
            }

            let buttonText = tabButton.firstChild.nodeType === 3 ? tabButton.firstChild.textContent.trim() : tabButton.textContent.trim();
            if (tabId === 'moreMenuBtn') buttonText = 'আরও';
            if (tabId === 'settingsMenuBtn') buttonText = 'সেটিংস';

            createDashboardCard(tabId, buttonText);
            tabButton.style.setProperty('display', 'none', 'important'); 

            savedItems.push(tabId);
            saveDashboardItems(savedItems);
        }
        
        function createDashboardCard(tabId, text) {
             const card = document.createElement('div');
            card.className = 'dashboard-card';
            card.textContent = text;
            card.dataset.tabId = tabId;
            card.setAttribute('draggable', 'true');

            card.addEventListener('dragstart', (e) => {
                e.stopPropagation();
                draggingCard = card;
                draggedTabId = null; 
                setTimeout(() => card.classList.add('dragging'), 0);
            });

            card.addEventListener('dragend', () => {
                card.classList.remove('dragging');
                draggingCard = null;
                saveDashboardOrder(); 
            });

            card.addEventListener('click', () => {
                if (tabId === 'moreMenuBtn') {
                    const allFeaturesTab = document.getElementById('allFeaturesTab');
                    if(allFeaturesTab) allFeaturesTab.click();
                } else if (tabId === 'settingsMenuBtn') {
                    const moreSettingsTab = document.getElementById('moreSettingsTab');
                    if(moreSettingsTab) moreSettingsTab.click();
                } else {
                    const tabToClick = document.getElementById(tabId);
                    if (tabToClick) tabToClick.click();
                }
            });

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-from-dashboard';
            removeBtn.innerHTML = '&times;';
            removeBtn.title = 'ড্যাশবোর্ড থেকে সরান';
            removeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                removeFromDashboard(tabId);
            });

            card.appendChild(removeBtn);
            dashboardGrid.appendChild(card);
        }

        function removeFromDashboard(tabId) {
            const cardToRemove = dashboardGrid.querySelector(`.dashboard-card[data-tab-id="${tabId}"]`);
            if (cardToRemove) cardToRemove.remove();

            const originalButton = document.getElementById(tabId);
            if (originalButton) originalButton.style.display = ''; 

            let savedItems = getDashboardItems();
            savedItems = savedItems.filter(id => id !== tabId);
            saveDashboardItems(savedItems);
        }
        
        function saveDashboardOrder() {
            const orderedIds = [...dashboardGrid.querySelectorAll('.dashboard-card')].map(card => card.dataset.tabId);
            saveDashboardItems(orderedIds);
        }

        function getDragAfterElement(container, x) {
            const draggableElements = [...container.querySelectorAll('.dashboard-card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function saveDashboardItems(items) {
            localStorage.setItem(DOCK_KEY, JSON.stringify(items));
        }
        function getDashboardItems() {
            return JSON.parse(localStorage.getItem(DOCK_KEY) || '[]');
        }
        
        function loadDashboard() {
            const items = getDashboardItems();
            dashboardGrid.innerHTML = ''; 
            items.forEach(tabId => {
                const tabButton = document.getElementById(tabId);
                if (tabButton) {
                    let buttonText = tabButton.firstChild.nodeType === 3 ? tabButton.firstChild.textContent.trim() : tabButton.textContent.trim();
                    if (tabId === 'moreMenuBtn') buttonText = 'আরও';
                    if (tabId === 'settingsMenuBtn') buttonText = 'সেটিংস';

                    createDashboardCard(tabId, buttonText);
                    tabButton.style.setProperty('display', 'none', 'important');
                }
            });
        }
        
        loadDashboard();
        
        const dashboardTab = document.getElementById('dashboardTab');
        if (dashboardTab) {
            dashboardTab.addEventListener('click', () => showTab('dashboard'));
        }
    }
    
    // --- "All Features" Tab Interactivity ---
    function makeAllFeaturesInteractive() {
        const featuresList = document.querySelector('#featuresDisplayArea ul');
        if (!featuresList) return;

        const featureToTabIdMap = {
            'সাধারণ ও সাইন্টিফিক ক্যালকুলেটর': 'basicCalcTab',
            'বয়স ও তারিখ ক্যালকুলেটর': 'ageCalcTab',
            'পরিমাপ (ইউনিট কনভার্টার)': 'measurementTab',
            'স্বাস্থ্য ও জীবনধারা': 'healthLifestyleTab',
            'টাইপিং টেস্ট': 'typingTestTab',
            'ফন্ট কনভার্টার': 'converterTab',
            'ওয়ার্ড কাউন্টার': 'wordCounterTab',
            'ট্রান্সলেটর (জেমিনি)': 'translatorTab',
            'বানান সংশোধন': 'spellCheckTab',
            'ডিজিটাল তাসবিহ': 'tasbeehTab',
            'লেখা সাজানো': 'textBeautifierTab',
            'শব্দের অর্থ': 'wordMeaningTab',
            'স্পিচ টুলস': 'sttTab',
            'টেক্সট এনক্রিপশন': 'textEncryptionTab',
            'লেখা সম্পর্কিত টুলস (জেমিনি)': 'textAssistantTab',
            'টেক্সট টু স্পিচ': 'ttsTab',
            'স্পিচ টু টেক্সট (জেমিনি)': 'sttTab',
            'ছবি থেকে লেখা (OCR - জেমিনি)': 'imageToTextTab',
            'ছবি রিসাইজার': 'imageResizerTab',
            'টেক্সট অ্যাসিস্ট্যান্ট (জেমিনি)': 'textAssistantTab',
            'ওয়েব সার্চ': 'webSearchTab',
            'গুগল ম্যাপ': 'mapTab',
            'আবহাওয়া': 'weatherTab',
            'নামাজের সময়সূচি': 'prayerTimeTab',
            'দিবসসমূহ': 'daysObservancesTab',
            'ছুটির তালিকা': 'holidayListTab',
            'যাকাত ক্যালকুলেটর': 'zakatCalcTab',
            'কিউআর কোড': 'qrCodeTab',
            'রঙ বাছাইকারী': 'colorPickerTab',
            'জরুরি নম্বর': 'emergencyNumbersTab',
            'ইনভয়েজ': 'invoiceTab',
            'ঘড়ি': 'clockTab',
            'প্লেয়ার': 'playerTab',
            'নোটপ্যাড / টু-ডু লিস্ট': 'notepadTab',
            'কুইজ (জেমিনি)': 'quizTab',
            'ডোনেট': 'donateTab',
            'ডেভেলোপার প্রোফাইল': 'importantLinksTab',
            'মুদ্রা রূপান্তরকারী': 'currencyTab',
            'দামের তুলনা': 'unitPriceTab',
            'ইএমআই ক্যালকুলেটর': 'emiCalcTab',
            'আইপি ও ডিভাইস ইনফো': 'ipInfoTab',
            'রেসিপি জেনারেটর (জেমিনি)': 'recipeTab',
            'পিডিএফ টুলস': 'pdfToolsTab',
            'স্ক্রিন রেকর্ডার': 'screenRecorderTab',
            'জেসন ফর্মাটার': 'jsonFormatterTab',
            'মিম জেনারেটর': 'memeGenTab',
            'ইন্টারনেট স্পিড': 'speedTestTab',
            'বারকোড জেনারেটর': 'barcodeGenTab',
            'র‍্যান্ডম পিকার / লটারি': 'randomPickerTab',
            'সকল ফিচার': 'allFeaturesTab',
            'আরও': 'allFeaturesTab',
            'সেটিংস': 'moreSettingsTab',
            'আরও সেটিংস': 'moreSettingsTab',
			'ডিফ চেকার (Diff)': 'diffCheckerTab',
			'আয়-ব্যয় হিসাব':'expenseTrackerTab',
			'অন্যান্য সুবিধাসমূহ': 'sidebarToggle',
            'ভয়েস কমান্ড': 'voiceCommandBtn',
            'সাইডবার মেনু': 'sidebarToggle',
            'অ্যাপ ইন্সটল (PWA)': 'pwaInstallBtn',
            'ডার্ক ও লাইট মোড': 'theme-toggle',
            'এপিআই কী': 'setApiKeyBtn'
        };

        featuresList.querySelectorAll('li > strong').forEach(strongEl => {
            const featureName = strongEl.textContent.trim().replace(/:$/, '').trim();
            const tabId = featureToTabIdMap[featureName];

            if (tabId) {
                strongEl.style.cursor = 'pointer';
                strongEl.style.textDecoration = 'underline';
                strongEl.title = `"${featureName}" ট্যাবে যান`;
                strongEl.addEventListener('click', () => {
                    const tabButton = document.getElementById(tabId);
                    if (tabButton) {
                        const dropdown = tabButton.closest('.absolute'); 
                        if (dropdown && dropdown.classList.contains('hidden')) {
                            let dropdownToggleButton;
                            if (dropdown.id === 'moreMenuDropdown') dropdownToggleButton = document.getElementById('moreMenuBtn');
                            else if (dropdown.id === 'settingsMenuDropdown') dropdownToggleButton = document.getElementById('settingsMenuBtn');

                            if (dropdownToggleButton) {
                                dropdown.classList.remove('hidden');
                                tabButton.click();
                            } else {
                                 tabButton.click(); 
                            }
                        } else {
                            tabButton.click(); 
                        }
                    } else {
                        showCustomAlert(`"${featureName}" ট্যাব (${tabId}) খুঁজে পাওয়া যায়নি।`);
                    }
                });
            }
        });
    }
});
/* ======================================================== */
/* END: NEW SIDEBAR, DASHBOARD & INTERACTIVITY SCRIPT (UPDATED) */
/* ======================================================== */

// ========================================================
// START: Image Resizer Script (ছবি রিসাইজার) - পরিবর্তিত ও সংশোধিত
// ========================================================
function initializeImageResizer() {
    const dropZone = document.getElementById('image-drop-zone');
    const imageInput = document.getElementById('imageUploadInput');
    const widthInput = document.getElementById('widthInput');
    const heightInput = document.getElementById('heightInput');
    const aspectRatioLock = document.getElementById('aspectRatioLock');
    
    // --- START: নতুন পরিবর্তন ---
    // ব্যবহারকারীর অনুরোধ অনুযায়ী: "অনুপাত ঠিক রাখুন" ডিফল্টভাবে আনচেক থাকবে
    if (aspectRatioLock) {
        aspectRatioLock.checked = false; 
    }
    // --- END: নতুন পরিবর্তন ---

    const qualitySlider = document.getElementById('qualitySlider');
    const qualityValue = document.getElementById('qualityValue');
    const formatSelect = document.getElementById('formatSelect');
    const downloadBtn = document.getElementById('downloadBtn');

    const originalPreviewContainer = document.getElementById('originalPreviewContainer');
    const originalPreview = document.getElementById('originalPreview');
    const removeOriginalBtn = document.getElementById('removeOriginalBtn');

    const processedPreview = document.getElementById('processedPreview');
    const originalSize = document.getElementById('originalSize');
    const originalDimensions = document.getElementById('originalDimensions');
    const processedSize = document.getElementById('processedSize');
    const processedDimensions = document.getElementById('processedDimensions');

    // নতুন: ক্রপ করার জন্য ভ্যারিয়েবল
    const cropToggleBtn = document.getElementById('cropToggleBtn');
    let cropper = null;

    // নতুন: অ্যাডজাস্টমেন্টের জন্য ভ্যারিয়েবল
    const rotateLeftBtn = document.getElementById('rotateLeftBtn');
    const rotateRightBtn = document.getElementById('rotateRightBtn');
    const flipHorizontalBtn = document.getElementById('flipHorizontalBtn');
    const flipVerticalBtn = document.getElementById('flipVerticalBtn');
    const brightnessSlider = document.getElementById('brightnessSlider');
    const brightnessValue = document.getElementById('brightnessValue');
    const contrastSlider = document.getElementById('contrastSlider');
    const contrastValue = document.getElementById('contrastValue');
    
    // নতুন: ফ্লিপ করার জন্য ভ্যারিয়েবল
    let scaleX = 1;
    let scaleY = 1;

    let originalImage = null;
    let originalAspectRatio = 1;
    let isProcessing = false;
    let currentProcessedObjectURL = null;

    // Undo/Redo history
    let imageHistory = [];
    let historyIndex = -1;
    let undoCropBtn, redoCropBtn;

    // Create and insert Undo/Redo buttons dynamically
    const controlsContainer = document.querySelector('.image-resizer-controls');
    if (controlsContainer && !document.getElementById('undoRedoSection')) {
        const undoRedoSection = document.createElement('div');
        undoRedoSection.id = 'undoRedoSection';
        undoRedoSection.className = 'control-section mt-0'; // Add mt-0 as it's the first item
        undoRedoSection.innerHTML = `
            <h4 class="control-title">ইতিহাস (History)</h4>
            <div class="flex gap-4">
                <button id="undoCropBtn" class="w-full p-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-4.5-.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5z"/></svg>
                    <span>আনডু</span>
                </button>
                <button id="redoCropBtn" class="w-full p-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0M4.5 7.5a.5.5 0 0 1 0-1h5.793L7.854 4.146a.5.5 0 1 1 .708-.708l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708-.708L10.293 8.5z"/></svg>
                    <span>রিডু</span>
                </button>
            </div>
        `;

        // --- START: সংশোধিত কোড ---
        // কন্ট্রোল গ্রিডের তিনটি কলাম খুঁজুন
        const gridColumns = controlsContainer.querySelectorAll('.grid > div.flex');
        
        if (gridColumns.length === 3) {
            // তৃতীয় কলামটি (History & Actions) সিলেক্ট করুন
            const column3 = gridColumns[2];
            // কলামের শুরুতে History সেকশনটি যোগ করুন
            column3.prepend(undoRedoSection);
        } else {
            // ফলব্যাক: যদি লেআউটটি প্রত্যাশিত না হয়, তবে পুরানো পদ্ধতিতে যোগ করার চেষ্টা করুন
            const cropSection = cropToggleBtn.parentElement;
            if (cropSection) {
                cropSection.parentElement.insertBefore(undoRedoSection, cropSection);
            } else {
                controlsContainer.appendChild(undoRedoSection); // Last resort
            }
        }
        // --- END: সংশোধিত কোড ---
    }
    
    undoCropBtn = document.getElementById('undoCropBtn');
    redoCropBtn = document.getElementById('redoCropBtn');
    
    if(undoCropBtn) undoCropBtn.addEventListener('click', undoAction);
    if(redoCropBtn) redoCropBtn.addEventListener('click', redoAction);


    // Enter কী-এর জন্য ইভেন্ট লিসেনার শুধুমাত্র একবার যুক্ত করার জন্য ফ্ল্যাগ
    if (!window.imageResizerKeyListenerAdded) {
        document.addEventListener('keydown', (e) => {
            const imageResizerContent = document.getElementById('imageResizerContent');
            if (imageResizerContent && imageResizerContent.classList.contains('active') && e.key === 'Enter') {
                if (cropper) {
                    e.preventDefault();
                    downloadBtn.click();
                }
            }
        });
        window.imageResizerKeyListenerAdded = true;
    }

    function pushToHistory(dataUrl) {
        if (historyIndex < imageHistory.length - 1) {
            imageHistory = imageHistory.slice(0, historyIndex + 1);
        }
        imageHistory.push(dataUrl);
        historyIndex++;
        updateUndoRedoButtons();
    }

    function updateUndoRedoButtons() {
        if(undoCropBtn) undoCropBtn.disabled = historyIndex <= 0;
        if(redoCropBtn) redoCropBtn.disabled = historyIndex >= imageHistory.length - 1;
    }

    function loadImageFromDataURL(dataUrl, isHistoryNavigation = false) {
        // নতুন: ছবি লোড করার আগে যেকোনো চলমান ক্রপার থাকলে তা বন্ধ করুন
        if (cropper) {
            cropper.destroy();
            cropper = null;
            cropToggleBtn.classList.remove('active');
            cropToggleBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6.13 1L6 16a2 2 0 0 0 2 2h15"></path><path d="M1 6.13L16 6a2 2 0 0 1 2 2v15"></path></svg>
                <span>ক্রপ মোড</span>
            `;
            if(downloadBtn) downloadBtn.querySelector('span').textContent = 'ডাউনলোড করুন';
        }

        originalImage = new Image();
        originalImage.onload = () => {
            originalAspectRatio = originalImage.width / originalImage.height;
            
            // --- START: স্ট্রেচ বাগ ফিক্স (সংশোধিত) ---
            // ছবি লোড হওয়ার পর ইনপুট বক্স সবসময় আপডেট করুন
            if (widthInput) widthInput.value = originalImage.width;
            if (heightInput) heightInput.value = originalImage.height;
            // --- END: স্ট্রেচ বাগ ফিক্স (সংশোধিত) ---

            if(originalPreview) originalPreview.src = dataUrl;
            if(originalDimensions) originalDimensions.textContent = `${originalImage.width} x ${originalImage.height} px`;

            const sizeInBytes = (dataUrl.length * (3/4)) - (dataUrl.endsWith('==') ? 2 : (dataUrl.endsWith('=') ? 1 : 0));
            if(originalSize) originalSize.textContent = formatBytes(sizeInBytes);

            if (!isHistoryNavigation) {
                 let fileType = 'image/jpeg';
                 if (dataUrl.startsWith('data:image/png')) fileType = 'image/png';
                 if (dataUrl.startsWith('data:image/webp')) fileType = 'image/webp';
                 if(formatSelect) formatSelect.value = fileType;

                 // নতুন ছবি লোড হলে স্লাইডার রিসেট করুন
                 if(brightnessSlider) brightnessSlider.value = 100;
                 if(brightnessValue) brightnessValue.textContent = 100;
                 if(contrastSlider) contrastSlider.value = 100;
                 if(contrastValue) contrastValue.textContent = 100;
            }

            if(qualitySlider) qualitySlider.disabled = formatSelect.value === 'image/png';
            if (originalPreviewContainer) originalPreviewContainer.classList.add('has-image');
            if (cropToggleBtn) cropToggleBtn.disabled = false;
            
            // নতুন: ফ্লিপ ভ্যারিয়েবল রিসেট করুন
            scaleX = 1;
            scaleY = 1;
            
            processImage();
        };
        originalImage.src = dataUrl;
    }

    function handleFile(file) {
        if (!file || !file.type.startsWith('image/')) {
            showCustomAlert('অনুগ্রহ করে একটি ছবি ফাইল নির্বাচন করুন।');
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            imageHistory = [];
            historyIndex = -1;
            pushToHistory(e.target.result);
            loadImageFromDataURL(e.target.result, false);
            
            // নতুন: কন্ট্রোলগুলো সক্রিয় করুন
            if(rotateLeftBtn) rotateLeftBtn.disabled = false;
            if(rotateRightBtn) rotateRightBtn.disabled = false;
            if(flipHorizontalBtn) flipHorizontalBtn.disabled = false;
            if(flipVerticalBtn) flipVerticalBtn.disabled = false;
            if(brightnessSlider) brightnessSlider.disabled = false;
            if(contrastSlider) contrastSlider.disabled = false;
        };
        reader.onerror = () => {
            showCustomAlert('ফাইলটি পড়া সম্ভব হয়নি।');
            clearOriginalImage();
        };
        reader.readAsDataURL(file);
    }
    
    function undoAction() {
        if (historyIndex > 0) {
            historyIndex--;
            loadImageFromDataURL(imageHistory[historyIndex], true);
            updateUndoRedoButtons();
            showCustomAlert("আনডু করা হয়েছে।");
        }
    }

    function redoAction() {
        if (historyIndex < imageHistory.length - 1) {
            historyIndex++;
            loadImageFromDataURL(imageHistory[historyIndex], true);
            updateUndoRedoButtons();
            showCustomAlert("রিডু করা হয়েছে।");
        }
    }


    function toggleCropMode() {
        if (!originalImage) return;

        if (cropper) {
            cropper.destroy();
            cropper = null;
            cropToggleBtn.classList.remove('active');
            cropToggleBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6.13 1L6 16a2 2 0 0 0 2 2h15"></path><path d="M1 6.13L16 6a2 2 0 0 1 2 2v15"></path></svg>
                <span>ক্রপ মোড</span>
            `;
            if(downloadBtn) downloadBtn.querySelector('span').textContent = 'ডাউনলোড করুন';
            
            // ক্রপ মোড বন্ধ করার পর অরিজিনাল ডাইমেনশন ফিরিয়ে আনা
            widthInput.value = originalImage.width;
            heightInput.value = originalImage.height;
            processImage();
        } else {
            // *** পরিবর্তিত: ক্রপ মোড চালু করার সময় ইনপুট ভ্যালু চেক করা ***
            let initWidth = parseInt(widthInput.value);
            let initHeight = parseInt(heightInput.value);
            // যদি ইনপুট ভ্যালু না থাকে বা অবৈধ হয়, তবে আসল ছবির সাইজ ব্যবহার করুন
            if (isNaN(initWidth)) initWidth = originalImage.width;
            if (isNaN(initHeight)) initHeight = originalImage.height;

            cropper = new Cropper(originalPreview, {
                viewMode: 1,
                autoCropArea: 1, // ডিফল্ট সিলেকশন পুরো ছবি জুড়ে
                background: false,
                scaleX: scaleX,
                scaleY: scaleY,
                ready() {
                    // ক্রপার রেডি হলে ইনপুটের ডাইমেনশন সেট করুন
                    // this.cropper.setData({ width: initWidth, height: initHeight });
                },
                crop(event) {
                    // *** ফিক্স: ইনপুট বক্স আর অটো আপডেট হবে না। ***
                    // ব্যবহারকারী ক্রপ বক্স ড্রাগ করলে ইনপুটের মান পরিবর্তন হবে না।
                    // ফলে ইনপুটের মানই হবে ফাইনাল আউটপুট সাইজ।
                    // const data = event.detail;
                    // widthInput.value = Math.round(data.width);
                    // heightInput.value = Math.round(data.height);
                },
            });
            
            // *** নতুন: অনুপাত ঠিক রাখুন অপশন অনুযায়ী অ্যাসপেক্ট রেশিও সেট করুন ***
            if (aspectRatioLock.checked) {
                // ইনপুট অনুযায়ী অনুপাত সেট করা হবে
                if (initWidth && initHeight) {
                    cropper.setAspectRatio(initWidth / initHeight);
                } else {
                    cropper.setAspectRatio(originalAspectRatio);
                }
            } else {
                cropper.setAspectRatio(NaN);
            }

            cropToggleBtn.classList.add('active');
            cropToggleBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></svg>
                <span>ক্রপ বন্ধ করুন</span>
            `;
            if(downloadBtn) downloadBtn.querySelector('span').textContent = 'ক্রপ করুন';
        }
    }

    async function processImage() {
        if (!originalImage || isProcessing) return;
        isProcessing = true;
        if(downloadBtn) downloadBtn.disabled = true;
        if(processedSize) processedSize.textContent = 'প্রসেসিং...';
        if(processedDimensions) processedDimensions.textContent = 'প্রসেসিং...';

        const width = parseInt(widthInput.value);
        const height = parseInt(heightInput.value);
        const quality = parseInt(qualitySlider.value) / 100;
        const format = formatSelect.value;
        
        // নতুন: অ্যাডজাস্টমেন্ট ভ্যালু
        const brightness = brightnessSlider.value;
        const contrast = contrastSlider.value;

        if (isNaN(width) || isNaN(height) || width <= 0 || height <= 0) {
            showCustomAlert('অনুগ্রহ করে সঠিক প্রস্থ এবং উচ্চতা দিন।');
            if(processedSize) processedSize.textContent = 'ত্রুটি';
            if(processedDimensions) processedDimensions.textContent = 'অবৈধ মাপ';
            if (!currentProcessedObjectURL) {
                if(processedPreview) processedPreview.src = 'https://placehold.co/400x300/fee2e2/b91c1c?text=Invalid+Dimensions';
            }
            isProcessing = false;
            return;
        }
        
        setTimeout(async () => {
            try {
                let sourceCanvas;
                if (cropper) {
                    // ক্রপ করার সময় রোটেট এবং ফ্লিপ হ্যান্ডেল করার জন্য getCroppedCanvas ব্যবহার করুন
                    sourceCanvas = cropper.getCroppedCanvas();
                } else {
                    // ক্রপ না করলে, ম্যানুয়ালি ক্যানভাস তৈরি করুন
                    sourceCanvas = document.createElement('canvas');
                    sourceCanvas.width = originalImage.width;
                    sourceCanvas.height = originalImage.height;
                    const tempCtx = sourceCanvas.getContext('2d');
                    tempCtx.drawImage(originalImage, 0, 0);
                }

                const finalCanvas = document.createElement('canvas');
                finalCanvas.width = width;
                finalCanvas.height = height;
                const ctx = finalCanvas.getContext('2d');
                
                // নতুন: ফিল্টার প্রয়োগ
                ctx.filter = `brightness(${brightness}%) contrast(${contrast}%)`;
                
                ctx.drawImage(sourceCanvas, 0, 0, width, height);
                
                // ফিল্টার রিসেট করুন
                ctx.filter = 'none';

                finalCanvas.toBlob((blob) => {
                    if (blob) {
                        if (currentProcessedObjectURL) URL.revokeObjectURL(currentProcessedObjectURL);
                        currentProcessedObjectURL = URL.createObjectURL(blob);
                        if(processedPreview) processedPreview.src = currentProcessedObjectURL;
                        if(processedDimensions) processedDimensions.textContent = `${width} x ${height} px`;
                        if(processedSize) processedSize.textContent = formatBytes(blob.size);
                        if(downloadBtn) downloadBtn.disabled = false;
                    } else {
                         throw new Error("Blob could not be created.");
                    }
                    isProcessing = false;
                }, format, quality);

            } catch (error) {
                console.error("Image processing error:", error);
                showCustomAlert("ছবি প্রসেস করা সম্ভব হয়নি।");
                if(processedSize) processedSize.textContent = 'ত্রুটি';
                if(processedDimensions) processedDimensions.textContent = 'প্রসেসিং ত্রুটি';
                isProcessing = false;
            }
        }, 10);
    }

    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    function clearOriginalImage() {
        if (cropper) {
            cropper.destroy();
            cropper = null;
            cropToggleBtn.classList.remove('active');
            cropToggleBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6.13 1L6 16a2 2 0 0 0 2 2h15"></path><path d="M1 6.13L16 6a2 2 0 0 1 2 2v15"></path></svg>
                <span>ক্রপ মোড</span>
            `;
            if(downloadBtn) downloadBtn.querySelector('span').textContent = 'ডাউনলোড করুন';
        }
        if (cropToggleBtn) cropToggleBtn.disabled = true;
        originalImage = null;
        originalAspectRatio = 1;
        if(originalPreview) originalPreview.src = 'https://placehold.co/400x300/e0e7ff/3f51b5?text=Original+Image';
        if(originalSize) originalSize.textContent = 'N/A';
        if(originalDimensions) originalDimensions.textContent = 'N/A';
        if(widthInput) widthInput.value = '';
        if(heightInput) heightInput.value = '';
        if(imageInput) imageInput.value = '';
        if (originalPreviewContainer) originalPreviewContainer.classList.remove('has-image');
        clearProcessedImage();
        
        // Clear history
        imageHistory = [];
        historyIndex = -1;
        updateUndoRedoButtons();
        
        // নতুন: কন্ট্রোলগুলো রিসেট এবং নিষ্ক্রিয় করুন
        if(rotateLeftBtn) rotateLeftBtn.disabled = true;
        if(rotateRightBtn) rotateRightBtn.disabled = true;
        if(flipHorizontalBtn) flipHorizontalBtn.disabled = true;
        if(flipVerticalBtn) flipVerticalBtn.disabled = true;
        if(brightnessSlider) brightnessSlider.disabled = true;
        if(contrastSlider) contrastSlider.disabled = true;
        if(brightnessSlider) brightnessSlider.value = 100;
        if(contrastSlider) contrastSlider.value = 100;
        if(brightnessValue) brightnessValue.textContent = 100;
        if(contrastValue) contrastValue.textContent = 100;
        scaleX = 1;
        scaleY = 1;
    }

    function clearProcessedImage() {
        if (currentProcessedObjectURL) {
            URL.revokeObjectURL(currentProcessedObjectURL);
            currentProcessedObjectURL = null;
        }
        if(processedPreview) processedPreview.src = 'https://placehold.co/400x300/dcfce7/166534?text=Processed+Image';
        if(processedSize) processedSize.textContent = 'N/A';
        if(processedDimensions) processedDimensions.textContent = 'N/A';
        if(downloadBtn) downloadBtn.disabled = true;
    }

    if (dropZone) {
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); handleFile(e.dataTransfer.files[0]); });
    }

    if (imageInput) imageInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
    if (cropToggleBtn) cropToggleBtn.addEventListener('click', toggleCropMode);

    if (originalPreviewContainer && removeOriginalBtn) {
        removeOriginalBtn.style.opacity = '0';
        removeOriginalBtn.style.pointerEvents = 'none';
        originalPreviewContainer.addEventListener('mouseenter', () => { if (originalPreviewContainer.classList.contains('has-image')) { removeOriginalBtn.style.opacity = '1'; removeOriginalBtn.style.pointerEvents = 'auto'; } });
        originalPreviewContainer.addEventListener('mouseleave', () => { removeOriginalBtn.style.opacity = '0'; removeOriginalBtn.style.pointerEvents = 'none'; });
        removeOriginalBtn.addEventListener('click', (e) => { e.stopPropagation(); clearOriginalImage(); showCustomAlert("আসল ছবি মুছে ফেলা হয়েছে।"); });
    }

    let debounceTimer;
    const debouncedProcess = () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(processImage, 300); };

    if (widthInput) {
        widthInput.addEventListener('input', () => {
            // *** সংশোধিত: ক্রপ মোডেও ইনপুট নিলে আপডেট হবে ***
            if (cropper) {
                const val = parseInt(widthInput.value);
                if (!isNaN(val)) {
                    // ক্রপ বক্সের সাইজ আপডেট করুন
                    // let data = cropper.getData();
                    // data.width = val;
                    // cropper.setData(data);
                    
                    // যদি অনুপাত লক করা থাকে, তবে নতুন অনুপাত সেট করুন (যাতে ড্রাগ করলেও ঠিক থাকে)
                    if (aspectRatioLock.checked && heightInput.value) {
                        cropper.setAspectRatio(val / parseInt(heightInput.value));
                    }
                }
            } else {
                if (aspectRatioLock.checked && originalImage) {
                    const newWidth = parseInt(widthInput.value);
                    if (!isNaN(newWidth) && newWidth > 0) heightInput.value = Math.round(newWidth / originalAspectRatio) || 1;
                }
            }
            debouncedProcess();
        });
    }

    if (heightInput) {
        heightInput.addEventListener('input', () => {
            // *** সংশোধিত: ক্রপ মোডেও ইনপুট নিলে আপডেট হবে ***
            if (cropper) {
                const val = parseInt(heightInput.value);
                if (!isNaN(val)) {
                    // ক্রপ বক্সের সাইজ আপডেট করুন
                    // let data = cropper.getData();
                    // data.height = val;
                    // cropper.setData(data);
                    
                    // যদি অনুপাত লক করা থাকে, তবে নতুন অনুপাত সেট করুন
                    if (aspectRatioLock.checked && widthInput.value) {
                        cropper.setAspectRatio(parseInt(widthInput.value) / val);
                    }
                }
            } else {
                if (aspectRatioLock.checked && originalImage) {
                    const newHeight = parseInt(heightInput.value);
                    if (!isNaN(newHeight) && newHeight > 0) widthInput.value = Math.round(newHeight * originalAspectRatio) || 1;
                }
            }
            debouncedProcess();
        });
    }
    
    if (aspectRatioLock) {
        aspectRatioLock.addEventListener('change', () => {
            // *** সংশোধিত: লক চেক করার সাথে সাথে বর্তমান ইনপুট ভ্যালু দিয়ে অনুপাত ফিক্স করা ***
            if (cropper) {
                if (aspectRatioLock.checked) {
                    const w = parseInt(widthInput.value);
                    const h = parseInt(heightInput.value);
                    if (w && h) {
                        cropper.setAspectRatio(w / h);
                    } else {
                        // ভ্যালু না থাকলে ইমেজের রেশিও নিন
                        cropper.setAspectRatio(originalAspectRatio);
                    }
                } else {
                    cropper.setAspectRatio(NaN); // ফ্রি মোড
                }
            } else {
                // ক্রপার ছাড়া সাধারণ মোডে রেশিও আপডেট লজিক
                if (aspectRatioLock.checked && originalImage && widthInput.value) {
                    const newWidth = parseInt(widthInput.value);
                    if (!isNaN(newWidth) && newWidth > 0) {
                        heightInput.value = Math.round(newWidth / originalAspectRatio) || 1;
                        debouncedProcess();
                    }
                }
            }
        });
    }

    if (qualitySlider) {
        qualitySlider.addEventListener('input', () => { qualityValue.textContent = qualitySlider.value; debouncedProcess(); });
    }

    if (formatSelect) {
        formatSelect.addEventListener('change', () => { qualitySlider.disabled = formatSelect.value === 'image/png'; processImage(); });
    }
    
    // --- নতুন: অ্যাডজাস্টমেন্ট ইভেন্ট লিসেনার ---
    
    // Cropper.js দিয়ে রোটেট করা
    if (rotateLeftBtn) {
        rotateLeftBtn.addEventListener('click', () => {
            if (cropper) {
                cropper.rotate(-90);
                // processImage(); // ক্রপার থাকলে অটো-প্রসেস করার দরকার নেই, ডাউনলোড বাটনে ক্লিক করলেই হবে
            } else {
                showCustomAlert('রোটেট করার জন্য অনুগ্রহ করে প্রথমে "ক্রপ মোড" চালু করুন।');
            }
        });
    }
    
    if (rotateRightBtn) {
        rotateRightBtn.addEventListener('click', () => {
            if (cropper) {
                cropper.rotate(90);
                // processImage();
            } else {
                showCustomAlert('রোটেট করার জন্য অনুগ্রহ করে প্রথমে "ক্রপ মোড" চালু করুন।');
            }
        });
    }

    // Cropper.js দিয়ে ফ্লিপ করা
    if (flipHorizontalBtn) {
        flipHorizontalBtn.addEventListener('click', () => {
            if (cropper) {
                scaleX = scaleX * -1; // টগল করুন
                cropper.scaleX(scaleX);
                // processImage(); 
            } else {
                showCustomAlert('ফ্লিপ করার জন্য অনুগ্রহ করে প্রথমে "ক্রপ মোড" চালু করুন।');
            }
        });
    }

    if (flipVerticalBtn) {
        flipVerticalBtn.addEventListener('click', () => {
            if (cropper) {
                scaleY = scaleY * -1; // টগল করুন
                cropper.scaleY(scaleY);
                // processImage();
            } else {
                showCustomAlert('ফ্লিপ করার জন্য অনুগ্রহ করে প্রথমে "ক্রপ মোড" চালু করুন।');
            }
        });
    }

    // ব্রাইটনেস এবং কনট্রাস্ট স্লাইডার
    if (brightnessSlider) {
        brightnessSlider.addEventListener('input', () => {
            if(brightnessValue) brightnessValue.textContent = brightnessSlider.value;
            debouncedProcess();
        });
    }
    
    if (contrastSlider) {
        contrastSlider.addEventListener('input', () => {
            if(contrastValue) contrastValue.textContent = contrastSlider.value;
            debouncedProcess();
        });
    }

    if (downloadBtn) {
        downloadBtn.addEventListener('click', async () => {
            if (cropper) {
                // ক্রপ মোডে থাকলে, প্রথমে ক্রপ করা ছবিটি পান
                // *** ফিক্স: এখানে ইনপুটের ভ্যালু অনুযায়ী ফাইনাল সাইজ সেট করা হচ্ছে ***
                const finalWidth = parseInt(widthInput.value) || 0;
                const finalHeight = parseInt(heightInput.value) || 0;

                const cropOptions = {};
                // যদি ভ্যালু থাকে তবে সেই সাইজে রিসাইজ করে ক্যানভাস নেওয়া হবে
                if (finalWidth > 0 && finalHeight > 0) {
                    cropOptions.width = finalWidth;
                    cropOptions.height = finalHeight;
                }

                const croppedCanvas = cropper.getCroppedCanvas(cropOptions);
                
                const newImageDataUrl = croppedCanvas.toDataURL(formatSelect.value, parseInt(qualitySlider.value) / 100);
                
                // ক্রপ করা ছবিটিকে নতুন 'originalImage' হিসেবে সেট করুন
                pushToHistory(newImageDataUrl); 
                toggleCropMode(); // ক্রপ মোড বন্ধ করুন
                
                // এই কলটি প্রথমবার (স্ট্রেচড) ছবিটি লোড করবে
                loadImageFromDataURL(newImageDataUrl, true); 
                
                // --- START: ব্যবহারকারীর পরামর্শ অনুযায়ী স্ট্রেচ বাগ ফিক্স করার হ্যাক ---
                // প্রথম প্রসেসিং শেষ হওয়ার জন্য সামান্য অপেক্ষা করুন
                setTimeout(() => {
                    const currentQuality = parseInt(qualitySlider.value);
                    // কোয়ালিটি সামান্য পরিবর্তন করুন
                    const tempQuality = (currentQuality > 1) ? currentQuality - 1 : currentQuality + 1;
                    
                    // স্লাইডার সরানোর ভান করুন (১ম বার)
                    qualitySlider.value = tempQuality;
                    if(qualityValue) qualityValue.textContent = tempQuality;
                    debouncedProcess(); // এটি দ্বিতীয়বার প্রসেস ট্রিগার করবে

                    // স্লাইডার আগের জায়গায় ফিরিয়ে আনার ভান করুন (২য় বার)
                    setTimeout(() => {
                        qualitySlider.value = currentQuality;
                        if(qualityValue) qualityValue.textContent = currentQuality;
                        debouncedProcess(); // এটি চূড়ান্ত সঠিক প্রসেস ট্রিগার করবে
                    }, 350); // প্রথম ডিবাউন্স ফায়ার করার জন্য অপেক্ষা
                    
                }, 150); // onload এবং প্রথম processImage কল হওয়ার জন্য অপেক্ষা
                // --- END: ব্যবহারকারীর পরামর্শ অনুযায়ী স্ট্রেচ বাগ ফিক্স করার হ্যাক ---

                showCustomAlert('ছবি ক্রপ করা হয়েছে! অ্যাডজাস্টমেন্ট প্রয়োগ করা হয়েছে।');
            } else {
                // ক্রপ মোডে না থাকলে, সরাসরি প্রসেস ও ডাউনলোড করুন
                await processImage(); // নিশ্চিত করুন যে শেষ পরিবর্তনগুলো প্রসেস হয়েছে
                setTimeout(() => {
                     if (!currentProcessedObjectURL) {
                        showCustomAlert("ডাউনলোড করার জন্য কোনো প্রসেস করা ছবি নেই।");
                        return;
                    }
                    const link = document.createElement('a');
                    link.href = currentProcessedObjectURL;
                    const format = formatSelect.value.split('/')[1];
                    const originalFileName = imageInput.files[0]?.name.split('.')[0] || 'resized-image';
                    link.download = `${originalFileName}-adjusted.${format}`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }, 200);
            }
        });
    }
    
    // Initial UI state
    updateUndoRedoButtons();
}
// ========================================================
// END: Image Resizer Script
// ========================================================

// ====================================================================
// START: LIVE CRICKET TICKER SCRIPT (UPDATED & REFINED)
// ====================================================================

// গ্লোবাল ভেরিয়েবল (স্কোর ট্র্যাকিংয়ের জন্য)
let cricketTickerInterval = null;
let lastCricketState = {
    runs: -1,
    wickets: -1,
    totalBalls: -1,
    teamName: "",
    isInitialized: false
};
let recentBallHistory = []; 
let isWaitingForNextOver = true; // শুরুতে অপেক্ষা করুন দেখানোর জন্য ফ্ল্যাগ

function initCricketTicker() {
    const tickerContainer = document.getElementById('cricket-ticker-container');
    const ctTeam1Name = document.getElementById('ctTeam1Name');
    const ctTeam1Score = document.getElementById('ctTeam1Score');
    const ctTeam2Name = document.getElementById('ctTeam2Name');
    const ctTeam2Score = document.getElementById('ctTeam2Score');
    const ctMatchStatus = document.getElementById('ctMatchStatus');
    const ctLastOver = document.getElementById('ctLastOver');
    const closeTickerBtn = document.getElementById('closeTickerBtn');

    if (!tickerContainer) return;

    // বর্ণমালা ফন্ট এবং স্টাইল সেট করা
    if (ctLastOver) {
        ctLastOver.style.fontFamily = "'Bornomala', sans-serif";
        ctLastOver.style.minWidth = "80px"; // কমানো হয়েছে কারণ টেক্সট নেই
    }
    if (ctMatchStatus) ctMatchStatus.style.fontFamily = "'Bornomala', sans-serif";

    // --- লজিক পরিবর্তন শুরু ---
    // ১. প্রথমে ব্যবহারকারীর সেভ করা লিংক চেক করা হবে
    let savedUrl = localStorage.getItem('crexMatchUrl');

    // ২. যদি ব্যবহারকারী লিংক না দেয়, তবে ডেভেলপারের লিংক চেক করা হবে
    if (!savedUrl || savedUrl.trim() === '') {
        if (typeof DEVELOPER_CRICKET_URL !== 'undefined' && DEVELOPER_CRICKET_URL.trim() !== '') {
            savedUrl = DEVELOPER_CRICKET_URL;
        }
    }
    // --- লজিক পরিবর্তন শেষ ---

    // ১. লিংক না থাকলে সেকশনটি হাইড করুন
    if (!savedUrl || savedUrl.trim() === '') {
        tickerContainer.classList.add('hidden');
        tickerContainer.style.display = 'none';
        if (cricketTickerInterval) clearInterval(cricketTickerInterval);
        return;
    }

    // ২. লিংক থাকলে সেকশন দেখান
    tickerContainer.classList.remove('hidden');
    tickerContainer.style.display = 'flex';
    
    // বাকি কোড অপরিবর্তিত থাকবে...
    // লোডিং বা প্রাথমিক অবস্থা (প্রথমবার)
    if (!lastCricketState.isInitialized) {
        ctMatchStatus.innerText = ""; // লাইভ লেখা সরানো হয়েছে
        updateBallsUI(true); 
    }

    // প্রথমবার ডেটা ফেচ
    fetchTickerData(savedUrl);

    // অটো আপডেট (৫ সেকেন্ড পর পর)
    if (cricketTickerInterval) clearInterval(cricketTickerInterval);
    cricketTickerInterval = setInterval(() => fetchTickerData(savedUrl), 5000);

    // টিকারের ক্রস বাটনের লজিক
    if (closeTickerBtn) {
        closeTickerBtn.onclick = (e) => {
            e.stopPropagation();
            // ক্রস বাটনে ক্লিক করলে ইউজারের লোকাল স্টোরেজ ক্লিয়ার হবে
            // কিন্তু ডেভেলপার লিংক কোডে থাকলে পেজ রিফ্রেশ দিলে আবার চলে আসবে (এটাই স্বাভাবিক আচরণ হওয়া উচিত)
            localStorage.removeItem('crexMatchUrl');
            
            // যদি ডেভেলপার লিংক থাকে, তবে সাময়িকভাবে হাইড করা হবে
            tickerContainer.classList.add('hidden');
            tickerContainer.style.display = 'none';
            if (cricketTickerInterval) clearInterval(cricketTickerInterval);
            
            const cricketUrlInput = document.getElementById('cricketUrlInput');
            if (cricketUrlInput) cricketUrlInput.value = '';
            
            showCustomAlert('টিকার বন্ধ করা হয়েছে।');
        };
    }

    async function fetchTickerData(url) {
        try {
            const proxyUrl = `https://news.banglatoolbox.workers.dev/?url=${encodeURIComponent(url)}`;
            const response = await fetch(proxyUrl);
            if (!response.ok) throw new Error("Network response was not ok");
            const htmlText = await response.text();
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, "text/html");

            let team1 = "T1", team2 = "T2";
            let score1 = "", score2 = "";
            let status = "";
            let isLive = false;
            let foundData = false;

            const pageTitle = doc.querySelector('title')?.innerText || "";
            const metaDesc = doc.querySelector('meta[name="description"]')?.content || "";
            
            // টাইটেল থেকে ডেটা বের করা (আপডেটেড লজিক)
            const vsMatch = pageTitle.match(/\s(vs|v)\s/i);
            if (vsMatch) {
                const separator = vsMatch[0];
                const parts = pageTitle.split(separator);
                const leftPart = parts[0].trim();
                
                let rightPart = parts[1];
                const suffixMatch = rightPart.match(/\s*(\||Live|Scorecard)/i);
                if (suffixMatch) {
                    rightPart = rightPart.substring(0, suffixMatch.index).trim();
                }

                // স্কোর পার্সিং লজিক (উন্নত: ৩ অক্ষরের নাম ও স্কোর ফরম্যাট)
                const extractScore = (text) => {
                    // নাম এবং স্কোর আলাদা করা: "BHU-W 126/4 (20)" -> Name: BHU-W, Score: 126/4 (20)
                    // নামের শেষের স্পেস বাদে বাকিটুকু স্কোর হিসেবে ধরা হবে
                    const lastSpaceIndex = text.search(/\s\d/); // যেখানে স্কোরের সংখ্যা শুরু হয়
                    
                    if (lastSpaceIndex !== -1) {
                        const rawName = text.substring(0, lastSpaceIndex).trim();
                        // স্কোর ফরম্যাট ঠিক রাখা (ওভার সহ)
                        const rawScore = text.substring(lastSpaceIndex).trim(); 
                        return { 
                            // নাম থেকে প্রথম ৩ অক্ষর নেওয়া (হাইফেন থাকলে তা বাদ দিয়ে বা প্রথম অংশ নিয়ে)
                            name: rawName.split(/[\s-]/)[0].substring(0, 3).toUpperCase(), 
                            score: rawScore 
                        };
                    }
                    // যদি স্কোর না থাকে, শুধু নাম
                    return { 
                        name: text.split(/[\s-]/)[0].substring(0, 3).toUpperCase(), 
                        score: "" 
                    };
                };

                const t1Data = extractScore(leftPart);
                team1 = t1Data.name;
                score1 = t1Data.score;

                const t2Data = extractScore(rightPart);
                team2 = t2Data.name;
                score2 = t2Data.score;
                
                foundData = true;
            }

            // স্ট্যাটাস চেক
            if (pageTitle.toLowerCase().includes('live') || metaDesc.toLowerCase().includes('live score')) {
                status = ""; // লাইভ লেখা সরিয়ে ফেলা হলো
                isLive = true;
            } else if (pageTitle.toLowerCase().includes('won') || metaDesc.toLowerCase().includes('won')) {
                const resultMatch = metaDesc.match(/([A-Za-z\s]+) won by .*/);
                status = resultMatch ? resultMatch[0] : "ম্যাচ সমাপ্ত";
                isLive = false;
            } else {
                status = "অপেক্ষমান";
            }

            // UI আপডেট
            if (foundData) {
                ctTeam1Name.innerText = team1;
                ctTeam2Name.innerText = team2;
                ctTeam1Score.innerText = score1;
                ctTeam2Score.innerText = score2;
                
                if (isLive) {
                    ctMatchStatus.innerHTML = ""; // মাঝখানের স্ট্যাটাস খালি রাখা হলো
                    
                    // বর্তমান ব্যাটিং স্কোর থেকে রান ও বল বের করা
                    let currentBattingString = score1.includes('(') ? score1 : (score2.includes('(') ? score2 : "");
                    // যদি কোনো টিমের স্কোর ব্র্যাকেট না থাকে, তবে শেষ আপডেট হওয়া স্কোর চেক করুন
                    if (!currentBattingString) {
                         if (score2) currentBattingString = score2; 
                         else if (score1) currentBattingString = score1;
                    }

                    if(currentBattingString) {
                        calculateRecentBalls(team1, score1, team2, score2, currentBattingString);
                    }
                } else {
                    ctMatchStatus.innerText = status; // রেজাল্ট বা অন্যান্য স্ট্যাটাস দেখাবে
                    ctMatchStatus.classList.remove('text-red-500', 'font-bold');
                    ctMatchStatus.classList.add('text-yellow-400');
                    ctLastOver.classList.add('hidden');
                }
            } else {
                ctMatchStatus.innerText = "লিংক চেক করুন";
            }
        } catch (e) {
            console.error("Ticker fetch error", e);
            ctMatchStatus.innerText = "";
        }
    }

    // বল-বাই-বল ক্যালকুলেশন লজিক
    function calculateRecentBalls(team1, score1, team2, score2, battingStr) {
        // রিজেক্স আপডেট: 126/4 (19.2) ফরম্যাট হ্যান্ডেল করার জন্য
        const match = battingStr.match(/(\d+)[\/-](\d+)\s*\((\d+)\.(\d+)\)/) || battingStr.match(/(\d+)[\/-](\d+)\s*\((\d+)\)/);
        
        let currentRuns = 0;
        let currentWickets = 0;
        let currentOvers = 0;
        let currentBallInOver = 0;
        
        if (match) {
            currentRuns = parseInt(match[1]) || 0;
            currentWickets = parseInt(match[2]) || 0;
            currentOvers = parseInt(match[3]) || 0;
            currentBallInOver = parseInt(match[4]) || 0; 
        }
        
        const currentTotalBalls = (currentOvers * 6) + currentBallInOver;
        let currentBattingTeam = score1.includes('(') ? team1 : team2;

        // নতুন ইনিংস চেক
        if (currentBattingTeam !== lastCricketState.teamName) {
            lastCricketState = {
                runs: currentRuns,
                wickets: currentWickets,
                totalBalls: currentTotalBalls,
                teamName: currentBattingTeam,
                isInitialized: true
            };
            recentBallHistory = [];
            isWaitingForNextOver = true; 
            updateBallsUI(true);
            return;
        }

        // প্রথমবার লোড
        if (!lastCricketState.isInitialized) {
            lastCricketState = {
                runs: currentRuns,
                wickets: currentWickets,
                totalBalls: currentTotalBalls,
                teamName: currentBattingTeam,
                isInitialized: true
            };
            isWaitingForNextOver = true; 
            updateBallsUI(true);
            return;
        }

        // পার্থক্য বের করা
        const deltaRuns = currentRuns - lastCricketState.runs;
        const deltaWickets = currentWickets - lastCricketState.wickets;
        const deltaBalls = currentTotalBalls - lastCricketState.totalBalls;

        // নতুন বল বা রান আপডেট হয়েছে কিনা চেক
        if (deltaBalls > 0 || deltaRuns > 0 || deltaWickets > 0) {
            
            if (isWaitingForNextOver) {
                recentBallHistory = [];
                isWaitingForNextOver = false;
            }

            let ballResult = "";

            if (deltaBalls > 0) {
                if (deltaWickets > 0) {
                    ballResult = "W";
                } else {
                    ballResult = deltaRuns.toString();
                }
                recentBallHistory.push(ballResult);
            } 
            else if (deltaRuns > 0 && deltaBalls === 0) {
                ballResult = "Ex" + deltaRuns; 
                recentBallHistory.push(ballResult);
            }

            // আপডেট স্টেট সংরক্ষণ
            lastCricketState.runs = currentRuns;
            lastCricketState.wickets = currentWickets;
            lastCricketState.totalBalls = currentTotalBalls;
            
            updateBallsUI(false);
            
            // ওভার শেষ হলে
            if (currentTotalBalls > 0 && currentTotalBalls % 6 === 0) {
                isWaitingForNextOver = true; 
                setTimeout(() => {
                    if (isWaitingForNextOver) updateBallsUI(true);
                }, 3000);
            }
        } else {
            if (isWaitingForNextOver) {
                updateBallsUI(true);
            }
        }
    }

    function updateBallsUI(showWaiting) {
        if (!ctLastOver) return;
        ctLastOver.classList.remove('hidden');

        if (showWaiting) {
            // পরিবর্তন: শুধুমাত্র এনিমেশন (কোনো টেক্সট নেই)
            ctLastOver.innerHTML = `
                <div class="flex items-center justify-center w-full">
                    <span class="relative flex h-3 w-3">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                    </span>
                </div>`;
            return;
        }

        if (recentBallHistory.length === 0) {
             // হিস্টোরি না থাকলে ফাঁকা এনিমেশন
            ctLastOver.innerHTML = `
                <div class="flex items-center justify-center w-full">
                    <span class="relative flex h-3 w-3">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                    </span>
                </div>`;
            return;
        }

        // রানস লেবেল কালো (লাইট মোড) ও ধূসর (ডার্ক মোড) করা হয়েছে
        let ballsHtml = `<span class="text-[10px] text-black dark:text-gray-300 font-bold mr-1 uppercase" style="font-family: 'Bornomala', sans-serif;">RUNS:</span>`;
        
        recentBallHistory.forEach(ball => {
            let colorClass = "";
            let customStyle = "font-family: 'Bornomala', sans-serif;";
            
            if (ball === "4") colorClass = "four";
            else if (ball === "6") colorClass = "six";
            else if (ball === "W") colorClass = "wicket";
            else if (ball === "0") colorClass = "dot";
            else if (String(ball).startsWith("Ex")) {
                colorClass = "extra bg-gray-600 text-white border border-gray-500";
                customStyle += " font-size: 9px;";
            }

            ballsHtml += `<span class="ball-run ${colorClass} mx-0.5" style="${customStyle}">${ball}</span>`;
        });

        ctLastOver.innerHTML = ballsHtml;
    }
}
// Document Ready তে কল করুন
document.addEventListener('DOMContentLoaded', () => {
    initCricketTicker(); 
});

// ====================================================================
// END: LIVE CRICKET TICKER SCRIPT (UPDATED & REFINED)
// ====================================================================


    
// ====================================================================
// START: আরও সেটিংস (More Settings) TAB SCRIPT (Updated)
// ====================================================================
function initializeMoreSettings() {

     // ক্রিকেট সেটিংস লজিক
    const cricketUrlInput = document.getElementById('cricketUrlInput');
    const saveCricketBtn = document.getElementById('saveCricketBtn');
    const clearCricketBtn = document.getElementById('clearCricketBtn'); // নতুন

    if (saveCricketBtn && cricketUrlInput) {
        // লোড হলে সেভ করা URL দেখান
        cricketUrlInput.value = localStorage.getItem('crexMatchUrl') || '';

        saveCricketBtn.addEventListener('click', () => {
            const url = cricketUrlInput.value.trim();
            
            if (url && !url.includes('crex.com') && !url.includes('crex.live')) {
                return showCustomAlert('শুধুমাত্র Crex এর লিংক সাপোর্ট করে।');
            }
            
            localStorage.setItem('crexMatchUrl', url);
            showCustomAlert('লিংক সেভ করা হয়েছে! হোমপেজে টিকার চেক করুন।');
            
            // সাথে সাথে টিকার আপডেট করুন
            initCricketTicker();
        });

        // নতুন: মুছুন বাটনের লজিক
        if (clearCricketBtn) {
            clearCricketBtn.addEventListener('click', () => {
                cricketUrlInput.value = '';
                localStorage.removeItem('crexMatchUrl');
                showCustomAlert('লিংক মুছে ফেলা হয়েছে এবং টিকার বন্ধ করা হয়েছে।');
                // টিকার আপডেট করে বন্ধ করা
                initCricketTicker();
            });
        }
    }  

        // ০. জেমিনি API কী ইনপুট লজিক (নতুন যুক্ত করা হয়েছে)
        const settingsApiKeyInput = document.getElementById('settingsApiKeyInput');
        const saveSettingsApiKeyBtn = document.getElementById('saveSettingsApiKeyBtn');

        if (settingsApiKeyInput && saveSettingsApiKeyBtn) {
            // লোড হওয়ার সময় লোকাল স্টোরেজ থেকে কী নিয়ে ইনপুটে দেখান
            const savedApiKey = localStorage.getItem('geminiApiKey');
            if (savedApiKey) {
                settingsApiKeyInput.value = savedApiKey;
            }

            // সেভ বাটনে ক্লিক লিসেনার (আগের লিসেনার ওভাররাইড করতে onclick ব্যবহার করা হলো)
            saveSettingsApiKeyBtn.onclick = () => {
                const newApiKey = settingsApiKeyInput.value.trim();
                if (newApiKey) {
                    localStorage.setItem('geminiApiKey', newApiKey);
                    showCustomAlert('API কী সফলভাবে সেভ করা হয়েছে!');
                    // বাটন কালার আপডেট ফাংশন যদি থাকে
                    if (typeof updateApiKeyButton === 'function') updateApiKeyButton();
                } else {
                    // খালি রেখে সেভ করলে ডিলিট হবে
                    localStorage.removeItem('geminiApiKey');
                    showCustomAlert('API কী মুছে ফেলা হয়েছে।');
                    if (typeof updateApiKeyButton === 'function') updateApiKeyButton();
                }
            };
        }

    // ০.১. জেমিনি মডেল সিলেকশন লজিক (নতুন)
    const settingsGeminiModel = document.getElementById('settingsGeminiModel');
    if (settingsGeminiModel) {
        // লোড করার সময় সেভ করা মডেল বা ডিফল্ট মডেল সেট করুন
        const savedModel = localStorage.getItem('geminiModel') || "gemini-flash-latest";
        settingsGeminiModel.value = savedModel;

        // পরিবর্তন হলে সেভ করুন
        settingsGeminiModel.addEventListener('change', () => {
            const selectedModel = settingsGeminiModel.value;
            localStorage.setItem('geminiModel', selectedModel);
            showCustomAlert(`মডেল পরিবর্তন করা হয়েছে: ${selectedModel}`);
        });
    }

    // ০.২. Google সার্চ টগল লজিক (নতুন)
    const settingsGoogleSearchToggle = document.getElementById('settingsGoogleSearchToggle');
    if (settingsGoogleSearchToggle) {
        // ডিফল্ট true, যদি localStorage এ 'false' সেট করা না থাকে
        const isGoogleSearchEnabled = localStorage.getItem('googleSearchEnabled') !== 'false';
        settingsGoogleSearchToggle.checked = isGoogleSearchEnabled;

        settingsGoogleSearchToggle.addEventListener('change', () => {
            const isEnabled = settingsGoogleSearchToggle.checked;
            localStorage.setItem('googleSearchEnabled', isEnabled);
            showCustomAlert(`Google সার্চ: ${isEnabled ? 'চালু' : 'বন্ধ'} করা হয়েছে।`);
        });
    }
	
    // ১. নিউজ টিকার অন/অফ টগল লজিক
    const newsTickerToggle = document.getElementById('newsTickerToggle');
    const newsTickerContainer = document.getElementById('news-ticker-container');

    if (newsTickerToggle && newsTickerContainer) {
        const isNewsTickerEnabled = localStorage.getItem('newsTickerEnabled') !== 'false';
        newsTickerToggle.checked = isNewsTickerEnabled;

        newsTickerToggle.addEventListener('change', () => {
            const isEnabled = newsTickerToggle.checked;
            localStorage.setItem('newsTickerEnabled', isEnabled);
            
            if (isEnabled) {
                const useTypingAnimation = localStorage.getItem('newsAnimationType') === 'typing';
                newsTickerContainer.style.display = useTypingAnimation ? 'flex' : 'block';
            } else {
                newsTickerContainer.style.display = 'none';
            }
            showCustomAlert(`নিউজ টিকার: ${isEnabled ? 'চালু' : 'বন্ধ'} করা হয়েছে।`);
        });
    }

    // ২. সময় এবং তারিখ ব্যানার টগল লজিক
    const timeBannerToggle = document.getElementById('timeBannerToggle');
    const timeBannerContainer = document.getElementById('currentDateTimeBanner');

    if (timeBannerToggle && timeBannerContainer) {
        const isTimeBannerEnabled = localStorage.getItem('timeBannerEnabled') !== 'false';
        timeBannerToggle.checked = isTimeBannerEnabled;

        timeBannerToggle.addEventListener('change', () => {
            const isEnabled = timeBannerToggle.checked;
            localStorage.setItem('timeBannerEnabled', isEnabled);
            timeBannerContainer.style.display = isEnabled ? 'flex' : 'none';
            showCustomAlert(`সময় ব্যানার: ${isEnabled ? 'চালু' : 'বন্ধ'} করা হয়েছে।`);
        });
    }

// ৩. অনলাইন তারিখ আপডেট এবং অটো আপডেট লজিক (জেমিনি ইন্টিগ্রেটেড)
    const refreshDateBtn = document.getElementById('refreshDateBtn');
    const autoUpdateDateToggle = document.getElementById('autoUpdateDateToggle');

    // জেমিনি ব্যবহার করে তারিখ সিঙ্ক করার ফাংশন
    async function syncDatesWithGemini() {
        const apiKey = localStorage.getItem('geminiApiKey');
        if (!apiKey) throw new Error("API Key not set");

        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];

        // প্রম্পট: বর্তমান তারিখের জন্য সঠিক বাংলা ও হিজরি দিন চাওয়া হচ্ছে
        const prompt = `Current system date is ${dateStr}. 
        Determine the accurate current date in Bangladesh (Timezone Asia/Dhaka) right now.
        I need the Bengali Date (Day only) and Hijri Date (Day only) according to the official calendars used in Bangladesh today.
        
        Response JSON format ONLY:
        {
          "bengali_day": integer,
          "hijri_day": integer
        }`;

        const model = localStorage.getItem('geminiModel') || "gemini-flash-latest";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { response_mime_type: "application/json" }
        };

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        const data = JSON.parse(result.candidates[0].content.parts[0].text);

        if (data.bengali_day && data.hijri_day) {
            // বাংলা তারিখ অ্যাডজাস্টমেন্ট ক্যালকুলেশন
            const oldBenAdj = localStorage.getItem('bengaliDateAdjustment');
            let foundBen = false;
            // -৩ থেকে +৩ এর মধ্যে চেক করা হচ্ছে কোন অ্যাডজাস্টমেন্টে জেমিনির দেওয়া তারিখ মেলে
            for (let i = -3; i <= 3; i++) {
                localStorage.setItem('bengaliDateAdjustment', i.toString());
                if (getBengaliDate(now).day === data.bengali_day) {
                    foundBen = true;
                    // ইনপুট ফিল্ড আপডেট
                    const benInput = document.getElementById('bengaliDateAdjustInput');
                    if (benInput) benInput.value = i;
                    break;
                }
            }
            if (!foundBen) localStorage.setItem('bengaliDateAdjustment', oldBenAdj); // না মিললে আগের অবস্থায় ফেরত

            // হিজরি তারিখ অ্যাডজাস্টমেন্ট ক্যালকুলেশন
            const oldHijriAdj = localStorage.getItem('hijriDateAdjustment');
            let foundHijri = false;
            
            // হিজরি চেক করার জন্য একটি টেম্পোরারি ফাংশন বা লজিক
            const checkHijri = (adj) => {
                let d = new Date(now);
                d.setDate(d.getDate() + adj);
                const f = new Intl.DateTimeFormat('ar-SA', { calendar: 'islamic', day: 'numeric', timeZone: 'Asia/Dhaka' });
                // আরবী সংখ্যা থেকে ইংরেজি সংখ্যায় কনভার্ট করে তুলনা
                const part = f.formatToParts(d).find(p => p.type === 'day');
                const dayVal = parseInt(part.value.replace(/[٠-٩]/g, d => "٠١٢٣٤٥٦٧٨٩".indexOf(d)));
                return dayVal === data.hijri_day;
            };

            for (let i = -3; i <= 3; i++) {
                if (checkHijri(i)) {
                    localStorage.setItem('hijriDateAdjustment', i.toString());
                    foundHijri = true;
                    // ইনপুট ফিল্ড আপডেট
                    const hijriInput = document.getElementById('hijriDateAdjustInput');
                    if (hijriInput) hijriInput.value = i;
                    break;
                }
            }
            if (!foundHijri) localStorage.setItem('hijriDateAdjustment', oldHijriAdj);

            return true;
        }
        throw new Error("Invalid Data from Gemini");
    }

    if (refreshDateBtn && autoUpdateDateToggle) {
        // পরিবর্তন: ডিফল্টভাবে বন্ধ (false) রাখার জন্য লজিক আপডেট করা হয়েছে
        const isAutoUpdateEnabled = localStorage.getItem('autoUpdateDate') === 'true';
        autoUpdateDateToggle.checked = isAutoUpdateEnabled;

        // রিফ্রেশ বাটনের লজিক
        refreshDateBtn.onclick = async () => {
            showCustomAlert('অনলাইন (Gemini) থেকে তারিখ যাচাই করা হচ্ছে...');
            try {
                await syncDatesWithGemini();
                updateDateTimeBanner(true); // ব্যানার আপডেট
                showCustomAlert('Gemini-এর মাধ্যমে তারিখ ও অ্যাডজাস্টার আপডেট করা হয়েছে!');
            } catch (e) {
                console.error(e);
                showCustomAlert('Gemini ব্যর্থ। সাধারণ সার্ভার থেকে আপডেট করা হচ্ছে...');
                updateDateTimeBanner(true).then(() => {
                    showCustomAlert('তারিখ সফলভাবে আপডেট হয়েছে (সাধারণ)!');
                });
            }
        };

        // টগল লজিক
        autoUpdateDateToggle.addEventListener('change', async () => {
            const isEnabled = autoUpdateDateToggle.checked;
            localStorage.setItem('autoUpdateDate', isEnabled);
            showCustomAlert(`অটো ডেট আপডেট: ${isEnabled ? 'চালু' : 'বন্ধ'} করা হয়েছে।`);
            
            if (isEnabled) {
                // টগল অন করলে একবার জেমিনি চেক করার চেষ্টা করবে
                try {
                    await syncDatesWithGemini();
                    updateDateTimeBanner(true);
                } catch(e) {
                    updateDateTimeBanner(true); // ফেইল করলে সাধারণ আপডেট
                }
            }
        });
    }

// ৪. হিজরি তারিখ অ্যাডজাস্টার লজিক
    const hijriDateAdjustInput = document.getElementById('hijriDateAdjustInput');
    const saveHijriAdjustBtn = document.getElementById('saveHijriAdjustBtn');

    if (hijriDateAdjustInput && saveHijriAdjustBtn) {
        // যদি লোকাল স্টোরেজে কিছু না থাকে, তবে আমাদের গ্লোবাল ডিফল্ট ভ্যালুটি দেখাবে
        const currentAdjustment = getGlobalHijriAdjustment();
        hijriDateAdjustInput.value = currentAdjustment;

        saveHijriAdjustBtn.onclick = () => {
            const val = hijriDateAdjustInput.value;
            localStorage.setItem('hijriDateAdjustment', val);
            showCustomAlert(`হিজরি অ্যাডজাস্টমেন্ট (${val}) সেভ করা হয়েছে।`);
            updateDateTimeBanner(true);
        };
    }

    // ৫. বাংলা তারিখ অ্যাডজাস্টার লজিক
    const bengaliDateAdjustInput = document.getElementById('bengaliDateAdjustInput');
    const saveBengaliAdjustBtn = document.getElementById('saveBengaliAdjustBtn');

    if (bengaliDateAdjustInput && saveBengaliAdjustBtn) {
        const savedBengaliAdj = localStorage.getItem('bengaliDateAdjustment') || '0';
        bengaliDateAdjustInput.value = savedBengaliAdj;

        saveBengaliAdjustBtn.onclick = () => {
            const val = bengaliDateAdjustInput.value;
            localStorage.setItem('bengaliDateAdjustment', val);
            showCustomAlert(`বাংলা অ্যাডজাস্টমেন্ট (${val}) সেভ করা হয়েছে।`);
            updateDateTimeBanner(true);
        };
    }


// 3. ব্যাকগ্রাউন্ড এনিমেশন টগল লজিক (আপডেট করা হয়েছে)
    const bgAnimationToggle = document.getElementById('bgAnimationToggle');
    const bgArea = document.querySelector('.area'); // ব্যাকগ্রাউন্ড কালার কন্টেইনার
    const bgCircles = document.querySelector('.circles'); // বাবল এনিমেশন

    if (bgAnimationToggle && bgArea && bgCircles) {
        // পরিবর্তন: ডিফল্টভাবে বন্ধ রাখার জন্য লজিক আপডেট করা হয়েছে (=== 'true')
        const isBgAnimationEnabled = localStorage.getItem('bgAnimationEnabled') === 'true';
        bgAnimationToggle.checked = isBgAnimationEnabled;
        
        // পেজ লোডের সময় ইনিশিয়াল স্টেট সেট করা
        bgArea.style.display = 'block'; 
        
        // শুধুমাত্র বাবলগুলো হাইড বা শো হবে
        bgCircles.style.display = isBgAnimationEnabled ? 'block' : 'none';

        bgAnimationToggle.addEventListener('change', () => {
            const isEnabled = bgAnimationToggle.checked;
            localStorage.setItem('bgAnimationEnabled', isEnabled);
            
            // শুধুমাত্র বাবলগুলো হাইড বা শো হবে
            bgCircles.style.display = isEnabled ? 'block' : 'none';
            // .area সর্বদা দৃশ্যমান থাকবে
            bgArea.style.display = 'block';

            showCustomAlert(`ব্যাকগ্রাউন্ড এনিমেশন: ${isEnabled ? 'চালু' : 'বন্ধ'} করা হয়েছে।`);
        });
    }

    // ৪. টাইটেল এনিমেশন টগল লজিক (নতুন)
    const titleAnimationToggle = document.getElementById('titleAnimationToggle');
    
    if (titleAnimationToggle) {
        const isTitleAnimationEnabled = localStorage.getItem('titleAnimationEnabled') !== 'false';
        titleAnimationToggle.checked = isTitleAnimationEnabled;

        titleAnimationToggle.addEventListener('change', () => {
            const isEnabled = titleAnimationToggle.checked;
            localStorage.setItem('titleAnimationEnabled', isEnabled);
            showCustomAlert(`টাইটেল এনিমেশন: ${isEnabled ? 'চালু' : 'বন্ধ'} করা হয়েছে।`);
        });
    }

    // ৫. নিউজ অ্যানিমেশন স্টাইল টগল লজিক
    const newsAnimationToggle = document.getElementById('newsAnimationToggle');
    if (newsAnimationToggle) {
        const savedNewsSetting = localStorage.getItem('newsAnimationType') || 'sliding';
        newsAnimationToggle.checked = (savedNewsSetting === 'typing');

        newsAnimationToggle.addEventListener('change', () => {
            let newSetting = newsAnimationToggle.checked ? 'typing' : 'sliding';
            localStorage.setItem('newsAnimationType', newSetting);
            showCustomAlert(`নিউজ অ্যানিমেশন: ${newSetting === 'typing' ? 'টাইপিং' : 'স্লাইডিং'} সেট করা হয়েছে। পেজ রিলোড দিলে পরিবর্তন দেখা যাবে।`);
            
            const isTickerEnabled = localStorage.getItem('newsTickerEnabled') !== 'false';
            if (isTickerEnabled && typeof newsTickerContainer !== 'undefined') {
                 newsTickerContainer.style.display = newSetting === 'typing' ? 'flex' : 'block';
            }
        });
    }

    // ৬. অ্যাপ থিম সিলেকশন লজিক
    const themeSelect = document.getElementById('appThemeSelect');
    if (themeSelect) {
        const savedTheme = localStorage.getItem('selectedAppTheme') || 'modern';
        themeSelect.value = savedTheme;
        applyAppTheme(savedTheme);

        themeSelect.addEventListener('change', (e) => {
            const selectedTheme = e.target.value;
            localStorage.setItem('selectedAppTheme', selectedTheme);
            applyAppTheme(selectedTheme);
            showCustomAlert('থিম পরিবর্তন করা হয়েছে!');
        });
    }

    // ৭. ক্লিয়ার অ্যাপ ডাটা লজিক (উন্নত ও নিরাপদ - Promise যুক্ত)
    const clearAppDataBtn = document.getElementById('clearAppDataBtn');
    if (clearAppDataBtn) {
        clearAppDataBtn.addEventListener('click', async () => {
            const confirmed = confirm("সতর্কতা: আপনি কি নিশ্চিত যে আপনি সমস্ত অ্যাপ ডাটা মুছে ফেলতে চান? নোটপ্যাড, ইনভয়েজ এবং অন্যান্য সেভ করা তথ্য স্থায়ীভাবে মুছে যাবে।");
            if (confirmed) {
                // ইউজারকে ফিডব্যাক দিন যে প্রক্রিয়া চলছে
                if (typeof showCustomAlert === 'function') {
                    showCustomAlert('ডাটা মুছে ফেলা হচ্ছে, অনুগ্রহ করে অপেক্ষা করুন...');
                }
                clearAppDataBtn.disabled = true;
                clearAppDataBtn.innerText = 'মুছে ফেলা হচ্ছে...';

                // ১. লোকাল স্টোরেজ ক্লিয়ার
                localStorage.clear();

                // ২. ইনডেক্সডডিবি (IndexedDB) ডিলিট রিকোয়েস্ট (Promise সহ নিরাপদ পদ্ধতি)
                const dbsToDelete = ['BanglaToolboxDB', 'invoiceDB'];
                
                const deletePromises = dbsToDelete.map(dbName => {
                    return new Promise((resolve) => {
                        const req = indexedDB.deleteDatabase(dbName);
                        
                        // যদি সাকসেস হয় (মানে কানেকশন ওপেন ছিল না এবং ডিলিট হয়ে গেছে)
                        req.onsuccess = () => {
                            console.log(`${dbName} deleted successfully`);
                            resolve();
                        };
                        
                        // যদি ব্লকড হয় (মানে কানেকশন ওপেন আছে), তাও আমরা resolve করব।
                        // কারণ এর মানে হলো ব্রাউজার কমান্ড পেয়েছে এবং পেজ রিফ্রেশ (কানেকশন ক্লোজ) হওয়ার জন্য অপেক্ষা করছে।
                        req.onblocked = () => {
                            console.warn(`${dbName} delete blocked - will complete on reload`);
                            resolve(); 
                        };
                        
                        // কোনো এরর হলেও আমরা আটকে থাকব না, রিফ্রেশ করে দেব
                        req.onerror = (e) => {
                            console.error(`${dbName} delete error`, e);
                            resolve(); 
                        };
                    });
                });

                // ৩. সব ডিলিট রিকোয়েস্ট রেজিস্টার হওয়া পর্যন্ত অপেক্ষা
                try {
                    await Promise.all(deletePromises);
                } catch (error) {
                    console.error("Error during deletion:", error);
                }

                // ৪. পেজ রিফ্রেশ (এখন নিরাপদ কারণ রিকোয়েস্টগুলো ব্রাউজারের কিউ-তে জমা হয়েছে)
                if (typeof showCustomAlert === 'function') {
                    showCustomAlert('ডাটা ক্লিয়ার সম্পন্ন! পেজ রিফ্রেশ হচ্ছে...');
                } else {
                    alert('ডাটা ক্লিয়ার সম্পন্ন! পেজ রিফ্রেশ হচ্ছে...');
                }
                
                setTimeout(() => { 
                    location.reload(); 
                }, 500); // ব্যবহারকারীকে মেসেজ পড়ার জন্য সামান্য সময় দেওয়া
            }
        });
    }

    // ৮. নতুন: ফুলস্ক্রিন মোড টগল লজিক
    const fullscreenToggle = document.getElementById('fullscreenToggle');
    const mainContainer = document.querySelector('.main-container');

    if (fullscreenToggle && mainContainer) {
        // সেটিংস লোড করা
        const isFullscreenEnabled = localStorage.getItem('fullscreenMode') === 'true';
        fullscreenToggle.checked = isFullscreenEnabled;
        
        // টগল ইভেন্ট লিসেনার
        fullscreenToggle.addEventListener('change', () => {
            const isEnabled = fullscreenToggle.checked;
            localStorage.setItem('fullscreenMode', isEnabled);
            
            if (isEnabled) {
                mainContainer.classList.add('full-width');
            } else {
                mainContainer.classList.remove('full-width');
            }
            showCustomAlert(`ফুলস্ক্রিন মোড: ${isEnabled ? 'চালু' : 'বন্ধ'} করা হয়েছে।`);
        });
    }
	
}

// থিম অ্যাপ্লাই করার হেল্পার ফাংশন
function applyAppTheme(themeName) {
    const rootElement = document.documentElement;
    rootElement.removeAttribute('data-theme');
    if (['classic', 'nature', 'purple', 'sunset'].includes(themeName)) {
        rootElement.setAttribute('data-theme', themeName);
    }
}

// পেজ লোড হওয়ার সাথে সাথেই সেটিংস অ্যাপ্লাই করার জন্য
document.addEventListener('DOMContentLoaded', () => {
    const savedTheme = localStorage.getItem('selectedAppTheme') || 'modern';
    applyAppTheme(savedTheme);

    // --- নতুন: ফুলস্ক্রিন মোড অ্যাপ্লাই করা ---
    const isFullscreenEnabled = localStorage.getItem('fullscreenMode') === 'true';
    const mainContainer = document.querySelector('.main-container');
    if (isFullscreenEnabled && mainContainer) {
        mainContainer.classList.add('full-width');
    }
	
    // ব্যাকগ্রাউন্ড এনিমেশন ইনিশিয়ালাইজেশন (পেজ লোডের সময় ফ্লিকার এড়াতে) - আপডেট করা হয়েছে
    const bgArea = document.querySelector('.area');
    const bgCircles = document.querySelector('.circles');

    if (bgArea && bgCircles) {
        // পরিবর্তন: ডিফল্টভাবে বন্ধ রাখার জন্য লজিক আপডেট করা হয়েছে (=== 'true')
        const isBgAnimationEnabled = localStorage.getItem('bgAnimationEnabled') === 'true';
        
        // .area সর্বদা দৃশ্যমান থাকবে যাতে ব্যাকগ্রাউন্ড কালার ঠিক থাকে
        bgArea.style.display = 'block';
        
        // শুধুমাত্র বাবলগুলো সেটিংস অনুযায়ী শো/হাইড হবে
        bgCircles.style.display = isBgAnimationEnabled ? 'block' : 'none';
    }
// ৯. ডাটা এক্সপোর্ট এবং ইমপোর্ট লজিক (ব্যাকআপ ও রিস্টোর)
    const exportDataBtn = document.getElementById('exportDataBtn');
    const importDataBtn = document.getElementById('importDataBtn');
    const importFileInput = document.getElementById('importFileInput');

    // ইনভয়েজ ডাটাবেস এক্সেস করার জন্য হেল্পার (যেহেতু এটি আলাদা স্কোপে থাকে)
    function openInvoiceDbForBackup() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('invoiceDB', 2);
            request.onerror = () => resolve(null); // ফেইল করলে নাল রিটার্ন করবে, থামবে না
            request.onsuccess = (e) => resolve(e.target.result);
        });
    }

    if (exportDataBtn && importDataBtn && importFileInput) {
        
        // --- এক্সপোর্ট (ব্যাকআপ) ফাংশন ---
        exportDataBtn.addEventListener('click', async () => {
            exportDataBtn.disabled = true;
            exportDataBtn.innerText = 'প্রসেসিং...';
            
            try {
                const backupData = {
                    metadata: {
                        timestamp: new Date().toISOString(),
                        appName: "Bangla Toolbox",
                        version: "1.0"
                    },
                    localStorage: { ...localStorage },
                    indexedDB: {
                        converterStore: [],
                        invoices: [],
                        products: []
                    }
                };

                // ১. BanglaToolboxDB (নোটপ্যাড, হিস্টোরি ইত্যাদি) থেকে ডাটা নেওয়া
                try {
                    const db = await getDb(); // গ্লোবাল ফাংশন
                    const tx = db.transaction('converterStore', 'readonly');
                    const store = tx.objectStore('converterStore');
                    const items = await new Promise((resolve) => {
                        const req = store.getAll();
                        req.onsuccess = () => resolve(req.result);
                        req.onerror = () => resolve([]);
                    });
                    backupData.indexedDB.converterStore = items;
                } catch (e) { console.error("ConverterStore Backup Error:", e); }

                // ২. invoiceDB থেকে ডাটা নেওয়া
                try {
                    const invDb = await openInvoiceDbForBackup();
                    if (invDb) {
                        // Invoices
                        if (invDb.objectStoreNames.contains('invoices')) {
                            const txInv = invDb.transaction('invoices', 'readonly');
                            const itemsInv = await new Promise((resolve) => {
                                const req = txInv.objectStore('invoices').getAll();
                                req.onsuccess = () => resolve(req.result);
                                req.onerror = () => resolve([]);
                            });
                            backupData.indexedDB.invoices = itemsInv;
                        }
                        // Products
                        if (invDb.objectStoreNames.contains('products')) {
                            const txProd = invDb.transaction('products', 'readonly');
                            const itemsProd = await new Promise((resolve) => {
                                const req = txProd.objectStore('products').getAll();
                                req.onsuccess = () => resolve(req.result);
                                req.onerror = () => resolve([]);
                            });
                            backupData.indexedDB.products = itemsProd;
                        }
                    }
                } catch (e) { console.error("InvoiceDB Backup Error:", e); }

                // ফাইল ডাউনলোড করা
                const dataStr = JSON.stringify(backupData, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const date = new Date().toISOString().split('T')[0];
                a.download = `BanglaToolbox_Backup_${date}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showCustomAlert('ব্যাকআপ ফাইল ডাউনলোড শুরু হয়েছে!');

            } catch (error) {
                console.error("Export Failed:", error);
                showCustomAlert('ব্যাকআপ নিতে সমস্যা হয়েছে।');
            } finally {
                exportDataBtn.disabled = false;
                exportDataBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
                    এক্সপোর্ট (ব্যাকআপ)`;
            }
        });

        // --- ইমপোর্ট (রিস্টোর) বাটন ক্লিক ---
        importDataBtn.addEventListener('click', () => {
            importFileInput.click();
        });

        // --- ফাইল সিলেক্ট হলে রিস্টোর প্রসেস ---
        importFileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm("সতর্কতা: ব্যাকআপ রিস্টোর করলে বর্তমান ডাটা প্রতিস্থাপন করা হবে। আপনি কি নিশ্চিত?")) {
                importFileInput.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.localStorage || !data.indexedDB) {
                        throw new Error("অবৈধ ব্যাকআপ ফাইল ফরম্যাট।");
                    }

                    // ১. লোকাল স্টোরেজ রিস্টোর
                    localStorage.clear();
                    Object.keys(data.localStorage).forEach(key => {
                        localStorage.setItem(key, data.localStorage[key]);
                    });

                    // ২. BanglaToolboxDB রিস্টোর (নোটপ্যাড ইত্যাদি)
                    if (data.indexedDB.converterStore && data.indexedDB.converterStore.length > 0) {
                        const db = await getDb();
                        const tx = db.transaction('converterStore', 'readwrite');
                        const store = tx.objectStore('converterStore');
                        // পুরনো সব ডিলিট
                        await new Promise((resolve) => {
                            const req = store.clear();
                            req.onsuccess = resolve;
                        });
                        // নতুন ডাটা যোগ
                        for (const item of data.indexedDB.converterStore) {
                            store.put(item);
                        }
                        await new Promise(resolve => tx.oncomplete = resolve);
                    }

                    // ৩. invoiceDB রিস্টোর
                    const invDb = await openInvoiceDbForBackup();
                    if (invDb) {
                        // Invoices
                        if (data.indexedDB.invoices && data.indexedDB.invoices.length > 0) {
                            const txInv = invDb.transaction('invoices', 'readwrite');
                            const storeInv = txInv.objectStore('invoices');
                            storeInv.clear();
                            data.indexedDB.invoices.forEach(item => storeInv.put(item));
                        }
                        // Products
                        if (data.indexedDB.products && data.indexedDB.products.length > 0) {
                            const txProd = invDb.transaction('products', 'readwrite');
                            const storeProd = txProd.objectStore('products');
                            storeProd.clear();
                            data.indexedDB.products.forEach(item => storeProd.put(item));
                        }
                    }

                    showCustomAlert('ডাটা সফলভাবে রিস্টোর হয়েছে! পেজ রিলোড হচ্ছে...');
                    setTimeout(() => location.reload(), 2000);

                } catch (error) {
                    console.error("Import Failed:", error);
                    showCustomAlert('ইমপোর্ট ব্যর্থ হয়েছে: ' + error.message);
                }
            };
            reader.readAsText(file);
            importFileInput.value = ''; // রিসেট
        });
    }
});
// ====================================================================
// END: আরও সেটিংস (More Settings) TAB SCRIPT
// ====================================================================

// ====================================================================
// START: ইতিহাস (History) TAB SCRIPT
// ====================================================================

// জেমিনি থেকে পাওয়া Markdown টেক্সটকে HTML-এ রূপান্তর করার সহজ ফাংশন
function simpleMarkdownToHTML(text) {
    return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
        .replace(/\*(.*?)\*/g, '<em>$1</em>')     // Italic
        .replace(/####\s(.*?)\n/g, '<div class="history-section"><h4>$1</h4></div>') // H4
        .replace(/-\s(.*?)\n/g, '<ul><li>$1</li></ul>') // List items
        .replace(/<\/ul>\s*<ul>/g, '') // Join consecutive lists
        .replace(/\n\n/g, '<br><br>') // Paragraph breaks
        .replace(/\n(.*?)(?=\n####|\n<ul>|\n$)/g, '<p>$1</p>') // Wrap plain text in <p>
        .replace(/<p><\/p>/g, ''); // Remove empty paragraphs
}

// আজকের ইতিহাস লোড করার ফাংশন
async function loadOrFetchTodayHistory() {
    const today = new Date().toISOString().split('T')[0];
    const savedDate = sessionStorage.getItem('dailyHistoryDate');
    const savedContent = sessionStorage.getItem('dailyHistoryContent');
    const displayArea = document.getElementById('history-display-area');
    const title = document.getElementById('history-title');
    const loading = document.getElementById('history-loading');

    // শিরোনাম আপডেট করুন (ক্যাশে বা নতুন)
    const todayDate = new Date();
    const todayString = todayDate.toLocaleDateString('bn-BD', { day: 'numeric', month: 'long' });
    const todayDayName = todayDate.toLocaleDateString('bn-BD', { weekday: 'long' });
    title.innerText = `আজকের দিনে - ${todayString}, ${todayDayName}`;

    if (savedDate === today && savedContent) {
        console.log("Loading today's history from session cache.");
        displayArea.innerHTML = savedContent;
        loading.style.display = 'none'; // লোডার লুকান
        displayArea.classList.remove('hidden'); // কন্টেন্ট দেখান
    } else {
        console.log("Fetching new data for today.");
        loading.style.display = 'block'; // লোডার দেখানো নিশ্চিত করুন
        displayArea.classList.add('hidden'); // কন্টেন্ট লুকানো নিশ্চিত করুন
        await fetchDailyHistory();
    }
}

// আগামীকালের ইতিহাস লোড করার ফাংশন
async function loadOrFetchTomorrowHistory() {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowString = tomorrow.toISOString().split('T')[0];

    const savedDate = sessionStorage.getItem('dailyHistoryDateTomorrow');
    const savedContent = sessionStorage.getItem('dailyHistoryContentTomorrow');
    const displayArea = document.getElementById('history-display-area-tomorrow');
    const title = document.getElementById('history-title-tomorrow');
    const loading = document.getElementById('history-loading-tomorrow');

    // শিরোনাম আপডেট করুন (ক্যাশে বা নতুন)
    const tomorrowDateString = tomorrow.toLocaleDateString('bn-BD', { day: 'numeric', month: 'long' });
    const tomorrowDayName = tomorrow.toLocaleDateString('bn-BD', { weekday: 'long' });
    title.innerText = `আগামীকালের দিনে - ${tomorrowDateString}, ${tomorrowDayName}`;

    if (savedDate === tomorrowString && savedContent) {
        console.log("Loading tomorrow's history from session cache.");
        displayArea.innerHTML = savedContent;
        loading.style.display = 'none'; // লোডার লুকান
        displayArea.classList.remove('hidden'); // কন্টেন্ট দেখান
    } else {
        console.log("Fetching new data for tomorrow.");
        loading.style.display = 'block'; // লোডার দেখানো নিশ্চিত করুন
        displayArea.classList.add('hidden'); // কন্টেন্ট লুকানো নিশ্চিত করুন
        await fetchTomorrowHistory();
    }
}

// আজকের ইতিহাস জেমিনি থেকে আনার ফাংশন
async function fetchDailyHistory() {
    const displayArea = document.getElementById('history-display-area');
    const loading = document.getElementById('history-loading');
    const title = document.getElementById('history-title');
    const apiKey = localStorage.getItem('geminiApiKey');

    if (!apiKey) {
        displayArea.innerHTML = '<p class="text-red-500">অনুগ্রহ করে প্রথমে "সেটিংস" থেকে আপনার Gemini API কী সেট করুন।</p>';
        displayArea.classList.remove('hidden'); // ত্রুটি দেখানোর জন্য কন্টেন্ট এলাকা দেখান
        loading.style.display = 'none'; // লোডার লুকান
        return;
    }

    // API কল করার আগে লোডার দেখান এবং কন্টেন্ট লুকান
    loading.style.display = 'block';
    displayArea.classList.add('hidden');

    try {
        const today = new Date();
        const todayString = today.toLocaleDateString('bn-BD', { day: 'numeric', month: 'long' });
        const todayDayName = today.toLocaleDateString('bn-BD', { weekday: 'long' });
        // title.innerText = `আজকের দিনে - ${todayString}, ${todayDayName}`; // এটি এখন loadOrFetchTodayHistory দ্বারা নিয়ন্ত্রিত

        const prompt = `
        আজ ${todayString}, ${todayDayName}। আজকের দিনের জন্য নিচের তথ্যগুলো দাও (বাংলাদেশ প্রেক্ষাপটে):
        #### ঐতিহাসিক ঘটনা
        - আজকের দিনে অতীতে ঘটে যাওয়া ৩-৪টি গুরুত্বপূর্ণ ঐতিহাসিক ঘটনা (সালসহ)।
        #### গুরুত্বপূর্ণ দিবস (বাংলাদেশ)
        - আজকের দিনে বাংলাদেশে পালিত কোনো স্মরণীয় দিবস বা ঘটনা থাকলে তা উল্লেখ করো। না থাকলে "আজ বাংলাদেশে কোনো বিশেষ দিবস নেই" লেখো।
        #### গুরুত্বপূর্ণ দিবস (আন্তর্জাতিক)
        - আজকের দিনে পালিত ৩-৪টি গুরুত্বপূর্ণ আন্তর্জাতিক দিবস উল্লেখ করো।
        #### বাংলাদেশে ছুটির দিন?
        - আজকের তারিখটি (${todayString}) কি বাংলাদেশে সরকারি ছুটির দিন? শুধু 'হ্যাঁ' বা 'না'-এর মাধ্যমে উত্তর দাও এবং ছুটির কারণ উল্লেখ করো (যদি থাকে, শুক্রবার বা শনিবার হলে সাপ্তাহিক ছুটি উল্লেখ করো)।
        তোমার উত্তরটি সুন্দরভাবে Markdown ফরম্যাটে সাজিয়ে দাও। প্রতিটি সেকশনের শিরোনাম #### দিয়ে শুরু করবে।
        `;

        const payload = { contents: [{ parts: [{ text: prompt }] }] };
        // --- গ্লোবাল মডেল ব্যবহার ---
        const model = localStorage.getItem('geminiModel') || "gemini-flash-latest";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error(`API Error: ${response.status}`);
        const result = await response.json();
        const rawText = result.candidates?.[0]?.content?.parts?.[0]?.text;

        if (rawText) {
            const htmlContent = simpleMarkdownToHTML(rawText);
            displayArea.innerHTML = htmlContent;
            sessionStorage.setItem('dailyHistoryDate', today.toISOString().split('T')[0]);
            sessionStorage.setItem('dailyHistoryContent', htmlContent);
        } else {
            throw new Error("API থেকে কোনো তথ্য পাওয়া যায়নি।");
        }
    } catch (error) {
        console.error("Today's History Fetch Error:", error);
        displayArea.innerHTML = `<p class="text-red-500">তথ্য আনতে সমস্যা হয়েছে: ${error.message}</p>`;
    } finally {
        loading.style.display = 'none'; // লোডার লুকান
        displayArea.classList.remove('hidden'); // কন্টেন্ট (বা ত্রুটি) দেখান
    }
}

// আগামীকালের ইতিহাস জেমিনি থেকে আনার ফাংশন
async function fetchTomorrowHistory() {
    const displayArea = document.getElementById('history-display-area-tomorrow');
    const loading = document.getElementById('history-loading-tomorrow');
    const title = document.getElementById('history-title-tomorrow');
    const apiKey = localStorage.getItem('geminiApiKey');

    if (!apiKey) {
        displayArea.innerHTML = '<p class="text-red-500">অনুগ্রহ করে প্রথমে "সেটিংস" থেকে আপনার Gemini API কী সেট করুন।</p>';
        displayArea.classList.remove('hidden'); // ত্রুটি দেখানোর জন্য কন্টেন্ট এলাকা দেখান
        loading.style.display = 'none'; // লোডার লুকান
        return;
    }

    // API কল করার আগে লোডার দেখান এবং কন্টেন্ট লুকান
    loading.style.display = 'block';
    displayArea.classList.add('hidden');

    try {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const tomorrowString = tomorrow.toLocaleDateString('bn-BD', { day: 'numeric', month: 'long' });
        const tomorrowDayName = tomorrow.toLocaleDateString('bn-BD', { weekday: 'long' });
        // title.innerText = `আগামীকালের দিনে - ${tomorrowString}, ${tomorrowDayName}`; // এটি এখন loadOrFetchTomorrowHistory দ্বারা নিয়ন্ত্রিত

        const prompt = `
        আগামীকাল ${tomorrowString}, ${tomorrowDayName}। আগামীকালের দিনের জন্য নিচের তথ্যগুলো দাও (বাংলাদেশ প্রেক্ষাপটে):
        #### ঐতিহাসিক ঘটনা
        - আগামীকালের দিনে অতীতে ঘটে যাওয়া ৩-৪টি গুরুত্বপূর্ণ ঐতিহাসিক ঘটনা (সালসহ)।
        #### গুরুত্বপূর্ণ দিবস (বাংলাদেশ)
        - আগামীকালের দিনে বাংলাদেশে পালিত কোনো স্মরণীয় দিবস বা ঘটনা থাকলে তা উল্লেখ করো। না থাকলে "আগামীকাল বাংলাদেশে কোনো বিশেষ দিবস নেই" লেখো।
        #### গুরুত্বপূর্ণ দিবস (আন্তর্জাতিক)
        - আগামীকালের দিনে পালিত ৩-৪টি গুরুত্বপূর্ণ আন্তর্জাতিক দিবস উল্লেখ করো।
        #### বাংলাদেশে ছুটির দিন?
        - আগামীকালের তারিখটি (${tomorrowString}) কি বাংলাদেশে সরকারি ছুটির দিন? শুধু 'হ্যাঁ' বা 'না'-এর মাধ্যমে উত্তর দাও এবং ছুটির কারণ উল্লেখ করো (যদি থাকে, শুক্রবার বা শনিবার হলে সাপ্তাহিক ছুটি উল্লেখ করো)।
        তোমার উত্তরটি সুন্দরভাবে Markdown ফরম্যাটে সাজিয়ে দাও। প্রতিটি সেকশনের শিরোনাম #### দিয়ে শুরু করবে।
        `;

        const payload = { contents: [{ parts: [{ text: prompt }] }] };
		// --- গ্লোবাল মডেল ব্যবহার ---
        const model = localStorage.getItem('geminiModel') || "gemini-flash-latest";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) throw new Error(`API Error: ${response.status}`);
        const result = await response.json();
        const rawText = result.candidates?.[0]?.content?.parts?.[0]?.text;

        if (rawText) {
            const htmlContent = simpleMarkdownToHTML(rawText);
            displayArea.innerHTML = htmlContent;
            sessionStorage.setItem('dailyHistoryDateTomorrow', tomorrow.toISOString().split('T')[0]);
            sessionStorage.setItem('dailyHistoryContentTomorrow', htmlContent);
        } else {
            throw new Error("API থেকে কোনো তথ্য পাওয়া যায়নি।");
        }
    } catch (error) {
        console.error("Tomorrow's History Fetch Error:", error);
        displayArea.innerHTML = `<p class="text-red-500">তথ্য আনতে সমস্যা হয়েছে: ${error.message}</p>`;
    } finally {
        loading.style.display = 'none'; // লোডার লুকান
        displayArea.classList.remove('hidden'); // কন্টেন্ট (বা ত্রুটি) দেখান
    }
}

// ট্যাব খোলার সময় এই ফাংশনটি কল হবে
function initializeHistoryTab() {
    // এই ফাংশনটি কল করার আগে লোডারগুলো দৃশ্যমান এবং কন্টেন্ট এলাকা লুকানো আছে কিনা তা নিশ্চিত করুন
    document.getElementById('history-loading').style.display = 'block';
    document.getElementById('history-display-area').classList.add('hidden');
    document.getElementById('history-loading-tomorrow').style.display = 'block';
    document.getElementById('history-display-area-tomorrow').classList.add('hidden');

    loadOrFetchTodayHistory();
    loadOrFetchTomorrowHistory();

    // --- নতুন: রিফ্রেশ বাটন ইভেন্ট লিসেনার ---
    const todayRefreshBtn = document.getElementById('todayHistoryRefreshBtn');
    const tomorrowRefreshBtn = document.getElementById('tomorrowHistoryRefreshBtn');

    // বাটনগুলো একবারই ইনিশিয়ালাইজ করা হয়েছে কিনা তা পরীক্ষা করুন (অপশনাল কিন্তু ভালো অভ্যাস)
    if (todayRefreshBtn && !todayRefreshBtn.dataset.listenerAdded) {
        todayRefreshBtn.addEventListener('click', () => {
            showCustomAlert('আজকের ইতিহাস রিফ্রেশ করা হচ্ছে...');
            sessionStorage.removeItem('dailyHistoryDate');
            sessionStorage.removeItem('dailyHistoryContent');
            fetchDailyHistory(); // ক্যাশে চেক না করে সরাসরি API কল করুন
        });
        todayRefreshBtn.dataset.listenerAdded = 'true'; // ডুপ্লিকেট লিসেনার এড়াতে
    }

    if (tomorrowRefreshBtn && !tomorrowRefreshBtn.dataset.listenerAdded) {
        tomorrowRefreshBtn.addEventListener('click', () => {
            showCustomAlert('আগামীকালের ইতিহাস রিফ্রেশ করা হচ্ছে...');
            sessionStorage.removeItem('dailyHistoryDateTomorrow');
            sessionStorage.removeItem('dailyHistoryContentTomorrow');
            fetchTomorrowHistory(); // ক্যাশে চেক না করে সরাসরি API কল করুন
        });
        tomorrowRefreshBtn.dataset.listenerAdded = 'true';
    }
}
// ====================================================================
// END: ইতিহাস (History) TAB SCRIPT
// ====================================================================


// ====================================================================
// START: WHATSAPP FLOATING BUTTON SCRIPT
// ====================================================================
document.addEventListener('DOMContentLoaded', () => {
    const whatsappFab = document.getElementById('whatsapp-fab');
    const whatsappInputBox = document.getElementById('whatsapp-input-box');
    const whatsappSendBtn = document.getElementById('whatsapp-send-btn');
    const whatsappMessage = document.getElementById('whatsapp-message');

    if (whatsappFab && whatsappInputBox && whatsappSendBtn) {
        // ১. আইকনে ক্লিক করলে ইনপুট বক্স ওপেন/ক্লোজ হবে
        whatsappFab.addEventListener('click', (e) => {
            e.stopPropagation(); // সাইডবার যাতে বন্ধ না হয়
            whatsappInputBox.classList.toggle('hidden');
            // বক্স ওপেন হলে টেক্সট এরিয়াতে ফোকাস দিন
            if (!whatsappInputBox.classList.contains('hidden')) {
                whatsappMessage.focus();
            }
        });

        // ২. টেক্সটবক্সে ক্লিক করলে যাতে সাইডবার বন্ধ না হয়
        whatsappInputBox.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // ৩. সেন্ড বাটনে ক্লিক করলে নতুন ট্যাবে লিংক ওপেন হবে
        whatsappSendBtn.addEventListener('click', () => {
            const message = whatsappMessage.value;
            // টেক্সট এনকোড করা, যাতে স্পেস বা বিশেষ অক্ষর ইউআরএল-এ কাজ করে
            const encodedMessage = encodeURIComponent(message);
            const phoneNumber = "8801778472964";
            
            // নির্দিষ্ট ফরম্যাটে লিংক তৈরি
            const url = `https://web.whatsapp.com/send?text=${encodedMessage}&phone=${phoneNumber}`;
            
            // নতুন ট্যাবে ওপেন করা
            window.open(url, '_blank');
            
            // পাঠানোর পর বক্স লুকিয়ে ফেলা এবং লেখা মুছে ফেলা (ঐচ্ছিক)
            whatsappInputBox.classList.add('hidden');
            whatsappMessage.value = '';
        });
    }
});
// ====================================================================
// END: WHATSAPP FLOATING BUTTON SCRIPT
// ====================================================================

// ====================================================================
// START: BANGLA TOOLBOX SCRIPT
// ====================================================================
(function() {
    const _hexName = "\x4d\x64\x20\x53\x68\x61\x68\x69\x64\x75\x7a\x7a\x61\x6d\x61\x6e\x20\x53\x69\x66\x61\x74";
    function setAndProtectName(name) {
        const targets = [
            document.getElementById('preloader-name'), 
            document.querySelector('.important-links-container h2') 
        ];

        targets.forEach(element => {
            if (element) {
                
                element.innerText = name;
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (element.innerText !== name) {
                            console.warn("Developer identity tampering detected! Reverting...");
                            element.innerText = name; 
                        }
                    });
                });
                observer.observe(element, { 
                    childList: true, 
                    subtree: true, 
                    characterData: true, 
                    attributes: true 
                });
            }
        });
    }
    async function initIdentity() {
        const githubUrl = 'https://raw.githubusercontent.com/mdsifatgitid/mdsifatgitid.github.io/main/author.json';
        try {
            const response = await fetch(githubUrl);
            if (!response.ok) throw new Error('GitHub Fetch Failed');
            
            const data = await response.json();
            if (data && data.name) {
                setAndProtectName(data.name);
            } else {
                throw new Error('Invalid Data');
            }
        } catch (error) {
            // console.log("Offline Mode Active for Identity");
            setAndProtectName(_hexName);
        }
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initIdentity);
    } else {
        initIdentity();
    }
})();
// ====================================================================
// END: BANGLA TOOLBOX SCRIPT
// ====================================================================

// ====================================================================
// START: CURRENCY CONVERTER SCRIPT
// ====================================================================
function initializeCurrencyConverter() {
    const amountInput = document.getElementById('currAmount');
    const fromSelect = document.getElementById('currFrom');
    const toSelect = document.getElementById('currTo');
    const swapBtn = document.getElementById('currSwapBtn');
    const convertBtn = document.getElementById('convertCurrencyBtn');
    const resultDiv = document.getElementById('currResult');
    const finalAmountEl = document.getElementById('currFinalAmount');
    const rateEl = document.getElementById('currRate');

    if (!amountInput) return;

    const currencies = {
        "BDT": "Bangladeshi Taka", "USD": "US Dollar", "EUR": "Euro", "INR": "Indian Rupee",
        "SAR": "Saudi Riyal", "GBP": "British Pound", "MYR": "Malaysian Ringgit", 
        "AED": "UAE Dirham", "KWD": "Kuwaiti Dinar", "CAD": "Canadian Dollar",
        "AUD": "Australian Dollar", "JPY": "Japanese Yen"
    };

    // Populate dropdowns
    function populateCurrencyDropdowns() {
        if (fromSelect.options.length > 0) return; // Already populated
        for (let code in currencies) {
            let option1 = document.createElement("option");
            let option2 = document.createElement("option");
            option1.value = code; option1.text = `${code} - ${currencies[code]}`;
            option2.value = code; option2.text = `${code} - ${currencies[code]}`;
            fromSelect.add(option1);
            toSelect.add(option2);
        }
        fromSelect.value = "USD";
        toSelect.value = "BDT";
    }

    async function convertCurrency() {
        const amount = parseFloat(amountInput.value);
        const from = fromSelect.value;
        const to = toSelect.value;

        if (isNaN(amount)) return;

        convertBtn.disabled = true;
        convertBtn.textContent = 'হিসাব হচ্ছে...';

        try {
            // Free API (No key needed)
            const response = await fetch(`https://api.exchangerate-api.com/v4/latest/${from}`);
            const data = await response.json();
            const rate = data.rates[to];
            const result = (amount * rate).toFixed(2);

            finalAmountEl.textContent = `${result} ${to}`;
            rateEl.textContent = `1 ${from} = ${rate} ${to}`;
            resultDiv.classList.remove('hidden');
        } catch (error) {
            console.error("Currency API Error:", error);
            showCustomAlert("রেট লোড করা যায়নি। ইন্টারনেট সংযোগ চেক করুন।");
        } finally {
            convertBtn.disabled = false;
            convertBtn.textContent = 'রূপান্তর করুন';
        }
    }

    populateCurrencyDropdowns();

    convertBtn.addEventListener('click', convertCurrency);
    
    swapBtn.addEventListener('click', () => {
        const temp = fromSelect.value;
        fromSelect.value = toSelect.value;
        toSelect.value = temp;
        convertCurrency();
    });
}
// ====================================================================
// END: CURRENCY CONVERTER SCRIPT
// ====================================================================

// ====================================================================
// START: EMI CALCULATOR SCRIPT
// ====================================================================
function initializeEMICalculator() {
    const amountInput = document.getElementById('emiPrincipal');
    const rateInput = document.getElementById('emiRate');
    const tenureInput = document.getElementById('emiTenure');
    const tenureTypeInput = document.getElementById('emiTenureType');
    const calcBtn = document.getElementById('calculateEmiBtn');
    const resultDiv = document.getElementById('emiResult');

    if (!calcBtn) return;

    calcBtn.addEventListener('click', () => {
        const P = parseFloat(amountInput.value);
        const annualRate = parseFloat(rateInput.value);
        const tenureValue = parseFloat(tenureInput.value);
        
        if (!P || !annualRate || !tenureValue) {
            showCustomAlert("সবগুলো ঘর পূরণ করুন।");
            return;
        }

        let n = tenureTypeInput.value === 'years' ? tenureValue * 12 : tenureValue; // Months
        let r = annualRate / 12 / 100; // Monthly interest rate

        // EMI Formula: E = P * r * (1+r)^n / ((1+r)^n - 1)
        let emi = (P * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
        let totalPayment = emi * n;
        let totalInterest = totalPayment - P;

        document.getElementById('emiMonthly').textContent = `৳ ${Math.round(emi).toLocaleString('bn-BD')}`;
        document.getElementById('emiTotalInterest').textContent = `৳ ${Math.round(totalInterest).toLocaleString('bn-BD')}`;
        document.getElementById('emiTotalPayment').textContent = `৳ ${Math.round(totalPayment).toLocaleString('bn-BD')}`;
        
        resultDiv.classList.remove('hidden');
    });
}
// ====================================================================
// END: EMI CALCULATOR SCRIPT
// ====================================================================

// ====================================================================
// START: IP & DEVICE INFO SCRIPT
// ====================================================================
function initializeIpInfo() {
    const ipLoading = document.getElementById('ipLoading');
    const resultDiv = document.getElementById('ipInfoResult');
    const errorDiv = document.getElementById('ipErrorDisplay');
    const refreshBtn = document.getElementById('refreshIpBtn');

    if (!refreshBtn) return;

    async function fetchInfo() {
        ipLoading.classList.remove('hidden');
        resultDiv.classList.add('hidden');
        if (errorDiv) errorDiv.classList.add('hidden');

        try {
            // উইন্ডোজ ক্রোমে অনেক সময় ipapi.co ব্লক থাকে, তাই ফলব্যাক রাখা হলো
            let data;
            try {
                const res = await fetch('https://ipapi.co/json/');
                if (!res.ok) throw new Error('Primary API Failed');
                data = await res.json();
            } catch (primaryError) {
                console.warn("Primary IP API failed, trying fallback...", primaryError);
                // Fallback API (ip-api.com) - এটি http/https মিক্সড কন্টেন্ট ইস্যু করতে পারে যদি সাইট https হয়, তবে এটি ফ্রি এবং নির্ভরযোগ্য
                // অন্যথায় api.db-ip.com ব্যবহার করা যেতে পারে
                const res = await fetch('https://api.db-ip.com/v2/free/self');
                const fallbackData = await res.json();
                // ডেটা ফরম্যাট মিলানো
                data = {
                    ip: fallbackData.ipAddress,
                    city: fallbackData.city,
                    country_name: fallbackData.countryName,
                    org: "N/A (Fallback)"
                };
            }

            document.getElementById('infoIp').textContent = data.ip || 'N/A';
            document.getElementById('infoIsp').textContent = data.org || data.asn || 'N/A';
            document.getElementById('infoLoc').textContent = `${data.city || ''}, ${data.country_name || ''}`;

            // Device Info
            let os = "Unknown OS";
            if (navigator.userAgent.indexOf("Win") != -1) os = "Windows";
            if (navigator.userAgent.indexOf("Mac") != -1) os = "MacOS";
            if (navigator.userAgent.indexOf("Linux") != -1) os = "Linux";
            if (navigator.userAgent.indexOf("Android") != -1) os = "Android";
            if (navigator.userAgent.indexOf("like Mac") != -1) os = "iOS";

            document.getElementById('infoOs').textContent = os;
            document.getElementById('infoBrowser').textContent = navigator.userAgentData?.brands[0]?.brand || "Browser";
            document.getElementById('infoRes').textContent = `${window.screen.width} x ${window.screen.height}`;
            document.getElementById('infoUa').textContent = navigator.userAgent;

            ipLoading.classList.add('hidden');
            resultDiv.classList.remove('hidden');

        } catch (e) {
            console.error(e);
            ipLoading.classList.add('hidden');
            if (errorDiv) {
                errorDiv.classList.remove('hidden');
                errorDiv.innerHTML = `তথ্য লোড করা সম্ভব হয়নি। আপনার ব্রাউজারে Adblocker বা Privacy Extension চালু থাকলে তা বন্ধ করে চেষ্টা করুন।<br>Error: ${e.message}`;
            } else {
                // Fallback if errorDiv doesn't exist
                showCustomAlert("আইপি তথ্য লোড করা যায়নি (Adblocker চালু থাকতে পারে)।");
            }
        }
    }

    refreshBtn.addEventListener('click', fetchInfo);
    // Auto load on init call is handled in showTab logic
    window.fetchIpInfo = fetchInfo; 
}
// ====================================================================
// END: IP & DEVICE INFO SCRIPT
// ====================================================================

// ====================================================================
// START: RECIPE GENERATOR SCRIPT (Updated)
// ====================================================================
function initializeRecipeGenerator() {
    const input = document.getElementById('recipeInput');
    const btn = document.getElementById('generateRecipeBtn');
    const resultDiv = document.getElementById('recipeResult');
    const loading = document.getElementById('recipeLoading');

    if (!btn) return;

    btn.addEventListener('click', async () => {
        let ingredients = input.value.trim();
        const apiKey = localStorage.getItem('geminiApiKey');
        
        if (!apiKey) return showCustomAlert("অনুগ্রহ করে সেটিংসে জেমিনি API কী সেট করুন।");

        loading.classList.remove('hidden');
        resultDiv.classList.add('hidden');
        btn.disabled = true;

        let prompt;
        // যদি ইনপুট খালি থাকে, তবে র্যান্ডম রেসিপি
        if (!ingredients) {
            prompt = `Suggest a random, delicious, and popular Bengali recipe. Provide the recipe name, cooking time, and step-by-step instructions in Bengali language using Markdown formatting. Make it a surprise!`;
            // ইউজারকে জানানো যে র্যান্ডম রেসিপি তৈরি হচ্ছে
            showCustomAlert("কোনো উপকরণ দেননি, তাই একটি স্পেশাল র্যান্ডম রেসিপি তৈরি করা হচ্ছে!");
        } else {
            prompt = `Create a delicious Bengali recipe using these ingredients: ${ingredients}. Provide the recipe name, cooking time, and step-by-step instructions in Bengali language using Markdown formatting.`;
        }

        try {
            const model = localStorage.getItem('geminiModel') || "gemini-flash-latest";
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (text) {
                // Simple Markdown to HTML
                const htmlText = text
                    .replace(/^# (.*$)/gim, '<h2 class="text-xl font-bold mb-2">$1</h2>')
                    .replace(/^## (.*$)/gim, '<h3 class="text-lg font-bold mt-3 mb-1">$1</h3>')
                    .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                    .replace(/\n/gim, '<br>');
                
                resultDiv.innerHTML = htmlText;
                resultDiv.classList.remove('hidden');
            } else {
                throw new Error("No recipe found");
            }
        } catch (e) {
            showCustomAlert("রেসিপি তৈরি করতে সমস্যা হয়েছে।");
            console.error(e);
        } finally {
            loading.classList.add('hidden');
            btn.disabled = false;
        }
    });
}
// ====================================================================
// END: RECIPE GENERATOR SCRIPT
// ====================================================================

// ====================================================================
// START: PDF TOOLS SCRIPT (Updated with Drag & Drop Sort)
// ====================================================================
function initializePdfTools() {
    const input = document.getElementById('pdfImageInput');
    const dropZone = document.getElementById('pdfDropZone');
    const previewArea = document.getElementById('pdfPreviewArea');
    const generateBtn = document.getElementById('generatePdfBtn');
    
    // ছবিগুলো মেমোরিতে রাখার জন্য অ্যারে
    let pdfImages = [];
    let draggedItemIndex = null;

    if (!input || !dropZone) return;

    // ফাইল হ্যান্ডলার
    const handleFiles = (files) => {
        const fileList = Array.from(files);
        if (fileList.length === 0) return;

        fileList.forEach(file => {
            if (!file.type.startsWith('image/')) return;

            const reader = new FileReader();
            reader.onload = (ev) => {
                const imgData = ev.target.result;
                pdfImages.push({
                    id: Date.now() + Math.random(),
                    data: imgData
                });
                renderPreviews();
            };
            reader.readAsDataURL(file);
        });
    };

    // প্রিভিউ রেন্ডার এবং ড্রাগ লজিক
    const renderPreviews = () => {
        previewArea.innerHTML = '';
        if (pdfImages.length === 0) {
            generateBtn.disabled = true;
            generateBtn.classList.add('opacity-50', 'cursor-not-allowed');
            return;
        }

        generateBtn.disabled = false;
        generateBtn.classList.remove('opacity-50', 'cursor-not-allowed');

        pdfImages.forEach((imgObj, index) => {
            const imgDiv = document.createElement('div');
            // ক্লাস এবং সিরিয়াল ডেটা অ্যাট্রিবিউট যোগ করা হয়েছে
            imgDiv.className = "pdf-preview-item relative h-24 border rounded overflow-hidden group";
            imgDiv.setAttribute('draggable', true);
            imgDiv.dataset.index = index;
            imgDiv.setAttribute('data-serial', `Image ${index + 1}`); // হোভার সিরিয়াল

            imgDiv.innerHTML = `
                <img src="${imgObj.data}" class="w-full h-full object-cover pointer-events-none">
                <button class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity z-10" data-action="remove" data-index="${index}">
                    &times;
                </button>
            `;
            
            // রিমুভ বাটনে ইভেন্ট
            imgDiv.querySelector('button').addEventListener('click', (e) => {
                e.stopPropagation(); // ড্রাগ ইভেন্ট যাতে ট্রিগার না হয়
                const idx = parseInt(e.target.dataset.index);
                pdfImages.splice(idx, 1);
                renderPreviews();
            });

            // ড্রাগ ইভেন্ট লিসেনার
            imgDiv.addEventListener('dragstart', (e) => {
                draggedItemIndex = index;
                imgDiv.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            imgDiv.addEventListener('dragend', () => {
                imgDiv.classList.remove('dragging');
                draggedItemIndex = null;
            });

            imgDiv.addEventListener('dragover', (e) => {
                e.preventDefault(); // ড্রপ করার অনুমতি দেয়
                e.dataTransfer.dropEffect = 'move';
            });

            imgDiv.addEventListener('drop', (e) => {
                e.preventDefault();
                if (draggedItemIndex === null || draggedItemIndex === index) return;

                // অ্যারে রি-অ্যারেঞ্জ করা
                const itemToMove = pdfImages[draggedItemIndex];
                pdfImages.splice(draggedItemIndex, 1);
                pdfImages.splice(index, 0, itemToMove);
                
                renderPreviews(); // নতুন অর্ডারে রেন্ডার
            });

            previewArea.appendChild(imgDiv);
        });
    };

    // ইনপুট চেঞ্জ ইভেন্ট
    input.addEventListener('change', (e) => handleFiles(e.target.files));

    // ড্রপজোন ড্র্যাগ অ্যান্ড ড্রপ ইভেন্ট (ফাইল আপলোডের জন্য)
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.add('bg-blue-50', 'dark:bg-gray-600'));
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.remove('bg-blue-50', 'dark:bg-gray-600'));
    });

    dropZone.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files));

    // পিডিএফ জেনারেট বাটন
    generateBtn.addEventListener('click', () => {
        const { jsPDF } = window.jspdf;
        if (!jsPDF) return showCustomAlert("PDF লাইব্রেরি লোড হয়নি। ইন্টারনেট চেক করুন।");

        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        pdfImages.forEach((imgObj, index) => {
            if (index > 0) doc.addPage();
            
            const imgData = imgObj.data;
            const imgProps = doc.getImageProperties(imgData);
            const ratio = imgProps.width / imgProps.height;
            
            let w = pageWidth - 20; // 10mm margin
            let h = w / ratio;

            if (h > pageHeight - 20) {
                h = pageHeight - 20;
                w = h * ratio;
            }

            const x = (pageWidth - w) / 2;
            const y = (pageHeight - h) / 2;

            doc.addImage(imgData, 'JPEG', x, y, w, h);
        });

        doc.save('bangla-toolbox-images.pdf');
        showCustomAlert("পিডিএফ ডাউনলোড শুরু হয়েছে!");
    });
}
// ====================================================================
// END: PDF TOOLS SCRIPT
// ====================================================================

// ========================================================
// START: Barcode Generator Function
// ========================================================
function initializeBarcodeGenerator() {
    const input = document.getElementById('barcodeInput');
    const formatSelect = document.getElementById('barcodeFormat');
    const colorInput = document.getElementById('barcodeColor');
    const showTextCheck = document.getElementById('showBarcodeText');
    const generateBtn = document.getElementById('generateBarcodeBtn');
    const downloadBtn = document.getElementById('downloadBarcodeBtn');
    const resultArea = document.getElementById('barcodeResultArea');
    const svgElement = document.getElementById('barcodeCanvas');

    if (!generateBtn) return;

    generateBtn.onclick = () => {
        const text = input.value.trim();
        if (!text) return showCustomAlert('দয়া করে টেক্সট বা নম্বর লিখুন।');

        resultArea.classList.remove('hidden');
        
        try {
            JsBarcode("#barcodeCanvas", text, {
                format: formatSelect.value,
                lineColor: colorInput.value,
                width: 2,
                height: 100,
                displayValue: showTextCheck.checked,
                background: "#ffffff", // সাদা ব্যাকগ্রাউন্ড ডাউনলোড এর সুবিধার জন্য
                margin: 10
            });
        } catch (e) {
            showCustomAlert('কোড জেনারেট করতে সমস্যা হয়েছে। ইনপুট ফরম্যাট চেক করুন।');
            resultArea.classList.add('hidden');
        }
    };

    downloadBtn.onclick = () => {
        // SVG থেকে ইমেজ কনভার্সন
        const svgData = new XMLSerializer().serializeToString(svgElement);
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        const img = new Image();
        
        // SVG এলিমেন্টের সাইজ নেওয়া
        const svgSize = svgElement.getBoundingClientRect();
        canvas.width = svgSize.width;
        canvas.height = svgSize.height;

        img.setAttribute("src", "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svgData))));
        
        img.onload = function() {
            ctx.drawImage(img, 0, 0);
            const imgURL = canvas.toDataURL("image/png");
            
            const dlLink = document.createElement('a');
            dlLink.download = `barcode-${input.value}.png`;
            dlLink.href = imgURL;
            document.body.appendChild(dlLink);
            dlLink.click();
            document.body.removeChild(dlLink);
        };
    };
}
// ========================================================
// END: Barcode Generator Function
// ========================================================

// ========================================================
// START: Random Picker Function
// ========================================================
function initializeRandomPicker() {
    const input = document.getElementById('pickerInput');
    const startBtn = document.getElementById('startPickerBtn');
    const sampleBtn = document.getElementById('addSampleDataBtn');
    const clearBtn = document.getElementById('clearPickerBtn');
    const resultArea = document.getElementById('pickerResultArea');
    const winnerDisplay = document.getElementById('pickerWinner');

    if (!startBtn) return;

    sampleBtn.onclick = () => {
        input.value = "করিম\nরহিম\nসাকিব\nতামিম\nমাশরাফি\nমুশফিক";
    };

    clearBtn.onclick = () => {
        input.value = "";
        resultArea.classList.add('hidden');
    };

    startBtn.onclick = () => {
        const items = input.value.split('\n').map(item => item.trim()).filter(item => item !== "");
        
        if (items.length < 2) {
            return showCustomAlert('লটারির জন্য অন্তত দুটি নাম লিখুন।');
        }

        resultArea.classList.remove('hidden');
        startBtn.disabled = true;
        winnerDisplay.classList.remove('text-purple-600', 'dark:text-purple-300');
        winnerDisplay.classList.add('text-gray-400');
        
        // শাফলিং এনিমেশন ইফেক্ট
        let counter = 0;
        const shuffleInterval = setInterval(() => {
            const randomPreview = items[Math.floor(Math.random() * items.length)];
            winnerDisplay.textContent = randomPreview;
            counter++;
            
            if (counter > 20) { // ২০ বার নাম পরিবর্তনের পর থামবে
                clearInterval(shuffleInterval);
                const finalWinner = items[Math.floor(Math.random() * items.length)];
                winnerDisplay.textContent = finalWinner;
                winnerDisplay.classList.remove('text-gray-400');
                winnerDisplay.classList.add('text-purple-600', 'dark:text-purple-300');
                
                // কনফেটি বা জাঁকজমক ইফেক্ট (সিম্পল ইমোজি ব্যবহার করে)
                showCustomAlert(`🎉 অভিনন্দন! বিজয়ী: ${finalWinner} 🎉`);
                startBtn.disabled = false;
            }
        }, 100); // প্রতি ১০০ms এ নাম পরিবর্তন
    };
}
// ========================================================
// END: Random Picker Function
// ========================================================

// ========================================================
// START: Unit Price Comparator Function
// ========================================================
function initializeUnitPriceComparator() {
    const priceAInput = document.getElementById('priceA');
    const qtyAInput = document.getElementById('qtyA');
    const priceBInput = document.getElementById('priceB');
    const qtyBInput = document.getElementById('qtyB');
    const compareBtn = document.getElementById('comparePriceBtn');
    const resultDiv = document.getElementById('compareResult');
    const winnerTitle = document.getElementById('winnerTitle');
    const savingsText = document.getElementById('savingsText');
    const unitPriceAEl = document.getElementById('unitPriceA');
    const unitPriceBEl = document.getElementById('unitPriceB');

    if (!compareBtn) return;

    compareBtn.onclick = () => {
        const priceA = parseFloat(priceAInput.value);
        const qtyA = parseFloat(qtyAInput.value);
        const priceB = parseFloat(priceBInput.value);
        const qtyB = parseFloat(qtyBInput.value);

        if (!priceA || !qtyA || !priceB || !qtyB) {
            showCustomAlert('অনুগ্রহ করে সবগুলোর দাম ও পরিমাণ লিখুন।');
            resultDiv.classList.add('hidden');
            return;
        }

        // প্রতি ইউনিটের দাম বের করা
        const unitPriceA = priceA / qtyA;
        const unitPriceB = priceB / qtyB;

        unitPriceAEl.textContent = unitPriceA.toFixed(4);
        unitPriceBEl.textContent = unitPriceB.toFixed(4);

        resultDiv.classList.remove('hidden', 'bg-green-100', 'border-green-300', 'bg-purple-100', 'border-purple-300', 'bg-gray-100', 'border-gray-300', 'dark:bg-green-900', 'dark:border-green-700', 'dark:bg-purple-900', 'dark:border-purple-700');

        if (unitPriceA < unitPriceB) {
            // পণ্য ১ লাভজনক
            const savings = ((unitPriceB - unitPriceA) / unitPriceB) * 100;
            resultDiv.classList.add('bg-blue-100', 'border-blue-300', 'dark:bg-blue-900', 'dark:border-blue-700');
            winnerTitle.innerHTML = '🎉 পণ্য ১ বেশি লাভজনক!';
            winnerTitle.className = 'text-2xl font-bold mb-2 text-blue-700 dark:text-blue-300';
            // ফিক্স: ব্যাকটিক (`) যোগ করা হয়েছে
            savingsText.innerHTML = `পণ্য ১ কিনলে আপনি প্রায় <b>${savings.toFixed(2)}%</b> সাশ্রয় করবেন।`;
        } else if (unitPriceB < unitPriceA) {
            // পণ্য ২ লাভজনক
            const savings = ((unitPriceA - unitPriceB) / unitPriceA) * 100;
            resultDiv.classList.add('bg-purple-100', 'border-purple-300', 'dark:bg-purple-900', 'dark:border-purple-700');
            winnerTitle.innerHTML = '🎉 পণ্য ২ বেশি লাভজনক!';
            winnerTitle.className = 'text-2xl font-bold mb-2 text-purple-700 dark:text-purple-300';
            // ফিক্স: ব্যাকটিক (`) যোগ করা হয়েছে
            savingsText.innerHTML = `পণ্য ২ কিনলে আপনি প্রায় <b>${savings.toFixed(2)}%</b> সাশ্রয় করবেন।`;
        } else {
            // সমান
            resultDiv.classList.add('bg-gray-100', 'border-gray-300', 'dark:bg-gray-700', 'dark:border-gray-500');
            winnerTitle.innerHTML = 'সমান সমান!';
            winnerTitle.className = 'text-2xl font-bold mb-2 text-gray-700 dark:text-gray-300';
            savingsText.innerHTML = 'দুটি পণ্যের দামের হার একদম সমান। যেকোনোটি কিনতে পারেন।';
        }
    };
}
// ========================================================
// END: Unit Price Comparator Function
// ========================================================

// ========================================================
// START: Modern Digital Tasbeeh Script (Multi-user)
// ========================================================
function initializeTasbeeh() {
    const displayArea = document.getElementById('tasbeehDisplayArea');
    const displayCount = document.getElementById('tasbeehCountDisplay');
    const currentProfileNameEl = document.getElementById('currentProfileName');
    
    // Controls
    const resetBtn = document.getElementById('tasbeehResetBtn');
    const undoBtn = document.getElementById('tasbeehUndoBtn');
    const redoBtn = document.getElementById('tasbeehRedoBtn');
    const manualInput = document.getElementById('tasbeehManualInput');
    const setBtn = document.getElementById('tasbeehSetBtn');
    
    // User Management
    const toggleUserListBtn = document.getElementById('toggleUserListBtn');
    const userSection = document.getElementById('tasbeehUserSection');
    const newProfileInput = document.getElementById('newProfileName');
    const addProfileBtn = document.getElementById('addProfileBtn');
    const profilesListEl = document.getElementById('tasbeehProfilesList');

    if (!displayArea) return;

    // State Variables
    let profiles = [];
    let activeProfileId = null;
    let history = []; // Session based history for undo/redo
    let historyIndex = -1;

    // --- Helper: Convert Number to Bengali ---
    const toBengali = (num) => {
        return num.toLocaleString('bn-BD');
    };

    // --- Database Operations ---
    async function loadProfiles() {
        try {
            const storedProfiles = await idbGet('tasbeeh_profiles_v2');
            if (storedProfiles && Array.isArray(storedProfiles) && storedProfiles.length > 0) {
                profiles = storedProfiles;
            } else {
                // Default Profile creation if none exists
                profiles = [{ id: Date.now(), name: 'আমার তাসবিহ', count: 0 }];
                await saveProfiles();
            }
            
            // Load last active ID
            const lastActive = await idbGet('tasbeeh_active_id');
            if (lastActive && profiles.find(p => p.id === lastActive)) {
                activeProfileId = lastActive;
            } else {
                activeProfileId = profiles[0].id;
            }
            
            renderUI();
        } catch (e) {
            console.error("Tasbeeh load error:", e);
        }
    }

    async function saveProfiles() {
        await idbSet('tasbeeh_profiles_v2', profiles);
    }

    async function saveActiveId() {
        await idbSet('tasbeeh_active_id', activeProfileId);
    }

    // --- Logic Functions ---
    function getActiveProfile() {
        return profiles.find(p => p.id === activeProfileId);
    }

    function renderUI() {
        const activeProfile = getActiveProfile();
        if (!activeProfile) return;

        // Update Main Display
        displayCount.innerText = toBengali(activeProfile.count);
        currentProfileNameEl.innerText = activeProfile.name;
        manualInput.value = activeProfile.count;

        // Update Buttons
        undoBtn.disabled = historyIndex <= 0;
        redoBtn.disabled = historyIndex >= history.length - 1;

        // Render List
        renderProfileList();
    }

    function renderProfileList() {
        profilesListEl.innerHTML = '';
        profiles.forEach(profile => {
            const div = document.createElement('div');
            const isActive = profile.id === activeProfileId;
            div.className = `user-card ${isActive ? 'active-user' : ''}`;
            
            div.innerHTML = `
                <div class="user-info flex-grow" onclick="switchProfile(${profile.id})">
                    <h4>${profile.name}</h4>
                    <p>গণনা: ${toBengali(profile.count)}</p>
                </div>
                <div class="user-actions flex gap-1">
                    <button onclick="editProfileName(${profile.id})" class="text-blue-500 hover:text-blue-700" title="নাম পরিবর্তন">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                    </button>
                    ${profiles.length > 1 ? `
                    <button onclick="deleteProfile(${profile.id})" class="text-red-500 hover:text-red-700" title="মুছুন">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>` : ''}
                </div>
            `;
            profilesListEl.appendChild(div);
        });
    }

    // --- Actions ---
    
    // Global functions for HTML inline onclick access
    window.switchProfile = (id) => {
        if (activeProfileId === id) return;
        activeProfileId = id;
        saveActiveId();
        // Reset session history on switch
        history = [getActiveProfile().count];
        historyIndex = 0;
        renderUI();
        
        // Mobile view: close list after selection
        if (window.innerWidth < 1024) {
            userSection.classList.add('hidden');
        }
    };

    window.deleteProfile = async (id) => {
        if (confirm("আপনি কি নিশ্চিত যে এই প্রোফাইলটি মুছে ফেলতে চান?")) {
            profiles = profiles.filter(p => p.id !== id);
            // If deleted active profile, switch to the first one available
            if (activeProfileId === id) {
                activeProfileId = profiles[0].id;
                history = [profiles[0].count];
                historyIndex = 0;
                saveActiveId();
            }
            await saveProfiles();
            renderUI();
            showCustomAlert('প্রোফাইল মুছে ফেলা হয়েছে।');
        }
    };

    window.editProfileName = async (id) => {
        const profile = profiles.find(p => p.id === id);
        const newName = prompt("নতুন নাম লিখুন:", profile.name);
        if (newName && newName.trim() !== "") {
            profile.name = newName.trim();
            await saveProfiles();
            renderUI();
        }
    };

    function addToHistory(countVal) {
        if (historyIndex < history.length - 1) {
            history = history.slice(0, historyIndex + 1);
        }
        history.push(countVal);
        // Limit history depth
        if (history.length > 50) history.shift();
        else historyIndex++;
    }

    function increment() {
        const profile = getActiveProfile();
        if (!profile) return;

        profile.count++;
        addToHistory(profile.count);
        saveProfiles();
        renderUI();

        // Animation
        displayArea.classList.remove('pulse-animation');
        void displayArea.offsetWidth; // trigger reflow
        displayArea.classList.add('pulse-animation');
        
        if (navigator.vibrate) navigator.vibrate(30);
    }

    function createNewProfile() {
        const name = newProfileInput.value.trim();
        if (!name) return showCustomAlert("অনুগ্রহ করে একটি নাম লিখুন।");

        const newProfile = {
            id: Date.now(),
            name: name,
            count: 0
        };
        profiles.push(newProfile);
        saveProfiles();
        
        // Switch to new profile
        activeProfileId = newProfile.id;
        saveActiveId();
        history = [0];
        historyIndex = 0;
        
        newProfileInput.value = '';
        renderUI();
        showCustomAlert("নতুন প্রোফাইল তৈরি হয়েছে!");
    }

    // --- Event Listeners ---
    
    displayArea.onclick = increment;
    
    resetBtn.onclick = async () => {
        if (confirm("গণনা রিসেট করতে চান?")) {
            const profile = getActiveProfile();
            profile.count = 0;
            addToHistory(0);
            await saveProfiles();
            renderUI();
        }
    };

    setBtn.onclick = async () => {
        const val = parseInt(manualInput.value, 10);
        if (!isNaN(val) && val >= 0) {
            const profile = getActiveProfile();
            profile.count = val;
            addToHistory(val);
            await saveProfiles();
            renderUI();
            showCustomAlert('সংখ্যা আপডেট করা হয়েছে।');
        }
    };

    undoBtn.onclick = async () => {
        if (historyIndex > 0) {
            historyIndex--;
            const val = history[historyIndex];
            const profile = getActiveProfile();
            profile.count = val;
            await saveProfiles();
            renderUI();
        }
    };

    redoBtn.onclick = async () => {
        if (historyIndex < history.length - 1) {
            historyIndex++;
            const val = history[historyIndex];
            const profile = getActiveProfile();
            profile.count = val;
            await saveProfiles();
            renderUI();
        }
    };

    addProfileBtn.onclick = createNewProfile;
    
    // Toggle User List (Mobile)
    toggleUserListBtn.onclick = () => {
        userSection.classList.toggle('hidden');
    };

    // Keyboard Shortcut (Spacebar)
    if (!window.tasbeehKeyboardListenerAdded) {
        document.addEventListener('keydown', (e) => {
            const content = document.getElementById('tasbeehContent');
            if (content && content.classList.contains('active') && e.target.tagName !== 'INPUT') {
                if (e.code === 'Space') {
                    e.preventDefault();
                    increment();
                }
            }
        });
        window.tasbeehKeyboardListenerAdded = true;
    }

    // Initial Load
    loadProfiles().then(() => {
        // Initialize history with current count
        const p = getActiveProfile();
        if(p) {
            history = [p.count];
            historyIndex = 0;
            renderUI();
        }
    });
}
// ========================================================
// END: Digital Tasbeeh Script
// ========================================================

// ========================================================
// START: Advanced Diff Checker Logic (Modern Side-by-Side & Combined)
// ========================================================
function initializeDiffChecker() {
    const compareBtn = document.getElementById('compareDiffBtn');
    const clearBtn = document.getElementById('clearDiffBtn');
    const backBtn = document.getElementById('backToDiffInputBtn');
    const input1 = document.getElementById('diffInput1');
    const input2 = document.getElementById('diffInput2');
    
    const resultContainer = document.getElementById('diffResultContainer');
    const inputContainer = document.getElementById('diffInputContainer');
    
    const outputOld = document.getElementById('diffOutputOld');
    const outputNew = document.getElementById('diffOutputNew');
    const outputCombined = document.getElementById('diffOutputCombined'); // নতুন কম্বাইন্ড আউটপুট

    if (!compareBtn) return;

    // ক্লিয়ার বাটন
    clearBtn.onclick = () => {
        input1.value = '';
        input2.value = '';
        resultContainer.classList.add('hidden');
        inputContainer.classList.remove('hidden');
        showCustomAlert('টেক্সটবক্স পরিষ্কার করা হয়েছে।');
    };

    // ব্যাক বাটন
    backBtn.onclick = () => {
        resultContainer.classList.add('hidden');
        inputContainer.classList.remove('hidden');
    };

    // তুলনা বাটন (Main Logic)
    compareBtn.onclick = () => {
        const text1 = input1.value;
        const text2 = input2.value;

        if (!text1 && !text2) {
            return showCustomAlert('অনুগ্রহ করে তুলনা করার জন্য টেক্সট লিখুন।');
        }

        // Google diff-match-patch ব্যবহার
        const dmp = new diff_match_patch();
        const diffs = dmp.diff_main(text1, text2);
        
        // শব্দ অনুযায়ী ক্লিনআপ (যাতে ক্যারেক্টার লেভেলে হিজিবিজি না দেখায়)
        dmp.diff_cleanupSemantic(diffs);

        // HTML তৈরি করা
        let htmlOld = [];
        let htmlNew = [];
        let htmlCombined = []; // নতুন কম্বাইন্ড ভিউ এর জন্য অ্যারে

        diffs.forEach(part => {
            const type = part[0]; // -1 (delete), 0 (equal), 1 (insert)
            let text = part[1];
            
            // HTML Escape (নিরাপত্তার জন্য)
            text = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            
            // নতুন লাইন হ্যান্ডলিং (ভিজুয়ালি সুন্দর দেখানোর জন্য)
            const formattedText = text.replace(/\n/g, '<br>');

            if (type === 0) { 
                // Equal (উভয় পাশে এবং কম্বাইন্ডে থাকবে)
                htmlOld.push(`<span>${formattedText}</span>`);
                htmlNew.push(`<span>${formattedText}</span>`);
                htmlCombined.push(`<span>${formattedText}</span>`);
            } else if (type === -1) { 
                // Delete (বাম পাশে এবং কম্বাইন্ডে লাল হয়ে থাকবে)
                htmlOld.push(`<span class="diff-removed">${formattedText}</span>`);
                // ডান পাশে দেখাবে না
                htmlCombined.push(`<span class="diff-removed">${formattedText}</span>`);
            } else if (type === 1) { 
                // Insert (ডান পাশে এবং কম্বাইন্ডে সবুজ হয়ে থাকবে)
                // বাম পাশে দেখাবে না
                htmlNew.push(`<span class="diff-added">${formattedText}</span>`);
                htmlCombined.push(`<span class="diff-added">${formattedText}</span>`);
            }
        });

        outputOld.innerHTML = htmlOld.join('');
        outputNew.innerHTML = htmlNew.join('');
        outputCombined.innerHTML = htmlCombined.join(''); // কম্বাইন্ড রেজাল্ট সেট করা
        
        // ভিউ সুইচ করা
        inputContainer.classList.add('hidden');
        resultContainer.classList.remove('hidden');
    };
}
// ========================================================
// END: Advanced Diff Checker Logic
// ========================================================

// ========================================================
// START: Expense Tracker Script (Updated with Edit & Clear Chart)
// ========================================================
function initializeExpenseTracker() {
    const balanceEl = document.getElementById('expBalance');
    const incomeEl = document.getElementById('expTotalIncome');
    const expenseEl = document.getElementById('expTotalExpense');
    const listEl = document.getElementById('transactionList');
    const formBtn = document.getElementById('addTransactionBtn');
    const clearBtn = document.getElementById('clearAllTransBtn');
    const dateInput = document.getElementById('expDate');
    const chartCanvas = document.getElementById('expenseChart');

    // ইনপুট ফিল্ডস
    const descInput = document.getElementById('expDesc');
    const amountInput = document.getElementById('expAmount');
    const categoryInput = document.getElementById('expCategory');
    const typeInputs = document.getElementsByName('transType');

    // চার্ট ইন্সট্যান্স রাখার জন্য
    let expenseChartInstance = null;

    // ডিফল্ট ডেট আজকের দিন সেট করা
    if(dateInput && !dateInput.value) {
        dateInput.valueAsDate = new Date();
    }

    // ডাটা লোড করা এবং UI আপডেট করা
    async function loadAndRender() {
        const transactions = await idbGet('expense_transactions') || [];
        updateValues(transactions);
        renderList(transactions);
        renderChart(transactions);
    }

    // মোট হিসাব আপডেট করা
    function updateValues(transactions) {
        const amounts = transactions.map(t => t.type === 'income' ? t.amount : -t.amount);
        
        const total = amounts.reduce((acc, item) => acc + item, 0);
        const income = amounts.filter(item => item > 0).reduce((acc, item) => acc + item, 0);
        const expense = (amounts.filter(item => item < 0).reduce((acc, item) => acc + item, 0) * -1);

        if(balanceEl) balanceEl.innerText = `৳ ${total.toLocaleString('bn-BD')}`;
        if(incomeEl) incomeEl.innerText = `৳ ${income.toLocaleString('bn-BD')}`;
        if(expenseEl) expenseEl.innerText = `৳ ${expense.toLocaleString('bn-BD')}`;
    }

    // তালিকা রেন্ডার করা (এডিট বাটন সহ)
    function renderList(transactions) {
        if(!listEl) return;
        listEl.innerHTML = '';

        if (transactions.length === 0) {
            listEl.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">কোনো লেনদেন নেই।</p>';
            return;
        }

        // নতুন থেকে পুরাতন সাজানো
        const sortedTrans = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

        sortedTrans.forEach(t => {
            const item = document.createElement('div');
            const isIncome = t.type === 'income';
            const sign = isIncome ? '+' : '-';
            const borderClass = isIncome ? 'border-l-4 border-green-500' : 'border-l-4 border-red-500';
            const textClass = isIncome ? 'text-green-600' : 'text-red-600';

            item.className = `bg-white dark:bg-gray-700 p-3 rounded shadow-sm flex justify-between items-center ${borderClass}`;
            
            // এডিট বাটন যোগ করা হয়েছে
            item.innerHTML = `
                <div>
                    <h5 class="font-bold text-gray-800 dark:text-gray-100">${t.desc}</h5>
                    <p class="text-xs text-gray-500 dark:text-gray-400">${t.date} | ${getCategoryBangla(t.category)}</p>
                </div>
                <div class="text-right">
                    <p class="font-bold ${textClass}">${sign}৳${t.amount.toLocaleString('bn-BD')}</p>
                    <div class="flex gap-2 justify-end mt-1">
                        <button class="text-xs text-blue-500 hover:text-blue-700 edit-btn" data-id="${t.id}">এডিট</button>
                        <button class="text-xs text-red-400 hover:text-red-500 delete-btn" data-id="${t.id}">&times; মুছুন</button>
                    </div>
                </div>
            `;
            
            // এডিট ইভেন্ট
            item.querySelector('.edit-btn').addEventListener('click', async (e) => {
                e.stopPropagation();
                // ইনপুট ফিল্ডে মান বসানো
                descInput.value = t.desc;
                amountInput.value = t.amount;
                categoryInput.value = t.category;
                dateInput.value = t.date;
                // রেডিও বাটন সেট করা
                for (const radio of typeInputs) {
                    if (radio.value === t.type) radio.checked = true;
                }

                // ডাটাবেস থেকে সরানো (যাতে আপডেটের মতো কাজ করে)
                // ব্যবহারকারী "লেনদেন যুক্ত করুন" ক্লিক করলে এটি নতুন করে সেভ হবে
                const newTrans = transactions.filter(tr => tr.id !== t.id);
                await idbSet('expense_transactions', newTrans);
                
                loadAndRender();
                showCustomAlert('তথ্য এডিট মোডে নেওয়া হয়েছে। পরিবর্তন করে "লেনদেন যুক্ত করুন" বাটনে ক্লিক করুন।');
                // স্ক্রল করে উপরে ফর্মের কাছে নিয়ে যাওয়া
                document.querySelector('.bg-gray-50.dark\\:bg-gray-800')?.scrollIntoView({ behavior: 'smooth' });
            });

            // ডিলেট ইভেন্ট
            item.querySelector('.delete-btn').addEventListener('click', async (e) => {
                e.stopPropagation();
                if(confirm('এই লেনদেনটি মুছে ফেলতে চান?')) {
                    const newTrans = transactions.filter(tr => tr.id !== t.id);
                    await idbSet('expense_transactions', newTrans);
                    loadAndRender();
                }
            });

            listEl.appendChild(item);
        });
    }

    // চার্ট রেন্ডার করা (Pie Chart)
    function renderChart(transactions) {
        if (!chartCanvas || typeof Chart === 'undefined') return;

        const income = transactions.filter(t => t.type === 'income').reduce((acc, t) => acc + t.amount, 0);
        const expense = transactions.filter(t => t.type === 'expense').reduce((acc, t) => acc + t.amount, 0);

        if (expenseChartInstance) {
            expenseChartInstance.destroy();
        }

        // যদি ডাটা না থাকে
        if (income === 0 && expense === 0) return;

        expenseChartInstance = new Chart(chartCanvas, {
            type: 'doughnut',
            data: {
                labels: ['আয়', 'ব্যয়'],
                datasets: [{
                    data: [income, expense],
                    backgroundColor: ['#10b981', '#ef4444'], // Green, Red
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#374151' }
                    }
                }
            }
        });
    }

    // ক্যাটাগরি বাংলায় দেখানোর হেল্পার
    function getCategoryBangla(cat) {
        const map = { 'Food': 'খাবার', 'Transport': 'যাতায়াত', 'Shopping': 'কেনাকাটা', 'Bills': 'বিল', 'Salary': 'বেতন', 'Others': 'অন্যান্য' };
        return map[cat] || cat;
    }

    // নতুন লেনদেন যোগ করা
    if(formBtn) {
        formBtn.onclick = async () => {
            const desc = descInput.value.trim();
            const amount = parseFloat(amountInput.value);
            const category = categoryInput.value;
            const date = dateInput.value;
            
            let type = 'expense';
            for (const radio of typeInputs) {
                if (radio.checked) {
                    type = radio.value;
                    break;
                }
            }

            if (desc === '' || isNaN(amount) || amount <= 0 || !date) {
                showCustomAlert('অনুগ্রহ করে সঠিক বিবরণ, পরিমাণ এবং তারিখ দিন।');
                return;
            }

            const transaction = {
                id: Date.now(),
                desc,
                amount,
                category,
                date,
                type
            };

            const transactions = await idbGet('expense_transactions') || [];
            transactions.push(transaction);
            await idbSet('expense_transactions', transactions);

            showCustomAlert('লেনদেন সফলভাবে যুক্ত হয়েছে!');
            
            // ফর্ম রিসেট
            descInput.value = '';
            amountInput.value = '';
            loadAndRender();
        };
    }

    // সব ডাটা মুছে ফেলা (চার্ট সহ)
    if(clearBtn) {
        clearBtn.onclick = async () => {
            if(confirm('সতর্কতা: আপনি কি নিশ্চিত যে সব লেনদেনের ইতিহাস মুছে ফেলতে চান?')) {
                await idbSet('expense_transactions', []);
                
                // চার্ট ধ্বংস করা
                if (expenseChartInstance) {
                    expenseChartInstance.destroy();
                    expenseChartInstance = null;
                }
                
                loadAndRender();
                showCustomAlert('সব ইতিহাস মুছে ফেলা হয়েছে।');
            }
        };
    }

    // ইনিশিয়াল লোড
    loadAndRender();
}
// ========================================================
// END: Expense Tracker Script
// ========================================================

// ====================================================================
// START: VOICE COMMAND & PWA LOGIC (সংশোধিত)
// ====================================================================

// --- 1. Voice Command Logic ---
const voiceBtn = document.getElementById('voiceCommandBtn');
let recognition;

if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = false; // একটি কমান্ড শুনেই থামবে
    recognition.lang = 'bn-BD'; // বাংলা ভাষা সেট করা হয়েছে
    recognition.interimResults = false;

    recognition.onstart = function() {
        voiceBtn.classList.add('listening');
        // ইনপুট বক্সে ফোকাস থাকলে এলার্ট দেখানোর দরকার নেই, কারণ তখন ইউজার টাইপ করতে চাচ্ছে
        const activeEl = document.activeElement;
        const isInputFocused = activeEl && (
            (activeEl.tagName === 'INPUT' && activeEl.type !== 'button' && activeEl.type !== 'submit') || 
            activeEl.tagName === 'TEXTAREA' || 
            activeEl.isContentEditable
        );

        if (!isInputFocused) {
            showCustomAlert("শুনছি... বলুন (যেমন: 'ক্যালকুলেটর', 'নোটপ্যাড', 'আবহাওয়া', 'অথবা যেকোনো টেক্সটবক্স সিলেক্ট করে ভয়েজ দিয়ে লিখুন')");
        }
    };

    recognition.onend = function() {
        voiceBtn.classList.remove('listening');
    };

    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript.trim();
        console.log("Voice Command/Text Received:", transcript);

        // ফোকাস করা এলিমেন্ট চেক করা
        const activeEl = document.activeElement;
        const isEditable = activeEl && (
            (activeEl.tagName === 'INPUT' && (activeEl.type === 'text' || activeEl.type === 'search' || activeEl.type === 'number' || activeEl.type === 'url' || activeEl.type === 'email')) || 
            activeEl.tagName === 'TEXTAREA' || 
            activeEl.isContentEditable
        );

        if (isEditable) {
            // যদি কোনো ইনপুট ফিল্ড সিলেক্ট করা থাকে, সেখানে টেক্সট ইনসার্ট হবে
            if (activeEl.isContentEditable) {
                // নোটপ্যাড বা contenteditable ডিভ-এর জন্য
                // execCommand 'insertText' কার্সরের পজিশনে প্লেইন টেক্সট ইনসার্ট করে এবং আনডু হিস্ট্রি ঠিক রাখে
                document.execCommand('insertText', false, transcript + ' ');
            } else {
                // ইনপুট বা টেক্সটএরিয়া-এর জন্য
                const start = activeEl.selectionStart;
                const end = activeEl.selectionEnd;
                const text = activeEl.value;
                const before = text.substring(0, start);
                const after = text.substring(end, text.length);
                
                // টেক্সট ইনসার্ট করা (শেষে একটি স্পেসসহ)
                activeEl.value = before + transcript + " " + after;
                
                // কার্সর পজিশন আপডেট করা
                const newCursorPos = start + transcript.length + 1;
                activeEl.selectionStart = activeEl.selectionEnd = newCursorPos;
                
                // ইভেন্ট ডিসপ্যাচ করা যাতে রিয়েল-টাইম ক্যালকুলেশন বা লজিক কাজ করে (যেমন: ওয়ার্ড কাউন্টার)
                activeEl.dispatchEvent(new Event('input', { bubbles: true }));
            }
        } else {
            // যদি কোনো ইনপুট ফিল্ড সিলেক্ট করা না থাকে, তবে কমান্ড হিসেবে প্রসেস হবে
            processVoiceCommand(transcript.toLowerCase());
        }
    };

    recognition.onerror = function(event) {
        console.error("Speech recognition error", event.error);
        voiceBtn.classList.remove('listening');
        if (event.error === 'not-allowed') {
            showCustomAlert("মাইক্রোফোন ব্যবহারের অনুমতি নেই।");
        }
    };

    if (voiceBtn) {
        // নতুন: মাউসডাউন ইভেন্টে প্রিভেন্ট ডিফল্ট দেওয়া হয়েছে যাতে ইনপুট ফিল্ড থেকে ফোকাস না সরে যায়
        voiceBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();
        });

        voiceBtn.addEventListener('click', () => {
            try {
                recognition.start();
            } catch (e) {
                console.log("Recognition already started or error:", e);
                recognition.stop();
            }
        });
    }
} else {
    if (voiceBtn) voiceBtn.style.display = 'none'; // ব্রাউজার সাপোর্ট না করলে বাটন লুকান
    console.log("Web Speech API not supported in this browser.");
}

function processVoiceCommand(command) {
    // কমান্ড এবং ট্যাব বাটনের আইডির ম্যাপিং
    const commandMap = {
        // ট্যাবসমূহ (পুরো নাম এবং সংক্ষিপ্ত কিওয়ার্ড সহ)
        'সাধারণ, ক্যালকুলেটর, হিসাব, বেসিক': 'basicCalcTab',
        'সাইন্টিফিক,  সাইন্টিফিক ক্যালকুলের, বিজ্ঞান': 'scientificCalcTab',
        'তারিখ ও সময়, তারিখ, সময়': 'dateCalcTab',
        'বয়স ক্যালকুলেটর, বয়স': 'ageCalcTab',
        'ওয়েব সার্চ, ওয়েব, সার্চ, ব্রাউজার': 'webSearchTab',
     'টেক্সট, টেক্সট এ্যাসিসটেন্ট, text, এ্যাসিসট্যান্ট, অ্যাসিস্ট্যান্ট, চ্যাট, জেমিনি': 'textAssistantTab',
        'কনভার্টার, ফন্ট কনভার্টার, বিজয়, অভ্র': 'converterTab',
        'নামাজের, সময়সূচি, নামাজ, আজান': 'prayerTimeTab',
        'ট্রান্সলেটর, অনুবাদ': 'translatorTab',
        'ওয়ার্ড কাউন্টার, ওয়ার্ড': 'wordCounterTab',
        'শব্দের অর্থ, অর্থ': 'wordMeaningTab',
        'বানান সংশোধন, বানান, শুদ্ধ': 'spellCheckTab',
        'লেখা সাজানো, সাজানো': 'textBeautifierTab',
        'ছবি থেকে লেখা, ওসিআর': 'imageToTextTab',
        'টাইপিং, টেস্ট, টাইপিং, টাইপ': 'typingTestTab',
        'কথা থেকে, কোথা থেকে, টিটিএস, কোথা থেকে লেখা, ভয়েস টু টেক্সট': 'sttTab',
        'লেখা থেকে, টেক্সট টু স্পিচ, পড়ে শোনাও': 'ttsTab',
        'গুগল ম্যাপ, ম্যাপ, মানচিত্র': 'mapTab',
        'আবহাওয়া, আবহাওয়া': 'weatherTab',
        'পরিমাপ, ইউনিট': 'measurementTab',
        'নোটপ্যাড, নোট, টুডু': 'notepadTab',
        'ড্যাশবোর্ড, হোম': 'dashboardTab',
        'ঘড়ি, ঘড়ি, স্টপওয়াচ, টাইমার, ক্লক, এলার্ম, alarm, বিশ্ব ঘড়ি, বিশ্বঘড়ি': 'clockTab',
        'প্লেয়ার, প্লেয়ার, গান, ভিডিও': 'playerTab',
        'কুইজ, প্রশ্ন': 'quizTab',
        'ইতিহাস, আজকের দিন': 'historyTab',
        'দিবসসমূহ, দিবস': 'daysObservancesTab',
        'ছুটির তালিকা, ছুটি, বন্ধ': 'holidayListTab',
        'যাকাতের হিসাব, যাকাত': 'zakatCalcTab',
        'কিউআর কোড, কিউ আর, কিউআর, স্ক্যান': 'qrCodeTab',
        'বারকোড, বার কোড, বারকোড জেনারেটর': 'barcodeGenTab',
        'রঙ বাছাইকারী, কালার পিকার, রং, কালার': 'colorPickerTab',
        'জরুরি নম্বর, জরুরি, নাম্বার': 'emergencyNumbersTab',
        'ইনভয়েজ, ইনভয়েস, বিল': 'invoiceTab',
        'ছবি রিসাইজার, রিসাইজার, ছবি এডিট': 'imageResizerTab',
        'স্বাস্থ্য ও জীবনধারা, স্বাস্থ্য, বিএমআই': 'healthLifestyleTab',
        'ইএমআই ক্যালকুলেটর, ইএমআই, লোন': 'emiCalcTab',
        'মুদ্রা রূপান্তরকারী, মুদ্রা, কারেন্সি, টাকা': 'currencyTab',
        'দামের তুলনা, দাম, তুলনা': 'unitPriceTab',
        'আইপি ও ডিভাইস ইনফো, আইপি': 'ipInfoTab',
        'রেসিপি জেনারেটর, রেসিপি, রান্না': 'recipeTab',
        'পিডিএফ টুলস, পিডিএফ': 'pdfToolsTab',
        'জেসন ফর্মাটার, জেসন': 'jsonFormatterTab',
        'মিম জেনারেটর, মিম': 'memeGenTab',
        'র‍্যান্ডম পিকার, লটারি': 'randomPickerTab',
        'স্ক্রিন রেকর্ডার, রেকর্ডার, স্ক্রিন': 'screenRecorderTab',
        'ডিজিটাল তাসবিহ, তাসবিহ, জিকির': 'tasbeehTab',
        'ডিফ চেকার, ডিফ, পার্থক্য': 'diffCheckerTab',
        'আয়-ব্যয় হিসাব, আয় ব্যয়, খরচ': 'expenseTrackerTab',
        'ডোনেট, সাহায্য': 'donateTab',
        'গুরুত্বপূর্ণ লিংকসমূহ, শহীদুজ্জামান, শহিদুজ্জামান, সিফাত, লিংক, প্রোফাইল': 'importantLinksTab',
        'ইন্টারনেট স্পিড, স্পিড, গতি': 'speedTestTab',
        'এনক্রিপশন, এনক্রিপ্ট, ডিক্রিপ্ট, লক, আনলক, পাসওয়ার্ড': 'textEncryptionTab',

        // বিশেষ কমান্ড (সেটিংস, থিম, ইত্যাদি)
        'সকল ফিচার, আরো, আরও': 'allFeaturesTab',
        'আরও সেটিংস, সেটিংস, সেটিং': 'moreSettingsTab',
        'এপিআই কী, এপি আই, এপিআই, সেট করুন': 'setApiKeyBtn',
             'সাইডবার, সাই বার, সাইট, সাইড, অন, খোলো, খোল, খোলা, সাইবার, ওপেন': 'sidebarToggle',
       'অফ, সাইডবার অফ, বন্ধ,  সাইডবার ক্লোজ' : 'sidebarClose',
   
        'ডার্ক মোড, ডাক, নাইট, লাইট মোড, মোড, মোট, নাইট মোড, নাইটমোড, লাইট, ডার্ক, থিম, দিন, রাত, সাদা, কালো, কালা, চাঁদ, সূর্য,': 'theme-toggle'
    };

    // ফাজি ম্যাচিং (Fuzzy Matching) - ইনপুটের মধ্যে কিওয়ার্ড খুঁজবে
    let foundButtonId = null;
    let matchedKeyword = "";

    // লুপ ঘুরিয়ে প্রতিটি কিওয়ার্ড চেক করা হচ্ছে
    for (const keys in commandMap) {
        // কমা দিয়ে আলাদা করে অ্যারে তৈরি করা হচ্ছে এবং স্পেস ট্রিম করা হচ্ছে
        const keywords = keys.split(',').map(k => k.trim()); 
        
        for (const key of keywords) {
            if (command.includes(key)) {
                foundButtonId = commandMap[keys];
                matchedKeyword = key;
                break; // প্রথম মিল পেলেই থামবে
            }
        }
        if (foundButtonId) break; // বাটন আইডি পাওয়া গেলে প্রধান লুপ থামানো হবে
    }

    if (foundButtonId) {
        const targetButton = document.getElementById(foundButtonId);
        if (targetButton) {
            // বাটনে ক্লিক সিমুলেট করা হচ্ছে
            targetButton.click();
            
            // যদি বাটনটি ড্রপডাউনের ভেতরে থাকে এবং ড্রপডাউন বন্ধ থাকে, তবে ড্রপডাউনটি ওপেন করার চেষ্টা করা
            const dropdown = targetButton.closest('.absolute'); 
            if (dropdown && dropdown.classList.contains('hidden')) {
                let dropdownToggleBtn;
                if (dropdown.id === 'moreMenuDropdown') dropdownToggleBtn = document.getElementById('moreMenuBtn');
                else if (dropdown.id === 'settingsMenuDropdown') dropdownToggleBtn = document.getElementById('settingsMenuBtn');
                
                if (dropdownToggleBtn) {
                    dropdownToggleBtn.click();
                }
            }

            showCustomAlert(`চালু করা হচ্ছে: ${matchedKeyword}`);
        } else {
            console.error(`Tab button with ID '${foundButtonId}' not found.`);
        }
    } else {
        showCustomAlert(`দুঃখিত, "${command}" এর জন্য কোনো ফিচার খুঁজে পাইনি।`);
    }
}

// --- 2. PWA Registration Logic ---
// PWA কাজ করার জন্য manifest.json এবং sw.js ফাইল থাকতে হবে।
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then(registration => {
                console.log('PWA ServiceWorker registration successful with scope: ', registration.scope);
            })
            .catch(err => {
                console.log('PWA ServiceWorker registration failed: ', err);
            });
    });
}

// PWA Install Button Logic
let deferredPrompt;
const pwaInstallBtn = document.getElementById('pwaInstallBtn');

window.addEventListener('beforeinstallprompt', (e) => {
    // ক্রোম ৬০+ এ অটোমেটিক প্রম্পট বন্ধ করা
    e.preventDefault();
    // ইভেন্টটি পরে ব্যবহারের জন্য সংরক্ষণ করুন
    deferredPrompt = e;
    // ইন্সটল বাটনটি দৃশ্যমান করুন
    if (pwaInstallBtn) {
        pwaInstallBtn.style.display = 'flex';
        
        pwaInstallBtn.addEventListener('click', () => {
            // বাটন লুকান
            pwaInstallBtn.style.display = 'none';
            // প্রম্পট দেখান
            deferredPrompt.prompt();
            // ব্যবহারকারীর প্রতিক্রিয়া জানুন
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the PWA install prompt');
                } else {
                    console.log('User dismissed the PWA install prompt');
                }
                deferredPrompt = null;
            });
        });
    }
});

// অ্যাপ ইন্সটল হয়ে গেলে বাটন লুকান
window.addEventListener('appinstalled', () => {
    console.log('PWA was installed');
    if (pwaInstallBtn) pwaInstallBtn.style.display = 'none';
});

// ====================================================================
// END: VOICE COMMAND & PWA LOGIC
// ====================================================================

/* ====================================================================*/
/* START: GLOBAL KEYBOARD SHORTCUTS */
/* ====================================================================*/
function initializeGlobalShortcuts() {
    document.addEventListener('keydown', (e) => {
        const activeTag = document.activeElement.tagName.toLowerCase();
        const isEditable = document.activeElement.isContentEditable;
        const isInputFocused = activeTag === 'input' || activeTag === 'textarea' || isEditable;

        // --- নতুন: Control কী শর্টকাট (ট্যাব নেভিগেশন ও ইনপুট ফোকাস) ---
        if (e.ctrlKey && !e.altKey && !e.shiftKey) {
            // ১. Ctrl + Right Arrow: পরবর্তী আইটেমে যান
            if (e.key === 'ArrowRight') {
                e.preventDefault();
                navigateTabs('next');
            }
            // ২. Ctrl + Left Arrow: পূর্ববর্তী আইটেমে যান
            else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                navigateTabs('prev');
            }
            // ৩. Ctrl + Down Arrow: ইনপুট বক্সে ফোকাস করুন (সিলেকশন)
            else if (e.key === 'ArrowDown') {
                e.preventDefault();
                focusNextInput();
            }
            // ৪. Ctrl + Up Arrow: ফোকাস সরান (আনসিলেকশন/আনফোকাস)
            else if (e.key === 'ArrowUp') {
                e.preventDefault();
                blurActiveTabInput();
            }
        }

        // এন্টার কি হ্যান্ডলিং (ভয়েস এবং থিম বাটনের জন্য)
        if (e.key === 'Enter') {
            const activeId = document.activeElement.id;
            if (activeId === 'theme-toggle' || activeId === 'voiceCommandBtn') {
                e.preventDefault();
                document.activeElement.click();
            }
        }

        // --- পুরাতন: Alt কী শর্টকাট ---
        // যদি ইউজার ইনপুট ফিল্ডে টাইপ করে, তবে Alt শর্টকাট কাজ করবে না
        if (isInputFocused) {
            return;
        }

        if (e.altKey && !e.ctrlKey && !e.shiftKey) {
            const key = e.key.toLowerCase();
            let targetTabId = null;

            // শর্টকাট ম্যাপিং (Alt + Key)
            const shortcutMap = {
                'c': 'basicCalcTab',        // Calculator
                's': 'scientificCalcTab',   // Scientific
                'n': 'notepadTab',          // Notepad
                'w': 'weatherTab',          // Weather
                't': 'translatorTab',       // Translator
                'b': 'converterTab',        // Font Converter (Bijoy)
                'p': 'playerTab',           // Player
                'h': 'historyTab',          // History
                'q': 'qrCodeTab',           // QR Code
                'i': 'invoiceTab',          // Invoice
                'm': 'mapTab',              // Map
                'a': 'textAssistantTab',    // AI Assistant
                'z': 'zakatCalcTab',        // Zakat
                'd': 'dashboardTab',        // Dashboard
                'g': 'webSearchTab',        // Browser
                'r': 'imageResizerTab',     // Resizer
                'e': 'expenseTrackerTab',    // Expense
                'v': 'voiceCommandBtn', // Voicecommand 
                'l': 'theme-toggle', // Theme Toggle 
                'u': 'moreSettingsTab', // Settings
                'o': 'clockTab', // Clock 
                'j': 'donateTab', //Donate
                'f': 'allFeaturesTab', //All Feature 
                'k': 'importantLinksTab', //Important Links
				'y': 'typingTestTab',  //Typing
				'.': 'moreMenuBtn',  //MoreMenuTab
                
            };

            if (shortcutMap[key]) {
                targetTabId = shortcutMap[key];
            }

            if (targetTabId) {
                e.preventDefault(); 
                const tabButton = document.getElementById(targetTabId);
                
                if (tabButton) {
                    tabButton.click();
                    showCustomAlert(`শর্টকাট সক্রিয়: ${tabButton.textContent.trim()}`);
                }
            }
        }
        
        // সাইডবার টগল (Alt + X)
        if (e.altKey && e.key.toLowerCase() === 'x') {
            e.preventDefault();
            const sidebarToggle = document.getElementById('sidebarToggle');
            if (sidebarToggle) sidebarToggle.click();
        }
    });

    // --- সাহায্যকারী ফাংশন: উন্নত ট্যাব নেভিগেশন (সাইডবার ভিত্তিক) ---
    function navigateTabs(direction) {
        // ১. বিশেষ বাটন (টপ বার) - এগুলো সাইডবারে নেই
        const topButtons = [
            document.getElementById('voiceCommandBtn'),
            document.getElementById('theme-toggle')
        ].filter(el => el && el.offsetParent !== null); // শুধুমাত্র দৃশ্যমান বাটন

        // ২. সাইডবারের লিংকগুলো (সাজানো তালিকা)
        const sidebarList = document.getElementById('sidebar-tool-list');
        let sidebarLinks = sidebarList ? Array.from(sidebarList.querySelectorAll('a')) : [];
        
        // ফিল্টারিং: অপ্রয়োজনীয় বাটন স্কিপ করা
        sidebarLinks = sidebarLinks.filter(link => {
            // ১. 'setApiKeyBtn' (API Key) বাটনটি স্কিপ করবে
            if (link.dataset.tabId === 'setApiKeyBtn') return false;

            // ২. 'আরও' বাটনটি স্কিপ করবে (যেটি 'allFeaturesTab' এ পয়েন্ট করে কিন্তু নাম 'আরও')
            // কিন্তু 'সকল ফিচার' বাটনটি (যেটিও 'allFeaturesTab' এ পয়েন্ট করে) থাকবে
            const text = link.textContent.trim();
            if (link.dataset.tabId === 'allFeaturesTab' && (text === 'আরও' || text.startsWith('আরও'))) {
                return false;
            }

            return true;
        });

        // সম্পূর্ণ নেভিগেশন লিস্ট (ভয়েস, থিম, তারপর সাইডবারের মেইন টুলস)
        const navigationList = [...topButtons, ...sidebarLinks];

        if (navigationList.length === 0) return;

        // বর্তমান ফোকাস করা বাটন খুঁজে বের করা
        let currentIndex = navigationList.indexOf(document.activeElement);

        // যদি ফোকাস না থাকে, তবে বর্তমানে অ্যাক্টিভ ট্যাবটি খুঁজে বের করার চেষ্টা করি
        if (currentIndex === -1) {
            // সাইডবার স্ক্রিপ্টে active লিংকে 'bg-indigo-600' ক্লাস যোগ করা হয়
            const activeSidebarLink = sidebarLinks.find(link => link.classList.contains('bg-indigo-600'));
            
            if (activeSidebarLink) {
                currentIndex = navigationList.indexOf(activeSidebarLink);
            }
        }

        // যদি তাও না পাওয়া যায়, শুরু থেকে শুরু
        if (currentIndex === -1) currentIndex = -1;

        let nextIndex;
        if (direction === 'next') {
            nextIndex = (currentIndex + 1) % navigationList.length;
        } else {
            nextIndex = (currentIndex - 1 + navigationList.length) % navigationList.length;
        }

        const targetElement = navigationList[nextIndex];

        if (targetElement) {
            // স্ক্রল প্রিভেন্ট করে ফোকাস করা
            targetElement.focus({ preventScroll: true });

            // বিশেষ শর্ত: থিম এবং ভয়েস বাটন বাদে বাকি সব (সাইডবার আইটেম) অটোমেটিক ক্লিক হবে
            const isThemeOrVoice = (targetElement.id === 'theme-toggle' || targetElement.id === 'voiceCommandBtn');
            
            if (!isThemeOrVoice) {
                targetElement.click(); // ট্যাব পরিবর্তন করবে
            }
            // থিম বা ভয়েস বাটন হলে শুধু ফোকাস থাকবে, ক্লিক হবে না (এন্টার চাপলে কাজ করবে)
        }
    }

    // --- সাহায্যকারী ফাংশন: ইনপুট ফোকাস নেভিগেশন (সিলেকশন ফিক্স) ---
    function focusNextInput() {
        // বর্তমানে সক্রিয় কন্টেন্ট এরিয়া খুঁজুন
        const activeContent = document.querySelector('.calculator-content.active');
        if (!activeContent) return;

        // সকল ইনপুট এলিমেন্ট সংগ্রহ করুন (দৃশ্যমান এবং এনাবলড)
        // textarea, select, এবং contenteditable সহ
        // আপডেট: div[contenteditable="true"] স্পষ্টভাবে সিলেক্ট করা হয়েছে
        const inputs = Array.from(activeContent.querySelectorAll('input, textarea, div[contenteditable="true"], select'))
            .filter(el => {
                const style = window.getComputedStyle(el);
                // ফিল্টার আপডেট: কালার পিকার, ফাইল ইনপুট এবং অদৃশ্য এলিমেন্ট বাদ দেওয়া হয়েছে
                return style.display !== 'none' && 
                       style.visibility !== 'hidden' && 
                       style.opacity !== '0' && // অপাসিটি ০ হলে বাদ (যেমন টুলবারের কালার পিকার)
                       !el.disabled && 
                       el.type !== 'hidden' &&
                       el.type !== 'color' && // কালার পিকার বাদ
                       el.type !== 'file';    // ফাইল আপলোড বাদ
            });
        
        if (inputs.length === 0) return;

        // বর্তমানে ফোকাসড ইনপুটটি খুঁজুন
        const currentIndex = inputs.indexOf(document.activeElement);

        if (currentIndex === -1) {
            // কেউ ফোকাসড নেই -> প্রথমটিতে ফোকাস দিন
            inputs[0].focus({ preventScroll: false });
            // প্রয়োজনে স্ক্রল করে সামনে আনা
            inputs[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
            moveCursorToEnd(inputs[0]);
        } else {
            // ফোকাসড আছে -> পরেরটিতে যান (লুপ করবে)
            const nextIndex = (currentIndex + 1) % inputs.length;
            const nextInput = inputs[nextIndex];

            nextInput.focus({ preventScroll: false });
            nextInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            moveCursorToEnd(nextInput);
        }
    }

    // কার্সর শেষে নিয়ে যাওয়ার ফাংশন
    function moveCursorToEnd(el) {
        if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
            try {
                // কিছু ইনপুট টাইপে (যেমন date, number) selection সাপোর্ট করে না
                const val = el.value;
                if (typeof el.selectionStart === "number") {
                    el.selectionStart = el.selectionEnd = val.length;
                }
            } catch (e) { /* ignore error for unsupported types */ }
        } else if (el.isContentEditable) {
            // ContentEditable div এর জন্য (যেমন নোটপ্যাড)
            const range = document.createRange();
            range.selectNodeContents(el);
            range.collapse(false);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }
    }

    // --- সাহায্যকারী ফাংশন: ইনপুট আনফোকাস (Blur) ---
    function blurActiveTabInput() {
        if (document.activeElement && 
           (document.activeElement.tagName === 'INPUT' || 
            document.activeElement.tagName === 'TEXTAREA' || 
            document.activeElement.isContentEditable ||
            document.activeElement.tagName === 'SELECT')) {
            
            document.activeElement.blur(); // ফোকাস সরিয়ে নিন
        }
    }
    
    console.log("Global keyboard shortcuts initialized with sidebar-based navigation.");
}

// স্ক্রিপ্ট লোড হওয়ার পর শর্টকাট ইনিশিয়ালাইজ করুন
document.addEventListener('DOMContentLoaded', initializeGlobalShortcuts);
/* ====================================================================*/
/* END: GLOBAL KEYBOARD SHORTCUTS */
/* ====================================================================*/

// ========================================================
// START: Text Encryption Function
// ========================================================
function initializeTextEncryption() {
    const inputEl = document.getElementById('encryptionInput');
    const passEl = document.getElementById('encryptionPassword');
    const outputEl = document.getElementById('encryptionOutput');
    const encryptBtn = document.getElementById('btnEncrypt');
    const decryptBtn = document.getElementById('btnDecrypt');
    const resultBox = document.getElementById('encryptionResultBox');
    const copyBtn = document.getElementById('btnCopyEncryption');
    const clearBtn = document.getElementById('btnClearEncryption');

    if (!encryptBtn) return;

    // এনক্রিপ্ট ফাংশন
    encryptBtn.onclick = () => {
        const text = inputEl.value.trim();
        let password = passEl.value.trim();

        if (!text) return showCustomAlert('অনুগ্রহ করে কিছু টেক্সট লিখুন।');
        
        // পাসওয়ার্ড খালি থাকলে একটি ডিফল্ট পাসওয়ার্ড ব্যবহার করা হবে (যাতে পাসওয়ার্ড ছাড়াও কাজ করে)
        if (!password) {
            password = "BT_DEFAULT_KEY_NO_PASS"; 
        }

        try {
            const encrypted = CryptoJS.AES.encrypt(text, password).toString();
            outputEl.value = encrypted;
            outputEl.style.color = '#ef4444'; // লাল রঙ (লকড বোঝাতে)
            resultBox.classList.remove('hidden');
            showCustomAlert('টেক্সট সফলভাবে এনক্রিপ্ট করা হয়েছে!');
        } catch (e) {
            console.error(e);
            showCustomAlert('এনক্রিপশনে সমস্যা হয়েছে।');
        }
    };

    // ডিক্রিপ্ট ফাংশন
    decryptBtn.onclick = () => {
        const text = inputEl.value.trim();
        let password = passEl.value.trim();

        if (!text) return showCustomAlert('অনুগ্রহ করে এনক্রিপ্টেড কোড দিন।');
        
        // পাসওয়ার্ড খালি থাকলে ডিফল্ট পাসওয়ার্ড ব্যবহার করা হবে
        if (!password) {
            password = "BT_DEFAULT_KEY_NO_PASS";
        }

        try {
            const bytes = CryptoJS.AES.decrypt(text, password);
            const originalText = bytes.toString(CryptoJS.enc.Utf8);

            if (originalText) {
                outputEl.value = originalText;
                outputEl.style.color = '#10b981'; // সবুজ রঙ (আনলকড বোঝাতে)
                resultBox.classList.remove('hidden');
                showCustomAlert('টেক্সট সফলভাবে ডিক্রিপ্ট করা হয়েছে!');
            } else {
                // ভুল পাসওয়ার্ড হলে বা স্ট্রিং খালি হলে
                showCustomAlert('ভুল পাসওয়ার্ড অথবা কোড! ডিক্রিপ্ট করা সম্ভব হয়নি।');
            }
        } catch (e) {
            console.error(e);
            showCustomAlert('ভুল ফরম্যাট বা পাসওয়ার্ড।');
        }
    };

    // কপি বাটন (ফিক্সড: মোবাইল এবং সব ব্রাউজারের জন্য)
    copyBtn.onclick = () => {
        if (!outputEl.value) {
            showCustomAlert('কপি করার জন্য কিছু নেই।');
            return;
        }

        // টেক্সট সিলেক্ট করা
        outputEl.select();
        outputEl.setSelectionRange(0, 99999); // মোবাইল ডিভাইসের জন্য

        try {
            // নির্ভরযোগ্য কপি কমান্ড ব্যবহার
            const successful = document.execCommand('copy');
            if (successful) {
                showCustomAlert('ফলাফল কপি করা হয়েছে!');
            } else {
                // ফলব্যাক মেথড যদি execCommand কাজ না করে
                navigator.clipboard.writeText(outputEl.value)
                    .then(() => showCustomAlert('ফলাফল কপি করা হয়েছে!'))
                    .catch(() => showCustomAlert('কপি করতে সমস্যা হয়েছে, ম্যানুয়ালি কপি করুন।'));
            }
        } catch (err) {
            console.error('Copy failed', err);
            showCustomAlert('কপি করতে সমস্যা হয়েছে।');
        }
        
        // সিলেকশন হাইলাইট সরিয়ে ফেলা (অপশনাল, কিন্তু ভালো দেখায়)
        // window.getSelection().removeAllRanges(); 
    };

    // ক্লিয়ার বাটন
    clearBtn.onclick = () => {
        inputEl.value = '';
        passEl.value = '';
        outputEl.value = '';
        resultBox.classList.add('hidden');
        showCustomAlert('সব মুছে ফেলা হয়েছে।');
    };
}
// ========================================================
// END: Text Encryption Function
// ========================================================

// ====================================================================
// START: KEYBOARD LAYOUT MANAGER SCRIPT
// ====================================================================
function initializeKeyboardLayoutManager() {
    const layoutBtn = document.getElementById('keyboardLayoutBtn');
    const layoutDropdown = document.getElementById('keyboardLayoutDropdown');
    const layoutOptions = document.querySelectorAll('.layout-option');
    const indicator = document.getElementById('currentLayoutIndicator');
    
    let currentLayout = 'english';
    
    if (layoutBtn) {
        layoutBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            layoutDropdown.classList.toggle('hidden');
        });
    }

    window.addEventListener('click', (e) => {
        if (layoutDropdown && !layoutDropdown.classList.contains('hidden')) {
            if (!layoutDropdown.contains(e.target) && !layoutBtn.contains(e.target)) {
                layoutDropdown.classList.add('hidden');
            }
        }
    });

    layoutOptions.forEach(option => {
        option.addEventListener('click', () => {
            const selectedLayout = option.dataset.layout;
            setKeyboardLayout(selectedLayout, true);
            layoutDropdown.classList.add('hidden');
        });
    });

    function updateLayoutUI(notify = false) {
        layoutOptions.forEach(opt => {
            const checkIcon = opt.querySelector('.check-icon');
            if (opt.dataset.layout === currentLayout) {
                opt.classList.add('active', 'bg-indigo-50', 'dark:bg-gray-600', 'text-indigo-700', 'dark:text-indigo-300');
                if(checkIcon) checkIcon.classList.remove('hidden');
            } else {
                opt.classList.remove('active', 'bg-indigo-50', 'dark:bg-gray-600', 'text-indigo-700', 'dark:text-indigo-300');
                if(checkIcon) checkIcon.classList.add('hidden');
            }
        });

        if (indicator && layoutBtn) {
            indicator.classList.remove('hidden');
            const shortcutHint = '(Ctrl+Space / Ctrl+K)';
            if (currentLayout === 'english') {
                indicator.className = "absolute top-0 right-0 block h-2.5 w-2.5 rounded-full bg-gray-400 ring-2 ring-white transform translate-x-1/4 -translate-y-1/4";
                layoutBtn.setAttribute('data-tooltip', `English ${shortcutHint}`);
            } else if (currentLayout === 'bijoy_unicode') {
                indicator.className = "absolute top-0 right-0 block h-2.5 w-2.5 rounded-full bg-green-500 ring-2 ring-white transform translate-x-1/4 -translate-y-1/4";
                layoutBtn.setAttribute('data-tooltip', `বিজয় ইউনিকোড ${shortcutHint}`);
            } else if (currentLayout === 'bijoy_ansi') {
                indicator.className = "absolute top-0 right-0 block h-2.5 w-2.5 rounded-full bg-blue-500 ring-2 ring-white transform translate-x-1/4 -translate-y-1/4";
                layoutBtn.setAttribute('data-tooltip', `বিজয় আনসি ${shortcutHint}`);
            }
        }
        
        if (notify) {
            const layoutNames = {
                'english': 'English',
                'bijoy_unicode': 'বিজয় ইউনিকোড',
                'bijoy_ansi': 'বিজয় আনসি'
            };
            showCustomAlert(`কীবোর্ড লেআউট: ${layoutNames[currentLayout]}`);
        }
    }

    function setKeyboardLayout(layout, notify = false) {
        currentLayout = layout;
        updateLayoutUI(notify);
    }

    function setContentEditableCursor(element, offset) {
        const range = document.createRange();
        const sel = window.getSelection();
        if (element.childNodes.length > 0) {
            const textNode = element.childNodes[0];
            if (textNode.nodeType === 3) {
                const safeOffset = Math.min(offset, textNode.length);
                range.setStart(textNode, safeOffset);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }
    }

    document.addEventListener('keydown', function(e) {
        const target = e.target;
        const isEditable = target.tagName === 'TEXTAREA' || target.tagName === 'INPUT' || target.isContentEditable;
        
        const isToggleShortcut = e.ctrlKey && (e.code === 'Space' || e.key.toLowerCase() === 'k');
        
        if (isToggleShortcut) {
            e.preventDefault();
            const layouts = ['english', 'bijoy_unicode', 'bijoy_ansi'];
            const nextLayout = layouts[(layouts.indexOf(currentLayout) + 1) % layouts.length];
            setKeyboardLayout(nextLayout, true);
            return;
        }

        if (currentLayout === 'english' || e.ctrlKey || e.altKey || e.metaKey || !isEditable) return;
        
        if (target.tagName === 'INPUT') {
            const type = target.type.toLowerCase();
            if (['button', 'checkbox', 'radio', 'range', 'color', 'file', 'submit', 'reset', 'image', 'hidden'].includes(type)) return;
        }

        if (e.key.length > 1) return;
        e.preventDefault(); 

        let charToInsert = '';
        const key = e.key;

        // গেট বিজয় চার ম্যাপ (ইউনিকোড ভিত্তিক)
        const getBijoyChar = (k) => {
            const map = {
                'a':'ৃ', 'A':'র্', 'd':'ি', 'D':'ী', 's':'ু', 'S':'ূ', 'f':'া', 'F':'অ',
                'g':'্', 'G':'।', 'h':'ব', 'H':'ভ', 'j':'ক', 'J':'খ', 'k':'ত', 'K':'থ',
                'l':'দ', 'L':'ধ', 'z':'্র', 'Z':'্য', 'x':'ও', 'X':'ৗ', 'c':'ে', 'C':'ৈ',
                'v':'র', 'V':'ল', 'b':'ন', 'B':'ণ', 'n':'স', 'N':'ষ', 'm':'ম', 'M':'শ',
                'q':'ঙ', 'Q':'ং', 'w':'য', 'W':'য়', 'e':'ড', 'E':'ঢ', 'r':'প', 'R':'ফ',
                't':'ট', 'T':'ঠ', 'y':'চ', 'Y':'ছ', 'u':'জ', 'U':'ঝ', 'i':'হ', 'I':'ঞ',
                'o':'গ', 'O':'ঘ', 'p':'ড়', 'P':'ঢ়', '\\':'ৎ', '|':'ঃ', '&':'ঁ',
                '0':'০', '1':'১', '2':'২', '3':'৩', '4':'৪', 
                '5':'৫', '6':'৬', '7':'৭', '8':'৮', '9':'৯',
                '`': '‘', '~': '“', '\'': '’', '"': '”' // ডিফল্ট কোটেশন
            };
            return map[k] || k;
        };

        let start, end, value;
        if (target.isContentEditable) {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            const range = selection.getRangeAt(0);
            value = target.innerText || "";
            start = range.startOffset;
            end = range.endOffset;
        } else {
            start = target.selectionStart;
            end = target.selectionEnd;
            value = target.value;
        }

        const prevChar = start > 0 ? value.substring(start - 1, start) : '';

        if (currentLayout === 'bijoy_unicode') {
            let mappedChar = getBijoyChar(key);

            // স্পেসের পর সিঙ্গেল বা ডাবল কোট লজিক
            if (key === '\'' && (start === 0 || prevChar === ' ' || prevChar === '\n' || prevChar === '\t')) {
                mappedChar = '‘';
            } else if (key === '"' && (start === 0 || prevChar === ' ' || prevChar === '\n' || prevChar === '\t')) {
                mappedChar = '“';
            }

            const precedingVowels = ['ি', 'ে', 'ৈ'];
            const vowelToNoun = { 'ি':'ই', 'ে':'এ', 'ৈ':'ঐ', 'া':'আ', 'ু':'উ', 'ূ':'ঊ','ী':'ঈ', 'ৗ':'ঔ', 'ৃ':'ঋ' };
            const zwnj = '\u200C';
            const unicodeHasanta = '্';
            const unicodeRa = 'র';
            const unicodeYaPhala = '্য';
            const unicodeRef = 'র্';
            const chandrabindhu = 'ঁ'; 
            const swapWithChandrabindhu = ['া', 'ু', 'ূ', 'ৃ', 'ে', 'ৈ', 'ো', 'ৌ', 'ৗ'];
            
            if (typeof start === 'number') {
                const prevPrevChar = start >= 2 ? value.substring(start - 2, start - 1) : '';
                const isConsonant = (ch) => /^[\u0995-\u09B9\u09DC-\u09DF]/.test(ch);

                // চন্দ্রবিন্দু ফিক্স
                if (swapWithChandrabindhu.includes(mappedChar) && start > 0 && prevChar === chandrabindhu) {
                    const newVal = value.substring(0, start - 1) + mappedChar + prevChar + value.substring(start);
                    if (target.isContentEditable) {
                        target.innerText = newVal;
                        setContentEditableCursor(target, start + mappedChar.length);
                    } else {
                        target.value = newVal;
                        target.selectionStart = target.selectionEnd = start + mappedChar.length;
                    }
                    target.dispatchEvent(new Event('input'));
                    return;
                }

                // য-ফলা ফিক্স
                if (mappedChar === unicodeYaPhala && start > 0 && (prevChar === 'ু' || prevChar === 'ূ')) {
                    const newVal = value.substring(0, start - 1) + mappedChar + prevChar + value.substring(start);
                    if (target.isContentEditable) {
                        target.innerText = newVal;
                        setContentEditableCursor(target, start + mappedChar.length);
                    } else {
                        target.value = newVal;
                        target.selectionStart = target.selectionEnd = start + mappedChar.length;
                    }
                    target.dispatchEvent(new Event('input'));
                    return;
                }

                // অ + া = আ ফিক্স
                if (mappedChar === 'া' && start > 0 && (prevChar === 'অ' || prevChar === unicodeHasanta)) {
                    const newVal = value.substring(0, start - 1) + 'আ' + value.substring(start);
                    if (target.isContentEditable) {
                        target.innerText = newVal;
                        setContentEditableCursor(target, start);
                    } else {
                        target.value = newVal;
                        target.selectionStart = target.selectionEnd = start;
                    }
                    target.dispatchEvent(new Event('input'));
                    return;
                }

                // একার/ইকার/ঐকার ক্লাস্টার ফিক্স
                if (precedingVowels.includes(mappedChar) && start < value.length) {
                    const nextText = value.substring(start);
                    const clusterMatch = nextText.match(/^([ক-হড়ঢ়য়](?:্[ক-হড়ঢ়য়])*)(.*)/s);
                    if (clusterMatch && clusterMatch[1] !== "") {
                        const cluster = clusterMatch[1];
                        const newVal = value.substring(0, start) + cluster + mappedChar + value.substring(start + cluster.length);
                        if (target.isContentEditable) {
                             target.innerText = newVal;
                             setContentEditableCursor(target, start + cluster.length + mappedChar.length);
                        } else {
                            target.value = newVal;
                            target.selectionStart = target.selectionEnd = start + cluster.length + mappedChar.length;
                        }
                        target.dispatchEvent(new Event('input'));
                        return;
                    }
                }

                if (vowelToNoun[mappedChar] && start > 0 && prevChar === unicodeHasanta) {
                    if (!(precedingVowels.includes(prevPrevChar) && value.substring(start-3, start-2) !== zwnj)) {
                        const newVal = value.substring(0, start - 1) + vowelToNoun[mappedChar] + value.substring(start);
                        if (target.isContentEditable) {
                            target.innerText = newVal;
                            setContentEditableCursor(target, start);
                        } else {
                            target.value = newVal;
                            target.selectionStart = target.selectionEnd = start;
                        }
                        target.dispatchEvent(new Event('input'));
                        return;
                    }
                }

                if (mappedChar === unicodeHasanta && start > 0 && precedingVowels.includes(prevChar)) {
                    let newVal;
                    let cursorOffset;
                    if (prevPrevChar === zwnj) {
                         newVal = value.substring(0, start - 2) + mappedChar + prevChar + value.substring(start);
                         cursorOffset = start;
                    } else {
                         newVal = value.substring(0, start - 1) + mappedChar + prevChar + value.substring(start);
                         cursorOffset = start + 1;
                    }
                    if (target.isContentEditable) {
                        target.innerText = newVal;
                        setContentEditableCursor(target, cursorOffset);
                    } else {
                        target.value = newVal;
                        target.selectionStart = target.selectionEnd = cursorOffset;
                    }
                    target.dispatchEvent(new Event('input'));
                    return;
                }

                if (mappedChar === unicodeYaPhala && start > 0 && prevChar === unicodeRa) {
                    const newVal = value.substring(0, start) + zwnj + mappedChar + value.substring(start);
                    if (target.isContentEditable) {
                        target.innerText = newVal;
                        setContentEditableCursor(target, start + 1 + mappedChar.length);
                    } else {
                        target.value = newVal;
                        target.selectionStart = target.selectionEnd = start + 1 + mappedChar.length;
                    }
                    target.dispatchEvent(new Event('input'));
                    return;
                }

                if (mappedChar === unicodeRef && start > 0 && isConsonant(prevChar)) {
                    const newVal = value.substring(0, start - 1) + mappedChar + prevChar + value.substring(start);
                    if (target.isContentEditable) {
                        target.innerText = newVal;
                        setContentEditableCursor(target, start + mappedChar.length);
                    } else {
                        target.value = newVal;
                        target.selectionStart = target.selectionEnd = start + mappedChar.length; 
                    }
                    target.dispatchEvent(new Event('input'));
                    return;
                }

                if ((mappedChar === '্র' || mappedChar === '্য') && start > 0 && precedingVowels.includes(prevChar)) {
                    const newVal = value.substring(0, start - 1) + mappedChar + prevChar + value.substring(start);
                    if (target.isContentEditable) {
                        target.innerText = newVal;
                        setContentEditableCursor(target, start + mappedChar.length);
                    } else {
                        target.value = newVal;
                        target.selectionStart = target.selectionEnd = start + mappedChar.length;
                    }
                    target.dispatchEvent(new Event('input'));
                    return;
                }

                if (isConsonant(mappedChar) && start >= 2 && precedingVowels.includes(prevChar) && (prevPrevChar === unicodeHasanta || prevPrevChar === '্র' || prevPrevChar === '্য')) {
                    const newVal = value.substring(0, start - 1) + mappedChar + prevChar + value.substring(start);
                    if (target.isContentEditable) {
                        target.innerText = newVal;
                        setContentEditableCursor(target, start + mappedChar.length);
                    } else {
                        target.value = newVal;
                        target.selectionStart = target.selectionEnd = start + mappedChar.length;
                    }
                    target.dispatchEvent(new Event('input'));
                    return;
                }

                if (precedingVowels.includes(mappedChar)) {
                    if (start === value.length || value[start] === " " || value[start] === "\n") {
                        charToInsert = zwnj + mappedChar;
                    } else {
                        charToInsert = mappedChar;
                    }
                } else {
                    if (start >= 2) {
                        const prevTwo = value.substring(start - 2, start);
                        if (prevTwo[0] === zwnj && precedingVowels.includes(prevTwo[1])) {
                            const vowel = prevTwo[1];
                            const newVal = value.substring(0, start - 2) + mappedChar + vowel + value.substring(start);
                            if (target.isContentEditable) {
                                target.innerText = newVal;
                                setContentEditableCursor(target, start);
                            } else {
                                target.value = newVal;
                                target.selectionStart = target.selectionEnd = start;
                            }
                            target.dispatchEvent(new Event('input'));
                            return;
                        }
                    }
                    charToInsert = mappedChar;
                }
            } else {
                charToInsert = mappedChar;
            }
        } else if (currentLayout === 'bijoy_ansi') {
            let unicodeChar = getBijoyChar(key);

            // আনসিতে স্পেসের পর কোটেশন এবং একসেন্ট লজিক
            if (key === '`') unicodeChar = 'Ô';
            else if (key === '~') unicodeChar = 'Ò';
            else if (key === '\'' && (start === 0 || prevChar === ' ' || prevChar === '\n' || prevChar === '\t')) {
                unicodeChar = 'Ô';
            } else if (key === '"' && (start === 0 || prevChar === ' ' || prevChar === '\n' || prevChar === '\t')) {
                unicodeChar = 'Ò';
            }

            charToInsert = (typeof unicodeToBijoyMap !== 'undefined' && unicodeToBijoyMap[unicodeChar]) ? unicodeToBijoyMap[unicodeChar] : unicodeChar;
        }

        if (target.isContentEditable) {
            document.execCommand('insertText', false, charToInsert);
        } else {
            const s = target.selectionStart;
            const e_pos = target.selectionEnd;
            let val = target.value;
            let before = val.substring(0, s);
            let after = val.substring(e_pos);
            
            let tempValueBeforeCursor = before + charToInsert;
            
            if (currentLayout === 'bijoy_ansi' && typeof manualAnsiReplacements !== 'undefined') {
                let bestMatch = null;
                for (const pattern in manualAnsiReplacements) {
                    if (tempValueBeforeCursor.endsWith(pattern)) {
                        if (!bestMatch || pattern.length > bestMatch.length) {
                            bestMatch = pattern;
                        }
                    }
                }
                if (bestMatch) {
                    const replacement = manualAnsiReplacements[bestMatch];
                    tempValueBeforeCursor = tempValueBeforeCursor.slice(0, -bestMatch.length) + replacement;
                }
            }

            target.value = tempValueBeforeCursor + after;
            target.selectionStart = target.selectionEnd = tempValueBeforeCursor.length;
            target.dispatchEvent(new Event('input'));
        }
    });

    updateLayoutUI(false);
}

document.addEventListener('DOMContentLoaded', initializeKeyboardLayoutManager);
// ====================================================================
// END: KEYBOARD LAYOUT MANAGER SCRIPT
// ====================================================================


// ====================================================================
// START: FILE CONVERTER SCRIPT (DOCX, DOC, XLSX, TXT) - DRAG DROP & FORMATTING
// ====================================================================

document.addEventListener('DOMContentLoaded', () => {
    const fileInput = document.getElementById('converterFileInput');
    const dropZone = document.getElementById('converterDropZone');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const processingLoader = document.getElementById('fileProcessingLoader');
    
    // Buttons
    const exportUnicodeBtn = document.getElementById('exportUnicodeBtn');
    const exportBijoyBtn = document.getElementById('exportBijoyBtn');
    const clearFileBtn = document.getElementById('clearFileBtn');
    const importToUnicodeBtn = document.getElementById('importToUnicodeBtn');
    const importToBijoyBtn = document.getElementById('importToBijoyBtn');
    const fileImportButtons = document.getElementById('fileImportButtons');
    
    // Dropdown
    const customExportDropdownBtn = document.getElementById('customExportDropdownBtn');
    const customExportMenu = document.getElementById('customExportMenu');
    const exportBtnText = document.getElementById('exportBtnText');

    let currentFile = null;
    let currentFileType = null;
    // পরিবর্তন: ডিফল্ট ফরম্যাট এখন 'doc' করা হয়েছে যাতে পুরানো ওয়ার্ডে সমস্যা না হয়
    let selectedExportFormat = 'doc'; 

    // --- Dropdown Logic ---
    if (customExportDropdownBtn) {
        // শুরুতে বাটন টেক্সট আপডেট করা
        if (exportBtnText) exportBtnText.textContent = `ফরম্যাট: Default (DOC)`;

        customExportDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            customExportMenu.classList.toggle('hidden');
        });
    }

    if (customExportMenu) {
        customExportMenu.querySelectorAll('a').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const value = e.target.getAttribute('data-value');
                // 'default' সিলেক্ট করলে আমরা 'doc' কে ডিফল্ট হিসেবে ধরব
                selectedExportFormat = value === 'default' ? 'doc' : value;
                
                // বাটন টেক্সট আপডেট
                const formatLabels = {
                    'default': 'Default (DOC)',
                    'docx': 'DOCX',
                    'doc': 'DOC (Legacy)',
                    'xlsx': 'Excel',
                    'txt': 'TXT'
                };
                // ভ্যালু যদি লিস্টে না থাকে (যেমন default এর আসল মান)
                const label = formatLabels[value] || formatLabels[selectedExportFormat] || 'DOC';
                
                if (exportBtnText) exportBtnText.textContent = `ফরম্যাট: ${label}`;
                customExportMenu.classList.add('hidden');
            });
        });
    }

    window.addEventListener('click', (e) => {
        if (customExportMenu && !customExportMenu.classList.contains('hidden')) {
            if (!customExportMenu.contains(e.target) && !customExportDropdownBtn.contains(e.target)) {
                customExportMenu.classList.add('hidden');
            }
        }
    });

    // --- File Handling & Drag Drop Logic ---
    
    const handleFileSelection = (file) => {
        if (file) {
            const name = file.name.toLowerCase();
            const allowedExtensions = ['.docx', '.doc', '.xlsx', '.xls', '.txt'];
            const isValid = allowedExtensions.some(ext => name.endsWith(ext));

            if (isValid) {
                currentFile = file;
                fileNameDisplay.textContent = `সিলেক্ট করা ফাইল: ${file.name}`;
                fileImportButtons.classList.remove('hidden');
                
                if (name.endsWith('.docx')) currentFileType = 'docx';
                else if (name.endsWith('.doc')) currentFileType = 'doc';
                else if (name.endsWith('.xlsx') || name.endsWith('.xls')) currentFileType = 'xlsx';
                else if (name.endsWith('.txt')) currentFileType = 'txt';
            } else {
                showCustomAlert('শুধুমাত্র .docx, .doc, .xlsx, .xls এবং .txt ফাইল সাপোর্ট করে।');
                resetFileState();
            }
        }
    };

    if (fileInput) {
        fileInput.addEventListener('change', (e) => {
            handleFileSelection(e.target.files[0]);
        });
    }

    if (dropZone) {
        // ড্র্যাগ ইভেন্ট প্রিভেন্ট করা
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        // ভিজ্যুয়াল ফিডব্যাক
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.add('bg-blue-100', 'dark:bg-gray-600', 'border-blue-500');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.remove('bg-blue-100', 'dark:bg-gray-600', 'border-blue-500');
            }, false);
        });

        // ড্রপ হ্যান্ডলিং
        dropZone.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFileSelection(files[0]);
        }, false);
    }

    if (clearFileBtn) {
        clearFileBtn.addEventListener('click', resetFileState);
    }

    function resetFileState() {
        if (fileInput) fileInput.value = '';
        currentFile = null;
        currentFileType = null;
        fileNameDisplay.textContent = '';
        fileImportButtons.classList.add('hidden');
        processingLoader.classList.add('hidden');
    }

    // --- Export Buttons Logic ---
    if (exportUnicodeBtn) {
        exportUnicodeBtn.addEventListener('click', () => {
            if (currentFile) {
                // ফাইল সিলেক্ট থাকলে: ইউনিকোড -> আন্সি -> ইউনিকোড -> এক্সপোর্ট
                processFile('unicode');
            } else {
                // ফাইল না থাকলে: টেক্সটবক্স থেকে সরাসরি এক্সপোর্ট
                downloadTextboxContent('unicode');
            }
        });
    }

    if (exportBijoyBtn) {
        exportBijoyBtn.addEventListener('click', () => {
            if (currentFile) {
                // ফাইল সিলেক্ট থাকলে: ইউনিকোড -> আন্সি -> এক্সপোর্ট
                processFile('bijoy');
            } else {
                // ফাইল না থাকলে: টেক্সটবক্স থেকে সরাসরি এক্সপোর্ট
                downloadTextboxContent('bijoy');
            }
        });
    }

    // --- Import to Textbox Logic ---
    if (importToUnicodeBtn) {
        importToUnicodeBtn.addEventListener('click', async () => {
            if (!currentFile) return;
            await importFileContentToTextbox('unicode');
        });
    }

    if (importToBijoyBtn) {
        importToBijoyBtn.addEventListener('click', async () => {
            if (!currentFile) return;
            await importFileContentToTextbox('bijoy');
        });
    }

    // --- Helper Functions ---

    // নতুন: JSZip ব্যবহার করে ভ্যালিড .docx তৈরি করার ফাংশন (আপডেট: লাইন স্পেসিং ফিক্স)
    async function createSimpleDocx(text) {
        const zip = new JSZip();
        
        // Escape XML characters
        const escapeXml = (unsafe) => {
            return unsafe.replace(/[<>&'"]/g, function (c) {
                switch (c) {
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '&': return '&amp;';
                    case '\'': return '&apos;';
                    case '"': return '&quot;';
                }
            });
        };

        // 1. [Content_Types].xml
        zip.file("[Content_Types].xml", `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
<Default Extension="xml" ContentType="application/xml"/>
<Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
</Types>`);

        // 2. _rels/.rels
        zip.file("_rels/.rels", `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`);

        // 3. word/_rels/document.xml.rels
        zip.folder("word/_rels").file("document.xml.rels", `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"></Relationships>`);

        // 4. word/document.xml (The Content with Formatting)
        // w:jc val="both" = Justify Alignment
        // w:spacing w:after="0" = লাইনের মাঝে বাড়তি ফাকা জায়গা বন্ধ করা
        const paragraphs = text.split('\n').map(line => {
            return `<w:p>
                        <w:pPr>
                            <w:jc w:val="both"/>
                            <w:spacing w:after="0" w:line="240" w:lineRule="auto"/>
                        </w:pPr>
                        <w:r>
                            <w:rPr>
                                <w:sz w:val="28"/>
                                <w:szCs w:val="28"/>
                            </w:rPr>
                            <w:t>${escapeXml(line)}</w:t>
                        </w:r>
                    </w:p>`;
        }).join('');

        const documentXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
<w:body>${paragraphs}</w:body>
</w:document>`;

        zip.file("word/document.xml", documentXml);

        // Generate the blob
        return await zip.generateAsync({
            type: "blob",
            mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
        });
    }

    // নতুন: DOCX থেকে HTML কনভার্টার (টেবিল সাপোর্ট সহ)
    async function convertDocxToSimpleHtml(file) {
        try {
            const arrayBuffer = await file.arrayBuffer();
            const zip = await JSZip.loadAsync(arrayBuffer);
            const docXml = await zip.file("word/document.xml").async("string");
            
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(docXml, "text/xml");
            const bodyChildren = xmlDoc.getElementsByTagName("w:body")[0].childNodes;
            
            let htmlContent = '';
            
            for (let i = 0; i < bodyChildren.length; i++) {
                const node = bodyChildren[i];
                if (node.nodeName === "w:p") {
                    // Paragraph processing
                    let pText = "";
                    const texts = node.getElementsByTagName("w:t");
                    for (let j = 0; j < texts.length; j++) {
                        pText += texts[j].textContent;
                    }
                    if(pText.trim()) {
                        htmlContent += `<p style="text-align: justify; margin-bottom: 0px; font-size: 14pt; font-family: 'SutonnyMJ', 'Kalpurush', sans-serif;">${pText}</p>`;
                    } else {
                        htmlContent += `<p style="margin:0;">&nbsp;</p>`;
                    }
                } else if (node.nodeName === "w:tbl") {
                    // Table processing
                    let tableHtml = '<table border="1" style="border-collapse: collapse; width: 100%; margin-bottom: 10px; font-size: 14pt; font-family: \'SutonnyMJ\', \'Kalpurush\', sans-serif;">';
                    const rows = node.getElementsByTagName("w:tr");
                    
                    for (let r = 0; r < rows.length; r++) {
                        tableHtml += '<tr>';
                        const cells = rows[r].getElementsByTagName("w:tc");
                        for (let c = 0; c < cells.length; c++) {
                            let cellText = "";
                            const paras = cells[c].getElementsByTagName("w:p");
                            for (let p = 0; p < paras.length; p++) {
                                const texts = paras[p].getElementsByTagName("w:t");
                                for (let t = 0; t < texts.length; t++) {
                                    cellText += texts[t].textContent;
                                }
                                if (p < paras.length - 1) cellText += "<br>";
                            }
                            tableHtml += `<td style="border: 1px solid black; padding: 5px;">${cellText}</td>`;
                        }
                        tableHtml += '</tr>';
                    }
                    tableHtml += '</table>';
                    htmlContent += tableHtml;
                }
            }
            return htmlContent;
        } catch (e) {
            console.error(e);
            return "";
        }
    }


    // টেক্সটবক্স থেকে এক্সপোর্ট (আপডেট করা হয়েছে: ১৪ ফন্ট ও জাস্টিফাই)
    async function downloadTextboxContent(type) {
        const textareaId = type === 'unicode' ? 'textAreaLeft' : 'textAreaRight';
        const content = document.getElementById(textareaId).value;
        
        if (!content) {
            showCustomAlert('টেক্সটবক্স খালি! এক্সপোর্ট করার মতো কিছু নেই।');
            return;
        }

        // ডিফল্ট ফরম্যাট 'doc' সেট করা হয়েছে, যদি ড্রপডাউন থেকে চেঞ্জ না করা হয়
        const format = selectedExportFormat;
        const fileName = `bangla_toolbox_${type}_export.${format}`;

        if (format === 'txt') {
            const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
            saveAs(blob, fileName);
            showCustomAlert('TXT ফাইল ডাউনলোড হয়েছে!');
        } 
        else if (format === 'docx') {
            // নতুন: JSZip ব্যবহার করে ভ্যালিড .docx তৈরি (With formatting and no extra spacing)
            try {
                const blob = await createSimpleDocx(content);
                saveAs(blob, fileName);
                showCustomAlert('DOCX ফাইল ডাউনলোড হয়েছে (Valid XML)!');
            } catch (e) {
                console.error(e);
                showCustomAlert('DOCX তৈরিতে সমস্যা হয়েছে।');
            }
        }
        else if (format === 'doc') {
            // পুরাতন: HTML মেথড (এটি .doc এর জন্য ভালো কাজ করে)
            // আপডেট: ফন্ট সাইজ ১৪ এবং জাস্টিফাই এলাইনমেন্ট নিশ্চিত করা হয়েছে
            const paragraphs = content.split('\n').map(line => {
                if(line.trim() === '') return '<p>&nbsp;</p>';
                return `<p style="text-align: justify; text-justify: inter-word; font-size: 14pt; margin-bottom: 0px; font-family: 'SutonnyMJ', 'Kalpurush', sans-serif;">${line}</p>`;
            }).join('');

            const htmlContent = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head>
                    <meta charset="utf-8">
                    <title>Export</title>
                    <style>
                        body { font-family: 'SutonnyMJ', 'Kalpurush', sans-serif; font-size: 14pt; }
                        p { margin: 0; padding: 0; text-align: justify; }
                    </style>
                </head>
                <body>
                    ${paragraphs}
                </body>
                </html>
            `;
            
            const blob = new Blob(['\ufeff', htmlContent], {
                type: 'application/msword'
            });
            saveAs(blob, fileName);
            showCustomAlert('DOC ফাইল ডাউনলোড হয়েছে (লিগ্যাসি সাপোর্ট)!');
        }
        else if (format === 'xlsx') {
            // টেক্সটকে এক্সেলে নেওয়া
            const rows = content.split('\n').map(line => [line]);
            const ws = XLSX.utils.aoa_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            XLSX.writeFile(wb, fileName);
            showCustomAlert('Excel ফাইল ডাউনলোড হয়েছে!');
        }
    }

    // ফাইল থেকে টেক্সট বের করা
    async function extractTextFromFile(file, fileType) {
        if (fileType === 'txt') {
            return await file.text();
        } 
        else if (fileType === 'docx') {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const zip = await JSZip.loadAsync(arrayBuffer);
                const docXml = await zip.file("word/document.xml").async("string");
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(docXml, "text/xml");
                // প্লেইন টেক্সট এক্সট্রাকশন (টেবিল ছাড়া) - শুধুমাত্র টেক্সটবক্সে দেখানোর জন্য
                let text = "";
                const paragraphs = xmlDoc.getElementsByTagName("w:p");
                for (let i = 0; i < paragraphs.length; i++) {
                     const pTexts = paragraphs[i].getElementsByTagName("w:t");
                     for (let j=0; j<pTexts.length; j++) {
                         text += pTexts[j].textContent;
                     }
                     text += "\n";
                }
                return text;
            } catch (e) {
                console.error(e);
                throw new Error("DOCX ফাইল পড়তে সমস্যা হয়েছে।");
            }
        } 
        else if (fileType === 'doc') {
             throw new Error("পুরাতন .doc ফাইল ব্রাউজারে সরাসরি এডিট করা সম্ভব নয়। দয়া করে এটিকে .docx এ সেভ করে আপলোড করুন অথবা টেক্সট কপি করে পেস্ট করুন।");
        }
        else if (fileType === 'xlsx') {
            const arrayBuffer = await file.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            let text = "";
            workbook.SheetNames.forEach(sheetName => {
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                jsonData.forEach(row => {
                    text += row.join("\t") + "\n";
                });
            });
            return text;
        }
        return "";
    }

    // টেক্সটবক্সে ইমপোর্ট
    async function importFileContentToTextbox(targetType) {
        processingLoader.classList.remove('hidden');
        try {
            const rawText = await extractTextFromFile(currentFile, currentFileType);
            
            if (targetType === 'unicode') {
                document.getElementById('textAreaLeft').value = rawText;
                addState('textAreaLeft');
            } else {
                document.getElementById('textAreaRight').value = rawText;
                addState('textAreaRight');
            }
            showCustomAlert('ফাইলের লেখা টেক্সটবক্সে ইমপোর্ট করা হয়েছে! (টেবিল ছাড়া)');
        } catch (error) {
            console.error(error);
            showCustomAlert(error.message || 'ফাইল পড়তে সমস্যা হয়েছে।');
        } finally {
            processingLoader.classList.add('hidden');
        }
    }

    // কনভার্সন এবং ডাউনলোড প্রসেস (আপডেট করা হয়েছে: ব্যবহারকারীর অনুরোধ অনুযায়ী লজিক)
    async function processFile(targetType) {
        if (!currentFile) return;
        
        processingLoader.classList.remove('hidden');
        exportUnicodeBtn.disabled = true;
        exportBijoyBtn.disabled = true;

        // ব্যবহারকারীর অনুরোধ অনুযায়ী কাস্টম কনভার্সন লজিক
        const performUserRequestedConversion = (text) => {
            if (!text) return '';
            
            if (targetType === 'unicode') {
                // ফাইল সিলেক্ট থাকলে (ইউনিকোড এক্সপোর্ট): ইউনিকোড -> আন্সি -> ইউনিকোড
                const ansiText = convertTextString(text, 'bijoy'); // Unicode to Bijoy
                return convertTextString(ansiText, 'unicode');     // Bijoy to Unicode
            } else {
                // ফাইল সিলেক্ট থাকলে (আন্সি এক্সপোর্ট): ইউনিকোড -> আন্সি
                return convertTextString(text, 'bijoy'); // Unicode to Bijoy
            }
        };

        try {
            let finalFormat = selectedExportFormat;
            if (finalFormat === 'default') {
                 finalFormat = currentFileType === 'docx' ? 'docx' : 'doc';
            }
            
            const outputFileName = `converted_${targetType}_${currentFile.name.split('.')[0]}.${finalFormat}`;

            // Case 1: DOCX to DOC (Table Preserved)
            if (currentFileType === 'docx' && finalFormat === 'doc') {
                // ১. DOCX থেকে স্ট্রাকচার্ড HTML বের করা (টেবিল সহ)
                let htmlContentBody = await convertDocxToSimpleHtml(currentFile);
                
                // ২. টেক্সট কনভার্সন HTML এর ভেতরে করা
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = htmlContentBody;
                
                const walk = document.createTreeWalker(tempDiv, NodeFilter.SHOW_TEXT, null, false);
                let node;
                while(node = walk.nextNode()) {
                    // লজিক প্রয়োগ
                    node.nodeValue = performUserRequestedConversion(node.nodeValue);
                }
                
                htmlContentBody = tempDiv.innerHTML;

                const finalHtml = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                    <head>
                        <meta charset="utf-8">
                        <title>Export</title>
                        <style>
                            body { font-family: 'SutonnyMJ', 'Kalpurush', sans-serif; font-size: 14pt; }
                            p { margin: 0; padding: 0; text-align: justify; }
                            table { border-collapse: collapse; width: 100%; }
                            td { border: 1px solid black; padding: 5px; }
                        </style>
                    </head>
                    <body>
                        ${htmlContentBody}
                    </body>
                    </html>
                `;
                
                const blob = new Blob(['\ufeff', finalHtml], { type: 'application/msword' });
                saveAs(blob, outputFileName);
                showCustomAlert('DOC ফাইল ডাউনলোড হয়েছে (টেবিল সহ)!');
            }
            // Case 2: TXT Export
            else if (finalFormat === 'txt') {
                const text = await extractTextFromFile(currentFile, currentFileType);
                // লজিক প্রয়োগ
                const convertedText = performUserRequestedConversion(text);
                const blob = new Blob([convertedText], { type: "text/plain;charset=utf-8" });
                saveAs(blob, outputFileName);
            }
            // Case 3: DOCX to DOCX (Structure Preserving - Text Only for now)
            else if (currentFileType === 'docx' && finalFormat === 'docx') {
                const arrayBuffer = await currentFile.arrayBuffer();
                const zip = await JSZip.loadAsync(arrayBuffer);
                const docXml = await zip.file("word/document.xml").async("string");
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(docXml, "text/xml");
                const textNodes = xmlDoc.getElementsByTagName("w:t");

                for (let i = 0; i < textNodes.length; i++) {
                    const originalText = textNodes[i].textContent;
                    if (originalText.trim()) {
                        // লজিক প্রয়োগ
                        textNodes[i].textContent = performUserRequestedConversion(originalText);
                    }
                }

                const serializer = new XMLSerializer();
                const newDocXml = serializer.serializeToString(xmlDoc);
                zip.file("word/document.xml", newDocXml);
                
                const blob = await zip.generateAsync({ type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
                saveAs(blob, outputFileName);
            }
            // Case 4: Excel to Excel
            else if (currentFileType === 'xlsx' && (finalFormat === 'xlsx' || finalFormat === 'xls')) {
                 const arrayBuffer = await currentFile.arrayBuffer();
                 const workbook = XLSX.read(arrayBuffer, { type: 'array' });

                 workbook.SheetNames.forEach(sheetName => {
                    const worksheet = workbook.Sheets[sheetName];
                    for (let cellAddress in worksheet) {
                        if (cellAddress[0] === '!') continue;
                        const cell = worksheet[cellAddress];
                        if (cell.v && typeof cell.v === 'string') {
                            // লজিক প্রয়োগ
                            cell.v = performUserRequestedConversion(cell.v);
                        }
                    }
                });
                
                XLSX.writeFile(workbook, outputFileName);
            }
            // Case 5: Fallback (TXT -> DOCX, etc - No Table support here yet)
            else {
                 const rawText = await extractTextFromFile(currentFile, currentFileType);
                 // লজিক প্রয়োগ
                 const convertedText = performUserRequestedConversion(rawText);
                 
                 if (finalFormat === 'docx') {
                     const blob = await createSimpleDocx(convertedText);
                     saveAs(blob, outputFileName);
                 } 
                 else if (finalFormat === 'doc') {
                     const htmlContent = `<html><head><style>body { font-family: 'SutonnyMJ', 'Kalpurush', sans-serif; font-size: 14pt; } p { text-align: justify; margin: 0; padding: 0; }</style></head><body><pre style="font-family: 'SutonnyMJ', 'Kalpurush', sans-serif; white-space: pre-wrap;">${convertedText}</pre></body></html>`;
                     const blob = new Blob(['\ufeff', htmlContent], { type: 'application/msword' });
                     saveAs(blob, outputFileName);
                 } 
                 else if (finalFormat === 'xlsx') {
                     const rows = convertedText.split('\n').map(line => [line]);
                     const ws = XLSX.utils.aoa_to_sheet(rows);
                     const wb = XLSX.utils.book_new();
                     XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                     XLSX.writeFile(wb, outputFileName);
                 }
            }

            showCustomAlert('ফাইল কনভার্ট এবং ডাউনলোড সম্পন্ন হয়েছে!');

        } catch (error) {
            console.error(error);
            showCustomAlert('ফাইল প্রসেসিং এ ত্রুটি হয়েছে: ' + error.message);
        } finally {
            processingLoader.classList.add('hidden');
            exportUnicodeBtn.disabled = false;
            exportBijoyBtn.disabled = false;
        }
    }
    
    // --- Text Conversion Helper (Updated for Bijoy Output Processing) ---
    function convertTextString(text, targetType) {
        if (!text) return '';
        
        if (targetType === 'bijoy') {
            // Unicode to Bijoy Logic (Full logic with pre-processing)
            let unicodeInput = text;
            const bengaliConsonants = 'কখগঘঙচছজঝঞটঠডঢণতথদধনপফবভমযরলশষসহড়ঢ়য়';
            const unicodeHasanta = '\u09CD';
            const consonantOrConjunct = `(?:(?:[${bengaliConsonants}]${unicodeHasanta})+[${bengaliConsonants}]|[${bengaliConsonants}])`;
            
            // Pre-processing
            unicodeInput = unicodeInput.replace(new RegExp(`(${consonantOrConjunct})(\u09CB|\u09CC)`, 'g'), (match, base, vowelSign) => {
                if (vowelSign === '\u09CB') return base + '\u09C7' + '\u09BE';
                if (vowelSign === '\u09CC') return base + '\u09C7' + '\u09D7';
                return match;
            });
            unicodeInput = unicodeInput.replace(new RegExp(`(\u09B0\u09CD)?(${consonantOrConjunct})((?:\u09CD\u09AF|\u09CD\u09B0)?)(\u09BF|\u09C7|\u09C8)`, 'g'), (match, reph, base, phala, vowel) => {
                return vowel + (reph || '') + base + (phala || '');
            });

            let bijoyOutput = '';
            let k = 0;
            while (k < unicodeInput.length) {
                let foundMatch = false;
                if (unicodeInput.substring(k, k + 2) === '\u09B0\u09CD') { // Reph
                    let baseCluster = '';
                    let clusterLen = 0;
                    for (const key of sortedUnicodeKeys) {
                        if (key.length > 0 && unicodeInput.substring(k + 2, k + 2 + key.length) === key) {
                            baseCluster = key;
                            clusterLen = key.length;
                            break;
                        }
                    }
                    if (clusterLen > 0) {
                        bijoyOutput += unicodeToBijoyMap[baseCluster] + '©';
                        k += 2 + clusterLen;
                        foundMatch = true;
                    }
                }
                if (!foundMatch) {
                    for (const key of sortedUnicodeKeys) {
                        if (key.length > 0 && unicodeInput.substring(k, k + key.length) === key) {
                            bijoyOutput += unicodeToBijoyMap[key];
                            k += key.length;
                            foundMatch = true;
                            break;
                        }
                    }
                }
                if (!foundMatch) {
                    bijoyOutput += unicodeInput[k];
                    k++;
                }
            }

            // --- Post-processing (Added as per user request to match main converter) ---
            
            // ম্যানুয়াল আনসি রিপ্লেসমেন্ট প্রয়োগ (Global variable from main script)
            if (typeof manualAnsiReplacements !== 'undefined') {
                for (const [wrong, correct] of Object.entries(manualAnsiReplacements)) {
                    if (wrong) {
                        const regex = new RegExp(wrong.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                        bijoyOutput = bijoyOutput.replace(regex, correct);
                    }
                }
            }

            // লাইনের শুরু এবং দাড়ির পর ফিক্স
            bijoyOutput = bijoyOutput.replace(/^‡/gm, '†'); // লাইনের শুরুতে
            bijoyOutput = bijoyOutput.replace(/\|‡/g, '|†');   // দাড়ির পরে
            bijoyOutput = bijoyOutput.replace(/^‰/gm, 'ˆ'); // লাইনের শুরুতে
            bijoyOutput = bijoyOutput.replace(/\|‰/g, '|ˆ');   // দাড়ির পরে

            return bijoyOutput;

        } else {
            // Bijoy to Unicode Logic
            let bijoyInput = text;
            let unicodeOutput = '';
            let i = 0;
            while (i < bijoyInput.length) {
                let foundMatch = false;
                for (const key of sortedBijoyKeys) {
                    if (bijoyInput.substring(i, i + key.length) === key) {
                        unicodeOutput += bijoyToUnicodeMap[key];
                        i += key.length;
                        foundMatch = true;
                        break;
                    }
                }
                if (!foundMatch) {
                    unicodeOutput += bijoyInput[i];
                    i++;
                }
            }
            
            // Post-processing
            const unicodeConsonantsStr = '\\u0995-\\u09B9\\u09DC-\\u09DF';
            const unicodeHasantaStr = '\\u09CD';
            const unicodeRefStr = '\\u09B0' + unicodeHasantaStr;
            const unicodeVowelSigns = '[\\u09BE-\\u09C4\\u09C7-\\u09C8\\u09CB-\\u09CC\\u09D7]';
            
            const consonantCluster = `(?:[${unicodeConsonantsStr}](?:${unicodeHasantaStr}[${unicodeConsonantsStr}])*)`;
            const fullClusterWithVowel = `(${consonantCluster}(?:${unicodeVowelSigns})?)`;
            
            unicodeOutput = unicodeOutput.replace(new RegExp(`${fullClusterWithVowel}(${unicodeRefStr})`, 'g'), '$2$1');
            
            const consonantClusterPattern = `(?:${unicodeRefStr})?(?:[${unicodeConsonantsStr}](?:${unicodeHasantaStr}[${unicodeConsonantsStr}])*)`;
            unicodeOutput = unicodeOutput.replace(new RegExp(`([\u09BF\u09C7\u09C8])(${consonantClusterPattern})`, 'g'), '$2$1');
            
            unicodeOutput = unicodeOutput.replace(new RegExp(`(\u09C7)(\u09BE)`, 'g'), '\u09CB');
            unicodeOutput = unicodeOutput.replace(new RegExp(`(\u09C7)(\u09D7)`, 'g'), '\u09CC');

            // ম্যানুয়াল ইউনিকোড রিপ্লেসমেন্ট (যদি গ্লোবাল ভেরিয়েবল থাকে)
            if (typeof manualUnicodeReplacements !== 'undefined') {
                for (const [wrong, correct] of Object.entries(manualUnicodeReplacements)) {
                    if (wrong) {
                        const regex = new RegExp(wrong.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                        unicodeOutput = unicodeOutput.replace(regex, correct);
                    }
                }
            }

            return unicodeOutput;
        }
    }
});
// ====================================================================
// END: FILE CONVERTER SCRIPT (DOCX, DOC, XLSX, TXT) - DRAG DROP & FORMATTING
// ====================================================================


//এই কমেন্টের আগেও নতুন ট্যাব এর স্ক্রিপ্ট বসানো যাবে বা বসাতে হয় ।
        window.onload = function() {
            const preloader = document.getElementById('preloader');
            const mainContainer = document.querySelector('.main-container');

            if (preloader) {
                preloader.classList.add('preloader-hidden');
                preloader.addEventListener('transitionend', () => {
                    if (mainContainer) {
                        // মূল কন্টেন্ট দৃশ্যমান করুন
                        mainContainer.style.visibility = 'visible';
                        mainContainer.style.animation = 'fadeInContent 2s ease-out forwards'; // 0.75s থেকে 2s করা হয়েছে
                    }
                }, {
                    once: true
                }); 
            } else {
                if (mainContainer) {
                    mainContainer.style.visibility = 'visible';
                    mainContainer.style.opacity = '1';
                }
            }
        };

    </script>
<!-- ====================================================================-->
<!-- END: MAIN SCRIPT-->
<!-- ====================================================================-->


<!-- ====================================================================-->
<!-- START: SCRIPT PART 2 FOR GLOBAL VISITOR COUNTER (FIREBASE)-->
<!-- ====================================================================-->
<script type="module">

    // এই মডিউলটি Firebase ইনিশিয়ালাইজ করে এবং গ্লোবাল ভিজিটর কাউন্টার পরিচালনা করে।

    // আপনার ওয়েব অ্যাপের Firebase কনফিগারেশন
    const firebaseConfig = {
        apiKey: "AIzaSyBmTptSZWbNB5MrT8jIWVm6knak2L2Xv40",
        authDomain: "bangla-toolbox1.firebaseapp.com",
        projectId: "bangla-toolbox1",
        storageBucket: "bangla-toolbox1.firebasestorage.app",
        messagingSenderId: "345647713379",
        appId: "1:345647713379:web:d3e121c3a7e258b971bc56",
        measurementId: "G-6NVS7YFNBX"
    };

    async function initializeGlobalCounter() {
        try {
            // Firebase SDK গুলি ডায়নামিকভাবে ইম্পোর্ট করা হচ্ছে
            const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
            const { getFirestore, doc, runTransaction, onSnapshot } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
            const { getAuth, signInAnonymously } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
            const { getAnalytics } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js");

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            const analytics = getAnalytics(app); // অ্যানালিটিক্স এখানে ইনিশিয়ালাইজ করা হলো

            // বেনামীভাবে ব্যবহারকারীকে সাইন ইন করানো হচ্ছে
            if (!auth.currentUser) {
                await signInAnonymously(auth);
            }
            
            const todayString = new Date().toISOString().split('T')[0];
            const counterDocRef = doc(db, "artifacts", "banglatoolbox.github.io", "public", "data", "global_visitor_stats", "counts");

            // ভিজিট সংখ্যা ১ বাড়ানোর ফাংশন
            const incrementCounts = async () => {
                 try {
                    await runTransaction(db, async (transaction) => {
                        const counterDoc = await transaction.get(counterDocRef);

                        if (!counterDoc.exists()) {
                            // ডকুমেন্ট না থাকলে নতুন করে তৈরি হবে
                            transaction.set(counterDocRef, {
                                totalVisits: 1,
                                dailyVisits: { [todayString]: 1 }
                            });
                        } else {
                            // ডকুমেন্ট থাকলে সংখ্যা বাড়ানো হবে
                            const data = counterDoc.data();
                            const newTotalVisits = (data.totalVisits || 0) + 1;
                            
                            const dailyVisits = data.dailyVisits || {};
                            const newDailyCount = (dailyVisits[todayString] || 0) + 1;
                            
                            transaction.update(counterDocRef, {
                                totalVisits: newTotalVisits,
                                [`dailyVisits.${todayString}`]: newDailyCount
                            });
                        }
                    });
                } catch (e) {
                    console.error("Firestore transaction failed: ", e);
                }
            };

            // রিয়েল-টাইমে ভিজিট সংখ্যা দেখানোর ফাংশন
            const listenForCounts = () => {
                onSnapshot(counterDocRef, (doc) => {
                    const allTodayVisitsEl = document.getElementById('all-today-visits');
                    const allTotalVisitsEl = document.getElementById('all-total-visits');

                    if (doc.exists()) {
                        const data = doc.data();
                        const total = data.totalVisits || 0;
                        const today = (data.dailyVisits && data.dailyVisits[todayString]) ? data.dailyVisits[todayString] : 0;
                        
                        if (allTotalVisitsEl) allTotalVisitsEl.textContent = total.toLocaleString('bn-BD');
                        if (allTodayVisitsEl) allTodayVisitsEl.textContent = today.toLocaleString('bn-BD');
                    } else {
                        if (allTotalVisitsEl) allTotalVisitsEl.textContent = '০';
                        if (allTodayVisitsEl) allTodayVisitsEl.textContent = '০';
                    }
                }, (error) => {
                     console.error("Firestore snapshot listener error:", error);
                });
            };

            // এই সেশনে ব্যবহারকারীর ভিজিট গণনা হয়েছে কিনা তা পরীক্ষা করা হচ্ছে
            // এটি প্রতিবার পেইজ রিলোড করার সাথে সাথে ভিজিট সংখ্যা বেড়ে যাওয়া থেকে বিরত রাখবে
            if (!sessionStorage.getItem('globalVisitCounted')) {
                await incrementCounts();
                sessionStorage.setItem('globalVisitCounted', 'true');
            }

            // রিয়েল-টাইম আপডেটের জন্য লিসেনার চালু করা হচ্ছে
            listenForCounts();

        } catch (error) {
            console.error("Failed to initialize global visitor counter:", error);
            // কোনো সমস্যা হলে কাউন্টারে ত্রুটি বার্তা দেখানো হবে
            const allTodayVisitsEl = document.getElementById('all-today-visits');
            const allTotalVisitsEl = document.getElementById('all-total-visits');
            if (allTodayVisitsEl) allTodayVisitsEl.textContent = '∞';
            if (allTotalVisitsEl) allTotalVisitsEl.textContent = '∞';
        }
    }

    // মডিউল লোড হওয়ার সাথে সাথে ফাংশনটি কল করা হচ্ছে
    initializeGlobalCounter();

</script>
<!-- ====================================================================-->
<!-- End: SCRIPT PART 2 FOR GLOBAL VISITOR COUNTER (FIREBASE-->
<!-- ====================================================================-->
	
<!-- ====================================================================-->
<!-- START: SIDEBAR SCRIPT-->
<!-- ====================================================================-->

<!-- Sidebar Toggle Button -->
<button id="sidebarToggle" class="fixed top-4 left-4 z-40 w-12 h-12 bg-indigo-600 text-white rounded-full shadow-lg flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition-transform duration-300 ease-in-out hover:bg-indigo-700 has-tooltip" data-tooltip="সাইডবার (শর্টকাট: Alt+X)">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
</button>

<!-- Sidebar Menu -->
<div id="sidebar" class="fixed top-0 left-[-300px] w-[300px] h-full bg-white dark:bg-gray-800 shadow-xl z-50 transition-left duration-300 ease-in-out">
    <div class="p-4">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">সকল টুলস</h3>
		<!-- নতুন সাইডবার ক্লোজ বাটন: সাইডবার ওপেন হলে ডানদিকে প্রদর্শিত হবে -->
<button id="sidebarClose" class="absolute top-4 right-4 z-50 text-gray-500 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors duration-200 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
</button>
        <input type="text" id="sidebarSearch" class="w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-indigo-500" placeholder="টুলস খুঁজুন...">
        <ul id="sidebar-tool-list" class="mt-4 space-y-2 h-[calc(100vh-120px)] overflow-y-auto">
            <!-- Tool list will be populated by JavaScript -->
        </ul>
    </div>

<!-- WhatsApp Floating Button Section Start -->
    <div id="whatsapp-container" class="absolute bottom-5 right-5 z-50 flex flex-col items-end gap-2">
        
        <!-- ভাসমান টেক্সটবক্স (ডিফল্টভাবে লুকানো) -->
        <div id="whatsapp-input-box" class="hidden bg-white dark:bg-gray-700 p-3 rounded-xl shadow-2xl border border-green-200 dark:border-gray-600 w-64 mb-2 transition-all duration-300 ease-in-out transform origin-bottom-right">
            <label class="block text-xs font-bold text-green-600 dark:text-green-400 mb-1">মেসেজ লিখুন:</label>
            <textarea id="whatsapp-message" rows="3" class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent dark:bg-gray-600 dark:border-gray-500 dark:text-white resize-none" placeholder="এখানে আপনার টেক্সট লিখুন..."></textarea>
            
            <button id="whatsapp-send-btn" class="mt-2 bg-green-500 hover:bg-green-600 text-white text-sm font-bold py-1.5 px-3 rounded-lg w-full flex items-center justify-center gap-2 transition-colors shadow-md">
                <span>পাঠিয়ে দিন</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                </svg>
            </button>
        </div>

        <!-- হোয়াটসঅ্যাপ আইকন বাটন -->
        <button id="whatsapp-fab" class="w-12 h-12 bg-green-500 hover:bg-green-600 text-white rounded-full flex items-center justify-center shadow-lg transition-transform transform hover:scale-110 active:scale-95 focus:outline-none ring-2 ring-white dark:ring-gray-800" title="হোয়াটসঅ্যাপে মেসেজ পাঠান">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 16 16">
                <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
            </svg>
        </button>
    </div>
    <!-- WhatsApp Floating Button Section End -->
	
</div>

<!-- Sidebar Overlay -->
<div id="sidebarOverlay" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 z-30 hidden"></div>

<!-- ====================================================================-->
<!-- END: SIDEBAR SCRIPT-->
<!-- ====================================================================-->


</body>
</html>
